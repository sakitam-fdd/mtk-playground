import{d as t,e}from"./common-DJbht5QT.js";import{b as n,l as r,y as i,F as o,H as s,M as a,J as l,K as h,m as u,P as c,N as f,T as d,O as p,a as g,h as m,L as A,g as y,j as v,U as x,X as _,C as b,R as w,E as T,S as M,r as C,Y as S,Z as I,z as P,_ as E,$ as O,a0 as R,a1 as k,a2 as L,a3 as D,V as N,o as F}from"./maptalks.es-7YTiJo2Q.js";var z="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"];var B={isTest:!1,idleLog:!1,idleForceTimeThreshold:48,workerCount:("undefined"!=typeof globalThis?globalThis:global||self).MAPTALKS_WORKER_COUNT||0,messagePostRatioPerWorker:.3,maxFPS:0};function H(){return Date.now()}function j(t,...e){for(var n=0;n<e.length;n++){var r=e[n];for(var i in r)t[i]=r[i]}return t}function U(t){return null==t}function V(t){return"number"==typeof t&&!isNaN(t)}function G(t){return(0|t)===t}function W(t){return"object"==typeof t&&!!t}function q(t){return!U(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function X(t){return!U(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var Z=Object.prototype.hasOwnProperty;function Y(t,e){return Z.call(t,e)}var J=Math.PI/180;function Q(t){return t*J}function K(t){return t/J}var $={};function tt(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!z){var et=navigator.userAgent.toLowerCase(),nt=document.documentElement||{style:{}},rt="ActiveXObject"in window,it=-1!==et.indexOf("webkit"),ot=-1!==et.indexOf("phantom"),st=-1!==et.search("android [23]"),at=-1!==et.indexOf("chrome"),lt=-1!==et.indexOf("gecko")&&!it&&!window.opera&&!rt,ht=/iphone/i.test(et)&&/micromessenger/i.test(et),ut="undefined"!=typeof orientation||-1!==et.indexOf("mobile"),ct=!window.PointerEvent&&window.MSPointerEvent,ft=window.PointerEvent&&navigator.pointerEnabled||ct,dt=rt&&"transition"in nt.style,pt="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!st,gt="MozPerspective"in nt.style,mt="OTransition"in nt.style,At=(dt||pt||gt)&&!mt&&!ot,yt="undefined"!=typeof window&&X(window.createImageBitmap),vt="undefined"!=typeof window&&X(window.ResizeObserver),xt="undefined"!=typeof window&&X(window.btoa),_t="undefined"!=typeof window&&X(window.Proxy),bt="undefined"!=typeof window&&X(window.requestIdleCallback),wt=0;at&&(wt=et.match(/chrome\/([\d.]+)/)[1]);var Tt=!ot&&(ft||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),Mt="undefined"!=typeof window&&"WebGLRenderingContext"in window,Ct=tt(),St=!1;try{new OffscreenCanvas(2,2).getContext("2d"),St=!0}catch(S6){St=!1}var It=!1;try{window.addEventListener("testPassive",(function(){}),{get passive(){return It=!0,!0}})}catch(Wp){}$={IS_NODE:z,isTest:!1,ie:rt,ielt9:rt&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:it,gecko:lt,android:-1!==et.indexOf("android"),android23:st,chrome:at,chromeVersion:wt,safari:!at&&-1!==et.indexOf("safari"),phantomjs:ot,ie3d:dt,webkit3d:pt,gecko3d:gt,opera12:mt,any3d:At,iosWeixin:ht,mobile:ut,mobileWebkit:ut&&it,mobileWebkit3d:ut&&pt,mobileOpera:ut&&window.opera,mobileGecko:ut&&lt,touch:!!Tt,msPointer:!!ct,pointer:!!ft,retina:Ct>1,devicePixelRatio:Ct,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:rt&&9===document.documentMode,ie10:rt&&10===document.documentMode,webgl:Mt,imageBitMap:yt,resizeObserver:vt,btoa:xt,decodeImageInWorker:St,monitorDPRChange:!0,supportsPassive:It,proxy:_t,requestIdleCallback:bt,checkDevicePixelRatio:function(){if("undefined"!=typeof window&&$.monitorDPRChange){var t=tt(),e=t!==$.devicePixelRatio;return e&&($.devicePixelRatio=t),e}return!1}}}var Pt=$;function Et(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Et=function(){return!!t})()}function Ot(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}function Rt(t,e,n){return e&&function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,Ot(r.key),r)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function kt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Dt(t,e)}function Lt(t){return(Lt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Dt(t,e){return(Dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function Nt(t){var e="function"==typeof Map?new Map:void 0;return Nt=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(Wp){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return function(t,e,n){if(Et())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,e);var i=new(t.bind.apply(t,r));return n&&Dt(i,n.prototype),i}(t,arguments,Lt(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Dt(n,t)},Nt(t)}function Ft(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function zt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Bt(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return zt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?zt(t,e):void 0}}(t))||e){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Ht,jt,Ut=function(){function t(t,e,n){if(U(t)||U(e)?U(t.x)||U(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1],this.z=t[2]):(this.x=+t.x,this.y=+t.y,this.z=t.z):(this.x=+t,this.y=+e,this.z=n),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e,n){return this.x=t,this.y=e,this.z=n||0,this},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.distanceTo=function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)},e.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e._add=function(t,e){return U(t.x)?U(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e._sub=function(t,e){return U(t.x)?U(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(t,e){return V(e)?this._sub(t,e):this._sub(t)},e.substract=function(t,e){return this.sub(t,e)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)||V(this.z)&&isNaN(this.z)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return V(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},e.toJSON=function(){var t={x:this.x,y:this.y};return V(this.z)&&(t.z=this.z),t},t}(),Vt=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},n.unit=function(){return this.copy()._unit()},n._unit=function(){return this._div(this.mag()),this},n.perp=function(){return this.copy()._perp()},n._perp=function(){return[this.x,this.y]=[-this.y,this.x],this},n.angleWith=function(t){return this.angleWithSep(t.x,t.y)},n.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},n._rotate=function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},n.rotate=function(t){return this.copy()._rotate(t)},n.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new e(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new e(this.x,this.y,this.z)},n.toFixed=function(t){return new e(this.x.toFixed(t),this.y.toFixed(t),V(this.z)?this.z.toFixed(t):void 0)},n.add=function(t,n){var r,i;return U(t.x)?U(t[0])?(r=this.x+t,i=this.y+n):(r=this.x+t[0],i=this.y+t[1]):(r=this.x+t.x,i=this.y+t.y),new e(r,i)},n.sub=function(t,n){var r,i;return U(t.x)?U(t[0])?(r=this.x-t,i=this.y-n):(r=this.x-t[0],i=this.y-t[1]):(r=this.x-t.x,i=this.y-t.y),new e(r,i)},n.multi=function(t){return new e(this.x*t,this.y*t)},n.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y&&this.z===t.z)},e}(Ut);function Gt(t){var e="data:image/svg+xml";return t.length>4&&".svg"===t.slice(-4)?1:t.slice(0,18)===e?2:0}function Wt(t,e){z&&Wt.node?Wt.node(t,e):t.src=e[0]}!function(){if(z)return Ht=function(t){return setTimeout(t,16)},void(jt=clearTimeout);var t,e,n=1e3/30;function r(t){return setTimeout(t,n)}function i(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||i("RequestAnimationFrame")||r,e=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=r,e=clearTimeout),Ht=function(e){return t(e)},jt=function(t){t&&e(t)}}();var qt=0;function Xt(){return qt++}var Zt=Xt;function Yt(t){return t&&q(t)?JSON.parse(t):t}function Jt(...t){for(var e=t[0],n=1;n<t.length;n++){var r=t[n];if(r&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e.length}function Qt(t,e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}function Kt(t,e,n){if(!Array.isArray(t))return n?e.call(n,t):e(t);for(var r,i,o=[],s=0,a=t.length;s<a;s++)U(r=t[s])?o.push(null):Array.isArray(r)?o.push(Kt(r,e,n)):(i=n?e.call(n,r):e(r),o.push(i));return o}function $t(t,e){return void 0===t?e:t}function te(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function ee(t,e,n){return t*(1-n)+e*n}function ne(t,e,n){if(t===n||t===e)return t;var r=n-e;return((t-e)%r+r)%r+e}function re(t,e,n){return Math.min(n,Math.max(e,t))}function ie(t){return Array.isArray(t)&&t.length>0}var oe=/^([a-z][a-z\d+\-.]*:)?\/\//i;var se=/^url\((['"])(.+)\1\)$/i,ae=/^url\(([^'"].*[^'"])\)$/i;function le(t){var e=function(t){return q(t)?ae.test(t)?1:se.test(t)?2:3:0}(t);return 3===e?t:1===e?ae.exec(t)[1]:2===e?se.exec(t)[2]:t}var he="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function ue(t,e,n,r){var i=n-t,o=r-e;return Math.atan2(o,i)}var ce="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function fe(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var n in t)if("center"===n){if(!e[n]||!de(t[n][0],e[n][0])||!de(t[n][1],e[n][1]))return!1}else if(t[n]!==e[n])return!1;return!0}function de(t,e,n){return null==n&&(n=1e-6),t>=e-n&&t<=e+n}function pe(t=100,e=4,n=null,r=null){t||(t=100),e||(e=4);var i=this,o=this.isVisible();return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function s(){if(0===e)return o?i.show():i.hide(),void(n&&(r?n.call(r):n()));e%2==0?i.hide():i.show(),e--,i._flashTimeout=setTimeout(s,t)}),t),this}function ge(t=[],e="_pt"){for(var n=[],r=0,i=t.length;r<i;r++){var o=t[r];if(o){o[e]||(o[e]=new Vt(0,0));var s=o[e];s.x=0,s.y=0,n.push(s)}else n.push(null)}return n}function me(t,e){e(t.data)}function Ae(t){if(t&&0===t.indexOf("http://")||0===t.indexOf("https://"))return t;var e=document.createElement("a");return e.href=t,t=e.href,e=null,t}var ye={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function ve(t,e=1){var{width:n,height:r}=t;return ye.cssWidth=n+"px",ye.cssHeight=r+"px",ye.width=Math.round(n*e),ye.height=Math.round(r*e),ye}var xe="_maptalks__internal_layer_",_e=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],be=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(_e),we=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],Te=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],Me={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},Ce=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],Se=14,Ie=function(){function t(t,e){V(t)&&V(e)?(this.width=t,this.height=e):V(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,n){var r,i;return e instanceof t?(r=this.width+e.width,i=this.height+e.height):(r=this.width+e,i=this.height+n),new t(r,i)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new Vt(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}(),Pe="";function Ee(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function Oe(t,e,n){if(!t)return t;for(;t.indexOf(e)>-1;)t=t.replace(e,n);return t}var Re=/[\b\t\r\v\f]/gim;function ke(t){return q(t)?t.replace(Re,Pe):t}var Le="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function De(t,e){return De.node?De.node(t,e):(Le.font=e,Le.measureText(t).width)}function Ne(t,e,n){var r=De(t,e);return new Ie(r,n||Se)}function Fe(t,e,n,r){if(!t||0===t.length)return[{text:"",width:0}];var i=U(r)?De(t,e):r,o=i/t.length,s=Math.floor(n/o/2);if(o>=n||s<=0)return[{text:"",width:n}];if(i<=n)return[{text:t,width:i}];for(var a=[],l=t.substring(0,s),h=o*s,u=s,c=t.length;u<c;u++){var f=t[u],d=De(l+f);d>=n?(a.push({text:l,width:h}),l=t.substring(u,s+u),u+=s-1,h=o*s):(l+=f,h=d),u>=c-1&&(h=De(l),a.push({text:l,width:h}))}return a}var ze=["{","}"];function Be(t,e){if(!q(t))return t;function n(t){if(!e)return Pe;var n=e[t];return U(n)?Pe:Array.isArray(n)?n.join():n}for(var[r,i]=ze,o=function(t){t+=Pe;for(var[e,n]=ze,r=[],i=!1,o=Pe,s=0,a=t.length;s<a;s++){var l=t[s];i||l!==e||(i=!0),l===e&&i&&(o=Pe),i&&l!==e&&l!==n&&(o+=l),l===n&&o&&(i=!1,r.push(o),o=Pe)}return r}(t),s=0,a=o.length;s<a;s++){var l=o[s];t=Oe(t,""+r+l+i,n(l))}return t}function He(t,e){V(t)&&(t+=""),t=t||"";var n=e.textMaxHeight||0,r=We(t,e);return n&&n<r.size.height&&(r.size.height=n),r}function je(t,e,n){var r=t.width,i=t.height;return new Vt("left"===e?-r:"right"===e?0:-r/2,"top"===n?-i:"bottom"===n?0:-i/2)}var Ue="sans-serif",Ve=14;function Ge(t){if(t.textFont)return t.textFont;var e=t.textSize;return U(e)&&(e=Ve),(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+e+"px "+(t.textFaceName&&function(t){for(var e=t.split(","),n=0;n<e.length;n++)e[n].trim&&(e[n]=e[n].trim()),e[n].indexOf(" ")>0&&'"'!==e[n][0]&&"'"!==e[n][0]&&(e[n]='"'+e[n]+'"');return e.join(",")}(t.textFaceName)||Ue)}function We(t,e){var n=Ge(e),r=e.textLineSpacing||0,i=Ne(t,n,e.textSize),o=i.width,s=i.height,a=e.textWrapCharacter||"\n",l=[],h=e.textWrapWidth;(!h||h>o)&&(h=o),q(t)||(t+="");var u=0;if(a&&t.indexOf(a)>=0)for(var c=t.split(a),f=0,d=c.length;f<d;f++){var p=c[f],g=De(p,n);if(g>h)for(var m=Fe(p,n,h,g),A=0,y=m.length;A<y;A++){var v=m[A].width;v>u&&(u=v),l.push({text:m[A].text,size:new Ie(v,s)})}else g>u&&(u=g),l.push({text:p,size:new Ie(g,s)})}else if(o>h)for(var x=Fe(t,n,h,o),_=0;_<x.length;_++){var b=x[_].width;b>u&&(u=b),l.push({text:x[_].text,size:new Ie(b,s)})}else o>u&&(u=o),l.push({text:t,size:i});var w=l.length;return{total:w,size:new Ie(u,s*w+r*(w-1)),rows:l,rawSize:i}}function qe(t){var e=0,n=t&&t.length||0;if(!n)return e;for(var r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}var Xe=z?function(t){return t[0]}:function(t){for(var e=document.documentElement&&document.documentElement.style||{},n=0;n<t.length;n++)if(t[n]in e)return t[n];return!1},Ze=Xe(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Ye=Xe(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),Je=Xe(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]);function Qe(t,e){var n=document.createElement(t);return e&&fn(n,e),n}function Ke(t,e,n){var r=Qe(t);return e&&hn(r,e),n&&n.appendChild(r),r}function $e(t){if(!t)return this;if(Pt.ielt9||Pt.ie9){var e=Qe("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function tn(t,e,n,r){if(!(t&&t.addEventListener&&e&&n))return this;for(var i=function(e){e||(e=window.event),n.call(r||t,e)},o=e.split(" "),s=o.length-1;s>=0;s--){var a=o[s];if(a)t["Z__"+a]||(t["Z__"+a]=[]),nn(t,a,n)>=0&&(console.warn(t,"find '"+a+"' handler:",n," The old listener function will be removed"),en(t,a,n)),t["Z__"+a].push({callback:i,src:n}),t.addEventListener(a,i,!!Pt.supportsPassive&&{capture:!1,passive:!1})}return this}function en(t,e,n){function r(e,n){"mousewheel"===e&&Pt.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,n,!1)}if(!t||!t.removeEventListener||!e)return this;for(var i=e.split(" "),o=i.length-1;o>=0;o--){var s=i[o];if(s){if(!n&&t["Z__"+s]){for(var a=t["Z__"+s],l=0,h=a.length;l<h;l++)r(a[l].callback);return delete t["Z__"+s],this}var u=nn(t,s,n);if(u<0)return this;r(s,t["Z__"+s][u].callback),t["Z__"+s].splice(u,1)}}return this}function nn(t,e,n){if(!t||!t["Z__"+e]||!n)return-1;for(var r=t["Z__"+e],i=0,o=r.length;i<o;i++)if(r[i].src===n)return i;return-1}function rn(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function on(t){return t._cancelBubble=!0,t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function sn(t,e){return t?(Pt.any3d?function(t,e){var n=e||new Vt(0,0);t.style[Ze]=Pt.any3d?"translate3d("+n.x+"px,"+n.y+"px,0px)":"translate("+n.x+"px,"+n.y+"px)"}(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function an(t){var e=window.getComputedStyle(t),n=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],r=t.getBoundingClientRect(),i=t.offsetWidth,o=t.offsetHeight,s=i?r.width/i:1,a=o?r.height/o:1;return t.__position=[r.left+n[0],r.top+n[1],s,a],t.__position}function ln(t,e){t||(t=window.event);var n=e.__position;n||(n=an(e));var r=t;return r.touches&&r.touches.length&&(t=r.touches[0]),r.changedTouches&&r.changedTouches.length&&(t=r.changedTouches[0]),new Vt((t.clientX-n[0]-e.clientLeft)/n[2],(t.clientY-n[1]-e.clientTop)/n[3])}function hn(t,e){var n,r,i,o=t.style.cssText;return r=";",(i=(n=o).length-r.length)>=0&&n.indexOf(r,i)===i||(o+=";"),t.style.cssText=o+e,this}function un(t,e){if(void 0!==t.classList)return t.classList.contains(e);var n=dn(t);return n.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(n)}function cn(t,e){if(void 0===t.classList||un(t,e)){var n=dn(t);fn(t,(n?n+" ":"")+e)}else for(var r=Ee(e).split(/\s+/),i=0,o=r.length;i<o;i++)t.classList.add(r[i]);return this}function fn(t,e){return U(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function dn(t){return U(t.className.baseVal)?t.className:t.className.baseVal}function pn(t,e){var n,r,i=(n=t,(r=document.createElement(n)).style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(r),r);q(e)?i.innerHTML=e:i.appendChild(e);var o=new Ie(i.clientWidth,i.clientHeight);return $e(i),o}Xe(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);var gn=tn,mn=en;function An(t){return t&&("mousemove"===t||"touchmove"===t)}function yn(t,e){var n=H(),r=e||48;return!!(t._mousemoveTime&&n-t._mousemoveTime<r)||(t._mousemoveTime=n,!1)}var vn={jsonp:function(t,e){var n="_maptalks_jsonp_"+Xt();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;var r=document.createElement("script");return r.type="text/javascript",r.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,n){if(X(e)){var r=n;n=e,e=r}if(z&&vn.get.node)return vn.get.node(t,n,e);var i=vn._getClient(n);if(i.open("GET",t,!0),e){for(var o in e.headers)i.setRequestHeader(o,e.headers[o]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(null),i},post:function(t,e,n){var r;if(q(t)){if(X(e)){var i=n;n=e,e=i}r=(e=e||{}).postData}else{var o=n;r=e,t=(e=t).url,n=o}if(z&&vn.post.node)return e.url=t,vn.post.node(e,r,n);var s=vn._getClient(n);if(s.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in s)for(var a in e.headers)e.headers.hasOwnProperty(a)&&s.setRequestHeader(a,e.headers[a]);return q(r)||(r=JSON.stringify(r)),s.send(r),s},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(Wp){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){}}}return e.onreadystatechange=vn._wrapCallback(e,t),e},getArrayBuffer:function(t,e,n){if(X(e)){var r=n;n=e,e=r}return e||(e={}),e.responseType="arraybuffer",vn.get(t,e,n)},getImage:function(t,e,n){return vn.getArrayBuffer(e,n,(function(e,n){if(e)t.onerror&&t.onerror(e);else if(n){var r=window.URL||window.webkitURL,i=t.onload;t.onload=function(){i&&i(),r.revokeObjectURL(t.src)};var o=new Blob([new Uint8Array(n.data)],{type:n.contentType});t.cacheControl=n.cacheControl,t.expires=n.expires,t.src=n.data.byteLength?r.createObjectURL(o):ce}}))},getJSON:function(t,e,n){}};vn.getJSON=function(t,e,n){if(X(e)){var r=n;n=e,e=r}var i=function(t,e){var r=e?Yt(e):null;n(t,r)};return e&&e.jsonp?vn.jsonp(t,i):vn.get(t,e,i)};var xn="",_n=/data:image\/.*;base64,/;function bn(t,e={}){for(var n in e){var r=e[n];if(r&&r.target&&(s=n,V(o=t)&&(o+=xn),V(s)&&(s+=xn),o&&s&&(o.includes?o.includes(s):o.indexOf(s)>-1))){var{target:i}=r;return t.replace(n,i)}}var o,s;return xn}var wn={host:xn,resources:{},proxy:{},origin:{},fromJSON:function(t){try{q(t)&&(t=JSON.parse(t)),W(t)&&j(wn,t)}catch(e){console.error(e)}},toJSON:function(){return{host:wn.host,proxy:j({},wn.proxy||{}),origin:j({},wn.origin||{})}},getResource:function(t){return wn.resources[t]},removeResource:function(t){delete wn.resources[t]},addResource:function(t,e){wn.resources[t]?console.warn(t+" resource Already exists,the "+t+" Cannot be added,the resource name Cannot repeat "):wn.resources[t]=e},updateResource:function(t,e){wn.resources[t]=e},allResource:function(){return wn.resources},loadSprite:function(t={imgUrl:"",jsonUrl:""}){return new Promise((function(e,n){var{imgUrl:r,jsonUrl:i}=t;if(!r||!i)return n(new Error("not find imgUrl/jsonUrl from options")),void console.error(t);function o(t,e,n){t.width=e,t.height=n;var r=t.getContext("2d");return r.clearRect(0,0,e,n),r}function s(r={},i){var s=function(){var t;return Pt.IS_NODE?console.error("Current environment does not support canvas dom"):t=Qe("canvas"),t}();if(s){var a=[];for(var l in r){var h=r[l];a.push({name:l,spriteItem:h})}var u=function(){var t;return Pt.decodeImageInWorker&&(t=new OffscreenCanvas(2,2)),t}(),c=t.sourceName||"";a.forEach((function(t){var e,{name:n,spriteItem:r}=t,{x:a,y:l,width:h,height:f}=r;u?(o(u,h,f).drawImage(i,a,l,h,f,0,0,h,f),e=u.transferToImageBitmap()):(o(s,h,f).drawImage(i,a,l,h,f,0,0,h,f),e=s.toDataURL());t.resource=e,wn.addResource(c+n,e)})),e(a)}else n(new Error("can not create canvas"))}vn.getJSON(i,{},(function(t,e){if(t)n(t);else{var i=new Image;i.onload=function(){s(e,i)},i.onerror=function(t){n(t)},vn.getImage(i,r,{})}}))}))},loadSvgs:function(t){return new Promise((function(e,n){var r="",i=[],o="",s="",a="";if(Array.isArray(t)||t instanceof NodeList)i=t;else if(W(t)){var l=t;r=l.url,i=l.symbols,o=l.fill,s=l.stroke,a=l.sourceName||""}else q(t)&&(r=t);if(r||!i||0!==i.length){var h=[],u=function(t,e){var n=function(t){var e=Mn.parseFromString(t,"text/xml").querySelector("svg");if(!e)return null;for(var n=e.childNodes,r=[],i=e.attributes,o=Cn(i,"fill"),s=Cn(i,"fill-opacity"),a=Cn(i,"stroke"),l=Cn(i,"stroke-opacity"),h=Cn(i,"stroke-width"),u=0,c=n.length;u<c;u++){var f=n[u],d=f.attributes;if(d){var p=void 0,g="path"===(f.tagName||"").toLowerCase();if(p=g?Cn(d,"d"):f){var m=Cn(d,"fill")||o,A=Cn(d,"stroke")||a,y={path:p};if(m&&(y.fill=m,y["fill-opacity"]=Cn(d,"fill-opacity")||s||1),A&&(y.stroke=A,y["stroke-opacity"]=Cn(d,"stroke-opacity")||l||1,y["stroke-width"]=Cn(d,"stroke-width")||h||1),r.push(y),!g)for(var v in y)"path"!==v&&y.hasOwnProperty(v)&&f.setAttribute(v,y[v])}}}return r}(e);n&&(n.forEach((function(t){o&&(t.fill=o),s&&(t.stroke=s)})),wn.addResource(a+t,n));var r={name:t,paths:n,body:e};h.push(r)};if(r&&q(r))fetch(r).then((function(t){return t.json()})).then((function(t){t.forEach((function(t){var{name:e,body:n}=t;u(e,n)})),e(h)})).catch((function(t){n(t)}));else if(i){for(var c=0,f=i.length;c<f;c++){var d=i[c],p=d.id,g=d.innerHTML;p&&u(p,"<xml><svg>"+g+"</svg></xml>")}e(h)}else n(new Error("not support svgs params type"))}else n(new Error("not find svgs data"))}))}};function Tn(t){if(V(t)&&(t+=xn),!t)return console.error("resouce path is null,path:",t),t;if(!q(t))return t;if(function(t){return _n.test(t)}(t)||function(t){return 0===t.indexOf("blob:")}(t))return t;if("$"===t[0])return wn.getResource(t.substring(1,1/0))||"";var e=wn.origin||{},n=function(t){return oe.test(t)}(t);if(n&&W(e)){var r=bn(t,e);return r||t}var i=wn.proxy||{};if(W(i)){var o=bn(t,i);if(o)return o}var{host:s}=wn;return!n&&s&&q(s)?""+s+t:Ae(t)}var Mn=new DOMParser;function Cn(t,e){return t?t[e]&&t[e].value:null}let Sn;const In={width:100,height:10};let Pn=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),Pn=!0}catch(S6){Pn=!1}let En=class{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},In,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!Sn){const{width:t,height:e}=In;Pn?Sn=new OffscreenCanvas(t,e):(Sn=document.createElement("canvas"),Sn.width=t,Sn.height=e)}return Sn}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:s}=this;for(let a=0,l=o.length;a<l;a++){const[t,e]=o[a],n=(t-this.min)/s;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}};var On;function Rn(t,e){var n,r,i;if(Un(t)){var o,s=t.stops&&"object"==typeof t.stops[0][0],a=s||void 0!==t.property,l=s||!a,h=t.type||e||"exponential";if("exponential"===h)o=Dn;else if("interval"===h)o=Ln;else if("categorical"===h)o=kn;else if("identity"===h)o=zn;else if("color-interpolate"===h)o=Fn;else{if("calculate-expression"!==h)throw new Error('Unknown function type "'+h+'"');o=Bn}if(s){var u={},c=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===u[f[0].zoom]&&(u[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in u)c.push([u[t].zoom,Rn(u[t])]);n=function(e,n){const r=Dn({stops:c,base:t.base},e)(e,n);return"function"==typeof r?r(e,n):r},r=!1,i=!1}else l?(n=function(e){const n=o(t,e);return"function"==typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=o(t,n?n[t.property]:null);return"function"==typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function kn(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function Ln(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function Dn(t,e){for(var n=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:Hn(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(On=new Map);const Nn={width:100,height:1};function Fn(t,e){const n=t.stops;if(n&&n.length>1){let t;if(On){const e=JSON.stringify(n);if(!On.has(e)){const t=new En(n,Nn);On.set(e,t)}t=On.get(e)}else t=new En(n,Nn);const[r,i,o,s]=t.getColor(e);return[r/255,i/255,o/255,s/255]}return n&&1===n.length?n[0][1]:null}function zn(t,e){return n=e,r=t.default,void 0!==n?n:void 0!==r?r:null;var n,r}function Bn(t,e){const n=String(t.property),r=t.expression,i=e;function o(e){return null==e||""===e||isNaN(e)?t.default:e}if(null==e||""===e||isNaN(e)||e<0)return o(t.default);{const e=function t(e,n,r){const i=Number(r),o=String(n);return Array.isArray(e)?e.map((e=>t(e,o,i))):e===o?i:e}(r,n,i);return o(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const r=n[0];if(!["+","-","*","/"].includes(r))throw new Error(`Unknown operator: ${r}`);const i=n.slice(1).map((t=>e(t)));switch(r){case"+":return i.reduce(((t,e)=>t+e),0);case"-":return i.reduce(((t,e)=>t-e));case"*":return i.reduce(((t,e)=>t*e),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${r}`)}}}(e))}}function Hn(t,e,n,r,i,o){return"function"==typeof i?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return Hn(t,e,n,r,s,a)}:i.length?function(t,e,n,r,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=jn(t,e,n,r,i[a],o[a]);return s}(t,e,n,r,i,o):jn(t,e,n,r,i,o)}function jn(t,e,n,r,i,o){var s,a=r-n,l=t-n;return i*(1-(s=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+o*s}function Un(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function Vn(t){for(const e in t)if(Un(t[e]))return!0;return!1}function Gn(t){return Xn(t,"exponential")}function Wn(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var r,i=[];for(let o=0;o<t.length;o++)(r=Wn(t[o],e))?(i.push(r),n=!0):i.push(t[o]);return n?i:t}var o,s={__fn_types_loaded:!0},a=[];for(o in t)t.hasOwnProperty(o)&&a.push(o);const l=function(t){Object.defineProperty(s,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=Gn(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let h=0,u=a.length;h<u;h++)Un(t[o=a[h]])?(n=!0,s["_"+o]=t[o],l(o)):s[o]=t[o];return n?s:t}function qn(t){if(!t||!t.stops)return[];const e=[];for(let n=0,r=t.stops.length;n<r;n++)e.push(t.stops[n][1]);return e}function Xn(t,e){if(!Un(t))return function(){return t};let n=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let s=0;s<i.length;s++)if(Un(i[s][1])){const t=Xn(i[s][1],e);n=n&&t.isZoomConstant,r=r&&t.isFeatureConstant,i[s]=[i[s][0],t]}const o=Rn(t,e);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=r&&o.isFeatureConstant,o}const Zn=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Yn(t){return new Function("f",`var p = (f && f.properties || {}); return ${Jn(t)}`)}function Jn(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return`(${"=="===e?Kn(t[1],t[2],"===",!1):"!="===e?Kn(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?Kn(t[1],t[2],e,!0):"any"===e?tr(t.slice(1),"||"):"all"===e?tr(t.slice(1),"&&"):"none"===e?rr(tr(t.slice(1),"||")):"in"===e?er(t[1],t.slice(2)):"!in"===e?rr(er(t[1],t.slice(2))):"has"===e?nr(t[1]):"!has"===e?rr(nr(t[1])):"contains"===e?function(t,e,n){const r=Qn(t);return void 0!==n?`(${r} + '').indexOf("${e}") === ${n}`:`(${r} + '').indexOf("${e}") >= 0`}(t[1],t[2],t[3]):"true"})`}function Qn(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function Kn(t,e,n,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,e,n,r){const i=t.property,o=t.op;let s=Qn(i);return"length"!==o?(console.error(`not support ${o} op`),"false"):(s=`((${s}+='').length)`,$n(s,i,e,n,r))}(t,e,n,r);var i;return $n(Qn(t),t,e,n,r)}function $n(t,e,n,r,i){const o="$type"===e?Zn.indexOf(n):JSON.stringify(n);return(i?`typeof ${t}=== typeof ${o}&&`:"")+t+r+o}function tr(t,e){return t.map(Jn).join(e)}function er(t,e){"$type"===t&&(e=e.map((t=>Zn.indexOf(t))));const n=JSON.stringify(e.sort(ir)),r=Qn(t);return e.length<=200?`${n}.indexOf(${r}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${r}, ${n},0,${e.length-1})`}function nr(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function rr(t){return`!(${t})`}function ir(t,e){return t<e?-1:t>e?1:0}function or(t){const e=t._toJSON(),n=e.feature;return n.type=Zn.indexOf(n.geometry.type),n.subType=e.subType,n}function sr(t){if(!Array.isArray(t))return sr([t]);const e=[];for(let n=0;n<t.length;n++){let r;r=!0===t[n].filter?function(){return!0}:Yn(t[n].filter),e.push(ar({},t[n],{filter:r}))}return e}function ar(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}var lr=[],hr={};function ur(t,e){return Wn(t,(function(){var t,n,r,i,o,s,a,l=e.getMap();return t=lr,n=l?l.getZoom():12,r=j({},e.getProperties(),(i=hr,o=l&&l.getBearing()||0,s=l&&l.getPitch()||0,a=l?l.getZoom():10,i["{bearing}"]=o,i["{pitch}"]=s,i["{zoom}"]=a,i)),t[0]=n,t[1]=r,t}))}function cr(t,e,n){if(!t.markerPath)return null;var r,i,o=1,s=(0===(i={stroke:{stroke:(r=t).markerLineColor,"stroke-width":r.markerLineWidth,"stroke-opacity":r.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:r.markerFill,"fill-opacity":r.markerFillOpacity}}).stroke["stroke-width"]&&(i.stroke["stroke-opacity"]=0),i);V(t.markerOpacity)&&(o=t.markerOpacity),V(t.opacity)&&(o*=t.opacity);var a,l={};if(s){for(var h in s.stroke)s.stroke.hasOwnProperty(h)&&(U(s.stroke[h])||(l[h]=s.stroke[h]));for(var u in s.fill)s.fill.hasOwnProperty(u)&&(U(s.fill[u])||(l[u]=s.fill[u]))}var c,f=t.markerPath;a=q(f)&&"$"===f[0]?wn.getResource(f.substring(1,1/0))||[]:Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];for(var d=[],p=0;p<a.length;p++)(c=j({},c=q(a[p])?{path:a[p]}:a[p],l)).d=c.path,delete c.path,d.push(c);var g=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];o<1&&g.push('opacity="'+o+'"'),t.markerPathWidth&&t.markerPathHeight&&g.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),g.push('preserveAspectRatio="none"'),e&&g.push('width="'+e+'"'),n&&g.push('height="'+n+'"'),g.push("><defs></defs>");for(var m=0;m<d.length;m++)if(d[m].d instanceof Element)g.push(d[m].d.outerHTML);else{var A="<path ";for(var y in d[m])d[m].hasOwnProperty(y)&&(A+=" "+y+'="'+d[m][y]+'"');A+="></path>",g.push(A)}return g.push("</svg>"),"data:image/svg+xml;base64,"+function(t){if(Pt.btoa)return window.btoa(t);for(var e,n,r=String(t),i="",o=0,s=he;r.charAt(0|o)||(s="=",o%1);i+=s.charAt(63&e>>8-o%1*8)){if((n=r.charCodeAt(o+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|n}return i}(g.join(" "))}function fr(t,e){if(!t)return[];var n=t;Array.isArray(t)||(n=[t]);for(var r,i,o,s,a=[],l=we,h=n.length-1;h>=0;h--)if(t=n[h]){e&&(t=dr(t));for(var u=0;u<l.length;u++)if(Un(r=t[l[u]])&&(r=qn(r)),r){Array.isArray(r)||(r=[r]);for(var c=0;c<r.length;c++)"url("===r[c].slice(0,4)&&(r[c]=le(r[c])),i=Te[u],a.push([r[c],t[i[0]],t[i[1]]])}if("path"===t.markerType&&t.markerPath)if(o=Un(t.markerWidth)?200:t.markerWidth,s=Un(t.markerHeight)?200:t.markerHeight,Un(t.markerPath)){r=qn(t.markerPath);for(var f=t.markerPath,d=0;d<r.length;d++)t.markerPath=r[d],a.push([cr(t),o,s]);t.markerPath=f}else a.push([cr(t),o,s])}return a}function dr(t){if(!t)return null;var e=t;if(z)return e;for(var n,r=we,i=0,o=r.length;i<o;i++)(n=e[r[i]])&&(e[r[i]]=pr(n));return e}function pr(t){if(Un(t)&&t.stops){for(var e=t.stops,n=0;n<e.length;n++)e[n][1]=pr(e[n][1]);return t}return"url("===t.slice(0,4)&&(t=le(t)),t}function gr(t){return t&&t.colorStops}function mr(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var n=[],r=t.colorStops.length-1;r>=0;r--)n.push(t.colorStops[r].join());e.push(n.join(","))}return e.join("_")}function Ar(t,e){if(!t)return 1;var n=[];if(Array.isArray(t)){for(var r=0;r<t.length;r++)n.push(Ar(t[r],e));return n.sort().join(",")}var i=Object.keys(t).sort().reduce((function(n,r){return e&&0!==r.indexOf(e)||(n[r]=t[r]),n}),{});return qe(JSON.stringify(i))}function yr(t,e){function n(t,e){U(t.opacity)?t.opacity=e:t.opacity*=e}var r;if(Array.isArray(t)){r=[];for(var i=0;i<t.length;i++){var o=j({},t[i]);n(o,e),r.push(o)}}else n(r=j({},t),e);return r}function vr(...t){var e=t[0],n=Array.prototype.slice.call(t,1);if(n&&n.length||(n=[{}]),Array.isArray(e)){for(var r,i,o=[],s=0,a=e.length;s<a;s++){r=e[s],i={};for(var l=0,h=n.length;l<h;l++)Array.isArray(n[l])?U(n[l][s])?j(i,r||{}):j(i,r,n[l][s]):j(i,r,n[l]?n[l]:{});o.push(i)}return o}var u=[{},e];return u.push.apply(u,n),j.apply(this,u)}function xr(t){if(t.symbol&&(t=[t]),Array.isArray(t))return t;var e=t.$root,n=t.$iconset;if(t=t.style,e||n){e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),n&&"/"===n[n.length-1]&&(n=n.substring(0,n.length-1));!function(t,e){for(var n=0;n<t.length;n++){var{symbol:r}=t[n];r&&br(r,e)}}(t,(function(t){return"{$root}"===t?e:"{$iconset}"===t?n:null}))}return t}var _r=/(\{\$root\}|\{\$iconset\})/g;function br(t,e){for(var n in t)t.hasOwnProperty(n)&&"textName"!==n&&(q(t[n])&&t[n].length>2?t[n]=t[n].replace(_r,e):Un(t[n])?t[n]=wr(t[n],e):W(t[n])&&br(t[n],e))}function wr(t,e){var n=t.default;q(n)&&(t.default=n.replace(_r,e));var r=t.stops;if(!r)return t;for(var i=0;i<r.length;i++)Array.isArray(r[i])&&(q(r[i][1])?r[i][1]=r[i][1].replace(_r,e):Un(r[i][1])&&(r[i][1]=wr(r[i][1],e)));return t}function Tr(t,e,n,r,i){var o=1/Math.tan(e/2),s=1/(r-i);return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*s,t[15]=0,t}function Mr(t,e,n){var r,i,o,s,a,l,h,u,c,f,d,p,g=n[0],m=n[1],A=n[2];return e===t?(t[12]=e[0]*g+e[4]*m+e[8]*A+e[12],t[13]=e[1]*g+e[5]*m+e[9]*A+e[13],t[14]=e[2]*g+e[6]*m+e[10]*A+e[14],t[15]=e[3]*g+e[7]*m+e[11]*A+e[15]):(r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=a,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=f,t[10]=d,t[11]=p,t[12]=r*g+a*m+c*A+e[12],t[13]=i*g+l*m+f*A+e[13],t[14]=o*g+h*m+d*A+e[14],t[15]=s*g+u*m+p*A+e[15]),t}function Cr(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Sr(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],g=e[12],m=e[13],A=e[14],y=e[15],v=n[0],x=n[1],_=n[2],b=n[3];return t[0]=v*r+x*a+_*c+b*g,t[1]=v*i+x*l+_*f+b*m,t[2]=v*o+x*h+_*d+b*A,t[3]=v*s+x*u+_*p+b*y,v=n[4],x=n[5],_=n[6],b=n[7],t[4]=v*r+x*a+_*c+b*g,t[5]=v*i+x*l+_*f+b*m,t[6]=v*o+x*h+_*d+b*A,t[7]=v*s+x*u+_*p+b*y,v=n[8],x=n[9],_=n[10],b=n[11],t[8]=v*r+x*a+_*c+b*g,t[9]=v*i+x*l+_*f+b*m,t[10]=v*o+x*h+_*d+b*A,t[11]=v*s+x*u+_*p+b*y,v=n[12],x=n[13],_=n[14],b=n[15],t[12]=v*r+x*a+_*c+b*g,t[13]=v*i+x*l+_*f+b*m,t[14]=v*o+x*h+_*d+b*A,t[15]=v*s+x*u+_*p+b*y,t}function Ir(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],A=e[15],y=n*a-r*s,v=n*l-i*s,x=n*h-o*s,_=r*l-i*a,b=r*h-o*a,w=i*h-o*l,T=u*g-c*p,M=u*m-f*p,C=u*A-d*p,S=c*m-f*g,I=c*A-d*g,P=f*A-d*m,E=y*P-v*I+x*S+_*C-b*M+w*T;return E?(E=1/E,t[0]=(a*P-l*I+h*S)*E,t[1]=(i*I-r*P-o*S)*E,t[2]=(g*w-m*b+A*_)*E,t[3]=(f*b-c*w-d*_)*E,t[4]=(l*C-s*P-h*M)*E,t[5]=(n*P-i*C+o*M)*E,t[6]=(m*x-p*w-A*v)*E,t[7]=(u*w-f*x+d*v)*E,t[8]=(s*I-a*C+h*T)*E,t[9]=(r*C-n*I-o*T)*E,t[10]=(p*b-g*x+A*y)*E,t[11]=(c*x-u*b-d*y)*E,t[12]=(a*M-s*S-l*T)*E,t[13]=(n*S-r*M+i*T)*E,t[14]=(g*v-p*_-m*y)*E,t[15]=(u*_-c*v+f*y)*E,t):null}function Pr(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Er(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function Or(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Rr=kr;function kr(t,e,n){var r,i,o,s,a,l=t.length,h=Dr(t[0],e),u=[];for(n||(n=[]),r=1;r<l;r++){for(i=t[r-1],s=a=Dr(o=t[r],e);;){if(!(h|s)){u.push(i),s!==a?(u.push(o),r<l-1&&(n.push(u),u=[])):r===l-1&&u.push(o);break}if(h&s)break;h?h=Dr(i=Lr(i,o,h,e),e):s=Dr(o=Lr(i,o,s,e),e)}h=a}return u.length&&n.push(u),n}function Lr(t,e,n,r){return 8&n?[t[0]+(e[0]-t[0])*(r[3]-t[1])/(e[1]-t[1]),r[3]]:4&n?[t[0]+(e[0]-t[0])*(r[1]-t[1])/(e[1]-t[1]),r[1]]:2&n?[r[2],t[1]+(e[1]-t[1])*(r[2]-t[0])/(e[0]-t[0])]:1&n?[r[0],t[1]+(e[1]-t[1])*(r[0]-t[0])/(e[0]-t[0])]:null}function Dr(t,e){var n=0;return t[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}kr.polyline=kr,kr.polygon=function(t,e){var n,r,i,o,s,a,l;for(r=1;r<=8;r*=2){for(n=[],o=!(Dr(i=t[t.length-1],e)&r),s=0;s<t.length;s++)(l=!(Dr(a=t[s],e)&r))!==o&&n.push(Lr(i,a,r,e)),l&&n.push(a),i=a,o=l;if(!(t=n).length)break}return n};var Nr=Or(Rr),Fr=1/0,zr=1/0,Br=-1/0,Hr=-1/0;function jr(){return[Fr,zr,Br,Hr]}var Ur=jr();function Vr(t){t[0]=Fr,t[1]=zr,t[2]=Br,t[3]=Hr}function Gr(t,e){if(t)if(Array.isArray(t[0]))for(var n=0,r=t.length;n<r;n++)Gr(t[n],e);else if(Array.isArray(t))for(var i=0,o=t.length;i<o;i++){var{x:s,y:a}=t[i];e[0]=Math.min(s,e[0]),e[1]=Math.min(a,e[1]),e[2]=Math.max(s,e[2]),e[3]=Math.max(a,e[3])}else{var{x:l,y:h}=t;e[0]=Math.min(l,e[0]),e[1]=Math.min(h,e[1]),e[2]=Math.max(l,e[2]),e[3]=Math.max(h,e[3])}}function Wr(t,e,n,r,i){(0===e||e)&&(Array.isArray(e)&&(n=e[1],r=e[2],i=e[3],e=e[0]),t[0]=Math.min(e,t[0]),t[1]=Math.min(n,t[1]),t[2]=Math.max(r,t[2]),t[3]=Math.max(i,t[3]))}function qr(t){return t&&t[0]!==1/0&&void 0!==t[0]}function Xr(t,e=0){t[0]-=e,t[1]-=e,t[2]+=e,t[3]+=e}function Zr(t,e){var[n,r,i,o]=t;return n>=e[0]&&i<=e[2]&&r>=e[1]&&o<=e[3]}function Yr(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function Jr(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Qr(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Kr(t,e,n){return Qr(t,e,n)}function $r(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function ti(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function ei(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ni(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function ri(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=i*l-o*a,t[1]=o*s-r*l,t[2]=r*a-i*s,t}function ii(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.hypot?Math.hypot(n,r,i):function(...t){var e=0,n=t.length;for(;n--;)e+=t[n]*t[n];return Math.sqrt(e)}(n,r,i)}function oi(t,e){ti(t,t),ti(e,e);var n=ei(t,e);return n>1?0:n<-1?Math.PI:Math.acos(n)}var si,ai=function(){function t(t,e){this.normal=t,this.constant=e}return t.prototype.distanceToPoint=function(t){return ei(this.normal,t)+this.constant},t}(),li=[0,0,0],hi=[0,0,0],ui=[0,0,0],ci=[0,0,0],fi=[0,0,0],di=new ai([0,0,1],0),pi=function(){function t(t,e){this.setFromTo(t,e)}var e=t.prototype;return e.setFromTo=function(t,e){this.origin=t;var n=this.direction||[0,0,0];this.direction=ti(n,Kr(n,e,t))},e.distanceToPlane=function(t){var e=ei(t.normal,this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;var n=-(ei(this.origin,t.normal)+t.constant)/e;return n>=0?n:null},e.intersectGround=function(t){return this.intersectPlane(di,t)},e.distanceToGround=function(){return this.distanceToPlane(di)},e.intersectPlane=function(t,e){var n=this.distanceToPlane(t);return null===n?null:this.at(n,e)},e.intersectBox=function(t,e){var n,r,i,o,s,a,l=1/this.direction[0],h=1/this.direction[1],u=1/this.direction[2],c=this.origin;return l>=0?(n=(t[0][0]-c[0])*l,r=(t[1][0]-c[0])*l):(n=(t[1][0]-c[0])*l,r=(t[0][0]-c[0])*l),h>=0?(i=(t[0][1]-c[1])*h,o=(t[1][1]-c[1])*h):(i=(t[1][1]-c[1])*h,o=(t[0][1]-c[1])*h),n>o||i>r?null:((i>n||isNaN(n))&&(n=i),(o<r||isNaN(r))&&(r=o),u>=0?(s=(t[0][2]-c[2])*u,a=(t[1][2]-c[2])*u):(s=(t[1][2]-c[2])*u,a=(t[0][2]-c[2])*u),n>a||s>r?null:((s>n||n!=n)&&(n=s),(a<r||r!=r)&&(r=a),r<0?null:this.at(n>=0?n:r,e)))},e.intersectTriangle=function(t,e,n,r,i){Kr(hi,e,t),Kr(ui,n,t),ri(ci,hi,ui);var o,s=ei(this.direction,ci);if(s>0){if(r)return null;o=1}else{if(!(s<0))return null;o=-1,s=-s}Kr(fi,this.origin,t),ri(ui,fi,ui);var a=o*ei(this.direction,ui);if(a<0)return null;ri(hi,hi,fi);var l=o*ei(this.direction,hi);if(l<0)return null;if(a+l>s)return null;var h=-o*ei(fi,ci);return h<0?null:this.at(h/s,i)},e.at=function(t,e){var n,r;return n=e,r=this.origin,n[0]=r[0],n[1]=r[1],n[2]=r[2],Jr(e,e,ni(li,this.direction,t))},t}(),gi="core-fetch-image";var mi=!1;var Ai=[];function yi(t){return Ai.indexOf(t)>-1}function vi(t){yi(t)||Ai.push(t)}var xi={};function _i(t,e){xi[t]=e}var bi,wi="\n    var adapters = {};\n    // Dynamic Create Adapter\n    function createAdapter(key,code){\n        if(adapters[key]||!code){\n            return;\n        }\n        var func=new Function('exports',code+'(exports)');\n        var workerExports={};\n        func(workerExports,self);\n        adapters[key]=workerExports;\n        workerExports.initialize && workerExports.initialize(self);\n\n    }\n    onmessage = function (msg) {\n        msg = msg.data;\n        //createAdapter\n        if (msg.messageType === 'createAdapter') {\n           var key=msg.key;\n           var code=msg.code;\n           createAdapter(key,code);\n           postMessage({adapterName:key});\n           return;\n        }\n        // postMessage when main thread idle\n        if(msg.messageType==='idle'){\n            var messageRatio = msg.messageRatio;\n            handleMessageQueue(messageRatio);\n            return;\n        }\n        if (msg.messageType === 'batch') {\n            const messages = msg.messages;\n            if (messages) {\n                for (let i = 0; i < messages.length; i++) {\n                    dispatch(messages[i]);\n                }\n            }\n        } else {\n            dispatch(msg);\n        }\n    };\n\n    function dispatch(msg) {\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    }\n\n    var messageResultQueue = [];\n\n    function handleMessageQueue(messageRatio){\n       if(messageResultQueue.length===0){\n          return;\n       }\n       var count = Math.ceil((messageRatio || 1) * messageResultQueue.length);\n       var queues = messageResultQueue.slice(0, count);\n       queues.forEach(function(queue){\n          post(queue.callback,queue.err,queue.data,queue.buffers);\n       });\n       messageResultQueue=messageResultQueue.slice(count, Infinity);\n    }\n\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n\n    function joinQueue(callback,err,data,buffers){\n        messageResultQueue.push({\n            callback:callback,\n            err:err,\n            data:data,\n            buffers:buffers\n        });\n    }\n\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            joinQueue(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n",Ti="\n    workerExports = null;\n";function Mi(){if("undefined"==typeof window)return null;if(!bi){var t=function(){var t=wi;for(var e in xi){var n=xi[e];vi(e),X(n)&&0===n.length&&(n=n()),t+="\n    workerExports = {};\n    ("+n+")(workerExports, self);\n    adapters['"+e+"'] = workerExports",t+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return t+Ti}();bi=window.URL.createObjectURL(new Blob([t],{type:"text/javascript"})),xi={}}return bi}function Ci(t,e){if(xi[t]){var n=xi[t];X(n)&&0===n.length&&(n=n()),n="("+n+")";if(si){var r=si.workers||[];0===r.length&&console.error("workerpool workers count is 0");var i=0,o=function n(o){(o=o.data||{}).adapterName===t&&++i===r.length&&(r.forEach((function(t){t.removeEventListener("message",n)})),delete xi[t],e())};r.forEach((function(e){e.addEventListener("message",o),e.postMessage({key:t,code:n,messageType:"createAdapter"})}))}}else console.error("not find "+t+" adapter")}var Si,Ii="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,Pi=Math.max(Math.floor(Ii/2),1),Ei=function(){function t(t=50){this._limit=t,this._messages=[],this.buffers=[]}var e=t.prototype;return e.addMessage=function(t,e){if(this._messages.push(t),Array.isArray(e))for(var n=0;n<e.length;n++)this.buffers.indexOf(e[n])<0&&this.buffers.push(e[n])},e.isFull=function(){return this._messages.length>=this._limit},e.getMessage=function(){return{messageType:"batch",messages:this._messages}},t}(),Oi=function(){function t(){this.active={},this.workerCount="undefined"!=typeof window?B.workerCount||Pi:0,this._messages=[],this._messageBuffers=[]}var e=t.prototype;return e.acquire=function(t){if(!this.workers){this.workers=[];for(var e=Mi(),n=0;n<this.workerCount;n++){var r=new Worker(e);r.id=n,this.workers.push(r)}URL.revokeObjectURL(e),mi=!0}return this.active[t]=!0,this.workers.slice()},e.release=function(t){delete this.active[t],0===Object.keys(this.active).length&&(this.workers.forEach((function(t){t.terminate()})),this.workers=null)},e.addMessage=function(t,e,n){var r=this._messages[t];r&&r.length||(r=this._messages[t]=[new Ei]);var i=r[r.length-1];i.isFull()&&(i=new Ei,this._messages[t].push(i)),i.addMessage(e,n)},e.commit=function(){if(this.workers&&this._messages.length)for(var t=0;t<this._messages.length;t++)if(this._messages[t]&&this._messages[t].length){var e=this._messages[t].shift();this.workers[t].postMessage(e.getMessage(),e.buffers)}},e.getWorkers=function(){return this.workers||[]},e.broadcastIdleMessage=function(t){return this.getWorkers().forEach((function(e){e.postMessage({messageType:"idle",messageRatio:t})})),this},t}();function Ri(){return Si||(Si=new Oi,si=Si),Si}var ki=[],Li=[];function Di(t){var e=B.messagePostRatioPerWorker*(t?.5:1);Ri().commit(),Ri().broadcastIdleMessage(e),function(){if(0!==ki.length){for(var t=[],e=[],n=ki.length,r=0;r<n;r++){var i=ki[r];if(i.count--,-1===i.count)e.push(i);else{t.push(i);var o=i.run();i.results.push(o)}}ki=t,n=e.length;for(var s=0;s<n;s++){var a=e[s];a.resolve&&a.resolve(a.results)}}}(),Li.forEach((function(t){t()}))}var Ni=H();function Fi(){Di(),Ni=H(),requestIdleCallback(Fi)}function zi(){if(Pt.requestIdleCallback){var{idleForceTimeThreshold:t,idleLog:e}=B;H()-Ni>t&&(Di(!0),Ni=H(),e&&console.warn("did not apply for availability, forced run idle"))}else Di();Ht(zi)}var Bi=!1;function Hi(){Bi||(Bi=!0,Pt.requestIdleCallback&&requestIdleCallback(Fi),Ht(zi))}var ji,Ui="function"==typeof Map,Vi=function(){},Gi=function(){function t(t,e){this.max=t,this.onRemove=e||Vi,this.reset()}var e=t.prototype;return e.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var n=this.getAndRemove(this.order[0]);n&&this.onRemove(n)}return this},e.has=function(t){return t in this.data},e.keys=function(){return this.order},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},e.get=function(t){return this.has(t)?this.data[t]:null},e.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},e.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}();Ui&&(ji=function(){function t(t,e){this.max=t,this.onRemove=e||Vi,this.reset()}var e=t.prototype;return e.reset=function(){if(this.data)for(var t,e=Bt(this.data.values());!(t=e()).done;){var n=t.value;this.onRemove(n)}return this.data=new Map,this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this},e.keys=function(){for(var t,e=new Array(this.data.size),n=0,r=Bt(this.data.keys());!(t=r()).done;){var i=t.value;e[n++]=i}return e},e.shrink=function(){for(var t=this.data.keys(),e=t.next();this.data.size>this.max;){var n=this.getAndRemove(e.value);n&&this.onRemove(n),e=t.next()}},e.has=function(t){return this.data.has(t)},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data.get(t);return this.data.delete(t),e},e.get=function(t){return this.has(t)?this.data.get(t):null},e.remove=function(t){if(!this.has(t))return this;var e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this},e.setMaxSize=function(t){return this.max=t,this.data.size>this.max&&this.shrink(),this},t}());var Wi=Ui?ji:Gi,qi={exports:{}},Xi={exports:{}};Xi.exports=function(){function t(t,n,i,o,s){e(t,n,i||0,o||t.length-1,s||r)}function e(t,r,i,o,s){for(;o>i;){if(o-i>600){var a=o-i+1,l=r-i+1,h=Math.log(a),u=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*u*(a-u)/a)*(l-a/2<0?-1:1);e(t,r,Math.max(i,Math.floor(r-l*u/a+c)),Math.min(o,Math.floor(r+(a-l)*u/a+c)),s)}var f=t[r],d=i,p=o;for(n(t,i,r),s(t[o],f)>0&&n(t,i,o);d<p;){for(n(t,d,p),d++,p--;s(t[d],f)<0;)d++;for(;s(t[p],f)>0;)p--}0===s(t[i],f)?n(t,i,p):n(t,++p,o),p<=r&&(i=p+1),r<=p&&(o=p-1)}}function n(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function r(t,e){return t<e?-1:t>e?1:0}return t}();var Zi=Xi.exports;qi.exports=Ji,qi.exports.default=Ji;var Yi=Zi;function Ji(t,e){if(!(this instanceof Ji))return new Ji(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function Qi(t,e,n){if(!n)return e.indexOf(t);for(var r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function Ki(t,e){$i(t,0,t.children.length,e,t)}function $i(t,e,n,r,i){i||(i=ao(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o,s=e;s<n;s++)o=t.children[s],to(i,t.leaf?r(o):o);return i}function to(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function eo(t,e){return t.minX-e.minX}function no(t,e){return t.minY-e.minY}function ro(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function io(t){return t.maxX-t.minX+(t.maxY-t.minY)}function oo(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function so(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function ao(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function lo(t,e,n,r,i){for(var o,s=[e,n];s.length;)(n=s.pop())-(e=s.pop())<=r||(o=e+Math.ceil((n-e)/r/2)*r,Yi(t,o,e,n,i),s.push(e,o,o,n))}Ji.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],r=this.toBBox;if(!so(t,e))return n;for(var i,o,s,a,l=[];e;){for(i=0,o=e.children.length;i<o;i++)s=e.children[i],so(t,a=e.leaf?r(s):s)&&(e.leaf?n.push(s):oo(t,a)?this._all(s,n):l.push(s));e=l.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!so(t,e))return!1;for(var r,i,o,s,a=[];e;){for(r=0,i=e.children.length;r<i;r++)if(o=e.children[r],so(t,s=e.leaf?n(o):o)){if(e.leaf||oo(t,s))return!0;a.push(o)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=ao([]),this},remove:function(t,e){if(!t)return this;for(var n,r,i,o,s=this.data,a=this.toBBox(t),l=[],h=[];s||l.length;){if(s||(s=l.pop(),r=l[l.length-1],n=h.pop(),o=!0),s.leaf&&-1!==(i=Qi(t,s.children,e)))return s.children.splice(i,1),l.push(s),this._condense(l),this;o||s.leaf||!oo(s,a)?r?(n++,s=r.children[n],o=!1):s=null:(l.push(s),h.push(n),n=0,r=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:eo,compareMinY:no,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,r){var i,o=n-e+1,s=this._maxEntries;if(o<=s)return Ki(i=ao(t.slice(e,n+1)),this.toBBox),i;r||(r=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,r-1))),(i=ao([])).leaf=!1,i.height=r;var a,l,h,u,c=Math.ceil(o/s),f=c*Math.ceil(Math.sqrt(s));for(lo(t,e,n,f,this.compareMinX),a=e;a<=n;a+=f)for(lo(t,a,h=Math.min(a+f-1,n),c,this.compareMinY),l=a;l<=h;l+=c)u=Math.min(l+c-1,h),i.children.push(this._build(t,l,u,r-1));return Ki(i,this.toBBox),i},_chooseSubtree:function(t,e,n,r){for(var i,o,s,a,l,h,u,c,f,d;r.push(e),!e.leaf&&r.length-1!==n;){for(u=c=1/0,i=0,o=e.children.length;i<o;i++)l=ro(s=e.children[i]),f=t,d=s,(h=(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-l)<c?(c=h,u=l<u?l:u,a=s):h===c&&l<u&&(u=l,a=s);e=a||e.children[0]}return e},_insert:function(t,e,n){var r=this.toBBox,i=n?t:r(t),o=[],s=this._chooseSubtree(i,this.data,e,o);for(s.children.push(t),to(s,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},_split:function(t,e){var n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);var o=this._chooseSplitIndex(n,i,r),s=ao(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,Ki(n,this.toBBox),Ki(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)},_splitRoot:function(t,e){this.data=ao([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Ki(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var r,i,o,s,a,l,h,u,c,f,d,p,g,m;for(l=h=1/0,r=e;r<=n-e;r++)i=$i(t,0,r,this.toBBox),o=$i(t,r,n,this.toBBox),c=i,f=o,d=void 0,p=void 0,g=void 0,m=void 0,d=Math.max(c.minX,f.minX),p=Math.max(c.minY,f.minY),g=Math.min(c.maxX,f.maxX),m=Math.min(c.maxY,f.maxY),s=Math.max(0,g-d)*Math.max(0,m-p),a=ro(i)+ro(o),s<l?(l=s,u=r,h=a<h?a:h):s===l&&a<h&&(h=a,u=r);return u},_chooseSplitAxis:function(t,e,n){var r=t.leaf?this.compareMinX:eo,i=t.leaf?this.compareMinY:no;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)},_allDistMargin:function(t,e,n,r){t.children.sort(r);var i,o,s=this.toBBox,a=$i(t,0,e,s),l=$i(t,n-e,n,s),h=io(a)+io(l);for(i=e;i<n-e;i++)o=t.children[i],to(a,t.leaf?s(o):o),h+=io(a);for(i=n-e-1;i>=e;i--)o=t.children[i],to(l,t.leaf?s(o):o),h+=io(l);return h},_adjustParentBBoxes:function(t,e,n){for(var r=n;r>=0;r--)to(e[r],t)},_condense:function(t){for(var e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():Ki(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var ho=Or(qi.exports),uo={},co=function(){function t(){this._tree=ho(9,["[0]","[1]","[2]","[3]"])}var e=t.prototype;return e.collides=function(t){return[uo.minX,uo.minY,uo.maxX,uo.maxY]=t,this._tree.collides(uo)},e.insertBox=function(t){return this._tree.insert(t),this},e.bulkInsertBox=function(t){return this._tree.load(t),this},e.clear=function(){return this._tree.clear(),this},t}(),fo=new Wi(5e4);function po(t,e,n){var r=t.font,i=t.fillStyle,o=t.strokeStyle,s=e.textHaloFill||go,a=e.textHaloRadius||0,l=e.textHaloOpacity;V(l)||(l=1);var h=r+"_"+i+"_"+s+"_"+a+"_"+l+"_"+n,u=fo.get(h);if(!u){var c=0!==l&&0!==a,f=2*(1.2*(e.textSize||14)+a),d=Oo.createCanvas(f,f);d.style.width=f/2+"px",d.style.height=f/2+"px";var p=f/4,g=f/4,m=Oo.getCanvas2DContext(d);m.scale(2,2),m.font=r,m.textAlign="center",m.textBaseline="middle",c&&(m.strokeStyle=o,m.lineWidth=2*a,m.globalAlpha=1,m.globalAlpha*=l,m.strokeText(n,p,g),m.globalAlpha=1),m.fillStyle=i,m.fillText(n,p,g),u=d,fo.add(h,u)}return u}var go="#000",mo=!1,Ao=null,yo=Math.PI/180,vo=new co,xo=new co;var _o=function(){for(var t={},e=32;e<128;e++){var n=String.fromCharCode(e);t[n]=n}return t}();function bo(t){if(t.toReversed)return t.toReversed();for(var e=[],n=0,r=t.length-1;n<=r;n++)e[n]=t[r-n];return e}function wo(t,e,n,r,i){var o=t.x,s=t.y,a=e.x-o,l=e.y-s,h=Math.atan2(l,a),u=h/Math.PI*180;return"left"===r?h=(u+=180)/180*Math.PI:"down"!==r||i?"up"!==r||i?h:h=(u+=90)/180*Math.PI:h=(u-=90)/180*Math.PI}function To(t,e){var n=e,r=e;return _o[t]&&(n=e/4,r=e),Math.sqrt(n*n+r*r)}function Mo(t,e){var{distance:n,p1:r,p2:i}=t,o=i.x-r.x,s=i.y-r.y,a=(i.z||0)-(r.z||0),l=e/n,h=r.x+l*o,u=r.y+l*s,c=(r.z||0)+l*a;return new Vt(h,u,c)}function Co(t){for(var e=t.length,n=t[0].point,r=t[e-1].point,i=jr(),o=0,s=t.length;o<s;o++){Gr(t[o].point,i)}var[a,l,h,u]=i,c=!0;return u-l>h-a&&(c=!1),c?n.x<r.x?"right":"left":n.y<r.y?"down":"up"}function So(t,e,n,r){var i=Po(t),o=[],s=0,a=!1;vo.clear();for(var l=1,h=0,u=e.length;h<u;h++){for(var c=e[h],f=To(c,n),d=f+s,p=l,g=t.length;p<g;p++){var m=t[p-1],A=t[p];if(!(A.distance<d)){l=p;var y=(d-m.distance)/(A.distance-m.distance),v=A.x-m.x,x=A.y-m.y,_=new Vt(m.x+v*y,m.y+x*y),{x:b,y:w}=_,T=f/3,M=[b-T,w-T,b+T,w+T];if(r&&r.collides(M)){a=!0;break}if(vo.collides(M)){a=!0;break}vo.insertBox(M),T=f/2,o.push({char:c,charSize:f,point:_,bbox:[b-T,w-T,b+T,w+T]}),s+=f;break}}if(a)break}return a||i<s?[]:o}function Io(t,e,n,r,i,o,s,a,l,h){var u=(t+n)/2,c=(e+r)/2,f=(n+i)/2,d=(r+o)/2,p=(i+s)/2,g=(o+a)/2,m=Math.sqrt((n-t)*(n-t)+(r-e)*(r-e)),A=Math.sqrt((i-n)*(i-n)+(o-r)*(o-r)),y=m/(m+A),v=A/(A+Math.sqrt((s-i)*(s-i)+(a-o)*(a-o))),x=u+(f-u)*y,_=c+(d-c)*y,b=f+(p-f)*v,w=d+(g-d)*v,T=x+(f-x)*l+n-x,M=_+(d-_)*l+r-_,C=b+(f-b)*l+i-b,S=w+(d-w)*l+o-w,I=[T,M,C,S];return h<1?function(t,e,n,r,i,o,s,a,l,h){var u=1-t,c=1-e,f=n*c*c+2*i*e*c+s*e*e,d=i*c*c+2*s*e*c+l*e*e,p=r*c*c+2*o*e*c+a*e*e,g=o*c*c+2*a*e*c+h*e*e;return[(n*u*u+2*i*t*u+s*t*t)*c+(i*u*u+2*s*t*u+l*t*t)*e,(r*u*u+2*o*t*u+a*t*t)*c+(o*u*u+2*a*t*u+h*t*t)*e,f*u+d*t,p*u+g*t,f*c+d*e,p*c+g*e]}(0,h,n,r,T,M,C,S,i,o):I}function Po(t){if(t.length<2)return 0;var e=0;t[0].distance=0;for(var n=1,r=t.length;n<r;n++){var i=t[n-1],o=t[n],s=i.distanceTo(o);o.distance=s+i.distance,e+=s}return e}function Eo(t,e,n){var r=t.x,i=t.y,o=e.x,s=e.y;return new Vt(r+(o-r)*n,i+(s-i)*n)}var Oo={getCanvas2DContext:function(t){return t.getContext("2d",{willReadFrequently:!0})},setHitTesting:function(t){mo=t},createCanvas:function(t,e,n){var r;return z?r=new n(t,e):((r=Qe("canvas")).width=t,r.height=e),r},prepareCanvasFont:function(t,e){"top"!==t.textBaseline&&(t.textBaseline="top");var n=Ge(e);t.font!==n&&(t.font=n);var r=e.textFill;r||(r="#000");var i=Oo.getRgba(r,e.textOpacity);t.fillStyle!==i&&(t.fillStyle=i)},prepareCanvas:function(t,e,n,r){if(e){var i=e.lineWidth;U(i)||t.lineWidth===i||(t.lineWidth=i);var o=e.linePatternFile,s=e.lineColor||go;if(r)t.strokeStyle="#000";else if(o&&n){var a;(e.linePatternDx||e.linePatternDy)&&(a=[e.linePatternDx,e.linePatternDy]),Oo._setStrokePattern(t,o,i,a,n),e.lineDasharray=[]}else gr(s)?e.lineGradientExtent?t.strokeStyle=Oo._createGradient(t,s,e.lineGradientExtent):t.strokeStyle=go:(Array.isArray(s)&&(s=Oo.normalizeColorToRGBA(s)),t.strokeStyle=s);e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&ie(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var l=e.polygonPatternFile,h=e.polygonFill||"rgba(255,255,255,0)";if(r)t.fillStyle="#000";else if(l&&n){var u=Lo(l),c=n.getImage([u,null,null]);if(c||(c=n.getImage([u+"-texture",null,i])),Gt(u)&&c instanceof Image&&(Pt.edge||Pt.ie)){var f=c.width||20,d=c.height||20,p=Oo.createCanvas(f,d);Oo.image(p.getContext("2d"),c,0,0,f,d),c=p}c?(t.fillStyle=t.createPattern(c,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",u)}else gr(h)?e.polygonGradientExtent?t.fillStyle=Oo._createGradient(t,h,e.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)":(Array.isArray(h)&&(h=Oo.normalizeColorToRGBA(h)),t.fillStyle=h)}},_createGradient:function(t,e,n){var r=null,i=e.places,o=n.getMin(),s=n.getMax(),a=n.getWidth(),l=n.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(i){if(6!==i.length)throw new Error("A radial gradient's places should have 6 numbers.");i=[o.x+i[0]*a,o.y+i[1]*l,a*i[2],o.x+i[3]*a,o.y+i[4]*l,a*i[5]]}else{var h=n.getCenter()._round();i=[h.x,h.y,Math.abs(h.x-o.x),h.x,h.y,0]}r=t.createRadialGradient.apply(t,i)}}else{if(i){if(4!==i.length)throw new Error("A linear gradient's places should have 4 numbers.");i=[o.x+i[0]*a,o.y+i[1]*l,o.x+i[2]*a,o.y+i[3]*l]}else i=[o.x,o.y,s.x,o.y];r=t.createLinearGradient.apply(t,i)}return e.colorStops.forEach((function(t){r.addColorStop.apply(r,t)})),r},_setStrokePattern:function(t,e,n,r,i){var o,s=Lo(e);if(z)o=i.getImage([s,null,n]);else{var a=s+"-texture-"+n;if(!(o=i.getImage(a))){var l=i.getImage([s,null,null]);if(l){var h;h=l.width&&l.height?Math.round(l.width*n/l.height):n;var u=Oo.createCanvas(h,n,t.canvas.constructor);Oo.image(u.getContext("2d"),l,0,0,h,n),i.addResource([a,null,n],u),o=u}}}o?(t.strokeStyle=t.createPattern(o,"repeat"),t.strokeStyle.linePatternOffset=r):"undefined"!=typeof console&&console.warn("img not found for",s)},clearRect:function(t,e,n,r,i){t.canvas._drawn=!1,t.clearRect(e,n,r,i)},fillCanvas:function(t,e,n,r){if(mo&&(e=1),t.canvas._drawn=!0,0!==e){var i,o=Oo._isPattern(t.fillStyle),s=t.fillStyle&&t.fillStyle.polygonPatternOffset,a=s?s[0]:0,l=s?s[1]:0;U(e)&&(e=1),e<1&&(i=t.globalAlpha,t.globalAlpha*=e),o&&(n=n||0,r=r||0,t.translate(n+a,r+l)),t.fill(),o&&t.translate(-n-a,-r-l),e<1&&(t.globalAlpha=i)}},getRgba:function(t,e){return U(e)&&(e=1),"#"!==t[0]?(Array.isArray(t)&&(t=Oo.normalizeColorToRGBA(t,e)),t):(7===t.length?(n=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),i=parseInt(t.substring(5,7),16)):(n=17*parseInt(t.substring(1,2),16),r=17*parseInt(t.substring(2,3),16),i=17*parseInt(t.substring(3,4),16)),"rgba("+n+","+r+","+i+","+e+")");var n,r,i},normalizeColorToRGBA:function(t,e=1){return"rgba("+255*t[0]+", "+255*t[1]+", "+255*t[2]+", "+(4===t.length?t[3]:1)*e+")"},image:function(t,e,n,r,i,o){t.canvas._drawn=!0;try{V(i)&&V(o)?t.drawImage(e,n,r,i,o):t.drawImage(e,n,r)}catch(s){console&&(console.warn("error when drawing image on canvas:",s),console.warn(e))}},text:function(t,e,n,r,i){return Oo._textOnMultiRow(t,i.rows,r,n,i.size,i.rawSize)},_textOnMultiRow:function(t,e,n,r,i,o){var s,a,l=je(i,n.textHorizontalAlignment,n.textVerticalAlignment),h=o.height+n.textLineSpacing,u=r.add(0,l.y),c=n.textMaxHeight,f=0;Vr(Ur);for(var d=0,p=e.length;d<p;d++){s=e[d].text,a=je(e[d].size,n.textHorizontalAlignment,n.textVerticalAlignment);var g=u.add(a.x,d*h);Oo._textOnLine(t,s,g,n.textHaloRadius,n.textHaloFill,n.textHaloOpacity);var m=e[d].size,A=g.x,y=g.y,v=A+m.width,x=y+m.height;if(Wr(Ur,A,y,v,x),c>0&&(f+=h)+m.height>=c)break}return Ur},_textOnLine:function(t,e,n,r,i,o){mo&&(o=1);var s,a,l=0!==o&&0!==r;t.textBaseline="top";var h=t.shadowBlur,u=t.shadowOffsetX,c=t.shadowOffsetY;if(l){var f=t.globalAlpha;t.globalAlpha*=o,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*r,Array.isArray(i)&&(i=Oo.normalizeColorToRGBA(i)),t.strokeStyle=i,t.strokeText(e,n.x,n.y+1),t.miterLimit=10,t.globalAlpha=f,s=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",a=t.fillStyle,t.fillStyle="#000"}h&&l&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),Oo.fillText(t,e,n),s&&(t.globalCompositeOperation=s,Oo.fillText(t,e,n,a),h&&(t.shadowBlur=h,t.shadowOffsetX=u,t.shadowOffsetY=c))},fillText:function(t,e,n,r){t.canvas._drawn=!0,r&&(t.fillStyle=r),t.fillText(e,n.x,n.y+1)},textAlongLine:function(t,e,n,r,i,o){if(e){var s=r.textSize||14,a=r.textSpacing||0,l=function(t,e){for(var n=0,r=0,i=t.length;r<i;r++)n+=To(t[r],e);return n}(e,s);if(!(a<l)){Array.isArray(n[0])||(n=[n]);var h=t.textBaseline,u=t.textAlign,c=t.strokeStyle,f=t.globalAlpha,d=t.lineWidth,p=r.textAlongDebug,g=r.textHaloFill||go,m=r.textHaloRadius||0,A=r.textHaloOpacity;V(A)||(A=1);var y=0!==A&&0!==m;t.textBaseline="middle",t.textAlign="center",y&&(Array.isArray(g)&&(g=Oo.normalizeColorToRGBA(g)),t.strokeStyle=g,t.lineWidth=2*m),xo.clear();var v=jr(),x=e.split(""),_=function(t){for(var e=0,n=t.length;e<n;e++){var r=t[e];if(!_o[r])return!1}return!0}(x);if(n.forEach((function(e){if(!(Po(e)<l)){var n=function(t,e){e=Object.assign({segDistance:1,isGeo:!0},e);for(var n=Math.max(e.segDistance,1e-17),r=[],i=0,o=0,s=0,a=t.length;s<a-1;s++){var l=t[s],h=t[s+1],u=h.distanceTo(l);r[o]={p1:l,distance:u,p2:h},o++,i+=u}if(i<=n)return[{distance:i,points:t}];var c,f=r.length;o=0;for(var d=0,p=[],g=[r[0].p1];o<f;){var{distance:m,p2:A}=r[o];if((d+=m)<n)g.push(A),o++;else if(d!==n){if(d>n){var y=n-(d-m);c=Mo(r[o],y),g.push(c),p.push(g),d=0,r[o].p1=c,r[o].distance=m-y,g=[c]}}else g.push(A),d=0,p.push(g),g=[A],o++}g.length&&p.push(g);for(var v=[],x=0,_=p.length;x<_;x++){var b=p[x];v[x]={points:b,distance:Po(b)}}return v}(e,{segDistance:a});if(n&&n.length)for(var i=0,h=n.length;i<h;i++){var u=n[i];if(!(u.distance<l)){var c=u.points;if(p){var f=t.fillStyle;t.fillStyle="red";var{x:d,y:g}=c[0];t.beginPath(),t.fillRect(d-2,g-2,4,4),t.fillStyle=f}var m=x,A=So(c,m,s,o);if(A.length){var y=Co(A);"left"===y&&(A=So(c,m=bo(m),s,o)),"up"!==y||_||(A=So(c,m=bo(m),s,o));for(var b=!1,w=0,T=A.length;w<T;w++){var{bbox:M}=A[w];if(xo.collides(M)){b=!0;break}if(o&&o.collides(M)){b=!0;break}}if(!b)for(var C=0,S=A.length;C<S;C++){var I=void 0,P=void 0;0===C?(I=A[C].point,P=A[1].point):C===S-1?(I=A[S-2].point,P=A[S-1].point):(I=A[C-1].point,P=A[C].point);var E=m[C],{point:O,bbox:R}=A[C];xo.insertBox(R),o&&o.insertBox(R);var{x:k,y:L}=O,D=wo(I,P,0,y,_);t.save(),t.translate(k,L),t.rotate(D);var N=po(t,r,E),{width:F,height:z}=N;if(t.drawImage(N,-F/4,-z/4,F/2,z/2),t.restore(),Wr(v,R),p){var B=t.strokeStyle,H=t.lineWidth;t.strokeStyle="red",t.lineWidth=.5;var[j,U,V,G]=R;t.beginPath(),t.rect(j,U,V-j,G-U),t.stroke(),t.lineWidth=H,t.strokeStyle=B}}}}}}})),t.textBaseline=h,t.textAlign=u,t.strokeStyle=c,t.globalAlpha=f,t.lineWidth=d,qr(v))return v}}},_stroke:function(t,e,n,r){if(mo&&(e=1),t.canvas._drawn=!0,0!==e){var i,o=t.strokeStyle&&t.strokeStyle.linePatternOffset,s=o?o[0]:0,a=o?o[1]:0,l=Oo._isPattern(t.strokeStyle)&&(!U(n)&&!U(r)||!U(s)&&!U(a));U(e)&&(e=1),e<1&&(i=t.globalAlpha,t.globalAlpha*=e),l&&(n=n||0,r=r||0,t.translate(n+s,r+a)),t.stroke(),l&&t.translate(-n-s,-r-a),e<1&&(t.globalAlpha=i)}},_gradientPath:function(t,e,n,r,i=!1){if(V(r)||(r=1),mo&&(r=1),0!==r&&0!==t.lineWidth){var o=t.globalAlpha;t.globalAlpha*=r;var s,a,l,h,u,c,f,d=t.lineColorIn,p=function(t){if(V(t.minStep))return t.minStep;for(var e=t.colors||[],n=e.length,r=[],i=0;i<n;i++)r[i]=e[i][0];r.sort((function(t,e){return t-e}));for(var o=1/0,s=1;s<n;s++){var a=r[s-1],l=r[s]-a;o=Math.min(o,l)}return t.minStep=o,o}(d),g=Po(e),m=0,[A,y,v,x]=d.getColor(0);s="rgba("+A+", "+y+", "+v+", "+x+")";var _=e[0];if(l=_.x,h=_.y,i){var b=e[e.length-1];_.equals(b)||e.push(_)}for(var w=n&&Array.isArray(n)&&n.length>1,T=function(){!w&&f&&(t.strokeStyle=a,t.beginPath(),t.moveTo(l,h),t.lineTo(u,c),t.lineTo(f.x,f.y),t.stroke());var e=t.createLinearGradient(l,h,u,c);e.addColorStop(0,s),e.addColorStop(1,a),t.strokeStyle=e,t.beginPath(),t.moveTo(l,h),t.lineTo(u,c),t.stroke(),s=a,l=u,h=c},M=1,C=e.length;M<C;M++){var S=e[M-1],I=e[M];f=e[M+1];var P=I.x,E=I.y,O=I.distanceTo(S)/g;if(O<=p){var[R,k,L,D]=d.getColor(m+O);a="rgba("+R+", "+k+", "+L+", "+D+")",u=P,c=E,T()}else{var N=Math.ceil(O/p);f=I;for(var F=1;F<=N;F++){var z=Math.min(F*p,O),[B,H,j,U]=d.getColor(m+z);if((a="rgba("+B+", "+H+", "+j+", "+U+")")!==s){var G=Eo(S,I,z/O);u=G.x,c=G.y,T()}}}m+=O}t.globalAlpha=o}},_path:function(t,e,n,r,i){if(ie(e))for(var o,s,a,l,h,u,c=ie(n),f=!0!==i&&Oo._isPattern(t.strokeStyle),d=0,p=e.length;d<p;d++)if(o=e[d],!c||t.setLineDash)t.lineTo(o.x,o.y),f&&d>0&&(s=e[d-1],h=o,u=void 0,u=ue((l=s).x,l.y,h.x,h.y),t.save(),t.rotate(u),Oo._stroke(t,r),t.restore(),t.beginPath(),t.moveTo(o.x,o.y));else if(c){if(d===p-1)break;a=e[d+1],Ro(t,o,a,n)}},path:function(t,e,n,r,i){ie(e)&&(t.lineColorIn?this._gradientPath(t,e,i,n):(t.beginPath(),t.moveTo(e[0].x,e[0].y),Oo._path(t,e,i,n)),Oo._stroke(t,n))},_multiClip:function(t,e){e&&0!==e.length&&e.forEach((function(e){for(var n=0,r=e.length;n<r;n++){var i=e[n],o=i.x,s=i.y;0===n?t.moveTo(o,s):t.lineTo(o,s),n===r-1&&(o=e[0].x,s=e[0].y,t.lineTo(o,s))}}))},polygon:function(t,e,n,r,i,o){if(t.isMultiClip)Oo._multiClip(t,e);else if(t.isClip)Oo._multiClip(t,Array.isArray(e[0])?e:[e]);else if(ie(e)){var s=Oo._isPattern(t.strokeStyle),a=ie(i)&&!t.setLineDash||s&&!o;ie(e[0])||(e=[e]);var l=t,h=t.dpr||1,u=1!==h;e.length>1&&!z&&(Ao||(Ao=Oo.createCanvas(1,1)),t.canvas._drawn=!1,Ao.width=t.canvas.width,Ao.height=t.canvas.height,No(t=Ao.getContext("2d"),[]),No(t,i),Do(t,l),u&&t.scale(h,h));var c,f,d,p=t.lineColorIn,g=t.lineWidth;if(a){for(t.save(),f=0,d=e.length;f<d;f++)ie(e[f])&&(p&&(t.lineWidth=.1),Oo._ring(t,e[f],null,0,!0),c=r,f>0&&(t.globalCompositeOperation="destination-out",c=1),Oo.fillCanvas(t,c,e[f][0].x,e[f][0].y),f>0?t.globalCompositeOperation="source-over":d>1&&(t.fillStyle="#fff"),Oo._stroke(t,0),t.lineWidth=g,p&&Oo._gradientPath(t,e,null,0,!0));t.restore()}var m=t.fillStyle;for(f=0,d=e.length;f<d;f++)ie(e[f])&&(p&&(t.lineWidth=.1),o?(Oo.paintSmoothLine(t,e[f],n,o,!0),t.closePath()):Oo._ring(t,e[f],i,n),a||(c=r,f>0&&(t.globalCompositeOperation="destination-out",c=1),Oo.fillCanvas(t,c,e[f][0].x,e[f][0].y),f>0?t.globalCompositeOperation="source-over":d>1&&(t.fillStyle="#fff")),Oo._stroke(t,n),t.lineWidth=g,p&&Oo._gradientPath(t,e[f],i,n,!0));if(t.fillStyle!==m&&(t.fillStyle=m),e.length>1&&!z){if(u){var A=1/h;l.scale(A,A)}l.drawImage(Ao,0,0),u&&l.scale(h,h),l.canvas._drawn=t.canvas._drawn,Do(l,t)}}},_ring:function(t,e,n,r,i){var o=Oo._isPattern(t.strokeStyle);i||!o||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),Oo._path(t,e,n,r,i),o||t.closePath()},paintSmoothLine_bak:function(t,e,n,r,i,o,s){if(e)if(e.length<=2||!r)Oo.path(t,e,n);else{var a,l=e.length,h=i?l:l-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==s&&(h-=Math.max(h-o-1,0));for(var u=0;u<h;u++){var c=e[u].x,f=e[u].y,d=void 0,p=void 0,g=void 0,m=void 0,A=void 0,y=void 0;u-1<0?i?(d=e[h-1].x,p=e[h-1].y):(d=e[u+1].x,p=e[u+1].y):(d=e[u-1].x,p=e[u-1].y),u+1<l?(g=e[u+1].x,m=e[u+1].y):(g=e[u+1-l].x,m=e[u+1-l].y),u+2<l?(A=e[u+2].x,y=e[u+2].y):i?(A=e[u+2-l].x,y=e[u+2-l].y):(A=e[u].x,y=e[u].y);var v=Io(d,p,c,f,g,m,A,y,r,u===h-1?s:1);if(u===h-1&&s>=0&&s<1){t.bezierCurveTo(v[0],v[1],v[2],v[3],v[4],v[5]),e.splice(h-1,l-(h-1)-1);var x=new Vt(v[4],v[5]);x.prevCtrlPoint=new Vt(v[2],v[3]),e.push(x),l=e.length}else t.bezierCurveTo(v[0],v[1],v[2],v[3],g,m);e[u].nextCtrlPoint=v.slice(0,2),e[u].prevCtrlPoint=a?a.slice(2):null,a=v}!i&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[l-1].prevCtrlPoint||(e[l-1].prevCtrlPoint=e[l-2].nextCtrlPoint),Oo._stroke(t,n)}},paintSmoothLine:function(t,e,n,r,i,o,s){if(e)if(e.length<=2||!r)Oo.path(t,e,n);else{var a,l,h=e.length,u=i?h:h-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==s&&(u-=Math.max(u-o-1,0));for(var c=0;c<u;c++){var f=e[c].x,d=e[c].y,p=void 0,g=void 0,m=void 0,A=void 0,y=void 0,v=void 0;c-1<0?i?(p=e[u-1].x,g=e[u-1].y):(p=e[c+1].x,g=e[c+1].y):(p=e[c-1].x,g=e[c-1].y),c+1<h?(m=e[c+1].x,A=e[c+1].y):(m=e[c+1-h].x,A=e[c+1-h].y),c+2<h?(y=e[c+2].x,v=e[c+2].y):i?(y=e[c+2-h].x,v=e[c+2-h].y):(y=e[c].x,v=e[c].y);var x=e[c],_=Io(p,g,f,d,m,A,y,v,r,c===u-1?s:1);if(c===u-1&&s>=0&&s<1){t.bezierCurveTo(_[0],_[1],_[2],_[3],_[4],_[5]),e.splice(u-1,h-(u-1)-1);var b=new Vt(_[4],_[5]);e.push(b),h=e.length}else t.bezierCurveTo(_[0],_[1],_[2],_[3],m,A);0===c?(x.arrowNextPoint=x.arrowNextPoint||new Vt(0,0),a=_[2],l=_[3],x.arrowNextPoint.x=a,x.arrowNextPoint.y=l):(x.arrowPrePoint=x.arrowPrePoint||new Vt(0,0),x.arrowPrePoint.x=a,x.arrowPrePoint.y=l,a=_[2],l=_[3],c===u-1&&e[c+1]&&(e[c+1].arrowPrePoint=e[c+1].arrowPrePoint||new Vt(0,0),e[c+1].arrowPrePoint.x=_[0],e[c+1].arrowPrePoint.y=_[1]))}Oo._stroke(t,n)}},_arcBetween:function(t,e,n,r){var i=Math.abs(r),o=e.distanceTo(n),s=Math.abs(o/2/Math.sin(i/2)),a=Math.asin((n.y-e.y)/o);e.x>n.x&&(a=Math.PI-a);var l=a-(90*yo-i/2),h=Math.cos(l)*s,u=Math.sin(l)*s,c=e.x+h,f=e.y+u,d=Math.asin((n.y-f)/s);c>n.x&&(d=Math.PI-d);var p=d+i;if(r<0){d+=Math.PI,p+=Math.PI;var g=(e.x+n.x)/2,m=(e.y+n.y)/2;c=g-(c-g),f=m-(f-m)}t.beginPath(),t.arc(c,f,s,d,p);var A=(p-d)/100,y=Math.cos(d+A)*s+c,v=Math.sin(d+A)*s+f,x=Math.cos(p-A)*s+c,_=Math.sin(p-A)*s+f;return e.arrowNextPoint=e.arrowNextPoint||new Vt(0,0),n.arrowPrePoint=n.arrowPrePoint||new Vt(0,0),r<0?(e.arrowNextPoint.x=y,e.arrowNextPoint.y=v,n.arrowPrePoint.x=x,n.arrowPrePoint.y=_):(e.arrowNextPoint.x=x,e.arrowNextPoint.y=_,n.arrowPrePoint.x=y,n.arrowPrePoint.y=v),[c,f]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,n,r){t.beginPath();var i=e[0];t.moveTo(i.x,i.y);var o=[t];o.push.apply(o,e.splice(1)),Oo._bezierCurveTo.apply(Oo,o),Oo.fillCanvas(t,r),Oo._stroke(t,n)},_bezierCurveTo:function(t,e,n,r){t.bezierCurveTo(e.x,e.y,n.x,n.y,r.x,r.y)},ellipse:function(t,e,n,r,i,o,s){var a,l,h,u,c,f,d,p,g;t.beginPath(),n===r&&n===i?t.arc(e.x,e.y,n,0,2*Math.PI):t.ellipse?r!==i?(t.ellipse(e.x,e.y,n,r,0,180*yo,360*yo,!1),t.ellipse(e.x,e.y,n,i,0,0,180*yo,!1)):t.ellipse(e.x,e.y,n,r,0,0,360*yo,!1):(a=e.x,l=e.y,d=(h=n)*(f=.5522848),p=(u=r)*f,g=(c=i)*f,t.moveTo(a-h,l),t.bezierCurveTo(a-h,l-p,a-d,l-u,a,l-u),t.bezierCurveTo(a+d,l-u,a+h,l-p,a+h,l),t.bezierCurveTo(a+h,l+g,a+d,l+c,a,l+c),t.bezierCurveTo(a-d,l+c,a-h,l+g,a-h,l),t.closePath()),Oo.fillCanvas(t,s,e.x-n,e.y-r),Oo._stroke(t,o,e.x-n,e.y-r)},rectangle:function(t,e,n,r,i){var{x:o,y:s}=e;t.beginPath(),t.rect(o,s,n.width,n.height),Oo.fillCanvas(t,i,o,s),Oo._stroke(t,r,o,s)},sector:function(t,e,n,r,i,o){var s,a,l,h,u,c,f=yo,d=r[0],p=r[1];s=t,a=e.x,l=e.y,h=n,u=f*-p,c=f*-d,s.beginPath(),s.moveTo(a,l),s.arc(a,l,h,u,c),s.lineTo(a,l),Oo.fillCanvas(s,o,a-h,l-h),Oo._stroke(s,i,a-h,l-h)},_isPattern:function(t){return!q(t)&&!("addColorStop"in t)},drawCross:function(t,e,n,r,i){t.canvas._drawn=!0,t.strokeStyle=i,t.lineWidth=r,t.beginPath(),t.moveTo(e-5,n),t.lineTo(e+5,n),t.moveTo(e,n-5),t.lineTo(e,n+5),t.stroke()},copy:function(t,e){var n=e||Qe("canvas");return n.width=t.width,n.height=t.height,n.getContext("2d").drawImage(t,0,0),n},pixelRect:function(t,e,n,r){var i=t.lineWidth,o=t.globalAlpha,s=!1;if(i>0&&n>0)s=!0,n<1&&(t.globalAlpha*=n);else{if(!(r>0))return;r<1&&(t.globalAlpha*=r)}t.canvas._drawn=!0,s?t.strokeRect(e[0],e[1],1,1):t.fillRect(e[0],e[1],1,1),t.globalAlpha!==o&&(t.globalAlpha=o)}};function Ro(t,e,n,r){var i=e.x,o=e.y,s=n.x,a=n.y,l=r,h=function(t,e){return t<=e},u=function(t,e){return t>=e},c=function(t,e){return Math.min(t,e)},f=function(t,e){return Math.max(t,e)},d={thereYet:u,cap:c},p={thereYet:u,cap:c};o-a>0&&(p.thereYet=h,p.cap=f),i-s>0&&(d.thereYet=h,d.cap=f),t.moveTo(i,o);for(var g,m,A=i,y=o,v=0,x=!0;!d.thereYet(A,s)||!p.thereYet(y,a);)g=Math.atan2(a-o,s-i),m=l[v],A=d.cap(s,A+Math.cos(g)*m),y=p.cap(a,y+Math.sin(g)*m),x?t.lineTo(A,y):t.moveTo(A,y),v=(v+1)%l.length,x=!x}var ko="data:image/";function Lo(t){return t.substring(0,ko.length)===ko?t:le(t)}function Do(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle,t.lineColorIn=e.lineColorIn}function No(t,e){e&&t.setLineDash&&Array.isArray(e)&&t.setLineDash(e)}function Fo(t){return"Z__"+t}function zo(t){return function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.on=function(t,e,n){if(!t)return this;if(!q(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var r,i=t.toLowerCase().split(" ");n||(n=this);var o,s=V(e._id);e._id=Xt();for(var a=0,l=i.length;a<l;a++){var h=Fo(r=i[a]);if(e[h]&&(e[h]._id=e._id),(o=this._eventMap[r])||(o=[],this._eventMap[r]=o),s){var u=o.length;if(u>0)for(var c=0;c<u;c++)if(e===o[c].handler&&o[c].context===n)return console.warn(this,"find '"+t+"' handler:",e," The old listener function will be removed"),this;o.push({handler:e,context:n})}else o.push({handler:e,context:n})}return this},n.addEventListener=function(...t){return this.on.call(this,...t)},n.once=function(t,e,n){if(!q(t)){var r={};for(var i in t)t.hasOwnProperty(i)&&(r[i]=this._wrapOnceHandler(i,t[i],e));return this._switch("on",r)}for(var o=t.split(" "),s=0,a=o.length;s<a;s++)this.on(o[s],this._wrapOnceHandler(o[s],e,n));return this},n.off=function(t,e,n){if(!this._eventMap||!t)return this;if(!q(t))return this._switch("off",t,e);if(!e)return this;if(!V(e._id))return this;var r,i,o,s=t.split(" ");n||(n=this);for(var a=0,l=s.length;a<l;a++)if(o=Fo(r=s[a].toLowerCase()),i=this._eventMap[r]){for(var h=i.length-1;h>=0;h--){var u=i[h];e!==u.handler&&e!==u.handler[o]||u.context!==n||(delete u.handler[o],i.splice(h,1))}i.length||delete this._eventMap[r]}return this},n.removeEventListener=function(...t){return this.off.call(this,...t)},n.listens=function(t,e,n){if(!this._eventMap||!q(t))return 0;var r=this._eventMap[t.toLowerCase()];if(!r||!r.length)return 0;if(!e)return r.length;for(var i=0,o=r.length;i<o;i++)if(e===r[i].handler&&(U(n)||r[i].context===n))return 1;return 0},n.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},n.copyEventListeners=function(t){var e,n=t._eventMap;if(!n)return this;for(var r in n)for(var i=0,o=(e=n[r]).length;i<o;i++)this.on(r,e[i].handler,e[i].context);return this},n.fire=function(t,e){return this._eventParent?this._eventParent.fire.call(this._eventParent,t,e):this._fire.call(this,t,e)},n._wrapOnceHandler=function(t,e,n){var r=Fo(t),i=!1,o=function t(...s){i||(delete o[r],i=!0,n?e.call(n,...s):e.call(this,...s),t._called=!0)};return o[r]=e,o},n._switch=function(t,e,n){for(var r in e)e.hasOwnProperty(r)&&this[t](r,e[r],n);return this},n._clearListeners=function(t){this._eventMap&&q(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},n._clearAllListeners=function(){this._eventMap=null},n._setEventParent=function(t){return this._eventParent=t,this},n._setEventTarget=function(t){return this._eventTarget=t,this},n._fire=function(t,e){if(!this._eventMap)return this;t=t.toLowerCase();var n=this._eventMap[t];if(!n)return this;e||(e={type:t,target:this._eventTarget||this}),e.type=t,e.target=this._eventTarget||this;for(var r,i,o=n.slice(0),s=0,a=o.length;s<a;s++){if(o[s])o[s].handler._called||(r=o[s].context,i=j({},e),!1===(r?o[s].handler.call(r,i):o[s].handler(i))&&e.domEvent&&on(e.domEvent))}var l=this._eventMap[t];if(l){for(var h=[],u=0,c=l.length;u<c;u++){l[u].handler._called||h.push(l[u])}this._eventMap[t]=h}return this},e}(t)}var Bo=function(t){function e(e){var n;return(n=t.call(this)||this)._enabled=!1,n.target=e,n}kt(e,t);var n=e.prototype;return n.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},n.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},n.enabled=function(){return!!this._enabled},n.remove=function(){this.disable(),delete this.target,delete this.dom},e}(zo((function(){}))),Ho=function(){function t(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks(),this._isUpdatingOptions=!1}var e=t.prototype;return e.proxyOptions=function(){var t=this;return Pt.proxy?(this.options=new Proxy(this.options,{set:function(e,n,r){if(e[n]===r)return!0;if(e[n]=r,t._isUpdatingOptions)return!0;var i={};return i[n]=r,t.config(i),!0}}),this):this},e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e.setOptions=function(t){if(this.hasOwnProperty("options")&&!U(this.options)||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.config=function(t,e){if(this._isUpdatingOptions=!0,!t){var n={};for(var r in this.options)this.options.hasOwnProperty(r)&&(n[r]=this.options[r]);return this._isUpdatingOptions=!1,n}if(2===arguments.length&&"string"==typeof t){var i={};i[t]=e,t=i}for(var o in t)this.options[o]=t[o],this[o]&&this[o]instanceof Bo&&(t[o]?this[o].enable():this[o].disable());return this.onConfig(t),this._isUpdatingOptions=!1,this},e.onConfig=function(t){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var n=t._initHooks;if(n&&n!==e._initHooks)for(var r=0;r<n.length;r++)n[r].call(this)}},t.addInitHook=function(t,...e){var n="function"==typeof t?t:function(){this[t].call(this,...e)},r=this.prototype,i=Object.getPrototypeOf(r);return r._initHooks&&r._initHooks!==i._initHooks||(r._initHooks=[]),r._initHooks.push(n),this},t.include=function(...t){for(var e=0;e<t.length;e++)j(this.prototype,t[e]);return this},t.mergeOptions=function(t){var e=this.prototype,n=Object.getPrototypeOf(e);return e.options&&e.options!==n.options||(e.options=e.options?Object.create(e.options):{}),j(e.options,t),this},t}(),jo=new(function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e}(zo((function(){})))),Uo="dprchange",Vo="docvisibilitychange",Go="dragstart",Wo="dragend";if("undefined"!=typeof window&&window.matchMedia)for(var qo=1;qo<500;qo++){var Xo=(.01*qo).toFixed(2),Zo=window.matchMedia("screen and (resolution: "+Xo+"dppx)");Zo&&(Zo.addEventListener?Zo.addEventListener("change",Pt.checkDevicePixelRatio):Zo.addListener&&Zo.addListener(Pt.checkDevicePixelRatio))}if(Pt.devicePixelRatio){var Yo=Pt.devicePixelRatio;Object.defineProperty(Pt,"devicePixelRatio",{get:function(){return Yo},set:function(t){t!==Yo&&(Yo=t,Pt.monitorDPRChange&&jo.fire(Uo,{devicePixelRatio:t}))}})}Pt.webgl&&"undefined"!=typeof document&&(tn(document,"visibilitychange",(function(){jo.fire(Vo,{visibilityState:document.visibilityState})})),tn(document,"dragstart",(function(){jo.fire(Go)})),tn(document,"dragend",(function(){jo.fire(Wo)})));var Jo={};function Qo(t){return function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e.registerJSONType=function(t){t&&(Jo[t]?console.error(t+" has register. please use Different name for:",this):Jo[t]=this)},e.getJSONClass=function(t){return t?Jo[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in Jo)if(Jo[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered Layer/Geometry class!");return this._jsonType},e}(t)}function Ko(t){return function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var n=this[t]=new e(this);return this._handlers.push(n),this.options[t]&&n.enable(),this},n.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var n=this._handlers.indexOf(e);n>=0&&this._handlers.splice(n,1),this[t].remove(),delete this[t]}return this},n._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var $o="touchstart mousedown",ts={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},es={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},ns=function(t){function e(e,n={}){var r;return(r=t.call(this,null)||this).dom=e,r.options=n,r}kt(e,t);var n=e.prototype;return n.addHooks=function(){},n.removeHooks=function(){},n.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},gn(this.dom,$o,this._onMouseDown,this),this):this},n.disable=function(){return this.dom?(this._offEvents(),mn(this.dom,$o,this._onMouseDown),delete this._onMouseDown,this):this},n.onMouseDown=function(t){if(this.options.rightclick||2!==t.button){var e=t;if(!(e.touches&&e.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var n=this.dom;n.setCapture?n.setCapture():window.captureEvents&&window.captureEvents(),n.ondragstart=function(){return!1},delete this.moved;var r=e.touches?e.touches[0]:t;this.startPos=new Vt(r.clientX,r.clientY),mn(document,ts[t.type],this.onMouseMove),mn(document,es[t.type],this.onMouseUp),gn(document,ts[t.type],this.onMouseMove,this),gn(document,es[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||(mn(this.dom,"mouseleave",this.onMouseUp),gn(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:t,mousePos:new Vt(r.clientX,r.clientY)})}}},n.onMouseMove=function(t){var e=t;if(e.touches&&e.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var n=e.touches?e.touches[0]:t,r=new Vt(n.clientX,n.clientY).sub(this.startPos);(r.x||r.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new Vt(n.clientX,n.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},n.onMouseUp=function(t){var e=t,n=e.changedTouches?e.changedTouches[0]:t;this._offEvents();var r={domEvent:t};V(n.clientX)&&(r.mousePos=new Vt(parseInt(n.clientX+"",0),parseInt(n.clientY+"",0))),this.moved&&(r.interupted=this.interupted,this.fire("dragend",r),delete this.interupted,delete this.moved),this.fire("mouseup",r)},n._offEvents=function(){var t=this.dom;if(mn(t,"mouseleave",this.onMouseUp),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in ts)mn(document,ts[e],this.onMouseMove),mn(document,es[e],this.onMouseUp);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents()}},e}(Bo),rs=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?Kt(t,(function(t){return t.toArray()})):t.toArray()},e.toCoordinates=function(t){if(V(t[0])&&V(t[1]))return new e(t);if(t instanceof e)return t;for(var n=[],r=0,i=t.length;r<i;r++){var o=t[r];Array.isArray(o)?V(o[0])?n.push(new e(o)):n.push(e.toCoordinates(o)):o instanceof e?n.push(o):n.push(new e(o))}return n};var n=e.prototype;return n.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},n.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new e(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new e(this.x,this.y,this.z)},n.toFixed=function(t){return new e(this.x.toFixed(t),this.y.toFixed(t),V(this.z)?this.z.toFixed(t):void 0)},n.add=function(t,n,r){var i,o,s=this.z;return U(t.x)?U(t[0])?(i=this.x+t,o=this.y+n,U(r)||(s=(this.z||0)+r)):(i=this.x+t[0],o=this.y+t[1],U(t[2])||(s=(this.z||0)+t[2])):(i=this.x+t.x,o=this.y+t.y,U(t.z)||(s=(this.z||0)+t.z)),new e(i,o,s)},n.sub=function(t,n,r){var i,o,s=this.z;return U(t.x)?U(t[0])?(i=this.x-t,o=this.y-n,U(r)||(s=(this.z||0)-r)):(i=this.x-t[0],o=this.y-t[1],U(t[2])||(s=(this.z||0)-t[2])):(i=this.x-t.x,o=this.y-t.y,U(t.z)||(s=(this.z||0)-t.z)),new e(i,o,s)},n.multi=function(t){return new e(this.x*t,this.y*t,U(this.z)?this.z:this.z*t)},n.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y&&this.z===t.z)},e}(Ut),is=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();is.WGS84=is.createProj4("+proj=longlat +datum=WGS84 +no_defs"),is.EPSG3857=is.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),is.IDENTITY=is.createProj4("+proj=identity +no_defs"),is.CGCS2000=is.createProj4("+proj=longlat +datum=CGCS2000"),is.EPSG4490=is.CGCS2000,is.BD09LL=is.createProj4("+proj=longlat +datum=BD09"),is.GCJ02=is.createProj4("+proj=longlat +datum=GCJ02");var os,ss=new Vt(0,0),as=new rs(0,0),ls=new rs(0,0),hs=new rs(0,0),us=new rs(0,0),cs=new rs(0,0),fs=new rs(0,0),ds=new rs(0,0),ps=new rs(0,0),gs=[],ms=[],As=function(){function t(...t){this._clazz=rs;var e=t.length,n=e>0?t[e-1]:null;n&&n.unproject&&(this.projection=t[e-1]),this._dirty=!0,this.antiMeridian=!1,this._initialize(t[0],t[1],t[2],t[3])}var e=t.prototype;return e._initialize=function(t,e,n,r){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!U(t)){var i=this.projection;if(V(t)&&V(e)&&V(n)&&V(r))i?this.set(t,e,n,r):this.set(Math.min(t,n),Math.min(e,r),Math.max(t,n),Math.max(e,r));else if(Array.isArray(t))i?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3]));else if(V(t.x)&&V(e.x)&&V(t.y)&&V(e.y)){var o=t,s=e;i?this.set(o.x,o.y,s.x,s.y):(o.x>s.x?(this.xmin=s.x,this.xmax=o.x):(this.xmin=o.x,this.xmax=s.x),o.y>s.y?(this.ymin=s.y,this.ymax=o.y):(this.ymin=o.y,this.ymax=s.y))}else V(t.xmin)&&V(t.xmax)&&V(t.ymin)&&V(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,U(t.x)?U(t.xmin)?U(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(t){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._add(t)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,U(t.x)?U(t.xmin)?U(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(t){return this._sub(t)},e.sub=function(t){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._sub(t)},e.substract=function(t){return this.sub(t)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2;return t?(t.set(e,n),t):new this._clazz(e,n)},e.isValid=function(){return!(U(this.xmin)||U(this.ymin)||U(this.xmax)||U(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),n=Math.max(this.pymin,t.pymin),r=Math.min(this.pxmax,t.pxmax),i=Math.min(this.pymax,t.pymax);return!(e>r||n>i)},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e){var n=as;Array.isArray(t)?(n.x=t[0],n.y=t[1],t=e.project(n,n)):void 0!==t.x?(n.x=t.x,n.y=t.y,t=e.project(n,n)):void 0!==t.xmin&&this._project(t)}return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new Ie(this.getWidth(),this.getHeight())},e.set=function(t,e,n,r){return this.xmin=t,this.ymin=e,this.xmax=n,this.ymax=r,this._dirty=!0,this},e.__combine=function(t){var e,n,r,i;void 0!==t.x&&(os.xmin=os.xmax=t.x,os.ymin=os.ymax=t.y,t=os),this._project(t),this._project(this),V(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),n=Math.min(this.pymin,t.pymin),r=Math.max(this.pxmax,t.pxmax),i=Math.max(this.pymax,t.pymax)):(e=t.pxmin,n=t.pymin,r=t.pxmax,i=t.pymax);var o=this.projection;if(o){ls.set(e,n),hs.set(r,i);var s=o.unproject(ls,ls),a=o.unproject(hs,hs);e=s.x,n=s.y,r=a.x,i=a.y}return ms[0]=e,ms[1]=n,ms[2]=r,ms[3]=i,ms},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;us.x=Math.max(this.pxmin,t.pxmin),us.y=Math.max(this.pymin,t.pymin),cs.x=Math.min(this.pxmax,t.pxmax),cs.y=Math.min(this.pymax,t.pymax);var e=us,n=cs,r=this.projection;return r&&(e=r.unproject(e,e),n=r.unproject(n,n)),new this.constructor(e,n,r)},e.expand=function(t){var e,n;return V(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-n,this.xmax+e,this.ymax+n,this.projection)},e._expand=function(t){var e,n;return V(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=n,this.xmax+=e,this.ymax+=n,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(t){var e=this.xmin,n=this.ymin,r=this.xmax,i=this.ymax;return t?(t[0].x=e,t[0].y=i,t[1].x=r,t[1].y=i,t[2].x=r,t[2].y=n,t[3].x=e,t[3].y=n,t[4].x=e,t[4].y=i,t):[new this._clazz([e,i]),new this._clazz([r,i]),new this._clazz([r,n]),new this._clazz([e,n]),new this._clazz([e,i])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var n,r=e||new this.constructor;return e&&r.set(null,null,null,null),this._clazz===rs?n=fs:this._clazz===Vt&&(n=ss),n.x=this.xmin,n.y=this.ymax,r._combine(t(n)),n.x=this.xmax,r._combine(t(n)),n.y=this.ymin,r._combine(t(n)),n.x=this.xmin,r._combine(t(n)),r},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){ds.set(t.xmin,t.ymin),ps.set(t.xmax,t.ymax),gs[0]=ds,gs[1]=ps;var n=e.projectCoords(gs,this.antiMeridian),r=n[0],i=n[1];t.pxmin=Math.min(r.x,i.x),t.pymin=Math.min(r.y,i.y),t.pxmax=Math.max(r.x,i.x),t.pymax=Math.max(r.y,i.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}else t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null)},t}();os=new As(0,0,0,0);var ys,vs=function(t){function e(...e){var n;return(n=t.call(this,...e)||this)._clazz=Vt,n}return kt(e,t),e}(As),xs=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,n){var r=this.matrix[0]*(t.x-this.matrix[2])/e,i=-this.matrix[1]*(t.y-this.matrix[3])/e;return n?(n.x=r,n.y=i,n):new Vt(r,i)},e.untransform=function(t,e,n){var r=t.x*e/this.matrix[0]+this.matrix[2],i=t.y*e/-this.matrix[1]+this.matrix[3];return n?(n.x=r,n.y=i,n):new rs(r,i)},t}(),_s={code:"",is:function(t){if(this.code===t)return!0;if(!this.aliases)return!1;for(var e=0;e<this.aliases.length;e++)if(this.aliases[e]===t)return!0;return!1},project:function(t){return t},unproject:function(t){return t},projectCoords:function(t,e){var n=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return Kt(t,this.project,this);if(Array.isArray(t[0]))return t.map((function(t){return n.projectCoords(t,e)}));for(var r,i,o,s,a,l=e,h=this.getCircum(),u=this.getSphereExtent().sy,c=t[0],f=[this.project(c)],d=1,p=t.length;d<p;d++){o=(i=t[d]).x-c.x,s=i.y-c.y,a=this.project(i);var g=!1;Math.abs(o)>180&&l&&(i.x=o<0?360-Math.abs(i.x):-180-(180-Math.abs(i.x)),g=!0),Math.abs(s)>90&&l&&(void 0===r&&(r=i.y<c.y),r&&(a._add(0,-h.y*te(s)*u),i._add(0,-180*te(s)))),g&&(a=this.project(i)),c=i,f.push(a)}return f},unprojectCoords:function(t){return t?Array.isArray(t)?Kt(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),n=new rs(t);return e.contains(n)||(n.x=ne(t.x,e.xmin,e.xmax),n.y=ne(t.y,e.ymin,e.ymax)),n},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new rs(180,90)),e=this.project(new rs(-180,-90));this.extent=new As(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},bs={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var n=0,r=0,i=t.length;r<i-1;r++)n+=this.measureLenBetween(t[r],t[r+1]);return n}},ws={measure:"IDENTITY",measureLenBetween:function(t,e,n=!1){if(!t||!e)return 0;try{var r=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));if(n)return r;var i=(t.z||0)-(e.z||0);return 0===i?r:Math.sqrt(r*r+i*i)}catch(S6){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,n=0,r=t.length;n<r;n++){var i=t[n],o=null;o=n===r-1?t[0]:t[n+1],e+=i.x*o.y-i.y*o.x}return Math.abs(e/2)},locate:function(t,e,n,r){return(r=r||new rs(0,0)).set(t.x,t.y),this._locate(r,e,n)},_locate:function(t,e,n){return t?(e||(e=0),n||(n=0),e||n?(t.x=t.x+e,t.y=t.y+n,t):t):null},rotate:function(t,e,n){return t=new rs(t.x,t.y),this._rotate(t,e,n)},_rotate:(ys=new Vt(0,0),function(t,e,n){return ys.x=t.x-e.x,ys.y=t.y-e.y,ys._rotate(n*Math.PI/180),t.x=e.x+ys.x,t.y=e.y+ys.y,t})},Ts=j(ws,bs),Ms=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e,n=!1){if(!t||!e)return 0;var r=Q(t.y),i=Q(e.y),o=r-i,s=Q(t.x)-Q(e.x);r=2*Math.asin(Math.sqrt(Math.pow(Math.sin(o/2),2)+Math.cos(r)*Math.cos(i)*Math.pow(Math.sin(s/2),2)));var a=r*=this.radius;if(n)return a;var l=(t.z||0)-(e.z||0);return 0===l?a:Math.sqrt(a*a+l*l)},e.measureArea=function(t){var e,n=Q(this.radius),r=0,i=t,o=i.length;if(o<3)return 0;for(e=0;e<o-1;e++){var s=i[e],a=i[e+1];r+=s.x*n*Math.cos(Q(s.y))*a.y*n-a.x*n*Math.cos(Q(a.y))*s.y*n}var l=i[e],h=i[0];return r+=l.x*n*Math.cos(Q(l.y))*h.y*n-h.x*n*Math.cos(Q(h.y))*l.y*n,.5*Math.abs(r)},e.locate=function(t,e,n,r){return(r=r||new rs(0,0)).set(t.x,t.y),this._locate(r,e,n)},e._locate=function(t,e,n){if(!t)return null;if(e||(e=0),n||(n=0),!e&&!n)return t;var r,i,o=Q(t.y);if(0!==n){var s=Math.abs(n);i=ne(180*(o+=2*Math.sin(s/(2*this.radius))*(n>0?1:-1))/Math.PI,-90,90)}else i=t.y;if(0!==e){var a=Math.abs(e),l=Q(t.x);r=ne(180*(l+=2*Math.sqrt(Math.pow(Math.sin(a/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(e>0?1:-1))/Math.PI,-180,180)}else r=t.x;return t.x=r,t.y=i,t},e.rotate=function(t,e,n){var r=new rs(t);return this._rotate(r,e,n)},e._rotate=function(t,e,n){var r=function(t,e,n={}){var r;r=n.final?Cs(e,t):Cs(t,e);return r>180?-(360-r):r}(e,t)-n,i=this.measureLenBetween(e,t,!0);return t.x=e.x,t.y=e.y,function(t,e,n,r){var i=e/r,o=t.x*Math.PI/180,s=Q(t.y),a=Q(n),l=i*Math.cos(a),h=s+l;Math.abs(h)>Math.PI/2&&(h=h>0?Math.PI-h:-Math.PI-h);var u=Math.log(Math.tan(h/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),c=Math.abs(u)>1e-11?l/u:Math.cos(s),f=i*Math.sin(a)/c,d=o+f;return t.x=(180*d/Math.PI+540)%360-180,t.y=180*h/Math.PI,t}(t,i,r,this.radius)},t}();function Cs(t,e){var n=Q(t.y),r=Q(e.y),i=Q(e.x-t.x);i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI);var o=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return(K(Math.atan2(i,o))+360)%360}var Ss={measure:"EPSG:4326",sphere:new Ms(6378137),measureLenBetween:function(t,e){return this.sphere.measureLenBetween(t,e)},measureArea:function(t){return this.sphere.measureArea.call(this.sphere,t)},_locate:function(t,e,n){return this.sphere._locate.call(this.sphere,t,e,n)},locate:function(t,e,n,r){return this.sphere.locate.call(this.sphere,t,e,n,r)},_rotate:function(t,e,n){return this.sphere._rotate.call(this.sphere,t,e,n)},rotate:function(t,e,n){return this.sphere.rotate.call(this.sphere,t,e,n)}},Is=j(Ss,bs),Ps={measure:"BAIDU",sphere:new Ms(6370996.81),measureLenBetween:function(t,e){return this.sphere.measureLenBetween.call(this.sphere,t,e)},measureArea:function(t){return this.sphere.measureArea.call(this.sphere,t)},_locate:function(t,e,n){return this.sphere._locate.call(this.sphere,t,e,n)},locate:function(t,e,n,r){return this.sphere.locate.call(this.sphere,t,e,n,r)},_rotate:function(t,e,n){return this.sphere._rotate.call(this.sphere,t,e,n)},rotate:function(t,e,n){return this.sphere.rotate.call(this.sphere,t,e,n)}},Es=j(Ps,bs),Os=Is,Rs={};function ks(t){Rs[t.measure]=t}ks(Ts),ks(Is),ks(Es);var Ls=function(t){if(!t)return Os;for(var e in Rs)if(Y(Rs,e)){var n=Rs[e].measure;if(!n)continue;if(t.toLowerCase()===n.toLowerCase())return Rs[e]}return null},Ds={code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var n=this.rad,r=this.metersPerDegree,i=this.maxLatitude,o=t.x,s=Math.max(Math.min(i,t.y),-i),a=o*r,l=(0===s?0:Math.log(Math.tan((90+s)*n/2))/n)*r;return e?(e.x=a,e.y=l,e):new rs(a,l)},unproject:function(t,e){var n,r=this.rad,i=this.metersPerDegree,o=t.x/i,s=t.y;0===s?n=0:(n=s/i,n=(2*Math.atan(Math.exp(n*r))-Math.PI/2)/r),Math.abs(Math.abs(o)-180)<1e-7&&(o=180*te(o)),Math.abs(Math.abs(n)-this.maxLatitude)<1e-7&&(n=te(n)*this.maxLatitude);var a=o,l=n;return e?(e.x=a,e.y=l,e):new rs(a,l)}},Ns=j({},_s,Ds,Is),Fs=j({},_s,{code:"EPSG:4326",aliases:["EPSG:4490"],project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new rs(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new rs(t)}},Is),zs=Math.abs,Bs=Math.sin,Hs=Math.cos,js=Math.tan,Us=Math.atan,Vs=Math.atan2,Gs=Math.sqrt,Ws=Math.log,qs=Math.hypot,Xs=Math.sinh,Zs=Math.cosh,Ys=1/0;function Js(t){var e,n,r,i,o,s,a=[],l=[],h=[],u=[];function c(t,e){for(var n,r=2*Hs(2*e),i=t.length-1,o=t[i],s=0;--i>=0;)n=r*o-s+t[i],s=o,o=n;return e+n*Bs(2*e)}function f(t,e,n){for(var r,i,o=Bs(e),s=Hs(e),a=Xs(n),l=Zs(n),h=2*s*l,u=-2*o*a,c=t.length-1,f=t[c],d=0,p=0,g=0;--c>=0;)r=p,i=d,f=h*(p=f)-r-u*(d=g)+t[c],g=u*p-i+h*d;return[(h=o*l)*f-(u=s*a)*g,h*g+u*f]}t.es,o=i=(r=t.es/(1+Gs(1-t.es)))/(2-r),a[0]=i*(2+i*(-2/3+i*(i*(116/45+i*(26/45+i*(-2854/675)))-2))),l[0]=i*(i*(2/3+i*(4/3+i*(-82/45+i*(32/45+i*(4642/4725)))))-2),o*=i,a[1]=o*(7/3+i*(i*(-227/45+i*(2704/315+i*(2323/945)))-1.6)),l[1]=o*(5/3+i*(-16/15+i*(-13/9+i*(904/315+i*(-1522/945))))),o*=i,a[2]=o*(56/15+i*(-136/35+i*(-1262/105+i*(73814/2835)))),l[2]=o*(-26/15+i*(34/21+i*(1.6+i*(-12686/2835)))),o*=i,a[3]=o*(4279/630+i*(-332/35+i*(-399572/14175))),l[3]=o*(1237/630+i*(i*(-24832/14175)-2.4)),o*=i,a[4]=o*(4174/315+i*(-144838/6237)),l[4]=o*(-734/315+i*(109598/31185)),o*=i,a[5]=o*(601676/22275),l[5]=o*(444337/155925),o=i*i,e=t.k0/(1+i)*(1+o*(1/4+o*(1/64+o/256))),h[0]=i*(i*(2/3+i*(-37/96+i*(1/360+i*(81/512+i*(-96199/604800)))))-.5),u[0]=i*(.5+i*(-2/3+i*(5/16+i*(41/180+i*(-127/288+i*(7891/37800)))))),h[1]=o*(-1/48+i*(-1/15+i*(437/1440+i*(-46/105+i*(1118711/3870720))))),u[1]=o*(13/48+i*(i*(557/1440+i*(281/630+i*(-1983433/1935360)))-.6)),o*=i,h[2]=o*(-17/480+i*(37/840+i*(209/4480+i*(-5569/90720)))),u[2]=o*(61/240+i*(-103/140+i*(15061/26880+i*(167603/181440)))),o*=i,h[3]=o*(-4397/161280+i*(11/504+i*(830251/7257600))),u[3]=o*(49561/161280+i*(-179/168+i*(6601661/7257600))),o*=i,h[4]=o*(-4583/161280+i*(108847/3991680)),u[4]=o*(34729/80640+i*(-3418889/1995840)),o*=i,h[5]=o*(-20648693/638668800),u[5]=.6650675310896665*o,s=c(l,t.phi0),n=-e*(s+function(t,e){var n,r=2*Hs(e),i=t.length-1,o=t[i],s=0;for(;--i>=0;)n=r*o-s+t[i],s=o,o=n;return Bs(e)*n}(u,2*s)),t.fwd=function(t,r){var i,o,s,a,h,d=t.phi,p=t.lam;d=c(l,d),i=Bs(d),o=Hs(d),a=Bs(p),s=Hs(p),d=Vs(i,s*o),p=Vs(a*o,qs(i,o*s)),p=function(t){var e=zs(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*Ws(e)/n}(e*(1+e/(qs(1,e)+1))),t<0?-e:e}(js(p)),h=f(u,2*d,2*p),d+=h[0],p+=h[1],zs(p)<=2.623395162778?(r.y=e*d+n,r.x=e*p):r.x=r.y=Ys},t.inv=function(t,r){var i,o,s,l,u,d=t.y,p=t.x;d=(d-n)/e,zs(p/=e)<=2.623395162778?(d+=(u=f(h,2*d,2*p))[0],p+=u[1],p=Us(Xs(p)),i=Bs(d),o=Hs(d),l=Bs(p),s=Hs(p),p=Vs(l,s*o),d=Vs(i*s,qs(l,s*o)),r.phi=c(a,d),r.lam=p):r.phi=r.lam=Ys}}var Qs=57.29577951308232,Ks=.017453292519943295,$s=["Traverse_Mercator"],ta={code:"EPSG:9807",aliases:$s,centralMeridian:0,create:function(t){var e={a:6378137,es:.0066943799901413165,x0:U(t.falseEasting)?5e5:t.falseEasting,y0:U(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*Ks,phi0:(t.latitudeOfOrigin||0)*Ks,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};Js(e);var n={lam:0,phi:0},r={},i=0,o=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*Ks-e.lam0,n.phi=e.originPhi0*Ks,e.fwd(n,r),i=e.a*r.x+e.x0,o=e.a*r.y+e.y0);var s={code:"EPSG:9807",aliases:$s,centralMeridian:t.centralMeridian,project:function(t,s){n.lam=t.x*Ks-e.lam0,n.phi=t.y*Ks,e.fwd(n,r);var a=e.a*r.x+e.x0-i,l=e.a*r.y+e.y0-o;return s?(s.x=a,s.y=l,s):new rs(a,l)},unproject:function(t,s){r.x=(t.x-e.x0+i)/e.a,r.y=(t.y-e.y0+o)/e.a,e.inv(r,n);var a=(n.lam+e.lam0)*Qs,l=n.phi*Qs;return s?(s.x=a,s.y=l,s):new rs(a,l)}};return j({},_s,s,Is)}},ea=j({},_s,ta),na={code:"utm",aliases:[],create:function(t){var e={},n=parseInt(t.zone);if(e.falseNorthing=t.south?1e7:0,e.falseEasting=5e5,!(n>0&&n<=60))throw new Error("zone must be > 0 and <= 60.");return n--,e.centralMeridian=6*(n+.5)-180,e.scaleFactor=.9996,ea.create(e)}},ra=j({},ea,na),ia=j({},_s,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},Es,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var n,r=0,i=this.MCBAND.length;r<i;r++)if(Math.abs(t.y)>=this.MCBAND[r]){n=this.MC2LL[r];break}return this.convertor(t,n,e)},convertLL2MC:function(t,e){var n,r,i;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var o=new rs(t.x,t.y);for(r=0,i=this.LLBAND.length;r<i;r++)if(o.y>=this.LLBAND[r]){n=this.LL2MC[r];break}if(!n)for(r=this.LLBAND.length-1;r>=0;r--)if(o.y<=-this.LLBAND[r]){n=this.LL2MC[r];break}return this.convertor(t,n,e)},convertor:function(t,e,n){if(!t||!e)return null;var r=e[0]+e[1]*Math.abs(t.x),i=Math.abs(t.y)/e[9],o=e[2]+e[3]*i+e[4]*i*i+e[5]*i*i*i+e[6]*i*i*i*i+e[7]*i*i*i*i*i+e[8]*i*i*i*i*i*i;return r*=t.x<0?-1:1,o*=t.y<0?-1:1,n?(n.x=r,n.y=o,n):new rs(r,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,n){return null!=e&&(t=Math.max(t,e)),null!=n&&(t=Math.min(t,n)),t},getLoop:function(t,e,n){if(t===1/0)return n;if(t===-1/0)return e;for(;t>n;)t-=n-e;for(;t<e;)t+=n-e;return t}}),oa=j({},_s,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()}},Ts),sa=Ns,aa=Object.freeze({__proto__:null,BAIDU:ia,Common:_s,DEFAULT:sa,EPSG3857:Ns,EPSG4326:Fs,EPSG9807:ea,IDENTITY:oa,UTM:ra});function la(t){return function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e.registerRenderer=function(t,e){var n=this.prototype,r=Object.getPrototypeOf(n);return n._rendererClasses&&n._rendererClasses!==r._rendererClasses||(n._rendererClasses=n._rendererClasses?Object.create(n._rendererClasses):{}),n._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)}var ha="check_browser_max_fps";_i(ha,(function(){return"function (exports) {\n    exports.initialize = function () {};\n    function now(){\n        return  new Date().getTime();\n    }\n    function checkFPS(cb) {\n        if (!requestAnimationFrame) {\n            cb(-1);\n            return;\n        }\n        const count = 100;\n        let idx = 0;\n        let id;\n        let startTime;\n        function loop() {\n            idx++;\n            if (idx === count) {\n                cancelAnimationFrame(id);\n                const endTime = now();\n                const timePerFPS = (endTime - startTime) / count;\n                const fps = Math.floor(1000 / timePerFPS);\n                cb(fps);\n            } else {\n                id = requestAnimationFrame(loop);\n            }\n        }\n        startTime = now();\n        id = requestAnimationFrame(loop);\n    }\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        checkFPS((fps) => {\n            if (fps < -1) {\n                postResponse('check fps fail');\n            } else {\n                postResponse(null, { fps });\n            }\n        })\n    }\n}"}));var ua,ca=0,fa=[],da=function(){function t(t){var e=this;Hi(),this._delayMessages=[],this.initializing=!1;var n=yi(t);mi&&!n&&(this.initializing=!0,Ci(t,(function(){e.initializing=!1,e.created()}))),this.workerKey=t,this.workerPool=Ri(),this.currentActor=0,this.actorId=Xt(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(t){t.addEventListener("message",e.receiveFn,!1)})),vi(t)}var e=t.prototype;return e.created=function(){var t=this;this._delayMessages.forEach((function(e){var{command:n,data:r,buffers:i,cb:o,workerId:s}=e;t[n](r,i,o,s)})),this._delayMessages=[]},e.isActive=function(){return!!this.workers},e.broadcast=function(t,e,n){var r=this;return this.initializing?(this._delayMessages.push({command:"broadcast",data:t,buffers:e,cb:n}),this):(n=n||function(){},function(t,e,n){t.length||n(null,[]);var r=t.length,i=new Array(t.length),o=null;t.forEach((function(t,s){e(t,(function(t,e){t&&(o=t),i[s]=e,0==--r&&n(o,i)}))}))}(this.workers,(function(n,i){r.send(t,e,i,n.id)}),n),this)},e.send=function(t,e,n,r){if(this.initializing)return this._delayMessages.push({command:"send",data:t,buffers:e,cb:n,workerId:r}),this;var i=n?this.actorId+":"+this.callbackID++:null;return n&&(this.callbacks[i]=n),this.post({data:t,callback:String(i)},e,r),this},e.receive=function(t){var e=this,n=t.data,r=n.callback,i=this.callbacks[r];delete this.callbacks[r],"<request>"===n.type?this.actorId===n.actorId&&this[n.command](n.params,(function(t,r,i){var o={type:"<response>",callback:n.callback};t?o.error=t.message:o.data=r,e.post(o,i||fa,n.workerId)})):i&&n.error?i(n.error):i&&i(null,n.data)},e.remove=function(){var t=this;this.workers.forEach((function(e){e.removeEventListener("message",t.receiveFn,!1)})),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},e.post=function(t,e,n){return("number"!=typeof n||isNaN(n))&&(n=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=n,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workerPool.addMessage(n,t,e||fa),n},e.getDedicatedWorker=function(){return ca=(ca+1)%this.workerPool.workerCount},t}();var pa=function(t){function e(){return t.call(this,ha)||this}return kt(e,t),e}(da);var ga,ma=!1;ga=function(){var t;ma||B.maxFPS<=0&&(ma=!0,t=function(t){V(t)&&t>0&&B.maxFPS<=0&&(B.maxFPS=t),ma=!1},ua||(ua=new pa),ua.send({},[],(function(e,n){e?(console.error(e),t()):t(n.fps)})))},Li.indexOf(ga)>-1||X(ga)&&Li.push(ga);var Aa=[],ya=function(t){function e(){return t.call(this,gi)||this}return kt(e,t),e.prototype.fetchImage=function(t,e){var n={url:t};this.send(n,Aa,e)},e}(da),va=function(t){function e(e){var n;return(n=t.call(this)||this).layer=e,n._painted=!1,n._drawTime=0,!Pt.decodeImageInWorker||Pt.safari||Pt.iosWeixin||(n._resWorkerConn=new ya),n.setToRedraw(),n}kt(e,t);var n=e.prototype;return n.render=function(t){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=new xa),this.checkAndDraw(this._tryToDraw,t),this._frameTime=t)},n.getFrameTimestamp=function(){return this._frameTime||0},n.checkAndDraw=function(t,...e){var n=this;if(this._toRedraw=!1,this.checkResources){var r=this.checkResources();r.length>0?(this._loadingResource=!0,this.loadResources(r).then((function(){if(n._loadingResource=!1,n.layer){n.layer.fire("resourceload");var t=n.layer.getMap();n.setToRedraw(),t.getRenderer().callInNextFrame((function(){n.setToRedraw()}))}}))):t.call(this,...e)}else t.call(this,...e)},n.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},n.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged())&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},n.onSkipDrawOnInteracting=function(){},n.isLoadingResource=function(){return this._loadingResource},n.isRenderComplete=function(){return!!this._renderComplete},n.mustRenderOnInteracting=function(){return!this._painted},n.setToRedraw=function(){return this._toRedraw=!0,this},n.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},n.isCanvasUpdated=function(){return!!this._canvasUpdated},n.remove=function(){this.onRemove(),delete this._loadingResource,delete this.middleWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,this._resWorkerConn&&(this._resWorkerConn.remove(),delete this._resWorkerConn),delete this.layer},n.onRemove=function(){},n.onAdd=function(){},n.getMap=function(){return this.layer?this.layer.getMap():null},n.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.middleWest)._add(0,-t.height/2);return{image:this.canvas,layer:this.layer,point:e}},n.clear=function(){this.clearCanvas()},n.isBlank=function(){return!this._painted},n.show=function(){this.setToRedraw()},n.hide=function(){this.clear(),this.setToRedraw()},n.setZIndex=function(t){this.setToRedraw()},n.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var e=this.getMap(),n=e.getDevicePixelRatio(),r=e.getSize();if(t.x<0||t.x>r.width*n||t.y<0||t.y>r.height*n)return!1;var i=this.getImageData&&this.getImageData();if(i){var o=Math.round(n*t.x),s=Math.round(n*t.y)*i.width*4+4*o;return i.data[s+3]>0}try{if(this.context.getImageData(n*t.x,n*t.y,1,1).data[3]>0)return!0}catch(a){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",a),this._errorThrown=!0),!1}return!1},n.loadResources=function(t){this.resources||(this.resources=new xa);var e=this.resources,n=[];if(ie(t))for(var r={},i=t.length-1;i>=0;i--){var o=t[i];o&&o.length&&!r[o.join("-")]&&(r[o.join("-")]=1,e.isResourceLoaded(o,!0)||n.push(new Promise(this._promiseResource(o))))}return Promise.all(n)},n.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t.get2DExtent(),this.middleWest=t._containerPointToPoint(new Vt(0,t.height/2))},n.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),n=t.getDevicePixelRatio(),r=Math.round(n*e.width),i=Math.round(n*e.height);if(this.layer._canvas){var o=this.layer._canvas;o.width=r,o.height=i,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=Oo.createCanvas(r,i,t.CanvasClass);this.onCanvasCreate()}},n.onCanvasCreate=function(){},n._canvasContextScale=function(t,e){return t.scale(e,e),t.dpr=e,this},n.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=Oo.getCanvas2DContext(this.canvas),this.context)){this.context.dpr=1,this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this._canvasContextScale(this.context,t)}},n.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},n.resizeCanvas=function(t){var e=this.canvas;if(e){var n=t||this.getMap().getSize(),r=this.getMap().getDevicePixelRatio(),{width:i,height:o,cssWidth:s,cssHeight:a}=ve(n,r);!this.layer._canvas||e.style.width===s&&e.style.height===a||(e.style.width=s,e.style.height=a),e.width===i&&e.height===o||(e.height=o,e.width=i,this.context&&(this.context.dpr=1),1!==r&&this.context&&this._canvasContextScale(this.context,r))}},n.clearCanvas=function(){if(this.context&&this.getMap()){var t=1/this.getMap().getDevicePixelRatio(),e=this.canvas.width*t,n=this.canvas.height*t;Oo.clearRect(this.context,0,0,Math.max(e,this.canvas.width),Math.max(n,this.canvas.height))}},n.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getMaskPainter().get2DExtent();return e&&this._extent2D&&e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},n.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;if(!this.layer.options.maskClip)return!1;var n=this.middleWest,r=this.getMap();this.middleWest=r._containerPointToPoint(new Vt(0,r.height/2)),t.save();var i=r.getDevicePixelRatio();if(1!==i&&(t.save(),this._canvasContextScale(t,i)),e.getGeometries){t.isMultiClip=!0;var o=e.getGeometries()||[];t.beginPath(),o.forEach((function(e){e._getMaskPainter().paint(null,t)})),t.stroke(),t.isMultiClip=!1}else{t.isClip=!0,t.beginPath(),e._getMaskPainter().paint(null,t),t.isClip=!1}1!==i&&t.restore();try{t.clip("evenodd")}catch(s){console.error(s)}return this.middleWest=n,!0},n.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,middleWest:this.middleWest}},n.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},n.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},n.onZoomStart=function(t){},n.onZoomEnd=function(t){this.setToRedraw()},n.onZooming=function(t){},n.onMoveStart=function(t){},n.onMoving=function(t){},n.onMoveEnd=function(t){this.setToRedraw()},n.onResize=function(t){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},n.onDragRotateStart=function(t){},n.onDragRotating=function(t){},n.onDragRotateEnd=function(t){this.setToRedraw()},n.onSpatialReferenceChange=function(t){},n.getDrawTime=function(){return this._drawTime},n._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},n._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var n=H();this.draw(t),n=H()-n,this._drawTime=e?n:n/2,e&&this.layer&&this.layer.options.logDrawTime&&(this.layer.getId(),this._drawTime)}},n._promiseResource=function(t){var e=this,n=this.layer,r=this.resources,i=n.options.crossOrigin,o=n.options.renderer||"";return function(s){if(r.isResourceLoaded(t,!0))s(t);else{var a=Tn(t[0]);if(function(t){return t&&Pt.decodeImageInWorker&&t instanceof ImageBitmap}(a))createImageBitmap(a).then((function(n){e._cacheResource(t,n),s(t)})).catch((function(e){console.error(e),s(t)}));else if(!Gt(t[0])&&e._resWorkerConn&&("canvas"!==n.options.renderer||n.options.decodeImageInWorker))e._resWorkerConn.fetchImage(a,(function(n,r){if(n)return n&&"undefined"!=typeof console&&console.warn(n),void s(t);me(r,(function(n){e._cacheResource(t,n),s(t)}))}));else{var l=new Image;U(i)?"canvas"!==o&&(l.crossOrigin=""):l.crossOrigin=i,Gt(t[0])&&!z&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),l.onload=function(){e._cacheResource(t,l),s(t)},l.onabort=function(e){console&&console.warn("image loading aborted: "+t[0]),e&&console&&console.warn(e),s(t)},l.onerror=function(e){e&&"undefined"!=typeof console&&console.warn(e),r.markErrorResource(t),s(t)},Wt(l,[a])}}}},n._cacheResource=function(t,e){if(this.layer&&this.resources){var n=t[1],r=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===Gt(t[0])&&(Pt.edge||Pt.ie)){U(n)&&(n=e.width||this.layer.options.defaultIconSize[0]),U(r)&&(r=e.height||this.layer.options.defaultIconSize[1]);var i=Oo.createCanvas(n,r);Oo.image(i.getContext("2d"),e,0,0,n,r),e=i}this.resources.addResource(t,e)}},e}(Ho),xa=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){var n=this;if(this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0},e&&e.width&&e.height&&!e.close&&Pt.imageBitMap&&!Pt.safari&&!Pt.iosWeixin){if(e.src&&Gt(e.src))return;createImageBitmap(e).then((function(e){n.resources[t[0]]&&(n.resources[t[0]].image=e)}))}},e.isResourceLoaded=function(t,e){if(!t)return!1;var n=this._getImgUrl(t);if(this._errors[n])return!0;var r=this.resources[n];return!!r&&!(e&&Gt(t[0])&&(+t[1]>r.width||+t[2]>r.height))},e.login=function(t){var e=this.resources[t];e&&e.refCnt++},e.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&(e.image&&e.image.close&&e.image.close(),delete this.resources[t])},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var n=t.resources[e];this.addResource([e,n.width,n.height],n.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)Y(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},e.remove=function(){for(var t in this.resources){var e=this.resources[t];e&&e.image&&e.image.close&&e.image.close()}this.resources={}},t}();Pt.decodeImageInWorker&&_i(gi,(function(){return"\nfunction (exports) {\n    exports.onmessage = function (msg, postResponse) {\n        var url = msg.data.url;\n        var fetchOptions = msg.data.fetchOptions;\n        requestImageOffscreen(url, function (err, data) {\n            var buffers = [];\n            if (data && data.data) {\n                buffers.push(data.data);\n            }\n            postResponse(err, data, buffers);\n        }, fetchOptions);\n    };\n\n    function requestImageOffscreen(url, cb, fetchOptions) {\n        fetch(url, fetchOptions ? fetchOptions : {})\n            .then(response => response.arrayBuffer())\n            .then(arrayBuffer => {\n                const blob=new Blob([arrayBuffer]);\n                return createImageBitmap(blob);\n            })\n            .then(bitmap => {\n                cb(null, {data:bitmap});\n            }).catch(err => {\n                console.warn('error when loading tile:', url);\n                console.warn(err);\n                cb(err);\n            });\n    }\n}"}));var _a={markerWidth:10,markerHeight:10,markerLineWidth:1},ba=new Vt(0,0);function wa(t,e,n,r,i,o){var s=i.x+o.x,a=i.y+o.y;ba.x=s,ba.y=a;var l=function(t){if(!t)return 0;var{x:e,y:n}=t;if(0===e&&0===n)return 0;if(0===e||!e){if(n<0)return-Math.PI/2;if(n>0)return Math.PI/2}var r=n/e;return n<0&&e<0?Math.atan(r)-Math.PI:n>0&&e<0?Math.atan(r)+Math.PI:Math.atan(r)}(ba),h=Math.sqrt(s*s+a*a),u=0,c=0;u+=Math.cos(e+l)*h,c+=Math.sin(e+l)*h;var[f,d,p,g]=function(t,e,n){var r=Math.PI/2+n,i=Math.PI/4+n,o=n,s=e,a=Math.sqrt(t*t+e*e),l=t,h=Math.cos(r)*s,u=Math.sin(r)*s,c=Math.cos(i)*a,f=Math.sin(i)*a,d=Math.cos(o)*l,p=Math.sin(o)*l,g=Math.min(h,c,d,0),m=Math.min(u,f,p,0);return[g,m,Math.max(h,c,d,0)-g,Math.max(u,f,p,0)-m]}(n,r,e);c+=d;var m=(u+=f)+Math.max(n,p),A=c+Math.max(r,g);return t.set(u,c,m,A),t}var Ta=new Vt(0,0);function Ma(t,e,n,r,i,o,s){var a=Ta.set(e,n);if(r)return wa(t,r,o,s,a,i);var l=t.set(a.x,a.y,a.x+o,a.y+s);return l._add(i),r&&function(t,e){var{xmin:n,ymin:r,xmax:i,ymax:o}=t;ka.set(n,r,i,o),ka.convertTo((function(t){return t._rotate(e)}),t)}(l,r),l}var Ca=[];function Sa(t,e,n){if((n=n||Ra(Ca,e))&&(0===n[0]||0===n[1]))return qa(t),t;var r=Oa(e,n[0],n[1]);return Ma(t,e.markerDx||0,e.markerDy||0,La(e),r,n[0],n[1])}function Ia(t){return"rectangle"===t?"right":"middle"}function Pa(t){return"bar"===t||"pie"===t||"pin"===t?"top":"rectangle"===t?"bottom":"middle"}var Ea=new Ie(0,0);function Oa(t,e,n){var r=2*(t.shadowBlur||0)+.5;Ea.width=e,Ea.height=n;var i=t.markerType,o=je(Ea,t.markerHorizontalAlignment||Ia(i),t.markerVerticalAlignment||Pa(i));return o.x!==-e/2&&(o.x-=te(o.x+e/2)*r),o.y!==-n/2&&(o.y-=te(o.y+n/2)*r),o}function Ra(t,e){var n=$t(e.markerWidth,_a.markerWidth),r=$t(e.markerHeight,_a.markerHeight);if(0===n||0===r)return t[0]=0,t[1]=0,t;var i=$t(e.markerLineWidth,_a.markerLineWidth),o=2*((e.shadowBlur||0)+Math.max(Math.abs(e.shadowOffsetX||0)+Math.abs(e.shadowOffsetY||0))),s=Math.round(n+i+o+1),a=Math.round(r+i+o+1);return t[0]=s,t[1]=a,t}var ka=new vs;function La(t,e="markerRotation"){var n=t[e];return V(n)?-n*Math.PI/180:0}function Da(t,e,n){var r=e.markerFile,i=n?n.getImage(r):null,o=e.markerWidth||(i?i.width:0),s=e.markerHeight||(i?i.height:0);if(Ea.width=o,Ea.height=s,0===e.markerWidth||0===e.markerHeight)return qa(t),t;var a=je(Ea,e.markerHorizontalAlignment||"middle",e.markerVerticalAlignment||"top");return Ma(t,e.markerDx||0,e.markerDy||0,La(e),a,o,s)}function Na(t,e,n){var r=n.size;if(r&&(0===r.width||0===r.height))return qa(t),t;var i=je(r,e.textHorizontalAlignment,e.textVerticalAlignment),o=e.textHaloRadius||0,s=Ma(t,e.textDx||0,e.textDy||0,La(e,"textRotation"),i,r.width,r.height);return s.xmin-=o,s.xmax+=o,s.ymin-=o,s.ymax+=o,s}var Fa=new vs;function za(t,e,n,r){var i=t||new vs;if(Array.isArray(e)){for(var o=e,s=0;s<o.length;s++)za(i,o[s],n,r[s]);return i}return Ba(e)&&i._combine(Na(Fa,e,r)),Ha(e)&&i._combine(Da(Fa,e,n)),ja(e)&&i._combine(Sa(Fa,e)),Ua(e)&&i._combine(Da(Fa,e)),i}function Ba(t){return!!t&&!U(t.textName)}function Ha(t){return!!t&&!U(t.markerFile)}function ja(t){return!!t&&!(!U(t.markerFile)||U(t.markerType)||"path"===t.markerType)}function Ua(t){return!!t&&!(!U(t.markerFile)||"path"!==t.markerType)}var Va,Ga=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","markerRotation","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation","textWrapWidth"],Wa=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY","textWrapWidth"];function qa(t){t&&(t.xmin=1/0,t.ymin=1/0,t.xmax=-1/0,t.ymax=-1/0)}function Xa(t,e,n,r){for(var i,o=[],s=0,a=0,l=t.length;a<l-1;a++)(i=Za(t[a],t[a+1],e,a,n,r))&&(o[s]=o[s]||[],o[s].push({point:i[0],index:a}),i[1]===t[a+1]&&a!==l-2||(o[s].push({point:i[1],index:a+1}),s++));return o}function Za(t,e,n,r,i,o){var s,a,l,h=r?Va:Qa(t,n),u=Qa(e,n);for(Va=u;;){if(!(h|u))return[t,e];if(h&u)return!1;if(o)return[t,e];l=Qa(a=Ja(t,e,s=h||u,n,i),n),s===h?(t=a,h=l):(e=a,u=l)}}function Ya(t,e,n){var r,i,o,s,a,l,h,u,c,f=[1,4,2,8];for(i=0,h=t.length;i<h;i++)t[i]._code=Qa(t[i],e);for(s=0;s<4;s++){for(u=f[s],r=[],i=0,o=(h=t.length)-1;i<h;o=i++)a=t[i],l=t[o],a._code&u?l._code&u||((c=Ja(l,a,u,e,n))._code=Qa(c,e),r.push(c)):(l._code&u&&((c=Ja(l,a,u,e,n))._code=Qa(c,e),r.push(c)),r.push(a));t=r}return t}function Ja(t,e,n,r,i){var o,s,a=e.x-t.x,l=e.y-t.y,h=r.getMin(),u=r.getMax();8&n?(o=t.x+a*(u.y-t.y)/l,s=u.y):4&n?(o=t.x+a*(h.y-t.y)/l,s=h.y):2&n?(o=u.x,s=t.y+l*(u.x-t.x)/a):1&n&&(o=h.x,s=t.y+l*(h.x-t.x)/a);var c=new Vt(o,s);return i&&c._round(),c}function Qa(t,e){var n=0;return t.x<e.getMin().x?n|=1:t.x>e.getMax().x&&(n|=2),t.y<e.getMin().y?n|=4:t.y>e.getMax().y&&(n|=8),n}function Ka(t,e,n,r){t=new Vt(t);var i,o,s,a=Math.abs(n.x-e.x),l=Math.abs(n.y-e.y),h=Math.sqrt(Math.abs(a*a-l*l));return a>=l?(i=new Vt(e.x-h,e.y),o=new Vt(e.x+h,e.y),s=2*a):(i=new Vt(e.x,e.y-h),o=new Vt(e.x,e.y+h),s=2*l),t.distanceTo(i)+t.distanceTo(o)<=s+2*r}function $a(t){if(!t)return[0,0];var e=1/0,n=-1/0;if(V(t))return[e=n=t,n];var r=function(t){for(var r=0,i=t.length;r<i;r++){var o=t[r];e=Math.min(e,o),n=Math.max(n,o)}};if(!Array.isArray(t[0]))return r(t),[e,n];for(var i=0,o=t.length;i<o;i++){r(t[i])}return[e,n]}var tl=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n._prepareContext=function(t){if(Un(this.symbol.opacity)?this._opacityFn||(this._opacityFn=Gn(this.symbol.opacity)):delete this._opacityFn,V(this.symbol.opacity))t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var e=this.getMap();t.globalAlpha=this._opacityFn(e.getZoom())}else 1!==t.globalAlpha&&(t.globalAlpha=1)},n.prepareCanvas=function(t,e,n){t.setLineDash&&ie(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var r=this.getPainter().isHitTesting();Oo.prepareCanvas(t,e,n,r)},n.remove=function(){},n.setZIndex=function(){},n.show=function(){},n.hide=function(){},n._defineStyle=function(t){return this.symbol&&(t.visible=this.symbol.visible,t.opacity=this.symbol.opacity),ur(t,this.geometry)},e}(function(){function t(){this.bbox=jr()}var e=t.prototype;return e._setBBOX=function(t,e,n,r,i){return t.isHitTesting||Wr(this.bbox,e,n,r,i),this},e._bufferBBOX=function(t,e){return t.isHitTesting||Xr(this.bbox,e),this},e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},e.isDynamicSize=function(){return!1},e.isVisible=function(){if(!this.style)return!0;var t=this.style.visible;return!1!==t&&0!==t&&!(this.style.opacity<=0)},t.testColor=function(t){return!(!t||!q(t))&&Ce.indexOf(t)>=0},t}());function el(t,e,n,r){var i,o=nl(n),s=n,a=s.markerType.toLowerCase(),l=rl(a,s.markerWidth,s.markerHeight),h=o.lineOpacity,u=o.polygonOpacity;gr(o.polygonFill)&&(gr(o.polygonFill)&&(i||(i=function(t,e,n){var r=new vs;return r._combine(t),r.xmin+=-e/2,r.ymin+=-n/2,r.xmax+=e/2,r.ymax+=n/2,r}(e,s.markerWidth,s.markerHeight)),o.polygonGradientExtent=i));Oo.prepareCanvas(t,o,r);var c=s.markerWidth,f=s.markerHeight,d=s.markerLineWidth/2;if("ellipse"===a)Oo.ellipse(t,e,c/2,f/2,f/2,h,u);else if("cross"===a||"x"===a){for(var p=l.length-1;p>=0;p--)l[p]._add(e);Oo.path(t,l.slice(0,2),h),Oo.path(t,l.slice(2,4),h)}else if("diamond"===a||"bar"===a||"square"===a||"rectangle"===a||"triangle"===a){"bar"===a?e=e.add(0,-d):"rectangle"===a&&(e=e.add(d,d));for(var g=l.length-1;g>=0;g--)l[g]._add(e);Oo.polygon(t,l,h,u)}else if("pin"===a){e=e.add(0,-d);for(var m=l.length-1;m>=0;m--)l[m]._add(e);var A=t.lineCap;t.lineCap="round",Oo.bezierCurveAndFill(t,l,h,u),t.lineCap=A}else{if("pie"!==a)throw new Error("unsupported markerType: "+a);e=e.add(0,-d);var y=180*Math.atan(c/2/f)/Math.PI,v=t.lineCap;t.lineCap="round",Oo.sector(t,e,f,[90-y,90+y],h,u),t.lineCap=v}return t.canvas}function nl(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}function rl(t,e,n){var r,i,o,s,a=n/2,l=e/2;if("triangle"===t)return[r=new Vt(0,0-a),i=new Vt(0-l,0+a),o=new Vt(0+l,0+a)];if("cross"===t)return[r=new Vt(0-l,0),i=new Vt(0+l,0),o=new Vt(0,0-a),s=new Vt(0,0+a)];if("diamond"===t)return[r=new Vt(0-l,0),i=new Vt(0,0-a),o=new Vt(0+l,0),s=new Vt(0,0+a)];if("square"===t)return[r=new Vt(0-l,0+a),i=new Vt(0+l,0+a),o=new Vt(0+l,0-a),s=new Vt(0-l,0-a)];if("rectangle"===t)return i=(r=new Vt(0,0)).add(e,0),o=r.add(e,n),s=r.add(0,n),[r,i,o,s];if("x"===t)return[r=new Vt(0-l,0+a),i=new Vt(0+l,0-a),o=new Vt(0+l,0+a),s=new Vt(0-l,0-a)];if("bar"===t)return[r=new Vt(0-l,0-n),i=new Vt(0+l,0-n),o=new Vt(0+l,0),s=new Vt(0-l,0)];if("pin"===t||"pie"===t){var h=n*Math.atan(l/a);return[r=new Vt(0,0),i=new Vt(0-h,0-n),o=new Vt(0+h,0-n),s=new Vt(0,0)]}return[]}var il=new Vt(0,0),ol=new Vt(0,0),sl=new Vt(0,0),al=new Vt(0,0),ll=function(t){function e(e,n,r){var i;return(i=t.call(this)||this).symbol=e,i.geometry=n,i.painter=r,i.rotations=[],i}kt(e,t);var n=e.prototype;return n.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLRes(),n=new vs,r=this._getRenderPoints()[0],i=r.length-1;i>=0;i--)r[i]&&n._combine(t._pointAtResToPoint(r[i],e));return n},n.isDynamicSize=function(){var t=this.symbol;return Un(t.markerWidth)||Un(t.markerHeight)||Un(t.textSize)},n._rotateExtent=function(t,e){return t.convertTo((function(t){return t._rotate(e)}))},n._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},n._getRenderContainerPoints=function(t){var e=this.getPainter();if(e.isSpriting())return this._getRenderPoints()[0];var n,r=this.geometry,i=this.getDxDy();if(r._cPoint&&!t){var o=t?sl:al;o.set(r._cPoint.x,r._cPoint.y);var s=e.containerOffset;o._sub(s);var a=i.x,l=i.y;(a||l)&&o._add(a||0,l||0),n=[o]}else{var h=this._getRenderPoints()[0];n=this.painter._pointContainerPoints(h,i.x,i.y,t,!0,this.getPlacement())}if(!n||!Array.isArray(n[0]))return n;for(var u=[],c=0,f=n.length;c<f;c++)for(var d=0,p=n[c].length;d<p;d++)u.push(n[c][d]);return u},n.getPlacement=function(){return this.symbol.markerPlacement},n.getRotation=function(){return La(this.style)},n.getDxDy=function(){var t=this.style,e=t.markerDx,n=t.markerDy;return new Vt(e,n)},n._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var n=this._getRenderPoints()[1];if(!n||!n[t])return e;var r=this.getMap(),i=n[t][0],o=n[t][1];if(!i||!o)return e;if(r.isTransforming()){var s=r.getGLRes();return i=r._pointAtResToContainerPoint(n[t][0],s,0,il),o=r._pointAtResToContainerPoint(n[t][1],s,0,ol),e+ue(i.x,i.y,o.x,o.y)}return e+-ue(i.x,i.y,o.x,o.y)},n._rotate=function(t,e,n){if(n){var r=this.getDxDy(),i=e.sub(r);return t.save(),t.translate(i.x,i.y),t.rotate(n),r}return null},e}(tl),hl=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.getPlacement=function(){return"point"},n.getDxDy=function(){return new Vt(0,0)},n.symbolize=function(t){var e=this.geometry,n=e.getLayer();if(e.options.debug||!n||n.options.debug){var r=this.getMap();if(r&&!r.isZooming()){var i=n.options.debugOutline;t.strokeStyle=i,t.fillStyle=i,t.lineWidth=1,t.font="18px  serif";var o=e.getContainerExtent().toArray();Oo.polygon(t,[o],1,0);for(var s=this._getRenderContainerPoints(),a=this.geometry.getId(),l=rl("cross",10,10),h=0;h<s.length;h++){var u=s[h];U(a)||Oo.fillText(t,a,u.add(8,-4),i);for(var c=[],f=0;f<l.length;f++)c.push(l[f].add(u));Oo.path(t,c.slice(0,2),1),Oo.path(t,c.slice(2,4),1)}}}},e}(ll),ul=new Ie(1,1),cl=new vs,fl=function(t){function e(e,n,r){var i;return(i=t.call(this,e,n,r)||this).style=i._defineStyle(i.translate()),i}kt(e,t),e.test=function(t){return Ha(t)};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var r=this._getRenderContainerPoints();if(ie(r)){var i=this._getImage(e);if(i){this._prepareContext(t);var o,s=n.markerWidth,a=n.markerHeight;if(!V(s)||!V(a)){s=i.width,a=i.height,n.markerWidth=s,n.markerHeight=a;var l=n.markerFile;e.isResourceLoaded(l)||e.addResource(l,i);var h=this.getPainter();h.isSpriting()||h.removeCache()}"path"!==this.symbol.markerType&&V(n.markerOpacity)&&n.markerOpacity<1&&(o=t.globalAlpha,t.globalAlpha*=n.markerOpacity),ul.width=s,ul.height=a;var u=je(ul,n.markerHorizontalAlignment,n.markerVerticalAlignment);this.rotations=[];for(var c=0,f=r.length;c<f;c++){var d=r[c],p=this._rotate(t,d,this._getRotationAt(c)),g=void 0;if(p){var m=d.sub(p);d=p;var A=this._getRotationAt(c);(g=wa(cl,A,s,a,d,u))._add(m),this.rotations.push(A)}var y=d.x+u.x,v=d.y+u.y;Oo.image(t,i,y,v,s,a),p&&t.restore(),p?this._setBBOX(t,g.xmin,g.ymin,g.xmax,g.ymax):this._setBBOX(t,y,v,y+s,v+a)}void 0!==o&&(t.globalAlpha=o)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}}}},n._getImage=function(t){return function(t,e){return t&&t.getImage(e)||null}(t,this.style.markerFile)},n.getFixedExtent=function(t){return this._fixedExtent=this._fixedExtent||new vs,Da(this._fixedExtent,this.style,t)},n.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:$t(t.markerOpacity,1),markerWidth:$t(t.markerWidth,null),markerHeight:$t(t.markerHeight,null),markerRotation:$t(t.markerRotation,0),markerDx:$t(t.markerDx,0),markerDy:$t(t.markerDy,0),markerHorizontalAlignment:$t(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:$t(t.markerVerticalAlignment,"top")}},e}(ll);let dl;const pl={width:100,height:10};let gl=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),gl=!0}catch(S6){gl=!1}let ml=class{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},pl,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!dl){const{width:t,height:e}=pl;gl?dl=new OffscreenCanvas(t,e):(dl=document.createElement("canvas"),dl.width=t,dl.height=e)}return dl}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:s}=this;for(let a=0,l=o.length;a<l;a++){const[t,e]=o[a],n=(t-this.min)/s;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}};var Al=new rs(0,0),yl=new rs(0,0),vl=function(t){function e(e,n,r){var i;return(i=t.call(this)||this).symbol=e,i.geometry=n,i.painter=r,n.isPoint?Ft(i):(i.style=i._defineStyle(i.translate()),i)}kt(e,t),e.test=function(t,e){if(!t)return!1;if(e&&e.isPoint)return!1;for(var n in t){var r=n.slice(0,4);if("line"===r||"poly"===r)return!0}return!1};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity||this.painter.isHitTesting()){var r=this._getPaintParams();if(r){this._prepareContext(t);var i=gr(n.lineColor)||n.lineGradientProperty,o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!i||!n.lineColor.places&&o||(n.lineGradientExtent=this.geometry.getContainerExtent()._expand(n.lineWidth)),gr(n.polygonFill)&&(n.polygonGradientExtent=this.geometry.getContainerExtent());var s=this.geometry.getLayer().options.geometryEventTolerance||0,a=this.geometry._hitTestTolerance()+s,l=r[0];if("Polygon"===this.geometry.getJSONType()&&l.length>0&&Array.isArray(l[0][0])||"LineString"===this.geometry.type&&l.length>0&&Array.isArray(l[0]))for(var h=0;h<l.length;h++){this.prepareCanvas(t,n,e),i&&o&&!n.lineColor.places&&this._createGradient(t,l[h],n.lineColor);var u=[t,l[h]];r.length>1&&u.push(...r.slice(1)),u.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),i&&u.push(this._lineColorIn);var c=this.geometry._paintOn(...u);this._setBBOX(t,c),this._bufferBBOX(t,a)}else{this.prepareCanvas(t,n,e),i&&o&&!n.lineColor.places&&this._createGradient(t,l,n.lineColor);var f=[t];f.push(...r),f.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),i&&f.push(this._lineColorIn);var d=this.geometry._paintOn(...f);this._setBBOX(t,d),this._bufferBBOX(t,a)}t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([]),this._tempRenderPoints=l}}}},n.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new rs(0,0),this._extMax=new rs(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var n=t._prjToPoint(this._extMin,void 0,Al),r=t._prjToPoint(this._extMax,void 0,yl);return this._pxExtent?this._pxExtent.set(Math.min(n.x,r.x),Math.min(n.y,r.y),Math.max(n.x,r.x),Math.max(n.y,r.y)):this._pxExtent=new vs(n,r),this._pxExtent},n.getFixedExtent=function(){var t=this.style.lineWidth/2;return new vs(-t,-t,t,t)},n._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},n.translate=function(){var t=this.symbol,e={lineColor:$t(t.lineColor,"#000"),lineWidth:$t(t.lineWidth,2),lineOpacity:$t(t.lineOpacity,1),lineDasharray:$t(t.lineDasharray,[]),lineCap:$t(t.lineCap,"butt"),lineJoin:$t(t.lineJoin,"miter"),linePatternFile:$t(t.linePatternFile,null),lineDx:$t(t.lineDx,0),lineDy:$t(t.lineDy,0),polygonFill:$t(t.polygonFill,null),polygonOpacity:$t(t.polygonOpacity,1),polygonPatternFile:$t(t.polygonPatternFile,null),polygonPatternDx:$t(t.polygonPatternDx,0),polygonPatternDy:$t(t.polygonPatternDy,0),linePatternDx:$t(t.linePatternDx,0),linePatternDy:$t(t.linePatternDy,0),lineGradientProperty:$t(t.lineGradientProperty,null)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},n._createGradient=function(t,e,n){if(Array.isArray(e)&&e.length){var[r,i]=function(t){var e,n=!0;Array.isArray(t[0])?(e=t[0],n=!1):e=t;var r=e.length;if(n)return[e[0],e[r-1]];for(var i,o=e[0],s=0,a=1;a<r;a++){var l=e[a],h=o.distanceTo(l);h>s&&(s=h,i=l)}return[o,i]}(e);if(r&&i){var o;if(n.colorStops&&(o=n.colorStops),!o)o=(this.geometry.properties||{})[(this.style||{}).lineGradientProperty];if(o&&Array.isArray(o)&&!(o.length<2)){if(!Array.isArray(o[0])){for(var s=[],a=[],l=0,h=0,u=o.length;h<u;h+=2)a[0]=o[h],a[1]=o[h+1],s[l]=a,l++,a=[];o=s}var c=t.createLinearGradient(r.x,r.y,i.x,i.y);o.forEach((function(t){c.addColorStop(...t)})),t.strokeStyle=c;var f=JSON.stringify(o);if(f!==this._lineColorStopsKey){this._lineColorStopsKey=f;var d=o.map((function(t){return[parseFloat(t[0]),t[1]]}));this._lineColorIn=new ml(d,{height:1,width:100})}}}else console.error("unable create canvas LinearGradient,error data:",e)}},e}(tl);var xl=new vs;var _l,bl=function(t){function e(e,n,r){var i,o=(i=t.call(this,e,n,r)||this).translate();return i._dynamic=Vn(o),i.style=i._defineStyle(o),0===i.style.textWrapWidth?Ft(i):(i.strokeAndFill=i._defineStyle(i.translateLineAndFill(i.style)),i)}kt(e,t),e.test=function(t){return Ba(t)};var n=e.prototype;return n.isAlongLine=function(){var t=this.getPlacement(),e=this.style.textSpacing;return"line"===t&&V(e)&&e>0},n.symbolize=function(t,e){if(this.isVisible()&&(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth)){var n=this.style,r=this.strokeAndFill,i=Be(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var o=this._textDesc=this._textDesc||He(i,this.style);this._prepareContext(t),this.prepareCanvas(t,r,e),Oo.prepareCanvasFont(t,n);var s=n.textHaloRadius||0;if(this.rotations=[],this.isAlongLine()){var a=this.getPainter().getPathTempRenderPoints();if(!a)return;if(a=function(t,e){var{width:n,height:r}=e,i=n+0,o=r+0;xl.xmin=-0,xl.ymin=-0,xl.xmax=i,xl.ymax=o,Array.isArray(t[0])||(t=[t]);var s=[];return t.forEach((function(t){for(var e=!1,n=0,r=t.length;n<r;n++){var{x:a,y:l}=t[n];if(a<-0||a>i||l<-0||l>o){e=!0;break}}e?Xa(t,xl,!1,!1).forEach((function(t){for(var e=[],n=0,r=t.length;n<r;n++)e[n]=t[n].point;s.push(e)})):s.push(t)})),s}(a,this.getMap().getSize()),a){var l=this.geometry.getLayer(),h=Oo.textAlongLine(t,i,a,n,o,l.options.collision?l.getCollisionIndex():null);h&&(this._setBBOX(t,h),this._bufferBBOX(t,s))}}else{var u=this._getRenderContainerPoints();if(!ie(u))return;for(var c=0,f=u.length;c<f;c++){var d=u[c],p=this._rotate(t,d,this._getRotationAt(c)),g=void 0;if(p){var m=d.sub(p);d=p;var A=this._getRotationAt(c),{width:y,height:v}=o.size||{width:0,height:0},x=je(o.size,n.textHorizontalAlignment,n.textVerticalAlignment);(g=wa(xl,A,y,v,d,x))._add(m),this.rotations.push(A)}var _=Oo.text(t,i,d,n,o);p?(this._setBBOX(t,g.xmin,g.ymin,g.xmax,g.ymax),t.restore()):this._setBBOX(t,_),this._bufferBBOX(t,s)}}}},n.getPlacement=function(){return this.symbol.textPlacement},n.getRotation=function(){var t=this.style.textRotation;return V(t)?-t*Math.PI/180:null},n.getDxDy=function(){var t=this.style;return new Vt(t.textDx,t.textDy)},n.getFixedExtent=function(){var t=this.geometry.getTextDesc();return Array.isArray(t)&&(t=t[this._index]),this._fixedExtent=this._fixedExtent||new vs,t?Na(this._fixedExtent,this.style,t):this._fixedExtent},n.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:$t(t.textFaceName,"monospace"),textWeight:$t(t.textWeight,"normal"),textStyle:$t(t.textStyle,"normal"),textSize:$t(t.textSize,Se),textFont:$t(t.textFont,null),textFill:$t(t.textFill,"#000"),textOpacity:$t(t.textOpacity,1),textHaloFill:$t(t.textHaloFill,"#ffffff"),textHaloRadius:$t(t.textHaloRadius,0),textHaloOpacity:$t(t.textHaloOpacity,1),textWrapWidth:$t(t.textWrapWidth,null),textWrapCharacter:$t(t.textWrapCharacter,"\n"),textLineSpacing:$t(t.textLineSpacing,0),textDx:$t(t.textDx,0),textDy:$t(t.textDy,0),textHorizontalAlignment:$t(t.textHorizontalAlignment,"middle"),textVerticalAlignment:$t(t.textVerticalAlignment,"middle"),textAlign:$t(t.textAlign,"center"),textRotation:$t(t.textRotation,0),textMaxWidth:$t(t.textMaxWidth,0),textMaxHeight:$t(t.textMaxHeight,0),textSpacing:$t(t.textSpacing,0),textAlongDebug:$t(t.textAlongDebug,!1)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},n.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e}(ll),wl=[0,0],Tl=new vs,Ml=new Vt(0,0),Cl=function(t){function e(e,n,r){var i,o=(i=t.call(this,e,n,r)||this).translate();return i._dynamic=Vn(o),i.style=i._defineStyle(o),i.strokeAndFill=i._defineStyle(nl(i.style)),i.padding=0,i}kt(e,t),e.test=function(t){return ja(t)};var n=e.prototype;return n.symbolize=function(t,e){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var r=this._getRenderContainerPoints();ie(r)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,r,e):this._drawMarkersWithCache(t,r,e))}}},n._drawMarkers=function(t,e,n){for(var r=e.length-1;r>=0;r--){var i=e[r],o=Ra(wl,this.style),[s,a]=o,l=this._rotate(t,i,this._getRotationAt(r));this.rotations=[];var h=void 0;if(l){var u=i.sub(l);i=l;var c=this._getRotationAt(r);(h=wa(Tl,c,s,a,i,Ml))._add(u),this.rotations.push(c)}if(this._drawVectorMarker(t,i,n),l)t.restore(),this._setBBOX(t,h.xmin,h.ymin,h.xmax,h.ymax);else{var{x:f,y:d}=i;this._setBBOX(t,f,d,f+s,d+a)}}},n._drawMarkersWithCache=function(t,e,n){var r=this._stampSymbol(),i=n.getImage(r);i||(i=this._createMarkerImage(t,n),n.addResource([r,i.width,i.height],i));for(var o=Oa(this.style,i.width,i.height),s=e.length-1;s>=0;s--){var a=e[s],l=this._rotate(t,a,this._getRotationAt(s));this.rotations=[];var h=void 0;if(l){var u=a.sub(l);a=l;var c=this._getRotationAt(s);(h=wa(Tl,c,i.width,i.height,a,o))._add(u),this.rotations.push(c)}var f=a.x+o.x,d=a.y+o.y;Oo.image(t,i,f,d),l?(t.restore(),this._setBBOX(t,h.xmin,h.ymin,h.xmax,h.ymax)):this._setBBOX(t,f,d,f+i.width,d+i.height)}},n._createMarkerImage=function(t,e){var n=t.canvas.constructor,r=Ra(wl,this.style),i=Oo.createCanvas(r[0],r[1],n),o=this._getCacheImageAnchor(r[0],r[1]),s=i.getContext("2d");return this._drawVectorMarker(s,o,e),i},n._stampSymbol=function(){return this._stamp||(this._stamp=qe([this.style.markerType,gr(this.style.markerFill)?mr(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,gr(this.style.markerLineColor)?mr(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},n._getCacheImageAnchor=function(t,e){var n=2*(this.symbol.shadowBlur||0)+this.padding,r=this.style.markerType;return"bar"===r||"pie"===r||"pin"===r?new Vt(t/2,e-n):"rectangle"===r?new Vt(n,n):new Vt(t/2,e/2)},n._getGraidentExtent=function(t){var e=new vs,n=this.getDxDy(),r=this.getFixedExtent();if(Array.isArray(t))for(var i=t.length-1;i>=0;i--)e._combine(t[i]);else e._combine(t);return e.xmin+=r.xmin-n.x,e.ymin+=r.ymin-n.y,e.xmax+=r.xmax-n.x,e.ymax+=r.ymax-n.y,e},n._drawVectorMarker=function(t,e,n){el(t,e,this.style,n)},n.getFixedExtent=function(){var t=this.isDynamicSize(),e=this.style.markerWidth,n=this.style.markerHeight;return this._fixedExtent=this._fixedExtent||new vs,Sa(this._fixedExtent,this.style,t?[128,128*(0===e?1:n/e)]:null)},n.translate=function(){var t=this.symbol,e={markerType:$t(t.markerType,"ellipse"),markerFill:$t(t.markerFill,"#00f"),markerFillOpacity:$t(t.markerFillOpacity,1),markerFillPatternFile:$t(t.markerFillPatternFile,null),markerLineColor:$t(t.markerLineColor,"#000"),markerLineWidth:$t(t.markerLineWidth,_a.markerLineWidth),markerLineOpacity:$t(t.markerLineOpacity,1),markerLineDasharray:$t(t.markerLineDasharray,[]),markerLinePatternFile:$t(t.markerLinePatternFile,null),markerDx:$t(t.markerDx,0),markerDy:$t(t.markerDy,0),markerWidth:$t(t.markerWidth,_a.markerWidth),markerHeight:$t(t.markerHeight,_a.markerHeight),markerRotation:$t(t.markerRotation,0),shadowBlur:$t(t.shadowBlur,0),shadowOffsetX:$t(t.shadowOffsetX,0),shadowOffsetY:$t(t.shadowOffsetY,0)},n=e.markerType,r=Ia(n),i=Pa(n);return e.markerHorizontalAlignment=$t(t.markerHorizontalAlignment,r),e.markerVerticalAlignment=$t(t.markerVerticalAlignment,i),V(t.markerOpacity)&&(V(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),V(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e}(ll),Sl=function(t){function e(e,n,r){var i;U(e.markerWidth)&&(e.markerWidth=80),U(e.markerHeight)&&(e.markerHeight=80),e=j({},e,(i=t.call(this,e,n,r)||this).translate());var o=i.style=i._defineStyle(e);return Pt.gecko?i._url=[cr(o,o.markerWidth,o.markerHeight),o.markerWidth,o.markerHeight]:i._url=[cr(o),o.markerWidth,o.markerHeight],i}kt(e,t),e.test=function(t){return Ua(t)};var n=e.prototype;return n._prepareContext=function(){},n._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var n=this.painter,r=new Image;return r.onload=function(){var t=n.getLayer()&&n.getLayer().getRenderer();t&&t.setToRedraw()},r.onerror=function(n){n&&"undefined"!=typeof console&&console.warn(n),t.markErrorResource(e._url)},r.src=this._url[0],t&&t.addResource(this._url,r),r},e}(fl),Il={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Pl=function(t){function e(e,n,r){var i;return(i=t.call(this,e,n,r)||this).style=n.getLayer().options.drawAltitude,i.style&&W(i.style)||(i.style={lineWidth:2}),i.style.lineWidth||(i.style.lineWidth=0),i.dxdy=i._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),i}kt(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var n=e.getJSONType();return"Marker"===n||"LineString"===n};var n=e.prototype;return n.symbolize=function(t){if(this.geometry.getLayer().options.drawAltitude&&this.geometry.hasAltitude()){var e=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var n=this._getPaintParams(e.lineDx,e.lineDy);if(!n)return;var r=this.getPainter().getPaintParams(e.lineDx,e.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(t,n[0],r)}else{var i=this._getRenderContainerPoints(),o=this._getRenderContainerPoints(!0);if(!i||0===i.length)return;this._drawMarkerAltitude(t,i[0],o[0])}}},n.getDxDy=function(){var t=this.dxdy;return new Vt(t.dx||0,t.dy||0)},n.get2DExtent=function(){return"LineString"===this.geometry.type?vl.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},n.getPlacement=function(){return"point"},n._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0,null,!0,"_altpt")},n._drawMarkerAltitude=function(t,e,n){var r=this._getStyle();this.prepareCanvas(t,r),Oo.path(t,[e,n],r.lineOpacity,null,r.lineDasharray)},n._drawLineAltitude=function(t,e,n){var r=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var i=0;i<e.length;i++)this._drawLine(t,e[i],n[i]);else this._drawLine(t,e,n);t.setLineDash&&Array.isArray(r.lineDasharray)&&t.setLineDash([])},n._drawLine=function(t,e,n){var r=this._getStyle();this.prepareCanvas(t,r);for(var i=0,o=e.length-1;i<o;i++)Oo.polygon(t,[e[i],e[i+1],n[i+1],n[i]],r.lineOpacity,r.polygonOpacity,r.lineDasharray)},n._getStyle=function(){var t=this.geometry.getLayer(),e=t.options.drawAltitude;if(Array.isArray(e)){var n=(t.getGeometries()||[]).indexOf(this.geometry);n>=0&&(e=e[n]||Il)}return W(e)||(e=Il),e.lineWidth||(e.lineWidth=0,e.lineOpacity=0),e},e}(ll),El=[Pl,vl,fl,Sl,Cl,bl],Ol=new Vt(0,0),Rl=new vs,kl=new vs,Ll=new vs,Dl=new vs,Nl=new vs,Fl={code:void 0},zl={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},Bl=function(t){function e(e){var n;return(n=t.call(this)||this).geometry=e,n.symbolizers=n._createSymbolizers(),n._altAtGL=n._getGeometryAltitude(),n.bbox=jr(),n._drawTime=0,n}kt(e,t);var n=e.prototype;return n._setDrawTime=function(t){return this._drawTime=t,this},n.getRenderBBOX=function(){var t=this.getLayer();if(t&&t._drawTime!==this._drawTime)return null;Vr(this.bbox);for(var e=this.symbolizers.length-1;e>=0;e--){var n=this.symbolizers[e].bbox;qr(n)&&Wr(this.bbox,n)}return qr(this.bbox)?this.bbox:null},n.getMap=function(){return this.geometry.getMap()},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n._createSymbolizers=function(){var t=this.getSymbol(),e=[],n=El,r=t;Array.isArray(t)||(r=[t]);for(var i=r.length-1;i>=0;i--)for(var o=r[i],s=n.length-1;s>=0;s--)if(n[s].test(o,this.geometry)){var a=new n[s](o,this.geometry,this);a._index=i,e.push(a),a instanceof ll&&(this._hasPoint=!0)}if(!e.length&&console){var l=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(l?":"+l:""):"")+") to draw : "+JSON.stringify(t))}return this._debugSymbolizer=new hl(t,this.geometry,this),e},n.hasPoint=function(){return!!this._hasPoint},n.getRenderPoints=function(t){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},n.getPaintParams=function(t,e,n,r,i="_pt"){var o,s,a,l,h,u=this.getLayer()._getRenderer().mapStateCache,c=this.getMap();u&&!this._hitPoint?(o=u.resolution,s=u.pitch,a=u.bearing,l=u.glScale,h=u.containerExtent):(o=c.getResolution(),s=c.getPitch(),a=c.getBearing(),l=c.getGLScale(),h=c.getContainerExtent());var f=this.geometry,d=o,p=0!==s,g=0!==a,m=this._cachedParams,A=f._paintAsPath&&f._paintAsPath();if(A&&this._unsimpledParams&&d<=this._unsimpledParams._res)m=this._unsimpledParams;else if(!m||m._res!==o||this._pitched!==p&&f._redrawWhenPitch()||this._rotated!==g&&f._redrawWhenRotate()){if(!(m=f._getPaintParams()))return null;m._res=d,!f._simplified&&A&&(this._unsimpledParams||(this._unsimpledParams=m),d>this._unsimpledParams._res&&(this._unsimpledParams._res=d)),this._cachedParams=m}if(!m)return null;this._pitched=p,this._rotated=g;var y=l,v=[],x=m[0],_=h,b=this._pointContainerPoints(x,t,e,n,r||this._hitPoint&&!_.contains(this._hitPoint),null,i);if(!b)return null;v.push(b);for(var w=1,T=m.length;w<T;w++)V(m[w])||m[w]instanceof Ie?V(m[w])?v.push(m[w]/y):v.push(m[w].multi(1/y)):v.push(m[w]);return v},n._pointContainerPoints=function(t,e,n,r,i,o,s="_pt"){if(this._aboveCamera())return null;var a,l,h,u=this.getLayer()._getRenderer(),c=u.mapStateCache,f=this.getMap(),d=this.geometry,p=this.containerOffset;c?(a=c.glRes,l=c.containerExtent):(a=f.getGLRes(),l=f.getContainerExtent());var g=this.getLayer().options.roundPoint,m=1/0,A=1/0,y=-1/0,v=-1/0,x=!i,_=u.layer.options.clipBBoxBufferSize||3,b=this.symbolizers,w=d.options.enableClip;function T(t=[],r=[]){for(var i=ge(t,s),o=0,h=(i=f._pointsAtResToContainerPoints(t,a,r,i)).length;o<h;o++){var u=i[o];u._sub(p),(e||n)&&u._add(e||0,n||0),g&&(u.x=Math.ceil(u.x),u.y=Math.ceil(u.y)),m=Math.min(u.x,m),A=Math.min(u.y,A),y=Math.max(u.x,y),v=Math.max(u.y,v)}if(w&&x&&function(t=[]){Array.isArray(t)||(t=[t]);for(var e=t.length,n=0;n<e;n++){var r=t[n];if(r.style){var{lineDasharray:i,lineWidth:o}=r.style;if(o&&V(o)&&o>0&&i&&Array.isArray(i)&&i.length)return!0}}return!1}(b)){if(Nl.ymin=l.ymin,Nl.ymin<_&&(Nl.ymin=l.ymin-_),Nl.xmin=l.xmin-_,Nl.xmax=l.xmax+_,Nl.ymax=l.ymax+_,d.getShell&&d.getHoles)return Ya(i,Nl);var c=Xa(i,Nl,!1);if(c.length){var T=[];return c.forEach((function(t){for(var e=0,n=t.length;e<n;e++)T.push(t[e].point)})),T}}return i}var M=this.getAltitude();if(Array.isArray(t)){var C,S=this.geometry;!i&&S.options.enableClip?(C=this._clip(t,M)).inView&&(x=!1):C={points:t,altitude:M};var I=C.points;M=C.altitude,r&&(M=0);var P=M;h=[];for(var E=[],O=V(M),R=0,k=I.length;R<k;R++){var L=I[R];if(Array.isArray(L)){if(O){var D=T(L,M);h.push(D);continue}for(var N=[],F=0,z=L.length;F<z;F++)Array.isArray(M)&&(P=M[R]?M[R][F]:0),N.push(P);var B=T(L,N);h.push(B)}else Array.isArray(M)&&(P="vertex-last"===o?M[M.length-1-R]:"line"===o?(M[R]+M[R+1])/2:M[R]),E.push(P)}E.length&&(h=T(I,E))}else t instanceof Vt&&(r&&(M=0),h=f._pointAtResToContainerPoint(t,a,M)._sub(p),(e||n)&&h._add(e,n));return zl.minx=m,zl.miny=A,zl.maxx=y,zl.maxy=v,this._containerBbox=zl,h},n._clip=function(t,e){if(V(e)&&0!==e)return{points:t,altitude:e};if(Array.isArray(e)){for(var n=!1,r=0,i=e.length;r<i;r++)if(0!==e[r]){n=!0;break}if(n)return{points:t,altitude:e}}var o=this.getMap(),s=this.geometry,a=this.getSymbol().lineWidth;V(a)||(a=4);var l,h,u,c=this.getLayer()._getRenderer().mapStateCache;c?(l=c._2DExtent,h=c.glExtent,u=c.pitch):(l=o.get2DExtent(),h=o.get2DExtentAtRes(o.getGLRes()),u=o.getPitch());var f=l._expand(a);if(u>0&&e){var d=o.cameraLookAt,p=o.cameraPosition;Ol.set(p[0],p[1]),f=f._combine(Ol._add(te(d[0]-p[0]),te(d[1]-p[1])))}var g=t;if(this.get2DExtent(null,Dl).within(f))return{points:g,altitude:e,inView:!0};var m=h._expand(a*o.getGLScale());Ll.xmin=m.xmin,Ll.xmax=m.xmax,Ll.ymin=m.ymin,Ll.ymax=m.ymax;var A=s.options.smoothness;if(s.getShell&&this.geometry.getHoles&&!A){var{xmin:y,ymin:v,xmax:x,ymax:_}=m,b=Math.abs(x-y),w=Math.abs(_-v),T=Math.sqrt(b*b+w*w),M=(T-b)/2,C=(T-w)/2;if(Ll.xmin=m.xmin-M,Ll.xmax=m.xmax+M,Ll.ymin=m.ymin-C,Ll.ymax=m.ymax+C,Array.isArray(t[0])){g=[];for(var S=0;S<t.length;S++){var I=Ya(t[S],Ll);I.length&&g.push(I)}}else g=Ya(t,Ll)}else if("LineString"===s.getJSONType()&&!A){if(Array.isArray(t[0])){g=[];for(var P=0;P<t.length;P++)Jt(g,Xa(t[P],Ll,!1,!!A))}else g=Xa(t,Ll,!1,!!A);return this._interpolateSegAlt(g,t,e)}return{points:g,altitude:e}},n._interpolateSegAlt=function(t,e,n){if(!Array.isArray(n)){var r=function(t){return t.point};return{points:t.map((function(t){return Array.isArray(t)?t.map(r):t.point})),altitude:n}}var i=Hl(t,e,n);return n=[],{points:i.map((function(t){if(Array.isArray(t)){var e=[],r=t.map((function(t){return e.push(t.altitude),t.point}));return n.push(e),r}return n.push(t.altitude),t.point})),altitude:n}},n.getSymbol=function(){return this.geometry._getInternalSymbol()},n._resetSymbolizersBBOX=function(){for(var t=this.symbolizers.length-1;t>=0;t--){Vr(this.symbolizers[t].bbox)}return this},n.paint=function(t,e,n){if(this.symbolizers){var r=this.getLayer(),i=r._getRenderer();if(i&&(i.context||e)){var o=i.mapStateCache||{offset:void 0};if(this.geometry._isCheck||!t||t.intersects(this.get2DExtent(i.resources,Rl))){var s=this.getMap();if(!this._aboveCamera()){this.containerOffset=n||o.offset||s._pointToContainerPoint(i.middleWest)._add(0,-s.height/2),this._beforePaint();var a=e||i.context;a.isHitTesting||this._resetSymbolizersBBOX();for(var l=[a,i.resources],h=this.symbolizers.length-1;h>=0;h--)(a.shadowBlur||this.symbolizers[h].symbol.shadowBlur)&&this._prepareShadow(a,this.symbolizers[h].symbol),this.symbolizers[h].symbolize(...l);this._afterPaint(),this._painted=!0,(this.geometry.options.debug||r.options.debug)&&this._debugSymbolizer.symbolize(a)}}}}},n.getSprite=function(t,e){if(!this.geometry.isPoint)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var n=new vs;this.symbolizers.forEach((function(e){var r=e.getFixedExtent(t);n._combine(r)}));var r,i=n.getMin().multi(-1),o=e||(this.getMap()?this.getMap().CanvasClass:null),s=Oo.createCanvas(n.getWidth(),n.getHeight(),o);this._renderPoints&&(r=this._renderPoints);for(var a=s.getContext("2d"),l=[a,t],h=this.symbolizers.length-1;h>=0;h--){var u=this.symbolizers[h].getDxDy();this._renderPoints={center:[[i.add(u)]]},this._prepareShadow(a,this.symbolizers[h].symbol),this.symbolizers[h].symbolize(...l)}r&&(this._renderPoints=r),this._sprite={canvas:s,offset:n.getCenter()}}return this._spriting=!1,this._sprite},n.isSpriting=function(){return!!this._spriting},n.hitTest=function(t,e){if((!e||e<.5)&&(e=.5),this._hitPoint=t.sub(e,e),!_l){var n=this.getMap()?this.getMap().CanvasClass:null;_l=Oo.createCanvas(1,1,n)}Oo.setHitTesting(!0),_l.width=_l.height=2*e;var r=Oo.getCanvas2DContext(_l);r.isHitTesting=!0;try{this.paint(null,r,this._hitPoint)}finally{Oo.setHitTesting(!1)}delete this._hitPoint;for(var i=r.getImageData(0,0,_l.width,_l.height).data,o=3,s=i.length;o<s;o+=4)if(i[o]>0)return!0;return!1},n.isHitTesting=function(){return!!this._hitPoint},n._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},n._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var n=this.symbolizers.length-1;n>=0;n--)t.apply(e,[this.symbolizers[n]])}},n.get2DExtent=function(t,e){this._verifyProjection();var n=this.getMap();t=t||this.getLayer()._getRenderer().resources;var r=n.getZoom(),i=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===r&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==r&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new vs),this._extent2D._zoom=r),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(t,new vs)))),!this._extent2D)return i&&delete this._fixedExtent,null;var{xmin:o,ymin:s,xmax:a,ymax:l}=this._fixedExtent;return i&&delete this._fixedExtent,kl.set(o,-l,a,-s),e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(kl),e):this._extent2D.add(kl)},n._computeExtent2D=function(t){for(var e=this.symbolizers.length-1;e>=0;e--){var n=this.symbolizers[e];t._combine(n.get2DExtent())}return t},n._computeFixedExtent=function(t,e){for(var n=this.symbolizers.length-1;n>=0;n--){var r=this.symbolizers[n];r.getFixedExtent&&e._combine(r.getFixedExtent(t))}return e},n._isDynamicSize=function(){for(var t=this.symbolizers.length-1;t>=0;t--){if(this.symbolizers[t].isDynamicSize())return!0}return!1},n._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap(),n=e.getGLRes();t=e.altitudeToPoint(t,n)*te(t);var r=e.getFrustumAltitude();return t&&r&&r<t},n.getFixedExtent=function(){var t=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new vs):(this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,kl),this._fixedExtent)},n.setZIndex=function(t){this._eachSymbolizer((function(e){e.setZIndex(t)}))},n.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(t){t.show()}))):this.getLayer().isCanvasRender()||this.paint()},n.hide=function(){this._eachSymbolizer((function(t){t.hide()}))},n.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},n.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},n.remove=function(){this.removeCache(),this._removeSymbolizers()},n._removeSymbolizers=function(){this._eachSymbolizer((function(t){delete t.painter,t.remove()})),delete this.symbolizers},n.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},n.getAltitude=function(){return this.geometry._getAltitude()!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},n.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},n.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},n._getGeometryAltitude=function(){if(!this.getMap())return 0;var t=this.geometry._getAltitude();this._propAlt=t;var[e,n]=$a(t);return this.minAltitude=e,this.maxAltitude=n,t&&this.geometry.getCenter()?t:0},n._verifyProjection=function(){var t=this.geometry._getProjection()||Fl;this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},n._beforePaint=function(){},n._afterPaint=function(){},n.getPathTempRenderPoints=function(){for(var t=0,e=(this.symbolizers||[]).length;t<e;t++){var n=this.symbolizers[t];if(n instanceof vl&&n._tempRenderPoints)return n._tempRenderPoints}},e}(Ho);function Hl(t,e,n){if(!Array.isArray(n))return t;for(var r=[],i=0,o=t.length;i<o;i++)if(Array.isArray(t[i]))r.push(Hl(t[i],e,n));else{var s=t[i];if(s.point.equals(e[s.index]))s.altitude=n[s.index],r.push(s);else{var a=void 0,l=void 0;0===s.index?(a=s.index,l=s.index+1):(a=s.index-1,l=s.index);var h=s.point.distanceTo(e[l]),u=h/(h+e[a].distanceTo(s.point)),c=ee(n[a],n[l],1-u);s.altitude=c,r.push(s)}}return r}var jl=new vs,Ul=function(t){function e(e,n){var r;return(r=t.call(this)||this).geometry=e,r.isMask=n,r.bbox=jr(),r._drawTime=0,r}kt(e,t);var n=e.prototype;return n._setDrawTime=function(t){return this._drawTime=t,this._eachPainter((function(e){e._setDrawTime(t)})),this},n.getRenderBBOX=function(){var t=this,e=this.getLayer();return e&&e._drawTime!==this._drawTime?null:(Vr(this.bbox),this._eachPainter((function(e){var n=e.getRenderBBOX();qr(n)&&Wr(t.bbox,n)})),qr(this.bbox)?this.bbox:null)},n._eachPainter=function(t){for(var e,n=this.geometry.getGeometries(),r=0,i=n.length;r<i&&(!(e=this.isMask?n[r]._getMaskPainter():n[r]._getPainter())||!e||!1!==t.call(this,e));r++);},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n.paint=function(t){this.geometry&&this._eachPainter((function(e){e.paint(t)}))},n.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var n=e||new vs;return this._eachPainter((function(e){n=n._combine(e.get2DExtent(t,jl))})),n},n.remove=function(){this._eachPainter((function(t){t.remove()}))},n.setZIndex=function(t){this._eachPainter((function(e){e.setZIndex(t)}))},n.show=function(){this._eachPainter((function(t){t.show()}))},n.hide=function(){this._eachPainter((function(t){t.hide()}))},n.repaint=function(){this._eachPainter((function(t){t.repaint()}))},n.refreshSymbol=function(){this._eachPainter((function(t){t.refreshSymbol()}))},n.hasPoint=function(){var t=!1;return this._eachPainter((function(e){return!e.hasPoint()||(t=!0,!1)})),t},n.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter((function(n){var r=n.getMinAltitude();(t||r<e)&&(t=!1,e=r)})),e},n.getMaxAltitude=function(){var t=0;return this._eachPainter((function(e){var n=e.getMaxAltitude();n>t&&(t=n)})),t},e}(Ho);function Vl(t,e=[]){return e.forEach((function(e){var[n,r]=e;t=t.replace(n,r)})),t}function Gl(t){var{projection:e,isArcgis:n,isGeoServer:r,isSuperMap:i}=t,o=.0002645833333333333;return(n||r||i)&&(o=28e-5),e&&e.indexOf("4326")>-1&&(o=2.3767925226029154e-9,(n||i)&&(o=2.518101729011901e-9),r&&(o=2.51528279553466e-9)),o}var Wl="wmts";function ql(t,e){var n=t.getElementsByTagName(e);if(n&&n.length)return n;var r=Wl+":"+e;return t.getElementsByTagName(r)}function Xl(t,e){for(var n=0;n<t.length;n++){var r=t[n];if((r=r.getElementsByTagName("ows:Identifier")[0])&&r.textContent===e)return t[n]}return null}function Zl(t,e={}){var n,r,i,o=ql(t,"TileMatrix"),s=[],a=[],l=[],h=!1;if(!n){var u=t.getElementsByTagName("ows:SupportedCRS")[0];u&&(n=function(t){for(var e="",n=t.split(""),r=n.length-1;r>=0&&!isNaN(n[r]);r--)e=n[r]+e;return e}(n=(n=u.textContent).split("EPSG")[1]),n=function(t){var e=t.indexOf("EPSG")>-1?t:"EPSG:"+t;return Vl(e,[["4490","4326"],["102100","3857"],["900913","3857"]])}(n))}r||(r=t.getElementsByTagName("ows:Identifier")[0])&&(r=r.textContent),e.projection=n;for(var c=1/0,f=0;f<o.length;f++){var d=o[f],p=d.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(p))?(i=p.substr(0,p.lastIndexOf(":")),p=(p=p.split(":"))[p.length-1],p=parseInt(p),h=!0,e.isGeoServer=!0):p=parseInt(p),c=Math.min(c,p);var g=ql(d,"ScaleDenominator")[0].textContent,m=ql(d,"TopLeftCorner")[0].textContent,A=ql(d,"TileWidth")[0].textContent,y=ql(d,"TileHeight")[0].textContent;if(0===l.length&&l.push(parseInt(A),parseInt(y)),0===a.length){var[v,x]=m.split(" ").filter((function(t){return""!==t})).map((function(t){return parseFloat(t)}));v>0?a.push(1,-1,x,v):a.push(1,-1,v,x)}var _=Gl(e),b=parseFloat(g)*_;s.push(b)}if(c>0)for(var w=s[0],T=c-1;T>=0;T--)w*=2,s.splice(0,0,w);return{resolutions:s,tileSize:l,tileSystem:a,projection:n,TileMatrixSet:r,isGeoServer:h,levelStr:i}}var Yl=function(t,e,n={jsonp:!0}){q(t)&&vn.get(t,(function(r,i){if(r)e(r);else{var o=function(t,e,n){["isArcgis","isSuperMap","isGeoServer"].every((function(t){return null==n[t]}))&&console.warn("Please specify the server type, such as isArcgis, isSuperMap, isGeoServer, Otherwise, the system will determine by itself"),null==n.isArcgis&&(n.isArcgis=["arcgis","geoscene"].some((function(e){return t.indexOf(e)>-1}))),null==n.isSuperMap&&(n.isSuperMap=t.indexOf("supermap")>-1);var r=(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("Contents")[0];if(!r)return[];var i=ql(r,"Layer");if(!i.length)return[];for(var o=[],s=0,a=r.childNodes.length;s<a;s++)"TileMatrixSet"===r.childNodes[s].localName&&o.push(r.childNodes[s]);if(!o.length)return[];for(var l=[],h=0,u=i.length;h<u;h++){var c=i[h],f=c.querySelectorAll("Style")[0];f&&(f=f.getElementsByTagName("ows:Identifier")[0])&&(f=f.textContent);var d=c.getElementsByTagName("ows:Identifier")[0];d&&(d=d.textContent);var p=ql(c,"TileMatrixSetLink");if(0!==p.length)for(var g=0,m=p.length;g<m;g++){var A=p[g];(A=ql(A,"TileMatrixSet")[0])&&(A=A.textContent);var y=Xl(o,A);if(y){var v=c.querySelectorAll("ResourceURL")[0],x="";v&&(x=v.attributes.template.value);var{resolutions:_,tileSize:b,tileSystem:w,projection:T,TileMatrixSet:M,isGeoServer:C,levelStr:S}=Zl(y,n);x.length||(x=e.substr(0,e.lastIndexOf("?")),x+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var I=Vl(x,[["{LAYER}",d],["{Layer}",d],["{layer}",d],["{STYLE}",f],["{Style}",f],["{style}",f],["{TileMatrixSet}",M],["{TileMatrix}",C?S+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",C?"image/png":"tiles"]]);l.push({tileSize:b,tileSystem:w,spatialReference:{resolutions:_,projection:T},urlTemplate:I,info:{layerName:d,TileMatrixSet:M,style:f,tileSize:b,tileSystem:w,resolutions:_,projection:T,urlTemplate:I}})}}}return l}(i,t,n);e(null,o)}}),n)};function Jl(t){for(var e=t.tileInfo,n=[e.cols,e.rows],r=[],i=e.lods,o=0,s=i.length;o<s;o++)r.push(i[o].resolution);var a=t.fullExtent,l=e.origin,h=[1,-1,l.x,l.y];return delete a.spatialReference,{spatialReference:{resolutions:r,fullExtent:a},tileSystem:h,tileSize:n}}var Ql=23,Kl={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=12756274*Math.PI,n=0;n<Ql;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<Ql;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{projection:"baidu",resolutions:function(){for(var t=Math.pow(2,18),e=[],n=0;n<Ql;n++)e[n]=t,t*=.5;return e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var t=Math.pow(2,8),e=[],n=0;n<Ql;n++)e[n]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=6378137*Math.PI,n=0;n<Ql;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"PRESET-VT-4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<Ql;e++)t[e]=45/(128*Math.pow(2,e));return t}()}};Kl["EPSG:4490"]=Kl["EPSG:4326"],Kl["PRESET-3857-512"]=Kl["PRESET-VT-3857"],Kl["PRESET-4326-512"]=Kl["PRESET-VT-4326"],Kl["PRESET-4490-512"]=Kl["PRESET-VT-4326"];var $l=function(){function t(t={}){this.options=t,this._initSpatialRef()}t.registerPreset=function(t,e){t=t&&t.toUpperCase(),Kl[t]&&console.warn("Spatial reference "+t+" already registered."),Kl[t]=e},t.getPreset=function(t){return Kl[t.toUpperCase()]},t.getAllPresets=function(){return Object.keys(Kl)},t.loadArcgis=function(t,e,n){return function(t,e,n={jsonp:!0}){if(q(t)&&"{"!==t.substring(0,1))vn.getJSON(t,(function(t,n){if(t)e(t);else{var r=Jl(n);e(null,r)}}),n);else{q(t)&&(t=Yt(t));var r=Jl(t);e(null,r)}}(t,e,n),this},t.loadWMTS=function(t,e,n){return Yl(t,e,n),this},t.getProjectionInstance=function(t){var e;if(!t)return null;if((e=q(t)?{code:t}:t).project)return e.locate||("identity"===(e=j({},e)).measure?j(e,Ls("IDENTITY")):j(e,Ls("EPSG:4326"))),e;var n=(e.code+"").toLowerCase();for(var r in aa)if(Y(aa,r)){var i=aa[r].aliases||[],o=aa[r].code;o&&i.push(o);for(var s=0;s<i.length;s++)if(i[s].toLowerCase()===n){if(aa[r].create){var a=aa[r].create(t);return a.code=i[s],a}if(aa[r].code===i[s])return aa[r];var l=j({},aa[r]);return l.code=i[s],l}}return null},t.equals=function(t,e){if(q(t)||q(e))return t===e;if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var n=t.fullExtent,r=e.fullExtent;if(n&&!r||!n&&r)return!1;if(n&&r&&(n.top!==r.top||n.bottom!==r.bottom||n.left!==r.left||n.right!==r.right))return!1;var i=t.resolutions,o=e.resolutions;if(i&&o){if(i.length!==o.length)return!1;for(var s=0;s<i.length;s++)if(i[s]!==o[s])return!1}else if(i||o)return!1;return!0};var e=t.prototype;return e._initSpatialRef=function(){var e;if(!(e=this.options.projection?t.getProjectionInstance(this.options.projection):sa))throw new Error("must provide a valid projection in map's spatial reference.");(e=j({},_s,e)).measureLength||j(e,Os),this._projection=e;var n,r=this.options.resolutions;if(!r&&(e.code&&(n=Kl[e.code.toUpperCase()])&&(r=n.resolutions,this.isEPSG="IDENTITY"!==e.code),!r))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=r,this._pyramid=!0,this._pyramid)for(var i=0;i<r.length;i++)if(r[i]&&r[i-1]&&Math.round(r[i-1]/r[i]*1e4)/1e4!=2){this._pyramid=!1;break}var o=this.options.fullExtent;if(!o&&(e.code&&(n=Kl[e.code.toUpperCase()])&&(o=n.fullExtent),!o))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(U(o.left)?(this._fullExtent=new As(o),o.left=o.xmin,o.right=o.xmax,o.top=o.ymax,o.bottom=o.ymin):this._fullExtent=new As(new rs(o.left,o.top),new rs(o.right,o.bottom)),U(o.top)||U(o.bottom)||U(o.left)||U(o.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");j(this._fullExtent,o),this._projection.fullExtent=o;var s=o.right>=o.left?1:-1,a=o.top>=o.bottom?-1:1;this._transformation=new xs([s,a,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var n=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?n+(this._resolutions[e+1]-n)*(t-e):n},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!U(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!U(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return te(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},e.isPyramid=function(){return this._pyramid},t}(),th=new Vt(0,0),eh=new vs,nh={};var rh=function(t){function e(e){var n,r=j({},e),i=r.symbol,o=r.properties,s=r.id;return delete r.symbol,delete r.id,delete r.properties,n=t.call(this,r)||this,i?n.setSymbol(i):n._genSizeSymbol(),o&&n.setProperties(o),U(s)||n.setId(s),e&&V(e.rotateAngle)&&(n._dirtyRotate=!0),n}kt(e,t),e.fromJSON=function(t){return t};var n=e.prototype;return n.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},n.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},n.addTo=function(t,e){return t.addGeometry(this,e),this},n.getLayer=function(){return this._layer?this._layer:null},n.getMap=function(){return this._layer?this._layer.getMap():null},n.getId=function(){return this._id},n.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},n.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},n.setProperties=function(t){var e=this.properties;return this.properties=W(t)?j({},t):t,this._clearAltitudeCache(),this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},n.getType=function(){return this.type},n.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?vr(t):j({},t):null},n.setSymbol=function(t){return this._symbolUpdated=t,this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},n.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=Ar(this._symbolUpdated)),this._symbolHash},n.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Parameter of updateSymbol is not an array.");for(var n=0;n<t.length;n++)Ba(t[n])&&delete this._textDesc,e[n]&&t[n]&&(e[n]=vr(e[n],t[n]))}else{if(Array.isArray(t))throw new Error("Geometry's symbol is not an array to update.");Ba(e)&&delete this._textDesc,e=vr(e||this._getInternalSymbol(),t)}return this._eventSymbolProperties=t,delete this._compiledSymbol,this.setSymbol(e)},n.getTextContent=function(){var t=this._getInternalSymbol();if(Array.isArray(t)){for(var e=[],n=!1,r=0;r<t.length;r++)e[r]=Be(t[r]&&t[r].textName,this.getProperties()),U(e[r])||(n=!0);return n?e:null}return Be(t&&t.textName,this.getProperties())},n.getTextDesc=function(){if(!this._textDesc){var t=this.getTextContent(),e=this._sizeSymbol,n=Array.isArray(t);Array.isArray(e)?this._textDesc=e.map((function(e,r){return He(n?t[r]:"",e)})):this._textDesc=He(t,e)}return this._textDesc},n.getCenter=function(){return this._computeCenter(this._getMeasurer())},n.getExtent=function(){var t=this._getPrjExtent(),e=this._getProjection();if(t&&e){var n=e.unproject(new rs(t.xmin,t.ymin)),r=e.unproject(new rs(t.xmax,t.ymax));return new As(n,r,e)}return this._computeExtent(this._getMeasurer())},n.getContainerExtent=function(t){var e=this.get2DExtent();if(!e||!e.isValid())return null;var n=this.getMap(),r=n.getGLRes(),i=this.getMinAltitude(),o=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,r,i,th)}),t),s=this.getMaxAltitude();if(s!==i){var a=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,r,s,th)}),eh);o._combine(a)}var l=this.getLayer();if(l&&"LineString"===this.type&&s&&l.options.drawAltitude){var h=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,r,0,th)}),eh);o._combine(h)}if(o){var u=this._getFixedExtent();(function(t){if(!t)return!1;var{xmin:e,ymin:n,xmax:r,ymax:i}=t;return r-e>0&&i-n>0})(u)&&o._add(u)}return this.options.smoothness&&o._expand(.15*o.getWidth()),o},n._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new vs);var t=this._sizeSymbol,e=(t&&t.lineWidth||1)/2;this._fixedExtent.set(-e,-e,e,e);var n=t&&t.lineDx||0;this._fixedExtent._add([n,0]);var r=t&&t.lineDy||0;return this._fixedExtent._add([0,r]),this._fixedExtent},n.get2DExtent=function(){var t=this.getMap();if(!t)return null;if(this._extent2d)return this._extent2d;var e=this._getPrjExtent();if(!e||!e.isValid())return null;var n=e.getMin(),r=e.getMax(),i=t.getGLRes();return t._prjToPointAtRes(n,i,n),t._prjToPointAtRes(r,i,r),this._extent2d=new vs(n,r),this._extent2d.z=t.getZoom(),this._extent2d},n.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},n.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof rs&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},n._containsPoint=function(t,e){var n=this._getPainter();return!!n&&(e=e||0,this._hitTestTolerance&&(e+=this._hitTestTolerance()),n.hitTest(t,e))},n.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},n.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(!this.symbolIsVisible())return!1;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,n=t.length;e<n;e++)if(U(t[e].opacity)||t[e].opacity>0)return!0;return!1}return U(t.opacity)||W(t.opacity)||V(t.opacity)&&t.opacity>0},n.symbolIsVisible=function(){var t=this._getCompiledSymbol();if(!t)return!0;Array.isArray(t)||(t=[t]);for(var e=0,n=t.length;e<n;e++){var r=t[e];if(r){var i=r.visible;if(!1!==i&&0!==i)return!0}}return!1},n.getZIndex=function(){return this.options.zIndex||0},n.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},n.setZIndexSilently=function(t){return this.options.zIndex=t,this},n.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},n.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},n.translate=function(t,e,n){if(U(t))return this;var r=new rs(t,e,n);if(0===r.x&&0===r.y&&(U(r.z)||0===r.z))return this;var i=this.getCoordinates();if(this._silence=!0,i)if(Array.isArray(i)){var o=Kt(i,(function(t){return t.add(r)}));this.setCoordinates(o)}else this.setCoordinates(i.add(r));return this._silence=!1,this._fireEvent("positionchange"),this},n._translateRotatePivot=function(t){if(!this._pivot||!t)return this;if(this.options.rotatePivot){var e=this.getCoordinates();if(!e)return this;t instanceof rs||(t=new rs(t));var n=t.sub(e);if(0===n.x&&0===n.y)return this;this._pivot._add(n),this.options.rotatePivot=this._pivot.toArray()}return this},n.flash=function(t,e,n,r){return pe.call(this,t,e,n,r)},n.copy=function(){var t=this.toJSON(),n=e.fromJSON(t);return n.options.visible=!0,n},n.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},n.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},n.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(U(t.geometry)||t.geometry){var n=this._exportGeoJSONGeometry();e.geometry=n}var r,i=this.getId();return U(i)||(e.id=i),(U(t.properties)||t.properties)&&(r=this._exportProperties()),e.properties=r,e},n.toJSON=function(t){t||(t={});var e=this._toJSON(t);return j(e,this._exportGraphicOptions(t)),e},n.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},n.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},n.rotate=function(t,e){if(!V(t))return console.error("angle:"+t+" is not number"),this;if(this._painter||(this._dirtyRotate=!0),"GeometryCollection"===this.type)return this.getGeometries().forEach((function(n){return n.rotate(t,e)})),this;e=e?new rs(e):this.getCenter(),this._angle=t,this._pivot=e;var n=this._getMeasurer(),r=this.getCoordinates();if(!Array.isArray(r)){if(e.x===r.x&&e.y===r.y||this.getShell)this.onPositionChanged();else{var i=n._rotate(r,e,t);this.setCoordinates(i)}return this.getShell&&(this.options.rotateAngle=t,this.options.rotatePivot=e.toArray()),this}return Kt(r,(function(r){return n._rotate(r,e,t)})),this.setCoordinates(r),this},n._rotatePrjCoordinates=function(t){if(!t||0===this._angle||!this._pivot)return t;var e=this._getProjection();if(!e)return t;var n,r,i=0,o=Array.isArray(t),s=o?t:[t],a=[];if(this.getRotateOffsetAngle){i=this.getRotateOffsetAngle();var l=s[s.length-1];n=l.x,r=l.y}else{var h=jr();Gr(s,h);var[u,c,f,d]=h;n=(u+f)/2,r=(c+d)/2}for(var p=0,g=s.length;p<g;p++){var m=s[p],{x:A,y:y}=m,v=A-n,x=y-r,_=Math.sqrt(v*v+x*x),b=(hh(n,r,A,y)-this._angle+i)/180*Math.PI,w=Math.cos(b)*_,T=Math.sin(b)*_,M=new rs(n+w,r+T);a.push(M)}for(var C=e.project(this._pivot),S=n-C.x,I=r-C.y,P=0,E=a.length;P<E;P++){var O=a[P];O.x-=S,O.y-=I}return o?a:a[0]},n.isRotated=function(){return!(!V(this._angle)||!this._pivot)},n._getConnectPoints=function(){return[this.getCenter()]},n._initOptions=function(t){var e=j({},t),n=e.symbol,r=e.properties,i=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),n&&this.setSymbol(n),r&&this.setProperties(r),U(i)||this.setId(i)},n._bindLayer=function(t){if(t!==this.getLayer()){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._bindInfoWindow(),this._bindMenu()}},n._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],n=0;n<t.length;n++)e.push(dr(this._checkAndCopySymbol(t[n])));return e}return t?dr(t=this._checkAndCopySymbol(t)):null},n._checkAndCopySymbol=function(t){var e={};for(var n in t)Me[n]&&q(t[n])?e[n]=+t[n]:e[n]=t[n];return e},n._getSymbol=function(){return this._symbol},n._setExternSymbol=function(t){return this._eventSymbolProperties=t,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},n._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},n._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},n._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},n._getInternalId=function(){return this._internalId},n._setInternalId=function(t){this._internalId=t},n._getMeasurer=function(){return this._getProjection()?this._getProjection():$l.getProjectionInstance(this.options.defaultProjection)},n._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n._verifyProjection=function(){var t=this._getProjection();this._projCode&&t&&this._projCode!==t.code&&this._clearProjection(),this._projCode=t?t.code:this._projCode},n._getExternalResources=function(){return fr(this._getInternalSymbol())},n._getPainter=function(){if(this._painter)return this._painter;var t=this.getLayer();if(!this._painter&&t)if(-1!==_e.indexOf(this.type)){if(t.constructor.getCollectionPainterClass){var e=t.constructor.getCollectionPainterClass();e&&(this._painter=new e(this))}}else if(t.constructor.getPainterClass){var n=t.constructor.getPainterClass();n&&(this._painter=new n(this))}return this._painter},n._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new Ul(this,!0):new Bl(this)),this._maskPainter},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},n._paint=function(t){if(this.symbolIsVisible()&&this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var e=this._getProjection();e&&(this._pcenter=e.project(this._coordinates),this._clearCache())}this._dirtyRotate&&V(this.options.rotateAngle)&&this.rotate(this.options.rotateAngle,this.options.rotatePivot),this._dirtyRotate=!1,this._painter.paint(t)}},n._clearCache=function(){delete this._extent,delete this._extent2d,this._clearAltitudeCache()},n._clearProjection=function(){delete this._extent,delete this._extent2d},n._repaint=function(){this._painter&&this._painter.repaint()},n.onHide=function(){this.closeMenu(),this.closeInfoWindow()},n.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},n.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},n.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var t={};this._eventSymbolProperties?(t.properties=JSON.parse(JSON.stringify(this._eventSymbolProperties)),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",t)},n._genSizeSymbol=function(){var t=this._getInternalSymbol();if(t)if(Array.isArray(t)){this._sizeSymbol=[];for(var e=!1,n=0;n<t.length;n++){var r=this._sizeSymbol[n]=this._getSizeSymbol(t[n]);!e&&r&&r._dynamic&&(e=!0)}this._sizeSymbol._dynamic=e}else this._sizeSymbol=this._getSizeSymbol(t);else delete this._sizeSymbol},n._getSizeSymbol=function(t){var e=ur({lineWidth:t.lineWidth,lineDx:t.lineDx,lineDy:t.lineDy},this);return(Un(t.lineWidth)||Un(t.lineDx)||Un(t.lineDy))&&(e._dynamic=!0),e},n._getCompiledSymbol=function(){return this._compiledSymbol||(this._compiledSymbol=ur(this._getInternalSymbol(),this)),this._compiledSymbol},n.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var n=!1;for(var r in t)if(t.hasOwnProperty(r)){var i=r.slice(0,5);if("arrow"===i||"smoot"===i){n=!0;break}}e?(this.setProperties(e),this._repaint()):n&&this._repaint()},n._setParent=function(t){t&&(this._parent=t)},n._getParent=function(){return this._parent},n._fireEvent=function(t,e){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e))},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},n._recordVisible=function(){var t=this.options.visible;U(t)&&(t=!0),this._savedVisible=t},n._recoveryVisible=function(){delete this._savedVisible},n._exportGraphicOptions=function(t){var e={};return(U(t.options)||t.options)&&(e.options=this.config()),e.options&&this.isEditing&&this.isEditing()&&(e.options.visible=this._savedVisible),(U(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(U(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=rs.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._exportProperties=function(){var t=null,e=this.getProperties();return U(e)||(t=W(e)?j({},e):e),t},n._hitTestTolerance=function(){return 0},n._getAltitude=function(){var t=this.getLayer();if(!t)return 0;var e=t.options,n=t.getAltitude?t.getAltitude():0,r=e.enableAltitude;if(!r&&t.isVectorLayer)return n;var i=ih(t),o=(this.properties||nh)[i];if(U(o)){var s=oh(this,n,r);return U(s)?n:s}return Array.isArray(o)?o.map((function(t){return t+n})):o+n},n.getAltitude=function(){var t=ih(this.getLayer()),e=(this.properties||nh)[t];if(!U(e))return e;var n=oh(this,0,!1);return U(n)?0:n},n.hasAltitude=function(){return this._genMinMaxAlt(),!!this._minAlt||!!this._maxAlt},n.setAltitude=function(t){if(!V(t))return this;var e=this.getLayer(),n=ih(e),r=this.properties||nh,i=r[n];if(!U(i))if(Array.isArray(i))for(var o=0,s=i.length;o<s;o++)i[o]=t;else r[n]=t;var a=this.getCoordinates?this.getCoordinates():null;if(!a)return this;if(sh(a,t),e){var l=e.getRenderer();l&&l.gl?this.setCoordinates(a):l&&this._repaint()}return this._clearAltitudeCache(),this.onPositionChanged(),this},n._genMinMaxAlt=function(){if(void 0===this._minAlt||void 0===this._maxAlt){var t=this._getAltitude(),[e,n]=$a(t);this._minAlt=e,this._maxAlt=n}},n.getMinAltitude=function(){return this._genMinMaxAlt(),this._minAlt},n.getMaxAltitude=function(){return this._genMinMaxAlt(),this._maxAlt},n._clearAltitudeCache=function(){return this._minAlt=void 0,this._maxAlt=void 0,this},n._getEditCenter=function(){var t=this.getCenter().copy();t.z=0;var e=this.getAltitude();if(V(e))return t.z=e,t;var n=0,r=0;return Array.isArray(e)&&(!function t(e){for(var i=0,o=e.length;i<o;i++)Array.isArray(e[i])?t(e[i]):(r++,n+=e[i])}(e),t.z=n/r),t},e}(Qo(zo(Ko(Ho))));function ih(t){var e="altitude";if(t){if(!t.isVectorLayer)return null;e=t.options.altitudeProperty}return e}function oh(t,e,n){var r=t.getCoordinates?t.getCoordinates():null;if(r){var i=[];if(ah(r,i),i.length)return lh(r,e,n)}return null}function sh(t,e){if(Array.isArray(t))for(var n=0,r=t.length;n<r;n++)sh(t[n],e);else t.z=e}function ah(t,e){if(!e.length)if(Array.isArray(t))for(var n=0,r=t.length;n<r;n++)ah(t[n],e);else V(t.z)&&e.push(t.z)}function lh(t,e,n){if(Array.isArray(t)){for(var r=[],i=0,o=t.length;i<o;i++)r.push(lh(t[i],e,n));return r}return V(t.z)?n?e+t.z:t.z:n?e:0}function hh(t,e,n,r){return t===n?r>e?-90:90:(n-=t,r=-(r-=e),Math.atan2(r,n)/Math.PI*180)}rh.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"});var uh={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!Pt.mobile,maskClip:!0},ch=function(t){function e(e,n){var r,i;return n&&(i=n.canvas,delete n.canvas),(r=t.call(this,n)||this)._canvas=i,r.setId(e),n&&(r.setZIndex(n.zIndex),n.mask&&r.setMask(rh.fromJSON(n.mask))),r.proxyOptions(),r}kt(e,t);var n=e.prototype;return n.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();U(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},n.getId=function(){return this._id},n.setId=function(t){var e=this._id;return U(t)||(t+=""),this._id=t,this.fire("idchange",{type:"idchange",target:this,old:e,new:t}),this},n.addTo=function(t){return t.addLayer(this),this},n.setZIndex=function(t){return this._zIndex=t,U(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this.fire("setzindex",{type:"setzindex",target:this,zIndex:t}),this},n.getZIndex=function(){return this._zIndex||0},n.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},n.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),U(e)?1/0:e):e},n.getOpacity=function(){return this.options.opacity},n.setOpacity=function(t){return this.config("opacity",t),this.fire("setopacity",{type:"setopacity",target:this,opacity:t}),this},n.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof va},n.getMap=function(){return this.map?this.map:null},n.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n+1),this},n.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n-1),this},n.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var n=this.getMap();e&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){t.fire("show")}))})):this.fire("show")}return this},n.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var n=this.getMap();e&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){t.fire("hide")}))})):this.fire("hide")}return this},n.isVisible=function(){if(V(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!U(this.options.maxZoom)&&this.options.maxZoom<e||!U(this.options.minZoom)&&this.options.minZoom>e)return!1}return U(this.options.visible)&&(this.options.visible=!0),this.options.visible},n.remove=function(){if(this.map){var t=this.map.getRenderer();this.map.removeLayer(this),t&&t.setToRedraw()}else this.fire("remove");return this},n.getMask=function(){return this._mask},n.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(t._bindLayer(this),"Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=t,t&&t.toGeoJSON)try{this._maskGeoJSON=t.toGeoJSON()}catch(n){delete this._maskGeoJSON,console.error(n)}if(this.options.mask=t.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},n.removeMask=function(){if(delete this._mask,delete this._maskGeoJSON,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},n.onLoad=function(){return!0},n.onLoadEnd=function(){},n.isLoaded=function(){return!!this._loaded},n.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new co),this._collisionIndex;var t=this.getMap();return t?t.getCollisionIndex():null},n.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},n.getRenderer=function(){return this._getRenderer()},n.onConfig=function(t){if(t&&Object.keys&&Object.keys(t).length>0&&U(t.animation)){if(this._optionsHook&&X(this._optionsHook)&&this._optionsHook(t),this._silentConfig)return;var e=this.getRenderer();if(e&&e.setToRedraw&&e.setToRedraw(),"attribution"in t){var n=this.getMap();n&&n.attributionControl&&n.attributionControl._update&&n.attributionControl._update()}}},n.onAdd=function(){},n.onRendererCreate=function(){},n.onCanvasCreate=function(){},n.onRemove=function(){},n._bindMap=function(t,e){t&&(this.map=t,U(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},n._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{type:"renderercreate",target:this,renderer:this._renderer})}},n._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},n._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()&&this.getMap()[t](e.getEvents(),e)},n._getRenderer=function(){return this._renderer},n._getLayerList=function(){if(!this.map)return[];var t=+!!this.map.getBaseLayer();return this.map.getLayers().slice(t)},n._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getMaskPainter();return t?t.get2DExtent():null},n.toJSON=function(t){return{type:"Layer",id:this.getId(),options:t||this.config()}},e.fromJSON=function(t){if(!t)return null;var n=t.type,r=e.getJSONClass(n);if(!r||!r.fromJSON)throw new Error("unsupported layer type:"+n);return r.fromJSON(t)},e}(Qo(zo(la(Ho))));ch.mergeOptions(uh);var fh=ch.prototype.fire;ch.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={type:null,target:null}),e.type=t,e.target=this,this.map._onLayerEvent(e)),fh.apply(this,arguments),["show","hide"].indexOf(t)>-1&&this.fire("visiblechange",Object.assign({},e,{visible:this.options.visible})),this};var dh=new rs(0,0),ph=new Vt(0,0),gh=["centerCross","fog","fogColor","debugSky"],mh={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:function(){return!z}(),zoomAnimationDuration:330,panAnimation:function(){return!z}(),panAnimationDuration:600,rotateAnimation:function(){return!z}(),zoomable:!0,enableInfoWindow:!0,hitDetect:!Pt.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,limitExtentOnMaxExtent:!1,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas",cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0,preventWheelScroll:!0,preventTouch:!0,supportPluginEvent:!0,switchDragButton:!1,mousemoveThrottleTime:48,maxFPS:0,debug:!1,cameraFarUndergroundInMeter:2e3},Ah=function(t){function e(n,r){var i;if(!r)throw new Error("Invalid options when creating map.");if(!r.center)throw new Error("Invalid center when creating map.");var o=j({},r),s=o.zoom;delete o.zoom;var a=new rs(o.center);delete o.center;var l=o.baseLayer;delete o.baseLayer;var h=o.layers;return delete o.layers,(i=t.call(this,o)||this).VERSION=e.VERSION,Object.defineProperty(i,"id",{value:Xt(),writable:!1}),i._loaded=!1,i._initContainer(n),i._panels={},i._baseLayer=null,i._layers=[],i._zoomLevel=s,i._center=a,i._centerZ=a.z,i.setSpatialReference(o.spatialReference||o.view),i._mapViewPoint=new Vt(0,0),i._initRenderer(),i._updateMapSize(i._getContainerDomSize()),l&&i.setBaseLayer(l),h&&i.addLayer(h),i.setMaxExtent(o.maxExtent),i._Load(),i.proxyOptions(),i.isMap=!0,i}kt(e,t),e.addOnLoadHook=function(t,...e){var n="function"==typeof t?t:function(){this[t].call(this,...e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(n),this};var n=e.prototype;return n.isLoaded=function(){return!!this._loaded},n.getContainer=function(){return this._containerDOM},n.getSpatialReference=function(){return this._spatialReference},n.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&$l.equals(e,t)||this._updateSpatialReference(t,e),this},n._updateSpatialReference=function(t,e){q(t)&&(t=$l.getPreset(t)),t=j({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new $l(t);var n=this._spatialReference.getProjection();return this.options.spatialReference&&X(this.options.spatialReference.projection)&&(this.options.spatialReference.projection=n.code),this._resetMapStatus(),ea.is(n.code)&&(this._originLng=n.centralMeridian,this._altitudeOriginDirty=!0),this._fireEvent("spatialreferencechange",{old:e,new:j({},this.options.spatialReference)}),this},n.onConfig=function(t){var e=t.spatialReference||t.view;U(e)||this._updateSpatialReference(e,null);for(var n=!1,r=0,i=gh.length;r<i;r++){if(!U(t[gh[r]])){n=!0;break}}if(!n)return this;var o=this.getRenderer();return o&&o.setToRedraw(),this},n.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},n.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},n.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},n.resetCursor=function(){return this.setCursor(null)},n.getCenter=function(){if(!this._loaded||!this._prjCenter)return this._center;var t=this.getProjection().unproject(this._prjCenter);return t.x=Math.round(1e8*t.x)/1e8,t.y=Math.round(1e8*t.y)/1e8,t.z=this._centerZ,this.centerAltitude&&(t.z=this.centerAltitude),t},n.setCenter=function(t,e){if(!t)return this;t=new rs(t),e&&(t=this._getCenterByPadding(t,this.getZoom(),e));var n=this.getProjection().project(t);return this._verifyExtent(n)||this.options.limitExtentOnMaxExtent?this._loaded?(this._centerZ=t.z,this.onMoveStart(),this._setPrjCenter(n),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},n.getSize=function(){return U(this.width)||U(this.height)?this._getContainerDomSize():new Ie(this.width,this.height)},n.getContainerExtent=function(){var t=this.height,e=this.getPitch(),n=this.options.maxVisualPitch;return n&&e>n&&(t=this._getVisualHeight(n)),new vs(0,this.height-t,this.width,this.height)},n._getVisualHeight=function(t){t=t||.01;var e=(90-this.getPitch())*Math.PI/180,n=this.getFov()*Math.PI/180;t*=Math.PI/180;var r=this.cameraCenterDistance/this.getGLScale(),i=Math.tan(n/2),o=r*i/(1/Math.tan(t)-i)/Math.sin(t),s=r*(Math.sin(e)*o/(r+Math.cos(e)*o));return this.height/2+s},n.getExtent=function(){return this.pointToExtent(this.get2DExtent())},n.getProjExtent=function(){var t=this.get2DExtent();return new As(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},n.getPrjExtent=function(){return this.getProjExtent()},n.getMaxExtent=function(){return this.options.maxExtent?new As(this.options.maxExtent,this.getProjection()):null},n.setMaxExtent=function(t){if(t){var e=new As(t,this.getProjection());this.options.maxExtent=e;var n=this.getProjection();this._prjMaxExtent=e.convertTo((function(t){return n.project(t)})),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=n.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},n.getZoom=function(){return this._zoomLevel},n.getZoomForScale=function(t,e,n){var r=this.getZoom();if(U(e)&&(e=r),1===t&&e===r)return r;var i=this._getResolution(e)/t,o=this.getZoomFromRes(i);if(n)return o;var s=1e-6;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-s):Math.floor(o+s)},n.getZoomFromRes=function(t){var e=this._getResolutions(),n=this._getResolution(this.getMinZoom()),r=this._getResolution(this.getMaxZoom());if(n<=r){if(t<=n)return this.getMinZoom();if(t>=r)return this.getMaxZoom()}else{if(t>=n)return this.getMinZoom();if(t<=r)return this.getMaxZoom()}for(var i=e.length,o=0;o<i-1;o++)if(e[o]){var s=e[o+1]-e[o],a=t-e[o];if(te(s)===te(a)&&Math.abs(s)>=Math.abs(a))return o+a/s}return i-1},n.setZoom=function(t,e={animation:!0}){return isNaN(t)||U(t)||(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t)),this},n.getMaxZoom=function(){return U(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},n.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},n.getMinZoom=function(){return U(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},n.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},n.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},n.getGLRes=function(){if(this._glRes)return this._glRes;var t=this.getSpatialReference().getFullExtent();return this._glRes=(t.right-t.left)/Math.pow(2,19),this._glRes},n.getGLScale=function(t){return U(t)&&(t=this.getZoom()),this._getResolution(t)/this.getGLRes()},n.zoomIn=function(){return this.setZoom(this.getZoom()+1)},n.zoomOut=function(){return this.setZoom(this.getZoom()-1)},n.isZooming=function(){return!!this._zooming},n.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},n.setCenterAndZoom=function(t,e){return U(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},n._getPaddingSize=function(t={}){return t.paddingLeft||t.paddingTop||t.paddingRight||t.paddingBottom?{width:(t.paddingLeft||0)+(t.paddingRight||0),height:(t.paddingTop||0)+(t.paddingBottom||0)}:null},n.getFitZoom=function(t,e,n){var r=this;if(!(t&&t instanceof As))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var i=this.getSize(),o=this._getPaddingSize(n);if(o){var s={width:i.width-(o.width||0),height:i.height-(o.height||0)};i=new Ie(s.width,s.height)}var a=t.convertTo((function(t){return r.coordToPoint(t)})),l=a.getWidth(),h=a.getHeight(),u=i.width/l,c=i.height/h,f=this.getSpatialReference().getZoomDirection()<0?Math.max(u,c):Math.min(u,c);return this.getZoomForScale(f,null,e)},n.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},n._validateView=function(t){if(t&&W(t)){if(V(t.bearing)){var e=t.bearing;(e%=360)>180&&(e=-180+Math.abs(e-180)),e<-180&&(e=180-Math.abs(e+180)),t.bearing=e}V(t.pitch)&&(t.pitch=Math.max(0,t.pitch),t.pitch=Math.min(this.options.maxPitch,t.pitch));var n=this.getMaxZoom();V(t.zoom)&&(t.zoom=Math.max(0,t.zoom),t.zoom=Math.min(n,t.zoom))}},n.setView=function(t){return t?(this._validateView(t),t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.bearing||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},n.getResolution=function(t){return this._getResolution(t)},n.getScale=function(t){var e=U(t)?this.getZoom():t,n=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/n},n._getCenterByPadding=function(t,e,n){var r=this.coordinateToPoint(t,e),{paddingLeft:i=0,paddingRight:o=0,paddingTop:s=0,paddingBottom:a=0}=n||{},l=0,h=0;(i||o)&&(l=(o-i)/2),(s||a)&&(h=(s-a)/2);var u=new Vt({x:r.x+l,y:r.y+h});return this.pointToCoordinate(u,e)},n.fitExtent=function(t,e,n,r){if(n=n||{},!t)return this;t=new As(t,this.getProjection());var i=this.getFitZoom(t,n.isFraction||!1,n)+(e||0),o=t.getCenter();return this._getPaddingSize(n)&&(o=this._getCenterByPadding(o,i,n)),void 0===n.animation||n.animation?this._animateTo({center:o,zoom:i},{duration:n.duration||this.options.zoomAnimationDuration,easing:n.easing||"out"},r):this.setCenterAndZoom(o,i)},n.getBaseLayer=function(){return this._baseLayer},n.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},n.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},n.getLayers=function(t){return this._getLayers((function(e){return!(e===this._baseLayer||e.getId().indexOf(xe)>=0)&&(!t||t(e))}))},n.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var n=this.getBaseLayer();return n&&n.getId()===t?n:null},n.addLayer=function(t,...e){if(!t)return this;Array.isArray(t)||(t=[t]),e&&e.length&&(t=t.concat(e)),this._layerCache||(this._layerCache={});for(var n=this._layers,r=0,i=t.length;r<i;r++){var o=t[r],s=o.getId();if(U(s))throw new Error("Invalid id for the layer: "+s);if(o.getMap()!==this){if(this._layerCache[s])throw new Error("Duplicate layer id in the map: "+s);this._layerCache[s]=o,o._bindMap(this),n.push(o),this._loaded&&o.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},n.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];if(i instanceof ch||(i=this.getLayer(i)),i){var o=i.getMap();if(o&&o===this){e.push(i),this._removeLayer(i,this._layers),this._loaded&&i._doRemove();var s=i.getId();this._layerCache&&delete this._layerCache[s]}}}if(e.length>0){var a=this.getRenderer();a&&a.setLayerCanvasUpdated(),this.once("frameend",(function(){e.forEach((function(t){t.fire("remove")}))}))}return this._fireEvent("removelayer",{layers:t}),this},n.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],n=Number.MAX_VALUE,r=0,i=t.length;r<i;r++){var o=t[r];if(q(t[r])&&(o=this.getLayer(o)),!(o instanceof ch&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<n&&(n=o.getZIndex()),e.push(o)}for(var s=0,a=e.length;s<a;s++)e[s].setZIndex(n+s);return this},n.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var n=t.save,r=this._getRenderer();if(r&&r.toDataURL){var i=t.fileName;i||(i="export");var o=r.toDataURL(e,t.quality||.92);if(n&&o){var s;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var a=function(t,e){for(var n=atob(t),r=new ArrayBuffer(n.length),i=new Uint8Array(r),o=0;o<n.length;o++)i[o]=255&n.charCodeAt(o);return new Blob([r],{type:e})}(o.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),e);s=URL.createObjectURL(a)}else s=o;var l=document.createElement("a");l.download=i,l.href=s,document.body.appendChild(l),l.click(),document.body.removeChild(l)}return o}return null},n.coordToPoint=function(t,e,n){return this.coordinateToPoint(t,e,n)},n.coordToPointAtRes=function(t,e,n){return this.coordinateToPointAtRes(t,e,n)},n.pointToCoord=function(t,e,n){return this.pointToCoordinate(t,e,n)},n.pointAtResToCoord=function(t,e,n){return this.pointAtResToCoordinate(t,e,n)},n.coordToViewPoint=function(t,e,n){return this.coordinateToViewPoint(t,e,n)},n.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},n.coordToContainerPoint=function(t,e,n){return this.coordinateToContainerPoint(t,e,n)},n.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},n.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},n.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},n.checkSize=function(t){var e=H()-this._initTime<1500&&0===this.width||0===this.height,n=this._getContainerDomSize(),r=this.height,i=this.width;if(!t&&n.width===i&&n.height===r)return this;an(this._containerDOM);var o=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(n);else{var s=this._getVisualHeight(this.getPitch()),a=new Vt(0,this.height-s),l=this._containerPointToPrj(a);this._updateMapSize(n);var h=this._getVisualHeight(this.getPitch()),u=new Vt(0,this.height-h);this._setPrjCoordAtContainerPoint(l,u),this._mapViewCoord=this._getPrjCenter()}var c=0===n.width||0===n.height||0===i||0===r;return(e||c)&&(this._eventSilence=!0,this.setCenter(o),delete this._eventSilence),this._fireEvent("resize"),this},n.locate=function(t,e,n){return this.getProjection()._locate(new rs(t),e,n)},n.getMainPanel=function(){var t=this._getRenderer();return t?t.getMainPanel():null},n.getPanels=function(){return this._panels},n.remove=function(){var t=this;if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var e=this.getLayers(),n=0;n<e.length;n++)e[n].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(t){return"maptalks-wrapper"===t.className})).forEach((function(e){return t._containerDOM.removeChild(e)})),delete this._panels,delete this._containerDOM,delete this._renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},n.isRemoved=function(){return!this._containerDOM},n.isMoving=function(){return!!this._moving},n.onMoveStart=function(t){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var e=this._getPrjCenter();this._originCenter&&!this._verifyExtent(e)||(this._originCenter=e),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},n.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving")),this._limitMaxExtent()},n.onMoveEnd=function(t){if(this._moving=!1,this._suppressRecenter||this._recenterOnTerrain(),this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this._getPrjCenter())&&this._originCenter&&!this.options.limitExtentOnMaxExtent){var e=this._originCenter;this._panTo(e)}this._limitMaxExtent()},n.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},n.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},n.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},n.isDragRotating=function(){return!!this._dragRotating},n.isOffscreen=function(t,e=0){var{width:n,height:r}=this,i=n+e,o=r+e,{xmin:s,ymin:a,xmax:l,ymax:h}=t;return Array.isArray(t)&&([s,a,l,h]=t),l<e||s>=i||h<e||a>o},n.getRenderer=function(){return this._getRenderer()},n.getDevicePixelRatio=function(){return this.options.devicePixelRatio||Pt.devicePixelRatio||1},n.setDevicePixelRatio=function(t){return V(t)&&t>0&&t!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=t,this.checkSize(!0)),this},n._initContainer=function(t){if(q(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,z&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},n._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},n._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},n._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},n._removeLayer=function(t,e){if(t&&e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}},n._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++){var n=this._layers[t];n._order=t,n.sortLayersByZIndex&&n.sortLayersByZIndex()}this._layers.sort((function(t,e){var n=t.getZIndex()-e.getZIndex();return 0===n?t._order-e._order:n}))}},n._fireEvent=function(t,e){if(!this._eventSilence){"_"!==t[0]&&this.fire("_"+t,e),this.fire(t,e)}},n._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=H()},n._initRenderer=function(){var t=this.options.renderer,n=e.getRendererClass(t);this._renderer=new n(this),this._renderer.load()},n._getRenderer=function(){return this._renderer},n._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(t){t&&t.load()}),this.getLayers())},n._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,n=[],r=0;r<e.length;r++)t&&!t.call(this,e[r])||n.push(e[r]);return n},n._eachLayer=function(t,...e){if(!(arguments.length<2)){e&&!Array.isArray(e)&&(e=[e]);for(var n=[],r=0,i=e.length;r<i;r++)n=n.concat(e[r]);for(var o=0,s=n.length;o<s;o++)t.call(t,n[o])}},n._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},n._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),n=this._spatialReference.getMaxZoom(),r=this._spatialReference.getMinZoom();(U(t)||-1===t||t>n)&&this.setMaxZoom(n),(U(e)||-1===e||e<r)&&this.setMinZoom(r),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(U(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter,delete this._glRes;var i=this.getProjection();this._prjCenter=i.project(this._center),this._prjCenter.z=this._center.z,this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},n.setContainerDomRect=function(t){this._containerDomContentRect=t},n._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,n=this._containerDOM;if(this._containerDomContentRect)return t=this._containerDomContentRect.width,e=this._containerDomContentRect.height,new Ie(t,e);var r=n;if(U(r.width)||U(r.height)){if(U(n.clientWidth)||U(n.clientHeight))throw new Error("can not get size of container");t=parseInt(n.clientWidth+"",0),e=parseInt(n.clientHeight+"",0)}else{t=r.width,e=r.height;var i=this.getDevicePixelRatio();1!==i&&n.layer&&(t/=i,e/=i)}return new Ie(t,e)},n._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},n._getPrjCenter=function(){return this._prjCenter},n._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},n._setPrjCoordAtContainerPoint=function(t,e){if(!this.centerAltitude&&e.x===this.width/2&&e.y===this.height/2)return this;var n=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),r=this._pointToPrj(this._prjToPoint(t)._sub(n));return this._setPrjCenter(r),this},n._setPrjCoordAtOffsetToCenter=function(t,e){var n=this._pointToPrj(this._prjToPoint(t)._sub(e));return this._setPrjCenter(n),this},n._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},n._limitMaxExtent=function(){var t=this;if(this._limitMaxExtenting||!this.options.limitExtentOnMaxExtent)return this;var e=this._prjMaxExtent,n=this.getMaxExtent();if(!e||!n)return this;var r=e.toArray().map((function(e){return t.prjToContainerPoint(e)})),i=jr();Gr(r,i);var{width:o,height:s}=this.getSize(),a=[0,0,o,s];if(Zr(a,i))return this;if(Zr(i,a))return this;var l=0,h=0,u=0,c=0,f=0,d=0,p=Math.abs,[g,m,A,y]=i;if(g>0&&A>o&&(l=u=p(g)),g<0&&A<o&&(l=u=-p(g)),g<0&&A<o&&(l=c=-p(o-A)),g>0&&A>o&&(l=c=p(o-A)),m>0&&y>s&&(h=f=p(m)),m<0&&y<s&&(h=f=-p(m)),m<0&&y<s&&(h=d=-p(s-y)),m>0&&y>s&&(h=d=p(s-y)),0!==u&&0!==c&&(l=u,p(c)<p(u)&&(l=c)),0!==f&&0!==d&&(h=f,p(d)<p(f)&&(h=d)),0!==l||0!==h){var v=new Vt(o/2+l,s/2+h),x=this.containerPointToCoord(v);this._limitMaxExtenting=!0,this.setCenter(x),this._limitMaxExtenting=!1}return this},n._offsetCenterByPixel=function(t){var e=ph.set(this.width/2-t.x,this.height/2-t.y),n=this._containerPointToPrj(e,dh),r=ph.set(this.width/2,this.height/2);this._setPrjCoordAtContainerPoint(n,r)},n.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this._mapViewPoint):this._mapViewPoint},n.getViewPoint=function(){var t=this.getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},n._resetMapViewPoint=function(){this._mapViewPoint=new Vt(0,0),this._mapViewCoord=this._getPrjCenter()},n._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?(U(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},n._getResolutions=function(){return this._spatialReference.getResolutions()},n._prjToPoint=function(t,e,n){e=U(e)?this.getZoom():e;var r=this._getResolution(e);return this._prjToPointAtRes(t,r,n)},n._prjToPointAtRes=function(t,e,n){return this._spatialReference.getTransformation().transform(t,e,n)},n._prjsToPointsAtRes=function(t,e,n=[]){for(var r=this._spatialReference.getTransformation(),i=[],o=0,s=t.length;o<s;o++){var a=r.transform(t[o],e,n[o]);i.push(a)}return i},n._pointToPrj=function(t,e,n){e=U(e)?this.getZoom():e;var r=this._getResolution(e);return this._pointToPrjAtRes(t,r,n)},n._pointToPrjAtRes=function(t,e,n){return this._spatialReference.getTransformation().untransform(t,e,n)},n._pointToPoint=function(t,e,n){return U(e)?(n?(n.x=t.x,n.y=t.y):n=t.copy(),n):this._pointAtResToPoint(t,this._getResolution(e),n)},n._pointAtResToPoint=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(e/this._getResolution())},n._pointToPointAtRes=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(this._getResolution()/e)},n._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},n._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var n=0,r=t._onLoadHooks.length;n<r;n++)t._onLoadHooks[n].call(this)},n._fixPrjOnWorldWide=function(t){var e=this.getProjection();if(e&&e.fullExtent&&t){var{left:n,bottom:r,top:i,right:o}=e.fullExtent||{};V(n)&&(t.x=Math.max(n,t.x)),V(o)&&(t.x=Math.min(o,t.x)),V(r)&&(t.y=Math.max(r,t.y)),V(i)&&(t.y=Math.min(i,t.y))}return this},n.toJSON=function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom(),e.options.bearing=this.getBearing(),e.options.pitch=this.getPitch();var n=this.getBaseLayer();(U(t.baseLayer)||t.baseLayer)&&n&&(e.baseLayer=n.toJSON(t.baseLayer));var r={};t.clipExtent&&(!0===t.clipExtent?r.clipExtent=this.getExtent():r.clipExtent=t.clipExtent);var i=[];if(U(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var o=this.getLayers(),s=0,a=o.length;s<a;s++)if(o[s].toJSON){var l=j({},W(t.layers)?t.layers:{},r);i.push(o[s].toJSON(l))}e.layers=i}else if(ie(t.layers)){for(var h=t.layers,u=0;u<h.length;u++){var c=h[u],f=this.getLayer(c.id);if(f.toJSON){var d=j({},c.options,r);i.push(f.toJSON(d))}}e.layers=i}else e.layers=[];return e},e.fromJSON=function(t,n,r){if(!t||!n)return null;r||(r={});var i=new e(t,n.options);if(U(r.baseLayer)||r.baseLayer){var o=ch.fromJSON(n.baseLayer);o&&i.setBaseLayer(o)}if(U(r.layers)||r.layers){for(var s=[],a=n.layers,l=0;l<a.length;l++){var h=ch.fromJSON(a[l]);s.push(h)}i.addLayer(s)}return i},e}(Ko(zo(la(Ho))));Ah.mergeOptions(mh);var yh=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},n.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},n._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var n=e.getZoom(),r=t.domEvent.shiftKey?Math.ceil(n)-1:Math.floor(n)+1;e._zoomAnimation(r,t.containerPoint)}},e}(Bo);Ah.mergeOptions({doubleClickZoom:!0}),Ah.addOnLoadHook("addHandler","doubleClickZoom",yh);var vh=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target;if(t){var e=t.getPanels().mapWrapper||t.getContainer();this._dragHandler=new ns(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},n.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},n._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},n._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},n._onMouseDown=function(t){delete this.startDragTime,delete this._mode;var e=this.target.options.switchDragButton,n=e?0:2,r="touchstart"===t.domEvent.type;e&&r||t.domEvent.button===n||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),rn(t.domEvent)},n._onDragStart=function(t){this.startDragTime=H(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},n._onDragging=function(t){"move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t)},n._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},n._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},n._moveStart=function(t){delete this.startContainerPoint,this._start(t);var e=this.target;e.onMoveStart(t);var n=ln(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e.queryPrjCoordAtContainerPoint(n),e._isContainerPointOutOfMap(n)&&void 0===this.startPrjCoord.z&&(this.startContainerPoint=n)},n._moving=function(t){if(this.startDragTime){var e=this.target,n=ln(e._getActualEvent(t.domEvent),e.getContainer());if(this.startContainerPoint){var r=n._sub(this.startContainerPoint);n.set(e.width/2+r.x,e.height/2+r.y)}var i=e._containerPointToPoint(n,void 0,void 0,this.startPrjCoord.z)._sub(e._prjToPoint(e._getPrjCenter()));e._setPrjCoordAtOffsetToCenter(this.startPrjCoord,i),e.onMoving(t)}},n._moveEnd=function(t){if(this.startDragTime){var e="touchend"===t.domEvent.type,n=this.target,r=H()-this.startDragTime,i=t.mousePos.x,o=t.mousePos.y,s=i-this.startX,a=o-this.startY,l=n._getPrjCenter(),h=l.sub(this._startPrjCenter);if(this._clear(),n.options.panAnimation&&!t.interupted&&n._verifyExtent(n._getPrjCenter())&&r<280&&Math.abs(a)+Math.abs(s)>5){r*=5;var u=e?5:2.8,c=l.add(h._multi(u));n._panTo(c,{duration:e?3*r:2*r,easing:n.options.dragPanEasing||"outExpo"})}else n.onMoveEnd(t)}},n._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},n._rotating=function(t){var e=this.target,n=t.mousePos.x,r=t.mousePos.y,i=e.getPitch(),o=e.getBearing(),s=Math.abs(n-this.preX),a=Math.abs(r-this.preY);if(this._rotateMode||(e.options.dragRotatePitch?this._rotateMode="rotate_pitch":this._rotateMode=s>a?"rotate":s<a?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===i&&a<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var l=.15,h=0;h=e.options.dragPitch||s>a?-.15*(this.preX-n):n>e.width/2?l*(this.preY-r):-.15*(this.preY-r);var u=e.getBearing()+h;this._db=this._db||0,this._db+=h,e._setBearing(u)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e._setPitch(e.getPitch()+.15*(this.preY-r)),this.preX=n,this.preY=r,e.getBearing()===o&&e.getPitch()===i||e.onDragRotating(t)}},n._rotateEnd=function(t){var e=this.target,n=e.getBearing();this._clear();var r=H()-this.startDragTime;if(e.onDragRotateEnd(t),e.options.rotateAnimation&&Math.abs(n-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&r<400){var i=e.getBearing();e._animateTo({bearing:i+this._db/1.5},{easing:"outQuint",duration:1600})}},n._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(Bo);Ah.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),Ah.addOnLoadHook("addHandler","draggable",vh);var xh="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend mouseout",_h={mousemove:["mousemove","mouseover","mouseout","mouseenter"],touchend:["touchend","click"]},bh=function(t){return t&&t.getLayer&&t.on&&t.fire},wh=function(t,e,n){if(t._onEvent)return t._onEvent(e,n);var r=t.getLayer();return r&&r.fireGeoEvent?r.fireGeoEvent(t,e,n):null},Th=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target,e=t.getPanels().allLayers||t.getContainer();gn(e,xh,this._identifyGeometryEvents,this)},n.removeHooks=function(){var t=this.target,e=t.getPanels().allLayers||t.getContainer();mn(e,xh,this._identifyGeometryEvents)},n._identifyGeometryEvents=function(t,e){var n=this.target;if(!n.isInteracting()&&!n._ignoreEvent(t)){var r=null,i=e||t.type;if(An(i)&&!B.isTest&&yn(this,n.options.mousemoveThrottleTime))on(t);else{var o="mousedown"===i||"touchstart"===i&&t.touches&&1===t.touches.length;if(o)this._mouseDownTime=H();else if(("click"===i||"touchend"===i)&&this._mouseDownTime){var s=this._mouseDownTime;if(delete this._mouseDownTime,H()-s>300){if("click"===i)return}else"touchend"===i&&(r="click")}var a=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(a){var l=ln(a,n.getContainer());"touchstart"===i&&n.options.preventTouch&&rn(t);for(var h=null,u=this.target.getRenderer().getTopElements(),c=o&&2!==t.button,f=0;f<u.length;f++)if(u[f].hitTest(l)){var d=u[f].options.cursor;if(d&&(h=d),c||u[f].events&&u[f].events.indexOf(i)>=0){var p={target:n,type:i,domEvent:t,containerPoint:l};if(c)return n._setPriorityCursor(h),void u[f].mousedown(p);u[f].onEvent(p)}}var g=n._getLayers((function(t){return!(!t.identify||!t.options.geometryEvents)}));if(g.length){var m=_h[i]||[i],A={includeInternals:!0,filter:function(e){if(e instanceof rh){var n=e._getEventTypeToFire(t);return"mousemove"===i?(!h&&e.options.cursor&&(h=e.options.cursor),!0):!(!e.listens(n)&&!e.listens(r))}return!!bh(e)},count:1,onlyVisible:n.options.onlyVisibleGeometryEvents,containerPoint:l,layers:g,eventTypes:m,domEvent:t},y=function(e){var o=this,s=!0,a=function(){return o._prevOverGeos&&o._prevOverGeos.geos||[]},l=function(e=[],n=[]){if(e&&e.length>0)for(var r=e.length-1;r>=0;r--){var i=e[r];bh(i)&&(-1===n.indexOf(i)&&(s=wh(i,t,"mouseout")))}};if("mouseout"===i){var u=a();this._prevOverGeos={geos:[],geomap:{}},l(u,[])}else if("mousemove"===i){var c={};if(e.length>0)for(var f=e.length-1;f>=0;f--){var d=e[f];if(bh(d)){var p=(A=d)._getInternalId?A._getInternalId():A.getId?A.getId():null;c[p]=d,wh(d,t),this._prevOverGeos&&this._prevOverGeos.geomap[p]||wh(d,t,"mouseenter"),s=wh(d,t,"mouseover")}}n._setPriorityCursor(h);var g=a();this._prevOverGeos={geos:e,geomap:c},l(g,e)}else{if(!e||!e.length)return;for(var m=e.length-1;m>=0;m--)if(bh(e[m])){s=wh(e[m],t),r&&wh(e[m],t,r);break}}var A;!1===s&&on(t)}.bind(this);An(i)?this._queryIdentifyTimeout=n.getRenderer().callInNextFrame((function(){n.isInteracting()||n.identifyAtPoint(A,y)})):n.identifyAtPoint(A,y)}}}}},e}(Bo);Ah.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),Ah.addOnLoadHook("addHandler","geometryEvents",Th);var Mh=4.000244140625,Ch=1/450,Sh=function(t){function e(e){var n;return(n=t.call(this,e)||this)._thisScrollZoom=n._scrollZoom.bind(n),n._thisCheckIfEndZoom=n._checkIfEndZoom.bind(n),n._wheelZoomRate=Ch,n._defaultZoomRate=.01,n._delta=0,n}kt(e,t);var n=e.prototype;return n.addHooks=function(){tn(this.target._containerDOM,"wheel",this._onWheelScroll,this)},n.removeHooks=function(){en(this.target._containerDOM,"wheel",this._onWheelScroll)},n._currentZoomCanScroll=function(t){if(V(t)){var e=this.target,n=e.getZoom(),r=e.getMinZoom(),i=e.getMaxZoom();if(n===r&&t>0)return!1;if(n===i&&t<0)return!1}return!0},n._onWheelScroll=function(t){var e=this.target;if(e.options.preventWheelScroll&&(rn(t),on(t)),e._ignoreEvent(t)||!e.options.zoomable)return!1;var n=e.getContainer(),r=e._checkZoomOrigin(ln(t,n));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,r)):this._interval(t,r)},n._seamless=function(t,e){var n=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(n%Mh!=0&&(this._ensureTrackpad||(Math.abs(n)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(n*=14)),t.shiftKey&&n&&(n/=4),this._lastWheelEvent=t,U(this._delta)&&(this._delta=0),this._delta-=n,this._currentZoomCanScroll(n)){if(!this._zooming&&this._delta){var r=this.target;this._zoomOrigin=e,r.onZoomStart(null,e)}this._start()}},n._start=function(){if(this._delta){this._zooming=!0;var t=this.target;this._active||(t.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0)}},n._scrollZoom=function(){if(this._active=!1,this._delta){var t=Math.abs(this._delta)>Mh?this._wheelZoomRate:this._defaultZoomRate,e=2/(1+Math.exp(-Math.abs(this._delta*t)));this._delta<0&&0!==e&&(e=1/e);var n=this.target,r=n.getZoom(),i=n.getZoomForScale(e,r,!0);this._delta=0,n.onZooming(i,this._zoomOrigin),this._scrollTime=performance.now(),n.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._checkIfEndZoom=function(){if(this._zooming){var t=this.target;performance.now()-this._scrollTime>210?(this._zooming=!1,t.onZoomEnd(t.getZoom(),this._zoomOrigin)):t.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._interval=function(t,e){var n=this,r=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var i=(t.deltaY?-1*t.deltaY:t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(i*=-1);var o=r.getZoom(),s=o+i;if((s=r._checkZoom(i>0?Math.ceil(s):Math.floor(s)))===o)return!1;this._zooming=!0,this._delta||(r.onZoomStart(null,e),this._origin=e,this._delta=i,this._startZoom=r.getZoom());return r._animateTo({zoom:s-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(e){"finished"===e.state.playState?n._requesting<1||Math.abs(s-n._startZoom)>2||s===r.getMaxZoom()||s===r.getMinZoom()?(r._animateTo({zoom:s,around:n._origin},{continueOnViewChanged:!0,duration:100},(function(t){"running"!==t.state.playState&&(delete n._zooming,delete n._requesting)})),delete n._startZoom,delete n._origin,delete n._delta,n._requesting=0):U(n._requesting)||(delete n._zooming,n._onWheelScroll(t)):"running"!==e.state.playState&&(delete n._zooming,delete n._requesting)})),!1},e}(Bo);Ah.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),Ah.addOnLoadHook("addHandler","scrollWheelZoom",Sh);var Ih=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){tn(this.target.getContainer(),"touchstart",this._onTouchStart,this)},n.removeHooks=function(){en(this.target.getContainer(),"touchstart",this._onTouchStart)},n._onTouchStart=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),r=ln(t.touches[0],n),i=ln(t.touches[1],n);this.preY=r.y,this._startP1=r,this._startP2=i,this._startDist=r.distanceTo(i),this._startVector=r.sub(i),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),mn(document,"touchmove",this._onTouchMove),mn(document,"touchend",this._onTouchEnd),tn(document,"touchmove",this._onTouchMove,this),tn(document,"touchend",this._onTouchEnd,this),e.options.preventTouch&&rn(t),e._fireEvent("touchactstart")}},n._onTouchMove=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),r=ln(t.touches[0],n),i=ln(t.touches[1],n),o=r.sub(this._startP1),s=i.sub(this._startP2),a=r.sub(i),l=r.distanceTo(i)/this._startDist,h=180*a.angleWith(this._startVector)/Math.PI,u=.4*((this.preY||r.y)-r.y);this.preY=r.y;var c={domEvent:t,mousePos:[r,i]};if(this.mode||(e.options.touchRotate&&Math.abs(h)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&o.y*s.y>0&&Math.abs(o.y)>10&&Math.abs(s.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-l)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(c)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=l;var f=e._getResolution(this._startZoom)/l,d=e.getZoomFromRes(f);e.onZooming(d,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e._setBearing(this._startBearing+h),e.onDragRotating(c)):"pitch"===this.mode&&(e._setPitch(e.getPitch()+u),e.onDragRotating(c)),e._fireEvent("touchactinging")}},n._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var n=e.getSize();this._Origin=new Vt(n.width/2,n.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},n._onTouchEnd=function(t){delete this.preY;var e=this.target;if(mn(document,"touchmove",this._onTouchMove),mn(document,"touchend",this._onTouchEnd),"zoom"===this.mode||"rotate_zoom"===this.mode){var n=this._scale,r=e._getResolution(this._startZoom)/n,i=e.getZoomFromRes(r);e.onZoomEnd(i,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(Bo);Ah.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),Ah.addOnLoadHook("addHandler","touchGesture",Ih);var Ph="__anim_player",Eh={outExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},outQuint:function(t){return 1-Math.pow(1-t,5)},in:function(t){return Math.pow(t,2)},out:function(t){return 1-Eh.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?Eh.inAndOut(2*t):1-Eh.inAndOut(2*(t-.5))}},Oh=Rt((function(t,e){this.state=t,this.styles=e}),[{key:"playState",get:function(){return this.state.playState}},{key:"symbol",get:function(){return this.styles.symbol}}]),Rh=function(){function t(t,e,n,r){this._animation=t,this.options=e,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1,this.target=r}var e=t.prototype;return e._prepare=function(){var t=this.options,e=t.speed||t.duration;q(e)&&((e=kh.speed[e])||(e=+e)),e||(e=kh.speed.normal),this.duration=e,this._framer=t.framer||kh._requestAnimFrame.bind(kh)},e.play=function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[Ph])return this;this.target&&(this.target[Ph]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=H();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},e.pause=function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},e.cancel=function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},e.finish=function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},e.reverse=function(){},e._run=function(){var t=this,e=this._onFrame,n=H(),r=n-this._playStartTime;if(this.options.repeat&&r>=this.duration&&(this._playStartTime=n,r=0),"running"===this.playState){var i=this._animation(r,this.duration);this.playState=i.state.playState,"running"!==this.playState&&this.target&&delete this.target[Ph],"idle"===this.playState?this.startTime>n&&setTimeout(this._run.bind(this),this.startTime-n):"running"===this.playState?this._framer((function(){"running"===t.playState&&(t.currentTime=r,e&&e(i),t._run())})):"finished"===this.playState&&(this.finished=!0,e&&e(i))}else if(this.target&&delete this.target[Ph],e){"finished"===this.playState?r=this.duration:"idle"===this.playState&&(r=0);var o=this._animation(r,this.duration);o.state.playState=this.playState,e(o)}},t}(),kh={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return kh._resolveStyles(t);for(var e=[],n=[],r=[],i=0;i<t.length;i++){var o=kh._resolveStyles(t[i]);o&&(e.push(o[0]),n.push(o[1]),r.push(o[2]))}return e.length?[e,n,r]:null}function n(t){var e,n=t;Array.isArray(t)||(n=V(t)?[0,t]:t instanceof Vt||t instanceof rs?[new(e=t.constructor)(0,0),t]:[t,t]);var r=n[0],i=n[1];return V(r)&&V(i)?r===i?null:[r,i-r,i]:Array.isArray(r)&&V(r[0])||r instanceof rs||r instanceof Vt?(Array.isArray(r)?(r=new rs(r),i=new rs(i)):(r=new(e=r.constructor)(r),i=new e(i)),r.equals(i)?null:[r,i.sub(r),i]):[r,i,i]}var r,i={},o={},s={};for(var a in t)if(t.hasOwnProperty(a)){var l=t[a];if(!l)continue;if(Array.isArray(l)&&(U(l[0])||U(l[1])))continue;var h=void 0;r=l,(h=!Array.isArray(r)&&r.constructor===Object||Array.isArray(r)&&r[0].constructor===Object?e(l):n(l))&&(o[a]=h[0],i[a]=h[1],s[a]=h[2])}return[o,i,s]},framing:function(t,e){e||(e={});var n,r,i,o=e.easing?Eh[e.easing]:Eh.linear;o||(o=Eh.linear),(t=kh._resolveStyles(t))&&(r=t[0],n=t[1],i=t[2]);var s=function t(e,n,r){if(!n||!r)return null;var o={};for(var s in r)if(r.hasOwnProperty(s)){if(n[s]===i[s]){o[s]=n[s];continue}var a=n[s],l=r[s];if(V(l))o[s]=a+e*l;else if(Array.isArray(l)){for(var h=[],u=0;u<l.length;u++)h.push(t(e,a[u],l[u]));o[s]=h}else{var c=l.constructor;o[s]=c===Object?t(e,a,l):a instanceof Vt||a instanceof rs?a.add(l.multi(e)):l}}return o};return function(t,e){var a,l;if(t<0)a={playState:"idle",delta:0},l=r;else if(t<e){var h=o(t/e);a={playState:"running",delta:h},l=s(h,r,n)}else a={playState:"finished",delta:1},l=i;return a.startStyles=r,a.destStyles=i,a.progress=t,a.remainingMs=e-t,new Oh(a,l)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=Ht(kh._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]();this._frameQueue.length?this._animationFrameId=Ht(kh._frameFn):delete this._animationFrameId}},animate:function(t,e,n,r){e||(e={});var i=kh.framing(t,e);return new Rh(i,e,n,r)},_frameFn:function(){}};kh._frameFn=kh._run.bind(kh),kh.animate;var Lh,Dh={exports:{}};Lh=Dh,function(){function t(t,e,n){var r=e.x,i=e.y,o=n.x-r,s=n.y-i;if(0!==o||0!==s){var a=((t.x-r)*o+(t.y-i)*s)/(o*o+s*s);a>1?(r=n.x,i=n.y):a>0&&(r+=o*a,i+=s*a)}return(o=t.x-r)*o+(s=t.y-i)*s}function e(n,r,i,o,s){for(var a,l=o,h=r+1;h<i;h++){var u=t(n[h],n[r],n[i]);u>l&&(a=h,l=u)}l>o&&(a-r>1&&e(n,r,a,o,s),s.push(n[a]),i-a>1&&e(n,a,i,o,s))}function n(t,n){var r=t.length-1,i=[t[0]];return e(t,0,r,n,i),i.push(t[r]),i}function r(t,e,r){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=r?t:function(t,e){for(var n,r,i,o,s,a=t[0],l=[a],h=1,u=t.length;h<u;h++)n=t[h],i=a,o=void 0,s=void 0,o=(r=n).x-i.x,s=r.y-i.y,o*o+s*s>e&&(l.push(n),a=n);return a!==n&&l.push(n),l}(t,i),t=n(t,i)}Lh.exports=r,Lh.exports.default=r}();var Nh=Or(Dh.exports),Fh="not find Geometry' Projection. please add Geometry to Layer and add Layer to Map",zh=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.animateShow=function(t={},e){var n=this;this._showPlayer&&this._showPlayer.finish(),X(t)&&(e=t={});var r=this.getCoordinates();if(0!==r.length){this._animIdx=0,this._animLenSoFar=0,this.show();var i=!!this.getShell?this.getShell().concat(this.getShell()[0]):r,o=this._getProjection();if(o){var s=o.projectCoords(i,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=o.unproject(this._prjAniShowCenter);var a=t.duration||1e3,l=t.easing||"out";this.setCoordinates([]);var h=0;s.length&&(s[0]._distance=0);for(var u=1;u<s.length;u++){var c=s[u].distanceTo(s[u-1]);s[u]._distance=c,h+=c}this._tempCoord=new rs(0,0),this._tempPrjCoord=new Vt(0,0);var f=this._showPlayer=kh.animate({t:a},{duration:a,easing:l},(function(t){if(n.getMap()){var o=n._drawAnimShowFrame(t.styles.t,a,h,i,s);"finished"===t.state.playState&&(delete n._showPlayer,delete n._aniShowCenter,delete n._prjAniShowCenter,delete n._animIdx,delete n._animLenSoFar,delete n._animTailRatio,delete n._tempCoord,delete n._tempPrjCoord,n.setCoordinates(r)),e&&e(t,o)}else if("finished"!==f.playState&&(f.finish(),e)){var l=n.getCoordinates();e(t,l[l.length-1])}}),this);return f.play(),f}console.error(Fh)}},n._drawAnimShowFrame=function(t,e,n,r,i){if(0===t)return r[0];var o,s,a=t/e*n,l=0;for(o=this._animIdx+1,s=i.length;o<s&&(l=i[o]._distance,!(this._animLenSoFar+l>a));o++)this._animLenSoFar+=l;if(this._animIdx=o-1,this._animIdx>=s-1)return this.setCoordinates(r),r[r.length-1];var h=this._animIdx,u=i[h],c=i[h+1],f=(a-this._animLenSoFar)/l;this._animTailRatio=f;var d=u.x+(c.x-u.x)*f,p=u.y+(c.y-u.y)*f;this._tempPrjCoord.x=d,this._tempPrjCoord.y=p;var g=this._tempPrjCoord,m=r[h],A=r[h+1],y=m.x+(A.x-m.x)*f,v=m.y+(A.y-m.y)*f;this._tempCoord.x=y,this._tempCoord.y=v;var x=this._tempCoord,_=!!this.getShell;if(!_&&this.options.smoothness>0){for(var b=[],w=[],T=0;T<=this._animIdx;T++)b.push(r[T]),w.push(i[T]);b.push(x,x),w.push(g,g),this.setCoordinates(b),this._setPrjCoordinates(w)}else{var M=r.slice(0,this._animIdx+1);M.push(x);var C=i.slice(0,this._animIdx+1);C.push(g),_?(this.setCoordinates([this._aniShowCenter].concat(M)),this._setPrjCoordinates([this._prjAniShowCenter].concat(C))):(this.setCoordinates(M),this._setPrjCoordinates(C))}return x},n._getCenterInExtent=function(t,e,n){var r=this.getExtent();if(!t.intersects(r))return null;var i=n(e,t);if(0===i.length)return null;var[o,s,a]=[0,0,0];i.forEach((function(t){Array.isArray(t)?t.forEach((function(t){t.point&&(t=t.point),o+=t.x,s+=t.y,a++})):(t.point&&(t=t.point),o+=t.x,s+=t.y,a++)}));var l=new rs(o,s)._multi(1/a);return l.count=a,l},n._getPath2DPoints=function(t,e,n){if(!ie(t))return[];var r=this.getMap(),i=!e&&this._shouldSimplify(),o=this.options.simplifyTolerance*r._getResolution(),s=Array.isArray(t[0]);if(delete this._simplified,i&&!s){var a=t.length;t=Nh(t,o,!1),this._simplified=t.length<a}if(n||(n=r._getResolution()),Array.isArray(t)){var l=[],h="_glPt";if(!Array.isArray(t[0]))return l=ge(t,h),r._prjsToPointsAtRes(t,n,l);for(var u=[],c=0,f=t.length;c<f;c++){var d=t[c];l=ge(d,h);var p=r._prjsToPointsAtRes(d,n,l);u.push(p)}return u}return r._prjToPointAtRes(t,n)},n._shouldSimplify=function(){var t=this.getLayer(),e=t.options.enableAltitude;return t&&t.options.enableSimplify&&!e&&this.options.enableSimplify&&!this._showPlayer},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},n._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},n._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},n._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t,this.options.antiMeridian):[]},n._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},n._computeCenter=function(){var t=this._coordinates;if(!ie(t))return null;for(var e=0,n=0,r=0,i=t.length,o=0;o<i;o++)t[o]&&V(t[o].x)&&V(t[o].y)&&(e+=t[o].x,n+=t[o].y,r++);return new rs(e/r,n/r)},n._computeExtent=function(t){var e=this._coordinates;if(!ie(e))return null;var n=[e];return this.hasHoles&&this.hasHoles()&&n.push.call(n,...this.getHoles()),this._coords2Extent(n,this._getProjection())},n._computePrjExtent=function(t){var e=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&e.push.call(e,...this._getPrjHoles()),this._coords2Extent(e)},n._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,n=1,r=t.length;n<r;n++)e+=t[n].distanceTo(t[n-1]);return e},n._hitTestTolerance=function(){var e,n=this._getInternalSymbol();if(Array.isArray(n)){e=0;for(var r=0;r<n.length;r++)V(n[r].lineWidth)&&n[r].lineWidth>e&&(e=n[r].lineWidth)}else e=n.lineWidth;return t.prototype._hitTestTolerance.call(this)+(V(e)?e/2:1.5)},n._coords2Extent=function(t,e){if(!t||0===t.length||Array.isArray(t[0])&&0===t[0].length)return null;for(var n=new As(e),r=0,i=t.length;r<i;r++)for(var o=0,s=t[r].length;o<s;o++)n._combine(t[r][o]);return n},e}(rh);zh.mergeOptions({smoothness:!1,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var Bh="Polygon",Hh=function(t){function e(e,n){var r;return(r=t.call(this,n)||this).type="Polygon",e&&r.setCoordinates(e),r}kt(e,t);var n=e.prototype;return n.getOutline=function(){return this._getPainter()?new e(this.getExtent().toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}}):null},n.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=rs.toCoordinates(t),n=e.length;if(Array.isArray(e[0]))if(this._coordinates=this._trimRing(e[0]),n>1){for(var r=[],i=1;i<n;i++)e[i]&&r.push(this._trimRing(e[i]));this._holes=r}else this._holes=null;else this._coordinates=this._trimRing(e);return this._projectRings(),this},n.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],n=0,r=t.length;n<r;n++)e.push(this._copyAndCloseRing(t[n]));return e},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),Ya)},n.getShell=function(){return this._coordinates||[]},n.getHoles=function(){return this._holes||[]},n.hasHoles=function(){return this.getHoles().length>0},n._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},n._checkRing=function(t){if(this._cleanRing(t),!t||!ie(t))return!1;var e=t[t.length-1],n=!0;return t[0].x===e.x&&t[0].y===e.y||(n=!1),n},n._trimRing=function(t){var e=this._checkRing(t);return ie(t)&&e&&t.splice(t.length-1,1),t},n._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return ie(t)&&!e?(t.push(t[0].copy()),t):t},n._getPrjShell=function(){return this.getJSONType()===Bh?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this._getShell?this._getShell():this.getShell())),this._prjShell)},n._getPrjHoles=function(){var t=this._getProjection();return this._verifyProjection(),t&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},n._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!ie(e))return 0;for(var n=0,r=0,i=e.length;r<i;r++)n+=t.measureLength(e[r]);return n},n._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!ie(e))return 0;for(var n=t.measureArea(e[0]),r=1,i=e.length;r<i;r++)n-=t.measureArea(e[r]);return n},n._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},n._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},n._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(zh);function jh(t){return function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){var e=t instanceof rs?t:new rs(t);if(this._translateRotatePivot(e),this._coordinates=e,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var n=this._getPrjCoordinates();return n?(t||(t=e._getResolution()),e._prjToPointAtRes(n,t)):null},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pcenter&&t&&this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter},n._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},n._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}Hh.registerJSONType(Bh);var Uh=new vs,Vh=function(t){function e(e,n){var r;return(r=t.call(this,n)||this).type="Point",r.isPoint=!0,e&&r.setCoordinates(e),r}kt(e,t);var n=e.prototype;return n.getOutline=function(){var t=this.getCoordinates(),n=this.getContainerExtent(),r=this.getMap().coordToContainerPoint(t);return new e(t,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(r.x-n.getWidth()/2),markerDy:n.ymin-(r.y-n.getHeight()/2)}})},n.setSymbol=function(e){return delete this._fixedExtent,t.prototype.setSymbol.call(this,e)},n._getSizeSymbol=function(t){for(var e,n={},r=!1,i=!1,o=0;o<Ga.length;o++){var s=t[Ga[o]];U(s)||(!r&&Un(s)&&(r=!0,i=!0),n[Ga[o]]=s)}for(var a=0;a<Wa.length;a++){var l=t[Wa[a]];U(l)||(!r&&Un(l)&&(r=!0),n[Wa[a]]=l)}return r?(e=ur(n,this),i&&(e._dynamic=!0)):e=n,e},n._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,t.prototype._setExternSymbol.call(this,e)},n._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},n._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new vs,this._fixedExtent.set(null,null,null,null);var t=this._sizeSymbol;if(!t)return this._fixedExtent;var e=this.getLayer()&&this.getLayer().getRenderer(),n=e&&e.resources,r=this.getTextDesc();if(Array.isArray(t)){Uh.set(1/0,1/0,-1/0,-1/0);for(var i=0;i<t.length;i++)t[i]&&this._fixedExtent._combine(za(Uh,t[i],n,r&&r[i]))}else this._fixedExtent=za(this._fixedExtent,t,n,r);return this._fixedExtent},n._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&ja(t)},n._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(ja(t)||Ua(t)||Ha(t))},n._containsPoint=function(e,n){var r=this.getContainerExtent();return n&&(r=r.expand(n)),!!r.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,n))},n._computeExtent=function(){return Gh.call(this,"getCenter")},n._computePrjExtent=function(){return Gh.call(this,"_getPrjCoordinates")},n._computeGeodesicLength=function(){return 0},n._computeGeodesicArea=function(){return 0},n._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new Bl(this).getSprite(t,e)},e}(jh(rh));function Gh(t){var e=this[t]();return e?new As(e,e,this._getProjection()):null}Vh.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1,collision:!0}),Vh.registerJSONType("Marker");var Wh=function(t){function e(e,n){var r;return(r=t.call(this,n)||this).type="LineString",e&&r.setCoordinates(e),r}kt(e,t);var n=e.prototype;return n.getOutline=function(){return Hh.prototype.getOutline.call(this)},n.setCoordinates=function(t){return t?(this._coordinates=rs.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},n.getCoordinates=function(){return this._coordinates||[]},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),Xa)},n._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},n._computeGeodesicArea=function(){return 0},e}(zh);Wh.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),Wh.registerJSONType("LineString");var qh=new vs,Xh=function(t){function e(e,n){var r;return(r=t.call(this,n)||this).type="GeometryCollection",r.setGeometries(e),r}kt(e,t);var n=e.prototype;return n.getContainerExtent=function(t){var e=t||new vs;return this.forEach((function(t){e._combine(t.getContainerExtent(qh))})),e},n.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),n=this._getSymbol(),r=this.config(),i=this.getProperties(),o=e.length-1;o>=0;o--)e[o]._initOptions(r),e[o]._setParent(this),e[o]._setEventParent(this),n&&e[o].setSymbol(n),i&&e[o].setProperties(i);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},n.getGeometries=function(){return this._geometries||[]},n.forEach=function(t,e){for(var n=this.getGeometries(),r=0,i=n.length;r<i;r++)n[r]&&(e?t.call(e,n[r],r):t(n[r],r));return this},n.filter=function(t,n){if(!t)return new e;var r=[],i=X(t),o=i?t:Yn(t);return this.forEach((function(t){var e=i?t:or(t);(n?o.call(n,e):o(e))&&r.push(t)}),this),new e(r)},n.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach((function(t){t&&t.translate&&t.translate.apply(t,e)})),this},n.isEmpty=function(){return!ie(this.getGeometries())},n.remove=function(){return this.forEach((function(t){t._unbind()})),rh.prototype.remove.apply(this,arguments)},n.show=function(){return this.options.visible=!0,this.forEach((function(t){t.show()})),this},n.hide=function(){return this.options.visible=!1,this.forEach((function(t){t.hide()})),this},n.onConfig=function(t){this.forEach((function(e){e.config(t)}))},n.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var n=[],r=!1;this.forEach((function(t){t.getSymbol()&&!r&&(r=!0),n.push(t.getSymbol())})),r&&(e={children:n})}return e},n.setSymbol=function(t){var e=this;if(t&&t.children)this._symbol=null,this.forEach((function(n,r){n._eventSymbolProperties=e._eventSymbolProperties,n.setSymbol(t.children[r])}));else{var n=this._prepareSymbol(t);this._symbol=n,this.forEach((function(t){t._eventSymbolProperties=e._eventSymbolProperties,t.setSymbol(n)}))}return this.onSymbolChanged(),this},n._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach((function(e){e._setExternSymbol(t)})),this.onSymbolChanged(),this},n._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},n._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach((function(e){e._bindLayer(t)}))},n._checkGeometries=function(t){for(var e=[],n=0,r=(t=Array.isArray(t)?t:[t]).length;n<r;n++){var i=t[n];i&&(this._checkGeo(i)?i instanceof Xh?console.error(i," is GeometryCollection sub class,it Cannot be placed in GeometryCollection"):e.push(i):console.error("The geometry added to collection is invalid. Index: "+n))}return e},n._checkGeo=function(t){return t instanceof rh},n._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(t){t&&t._updateCache&&t._updateCache()}))},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(t){t._removePainter()}))},n._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,n=0,r=0,i=this.getGeometries(),o=0,s=i.length;o<s;o++)if(i[o]){var a=i[o]._computeCenter(t);a&&(e+=a.x,n+=a.y,r++)}return 0===r?null:new rs(e/r,n/r)},n._containsPoint=function(t,e){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var n=this.getGeometries(),r=0,i=n.length;r<i;r++)if(n[r]._containsPoint(t,e))return this._pickGeometryIndex=r,!0;return!1},n._hitTestTolerance=function(){for(var t=this.getGeometries(),e=0,n=0,r=t.length;n<r;n++){var i=t[n]._hitTestTolerance();e=Math.max(e,i)}return e},n._computeExtent=function(t){return Zh.call(this,t,"_computeExtent")},n._computePrjExtent=function(t){return Zh.call(this,t,"_computePrjExtent")},n._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,r=0,i=e.length;r<i;r++)e[r]&&(n+=e[r]._computeGeodesicLength(t));return n},n._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,r=0,i=e.length;r<i;r++)e[r]&&(n+=e[r]._computeGeodesicArea(t));return n},n._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),n=0,r=e.length;n<r;n++)e[n]&&t.push(e[n]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},n._toJSON=function(t){t=j({},t);var e,n={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter((function(t){return t&&t._toJSON})).map((function(t){var e=t._toJSON();return e.subType?e:t._exportGeoJSONGeometry()}))}},r=this.getId();return U(r)||(n.id=r),(U(t.properties)||t.properties)&&(e=this._exportProperties()),n.properties=e,t.feature=n,t},n._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e]&&t[e]._clearProjection()},n._getConnectPoints=function(){var t=this.getExtent();return[new rs(t.xmin,t.ymax),new rs(t.xmax,t.ymin),new rs(t.xmin,t.ymin),new rs(t.xmax,t.ymax)]},n._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,n=this.getGeometries(),r=[],i={},o=0,s=n.length;o<s;o++)if(n[o])for(var a=0,l=(t=fr(n[o]._getInternalSymbol())).length;a<l;a++)i[e=t[a].join()]||(r.push(t[a]),i[e]=1);return r},n.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1),this._recordVisible();for(var n=this.getGeometries(),r=0,i=n.length;r<i;r++)n[r].startEdit(t);this._editing=!0;var o=this.getLayer();return o&&"canvas"===o.options.renderer&&this.hide(),setTimeout((function(){e.fire("editstart")}),1),this},n.endEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},n.isEditing=function(){return!!this._editing},e}(rh);function Zh(t,e){if(this.isEmpty())return null;for(var n=new As,r=this.getGeometries(),i=0,o=r.length;i<o;i++)if(r[i]){var s=r[i][e](t);s&&n._combine(s)}return n}Xh.registerJSONType("GeometryCollection");var Yh=function(t){function e(e,n,r,i){var o;return(o=t.call(this,null,i)||this).GeometryType=e,o.type=n,o._initData(r),o}kt(e,t);var n=e.prototype;return n.getCoordinates=function(){for(var t=[],e=this.getGeometries(),n=0,r=e.length;n<r;n++){var i=e[n];t.push(i.getShell&&"Polygon"!==i.getJSONType()?[i.getShell()]:i.getCoordinates())}return t},n.setCoordinates=function(t){for(var e=[],n=0,r=(t=t||[]).length;n<r;n++){var i=new this.GeometryType(t[n],this.config());e.push(i)}return this.setGeometries(e),this},n._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},n._checkGeo=function(t){return t instanceof this.GeometryType},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=rs.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},e}(Xh),Jh=function(t){function e(e,n){return t.call(this,Vh,"MultiPoint",e,n)||this}return kt(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=this.getCoordinates(),n=null,r=1/0;return e.forEach((function(e){var i,o,s,a,l=(i=e,s=(o=t).x-i.x,a=o.y-i.y,Math.sqrt(s*s+a*a));l<r&&(n=e,r=l)})),n},e}(Yh);Jh.registerJSONType("MultiPoint");var Qh=function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e.prototype.getCenterInExtent=function(t){var e=this.getGeometries(),[n,r,i]=[0,0,0];return e.forEach((function(e){var o=e.getCenterInExtent(t);o&&(n+=o.x*o.count,r+=o.y*o.count,i+=o.count)})),0===i?null:new rs(n,r)._multi(1/i)},e}(Yh),Kh=function(t){function e(e,n){return t.call(this,Wh,"MultiLineString",e,n)||this}return kt(e,t),e}(Qh);Kh.registerJSONType("MultiLineString");var $h=function(t){function e(e,n){return t.call(this,Hh,"MultiPolygon",e,n)||this}return kt(e,t),e}(Qh);$h.registerJSONType("MultiPolygon");var tu,eu={Marker:Vh,LineString:Wh,Polygon:Hh,MultiPoint:Jh,MultiLineString:Kh,MultiPolygon:$h},nu="geojson-fetch-worker-page-async",ru=function(t){function e(){return t.call(this,nu)||this}kt(e,t);var n=e.prototype;return n._sendMsg=function(t,e,n){var r=this;this.send(t,[],(function(i,o){i?n(i):r._pageFeatures(t,o,e,n)}),t.workerId)},n._fetchGeoJSON=function(t,e,n=[],r){var i=j({},e);i.type="fetchdata",i.url=t,this._sendMsg(i,n,r)},n._pageFeatures=function(t,e,n,r){if(n.push(e),0!==e.length){var i=j({},t);i.type="pagefeatures",this._sendMsg(i,n,r)}else r(null,n)},e}(da);_i(nu,(function(){return"\nfunction (exports) {\n    const resultMap = {};\n\n    function handleResult(msg, postResponse) {\n        const data = msg.data || {};\n        const { taskId } = data;\n        const features = resultMap[taskId];\n        if (!features) {\n            postResponse('not find geojson dataset the taskId:' + taskId);\n            return;\n        }\n        if (features.length === 0) {\n            delete resultMap[taskId];\n            postResponse(null, []);\n            return;\n        }\n        const pageSize = data.pageSize || 2000;\n        const pageFeatures = features.slice(0, pageSize);\n        resultMap[taskId] = features.slice(pageSize, Infinity);\n        postResponse(null, pageFeatures);\n    }\n    //worker init\n    exports.initialize = function () {\n        // console.log(\"geojson fetch init\");\n    };\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        const { taskId, type, url } = msg.data || {};\n        if (!taskId) {\n            postResponse('not find task id for get geojson dataset,taskId=' + taskId);\n            return;\n        }\n        if (type === 'fetchdata') {\n            if (!url) {\n                postResponse('url is null,url=' + url);\n                return;\n            }\n            fetch(url).then(res => res.json()).then(geojson => {\n                let features;\n                if (Array.isArray(geojson)) {\n                    features = geojson;\n                } else if (geojson.features) {\n                    features = geojson.features;\n                } else {\n                    features = [geojson];\n                }\n                resultMap[taskId] = features;\n                handleResult(msg, postResponse);\n            }).catch(errror => {\n                postResponse(errror.message);\n            });\n        } else if (type === 'pagefeatures') {\n            handleResult(msg, postResponse);\n        } else {\n            postResponse('not support task type:' + type);\n        }\n    };\n}"}));var iu={toGeometry:function(t,e){if(q(t)&&(t=Yt(t)),Array.isArray(t)){for(var n=[],r=0,i=t.length;r<i;r++){var o=iu._convert(t[r],e);Array.isArray(o)?Jt(n,o):n.push(o)}return n}return iu._convert(t,e)},toGeometryAsync:function(t,e,n=2e3){return q(t)&&(t=Yt(t)),new Promise((function(r){var i,o=[];if(t&&(Array.isArray(t)||Array.isArray(t.features))){var s=V(n)?Math.round(n):2e3,a=t.features||t,l=Math.ceil(a.length/s),h=1;(i={count:l,run:function(){var t=(h-1)*s,n=h*s,r=a.slice(t,n),i=iu.toGeometry(r,e);return h++,i}},Hi(),new Promise((function(t,e){if(i)if(X(i)&&(i={count:1,run:i}),i.run)if(U(i.count)&&(i.count=1),i.count=Math.ceil(i.count),V(i.count)){var n=i;n.results=[],ki.push(n),n.resolve=t}else e(new Error("task.count is not number"));else e(new Error("task.run is null"));else e(new Error("task is null"))}))).then((function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e];i&&(Array.isArray(i)?Jt(o,i):o.push(i))}r(o)}))}else{var u=iu.toGeometry(t,e);r(u)}}))},_convert:function(t,e){if(!t||U(t.type))return null;var n=t.type;if("Feature"===n){var r=t.geometry,i=iu._convert(r);return i?(i.setId(t.id),i.setProperties(t.properties),e&&e(i),i):null}if("FeatureCollection"===n){var o=t.features;return o?iu.toGeometry(o,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(n)>=0){var s=new eu["Point"===n?"Marker":n](t.coordinates);return e&&e(s),s}if("GeometryCollection"===n){var a=t.geometries;if(!ie(a)){var l=new Xh;return e&&e(l),l}for(var h=[],u=a.length,c=0;c<u;c++)a[c].subType?h.push(rh.getJSONClass(a[c].subType).fromJSON(a[c])):h.push(iu._convert(a[c]));var f=new Xh(h);return e&&e(f),f}return null},_isGeoJSON:function(t){if(!t)return!1;if(t=t||{},Array.isArray(t)&&t.length)return iu.isGeoJSON(t[0]);var e=t.type;if(!e)return!1;if(-1===be.indexOf(e))return!1;var{features:n,geometries:r,geometry:i,coordinates:o}=t;if(o&&Array.isArray(o))return!0;if(Array.isArray(r))return!0;if(Array.isArray(n))return!0;if(i){var s=i.coordinates;if(s&&Array.isArray(s))return!0}return!1},fetch:function(t,e=2e3){return new Promise((function(n,r){if(t&&q(t)){var i=j({pageSize:2e3},{pageSize:e});t=Ae(t),tu||(tu=new ru);var o=tu.workers.length,s=Math.floor(Math.random()*o);s=Math.min(o-1,s),i.workerId=s,i.taskId=Zt(),tu._fetchGeoJSON(t,i,[],(function(t,e){if(t)r(t);else{var i=[];e.forEach((function(t){for(var e=0,n=t.length;e<n;e++)i.push(t[e])})),n({type:"FeatureCollection",features:i})}}))}else r("url is error,It should be string")}))}},ou=function(t){function e(e,n,r){var i;return i=t.call(this,null,r)||this,e&&i.setCoordinates(e),i._radius=n,i}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(t.coordinates,t.radius,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n.getRadius=function(){return this._radius},n.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},n.getShell=function(){for(var t,e,n,r=this._getMeasurer(),i=this.getCoordinates(),o=this.options.numberOfShellPoints,s=this.getRadius(),a=[],l=0,h=o-1;l<h;l++){t=360*l/h*Math.PI/180,e=s*Math.cos(t),n=s*Math.sin(t);var u=r.locate(i,e,n);u.z=i.z,a.push(u)}return a.push(a[0]),a},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var r=this.getMap();if(r.getPitch())return t.prototype._containsPoint.call(this,e,n);var i=r._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),s=this._hitTestTolerance()+(n||0),a=i.add(o.width/2,o.height/2);return Ka(e,i,a,s)},n._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var n=this._getPrjCoordinates(),r=e.map((function(e){return t.project(e)})),i=r[0].x-n.x,o=r[1].x-n.x,s=r[2].y-n.y,a=r[3].y-n.y;return new As(n.add(i,s),n.add(o,a))},n._computeExtent=function(t){var e=this._getMinMax(t);return e?new As(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},n._getMinMax=function(t){if(!t||!this._coordinates||U(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},n._computeGeodesicLength=function(){return U(this._radius)?0:2*Math.PI*this._radius},n._computeGeodesicArea=function(){return U(this._radius)?0:Math.PI*Math.pow(this._radius,2)},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:rs.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=this.getCenter(),n=j({},t);n.geometry=!1;var r=this.toGeoJSON(n);return r.geometry={type:"Polygon"},{feature:r,subType:"Circle",coordinates:e.toArray(),radius:this.getRadius()}},e}(jh(Hh));ou.mergeOptions({numberOfShellPoints:60}),ou.registerJSONType("Circle");var su=function(t){function e(e,n,r,i){var o;return o=t.call(this,null,i)||this,e&&o.setCoordinates(e),o.width=n,o.height=r,o}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(t.coordinates,t.width,t.height,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n.getWidth=function(){return this.width},n.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},n.getHeight=function(){return this.height},n.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var t,e,n,r,i=this._getMeasurer(),o=this.getCoordinates(),s=this.options.numberOfShellPoints-1,a=this.getWidth(),l=this.getHeight(),h=[],u=Math.pow(a/2,2)*Math.pow(l/2,2),c=Math.pow(a/2,2),f=Math.pow(l/2,2),d=[];if(Math.max(a/l,l/a)>2){var{fs:p,sum:g}=function(t){for(var e,n=[],r=[],i=0;i<t;i++)r.push((e=i/t)*e*e*e);var o=r.map((function(t){return t})).reverse(),s=[];Jt(s,r,o,r,o);for(var a=0,l=0,h=s.length;l<h;l+=4)n.push(s[l]),a+=s[l];return{fs:n,sum:a}}(s),m=360/g,A=0;l>a&&(A=90);for(var y=0,v=0,x=p.length;v<x;v++)y+=m*p[v],d.push(y+A)}else for(var _=0;_<s;_++){var b=360*_/s;d.push(b)}this.options.debug;for(var w=0;w<d.length;w++){e=(t=d[w])*Math.PI/180,n=Math.sqrt(u/(c*Math.pow(Math.tan(e),2)+f)),r=Math.sqrt(u/(f*Math.pow(1/Math.tan(e),2)+c)),t>90&&t<270&&(n*=-1),t>180&&t<360&&(r*=-1);var T=i.locate(o,n,r);T.z=o.z,h.push(T)}return h.push(h[0].copy()),h},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,n);var i=r.getProjection(),o=this._hitTestTolerance()+(n||0),s=i.projectCoords([this._coordinates,r.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian);return Ka(e,r.prjToContainerPoint(s[0]),r.prjToContainerPoint(s[1]),o)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():ou.prototype._computePrjExtent.apply(this,arguments)},n._computeExtent=function(){return ou.prototype._computeExtent.apply(this,arguments)},n._getMinMax=function(t){if(!t||!this._coordinates||U(this.width)||U(this.height))return null;var e=this.getWidth(),n=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-n/2),t.locate(this._coordinates,0,n/2)]},n._computeGeodesicLength=function(){if(U(this.width)||U(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},n._computeGeodesicArea=function(){return U(this.width)||U(this.height)?0:Math.PI*this.width*this.height/4},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:rs.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=j({},t),n=this.getCenter();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Ellipse",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},e}(jh(Hh));su.mergeOptions({numberOfShellPoints:81}),su.registerJSONType("Ellipse");var au=function(t){function e(e,n,r,i){var o;return o=t.call(this,null,i)||this,e&&o.setCoordinates(e),o._width=n,o._height=r,o}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(t.coordinates,t.width,t.height,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){var e=t instanceof rs?t:new rs(t);if(this._translateRotatePivot(e),this._coordinates=e,!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var t=this._getMeasurer(),e=this._coordinates,n=this.getMap(),r=1,i=-1;if(n){var o=n.getFullExtent();o.left>o.right&&(r=-1),o.bottom>o.top&&(i=1)}var s=[];s.push(e);var a=t.locate(e,r*this._width,0);a.z=e.z,s.push(a);var l=t.locate(e,r*this._width,i*this._height);l.z=e.z,s.push(l);var h=t.locate(e,0,i*this._height);return s.push(h),h.z=e.z,s.push(e),s},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pnw&&t&&this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw},n._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),n=this._getProjection();if(!n.isSphere())return this._rotatePrjCoordinates(e);for(var r=n.getSphereExtent(),i=r.sx,o=r.sy,s=this._getProjection().getCircum(),a=e[0],l=1,h=e.length;l<h;l++){var u=e[l],c=0,f=0;i*(a.x-u.x)>0&&(c=s.x*i),o*(a.y-u.y)<0&&(f=s.y*o),e[l]._add(c,f)}return this._rotatePrjCoordinates(e)},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},n._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},n._containsPoint=function(e,n){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,n);var i=U(n)?this._hitTestTolerance():n,o=r._getResolution()*i,s=this._getPrjExtent().expand(o),a=r._containerPointToPrj(e);return s.contains(a)},n._computePrjExtent=function(t){if(this.isRotated())return this._computeRotatedPrjExtent();var e=this._getSouthEast(t);if(!e)return null;var n=t.projectCoords([new rs(this._coordinates.x,e.y),new rs(e.x,this._coordinates.y)],this.options.antiMeridian);return new As(n[0],n[1])},n._computeExtent=function(t){var e=this._getSouthEast(t);return e?new As(this._coordinates,e,this._getProjection()):null},n._getSouthEast=function(t){if(!t||!this._coordinates||U(this._width)||U(this._height))return null;var e=this.getWidth(),n=-this.getHeight();if(t.fullExtent){var r=t.fullExtent;e*=r.right>r.left?1:-1,n*=r.top>r.bottom?1:-1}var i=t.locate(this._coordinates,e,0),o=t.locate(this._coordinates,0,n);return i.y=o.y,i},n._computeGeodesicLength=function(){return U(this._width)||U(this._height)?0:2*(this._width+this._height)},n._computeGeodesicArea=function(){return U(this._width)||U(this._height)?0:this._width*this._height},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:rs.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=j({},t),n=this.getCoordinates();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Rectangle",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},e}(Hh);au.registerJSONType("Rectangle");var lu=function(t){function e(e,n,r,i,o){var s;return(s=t.call(this,e,n,o)||this).startAngle=r,s.endAngle=i,s}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n.getStartAngle=function(){return this.startAngle},n.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},n.getEndAngle=function(){return this.endAngle},n.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},n._correctAngles=function(){var t=this.getStartAngle(),e=this.getEndAngle();if(e<t)return console.error("The ending angle should be greater than the starting angle ",t,e),[0,0];return e-t>360?(console.error("The difference between the end angle and the start angle is greater than 360 degrees ",t,e),[0,0]):(t<0&&(t+=360,e+=360),[t,e])},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){for(var t,e,n,[r,i]=this._correctAngles(),o=this._getMeasurer(),s=this.getCoordinates(),a=this.options.numberOfShellPoints-2,l=this.getRadius(),h=[s.copy()],u=i-r,c=0;c<a;c++){t=(u*c/(a-1)+r)*Math.PI/180,e=l*Math.cos(t),n=l*Math.sin(t);var f=o.locate(s,e,n);f.z=s.z,h.push(f)}return h.push(s.copy()),h},n.getRotateOffsetAngle=function(){return 90},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():ou.prototype._computePrjExtent.apply(this,arguments)},n._containsPoint=function(e,n){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,n);var i=r._pointToContainerPoint(this._getCenter2DPoint()),o=this._hitTestTolerance()+(n||0),s=this.getSize(),a=i,l=e,h=l.x-a.x,u=a.y-l.y,c=Math.atan2(u,h),f=c<0?360*(c+2*Math.PI)/(2*Math.PI):360*c/(2*Math.PI),[d,p]=this._correctAngles(),g=d%360,m=p%360,A=!1;return A=g>m?!(f>m&&f<g):f>=g&&f<=m,l.distanceTo(a)<=s.width/2+o&&A},n._computeGeodesicLength=function(){if(U(this._radius))return 0;var[t,e]=this._correctAngles();return 2*Math.PI*this._radius*Math.abs(t-e)/360+2*this._radius},n._computeGeodesicArea=function(){if(U(this._radius))return 0;var[t,e]=this._correctAngles();return Math.PI*Math.pow(this._radius,2)*Math.abs(t-e)/360},n._toJSON=function(t){var e=j({},t),n=this.getCenter();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Sector",coordinates:n.toArray(),radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(ou);lu.mergeOptions({numberOfShellPoints:60}),lu.registerJSONType("Sector");var hu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n._arc=function(t,e,n){var r=this.options.arcDegree;0===r&&(r=1);for(var i=r*Math.PI/180,o=1,s=e.length;o<s;o++)Oo._arcBetween(t,e[o-1],e[o],i),Oo._stroke(t,n)},n._quadraticCurve=function(t,e){if(e.length<=2)Oo._path(t,e);else{var n,r;for(n=2,r=e.length;n<r;n+=2)t.quadraticCurveTo(e[n-1].x,e[n-1].y,e[n].x,e[n].y);if((n-=1)<r)for(;n<r;n++)t.lineTo(e[n].x,e[n].y)}},n._bezierCurve=function(t,e){if(e.length<=3)Oo._path(t,e);else{var n,r;for(n=1,r=e.length;n+2<r;n+=3)t.bezierCurveTo(e[n].x,e[n].y,e[n+1].x,e[n+1].y,e[n+2].x,e[n+2].y);if(n<r)for(;n<r;n++)t.lineTo(e[n].x,e[n].y)}},n._getCurveArrowPoints=function(t,e,n,r,i,o){var s,a=e.length;for(s=o;s<a;s+=o){var l=this._getArrowShape(e[s-1],e[s],n,r,i);l&&t.push(l)}if((s-=o)<a-1)for(s+=1;s<a;s++){var h=this._getArrowShape(e[s-1],e[s],n,r,i);h&&t.push(h)}},e}(Wh);hu.mergeOptions({enableSimplify:!1,enableClip:!1});var uu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},n._paintOn=function(t,e,n){t.beginPath(),this._arc(t,e,n),Oo._stroke(t,n),this._paintArrow(t,e,n)},e.fromJSON=function(t){var n=t.feature,r=new e(n.geometry.coordinates,t.options);return r.setProperties(n.properties),r},e}(hu);uu.registerJSONType("ArcCurve"),uu.mergeOptions({arcDegree:90});var cu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(n.geometry.coordinates,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),Oo._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,r,i){return this._getCurveArrowPoints(t,e,n,r,i,3)},e}(hu);cu.registerJSONType("CubicBezierCurve");var fu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t),e.fromJSON=function(t){var n=t.feature,r=new e(n.geometry.coordinates,t.options);return r.setProperties(n.properties),r};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,n),Oo._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,r,i){return this._getCurveArrowPoints(t,e,n,r,i,2)},e}(hu);fu.registerJSONType("QuadBezierCurve");var du={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},pu={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},gu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.getContent=function(){return this._content},n.setContent=function(t){var e=this._content;return this._content=ke(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},n.onAdd=function(){this._refresh()},n.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},n.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var n=this._parseSymbol(e);if(this.setTextStyle){var r=this.getTextStyle()||{};r.symbol=n[0],this.setTextStyle(r)}else this.setTextSymbol&&this.setTextSymbol(n[0]);if(this.setBoxStyle){var i=this.getBoxStyle()||{};i.symbol=n[1],this.setBoxStyle(i)}else this.setBoxSymbol&&this.setBoxSymbol(n[1]);return this},n._parseSymbol=function(t){var e={},n={};for(var r in t)Y(t,r)&&(0===r.indexOf("text")?e[r]=t[r]:n[r]=t[r]);return[e,n]},n._getTextSize=function(t){return We(this._content,t).size},n._getInternalSymbol=function(){return this._symbol},n._getDefaultTextSymbol=function(){return j({},du)},n._getDefaultBoxSymbol=function(){return j({},pu)},n._getDefaultPadding=function(){return[12,8]},e}(Vh),mu=function(t){function e(e,n,r,i,o={}){var s;return(s=t.call(this,n,o)||this)._content=ke(e),s._width=U(r)?100:r,s._height=U(i)?40:i,o.boxSymbol&&s.setBoxSymbol(o.boxSymbol),o.textStyle&&s.setTextStyle(o.textStyle),s._refresh(),s}kt(e,t);var n=e.prototype;return n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this._refresh(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this._refresh(),this},n.getBoxSymbol=function(){return j({},this.options.boxSymbol)},n.setBoxSymbol=function(t){return this.options.boxSymbol=t?j({},t):t,this.getSymbol()&&this._refresh(),this},n.getTextStyle=function(){return this.options.textStyle?j({},this.options.textStyle):null},n.setTextStyle=function(t){return this.options.textStyle=t?j({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var n=t.feature,r=new e(t.content,n.geometry.coordinates,t.width,t.height,t.options);return r.setProperties(n.properties),r.setId(n.id),t.symbol&&r.setSymbol(t.symbol),r},n._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},n._refresh=function(){var t,e,n=this.getTextStyle()||{},r=n.padding||[12,8];if(Un(this._width)){var i=(t=JSON.parse(JSON.stringify(this._width))).stops;if(i)for(var o=0;o<i.length;o++)i[o][1]=i[o][1]-2*r[0]}else t=this._width-2*r[0];if(Un(this._height)){var s=(e=JSON.parse(JSON.stringify(this._height))).stops;if(s)for(var a=0;a<s.length;a++)s[a][1]=s[a][1]-2*r[1]}else e=this._height-2*r[1];var l=j({},n.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:t,textMaxHeight:e});n.wrap&&!l.textWrapWidth&&(l.textWrapWidth=t);var h,u=n.horizontalAlignment;if(l.textDx=l.markerDx||0,Un(this._width)){var c=(h=JSON.parse(JSON.stringify(this._width))).stops;if(c)for(var f=0;f<c.length;f++)c[f][1]=c[f][1]/2-r[0],"left"===u&&(c[f][1]*=-1)}else h=l.markerWidth/2-r[0],"left"===u&&(h*=-1);"left"===u?(l.textHorizontalAlignment="right",l.textDx=h):"right"===u&&(l.textHorizontalAlignment="left",l.textDx=h);var d,p=n.verticalAlignment;if(l.textDy=l.markerDy||0,Un(this._height)){var g=(d=JSON.parse(JSON.stringify(this._height))).stops;if(g)for(var m=0;m<g.length;m++)g[m][1]=g[m][1]/2-r[1],"top"===p&&(g[m][1]*=-1)}else d=l.markerHeight/2-r[1],"top"===p&&(d*=-1);"top"===p?(l.textVerticalAlignment="bottom",l.textDy=d):"bottom"===p&&(l.textVerticalAlignment="top",l.textDy=d),this._refreshing=!0,this.updateSymbol(l),delete this._refreshing},n.startEdit=function(e){var n=this._getCompiledSymbol();if(Un(this._width)){var r=n.markerWidth;this._oldWidth=this._width,this.setWidth(r)}if(Un(this._height)){var i=n.markerHeight;this._oldHeight=this._height,this.setHeight(i)}return t.prototype.startEdit.call(this,e)},n.endEdit=function(){var e=this.getMap(),n=e&&e.getZoom();if(this._oldWidth){for(var r=this._width/Gn(this._oldWidth)(n),i=this._oldWidth.stops,o=0;o<i.length;o++)i[o][1]*=r;this.setWidth(this._oldWidth),delete this._oldWidth}if(this._oldHeight){for(var s=this._height/Gn(this._oldHeight)(n),a=this._oldHeight.stops,l=0;l<a.length;l++)a[l][1]*=s;this.setHeight(this._oldHeight),delete this._oldHeight}return t.prototype.endEdit.call(this)},e}(gu);mu.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),mu.registerJSONType("TextBox");var Au=function(t){function e(e,n,r={}){var i;return i=t.call(this,n,r)||this,r.textSymbol&&i.setTextSymbol(r.textSymbol),r.boxStyle&&i.setBoxStyle(r.boxStyle),i._content=ke(e),i._refresh(),i}kt(e,t);var n=e.prototype;return n.getBoxStyle=function(){return this.options.boxStyle?j({},this.options.boxStyle):null},n.setBoxStyle=function(t){return this.options.boxStyle=t?j({},t):t,this._refresh(),this},n.getTextSymbol=function(){return j({},this._getDefaultTextSymbol(),this.options.textSymbol)},n.setTextSymbol=function(t){return this.options.textSymbol=t?j({},t):t,this._refresh(),this},e.fromJSON=function(t){var n=t.feature,r=new e(t.content,n.geometry.coordinates,t.options);return r.setProperties(n.properties),r.setId(n.id),t.symbol&&r.setSymbol(t.symbol),r},n._canEdit=function(){return!1},n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},n._refresh=function(){var t=j({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){j(t,e.symbol);var n=this._getBoxSize(t),r=n[1],i=e.padding||this._getDefaultPadding(),o=n[0];t.markerWidth=o.width,t.markerHeight=o.height;var s=t.textDx||0,a=t.textDy||0,l=je(r,t.textHorizontalAlignment,t.textVerticalAlignment)._add(s,a),h=e.horizontalAlignment||"middle";t.markerDx=l.x,"left"===h?t.markerDx+=t.markerWidth/2-i[0]:"right"===h?t.markerDx-=t.markerWidth/2-r.width-i[0]:t.markerDx+=r.width/2;var u=e.verticalAlignment||"middle";t.markerDy=l.y,"top"===u?t.markerDy+=t.markerHeight/2-i[1]:"bottom"===u?t.markerDy-=t.markerHeight/2-r.height-i[1]:t.markerDy+=r.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},n._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,n,r=this.getBoxStyle(),i=this._getTextSize(t),o=r.padding||this._getDefaultPadding();return e=i.width+2*o[0],n=i.height+2*o[1],r.minWidth&&(!e||e<r.minWidth)&&(e=r.minWidth),r.minHeight&&(!n||n<r.minHeight)&&(n=r.minHeight),[new Ie(e,n),i]},e}(gu);Au.mergeOptions({boxStyle:null,textSymbol:null}),Au.registerJSONType("Label");var yu=function(t){return function(t){function e(...e){return t.call(this,...e)||this}kt(e,t),e._hasConnectors=function(t){return!U(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var n=e.prototype;return n.getConnectSource=function(){return this._connSource},n.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},n.getConnectTarget=function(){return this._connTarget},n.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},n._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,n,r=this._connSource._getConnectPoints(),i=this._connTarget._getConnectPoints(),o=0,s=this.getCoordinates(),a=0,l=r.length;a<l;a++)for(var h=r[a],u=0,c=i.length;u<c;u++){var f=i[u],d=t.computeLength(h,f);0===a&&0===u?(e=h,n=f,o=d):d<o&&(e=h,n=f)}ie(s)&&s[0].equals(e)&&s[1].equals(n)||this.setCoordinates([e,n])}},n.onAdd=function(){this._registerEvents(),this._updateCoordinates()},n.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&Qt(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(Qt(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof rh&&this._connTarget instanceof rh)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},n._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},n._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof rh&&this._connTarget instanceof rh)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},vu={showOn:"always"},xu=function(t){function e(e,n,r){var i;return i=t.call(this,null,r)||this,1===arguments.length&&(r=e,e=null,n=null),i._connSource=e,i._connTarget=n,i}return kt(e,t),e}(yu(Wh));xu.mergeOptions(vu),xu.registerJSONType("ConnectorLine");var _u=function(t){function e(e,n,r){var i;return i=t.call(this,null,r)||this,1===arguments.length&&(r=e,e=null,n=null),i._connSource=e,i._connTarget=n,i}return kt(e,t),e}(yu(uu));function bu(t){return t&&t instanceof rh}_u.mergeOptions(vu),_u.registerJSONType("ArcConnectorLine");var wu=[],Tu=function(t){function e(e,n,r){var i;n&&!bu(n)&&!Array.isArray(n)&&be.indexOf(n.type)<0&&(r=n,n=null),(i=t.call(this,e,r)||this)._maxZIndex=0,i._minZIndex=0,i._initCache(),n&&i.addGeometry(n);var o=i.options.style;return o&&i.setStyle(o),i}kt(e,t);var n=e.prototype;return n.getAltitude=function(){return 0},n.getGeometryById=function(t){return U(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},n.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var n,r=[],i=0,o=this._geoList.length;i<o;i++)n=this._geoList[i],(e?t.call(e,n):t(n))&&r.push(n);return r},n.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},n.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},n.getCount=function(){return this._geoList.length},n.getExtent=function(){if(0===this.getCount())return null;var t=new As(this.getProjection());return this.forEach((function(e){t._combine(e.getExtent())})),t},n.forEach=function(t,e){for(var n=this._geoList.slice(0),r=0,i=n.length;r<i;r++)e?t.call(e,n[r],r):t(n[r],r);return this},n.filter=function(t,e){var n=[],r=X(t),i=r?t:Yn(t);return this.forEach((function(t){var o=r?t:or(t);(e?i.call(e,o):i(o))&&n.push(t)}),this),n},n.isEmpty=function(){return!this._geoList.length},n.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(iu.toGeometry(t),e);if(!Array.isArray(t)){var n=arguments.length,r=arguments[n-1];return t=Array.prototype.slice.call(arguments,0,n-1),e=r,r&&W(r)&&("type"in r||bu(r))&&(t.push(r),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var i;this._initCache(),e&&(i=new As),this._toSort=this._maxZIndex>0;for(var o=[],s=0,a=t.length;s<a;s++){var l=t[s];if(!l||!iu._isGeoJSON(l)&&!bu(l))throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+s);if(!l.getLayer||l.getLayer()!==this){if(!bu(l)&&(l=rh.fromJSON(l),Array.isArray(l)))for(var h=0,u=l.length;h<u;h++)this._add(l[h],i,s),o.push(l[h]);if(!l)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+s);Array.isArray(l)||(this._add(l,i,s),o.push(l))}}var c=this.getMap();if(c&&(this._getRenderer().onGeometryAdd(o),i&&!U(i.xmin))){var f=i.getCenter(),d=c.getFitZoom(i);if(W(e)){var p=X(e.step)?e.step:function(){};c.animateTo({center:f,zoom:d},j({duration:c.options.zoomAnimationDuration,easing:"out"},e),p)}else!0===e&&c.setCenterAndZoom(f,d)}return this.fire("addgeo",{type:"addgeo",target:this,geometries:t}),this},n.getGeoMinZIndex=function(){return this._minZIndex},n.getGeoMaxZIndex=function(){return this._maxZIndex},n._add=function(t,e,n){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var r=t.getId();if(!U(r)){if(!U(this._geoMap[r]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+r+", at index:"+n);this._geoMap[r]=t}var i=Xt();t._setInternalId(i),this._geoList.push(t),this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(t)},n.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof rh||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{type:"removegeo",target:this,geometries:t}),this},n.clear=function(){this._clearing=!0,this.forEach((function(t){t.remove()})),this._geoMap={};var t=this._geoList;this._geoList=[];var e=this._getRenderer();return e&&(e.onGeometryRemove(t),e.clearImageData&&(e.clearImageData(),delete e._lastGeosToDraw)),this._clearing=!1,this.fire("clear"),this},n.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!U(t._getInternalId()))){var e=t.getId();U(e)||delete this._geoMap[e];var n=this._findInList(t);n>=0&&this._geoList.splice(n,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},n.getStyle=function(){return this.options.style?this.options.style:null},n.setStyle=function(t){return this.options.style=t,t=xr(t),this._cookedStyles=sr(t),this.forEach((function(t){this._styleGeometry(t)}),this),this.fire("setstyle",{type:"setstyle",target:this,style:t}),this},n._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=or(t),n=0,r=this._cookedStyles.length;n<r;n++)if(!0===this._cookedStyles[n].filter(e))return t._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},n.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(t){t._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},n.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},n.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return ch.prototype.hide.call(this)},n._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},n._updateZIndex=function(...t){this._maxZIndex=Math.max(this._maxZIndex,Math.max(...t)),this._minZIndex=Math.min(this._minZIndex,Math.min(...t))},n._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(e,n){return t._updateZIndex(e.getZIndex(),n.getZIndex()),t._compare(e,n)})),this._toSort=!1)},n._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},n._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;this._sortGeometries();for(var n,r=0,i=e-1;r<=i;){if(n=Math.floor((r+i)/2),this._geoList[n]===t)return n;this._compare(this._geoList[n],t)>0?i=n-1:r=n+1}return-1},n.onGeometryEvent=function(t){return this._onGeometryEvent(t)},n._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},n._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!U(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}U(t.old)||t.new===t.old||delete this._geoMap[t.old]}},n._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},n._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},n._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},n._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},n._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},n._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},n._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},n._hasGeoListeners=function(t){if(!t)return!1;Array.isArray(t)||(wu[0]=t,t=wu);for(var e=this.getGeometries()||[],n=0,r=e.length;n<r;n++){var i=e[n];if(i){if(i.options.cursor)return!0;for(var o=0,s=t.length;o<s;o++){var a=t[o];if(i.listens(a)>0)return!0}}}return!1},n._getRenderer=function(){return t.prototype._getRenderer.call(this)},e}(ch);Tu.mergeOptions({drawImmediate:!1,geometryEvents:!0,geometryEventTolerance:1});var Mu=new vs,Cu={debug:!1,enableSimplify:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:Pt.gecko,enableAltitude:!0,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,collision:!1,collisionBufferSize:2,collisionDelay:250,collisionScope:"layer",progressiveRender:!1,progressiveRenderCount:1e3,progressiveRenderDebug:!1},Su=function(t){function e(e,n,r){var i;return(i=t.call(this,e,n,r)||this).isVectorLayer=!0,i}kt(e,t);var n=e.prototype;return n.onConfig=function(e){if(t.prototype.onConfig.call(this,e),!U(e.enableAltitude))for(var n=this.getGeometries()||[],r=0,i=n.length;r<i;r++){var o=n[r];o&&(o._clearAltitudeCache(),o.fire("positionchange"))}if(e.enableAltitude||e.drawAltitude||e.altitudeProperty){var s=this.getRenderer();s&&s.setToRedraw&&s.setToRedraw()}},n.identify=function(t,e){e=e||{};var n=this.getRenderer();t instanceof rs||(t=new rs(t));var r=this.getMap().coordToContainerPoint(t);return e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(r,e):this._hitGeos(this._geoList,r,e)},n.identifyAtPoint=function(t,e){e=e||{};var n=this.getRenderer();return t instanceof Vt||(t=new Vt(t)),e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(t,e):this._hitGeos(this._geoList,t,e)},n._hitGeos=function(t,e,n={}){if(!t||!t.length)return[];for(var r=[],i=0,o=0,s=t.length;o<s;o++){var a=t[o];a.isPoint&&!0===a._collided||(r[i]=a,i++)}t=r;var l=n.filter,h=[],u=n.tolerance,c=this.getMap(),f=this.getRenderer(),d=f&&f.getImageData&&f.getImageData();if(d){var p=0,g=f.maxTolerance;if(V(g))p=g;else for(var m=t.length-1;m>=0;m--){var A=t[m]._hitTestTolerance()+(u||0);A>p&&(p=A)}var y=c.getDevicePixelRatio();d.r=y;for(var v=!1,x=e.x-p,_=e.y-p,b=-p;b<=p;b++){for(var w=-p;w<=p;w++){var T=Math.round((x+b)*y),M=Math.round((_+w)*y)*d.width*4+4*T;if(d.data[M+3]>0){v=!0;break}}if(v)break}if(!v)return h}for(var C=n.onlyVisible,S=t.length-1;S>=0;S--){var I=t[S];if(I&&I.options.interactive&&(C||I.isVisible())){var P=I._getPainter();if(P){var E=P.getRenderBBOX&&P.getRenderBBOX();if(E){var{x:O,y:R}=e;if(O<E[0]||R<E[1]||O>E[2]||R>E[3])continue}if(!(I instanceof Wh&&(I._getArrowStyle()||I instanceof hu))){var k=I.getContainerExtent(Mu);if(u&&(k=k._expand(u)),!k||!k.contains(e))continue}if(I._containsPoint(e,u)&&(!l||l(I))&&(h.push(I),n.count&&h.length>=n.count))break}}}return h},n.getAltitude=function(){return this.options.altitude||0},n.toJSON=function(t){t||(t={clipExtent:null,geometries:null});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if(U(t.geometries)||t.geometries){var n;if(t.clipExtent){var r=this.getMap(),i=r?r.getProjection():null;n=new As(t.clipExtent,i)}for(var o=[],s=this.getGeometries(),a=0,l=s.length;a<l;a++){var h=s[a],u=h.getExtent();if(u&&(!n||n.intersects(u))){var c=h.toJSON(t.geometries);o.push(c)}}e.geometries=o}return e},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var n=new e(t.id,t.options),r=t.geometries,i=[],o=0;o<r.length;o++){var s=rh.fromJSON(r[o]);s&&i.push(s)}return n.addGeometry(i),n},e.getPainterClass=function(){return Bl},e.getCollectionPainterClass=function(){return Ul},e}(Tu);Su.mergeOptions(Cu),Su.registerJSONType("VectorLayer");var Iu="_map_tool",Pu=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addTo=function(t){return t?(this._map=t,t[Iu]&&t[Iu].disable(),this.onAdd&&this.onAdd(),this.enable(),t[Iu]=this,this._fireEvent("add"),this):this},n.getMap=function(){return this._map},n.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},n.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},n.isEnabled=function(){return!!this._enabled},n.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[Iu],delete this._map),this._fireEvent("remove"),this):this},n._registerEvents=function(){this._switchEvents("on")},n._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},n._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(zo(Ho)),Eu={symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1,zIndex:Number.MAX_VALUE,enableAltitude:!0,interactive:!0,transformCoordinate:null},Ou={},Ru=function(t){function e(e){var n;return(n=t.call(this,e)||this)._checkMode(),n._events={click:n._clickHandler,"mousemove touchmove":n._mouseMoveHandler,dblclick:n._doubleClickHandler,"mousedown touchstart":n._mouseDownHandler,"mouseup touchend":n._mouseUpHandler,mousemove:n._mouseMoveHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}kt(e,t),e.registerMode=function(t,e){Ou[t.toLowerCase()]=e},e.getRegisterMode=function(t){return Ou[t.toLowerCase()]};var n=e.prototype;return n.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},n.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},n.getSymbol=function(){var t=this.options.symbol;return vr(t||this.options.symbol)},n.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},n.getCurrentGeometry=function(){return this._geometry},n.onAdd=function(){this._checkMode()},n.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var t=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})),this._geometryEvents=t.options.geometryEvents,this.options.blockGeometryEvents&&t.config("geometryEvents",!1),this},n.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw({ignoreEndEvent:!0}),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&t.config("geometryEvents",this._geometryEvents),this},n.undo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||!this._historyPointer)return this;var n=this._clickCoords.slice(0,--this._historyPointer);return t.update(this.getMap().getProjection(),n,this._geometry),this},n.redo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||U(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var n=this._clickCoords.slice(0,++this._historyPointer);return t.update(this.getMap().getProjection(),n,this._geometry),this},n._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},n._checkMode=function(){this._getRegisterMode()},n._saveMapCfg=function(){var t=this.getMap();this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom});for(var e=this._getRegisterMode().action,n=!1,r=0;r<e.length;r++)if(e[r].indexOf("mousedown")>=0||e[r].indexOf("touchstart")>=0){n=!0;break}if(n){var i=this.getMap();this._mapDraggable=i.options.draggable,i.config({draggable:!1})}},n._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),U(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},n._loadResources=function(){var t=fr(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},n._getProjection=function(){return this._map.getProjection()},n._getRegisterMode=function(){var t=this.getMode(),n=e.getRegisterMode(t);if(!n)throw new Error(t+" is not a valid mode of DrawTool.");return n},n.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var n=0;n<t.length;n++)e[t[n]]=this._events[t[n]];return e}return null},n._mouseDownHandler=function(t){(null==t?void 0:t.coordinate)&&this._createGeometry(t)},n._mouseUpHandler=function(t){(null==t?void 0:t.coordinate)&&this.endDraw(t)},n._clickHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;t.enableAltitude=this.options.enableAltitude;var e=this.getMap(),n=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var r=this._clickCoords.length,i=e._pointToPrj(t.point2d);if(this._clickCoords[r-1].equals(i))return}if(this._geometry){var o=e._pointToPrj(t.point2d);U(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer));var s=this._geometry.snapTo;if(s&&X(s)){var a=this._getSnapResult(s,t.containerPoint);if(o=a.prjCoord,this._clickCoords=this._clickCoords.concat(a.effectedVertex),this._clickCoords[this._clickCoords.length-1].equals(o))return}if(this._clickCoords.push(o),this._historyPointer=this._clickCoords.length,t.drawTool=this,n.update(e.getProjection(),this._clickCoords,this._geometry,t),"point"===this.getMode())return void this.endDraw(t);this._clickCoords.length<=1?this._fireEvent("drawstart",t):this._fireEvent("drawvertex",t),n.clickLimit&&n.clickLimit===this._historyPointer&&this.endDraw(t)}else this._createGeometry(t)}},n._createGeometry=function(t){var e=this.getMode(),n=this.getMap(),r=this._getRegisterMode(),i=n._pointToPrj(t.point2d),o=this.getSymbol();if(!this._geometry){this._fireEvent("drawprepare",t),this._clickCoords=[i],t.drawTool=this,this._geometry=r.create(this.getMap().getProjection(),this._clickCoords,t),o&&"point"!==e?this._geometry.setSymbol(o):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t);var s=this._geometry.snapTo;if(s&&X(s)){var a=this._getSnapResult(s,t.containerPoint),l=this.getMap();if(l&&a){var h=a.prjCoord;this._clickCoords=[h],r.update(l.getProjection(),this._clickCoords,this._geometry,t)}}}"point"===e&&"mousemove"!==t.type&&this.endDraw(t)},n._mouseMoveHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;t.enableAltitude=this.options.enableAltitude;var e=this.getMap();if(e&&!e.isInteracting())if("point"!==this.getMode()||this._geometry){if(this._geometry){var n=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(n)){var r=e._pointToPrj(t.point2d),i=[],o=this._geometry.snapTo;if(o&&X(o)){var s=this._getSnapResult(o,n);r=s.prjCoord,i=s.effectedVertex}var a=e.getProjection();t.drawTool=this;var l=this._getRegisterMode();if(this._shouldRecordHistory(l.action)){var h=this._clickCoords.slice(0,this._historyPointer);if(h&&h.length>0&&r.equals(h[h.length-1]))return;l.update(a,h.concat(i,[r]),this._geometry,t)}else l.update(a,r,this._geometry,t);this._fireEvent("mousemove",t)}}}else this._createGeometry(t)}},n._doubleClickHandler=function(t){if(null==t?void 0:t.coordinate){if(!this.options.interactive)return this;if(t.enableAltitude=this.options.enableAltitude,this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var n=this._getRegisterMode(),r=this._clickCoords;if(r&&!(r.length<2)){var i=this.getMode();if(!(i&&i.indexOf("polygon")>-1&&r.length<3)){for(var o=this.getMap().getProjection(),s=[r[0]],a=1,l=r.length;a<l;a++)r[a].x===r[a-1].x&&r[a].y===r[a-1].y||s.push(r[a]);s.length<2||this._geometry&&this._geometry instanceof Hh&&s.length<3||(t.drawTool=this,n.update(o,s,this._geometry,t),this.endDraw(t))}}}}}},n._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},n.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,t.ignoreEndEvent||this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},n._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},n._getMouseContainerPoint=function(t){var e=this._getRegisterMode().action;return(e[0].indexOf("mousedown")>=0||e[0].indexOf("touchstart")>=0)&&on(t.domEvent),t.containerPoint},n._isValidContainerPoint=function(t){var e=this._map.getSize(),n=e.width,r=e.height;return!(t.x<0||t.y<0)&&!(t.x>n||t.y>r)},n._getSnapResult=function(t,e){var n=this.getMap(),r=[];if(this.options.edgeAutoComplete){var i=this._clickCoords[(this._historyPointer||1)-1];r.push(n.prjToContainerPoint(i));var o=this._clickCoords[(this._historyPointer||1)-2];o&&r.push(n.prjToContainerPoint(o))}var s=t(e,r);e=(s.effectedVertex?s.point:s)||e;var a=n._containerPointToPrj(e);return s.effectedVertex&&(s.effectedVertex=s.effectedVertex.map((function(t){return n._containerPointToPrj(t)}))),{prjCoord:a,effectedVertex:s.effectedVertex||[]}},n._getDrawLayer=function(){var t=xe+"drawtool",e=this._map.getLayer(t);return e||(e=new Su(t,{enableSimplify:!1,enableAltitude:this.options.enableAltitude,zIndex:this.options.zIndex}),this._map.addLayer(e)),this._pushLayers(e),e},n._fireEvent=function(t,e){e||(e={}),e=j({},e),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),e.tempGeometry=this._geometry),Pu.prototype._fireEvent.call(this,t,e)},n._pushLayers=function(t){var e=this;return t?(Array.isArray(t)||(t=[t]),this._layers=this._layers||[],t.forEach((function(t){-1===e._layers.indexOf(t)&&e._layers.push(t)})),this):this},n._outLayers=function(t){var e=this;return t?(Array.isArray(t)||(t=[t]),this._layers=this._layers||[],t.forEach((function(t){for(var n=0,r=e._layers.length;n<r;n++)if(t===e._layers[n]){e._layers.splice(n,1);break}})),this):this},n.setLayerZIndex=function(t){return V(t)?(this.options.zIndex=t,this._layers=this._layers||[],this._layers.forEach((function(e){e&&e.setZIndex&&e.setZIndex(t)})),this):this},n.addCoordinate=function(t){if(!this.isEnabled())return this;var e=this.getMap();if(!e)return this;t=new rs(t);var n=e._parseEventFromCoord(t);return this._clickHandler(n),this},n.getTempGeometry=function(){return this._geometry},e}(Pu);Ru.mergeOptions(Eu);var ku=function(t){function e(e){var n;return(n=t.call(this,e)||this).drawTool=new Ru({mode:"boxZoom",ignoreMouseleave:!1}),n}kt(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},n.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},n._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},n._boxZoom=function(t){var e=this.target;this.drawTool.remove();var n=t.geometry,r=n.getCenter(),i=n.getSymbol(),o=i.markerWidth,s=i.markerHeight,a=new As(r,e.locateByPoint(r,o,s),e.getProjection()),l=e.getFitZoom(a);e._animateTo({center:a.getCenter(),zoom:l})},e}(Bo);Ah.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),Ah.addOnLoadHook("addHandler","boxZoom",ku);var Lu=30,Du=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},n.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},n._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var{containerPoint:n}=t,r=e.getContainerExtent();if(r){var i,{x:o,y:s}=n,{xmax:a,ymax:l}=r;o<Lu&&(i=[Math.abs(o-Lu),0]),s<Lu&&(i=[0,Math.abs(s-Lu)]),o+Lu>a&&(i=[-Math.abs(o+Lu-a),0]),s+Lu>l&&(i=[0,-Math.abs(s+Lu-l)]),i&&e.panBy(i,{duration:1})}}},e}(Bo);function Nu(t,e){var n=t.bearing,r=e.getBearing();return!(r>=0&&n>180)&&!(r<=0&&n<-180)}function Fu(t,e){var n=t.bearing,r=e.getBearing();r>=0&&n<0&&(t.bearing=180-Math.abs(n)+180),r<=0&&n>0&&(t.bearing=-180-(180-Math.abs(n))),r>=0&&n>0&&(t.bearing=-180-(180-Math.abs(n))),r<=0&&n<0&&(t.bearing=180-Math.abs(n)+180)}function zu(t,e,n){return t*(1-n)+e*n}Ah.mergeOptions({autoPanAtEdge:!1}),Ah.addOnLoadHook("addHandler","autoPanAtEdge",Du),Ah.include({animateTo:function(t,e={},n){var r=this;(t=j({},this.getView(),t)).bearing=t.bearing%360,X(e)&&(n=e,e={}),e.counterclockwise&&Fu(t,this),Nu(t,this)&&this._validateView(t);var i=this.getProjection(),o=this.getView(),s={},a=!0;for(var l in t)if(Y(t,l)&&!U(t[l])&&("prjCenter"===l||!U(o[l])))if(a=!1,"center"===l){var h=new rs(o[l]),u=new rs(t[l]);h.equals(u)||(s.center=[h,u])}else if("prjCenter"===l){var c=new rs(this._getPrjCenter()),f=new rs(t[l]);c.equals(f)||(s.prjCenter=[c,f])}else o[l]!==t[l]&&"around"!==l&&(s[l]=[o[l],t[l]]);if(a)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var d=t.around||null,p=this._getRenderer(),g=this._animPlayer=kh.animate(s,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){p.callInNextFrame(t)},repeat:e.repeat},(function(t){if(r.isRemoved())g.finish();else{if("running"===g.playState){if(t.styles.center){var o=t.styles.center;r._setPrjCenter(i.project(o)),r.onMoving(r._parseEventFromCoord(r.getCenter()))}else if(t.styles.prjCenter){var a=t.styles.prjCenter;r._setPrjCenter(a),r.onMoving(r._parseEventFromCoord(r.getCenter()))}U(t.styles.zoom)||r.onZooming(t.styles.zoom,d),U(t.styles.pitch)||r._setPitch(t.styles.pitch),U(t.styles.bearing)||r._setBearing(t.styles.bearing),r._fireEvent("animating")}else"paused"===g.playState&&g!==r._mapAnimPlayer||(g._interupted||(s.center?r._setPrjCenter(i.project(s.center[1])):s.prjCenter&&r._setPrjCenter(s.prjCenter[1]),U(s.pitch)||r._setPitch(s.pitch[1]),U(s.bearing)||r._setBearing(s.bearing[1])),r._endAnim(g,s,d,e));n&&n(t)}}),this);return this._startAnim(s,d),g},_animateTo:function(t,e={},n){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,n),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(t,e={},n){var r=this;(t=j({},this.getView(),t)).bearing=t.bearing%360,e.counterclockwise&&Fu(t,this),Nu(t,this)&&this._validateView(t),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),X(e)&&(n=e,e={}),e=j({curve:1.42},e);var i=this;function o(t,e){return i.getResolution(e)/i.getResolution(t)}var s=t.around||new Vt(this.width/2,this.height/2),a=this.getMinZoom(),l=this.getMaxZoom(),h=this.getProjection(),u=this.getView(),c=u.zoom,f=u.bearing,d=u.pitch,p="zoom"in t?re(+t.zoom,a,l):c,g="bearing"in t?+t.bearing:f,m="pitch"in t?+t.pitch:d,A=h.project(t.center&&new rs(t.center)||this.getCenter()),y=o(p,c),v=h.project(this.getCenter()),x=A.sub(v),_=e.curve,b=Math.max(this.width,this.height),w=b/y,T=x.mag();if("minZoom"in e){var M=re(Math.min(e.minZoom,c,p),a,l),C=b/o(M,c);_=Math.sqrt(C/T*2)}var S=_*_;function I(t){var e=(w*w-b*b+(t?-1:1)*S*S*T*T)/(2*(t?w:b)*S*T);return Math.log(Math.sqrt(e*e+1)-e)}function P(t){return(Math.exp(t)-Math.exp(-t))/2}function E(t){return(Math.exp(t)+Math.exp(-t))/2}var O=I(0),R=function(t){return E(O)/E(O+_*t)},k=function(t){return b*((E(O)*(P(e=O+_*t)/E(e))-P(O))/S)/T;var e},L=(I(1)-O)/_;if(Math.abs(T)<1e-6||!isFinite(L)){if(Math.abs(b-w)<1e-6)return this.animateTo(t,e,n);var D=w<b?-1:1;L=Math.abs(Math.log(w/b))/_,k=function(){return 0},R=function(t){return Math.exp(D*_*t)}}var N=this._getRenderer(),F=this._animPlayer=kh.animate({k:[0,1]},{easing:e.easing||"out",duration:e.duration||8,framer:function(t){N.callInNextFrame(t)}},(function(i){if(r.isRemoved())F.finish();else{var o=i.styles.k,a=o*L,l=1/R(a),h={};if(t.center){var u=1===o?A:v.add(x.multi(k(a)));h.prjCenter=[A,u]}if(c!==p){var y=1===o?p:r.getZoomForScale(l,c,!0);h.zoom=[c,y]}if(d!==m){var _=zu(d,m,o);h.pitch=[m,_]}if(f!==g){var b=zu(f,g,o);h.bearing=[g,b]}if("running"===F.playState){if(h.prjCenter){var w=h.prjCenter;r._setPrjCenter(w[1]),r.onMoving(r._parseEventFromCoord(r.getCenter()))}h.zoom&&r.onZooming(h.zoom[1],s),h.pitch&&r._setPitch(h.pitch[1]),h.bearing&&r._setBearing(h.bearing[1]),r._fireEvent("animating")}else"paused"===F.playState&&F!==r._mapAnimPlayer||(F._interupted||(h.prjCenter&&r._setPrjCenter(h.prjCenter[1]),h.pitch&&r._setPitch(h.pitch[1]),h.bearing&&r._setBearing(h.bearing[1])),r._endAnim(F,h,s,e));n&&n(i)}}),{});return this._startAnim({center:t.center,zoom:t.zoom!==c,pitch:m!==d,bearing:g!==f},s),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,n,r){delete this._animRotating;var i,o=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)i=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(i));else if(e.prjCenter){var s;s=t._interupted?this._getPrjCenter():e.prjCenter[1];var a=this._parseEventFromCoord(this.getProjection().unproject(s));a.point2d=this._prjToPoint(s),this.onMoveEnd(a)}U(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom()):r.wheelZoom?this.onZooming(e.zoom[1],n):this.onZoomEnd(e.zoom[1])),o&&this._fireEvent(o),U(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),r.wheelZoom||this._resumePrev(t)},_startAnim:function(t,e){this._animPlayer&&((t.center||t.prjCenter)&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&(delete this._animRotating,"finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(t){if(this._prevAnimPlayer){var e=this._prevAnimPlayer;"paused"!==e.playState&&delete this._prevAnimPlayer,t!==e&&(this._animPlayer=e,e.play())}}});var Bu=[60,120];function Hu(t){t.stopPropagation(),t.preventDefault()}var ju,Uu,Vu,Gu,Wu=["dragstart","dragenter","dragend","dragleave","dragover"].join(" ").toString(),qu="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend drop ";function Xu(t,e,n){var r=e[0],i=e[1],o=e[2],s=1/(n[3]*r+n[7]*i+n[11]*o+n[15]);return t[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])*s,t[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])*s,t[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])*s,t}Ah.include({_registerDomEvents:function(){var t=this._panels.mapWrapper||this._containerDOM;tn(t,qu,this._handleDOMEvent,this),tn(t,Wu,Hu,this)},_removeDomEvents:function(){var t=this._panels.mapWrapper||this._containerDOM;en(t,qu,this._handleDOMEvent),en(t,Wu,Hu)},_handleDOMEvent:function(t){if(t&&"drop"===t.type){t.stopPropagation(),t.preventDefault();var e=this._parseEvent(t,t.type);return e=j({},e,{dataTransfer:t.dataTransfer}),void this._fireEvent(t.type,e)}var n=this.options.clickTimeThreshold,r=t.type;if(!An(r)||B.isTest||!yn(this,this.options.mousemoveThrottleTime)){var i="mousedown"===r||"touchstart"===r&&(!t.touches||1===t.touches.length);i&&(this._domMouseDownTime=H(),this._domMouseDownView=this.getView());var o="contextmenu"===r&&function(t){if(!t._domMouseDownView)return!0;var e=t.getView(),n=t._domMouseDownView;return e.bearing!==n.bearing||e.pitch!==n.pitch}(this);if("contextmenu"===r){rn(t);var s=this._domMouseDownTime;H()-s<=n&&!o&&this._fireDOMEvent(this,t,"dom:"+t.type)}else this._fireDOMEvent(this,t,"dom:"+t.type);if(!this._ignoreEvent(t)){var a,l=!1;if(i)this._mouseDownTime=H();else if("click"===r||"touchend"===r||"contextmenu"===r){if(!this._mouseDownTime)return;var h=this._mouseDownTime;if(delete this._mouseDownTime,H()-h>n){if("click"===r||"contextmenu"===r)return}else if("contextmenu"===r){if(o)return}else"touchend"===r&&(l=!0)}l&&(this._clickTime&&H()-this._clickTime<=n?(delete this._clickTime,a="dblclick",this._fireDOMEvent(this,t,"dom:dblclick")):(this._clickTime=H(),a="click",this._fireDOMEvent(this,t,"dom:click"))),this._ignoreEvent(t)||(this._fireDOMEvent(this,t,r),a&&this._fireDOMEvent(this,t,a))}}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;var e,n=t.srcElement||t.target;if(n)for(;n&&n!==this._containerDOM;){if(n.className&&n.className.indexOf&&(n.className.indexOf("maptalks-control")>=0||n.className.indexOf("maptalks-ui")>=0&&e&&!e.eventsPropagation))return!0;e=n,n=n.parentNode}return!1},_isEventOutMap:function(t){var e=ln(this._getActualEvent(t),this._containerDOM);return this._isContainerPointOutOfMap(e)},_isContainerPointOutOfMap:(ju=[0,0,0],Uu=[0,0,0],Vu=new pi(ju,Uu),Gu=[0,0,0],function(t){var e=this.getPitch();if(e>Bu[0]&&e<Bu[1]){if(this.getContainerPointRay(ju,Uu,t,0,.5),Vu.setFromTo(ju,Uu),!Vu.intersectGround(Gu))return!0;if(Vu.distanceToGround()<=0)return!0}return!1}),_wrapTerrainData:function(t){t.containerPoint&&!t.terrain&&(t.terrain=this._queryTerrainInfo(t.containerPoint))},_parseEvent:function(t,e){if(!t)return null;var n={domEvent:t};if("keypress"!==e){var r=this._getActualEvent(t);if(r&&void 0!==r.clientX){var i=ln(r,this._containerDOM);n=j(n,{containerPoint:i,viewPoint:this.containerPointToViewPoint(i)}),this._isContainerPointOutOfMap(i)||(n=j(n,{coordinate:this.containerPointToCoord(i),point2d:this._containerPointToPoint(i)}))}}return this._wrapTerrainData(n),n},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,n){var r=this;if(!this.isRemoved()){var i=this._parseEvent(e,n);this._wrapTerrainData(i),An(n)?this.getRenderer().callInNextFrame((function(){i.domEvent&&i.domEvent._cancelBubble?r._fireEvent("_"+n,i):r._fireEvent(n,i)})):this._fireEvent(n,i)}},_getEventParams:function(t){var e=this,n={domEvent:t},r=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(r){var i=ln(r,e.getContainer());n.coordinate=e.containerPointToCoordinate(i),n.containerPoint=i,n.viewPoint=e.containerPointToViewPoint(i),n.point2d=e._containerPointToPoint(i)}return this._wrapTerrainData(n),n}}),Ah.addOnLoadHook("_registerDomEvents"),Ah.include({isFullScreen:function(){var t=document;return!!(t.webkitIsFullScreen||t.mozFullScreen||t.msFullscreenElement||t.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){var t=document;if(document.exitFullscreen)document.exitFullscreen();else if(t.mozCancelFullScreen)t.mozCancelFullScreen();else if(t.webkitCancelFullScreen)t.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),Ah.include({panTo:function(t,e={},n){if(!t)return this;if(X(e)&&(n=e,e={}),t=new rs(t),void 0===e.animation||e.animation){var r=this.getProjection().project(t);return this._panAnimation(r,e.duration,n)}return this.setCenter(t),this},_panTo:function(t,e={}){return void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e={},n){if(!t)return this;if(X(e)&&(n=e,e={}),t=new Vt(t),this.getContainerExtent().ymin>0&&t.y>30){var r=t.y;t.y=30,t.x=30*t.x/r,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(void 0===e.animation||e.animation){t=t.multi(-1);var i=this._containerPointToPrj(new Vt(this.width/2+t.x,this.height/2+t.y));this._panAnimation(i,e.duration,n)}else{this.onMoveStart(),this._offsetCenterByPixel(t);var o=this.containerPointToCoord(new Vt(this.width/2,this.height/2));this.onMoveEnd(this._parseEventFromCoord(o))}return this},_panAnimation:function(t,e,n){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},n)}}),Ah.include({computeLength:function(t,e){if(!this.getProjection())return null;var n=new rs(t),r=new rs(e);return n.equals(r)?0:this.getProjection().measureLength(n,r)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){var n=new rs((t=t||{}).coordinate);return this._identify(t,e,(function(e){return e.identify(n,t)}))},identifyAtPoint:function(t,e){var n=t.includeInternals,r=t.tolerance,i=new Vt((t=t||{}).containerPoint),o=this.containerPointToCoord(i);return this._identify(t,e,(function(e){var i,s=t.containerPoint;if(n&&!U(e.options.geometryEventTolerance)&&(t.tolerance=t.tolerance||0,t.tolerance+=e.options.geometryEventTolerance),e._hasGeoListeners&&n&&t.eventTypes.indexOf("mousemove")>=0&&!e._hasGeoListeners(t.eventTypes))return[];(i=e.identifyAtPoint?e.identifyAtPoint(s,t):o&&e.identify?e.identify(o,t):[],n&&(U(r)?delete t.tolerance:t.tolerance=r),i&&i.length)||(e.fire("identifyempty",t),e.getLayers&&X(e.getLayers)&&(e.getLayers()||[]).filter((function(t){return t})).forEach((function(e){e.fire("identifyempty",t)})));return i}))},_identify:function(t,e,n){var r=t.layers;if(!ie(r))return this;for(var i=t.eventTypes,o=[],s=0,a=r.length;s<a;s++)q(r[s])?o.push(this.getLayer(r[s])):o.push(r[s]);i&&(o=o.filter((function(t){return!t._hasGeoListeners||t._hasGeoListeners(i)})));for(var l=[],h=o.length-1;h>=0&&!(t.count&&l.length>=t.count);h--){var u=o[h];if(u&&u.getMap()&&(t.includeInvisible||u.isVisible())&&(t.includeInternals||!(u.getId().indexOf(xe)>=0))){var c=n(u),f=u.getId();if(c)if(Array.isArray(c)){for(var d=0;d<c.length;d++)c[d]&&!c[d].getLayer&&U(c[d].layer)&&(c[d].layer=f);Jt(l,c)}else!c.getLayer&&U(c.layer)&&(c.layer=f),l.push(c)}}return e.call(this,l),this}}),Ah.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,n){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,n)))},_checkZoomOrigin:function(t){return(!t||this.options.zoomInCenter||this._isContainerPointOutOfMap(t))&&(t=new Vt(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new Vt(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,n){U(n)&&(n=1);var r=this._getResolution(this._startZoomVal)/this._getResolution(t),i=this.options.zoomAnimationDuration*Math.abs(r-n)/Math.abs(r-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:i})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),delete this.cameraZenithDistance,this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=e&&this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,n){if(this.options.zoomable&&this._frameZoom!==t){U(n)&&(n=1),this._zoomTo(t,e);var r=this.getResolution(t),i=this.getResolution(this._startZoomVal)/r/n,o=this._startZoomCoord&&this.prjToContainerPoint(this._startZoomCoord,this._startZoomVal),s=this.getViewPoint();if(!this.isRotating()&&o&&!o.equals(e)&&1!==i){var a=this.getPitch(),l=o._sub(e)._multi(1/(1-i));a&&(l.y/=Math.cos(a*Math.PI/180)),e=e.add(l)}var h=e&&e.x||this.width/2,u=e&&e.y||this.height/2,c={view:[i,0,0,i,(h-s.x)*(1-i),(u-s.y)*(1-i)]},f=this.getDevicePixelRatio();c.container=[i,0,0,i,h*f*(1-i),u*f*(1-i)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:new Vt(h,u),matrix:c}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var n=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._suppressRecenter||this._recenterOnTerrain(),this._fireEvent("zoomend",{from:n,to:t}),this._verifyExtent(this._getPrjCenter())||this.options.limitExtentOnMaxExtent||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){if(this._zoomLevel=t,this._calcMatrices(),e&&this._startZoomCoord){var n=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter()));this._setPrjCoordAtOffsetToCenter(this._startZoomCoord,n)}},_checkZoom:function(t){var e=this.getMaxZoom(),n=this.getMinZoom();return t<n&&(t=n),t>e&&(t=e),t}});var Zu,Yu,Ju,Qu,Ku=Math.PI/180,$u=new rs(0,0),tc=new Vt(0,0),ec=[0,-1,0],nc=[];function rc(){return Pr(new Array(16))}Ah.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/Ku},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*Ku,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/Ku:0},setBearing:function(t){var e={bearing:t};return this._validateView(e),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(e.bearing)},_setBearing:function(t){if(Pt.ie9)throw new Error("map can't rotate in IE9.");var e=-ne(t,-180,180)*Ku;if(this._angle===e)return this;var n=this.getBearing();return this._fireEvent("rotatestart",{from:n,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:n,to:e}),this._fireEvent("rotateend",{from:n,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){var e={pitch:t};return this._validateView(e),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(e.pitch)},_setPitch:function(t){if(Pt.ie9)throw new Error("map can't tilt in IE9.");var e=re(t,0,this.options.maxPitch)*Ku;if(this._pitch===e)return this;var n=this.getPitch();return this._fireEvent("pitchstart",{from:n,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:n,to:e}),this._fireEvent("pitchend",{from:n,to:e}),this},setCameraMovements:function(t,e){var n=this;if(!Array.isArray(t)||!t.length)return this;if(t.forEach((function(t){n._validateView(t)})),this.setView({center:t[0].center,zoom:t[0].zoom,pitch:t[0].pitch,bearing:t[0].bearing}),1===t.length)return this;var r=1,i=function(o){if("finished"===o.state.playState){++r===t.length-1&&(i=null);var s=t[r];s.duration=s.timestamp-t[r-1].timestamp,e&&e.autoRotate&&(s.bearing=(a=t[r-1].center,l=s.center,h=Q(a[0]),u=Q(l[0]),c=Q(a[1]),f=Q(l[1]),d=Math.sin(u-h)*Math.cos(f),p=Math.cos(c)*Math.sin(f)-Math.sin(c)*Math.cos(f)*Math.cos(u-h),K(Math.atan2(d,p)))),n._setCameraMovement(s,i)}var a,l,h,u,c,f,d,p};2===t.length&&(i=null);var o=this.getBearing();this._setCameraMovement(Object.assign({bearing:o,duration:t[r].timestamp-t[r-1].timestamp},t[r]),i);return{play:function(){n._animPlayer.play()},pause:function(){n._animPlayer.pause()},cancel:function(){n._animPlayer.cancel()},finish:function(){n._animPlayer.finish()},reverse:function(){n._animPlayer.reverse()}}},_setCameraMovement:function(t,e){this.animateTo({zoom:t.zoom,center:t.center,pitch:t.pitch,bearing:t.bearing},{duration:t.duration,easing:"out"},e)},setCameraOrientation:function(t){var{position:e}=t;this._validateView(t);var{pitch:n,bearing:r}=t;n=n||0,r=r||0;var{zoom:i,cameraToGroundDistance:o}=this.getFitZoomForCamera(e,n),s=Math.sin(n*Ku)*o,a=ne(r,-180,180)*Ku,l=this.getGLRes(),h=new rs(e[0],e[1]),u=this.coordToPointAtRes(h,l),c=new Vt(0,0);c.x=u.x+s*Math.sin(a),c.y=u.y+s*Math.cos(a);var f=this._pointToPrjAtRes(c,this.getGLRes());return this._setPrjCenter(f),this.setView({bearing:r,pitch:n,zoom:i}),this},setCameraPosition:function(t){var e=this.getGLRes(),n=this.coordToPointAtRes(t,e);n.z=this.altitudeToPoint(t.z||0,e);var r=this.getCenter(),i=this.coordToPointAtRes(r,e);i.z=this.altitudeToPoint(r.z,e);var o=Qr([],n.toArray(),i.toArray());Yr(this.cameraUp||[0,0,0],0,0,1),this._pitch=oi(o,this.cameraUp),Yr(nc,o[0],o[1],0),this._angle=-oi(nc,ec),this._zoomLevel=this.getFitZoomForCamera(t,this._pitch).zoom,this._calcMatrices()},getFitZoomForCamera:function(t,e){var n=(Array.isArray(t)?t[2]:t.z)*this._meterToGLPoint,r=(this.centerAltitude||0)*this._meterToGLPoint,i=e*Ku,o=(n-r)/Math.cos(i),s=o+r;return{zoom:this.getFitZoomForAltitude(s),cameraToGroundDistance:o}},getFitZoomForAltitude:function(t){for(var e=t*this._getFovRatio()*2/(this.height||1)*this.getGLRes(),n=this._getResolutions(),r=0;r<n.length-1;r++){if(n[r]===e)return r;if(n[r+1]===e)return r+1;if(e<n[r]&&e>n[r+1])return(r=(e-n[r])/(n[r+1]-n[r])+r)-1}return r},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,n=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return n;e=Math.PI*e/180;var r=new Vt(this.cameraPosition).distanceTo(new Vt(this.cameraLookAt)),i=n*Math.tan(2*e);return n+Math.tan(e)*(r+i)},_pointToContainerPoint:function(t,e,n=0,r){var i=this._getResolution(e);return this._pointAtResToContainerPoint(t,i,n,r)},_pointAtResToContainerPoint:function(t,e,n=0,r){r||(r=new Vt(0,0)),t=this._pointAtResToPoint(t,e,r);var i,o=this.isTransforming();return o||n||(i=this._prjToPoint(this._getPrjCenter(),void 0,$u)),this._toContainerPoint(r,o,n,i),r},_pointsAtResToContainerPoints:function(t,e,n=[],r=[]){var i=this.getPitch(),o=this.getBearing(),s=e/this._getResolution();if(0===i&&0===o&&!function(t){if(V(t))return 0!==t;if(Array.isArray(t)&&t.length>0)for(var e=0,n=t.length;e<n;e++)if(V(t[e])&&0!==t[e])return!0;return!1}(n)){var{xmin:a,ymin:l,xmax:h,ymax:u}=this.get2DExtent();if(h>a&&u>l){for(var{width:c,height:f}=this.getSize(),d=(h-a)/c,p=(u-l)/f,g=0,m=t.length;g<m;g++)if(t[g]){var A=r[g];A.x=t[g].x,A.y=t[g].y,A._multi(s),A.x=(A.x-a)*d,A.y=f-(A.y-l)*p}else r[g]=null;return r}}for(var y=Array.isArray(n),v=this.isTransforming(),x=this._prjToPoint(this._getPrjCenter(),void 0,$u),_=0,b=t.length;_<b;_++)if(t[_]){var w=r[_];w.x=t[_].x,w.y=t[_].y,w._multi(s);var T=y?n[_]||0:n;this._toContainerPoint(w,v,T,x)}else r[_]=null;return r},_toContainerPoint:function(){var t=[0,0,0];return function(e,n,r,i){var o=this.width/2,s=this.height/2;if(n||r){this._altitudeScale||(this._altitudeScale=this.altitudeToPoint(100,this.getGLRes())/100);var a=this._glScale;Yr(t,e.x*a,e.y*a,r*this._altitudeScale);var l=this._projIfBehindCamera(t,this.cameraPosition,this.cameraForward);Xu(l,l,this.projViewMatrix),e.x=l[0]*o+o,e.y=-l[1]*s+s}else e._sub(i.x,i.y),e.set(e.x,-e.y),e._add(o,s)}}(),_projIfBehindCamera:(Yu=new Array(3),Ju=new Array(3),Qu=new Array(3),function(t,e,n){Qr(Yu,t,e);var r=ei(n,Yu);return r<=0&&(ni(Ju,n,1.01*r),Jr(t,e,Qr(Qu,Yu,Ju))),t}),_containerPointToPoint:function(t,e,n,r){var i=this._getResolution(e);return this._containerPointToPointAtRes(t,i,n,r)},_containerPointToPointAtRes:function(){var t=[0,0,0],e=[0,0,0];return function(n,r,i,o){if(this.isTransforming()){this.getContainerPointRay(t,e,n);var s=t[0],a=e[0],l=t[1],h=e[1],u=t[2],c=e[2],f=o?this.altitudeToPoint(o,r)*this._glScale:0,d=u===c?f:(f-u)/(c-u),p=ee(s,a,d),g=ee(l,h,d);return i?(i.x=p,i.y=g):i=new Vt(p,g),i._multi(1/this._glScale),this._getResolution()===r?i:this._pointToPointAtRes(i,r,i)}var m=this._prjToPointAtRes(this._getPrjCenter(),r,i),A=this._getResolution()/r,y=A*(n.x-this.width/2),v=A*(n.y-this.height/2);return m._add(y,-v)}}(),getContainerPointRay:function(){var t=[0,0,0],e=[0,0,0,1],n=[0,0,0,1];return function(r,i,o,s=0,a=1){var l=this.width/2||1,h=this.height/2||1,u=o;Yr(t,(u.x-l)/l,(h-u.y)/h,0),Yr(e,t[0],t[1],s),Yr(n,t[0],t[1],a),e[3]=n[3]=1,Xu(r,e,this.projViewMatrixInverse),Xu(i,n,this.projViewMatrixInverse)}}(),_calcMatrices:(Zu=rc(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,n=t.height||1;this._glScale=this.getGLScale();var r=this._getCameraWorldMatrix(),i=this.getFov()*Math.PI/180,o=this._getCameraFar(i,this.getPitch());this.cameraFar=o,this.cameraNear=this.cameraCenterDistance/20;var s=this.projMatrix||rc();Tr(s,i,e/n,this.cameraNear,o),this.projMatrix=s,this.viewMatrix=Ir(this.viewMatrix||rc(),r),this.projViewMatrix=Sr(this.projViewMatrix||rc(),s,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=Sr(this.projViewMatrixInverse||rc(),r,Ir(Zu,s)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this.get2DExtent(),this._mapGlExtent2D=this.get2DExtentAtRes(this._mapGlRes)}),_getCameraFar:function(t,e){var n=this.cameraCenterDistance=ii(this.cameraPosition,this.cameraLookAt),r=n/this._meterToGLPoint;e=(e=Math.min(e,85))*Math.PI/180;var i=r+this.options.cameraFarUndergroundInMeter/Math.cos(e);return Math.max(i*this._meterToGLPoint,5*n)},_calcCascadeMatrixes:function(){var t=rc();function e(e,n,r){var i=this.width,o=this.height,s=this.getFov()*Math.PI/180,a=this._getCameraFar(s,n),l=this.cameraCenterDistance;a=l+(a-l)/Math.cos((90-n)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),Tr(t,s,i/o,.1,a);var h=this.viewMatrix;return Sr(r,t,h)}return function(){var t=this.getPitch(),n=this.options.cascadePitches[0],r=this.options.cascadePitches[1],i=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||rc(),o=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||rc();t>n?e.call(this,t,n,i):Er(this.cascadeFrustumMatrix0,this.projViewMatrix),t>r?e.call(this,t,r,o):Er(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var t=rc(),e=rc(),n=[1,-1,1],r=[0,0,0];return function(){var i=this.width||1,o=this.height||1,s=.5/Math.tan(this._fov/2)*o;return Cr(t,this.projMatrix,n),Mr(t,t,Yr(r,0,0,-s)),this._pitch&&function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[4],s=e[5],a=e[6],l=e[7],h=e[8],u=e[9],c=e[10],f=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+h*r,t[5]=s*i+u*r,t[6]=a*i+c*r,t[7]=l*i+f*r,t[8]=h*i-o*r,t[9]=u*i-s*r,t[10]=c*i-a*r,t[11]=f*i-l*r}(t,t,this._pitch),this._angle&&function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],s=e[1],a=e[2],l=e[3],h=e[4],u=e[5],c=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+h*r,t[1]=s*i+u*r,t[2]=a*i+c*r,t[3]=l*i+f*r,t[4]=h*i-o*r,t[5]=u*i-s*r,t[6]=c*i-a*r,t[7]=f*i-l*r}(t,t,this._angle),Pr(e),Cr(e,e,Yr(r,i/2,-o/2,1)),Sr(this.domCssMatrix||rc(),e,t)}}(),_getFovZ:function(t){var e=this.getGLScale(t),n=this._getFovRatio();return e*(this.height||1)/2/n},_getCameraWorldMatrix:function(){var t={};return function(){var e=this.getGLRes();this._meterToGLPoint||(this._meterToGLPoint=this.distanceToPointAtRes(100,0,e).x/100);var n=this._prjToPointAtRes(this._prjCenter,e,tc),r=this.getCenter().z,i=(void 0!==r?r:this.centerAltitude||0)*this._meterToGLPoint;this.cameraLookAt=Yr(this.cameraLookAt||[0,0,0],n.x,n.y,i);var o=this.getPitch()*Ku,s=this.getBearing()*Ku,a=this._getFovZ(),l=(void 0===this.cameraZenithDistance?a:this.cameraZenithDistance)-i,h=l*Math.cos(o),u=Math.sin(o)*l,c=n.x-u*Math.sin(s),f=n.y-u*Math.cos(s);this.cameraPosition=Yr(this.cameraPosition||[0,0,0],c,f,h+i),this.cameraToCenterDistance=a,this.cameraUp=this.cameraUp||[0,0,0],this.cameraUp=this._getCameraUp(this.cameraUp,this.cameraLookAt,this.cameraPosition,o,s);var d,p,g,m,A,y,v,x=this.cameraWorldMatrix=this.cameraWorldMatrix||rc();d=x,p=this.cameraPosition,g=this.cameraLookAt,m=this.cameraUp,A=[0,0,0],y=[0,0,0],Qr(v=[0,0,0],p,g),0===$r(v)&&(v[2]=1),ti(v,v),ri(A,m,v),0===$r(v)&&(1===Math.abs(m[2])?v[0]+=1e-4:v[2]+=1e-4,ti(v,v),ri(A,m,v)),ti(A,A),ri(y,v,A),d[0]=A[0],d[4]=y[0],d[8]=v[0],d[1]=A[1],d[5]=y[1],d[9]=v[1],d[2]=A[2],d[6]=y[2],d[10]=v[2];var _=this.cameraForward||[0,0,0];return Qr(_,this.cameraLookAt,this.cameraPosition),this.cameraForward=ti(_,_),function(t,e){var n,r=e[0],i=e[4],o=e[8],s=e[1],a=e[5],l=e[9],h=e[2],u=e[6],c=e[10],f=r+a+c;f>0?(n=.5/Math.sqrt(f+1),t.w=.25/n,t.x=(u-l)*n,t.y=(o-h)*n,t.z=(s-i)*n):r>a&&r>c?(n=2*Math.sqrt(1+r-a-c),t.w=(u-l)/n,t.x=.25*n,t.y=(i+s)/n,t.z=(o+h)/n):a>c?(n=2*Math.sqrt(1+a-r-c),t.w=(o-h)/n,t.x=(i+s)/n,t.y=.25*n,t.z=(l+u)/n):(n=2*Math.sqrt(1+c-r-a),t.w=(s-i)/n,t.x=(o+h)/n,t.y=(l+u)/n,t.z=.25*n)}(t,x),function(t,e){var n=t,r=e.x,i=e.y,o=e.z,s=e.w,a=r+r,l=i+i,h=o+o,u=r*a,c=r*l,f=r*h,d=i*l,p=i*h,g=o*h,m=s*a,A=s*l,y=s*h;n[0]=1-(d+g),n[4]=c-y,n[8]=f+A,n[1]=c+y,n[5]=1-(u+g),n[9]=p-m,n[2]=f-A,n[6]=p+m,n[10]=1-(u+d),n[3]=0,n[7]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}(x,t),function(t,e){var n=t;n[12]=e[0],n[13]=e[1],n[14]=e[2]}(x,this.cameraPosition),x}}(),_getCameraUp:function(){var t=[0,0,0],e=[0,0,0],n=[0,0,0];return function(r,i,o,s,a){Yr(n,0,0,1),0===s?Yr(n,Math.sin(a),Math.cos(a),0):s===Math.PI&&Yr(n,-Math.sin(a),-Math.cos(a),0);var l=Qr(t,i,o);ti(l,l);var h=ri(e,l,n);return ri(r,h,l)}}(),updateCenterAltitude:function(){this.getRenderer().setToRedraw(),!this.centerAltitude&&this._hasAltitudeLayer()&&(this.centerAltitude=0),this._recenterOnTerrain()},_recenterOnTerrain:function(){if(void 0!==this.centerAltitude&&void 0===this._centerZ){var t=this._queryTerrainByProjCoord(this._prjCenter);U(t)&&this._hasAltitudeLayer()&&(t=this.centerAltitude);var e=t||0,n=this.getPitch()*Ku,r=this.getBearing()*Ku,i=(e-this.centerAltitude)*this._meterToGLPoint,o=this._getFovZ(),s=(void 0===this.cameraZenithDistance?o:this.cameraZenithDistance)-this.centerAltitude*this._meterToGLPoint-i/Math.cos(n),a=this.cameraPosition,l=Math.sin(n)*s,h=tc;h.x=a[0]+l*Math.sin(r),h.y=a[1]+l*Math.cos(r);var u=e*this._meterToGLPoint;this.cameraZenithDistance=(a[2]-u)/Math.cos(n)+u,this.centerAltitude=e;var c=this.pointAtResToCoordinate(h,this.getGLRes(),$u);this._eventSilence=!0,this._suppressRecenter=!0,this.setCenter(c),delete this._suppressRecenter,delete this._eventSilence,U(t)&&delete this.centerAltitude}},_queryTerrainByProjCoord:function(t){for(var e=this._getLayers(),n=0;n<e.length;n++)if(e[n].queryTerrainByProjCoord)return e[n].queryTerrainByProjCoord(t)[0];return 0},_hasAltitudeLayer:function(){for(var t=this._getLayers(),e=0;e<t.length;e++)if(t[e].getTerrainLayer&&t[e].getTerrainLayer())return!0;return!1},_queryTerrainInfo:function(t){for(var e=this._getLayers()||[],n=0;n<e.length;n++){var r=e[n];if(t&&r&&r.queryTerrainAtPoint&&r.getTerrainLayer&&r.getTerrainLayer()){var i=r.queryTerrainAtPoint(t);if(i)return{coordinate:i,altitude:i.z};break}}return null},_query3DTilesInfo:function(t){for(var e=this._getLayers()||[],n=0;n<e.length;n++){var r=e[n];if(t&&r&&r.query3DTilesAtPoint){var i=r.query3DTilesAtPoint(t);if(i)return{coordinate:i,altitude:i.z};break}}return null},queryPrjCoordAtContainerPoint:function(t){var e=this._query3DTilesInfo(t);if(e||(e=this._queryTerrainInfo(t)),e){var n=this.getProjection().project(e.coordinate);return n.z=e.altitude,n}return this._isContainerPointOutOfMap(t)&&(t=new Vt(this.width/2,this.height/2)),this._containerPointToPrj(t)},_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*Ku)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}}))}}),Ah.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),n=this._viewHistory.length-1;n>=0;n--)if(fe(t,this._viewHistory[n]))return this._viewHistoryPointer=n,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var r=this.options.viewHistoryCount;r>0&&this._viewHistory.length>r&&this._viewHistory.splice(0,this._viewHistory.length-r),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t={}){if(!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t={}){if(!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var n=this,r=this.getView();e.animation?this._animateTo(t,{duration:e.duration},(function(e){"finished"===e.state.playState&&n._fireViewChange(r,t)})):(this.setView(t),this._fireViewChange(r,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e}),this._insertUICollidesQueue()},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),Ah.mergeOptions({viewHistory:!0,viewHistoryCount:10});var ic=new co;Ah.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new co,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this},_insertUICollidesQueue:function(){return this._uiCollidesQueue||(this._uiCollidesQueue=[]),this._uiCollidesQueue.push(1),this},uiCollides:function(){if(!this.uiList||0===this.uiList.length||!this._uiCollidesQueue||0===this._uiCollidesQueue.length)return this;var t=ic;t.clear();for(var e=this.uiList,n=0,r=e.length;n<r;n++){var i=e[n],{collisionBufferSize:o,collision:s}=i.options;if(s){var a=i.getDOM();if(i.isVisible()&&a&&a.getBoundingClientRect){i.bbox||(i.bbox=[0,0,0,0]);var l=a.getBoundingClientRect(),{x:h,y:u}=l,{width:c,height:f}=l;if(0===c||0===f){var d=i.getSize();d&&(c=d.width,f=d.height)}var p=h-o,g=h+c+o,m=u-o,A=u+f+o;i.bbox[0]=p,i.bbox[1]=m,i.bbox[2]=g,i.bbox[3]=A,t.collides(i.bbox)?i._collidesEffect(!1):(t.insertBox(i.bbox),i._collidesEffect(!0))}}}return this._uiCollidesQueue=[],this},_addUI:function(t){return this.uiList||(this.uiList=[]),this.uiList.indexOf(t)>-1||(this.uiList.push(t),this.uiList=this.uiList.sort((function(t,e){return e.options.collisionWeight-t.options.collisionWeight}))),this},_removeUI:function(t){if(!this.uiList)return-1;var e=this.uiList.indexOf(t);return e<0||this.uiList.splice(e,1),e}});var oc,sc,ac,lc,hc,uc,cc,fc,dc,pc=new rs(0,0);Ah.include({coordinateToPoint:function(t,e,n){var r=this._getResolution(e);return this.coordinateToPointAtRes(t,r,n)},coordinateToPointAtRes:(dc=new rs(0,0),function(t,e,n){var r=this.getProjection().project(t,dc);return this._prjToPointAtRes(r,e,n)}),pointToCoordinate:function(){var t=new rs(0,0);return function(e,n,r){var i=this._pointToPrj(e,n,t);return this.getProjection().unproject(i,r)}}(),pointAtResToCoordinate:function(){var t=new rs(0,0);return function(e,n,r){var i=this._pointToPrjAtRes(e,n,t);return this.getProjection().unproject(i,r)}}(),coordinateToViewPoint:function(){var t=new rs(0,0);return function(e,n,r){return this._prjToViewPoint(this.getProjection().project(e,t),n,r)}}(),viewPointToCoordinate:function(){var t=new rs(0,0);return function(e,n){return this.getProjection().unproject(this._viewPointToPrj(e,t),n)}}(),coordinateToContainerPoint:function(t,e,n){var r=this._getResolution(e);return this.coordinateToContainerPointAtRes(t,r,n)},coordinateToContainerPointAtRes:function(){var t=new rs(0,0);return function(e,n,r){var i=this.getProjection().project(e,t);return this._prjToContainerPointAtRes(i,n,r)}}(),coordinatesToContainerPoints:function(t,e){var n=this._getResolution(e);return this.coordinatesToContainerPointsAtRes(t,n)},coordinatesToContainerPointsAtRes:function(){return function(t,e){for(var n=[],r=this._spatialReference.getTransformation(),i=e/this._getResolution(),o=this.getProjection(),s=new rs(0,0),a=this.isTransforming(),l=this._prjToPoint(this._getPrjCenter(),void 0,pc),h=0,u=t.length;h<u;h++){var c=o.project(t[h],s),f=r.transform(c,e);f=f._multi(i),this._toContainerPoint(f,a,t[h].z,l),n.push(f)}return n}}(),containerPointToCoordinate:function(){var t=new rs(0,0);return function(e,n){var r=this._containerPointToPrj(e,t);return this.getProjection().unproject(r,n)}}(),containerToExtent:(cc=new Vt(0,0),fc=new Vt(0,0),function(t){var e=new vs(this._containerPointToPoint(t.getMin(cc),void 0,cc),this._containerPointToPoint(t.getMax(fc),void 0,fc));return this._pointToExtent(e)}),distanceToPixel:function(){var t=new Vt(0,0),e=new Vt(0,0);return function(n,r,i){var o=this.getProjection();if(!o)return null;var s=this.getScale()/this.getScale(i),a=this.getCenter(),l=o.locate(a,n,r),h=this.coordToContainerPoint(a,void 0,t),u=this.coordToContainerPoint(l,void 0,e);return u._sub(h)._multi(s)._abs(),new Ie(u.x,u.y)}}(),distanceToPoint:function(t,e,n,r){var i=this._getResolution(n);return this.distanceToPointAtRes(t,e,i,r)},distanceToPointAtRes:function(){var t=new Vt(0,0),e=new rs(0,0);return function(n,r,i,o,s){var a=this.getProjection();if(!a)return null;var l=o||this.getCenter(),h=a.locate(l,n,r,e),u=this.coordToPointAtRes(l,i,t),c=this.coordToPointAtRes(h,i,s);return c._sub(u)._abs(),c}}(),altitudeToPoint:(hc=new rs(0,40),uc=new Vt(0,0),function(t=0,e,n){this._altitudeOriginDirty&&(hc.x=this._originLng,this._altitudeOriginDirty=!1);var r=this.distanceToPointAtRes(t,t,e,n||hc,uc);t<0&&r.x>0&&(r.x=-r.x);var i=this.options.heightFactor;return i&&1!==i&&(r.x*=i,r.y*=i),r.x}),pointAtResToAltitude:function(){var t=new rs(0,40);return function(e=0,n,r){return this.pointAtResToDistance(e,0,n,r||t)}}(),pixelToDistance:(oc=new rs(0,0),sc=new rs(0,0),ac=new rs(0,0),lc=new rs(0,0),function(t,e){var n=this.getProjection();if(!n)return null;var r=this.getFullExtent(),i=r.top>r.bottom?-1:1,o=oc.set(this.width/2,this.height/2),s=sc.set(this.width/2+t,this.height/2+i*e),a=this.containerPointToCoord(o,ac),l=this.containerPointToCoord(s,lc);return n.measureLength(a,l)}),pointToDistance:function(t,e,n){var r=this.getResolution(n);return this.pointAtResToDistance(t,e,r)},pointAtResToDistance:function(){var t=new Vt(0,0),e=new rs(0,0),n=new rs(0,0),r=new rs(0,0);return function(i,o,s,a){var l=this.getProjection();if(!l)return null;var h=a?l.project(a,e):this._getPrjCenter(),u=this._prjToPointAtRes(h,s,t);u._add(i,o);var c=this.pointAtResToCoord(u,s,n),f=a||l.unproject(h,r);return l.measureLength(f,c)}}(),locateByPoint:function(){var t=new Vt(0,0);return function(e,n,r){var i=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(i._add(n,r))}}(),_get2DExtent:function(t,e){var n;if(void 0!==t&&t!==this._zoomLevel||!this._mapExtent2D||(n=this._mapExtent2D),n)return e?(e.set(n.xmin,n.ymin,n.xmax,n.ymax),e):n.copy();var r=this._getResolution(t);return this._get2DExtentAtRes(r,e)},get2DExtent:function(t,e){return this._get2DExtent(t,e)},_get2DExtentAtRes:function(){var t=new Vt(0,0);return function(e,n){var r=this;return e===this._mapGlRes&&this._mapGlExtent2D?this._mapGlExtent2D:this.getContainerExtent().convertTo((function(n){return r._containerPointToPointAtRes(n,e,t)}),n)}}(),get2DExtentAtRes:function(t,e){return this._get2DExtentAtRes(t,e)},pointToExtent:function(t){return this._pointToExtent(t)},_pointToExtent:function(){var t=new rs(0,0),e=new rs(0,0);return function(n){var r=n.getMin(),i=n.getMax(),o=this.getFullExtent(),[s,a]=!o||o.left<=o.right?[r.x,i.x]:[i.x,r.x],[l,h]=!o||o.top>o.bottom?[i.y,r.y]:[r.y,i.y],u=r.set(s,h),c=i.set(a,l);return new As(this.pointToCoord(u,void 0,t),this.pointToCoord(c,void 0,e),this.getProjection())}}(),getViewPointFrameOffset:function(){var t=new Vt(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new Vt(0,0);return function(e,n){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),n)}}(),viewPointToPrj:function(t,e){return this._viewPointToPrj(t,e)},_prjToContainerPoint:function(t,e,n,r){var i=this._getResolution(e);return this._prjToContainerPointAtRes(t,i,n,r)},prjToContainerPoint:function(t,e,n,r){return this._prjToContainerPoint(t,e,n,r)},_prjToContainerPointAtRes:function(){var t=new Vt(0,0);return function(e,n,r,i){return this._pointAtResToContainerPoint(this._prjToPointAtRes(e,n,t),n,i||0,r)}}(),prjToContainerPointAtRes:function(t,e,n,r){return this.prjToContainerPointAtRes(t,e,n,r)},_prjToViewPoint:function(){var t=new Vt(0,0);return function(e,n,r){var i=this._prjToContainerPoint(e,void 0,t,r);return this.containerPointToViewPoint(i,n)}}(),prjToViewPoint:function(t,e,n){return this._prjToViewPoint(t,e,n)},_viewPointToPoint:function(){var t=new Vt(0,0);return function(e,n,r){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),n,r)}}(),viewPointToPoint:function(t,e,n){return this._viewPointToPoint(t,e,n)},_pointToViewPoint:function(){var t=new rs(0,0);return function(e,n,r){return this._prjToViewPoint(this._pointToPrj(e,n,t),r)}}(),pointToViewPoint:function(t,e,n){return this._pointToViewPoint(t,e,n)}});var gc={distancetool:{start:"起点",units:{mile:" 英里",feet:" 英尺",kilometer:" 公里",meter:" 米"}},areatool:{units:{mile:" 平方英里",feet:" 平方英尺",kilometer:" 平方公里",meter:" 平方米"}}},mc={distancetool:{start:"Inicio",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}}},Ac={distancetool:{start:"Start",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}}},yc=function(t){function e(e){var n;return(n=t.call(this,"Translator: "+e)||this).name="TranslatorError",n}return kt(e,t),e}(Nt(Error)),vc=function(t){function e(e){var n;return(n=t.call(this)||this).languages={"zh-CN":gc,"es-MX":mc,"en-US":Ac},n.setLang(e||"zh-CN"),n}kt(e,t);var n=e.prototype;return n.setLang=function(t){var e=this.languages[t];if(!e)throw new yc("Setted Lang does not exist");this.nodes=e},n._validateNestedProps=function(t){t.forEach((function(t){if(""===t)throw new yc('Any of sides of a dot "." cannot be empty')}))},n.translate=function(t=null){if(null==t)throw new yc("Missing parameter textNode");if("string"!=typeof t)throw new yc("Param passed has to be a String");if(!t.includes("."))return this.nodes[t];var e=t.split(".");if(e.length>3)throw new yc("Translate function can only access through 3 nested properties, trying to access -> "+e.length);this._validateNestedProps(e);try{var n=null;switch(e.length){case 2:n=this.nodes[e[0]][e[1]];break;case 3:n=this.nodes[e[0]][e[1]][e[2]]}return n}catch(S6){throw new yc("Unable to find the text translated in lang json"+S6.message)}},e}(Ho),xc=function(t){function e(e){var n;return(n=t.call(this,e)||this).on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n.translator=new vc(n.options.language),n}kt(e,t);var n=e.prototype;return n.clear=function(){if(ie(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._outLayers(this._measureLayers),this._measureLayers=[],this},n.getMeasureLayers=function(){return this._measureLayers},n.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},n.undo=function(){t.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var n=e;n<this._vertexes.length;n++)this._vertexes[n].label&&this._vertexes[n].label.remove(),this._vertexes[n].marker.remove();return this},n.redo=function(){t.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},n._formatLabelContent=function(t){var e=this.options.formatLabelContent;return e&&X(e)?e.call(this,t)+"":null},n._measure=function(t){var e,n=this.getMap();t instanceof rh?e=n.computeGeometryLength(t):Array.isArray(t)&&(e=n.getProjection().measureLength(t)),this._lastMeasure=e;var r=this._formatLabelContent(e);if(r)return r;var i=[this.translator.translate("distancetool.units.meter"),this.translator.translate("distancetool.units.kilometer"),this.translator.translate("distancetool.units.feet"),this.translator.translate("distancetool.units.mile")],o="",s=this.options.decimalPlaces;return this.options.metric&&(o+=e<1e3?e.toFixed(s)+i[0]:(e/1e3).toFixed(s)+i[1]),this.options.imperial&&(e*=3.2808399,o.length>0&&(o+="\n"),o+=e<5280?e.toFixed(s)+i[2]:(e/5280).toFixed(s)+i[3]),o},n._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},n._afterEnable=function(){this._registerMeasureEvents()},n._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},n._msOnDrawStart=function(t){var e=this.getMap(),n=Xt(),r="distancetool_"+n,i="distancetool_markers_"+n,o=this.options.zIndex,s=this.options.enableAltitude;e.getLayer(r)?(this._measureLineLayer=e.getLayer(r),this._measureMarkerLayer=e.getLayer(i)):(this._measureLineLayer=new Su(r,{zIndex:o,enableAltitude:s}).addTo(e),this._measureMarkerLayer=new Su(i,{zIndex:o,enableAltitude:s}).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),this._pushLayers([this._measureLineLayer,this._measureMarkerLayer]);var a=this._getFirstCoordinate()||t.coordinate,l=new Vh(a.copy(),{symbol:this.options.vertexSymbol}),h=this.translator.translate("distancetool.start"),u=new Au(h,a.copy(),this.options.labelOptions);this._lastVertex=u,this._addVertexMarker(l,u)},n._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var n=vr(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new Vh(t.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new Au(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var r=this._getLasttCoordinate()||t.coordinate;this._tailMarker.setCoordinates(r.copy()),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(r.copy())},n._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this._getLasttCoordinate()||t.coordinate,n=t.geometry,r=new Vh(e.copy(),{symbol:this.options.vertexSymbol}),i=this._measure(n),o=new Au(i,e.copy(),this.options.labelOptions);this._addVertexMarker(r,o),this._lastVertex=o},n._addVertexMarker=function(t,e){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:e,marker:t}),this._measureMarkerLayer.addGeometry(t),e&&this._measureMarkerLayer.addGeometry(e)},n._msOnDrawEnd=function(t){if(this._clearTailMarker(),t.geometry.getCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var e=this._lastVertex.getSize();e||(e=new Ie(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),e.width);var n=t.geometry.copy();n.setCoordinates(t.geometry.getCoordinates()),n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},n._addClearMarker=function(t,e,n){var r=this.options.clearButtonSymbol,i={markerDx:(r.markerDx||0)+n,textDx:(r.textDx||0)+n};Array.isArray(r)&&(i=r.map((function(t){return t?{markerDx:(t.markerDx||0)+n,textDx:(t.textDx||0)+n}:null}))),r=vr(r,i);var o=new Vh(t,{symbol:r}),s=this._measureLineLayer,a=this._measureMarkerLayer;o.on("click",(function(){return s.remove(),a.remove(),!1}),this),o.addTo(this._measureMarkerLayer)},n._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},n._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},n._getFirstCoordinate=function(){return this._geometry?(this._geometry.getCoordinates()||[])[0]:null},n._getLasttCoordinate=function(){if(!this._geometry)return null;var t=this._geometry.getCoordinates()||[];return t[t.length-1]},e}(Ru);xc.mergeOptions({formatLabelContent:null,decimalPlaces:2,mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});function _c(t,e,n){var r,i,o=Array.isArray(e);if(o||(e=[e]),n&&n.drawTool&&n.drawTool.options&&(i=n.drawTool.options.transformCoordinate),i&&X(i))r=e.map((function(e){return t.unproject(e)})),r=r.map((function(t){return i(t,n)||t}));else{if(!n||!n.target||!n.target._queryTerrainInfo)return r=e.map((function(e){return t.unproject(e)})),o?r:r[0];var s=n.target,a=n.enableAltitude;r=e.map((function(e){if(a){var n=s.prjToContainerPoint(e),r=s._queryTerrainInfo(n);if(r&&r.coordinate)return r.coordinate}return t.unproject(e)}))}return o?r:r[0]}(function(t){function e(e){var n;return(n=t.call(this,e)||this).translator=new vc(n.options.language),n._measureLayers=[],n}kt(e,t);var n=e.prototype;return n._measure=function(t){var e,n=this.getMap();t instanceof rh?e=n.computeGeometryArea(t):Array.isArray(t)&&(e=n.getProjection().measureArea(t)),this._lastMeasure=e;var r=this._formatLabelContent(e);if(r)return r;var i=[this.translator.translate("areatool.units.meter"),this.translator.translate("areatool.units.kilometer"),this.translator.translate("areatool.units.feet"),this.translator.translate("areatool.units.mile")],o="",s=this.options.decimalPlaces;if(this.options.metric&&(o+=e<1e6?e.toFixed(s)+i[0]:(e/1e6).toFixed(s)+i[1]),this.options.imperial){e*=Math.pow(3.2808399,2),o.length>0&&(o+="\n");var a=27878400;o+=e<a?e.toFixed(s)+i[2]:(e/a).toFixed(s)+i[3]}return o},n._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this._getLasttCoordinate()||t.coordinate,n=new Vh(e.copy(),{symbol:this.options.vertexSymbol});this._measure(t.geometry),this._lastVertex=n,this._addVertexMarker(n)},n._msOnDrawEnd=function(t){var e;this._clearTailMarker();var n=this.getMap();if(t.point2d)e=n._pointToPrj(t.point2d);else{var r=t.geometry._getPrjCoordinates()||[];e=(r=r.slice(0,r.length-1))[r.length-1]}if(t.geometry.getShell().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var i=this._measure(t.geometry),o=this._getLasttCoordinate(),s=new Au(i,o.copy(),this.options.labelOptions).addTo(this._measureMarkerLayer).getSize();s||(s=new Ie(10,10)),this._addClearMarker(o.copy(),e,s.width);var a=t.geometry.copy();a.setCoordinates(t.geometry.getCoordinates()),a.addTo(this._measureLineLayer),this._lastMeasure=a.getArea()},e})(xc).mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5},language:"zh-CN"});var bc={create:function(t,e,n){var r=_c(t,e[0],n);return new ou(r,0)},update:function(t,e,n,r){var i=n.getMap(),o=_c(t,Array.isArray(e)?e[e.length-1]:e,r),s=i.computeLength(n.getCenter(),o);n.setRadius(s)},generate:function(t){return t}};Ru.registerMode("circle",j({clickLimit:2,action:["click","mousemove","click"]},bc)),Ru.registerMode("freeHandCircle",j({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},bc));var wc={create:function(t,e,n){var r=_c(t,e[0],n);return new su(r,0,0)},update:function(t,e,n,r){var i=n.getMap(),o=n.getCenter(),s=_c(t,Array.isArray(e)?e[e.length-1]:e,r),a=i.computeLength(o,new rs({x:s.x,y:o.y})),l=i.computeLength(o,new rs({x:o.x,y:s.y}));n.setWidth(2*a),n.setHeight(2*l)},generate:function(t){return t}};Ru.registerMode("ellipse",j({clickLimit:2,action:["click","mousemove","click"]},wc)),Ru.registerMode("freeHandEllipse",j({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},wc));var Tc={create:function(t,e){var n=new Hh([]);return n._firstClick=e[0],n},update:function(t,e,n,r){var i=n.getMap(),o=r.containerPoint,s=i.prjToContainerPoint(n._firstClick),a=[[s.x,s.y],[o.x,s.y],[o.x,o.y],[s.x,o.y]].map((function(t){return i._containerPointToPrj(new Vt(t))})),l=_c(t,a,r);n.setCoordinates(l)},generate:function(t){return t}};Ru.registerMode("rectangle",j({clickLimit:2,action:["click","mousemove","click"]},Tc)),Ru.registerMode("freeHandRectangle",j({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Tc)),Ru.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(t,e,n){var r=_c(t,e[0],n);return new Vh(r)},generate:function(t){return t},update:function(t,e,n,r){if(Array.isArray(e)&&(e=e[e.length-1]),!e)return n;var i=_c(t,e,r);return n.setCoordinates(i),n}});var Mc={create:function(t,e,n){var r=_c(t,e,n),i=new Wh(r);return i.setCoordinates(r),i},update:function(t,e,n,r){var i,o=n.getSymbol();Array.isArray(e)?i=e:(i=n._drawPrjs||[]).push(e),n._drawPrjs=i;var s=_c(t,i,r);n.setCoordinates(s);var a=n.getLayer();if(a){var l=a.getGeometryById("polygon");if(!l&&i.length>=3){if(l=new Hh([s],{id:"polygon",zIndex:-1}),o){var h=vr(o,{lineOpacity:0});l.setSymbol(h)}l.addTo(a)}l&&l.setCoordinates([s])}},generate:function(t){var e=new Hh(t.getCoordinates(),{symbol:t.getSymbol(),properties:t.getProperties()});return e._projCode=t._projCode,e}};Ru.registerMode("polygon",j({action:["click","mousemove","dblclick"]},Mc)),Ru.registerMode("freeHandPolygon",j({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Mc));var Cc={create:function(t,e,n){var r=_c(t,e,n),i=new Wh(r);return i.setCoordinates(r),i},update:function(t,e,n,r){var i;Array.isArray(e)?i=e:(i=n._drawPrjs||[]).push(e),n._drawPrjs=i;var o=_c(t,i,r);n.setCoordinates(o)},generate:function(t){return t}};Ru.registerMode("linestring",j({action:["click","mousemove","dblclick"]},Cc)),Ru.registerMode("freeHandLinestring",j({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Cc)),Ru.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),r=new uu(n);return r._setPrjCoordinates(e),r},update:Cc.update,generate:function(t){return t}}),Ru.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),r=new fu(n);return r._setPrjCoordinates(e),r},update:Cc.update,generate:function(t){return t}}),Ru.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),r=new cu(n);return r._setPrjCoordinates(e),r},update:Cc.update,generate:function(t){return t}}),Ru.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t,e){e=e[0];var n=t.unproject(e),r=new Vh(n);return r._firstClick=e,r},update:function(t,e,n,r){var i=n.getMap(),o=i.prjToContainerPoint(n._firstClick),s=r.containerPoint;e=i._containerPointToPrj(new rs(Math.min(o.x,s.x),Math.min(o.y,s.y)));var a=t.unproject(e);n.setCoordinates(a)._setPrjCoordinates(e),n.updateSymbol({markerWidth:Math.abs(o.x-s.x),markerHeight:Math.abs(o.y-s.y)})},generate:function(t){return t}});var Sc=function(t){function e(e){var n;return(n=t.call(this,e)||this).proxyOptions(),n}kt(e,t);var n=e.prototype;return n._appendCustomClass=function(t){if(!t)return console.warn("dom is null:",t),this;if(this.options.cssName){var e=this.options.cssName;Array.isArray(e)||(e=[e]),e.forEach((function(e){t.classList.add(e)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.onDomRemove=function(){},n.getEvents=function(){return{}},n.getOwnerEvents=function(){return{}},n.buildOn=function(){return null},n.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},n.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},n._collides=function(){var t=this.getMap();return t?(t._addUI(this),t._insertUICollidesQueue(),this):this},n._collidesEffect=function(t){var e=this.getDOM();if(!e)return this;var n=t?"visible":"hidden";if(e.style.visibility=n,!e.classList||!e.classList.add)return this;if(!this.options.collisionFadeIn)return this;var r="mtk-ui-fadein",i=e.classList.contains(r);return t&&!i?e.classList.add(r):!t&&i&&e.classList.remove(r),this},n.show=function(t){var e=this,n=this.getMap();if(!n)return this;this.options.visible=!0,(t=t||this._coordinate||this._owner.getCenter())instanceof rs||(t=new rs(t));var r=this.isVisible();this._showBySymbolChange||this.fire("showstart");var i=this._getUIContainer();this._coordinate=t,this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on");var o=this.__uiDOM=this.buildOn();o.eventsPropagation=this.options.eventsPropagation,this._observerDomSize(o);var s=this.options.zIndex;if(!o)return this._showBySymbolChange||this.fire("showend"),this._collides(),this.setZIndex(s),this;this._measureSize(o),this._singleton()&&(o._uiComponent=this,n[this._uiDomKey()]=o),this._setPosition(),o.style[Je]=null,i.appendChild(o);var a=this._getAnimation();if(r&&(a.ok=!1),a.ok&&(a.fade&&(o.style.opacity="0"),a.scale)){if(this.getTransformOrigin){var l=this.getTransformOrigin();o.style[Ye]=l}o.style[Ze]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(o.style.display=""),this.options.eventsToStop&&gn(o,this.options.eventsToStop,on);var h=a.transition;return a.ok&&h&&(o.offsetHeight,h&&(o.style[Je]=h),a.fade&&(o.style.opacity="1"),a.scale&&(o.style[Ze]=this._toCSSTranslate(this._pos)+" scale(1)")),this._showBySymbolChange||this.fire("showend"),this._collides(),clearTimeout(this._autoPanId),this.options.autoPan&&(this._autoPanId=setTimeout((function(){e._autoPan()}),32)),this.setZIndex(s),this},n.hide=function(){var t=this;if(!this.getDOM())return this;this._onDomMouseout&&this._onDomMouseout(),this.options.visible=!1;var e=this._getAnimation(),n=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(n.offsetHeight,n.style[Je]=e.transition,setTimeout((function(){n.style.display="none",t.fire("hide")}),this.options.animationDuration)):(n.style.display="none",this.fire("hide")),e.fade&&(n.style.opacity="0"),e.scale&&(n.style[Ze]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this._collides(),this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},n.remove=function(){if(delete this._mapEventsOn,!this._owner)return this;var t=this.getMap();return t&&t._removeUI(this),this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this._collides(),this},n.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},n.getOwner=function(){return this._owner},n.getDOM=function(){return this.__uiDOM},n.setZIndex=function(t){if(!V(t))return this;var e=this.getDOM();return e?(e.style.zIndex=t+"",t!==this.options.zIndex&&(this.options.zIndex=t),this):this},n._roundPoint=function(t){return this.options.roundPoint&&(t=t._round()),t},n.getPosition=function(){if(!this.getMap())return null;var t=this._roundPoint(this._getViewPoint());if(this.getOffset){var e=this._roundPoint(this.getOffset());e&&t._add(e)}return t},n._getAnimation=function(){for(var t={fade:!1,scale:!1,ok:!1,transition:""},e=this.options.animation?this.options.animation.split(","):[],n=0;n<e.length;n++){var r=Ee(e[n]);"fade"===r?t.fade=!0:"scale"===r&&(t.scale=!0)}var i=null;return t.fade&&(i="opacity "+this.options.animationDuration+"ms"),t.scale&&(i=i?i+",":"",i+=Ze+" "+this.options.animationDuration+"ms"),t.transition=i,t.ok=null!==i,t},n._getViewPoint=function(){var t=0,e=this._coordinate||{};if(V(e.z)?t=e.z:this._owner&&this._owner.getAltitude&&(V(t=this._owner.getAltitude()||0)||(t=0)),this._owner.getLayer){var n=this._owner.getLayer();n&&n.isVectorLayer&&(V(t=this._owner._getAltitude()||0)||(t=0))}var r=this._meterToPoint(this._coordinate,t);return this.getMap().coordToViewPoint(this._coordinate,void 0,r)._add(this.options.dx,this.options.dy)},n._meterToPoint=function(t,e){return e},n._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(e&&t&&!t.isMoving()){var n=this._getViewPoint()._round(),r=t.width,i=t.height,o=t.getContainer();if(e&&o&&e.getBoundingClientRect){var s=o.getBoundingClientRect(),a=s.left,l=s.top,h=50,u=e.getBoundingClientRect(),c=0,f=0,{left:d,right:p,top:g,bottom:m}=u,{width:A,height:y}=u;if(d-=a,p-=a,g-=l,m-=l,A>0&&y>0){if(d<h&&(c=h-d),0===c&&p+h>r&&(c=-(p+h-r)),g<h&&(f=h-g),0===f&&m+h>i&&(f=-(m+h-i)),0!==c||0!==f)t.getPitch()>40&&0!==f&&this._coordinate?t.animateTo({center:this._coordinate},{duration:t.options.panAnimationDuration}):t.panBy([Math.ceil(c),Math.ceil(f)]);return}}var v=t.viewPointToContainerPoint(n),x=this.getOffset(),_=v.add(x),b=t.viewPointToPrj(n),w=parseInt(e.clientWidth+""),T=parseInt(e.clientHeight+""),M=0,C=0;if(_.x<0?M=50-_.x:_.x+w>r&&(M=-(_.x+w-r)-50),_.y-T<0?C=Math.abs(_.y-T)+50:_.y+T>i&&(C=i-(_.y+T)-50),w>=r&&(M=r/2-v.x),0!==C||0!==M){var S=v.add(M,C),I=t._containerPointToPoint(S)._sub(t._prjToPoint(t._getPrjCenter())),P=t._pointToPrj(t._prjToPoint(b).sub(I));t._panAnimation(P)}}},n._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute";var n=t.style.bottom?"bottom":"top";if(t.style.display="",e.appendChild(t),t.getBoundingClientRect){var r=t.getBoundingClientRect();this._size=new Ie(r.width,r.height)}else this._size=new Ie(t.clientWidth,t.clientHeight);return t.style.display="none",t.style.left="0px",t.style[n]="0px",this._size},n._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),n=this._uiDomKey();if(e[n]){t&&mn(e[n],t,on);var r=e[n]._uiComponent;r&&r!==this&&r.isVisible()&&r.fire("hide"),$e(e[n]),r&&!this.hideDom&&r._switchMapEvents("off"),delete e[n]}delete this.__uiDOM}else this.__uiDOM&&(t&&mn(this.__uiDOM,t,on),$e(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},n._uiDomKey=function(){return"__ui_"+this._getClassName()},n._singleton=function(){return this.options.single},n._getUIContainer=function(){return this.getMap().getPanels().ui},n._getClassName=function(){return"UIComponent"},n._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var n=this._getDefaultEvents();if(this.getEvents&&j(n,this.getEvents()),n)for(var r in n)n.hasOwnProperty(r)&&e[t](r,n[r],this)}},n._switchEvents=function(t){var e=this._getOwnerEvents();if(this._owner)for(var n in e)e.hasOwnProperty(n)&&this._owner[t](n,e[n],this)},n._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},n._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof rh&&(t.positionchange=this.onGeometryPositionChange,t.symbolchange=this._updatePosition),this.getOwnerEvents&&j(t,this.getOwnerEvents()),t},n.onGeometryPositionChange=function(t){if(this._owner&&this.isVisible()){this._showBySymbolChange=!0;var e=t.target,n=e.getCenter();if(e._getAltitude){var r=e._getAltitude();V(r)&&(n.z=r)}this.show(n),delete this._showBySymbolChange}},n.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},n.onEvent=function(){this.isVisible()&&this._updatePosition()},n.onZoomEnd=function(){this.isVisible()&&this._setPosition()},n.onResize=function(){this.isVisible()&&this._setPosition()},n.onDomSizeChange=function(){this.isVisible()&&(this._setPosition(),this._collides())},n._updatePosition=function(){return this.getMap()?(this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this)),this):this},n._setPosition=function(){var t=this.getDOM();if(t){t.style[Je]=null;var e=this.getPosition();this._pos=e,t.style[Ze]=this._toCSSTranslate(e)+" scale(1)"}},n._toCSSTranslate=function(t){if(!t)return"";if(Pt.any3d){var e=this.getMap(),n=e?e.getBearing():0,r=e?e.getPitch():0,i="";return this.options.pitchWithMap&&r&&(i+=" rotateX("+Math.round(r)+"deg)"),this.options.rotateWithMap&&n&&(i+=" rotateZ("+Math.round(-n)+"deg)"),"translate3d("+Math.fround(t.x)+"px,"+Math.fround(t.y)+"px, 0px)"+i}return"translate("+Math.fround(t.x)+"px,"+Math.fround(t.y)+"px)"},n._observerDomSize=function(t){var e=this;return t&&Pt.resizeObserver&&!this._resizeObserver?(this._resizeObserver=new ResizeObserver((function(t){if(t.length){var n=t[0].borderBoxSize;n&&n.length?e._domContentRect={width:n[0].inlineSize,height:n[0].blockSize}:e._domContentRect=t[0].contentRect}else delete e._domContentRect;e.onDomSizeChange&&e.onDomSizeChange()})),this._resizeObserver.observe(t),this):this},n.isSupportZoomFilter=function(){return!1},n.onConfig=function(){return this._updatePosition(),this},e.isSupport=function(t){return!!(t&&X(t.on)&&X(t.off)&&X(t.getCenter))},n._bindDomEvents=function(t,e){if(t){var n=this._getDomEvents()||{},r="on"===e?gn:mn;for(var i in n)"on"===e&&mn(t,i,n[i]),r(t,i,n[i],this)}},n._getDomEvents=function(){return{mouseover:this._onDomMouseover,mouseout:this._onDomMouseout}},n._configMapPreventWheelScroll=function(t){var e=this.getMap();e&&(this.options.eventsPropagation||(e.options.preventWheelScroll=t))},n._onDomMouseover=function(){this._configMapPreventWheelScroll(!1)},n._onDomMouseout=function(){this._configMapPreventWheelScroll(!0)},e}(zo(Ho));Sc.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1,collision:!1,collisionBufferSize:2,collisionWeight:0,collisionFadeIn:!1,zIndex:0});var Ic="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",Pc=function(t){function e(e,n){var r;return(r=t.call(this,n)||this)._markerCoord=new rs(e),r}kt(e,t);var n=e.prototype;return n._getClassName=function(){return"UIMarker"},n.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition(),this._collides()),this},n.getCoordinates=function(){return this._markerCoord},n.getCenter=function(){return this.getCoordinates()},n.getAltitude=function(){var t=this.getCoordinates()||{};return V(t.z)?t.z:this.options.altitude||0},n.setAltitude=function(t){return V(t)&&this._markerCoord&&(this._markerCoord.z=t,this._updatePosition&&(this._updatePosition(),this._collides())),this},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},n.getContent=function(){return this.options.content},n.onAdd=function(){if(this._owner&&!this._owner.isMap){var t=this._owner;throw new Error("UIMarker Can only be added to the map, but owner is:"+t.getJSONType&&t.getJSONType())}return this.show(),this},n.show=function(){return t.prototype.show.call(this,this._markerCoord)},n.flash=function(t,e,n,r){return pe.call(this,t,e,n,r)},n.buildOn=function(){var t,e=this.getDOM();this._bindDomEvents(e,"off");var n=this.options.content,r=q(n);return r||X(n)?(t=Qe("div"),r?t.innerHTML=this.options.content:n.bind(this)(t)):t=this.options.content,this.options.containerClass&&(t.className=this.options.containerClass),this._registerDOMEvents(t),this._bindDomEvents(t,"on"),this._appendCustomClass(t),t},n.getOffset=function(){var t=this.getSize(),e=-t.width/2,n=-t.height/2,{horizontalAlignment:r,verticalAlignment:i}=this.options;return"left"===r?e=-t.width:"right"===r&&(e=0),"top"===i?n=-t.height:"bottom"===i&&(n=0),new Vt(e,n)},n.getTransformOrigin=function(){return"center center"},n.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},n.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},n._registerDOMEvents=function(t){gn(t,Ic,this._onDomEvents,this)},n._onDomEvents=function(t,e){var n=this.getMap()._parseEvent(t,t.type);if("mousedown"===(e=e||t.type)&&(this._mousedownEvent=t),"mouseup"===e&&(this._mouseupEvent=t),("click"!==e||!this._mouseClickPositionIsChange())&&("touchstart"===e&&(this._touchstartTime=H()),this.fire(e,n),"touchend"===e&&Pt.touch)){var r=this.getMap().options.clickTimeThreshold||280;H()-this._touchstartTime<r&&this._onDomEvents(t,"click")}},n._removeDOMEvents=function(t){mn(t,Ic,this._onDomEvents)},n._mouseClickPositionIsChange=function(){var{x:t,y:e}=this._mousedownEvent||{},{x:n,y:r}=this._mouseupEvent||{};return t!==n||e!==r},n._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),n=this.getSize(),r=n.width,i=n.height;return[t.containerPointToCoordinate(e.add(-r/2,0)),t.containerPointToCoordinate(e.add(r/2,0)),t.containerPointToCoordinate(e.add(0,i/2)),t.containerPointToCoordinate(e.add(0,-i/2))]},n._getViewPoint=function(){var t=0;if(this._owner){var e=this.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},n._getDefaultEvents=function(){return j({},t.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},n._setPosition=function(){this.onZoomFilter(),t.prototype._setPosition.call(this)},n.onZoomFilter=function(){var t=this.getDOM();t&&(this.isVisible()||"none"===t.style.display?this.isVisible()&&"none"===t.style.display&&(t.style.display=""):t.style.display="none")},n.isVisible=function(){var t=this.getMap();if(!t)return!1;if(!this.options.visible)return!1;var e=t.getZoom(),{minZoom:n,maxZoom:r}=this.options;return!(!U(n)&&e<n||!U(r)&&e>r)&&(this.getDOM()&&!0)},n.isSupportZoomFilter=function(){return!0},e}(Ko(Sc));Pc.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null,horizontalAlignment:"middle",verticalAlignment:"middle"});var Ec=Pt.touch?"touchstart mousedown":"mousedown",Oc=function(t){function e(e){return t.call(this,e)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(Ec,this._startDrag,this)},n.removeHooks=function(){this.target.off(Ec,this._startDrag,this)},n._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},n._prepareDragHandler=function(){this._dragHandler=new ns(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onMouseDown=function(t){on(t.domEvent)},n._dragging=function(t){var e=this.target,n=e.getMap()._parseEvent(t.domEvent),r=n.domEvent;if(!(r.touches&&r.touches.length>1))if(this._isDragging){var i=n.coordinate,o=n.containerPoint;this._lastCoord||(this._lastCoord=i),this._lastPoint||(this._lastPoint=o);var s=i.sub(this._lastCoord),a=o.sub(this._lastPoint);this._lastCoord=i,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(s)),n.coordOffset=s,n.pointOffset=a,e.fire("dragging",n)}else this._isDragging=!0},n._endDrag=function(t){var e=this.target,n=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,n){var r=n._parseEvent(t.domEvent);e&&e._mouseClickPositionIsChange&&e._mouseClickPositionIsChange()&&e.fire("dragend",r)}},n.isDragging=function(){return!!this._isDragging},e}(Bo);Pc.addInitHook("addHandler","draggable",Oc);var Rc=/\{ *([\w_]+) *\}/g,kc={containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},Lc=new Ie(0,0),Dc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n._getClassName=function(){return"InfoWindow"},n.addTo=function(e){return e instanceof rh&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getContent=function(){return this.options.content},n.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getTitle=function(){return this.options.title},n.buildOn=function(){var t=this,e=X(this.options.content),n=q(this.options.content);if(this.options.custom){var r,i=this.getDOM();if(this._bindDomEvents(i,"off"),n||e){var o=Qe("div");n?(o.innerHTML=this.options.content,this._replaceTemplate(o)):this.options.content.bind(this)(o),r=o}else this._replaceTemplate(this.options.content),r=this.options.content;return this._bindDomEvents(r,"on"),this._appendCustomClass(r),r}this._bindDomEvents(this.getDOM(),"off");var s=Qe("div");this.options.containerClass&&(s.className=this.options.containerClass);var a=this._getWindowWidth();s.style.width=V(a)?a+"px":"auto",s.style.bottom="0px";var l='<em class="maptalks-ico"></em>';this.options.title&&(l+="<h2>"+this.options.title+"</h2>"),l+='<a href="javascript:void(0);" class="maptalks-close">×</a><div class="maptalks-msgContent"></div>',s.innerHTML=l,this._replaceTemplate(s);var h=s.querySelector(".maptalks-msgContent");return n||e?n?h.innerHTML=this.options.content:this.options.content.bind(this)(h):h.appendChild(this.options.content),this._onCloseBtnClick=function(e){t.options.eventsPropagation||(rn(e),on(e)),t.hide()},tn(s.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),e||this._replaceTemplate(h),this._bindDomEvents(s,"on"),this._appendCustomClass(s),s},n._replaceTemplate=function(t){var e=this._owner;if(this.options.enableTemplate&&e&&e.getProperties&&t&&t.innerHTML){var n=e.getProperties()||{};if(W(n)){var r=t.innerHTML;t.innerHTML=r.replace(Rc,(function(t,e){return n[e]}))}}return this},n.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},n.getOffset=function(){var t=this.getSize(),e=new Vt(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var n=this.getOwner();if(n instanceof Vh||n instanceof Jh){var r,i;if(n instanceof Vh)r=n._getPainter(),i=n.getSize();else{var o=n.getGeometries();if(!o||!o.length)return e;r=o[0]._getPainter(),i=o[0].getSize()}if(i||(i=Lc),r){var s=r.getFixedExtent();e._add(s.xmax-i.width/2,s.ymin)}else e._add(0,-i.height)}return e},n.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},n.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},n.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},n.onRemove=function(){this._onDomMouseout(),this.onDomRemove()},n.onDomRemove=function(){this._onCloseBtnClick&&(en(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},n._onAutoOpen=function(t){var e=this,n=this.getOwner();setTimeout((function(){n instanceof Vh||n instanceof Sc?e.show(n.getCoordinates()):n instanceof Jh?e.show(n.findClosest(t.coordinate)):n instanceof Wh||n instanceof Kh?(e.getMap().getScale()>=8&&(t.coordinate=e._rectifyMouseCoordinte(n,t.coordinate)),e.show(t.coordinate)):e.show(t.coordinate)}),1)},n._rectifyMouseCoordinte=function(t,e){var n=this;return t instanceof Wh?this._rectifyLineStringMouseCoordinate(t,e).coordinate:t instanceof Kh?t.getGeometries().map((function(t){return n._rectifyLineStringMouseCoordinate(t,e)})).sort((function(t,e){return t.dis-e.dis}))[0].coordinate:e},n._rectifyLineStringMouseCoordinate=function(t,e){for(var n=this.getMap(),r=t.getCoordinates()||[],i=n.getGLRes(),o=r.map((function(t){var e=n.coordToPointAtRes(t,i),r=t.z||0;return n._pointAtResToContainerPoint(e,i,r)})),s=n.coordToContainerPoint(e),a=1/0,l=-1,h=0,u=o.length;h<u;h++){var c=o[h],f=s.distanceTo(c);f<a&&(a=f,l=h)}for(var d=[l-1,l,l+1].filter((function(t){return t>=0&&t<=o.length-1})),p=d.map((function(t){return o[t]})),g=[],{width:m,height:A}=n.getSize(),y=0,v=p.length-1;y<v;y++){var x=y,_=p[y],b=p[y+1];if(_.x===b.x)for(var w=Math.max(0,Math.min(_.y,b.y)),T=Math.min(A,Math.max(_.y,b.y)),M=w;M<=T;M++)g.push({point:new Vt(_.x,M),coordinateIndex:x});else for(var C=(b.y-_.y)/(b.x-_.x),S=Math.max(0,Math.min(_.x,b.x)),I=Math.min(m,Math.max(_.x,b.x)),P=S;P<=I;P++){var E=C*(P-_.x)+_.y;g.push({point:new Vt(P,E),coordinateIndex:x})}}for(var O,R=1/0,k=-1,L=-1,D=0,N=g.length;D<N;D++){var{point:F,coordinateIndex:z}=g[D],B=s.distanceTo(F);B<R&&(R=B,k=D,L=z,O=F)}if(k<0)return{dis:R,coordinate:e};var H=p[L],j=p[L+1],U=H.distanceTo(j),V=O.distanceTo(H)/U,G=d.map((function(t){return r[t]})),W=G[L],q=G[L+1],X=W.x,Z=W.y,Y=W.z||0,J=q.x,Q=q.y,K=q.z||0;return{dis:R,coordinate:new rs(X+(J-X)*V,Z+(Q-Z)*V,Y+(K-Y)*V)}},n._getWindowWidth=function(){var t=kc.width,e=this.options.width;return e||(e=t),e},e}(Sc);Dc.mergeOptions(kc);var Nc="remove hide shapechange positionchange dragend animatestart",Fc=function(t){function e(e,n={}){var r;return(r=t.call(this,n)||this)._content=e,r}kt(e,t);var n=e.prototype;return n._getClassName=function(){return"ToolTip"},n.addTo=function(n){if(e.isSupport(n))return n.on("mousemove",this.onMouseMove,this),n.on("mouseout",this.onMouseOut,this),n.on(Nc,this.hideDom,this),t.prototype.addTo.call(this,n);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},n.setStyle=function(t){return this.options.containerClass=t,this},n.getStyle=function(){return this.options.containerClass},n.getContent=function(){return this._content},n.buildOn=function(){var t=Qe("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var n=e.containerClass||e.cssName;return!n&&e.height&&(t.style.lineHeight=e.height+"px"),X(this._content)?this._content.bind(this)(t):t.innerHTML='<div class="'+n+'">'+this._content+"</div>",this._appendCustomClass(t),t},n.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},n.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var n=this.getMap();if(n){var r=n.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(r):this._timeout=setTimeout((function(){n&&e.show(r)}),this.options.showTimeout)}},n.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mousemove",this.onMouseMove,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off(Nc,this.hideDom,this))},n.hideDom=function(){this.hide()},n.onEvent=function(){return t.prototype.onEvent.call(this),this.hideDom(),this},n._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},e}(Sc);Fc.mergeOptions({width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400});var zc=function(t){function e(e){return t.call(this,e)||this}kt(e,t);var n=e.prototype;return n._getClassName=function(){return"Menu"},n.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,this._owner=t,Sc.prototype.addTo.apply(this,[t])},n.setItems=function(t){return this.options.items=t,this},n.getItems=function(){return this.options.items||[]},n.buildOn=function(){var t;if(this.options.custom)if(q(this.options.items)){var e=Qe("div");e.innerHTML=this.options.items,this._appendCustomClass(e),t=e}else t=this.options.items;else{t=Qe("div"),this.options.containerClass&&cn(t,this.options.containerClass),t.style.width=this._getMenuWidth()+"px";var n=this._createMenuItemDom();t.appendChild(n),gn(t,"contextmenu",rn),this._appendCustomClass(t)}return t&&(this._bindDomEvents(t,"off"),this._bindDomEvents(t,"on")),t},n.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),n=this.getSize(),r=0,i=0;return e.x+n.width>t.width&&(r=-n.width),e.y+n.height>t.height&&(i=-n.height),new Vt(r,i)},n.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},n.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},n._createMenuItemDom=function(){var t=this,e=this.getMap(),n=Qe("ul");cn(n,"maptalks-menu-items");var r,i,o=this.getItems();function s(n){return function(r){var i=e._parseEvent(r,"click");i.target=t,i.owner=t._owner,i.index=n,!1!==this._callback(i)&&(t.hide(),t._owner&&t._owner.fire("closemenu"))}}for(var a=0,l=o.length;a<l;a++){if("-"===(r=o[a])||"_"===r)cn(i=Qe("li"),"maptalks-menu-splitter");else{i=Qe("li");var h=r.item;X(h)&&(h=h({owner:this._owner,index:a})),i.innerHTML=h,i._callback=r.click,gn(i,"click",s(a))}n.appendChild(i)}var u=this.options.maxHeight||0;return u>0&&hn(n,"max-height: "+u+"px; overflow-y: auto;"),n},n._getMenuWidth=function(){return this.options.width||160},e}(Sc);zc.mergeOptions({containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var Bc={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(t){var e=this instanceof Ah?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(),this._menu.show(t)),this.fire("openmenu",{coordinate:t}),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new zc(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.openMenu(t.coordinate),!1}};Ah.include(Bc),rh.include(Bc);var Hc=function(t){function e(e){return e&&e.position&&!q(e.position)&&(e.position=j({},e.position)),t.call(this,e)||this}kt(e,t);var n=e.prototype;return n._appendCustomClass=function(t){if(!t)return console.warn("dom is null:",t),this;if(this.options.cssName){var e=this.options.cssName;Array.isArray(e)||(e=[e]),e.forEach((function(e){t.classList.add(e)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t.getPanels().control;return this.__ctrlContainer=Qe("div"),hn(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},n.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},n.getMap=function(){return this._map},n.getPosition=function(){return j({},this._parse(this.options.position))},n.setPosition=function(t){return q(t)?this.options.position=t:this.options.position=j({},t),this._updatePosition(),this},n.getContainerPoint=function(){var t,e,n=this.getPosition(),r=this.getMap().getSize();return U(n.left)?U(n.right)||(t=r.width-parseInt(n.right+"")):t=parseInt(n.left+""),U(n.top)?U(n.bottom)||(e=r.height-parseInt(n.bottom+"")):e=parseInt(n.top+""),new Vt(t,e)},n.getContainer=function(){return this.__ctrlContainer},n.getDOM=function(){return this._controlDom},n.show=function(){return this.__ctrlContainer.style.display="",this},n.hide=function(){return this.__ctrlContainer.style.display="none",this},n.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},n.remove=function(){return this._map?($e(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},n._parse=function(t){var n=t;return q(t)&&(n=e.positions[n]),n},n._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)if(t.hasOwnProperty(e)){var n=t[e]||0;V(n)&&(n+="px"),this.__ctrlContainer.style[e]=n}this.fire("positionchange",{position:j({},t)})},e}(zo(Ho));Hc.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},Ah.mergeOptions({control:!0}),Ah.include({addControl:function(t){return this._containerDOM.getContext||t.addTo(this),this},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var jc="addlayer removelayer setbaselayer baselayerremove",Uc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(){return this._attributionContainer=Qe("div"),this._attributionContainer.className="maptalks-attribution",this._appendCustomClass(this._attributionContainer),this._update(),this._attributionContainer},n.getContent=function(){return this.options.content},n.setContent=function(t){return this.options.content=t,this._update(),this},n.onAdd=function(){this.getMap().on(jc,this._update,this)},n.onRemove=function(){this.getMap().off(jc,this._update,this)},n._updateContent=function(){var t=this._attributionContainer,e=this.options.content||"";return t&&(t.innerHTML="",q(e)?t.innerHTML=e:e instanceof HTMLElement&&t.appendChild(t)),this},n._update=function(){if(this.options.custom)this._updateContent();else{var t=this.getMap();if(t){var e=t._getLayers((function(t){return!!t.options.attribution})).reverse().map((function(t){return t.options.attribution})),n=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+n+"</span>"}}},e}(Hc);Uc.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>',custom:!1}),Ah.mergeOptions({attribution:!0}),Ah.addOnLoadHook((function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new Uc(t),this.addControl(this.attributionControl))}));var Vc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(t){var e=this._getCompass();return this._appendCustomClass(e),this._compass=e,this._registerDomEvents(),t.on("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),e},n.onAdd=function(){this._rotateCompass()},n._getCompass=function(){return Qe("div","maptalks-compass")},n._registerDomEvents=function(){gn(this._compass,"click",this._resetView,this)},n._rotateCompass=function(){var t=this.getMap().getBearing().toFixed(1),e=parseFloat(t);e<=180&&(e*=-1),e!==this._bearing&&(this._bearing=e,hn(this._compass,"transform: rotate("+this._bearing+"deg);"))},n.onRemove=function(){this.getMap().off("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),delete this._compass,delete this._bearing},n._resetView=function(){this.getMap().animateTo({bearing:0})},e}(Hc);Vc.mergeOptions({position:{top:120,left:20}}),Ah.mergeOptions({compassControl:!1}),Ah.addOnLoadHook((function(){this.options.compassControl&&(this.compassControl=new Vc(this.options.compassControl),this.addControl(this.compassControl))}));var Gc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.container=Qe("div",this.options.containerClass),e=this.panel=Qe("div","panel"),n=this.button=Qe("button");return t.appendChild(n),t.appendChild(e),this._appendCustomClass(t),t},n.onAdd=function(){gn(this.button,"mouseover",this._show,this),gn(this.panel,"mouseleave",this._hide,this)},n.onRemove=function(){this.panel&&(mn(this.button,"mouseover",this._show),mn(this.panel,"mouseleave",this._hide),$e(this.panel),$e(this.button),delete this.panel,delete this.button,delete this.container)},n._show=function(){un(this.container,"shown")||(cn(this.container,"shown"),this._createPanel())},n._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||fn(this.container,this.options.containerClass)},n._createPanel=function(){this.panel.innerHTML="";var t=Qe("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},n._renderLayers=function(t,e){var n=this,r=t.getBaseLayer(),i=t.getLayers(),o=i.length;if(r){var s=r.layers||[r],a=Qe("li","group"),l=Qe("ul"),h=Qe("label");h.innerHTML=this.options.baseTitle,a.appendChild(h);for(var u=0,c=s.length;u<c;u++){var f=s[u];this._isExcluded(f)&&(l.appendChild(this._renderLayer(s[u],!0)),a.appendChild(l),e.appendChild(a))}}if(o){var d=Qe("li","group"),p=Qe("ul"),g=Qe("label"),m=Qe("input");m.type="checkbox",m.checked=!0,g.innerHTML=this.options.overlayTitle,d.appendChild(m),d.appendChild(g);for(var A=function(t){var e=t.target.checked,n=t.target.parentNode;if(n){var r=n.getElementsByTagName("ul")[0];if(r){var i=function(t){var n=t._layer;n&&n[e?"show":"hide"]()},o=function(t){var n=t._layer,r=t.childNodes[0];r&&(r.checked=e),n&&n[e?"show":"hide"]()};i(n),r.childNodes.forEach((function(t){o(t);var e=t.getElementsByTagName("ul")[0];e&&(i(t),e.childNodes.forEach((function(t){o(t)})))}))}}},y=function(){var t=i[v];if(n._isExcluded(t)){if(t.getLayers){var e=Qe("li","group"),r=Qe("ul"),o=Qe("label"),s=Qe("input");o.innerHTML=t.getId(),s.type="checkbox",s.checked=t.isVisible(),s.onchange=A,e.appendChild(s),e.appendChild(o),e.appendChild(r),e._layer=t,p.appendChild(e),(t.getLayers()||[]).forEach((function(t){r.appendChild(n._renderLayer(t,!1,s.checked))}))}else p.appendChild(n._renderLayer(t));t&&!t.isVisible()&&(m.checked=!1)}},v=0;v<o;v++)y();d.appendChild(p),e.appendChild(d),m.onchange=A}},n._isExcluded=function(t){var e=t.getId(),n=this.options.excludeLayers;return!(n.length&&n.indexOf(e)>=0)},n._renderLayer=function(t,e,n=!0){var r=this,i=Qe("li","layer"),o=Qe("label"),s=Qe("input"),a=this.getMap(),l=t.options.visible;t.options.visible=!0;var h=t.isVisible();t.options.visible=l,i.className="layer";var u=s;return e?(u.type="radio",u.name="base"):u.type="checkbox",u.checked=l&&h,n||(u.checked=!1),h||u.setAttribute("disabled","disabled"),u.onchange=function(e){if("radio"===e.target.type){var n=a.getBaseLayer(),i=n.layers;if(i)for(var o=0,s=i.length;o<s;o++){var l=i[o];l[l===t?"show":"hide"]()}else n.isVisible()||n.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();r.fire("layerchange",{target:t})},i.appendChild(s),o.innerHTML=t.getId(),i.appendChild(o),i._layer=t,i},e}(Hc);Gc.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),Ah.mergeOptions({layerSwitcherControl:!1}),Ah.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new Gc(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var Wc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=Qe("div");this._appendCustomClass(e);var n=this.mapContainer=Qe("div");n.style.width=t[0]+"px",n.style.height=t[1]+"px",n.className=this.options.containerClass;var r=this.button=Qe("div");return r.className=this.options.buttonClass,e.appendChild(n),e.appendChild(r),e},n.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),gn(this.button,"click",this._onButtonClick,this),this._updateButtonText()},n.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),mn(this.button,"click",this._onButtonClick)},n.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},n.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},n.getOverviewMap=function(){return this._overview},n._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},n._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},n._createOverview=function(){var t=this.getMap(),e=this.mapContainer,n=t.config();j(n,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new Ah(e,n),this._updateBaseLayer(),this._perspective=new Hh(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new Su("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},n._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),n=t.getMinZoom(),r=this.options.level;if(r>0){for(var i=r;i>0;i--)if(e-i>=n)return e-i}else for(var o=r;o<0;o++)if(e-o>=n)return e-o;return e},n._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},n._getPerspectiveCoords=function(){var t=this.getMap(),e=t.getProjection();return t.getContainerExtent().toArray().map((function(n){if(e){var r=t._containerPointToPrj(n);return t._fixPrjOnWorldWide(r),e.unproject(r)}return t.containerPointToCoordinate(n)}))},n._update=function(){if(this._overview){an(this._overview.getContainer());var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},n._updateSpatialReference=function(){if(this._overview){var t=this.getMap().options.spatialReference;this._overview.setSpatialReference(t)}},n._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,n=0;if(e)for(var r=0,i=e.length;r<i;r++){if(e[r].isVisible()){n=r;break}}var o=t.toJSON(),s=null;e?(s=o.layers[n].options).visible=!0:s=o.options,this._overview.setMinZoom(s.minZoom||null).setMaxZoom(s.maxZoom||null),delete s.minZoom,delete s.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var a=ch.fromJSON(o);for(var l in t)X(t[l])&&t.hasOwnProperty(l)&&t[l]!==t.constructor.prototype[l]&&(a[l]=t[l]);this._overview.setBaseLayer(a)}else this._overview.setBaseLayer(null)}},e}(Hc);Wc.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),Ah.mergeOptions({overviewControl:!1}),Ah.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new Wc(this.options.overviewControl),this.addControl(this.overviewControl))}));(function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(){var t,e=this;if(this.options.custom)q(this.options.content)?((t=Qe("div")).innerHTML=this.options.content,this._appendCustomClass(t)):t=this.options.content;else{if(t=Qe("div","maptalks-panel"),this._appendCustomClass(t),this.options.closeButton){var n=Qe("a","maptalks-close");n.innerText="×",n.href="javascript:;",n.onclick=function(){t.style.display="none",e.fire("close")},t.appendChild(n)}var r=Qe("div","maptalks-panel-content");q(this.options.content)?r.innerHTML=this.options.content:r.appendChild(this.options.content),t.appendChild(r)}return this.draggable=new ns(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},n.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),Hc.prototype.update.call(this)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},n.getContent=function(){return this.options.content},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=j({},this.getPosition()),this.fire("dragstart",t)},n._onDragging=function(t){var e=t.mousePos.sub(this._startPos),n=this._startPosition,r=this.getPosition();U(r.top)||(r.top=parseInt(n.top)+e.y),U(r.bottom)||(r.bottom=parseInt(n.bottom)-e.y),U(r.left)||(r.left=parseInt(n.left)+e.x),U(r.right)||(r.right=parseInt(n.right)-e.x),this.setPosition(r),this.fire("dragging",t)},n._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},n._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),n=this.getDOM(),r=parseInt(n.clientWidth+""),i=parseInt(n.clientHeight+"");return[t.containerPointToCoordinate(e.add(r/2,0)),t.containerPointToCoordinate(e.add(r,i/2)),t.containerPointToCoordinate(e.add(r/2,i)),t.containerPointToCoordinate(e.add(0,i/2))]},e})(Hc).mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var qc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(){var t=this._getReset();return this._appendCustomClass(t),this._reset=t,this._registerDomEvents(),t},n.onAdd=function(){this._view=this.options.view?this.options.view:this.getMap().getView()},n.setView=function(t){this._view=t},n._getReset=function(){return Qe("div","maptalks-reset")},n._registerDomEvents=function(){gn(this._reset,"click",this._resetView,this)},n.onRemove=function(){delete this._reset,delete this._view},n._resetView=function(){this.getMap().setView(this._view)},e}(Hc);qc.mergeOptions({position:{top:156,left:20},view:null}),Ah.mergeOptions({resetControl:!1}),Ah.addOnLoadHook((function(){this.options.resetControl&&(this.resetControl=new qc(this.options.resetControl),this.addControl(this.resetControl))}));var Xc="zoomend moving moveend",Zc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(t){return this._map=t,this._scaleContainer=Qe("div",this.options.containerClass),this._addScales(),t.on(Xc,this._update,this),this._map.isLoaded()&&this._update(),this._appendCustomClass(this._scaleContainer),this._scaleContainer},n.onRemove=function(){this.getMap().off(Xc,this._update,this)},n._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=Ke("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=Ke("div",this.options.containerClass?null:t,this._scaleContainer))},n._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},n._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},n._updateMetric=function(t){var e=this._getRoundNum(t),n=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,n,e/t)},n._updateImperial=function(t){var e,n,r,i=3.2808399*t;i>5280?(e=i/5280,n=this._getRoundNum(e),this._updateScale(this._iScale,n+" mile",n/e)):(r=this._getRoundNum(i),this._updateScale(this._iScale,r+" feet",r/i))},n._updateScale=function(t,e,n){t.style.width=Math.round(this.options.maxWidth*n)+"px",t.innerHTML=e},n._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),n=t/e;return e*(n=n>=10?10:n>=5?5:n>=3?3:n>=2?2:1)},e}(Hc);Zc.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),Ah.mergeOptions({scaleControl:!1}),Ah.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new Zc(this.options.scaleControl),this.addControl(this.scaleControl))}));var Yc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(t){this._map=t;var e=Qe("div"),n=Qe("ul","maptalks-toolbar-hx");e.appendChild(n),this.options.vertical?cn(e,"maptalks-toolbar-vertical"):cn(e,"maptalks-toolbar-horizonal");var r=this;function i(t,e,n,i){var o=r._getItems()[e];return function(r){return on(r),t({target:o,index:e,childIndex:n,dom:i})}}var o,s=this.options.items;if(ie(s))for(var a=0,l=s.length;a<l;a++){var h=s[a],u=Qe("li");if(28!==this.options.height&&(u.style.lineHeight=this.options.height+"px"),u.style.height=this.options.height+"px",u.style.cursor="pointer",o=h.item,/<[a-z\][\s\S]*>/i.test(o)){u.style.textAlign="center";var c=pn("div",h.item);u.innerHTML='<div style="margin-top:'+(this.options.height-c.height)/2+'px;">'+h.item+"</div>"}else u.innerHTML=h.item;if(h.click&&gn(u,"click",i(h.click,a,null,u)),ie(h.children)){var f=this._createDropMenu(a);u.appendChild(f),u._menu=f,gn(u,"mouseover",(function(){this._menu.style.display=""})),gn(u,"mouseout",(function(){this._menu.style.display="none"}))}n.appendChild(u)}return this._appendCustomClass(e),e},n._createDropMenu=function(t){var e=this;function n(t,n,r){var i=e._getItems()[n].children[r];return function(e){return on(e),t({target:i,index:n,childIndex:r})}}var r=Qe("div","maptalks-dropMenu"),i=this._getItems(),o=i.length,s=Qe("ul"),a=i[t].children;t===o-1&&a&&(r.style.cssText="right: 0px;",s.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(s.style.bottom="0")),r.appendChild(Qe("em","maptalks-ico"));for(var l=0,h=0,u=a.length;h<u;h++){var c=Ne(a[h].item,"12px");c.width>l&&(l=c.width)}for(var f=0,d=a.length;f<d;f++){var p=a[f],g=Qe("li");g.innerHTML='<a href="javascript:;">'+p.item+"</a>",g.style.cursor="pointer",g.style.width=l+24+"px",gn(g.childNodes[0],"click",n(p.click,t,f)),s.appendChild(g)}if(this.options.vertical){var m=l<95?95:l;this.options.reverseMenu?r.style.right=-(m+20+2)+"px":r.style.left=-(m+20+2)+"px"}else this.options.reverseMenu?r.style.bottom="28px":r.style.top="29px";return r.appendChild(s),r.style.display="none",r},n._getItems=function(){return this.options.items||[]},e}(Hc);Yc.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:[]});var Jc=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.buildOn=function(t){var e=this.options,n=Qe("div","maptalks-zoom");if(this._appendCustomClass(n),e.zoomLevel){var r=Qe("span","maptalks-zoom-zoomlevel"),i=Qe("span","maptalks-zoom-zoomlevel-text");r.appendChild(i),n.appendChild(r),this._levelDOM=i}var o=Qe("div","maptalks-zoom-slider"),s=Qe("a","maptalks-zoom-zoomin");s.href="javascript:;",o.appendChild(s),this._zoomInButton=s;var a=Qe("a","maptalks-zoom-zoomout");return a.href="javascript:;",o.appendChild(a),this._zoomOutButton=a,n.appendChild(o),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),n},n.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this)},n._update=function(){this._updateText()},n._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();G(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t+""}},n._registerDomEvents=function(){this._zoomInButton&&gn(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&gn(this._zoomOutButton,"click",this._onZoomOutClick,this)},n._onZoomInClick=function(t){rn(t),this.getMap().zoomIn()},n._onZoomOutClick=function(t){rn(t),this.getMap().zoomOut()},e}(Hc);Jc.mergeOptions({position:"top-left",zoomLevel:!0,seamless:!1}),Ah.mergeOptions({zoomControl:!1}),Ah.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new Jc(this.options.zoomControl),this.addControl(this.zoomControl))}));var Qc=function(){function t(t,e,n,r){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:n,y:r})}return t.getDefault=function(t){var e=t.code.toLowerCase();return"baidu"===e?"baidu":e==="EPSG:4326".toLowerCase()||e==="EPSG:4490".toLowerCase()?"tms-global-geodetic":"identity"===e?[1,-1,0,0]:"web-mercator"},t}(),Kc=6378137*Math.PI;j(Qc,{"web-mercator":new Qc([1,-1,-Kc,Kc]),"tms-global-mercator":new Qc([1,1,-Kc,-Kc]),"tms-global-geodetic":new Qc([1,1,-180,-90]),baidu:new Qc([1,1,0,0])});for(var $c=function(){function t(t,e,n,r){this.map=t,this.tileSize=r,this.fullExtent=n,this.prepareTileInfo(e,n),this._xScale=n.right>=n.left?1:-1,this._yScale=n.top>=n.bottom?1:-1;var i=t.getGLRes();this._pointOrigin=t._prjToPointAtRes(new Vt(this.tileSystem.origin),i),this._glRes=i}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(q(t)?t=Qc[t.toLowerCase()]:Array.isArray(t)&&(t=new Qc(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var n=e.right>e.left?1:-1,r=e.top>e.bottom?-1:1,i=t.origin.x,o=t.origin.y;this.transformation=new xs([n,r,i,o])},e._getTileNum=function(t,e){var n=this.tileSystem,r=this.tileSize,i=Math.floor(1e-7*n.scale.x+t.x/(r.width*e)),o=Math.ceil(1e-7*n.scale.y+t.y/(r.height*e));return{x:n.scale.x*i,y:n.scale.y*o}},e.getTileIndex=function(t,e,n){var r=this.tileSystem,i=this.transformation.transform(t,1),o=this._getTileNum(i,e);return r.scale.x<0&&(o.x-=1),r.scale.y>0&&(o.y-=1),this.getNeighorTileIndex(o.x,o.y,0,0,e,n)},e.getNeighorTileIndex=function(t,e,n,r,i,o){var s=this.tileSystem,a=t+s.scale.x*n,l=e-s.scale.y*r,h=!1,u=a,c=l,f=this._getTileFullIndex(i);return o&&(!0!==o&&"x"!==o||(f.xmax===f.xmin?a=f.xmin:a<f.xmin?(a=f.xmax-(f.xmin-a)%(f.xmax-f.xmin))===f.xmax&&(a=f.xmin):a>=f.xmax&&(a=f.xmin+(a-f.xmin)%(f.xmax-f.xmin))),!0!==o&&"y"!==o||(f.ymax===f.ymin?l=f.ymin:l>=f.ymax?l=f.ymin+(l-f.ymin)%(f.ymax-f.ymin):l<f.ymin&&(l=f.ymax-(f.ymin-l)%(f.ymax-f.ymin))===f.ymax&&(l=f.ymin))),(a<f.xmin||a>f.xmax||l>f.ymax||l<f.ymin)&&(h=!0),{x:a,y:l,idx:u,idy:c,out:h}},e._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,n=this.transformation,r=this._getTileNum(n.transform(new rs(e.left,e.top),1),t),i=this._getTileNum(n.transform(new rs(e.right,e.bottom),1),t),o=this.tileSystem;return o.scale.x<0&&(r.x-=1,i.x-=1),o.scale.y>0&&(r.y-=1,i.y-=1),this._tileFullIndex[t]=new As(r,i,null),this._tileFullIndex[t]},e.getTilePrjNW=function(t,e,n,r){var i=this.tileSystem,o=this.tileSize,s=i.origin.y+this._yScale*i.scale.y*(e+(1===i.scale.y?1:0))*n*o.height,a=i.origin.x+this._xScale*i.scale.x*(t+(1===i.scale.x?0:1))*n*o.width;return r?(r.set(a,s),r):new rs(a,s)},e.getTilePointNW=function(t,e,n,r){var i=this._glRes/n,o=this.tileSystem,s=this.tileSize,a=this._pointOrigin.y*i+this._yScale*o.scale.y*(e+(1===o.scale.y?1:0))*s.height,l=this._pointOrigin.x*i+this._xScale*o.scale.x*(t+(1===o.scale.x?0:1))*s.width;return r?(r.set(l,a),r):new Vt(l,a)},e.getTilePrjSE=function(t,e,n,r){var i=this.tileSystem,o=this.tileSize,s=i.origin.y+this._yScale*i.scale.y*(e+(1===i.scale.y?0:1))*n*o.height,a=i.origin.x+this._xScale*i.scale.x*(t+(1===i.scale.x?1:0))*n*o.width;return r?(r.set(a,s),r):new rs(a,s)},e.getTilePointSE=function(t,e,n,r){var i=this._glRes/n,o=this.tileSystem,s=this.tileSize,a=this._pointOrigin.y*i+this._yScale*o.scale.y*(e+(1===o.scale.y?0:1))*s.height,l=this._pointOrigin.x*i+this._xScale*o.scale.x*(t+(1===o.scale.x?1:0))*s.width;return r?(r.set(l,a),r):new Vt(l,a)},e.getTilePrjExtent=function(t,e,n){var r=this.getTilePrjNW(t,e,n),i=this.getTilePrjSE(t,e,n);return new As(r,i)},t}(),tf=[],ef=0;ef<6;ef++)tf[ef]=[];var nf=[];function rf(t,e,n){var r,i,o,s,a,l,h,u,c,f,d,p,g,m,A,y,v;i=(r=t)[0],o=r[1],s=r[2],a=r[3],l=r[4],h=r[5],u=r[6],c=r[7],f=r[8],d=r[9],p=r[10],g=r[11],m=r[12],A=r[13],y=r[14],v=r[15],sf(tf[0],a-i,c-l,g-f,v-m),sf(tf[1],a+i,c+l,g+f,v+m),sf(tf[2],a+o,c+h,g+d,v+A),sf(tf[3],a-o,c-h,g-d,v-A),sf(tf[4],a-s,c-u,g-p,v-y),sf(tf[5],a+s,c+u,g+p,v+y);for(var x=0;x<6;x++){var _=tf[x];if(nf[0]=_[0]>0?e[1][0]:e[0][0],nf[1]=_[1]>0?e[1][1]:e[0][1],nf[2]=_[2]>0?e[1][2]:e[0][2],af(_,nf)<0)return!1}return!0}var of=1/6;function sf(t,e,n,r,i){return t[0]=e*of,t[1]=n*of,t[2]=r*of,t[3]=i*of,t}function af(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}var lf=new Vt(0,0),hf="undefined"!=typeof Set,uf=function(){function t(){this._table=hf?new Set:{}}var e=t.prototype;return e.add=function(t){hf?this._table.add(t):this._table[t]=!0},e.has=function(t){return hf?this._table.has(t):this._table[t]},e.reset=function(){hf?this._table.clear():this._table={}},t}(),cf={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,loadingLimitOnInteracting:3,loadingLimit:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!z,fadeDuration:1e3/60*10,debug:!1,spatialReference:null,maxCacheSize:256,renderer:Pt.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,tileStackStartDepth:7,tileStackDepth:6,awareOfTerrain:!0,bufferPixel:.5,mipmapTexture:!0,depthMask:!0,currentTilesFirst:!0,forceRenderOnMoving:!0,tileErrorScale:1},ff=/\{ *([\w_]+) *\}/g,df=new Vt(0,0),pf=new Vt(0,0),gf=new Vt(0,0),mf=new Vt(0,0),Af=new Vt(0,0),yf=new Vt(0,0),vf=[[0,0,0],[0,0,0]],xf=[0,0,0],_f=[0,0,0],bf=[0,0,0],wf=function(t){function e(e,n){return t.call(this,e,n)||this}kt(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var n=e.prototype;return n.forceReload=function(){return this.fire("forcereloadstart"),this.clear(),this._renderer&&this._renderer.setToRedraw(),this.fire("forcereloadend"),this},n.getTileSize=function(t){if(this._tileSize)return this._tileSize;var e=this.options.tileSize;return V(e)&&(e=[e,e]),this._tileSize=new Ie(e),this._tileSize},n.getTiles=function(t,e){var n,r=this;if(this._coordCache={},n=this._isPyramidMode()?this._getPyramidTiles(t,e):this._getCascadeTiles(t,e),!this._maskGeoJSON)return n;var i=n.tileGrids||[],o=0;return i.forEach((function(t){var e=t.tiles||[];t.tiles=e.filter((function(t){return r._tileInMask(t)})),o+=t.tiles.length;var n=t.tiles.map((function(t){return t.parent}));t.parents=t.parents.filter((function(t){return n.indexOf(t.id)>-1}))})),n.count=o,n},n._isPyramidMode=function(){var t=this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&t&&t.isPyramid()},n._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var t=this.getSpatialReference(),e=t.getFullExtent(),n=t.getResolution(0),r=this.getMap();return this._tileFullExtent=e.convertTo((function(t){return r._prjToPointAtRes(t,n,lf)})),this._tileFullExtent},n._getRootNodes=function(t){var e=this.getMap();if(this._rootNodes){var{tiles:n,mapWidth:r,mapHeight:i}=this._rootNodes;if(e.width!==r||e.height!==i){for(var o=this._getRootError(),s=0;s<n.length;s++)n[s].error=o;this._rootNodes.mapWidth=e.width,this._rootNodes.mapHeight=e.height}for(var a=0;a<n.length;a++)n[a].offset[0]=t[0],n[a].offset[1]=t[1];return this._rootNodes}var l=this.getSpatialReference(),h=l.getResolution(0),u=this._getTileConfig(),c=l.getFullExtent(),{origin:f,scale:d}=u.tileSystem,p=u.getTilePrjExtent(0,0,h),g=p.getWidth(),m=p.getHeight(),A=1e-5,y=Math.abs((f.x-c.left)/g);y=Math.ceil(y-A);var v=Math.abs((c.right-f.x)/g);v=Math.ceil(v-A);var x=Math.ceil(Math.abs(c.top-f.y)/m);x=Math.ceil(x-A);var _=Math.ceil(Math.abs(c.bottom-f.y)/m);if((v+y)*((_=Math.ceil(_-A))+x)>32)return{status:0,error:"Too many root nodes"};for(var b=this._getRootError(),w=[],T=-y;T<v;T++)for(var M=-x;M<_;M++){var C=d.y<0?M:-(M+1);w.push(this.createTileNode(T,C,0,T,C,h,b))}return this._rootNodes={status:1,tiles:w,mapWidth:e.width,mapHeight:e.height},this._getRootNodes(t)},n.createTileNode=function(t,e,n,r,i,o,s,a,l,h){var u=this.getMap(),c=this.options.zoomOffset;l||(l=this._getTileConfig().getTilePrjExtent(t,e,o).convertTo((function(t){return u._prjToPointAtRes(t,o,lf)})));var f=this._getTileOffset(n),d=this.getTileUrl(t,e,n+c);return{parent:a,layer:this.getId(),x:t,y:e,z:n,idx:r,idy:i,res:o,extent2d:l,id:h||this._getTileId(t,e,n),url:Tn(d),offset:f,error:s,children:[]}},n._getRootError=function(){var t=this.getMap(),e=Q(t.getFov()),n=t.width/t.height,r=t.cameraPosition[2],i=r*Math.tan(.5*e),o=i*n,s=Math.sqrt(r*r+i*i+o*o);return t._getFovZ(0)*(s/r)*this.getSpatialReference().getResolution(0)/t.getResolution(0)},n._getPyramidTiles=function(t,e){var n=this.getMap();isNaN(+t)&&(t=this._getTileZoom(n.getZoom()));var r,i=this.getSpatialReference(),o=Math.min(t,this.getMaxZoom(),this.getMaxAvailableZoom()||1/0),s=n.projViewMatrix,a=this._getTileFullExtent(),l=this._getTileOffset(0);if(this.options.repeatWorld){var h=n.getContainerExtent(),u=this._convertToExtent2d(h),c=i.getResolution(0)/n.getResolution();if(u.within(a.copy()._scale(c))){var f=this._getRootNodes(l);if(1!==f.status)return console.warn(f.error),this._disablePyramid=!0,this.getTiles(t,e);r=[...f.tiles]}else{var d=n.getPitch(),p=n.options.cascadePitches[1],g=Math.floor(n._getVisualHeight(p)),m=d<=p?h:new vs(0,n.height-g,n.width,n.height);this._visitedTiles=new uf;var A=this._getTiles(0-this.options.zoomOffset,m,2,e&&e.getRenderer(),!0),y=this._getRootError()*Math.pow(2,this.options.zoomOffset);A.tiles.forEach((function(t){t.error=y})),r=A.tiles}}else{var v=this._getRootNodes(l);if(1!==v.status)return console.warn(v.error),this._disablePyramid=!0,this.getTiles(t,e);r=[...v.tiles]}for(var x=n.getGLRes(),_={0:l},b=new vs,w=[],T=[];r.length>0;){var M=r.pop();M.z!==o?(_[M.z+1]||(_[M.z+1]=this._getTileOffset(M.z+1)),this._splitNode(M,s,r,w,b,o,_[M.z+1],e&&e.getRenderer(),x),this.isParentTile(t,o,M)&&T.push(M)):(b._combine(M.extent2d),w.push(M))}return T.sort(Tf),{tileGrids:[{extent:b,count:w.length,tiles:w,parents:T,offset:[0,0],zoom:t}],count:w.length}},n.isParentTile=function(t,e,n){var r=Math.max(this.getMinZoom(),t-this.options.tileStackStartDepth),i=Math.min(e,r+this.options.tileStackDepth);return n.z>=r&&n.z<i},n._splitNode=function(t,e,n,r,i,o,s,a,l){for(var h=t.z+1,u=this.getSpatialReference(),{idx:c,idy:f}=t,d=a||this.getRenderer(),p=!1,g=[],m=u.getResolution(h)/l,A=0;A<4;A++){var y=A%2,v=A>>1,x=(c<<1)+y,_=(f<<1)+v;t.children||(t.children=[]);var b=t.children[A];b||(b=this._getTileId(x,_,h),t.children[A]=b);var w=d.isTileCachedOrLoading(b),T=w&&w.info;T||(this.tileInfoCache||(this.tileInfoCache=new Wi(4*this.options.maxCacheSize)),(T=this.tileInfoCache.get(b))||(T=this._createChildNode(t,y,v,s,b))),T.error=t.error/2,T.offset[0]=s[0],T.offset[1]=s[1];var M=this._isTileVisible(T,e,m,o,s);if(1===M)p=!0;else{if(-1===M)continue;if(0===M&&h!==o)return r.push(t),void i._combine(t.extent2d)}g.push(T)}h===o?p?n.push(...g):(r.push(t),i._combine(t.extent2d)):n.push(...g)},n._createChildNode=function(t,e,n,r,i){var o,{x:s,y:a,idx:l,idy:h,extent2d:u}=t,c=t.z+1,f=(s<<1)+e,d=(a<<1)+n,p=(l<<1)+e,g=(h<<1)+n,m=u.getWidth()/2*2,A=u.getHeight()/2*2,y=2*u.xmin,v=2*u.ymax,x=2*u.ymin,_=this._getTileConfig().tileSystem.scale.y;if(i=i||this._getTileId(p,g,c),_<0){var b=y+e*m,w=v-n*A;o=new vs(b,w-A,b+m,w)}else{var T=y+e*m,M=x+n*A;o=new vs(T,M,T+m,M+A)}var C=this.createTileNode(f,d,c,p,g,t.res/2,t.error/2,t.id,o,i);return this.tileInfoCache.add(i,C),C},n._isTileVisible=function(t,e,n,r,i){if(0===t.z)return 1;if(!this._isTileInFrustum(t,e,n,i))return-1;var o=this.options.maxError;return U(o)&&(o=1),this._getScreenSpaceError(t,n,r,i)>=o?1:0},n._isTileInFrustum=function(t,e,n,r){if(!this._zScale){var i=this.getMap(),o=i.getGLRes();this._zScale=i.altitudeToPoint(100,o)/100}var s=this.getRenderer(),{xmin:a,ymin:l,xmax:h,ymax:u}=t.extent2d;if(t.offset&&!X(this.options.offset)){var[c,f]=t.offset;a+=c,h+=c,l+=f,u+=f}vf[0][0]=(a-r[0])*n,vf[0][1]=(l-r[1])*n;var d=t.minAltitude||s&&s.avgMinAltitude||0;vf[0][2]=d*this._zScale,vf[1][0]=(h-r[0])*n,vf[1][1]=(u-r[1])*n;var p=t.maxAltitude||s&&s.avgMaxAltitude||0;return vf[1][2]=p*this._zScale,rf(e,vf)},n._getScreenSpaceError=function(t,e,n,r){var i=t.error,o=this.getMap(),{xmin:s,ymin:a,xmax:l,ymax:h}=t.extent2d;xf[0]=(s-r[0])*e,xf[1]=(a-r[1])*e,_f[0]=(l-r[0])*e,_f[1]=(h-r[1])*e;var u,c,f,d,p,g,m=(u=xf,c=_f,f=o.cameraPosition,d=Math.max(u[0]-f[0],0,f[0]-c[0]),p=Math.max(u[1]-f[1],0,f[1]-c[1]),g=Math.max(u[2]-f[2],0,f[2]-c[2]),Math.sqrt(d*d+p*p+g*g)),A=Math.max(Math.abs(m),1e-7),y=Math.abs(t.z-n),v=i*(o.height<1e3||y<=1?1:y<=2?.7:.605)/A*this.options.tileErrorScale;return this.getMap().getPitch()<=60?1.45*v:v},n._getCascadeTiles=function(t,e){var n=this.getMap(),r=n.getPitch(),i=e&&e.getRenderer(),o=n.getContainerExtent(),s=[],a=0,l=this.getMinZoom(),h=n.options.cascadePitches[0],u=n.options.cascadePitches[1],c=Math.floor(n._getVisualHeight(u)),f=U(t)?this._getTileZoom(n.getZoom()):t;if(this._visitedTiles=new uf,!U(t)||!this.options.cascadeTiles||r<=h||!U(l)&&f<=l){var d=r<=u?o:new vs(0,n.height-c,n.width,n.height),p=this._getTiles(f,d,2,i);return p&&(a+=p.tiles.length,s.push(p)),{tileGrids:s,count:a}}var g=Math.floor(n._getVisualHeight(h)),m=new vs(0,n.height-g,n.width,n.height),A=this._getTiles(f,m,0,i);a+=A?A.tiles.length:0,s.push(A);var y,v,x=m.ymin,_=n.getSpatialReference().getZoomDirection(),b=_;if(r>u){f-b<=l&&(b=0);var w=new vs(0,n.height-c,n.width,x);a+=(y=this._getTiles(f-b,w,1,i))?y.tiles.length:0,x=w.ymin,b+=4*_,s.push(y)}if(f-b>=l){var T=new vs(0,o.ymin,n.width,x);a+=(v=this._getTiles(f-b,T,2,i))?v.tiles.length:0,s.push(v)}return y&&v&&(s[1]=v,s[2]=y),{tileGrids:s,count:a}},n.getTileUrl=function(t,e,n){var r=this.options.urlTemplate,i="";if(this.options.subdomains){var o=this.options.subdomains;if(ie(o)){var s=(t+e)%o.length;s<0&&(s=0),i=o[s]}}if(X(r))return r(t,e,n,i);var a={x:t,y:e,z:n,s:i};return this.options.token&&(a.token=this.options.token),this.options.customTags&&j(a,this.options.customTags),r.replace(ff,(function(t,e){var n=a[e];if(void 0===n)throw new Error("No value provided for variable "+t);return"function"==typeof n&&(n=n(a)),n}))},n.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},n.getSpatialReference=function(){var t=this.getMap();if(t&&(!this.options.spatialReference||$l.equals(this.options.spatialReference,t.options.spatialReference)))return t.getSpatialReference();if(this._sr)return this._sr;var e=this.options.spatialReference;if(q(e)&&!(e=$l.getPreset(e)))throw new Error("Unsupported spatial reference: "+this.options.spatialReference+", possible values: "+$l.getAllPresets().join());return this._sr=new $l(e),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==t.getSpatialReference().toJSON().projection,this._sr},n.getMinZoom=function(){var t=this.options.minZoom||0;return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.max(t,this._srMinZoom):t},n.getMaxZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},n._getTileZoom=function(t){if(!this._hasOwnSR){var e=this.getMap().getResolution(t),n=this.getSpatialReference().getResolution(t);t+=Math.log(n/e)*Math.LOG2E}var r=this.getMaxAvailableZoom();return!U(r)&&t>r&&(t=r),G(t)||(t=Math.round(t)),t=Math.max(0,t)},n.getMaxAvailableZoom=function(){var t=this.getSpatialReference();return this.options.maxAvailableZoom||t&&t.getMaxZoom()},n._getTiles=function(t,e,n,r,i){var o=this.getMap(),s=t,a=o.projViewMatrix,l=o.getResolution(t)/o.getResolution(t-1)==.5;n<2&&(0===n&&l&&(s-=1),a=0===n?o.cascadeFrustumMatrix0:1===n?o.cascadeFrustumMatrix1:o.projViewMatrix);var h=s+this.options.zoomOffset,u=this._getTileOffset(s),c=u[0]||u[1],f={zoom:s,extent:null,offset:u,tiles:[]};if(h<0)return f;if(!(o&&this.isVisible()&&o.width&&o.height))return f;if(!i){var d=this.getMinZoom(),p=this.getMaxZoom();if(!U(d)&&s<d||!U(p)&&s>p)return f}var g=this._getTileConfig();if(!g)return f;var m,A={zoom:u},y=this.getSpatialReference().getResolution(s);m=this._hasOwnSR?o.getGLScale(s):y/o.getGLRes();var v=!this._hasOwnSR&&this.options.repeatWorld,x=this._convertToExtent2d(e),_=this._getMask2DExtent();if(_){var b=_.intersection(x);if(!b)return f;e=b.convertTo((function(t){return o._pointToContainerPoint(t,void 0,0,lf)}))}var w,T=o._containerPointToPrj(e.getCenter(),df),M=o._prjToPoint(T,s,pf);w=c?this._project(o._pointToPrj(M._add(u),s,pf),pf):this._project(T,pf);var C=o.getGLScale()/o.getGLScale(s);gf.x=x.xmin*C,gf.y=x.ymax*C,mf.x=x.xmax*C,mf.y=x.ymin*C;for(var S=this._project(o._pointToPrj(gf._add(u),s,gf),gf),I=this._project(o._pointToPrj(mf._add(u),s,mf),mf),P=g.getTileIndex(w,y,v),E=g.getTileIndex(S,y,v),O=g.getTileIndex(I,y,v),R=Math.ceil(Math.abs(P.idy-E.idy)),k=Math.ceil(Math.abs(P.idx-E.idx)),L=Math.ceil(Math.abs(P.idy-O.idy)),D=Math.ceil(Math.abs(P.idx-O.idx)),N=(R+L+1)*(k+D+1),F=this.getTileSize(),z=this.getRenderer()||r,B=this._getTileConfig().tileSystem.scale,H=[],j=new vs,V=new Vt(0,0),G=-R;G<=L;G++)for(var W=-k,q=-1/0,X=!1;W>=q&&W<=D;){var Z=g.getNeighorTileIndex(P.idx,P.idy,W,G,y,v);q===-1/0?W++:W--;var Y=this._getTileId(Z.idx,Z.idy,s);if(!(Z.out||this._visitedTiles&&this._visitedTiles.has(Y))){var J=z&&z.isTileCachedOrLoading(Y);J&&(J=J.info);var Q=void 0;if(J){var{extent2d:K}=J;V.set(K.xmin,K.ymax),Q=V}else if(this._hasOwnSR){var $=g.getTilePrjNW(Z.x,Z.y,y);Q=o._prjToPoint(this._unproject($,mf),s)}else Q=g.getTilePointNW(Z.x,Z.y,y);var tt=void 0,et=void 0;if(this._hasOwnSR){var nt=void 0;if(this._hasOwnSR){var rt=g.getTilePrjSE(Z.x,Z.y,y);nt=o._prjToPoint(this._unproject(rt,mf),s,mf)}else nt=g.getTilePointSE(Z.x,Z.y,y);tt=Math.ceil(Math.abs(nt.x-Q.x)),et=Math.ceil(Math.abs(nt.y-Q.y))}else tt=F.width,et=F.height;var it=B.x*(Z.idx-Z.x)*tt,ot=B.y*(Z.idy-Z.y)*et;J||!it&&!ot||Q._add(it,ot);var st=J&&J.extent2d||new vs(Q.x,Q.y-et,Q.x+tt,Q.y);if(N<=4||X||this._isTileInExtent(a,st,u,m)){var at=this._hasOwnSR?o._getResolution(s):y;this._visitedTiles&&0===n&&this._visitedTiles.add(Y),l&&0===n?(this._splitTiles(a,H,z,Z,s+1,at,st,it,ot,A),j._combine(st)):(J?(J.offset[0]=u[0],J.offset[1]=u[1]):J=this.createTileNode(Z.x,Z.y,s,Z.idx,Z.idy,at,0,null,st,Y),H.push(J),j._combine(st)),q===-1/0?(q=W,W=D):X||(X=!0)}}}if(H.length){var lt=o._containerPointToPoint(e.getCenter(),s,lf)._add(u),ht=new Vt(0,0),ut=new Vt(0,0);H.sort((function(t,e){return ht.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),ut.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),ht.distanceTo(lt)-ut.distanceTo(lt)}))}return{offset:u,zoom:t,extent:j,tiles:H}},n._convertToExtent2d=function(t){var e=this,n=this.getMap();return t.convertTo((function(t){if(t.y>0&&t.y<n.height){var r=(0===t.x?0:1)+t.y;e._coordCache[r]||(e._coordCache[r]=n._containerPointToPoint(t)),e._coordCache[r]}return n._containerPointToPoint(t,void 0,lf)}))},n._splitTiles=function(t,e,n,r,i,o,s,a,l,h){var u=this._getTileConfig().tileSystem.scale.y,c=this.getMap().getGLScale(i),f=Af.set(2*s.xmin,u<0?2*s.ymax:2*s.ymin),d=s.getWidth(),p=s.getHeight(),g=2*r.idx,m=2*r.idy,A=2*r.x,y=2*r.y,v=this._checkAndAddTile(t,n,g,m,A,y,i,o,0,0,d,p,f,c,h);v&&e.push(v),(v=this._checkAndAddTile(t,n,g,m,A,y,i,o,0,1,d,p,f,c,h))&&e.push(v),(v=this._checkAndAddTile(t,n,g,m,A,y,i,o,1,0,d,p,f,c,h))&&e.push(v),(v=this._checkAndAddTile(t,n,g,m,A,y,i,o,1,1,d,p,f,c,h))&&e.push(v)},n._checkAndAddTile=function(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p){var g=this._getTileId(n+l,r+h,s);if(this._visitedTiles&&this._visitedTiles.has(g))return null;var m=p[s];m||(m=p[s]=this._getTileOffset(s));var A=this._getTileConfig().tileSystem.scale.y,y=new vs(f.x+l*u,f.y+A*h*c,f.x+(l+1)*u,f.y+A*(h+1)*c);if(!this._isSplittedTileInExtent(t,y,m,d))return null;var v=a/2,x=e&&e.isTileCachedOrLoading(g);return x?x.info:this.createTileNode(i+l,o+h,s,n+l,n+o,v,0,null,y,g)},n._getTileOffset=function(...t){var e=this.options.offset;return X(e)&&(e=e.call(this,...t)),V(e)&&(e=[e,e]),e||[0,0]},n.getTileId=function(t,e,n,r){return this._getTileId(t,e,n,r)},n._getTileId=function(t,e,n,r){return(r||this.getId())+"_"+t+"_"+e+"_"+n},n._project=function(t,e){if(this._hasOwnSR){var n=this.getMap().getProjection();return this.getSpatialReference().getProjection().project(n.unproject(t,e),e)}return t},n._unproject=function(t,e){if(this._hasOwnSR){var n=this.getMap(),r=this.getSpatialReference(),i=n.getProjection(),o=r.getProjection();return i.project(o.unproject(t,e),e)}return t},n._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),n=this.getSpatialReference(),r=n.getProjection(),i=n.getFullExtent();this._defaultTileConfig=new $c(t,Qc.getDefault(r),i,e),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new $c(t,this.options.tileSystem,i,e)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},n._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},n._bindMap=function(e){return this._onSpatialReferenceChange(),t.prototype._bindMap.apply(this,arguments)},n._isTileInExtent=function(t,e,n,r){var i,o,s,a,l,h,u,c,f=this.getMap();if(t!==f.projViewMatrix){var d=e.getCenter(yf)._sub(n[0],n[1])._multi(r);Yr(bf,d.x,d.y,0),i=(o=bf,s=bf,a=f.projViewMatrix,l=s[0],h=s[1],u=s[2],c=(c=a[3]*l+a[7]*h+a[11]*u+a[15])||1,o[0]=(a[0]*l+a[4]*h+a[8]*u+a[12])/c,o[1]=(a[1]*l+a[5]*h+a[9]*u+a[13])/c,o[2]=(a[2]*l+a[6]*h+a[10]*u+a[14])/c,o)[1]<0?f.projViewMatrix:t}else i=f.projViewMatrix;return vf[0][0]=(e.xmin-n[0])*r,vf[0][1]=(e.ymin-n[1])*r,vf[1][0]=(e.xmax-n[0])*r,vf[1][1]=(e.ymax-n[1])*r,rf(i,vf)},n._isSplittedTileInExtent=function(t,e,n,r){var i=this.getMap();return vf[0][0]=(e.xmin-n[0])*r,vf[0][1]=(e.ymin-n[1])*r,vf[1][0]=(e.xmax-n[0])*r,vf[1][1]=(e.ymax-n[1])*r,rf(i.projViewMatrix,vf)},n.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},n._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var t=this.getRenderer();t&&t.clear()},n.getPolygonOffsetCount=function(){return 2},n.getPolygonOffset=function(){return this._polygonOffset||0},n.setPolygonOffset=function(t){return this._polygonOffset=t,this},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},n._getTileBBox=function(t){var e=this.getMap();if(e){var n=t.extent2d,r=t.offset||[0,0];if(n){var i=t.res,[o,s]=r,{xmin:a,ymin:l,xmax:h,ymax:u}=n;h-=o,u-=s;var c=new Vt(a-=o,l-=s),f=new Vt(h,u),d=e.pointAtResToCoordinate(c,i,df),p=e.pointAtResToCoordinate(f,i,pf);return[d.x,d.y,p.x,p.y]}}},n._tileInMask=function(t){var e=this.getMask();if(!e)return!0;var n=e.type;if(!n||-1===n.indexOf("Polygon"))return!0;var r=this._maskGeoJSON;if(!r||!r.geometry)return!0;var{coordinates:i,type:o}=r.geometry;if(!i||!o)return!0;if(-1===o.indexOf("Polygon"))return!0;if(!r.bbox){var s=e.getExtent();if(!s)return!0;r.bbox=[s.xmin,s.ymin,s.xmax,s.ymax]}var a=this._getTileBBox(t);return!a||function(t,e){var n=e.bbox;if(!n)return console.error("maskGeoJSON bbox is null:",e),!1;if(function(t,e){return!(t[2]<e[0]||t[1]>e[3]||t[0]>e[2]||t[3]<e[1])}(n,t)){var r=e.geometry;if(!r)return console.error("maskGeoJSON is error,not find geometry.",e),!1;var{coordinates:i}=r;"Polygon"===r.type&&(i=[i]);for(var o=0,s=i.length;o<s;o++){var a=i[o][0],l=Nr.polygon(a,t);if(l.length>0){for(var h=1/0,u=-1/0,c=1/0,f=-1/0,d=0,p=l.length;d<p;d++){var[g,m]=l[d];h=Math.min(g,h),c=Math.min(m,c),u=Math.max(g,u),f=Math.max(m,f)}if(h!==u&&c!==f)return!0}}return!1}return!1}(a,this._maskGeoJSON)},e}(ch);function Tf(t,e){return t.z-e.z}wf.registerJSONType("TileLayer"),wf.mergeOptions(cf);var Mf=new Ie(256,256),Cf="show hide remove setzindex forcereloadstart";function Sf(t){return Array.isArray(t)||(t=[t]),t}var If=function(t){function e(e,n,r){var i;return(i=t.call(this,e,r)||this).layers=n||[],i._checkChildren(),i.layerMap={},i._groupChildren=[],i}kt(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var n=t.layers.map((function(t){return ch.fromJSON(t)}));return new e(t.id,n,t.options)};var n=e.prototype;return n.getLayers=function(){return this.layers},n.addLayer=function(t=[]){var e=this;t=Sf(t);var n=this.layers.length;return t.forEach((function(t){t instanceof wf&&(-1!==e.layers.indexOf(t)||e.layerMap[t.getId()]||e.layers.push(t))})),n!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},n.removeLayer=function(t=[]){var e=this;t=Sf(t);var n=this.layers.length;return t.forEach((function(t){if(t instanceof wf||(t=e.layerMap[t]),t instanceof wf){var n=e.layers.indexOf(t);n>=0&&(e.layers.splice(n,1),t._doRemove(),t.off(Cf,e._onLayerShowHide,e))}})),n!==this.layers.length&&(this._refresh(),this._renderLayers()),this},n.clearLayers=function(){var t=this;return this.layers.forEach((function(e){e._doRemove(),e.off(Cf,t._onLayerShowHide,t)})),this.layers=[],this._refresh(),this._renderLayers(),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(t){return t.toJSON()})),options:this.config()}},n.getTileSize=function(t){var e=this.getLayer(t);return e?e.getTileSize():Mf},n.getTiles=function(t,e){for(var n=this.layers,r=[],i=0,o=0,s=n.length;o<s;o++){var a=n[o];if(a&&a.options.visible&&a.isVisible()&&a.getMap()){var l=a.getTiles(t,e||this);l&&0!==l.count&&(i+=l.count,Jt(r,l.tileGrids))}}return{count:i,tileGrids:r}},n.onAdd=function(){this._sortLayers(),this._refresh(),t.prototype.onAdd.call(this)},n.onRemove=function(){var e=this;this.layers.forEach((function(t){t._doRemove(),t.off(Cf,e._onLayerShowHide,e)})),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},n.getLayer=function(t){return this.getChildLayer(t)},n.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var n=0;n<this._groupChildren.length;n++){var r=this._groupChildren[n].getChildLayer(t);if(r)return r}return null},n._removeChildTileCache=function(t){if(!t)return this;var e,n=this.getRenderer();if(!n)return this;var r=t.getId(),i=function(){return e&&e.info&&e.info.layer===r};n.tileCache&&n.tileCache.keys().forEach((function(t){e=n.tileCache.get(t),i()&&n.tileCache.remove(t)}));var o=n.tilesInView||{};for(var s in o)e=o[s],i()&&delete o[s];var a=n.tilesLoading||{};for(var l in a)e=a[l],i()&&n.abortTileLoading(e.image,e.info);return this},n._onLayerShowHide=function(t){var{type:e,target:n}=t||{};"remove"===e&&n?(this.layers.splice(this.layers.indexOf(n),1),n._doRemove(),n.off(Cf,this._onLayerShowHide,this),this._refresh()):"setzindex"===e?this._sortLayers():"forcereloadstart"===e&&this._removeChildTileCache(n),this._renderLayers()},n._renderLayers=function(){var t=this.getRenderer();return t&&t.setToRedraw(),this},n._refresh=function(){var t=this,e=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach((function(n){t.layerMap[n.getId()]=n,n.getChildLayer&&t._groupChildren.push(n),n.getMap()||n._bindMap(e),n.off(Cf,t._onLayerShowHide,t),n.on(Cf,t._onLayerShowHide,t)})),this},n.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,n=0,r=e.length;n<r;n++)if(e[n].isVisible())return!0;return!1},n._checkChildren=function(){var t=this,e={};this.layers.forEach((function(n){var r=n.getId();if(e[r])throw new Error("Duplicate child layer id ("+r+") in the GroupTileLayer ("+t.getId()+")");e[r]=1}))},n._sortLayers=function(){this.layers.sort((function(t,e){return t.options.zIndex-e.options.zIndex}))},e}(wf);If.registerJSONType("GroupTileLayer"),If.mergeOptions({urlTemplate:"",maxCacheSize:1024});var Pf,Ef={urlTemplate:"",crs:null,uppercase:!1,detectRetina:!1},Of={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Rf=function(t){function e(e,n){var r;return r=t.call(this,e)||this,Pf||(Pf=j({},r.options)),r.wmsParams=j({},Of),r.setOptions(n),r.setZIndex(n.zIndex),Pt.proxy||r._optionsHook(n),r}kt(e,t);var n=e.prototype;return n._optionsHook=function(t={}){for(var e in t)"tileSize"===e&&(this._tileSize=null),e in Pf||(this.wmsParams[e]=t[e]);var n=this.getTileSize();return this.wmsParams.width=n.width,this.wmsParams.height=n.height,this._wmsVersion=parseFloat(this.wmsParams.version),this},n.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),n=Ef.detectRetina?e:1;this.wmsParams.width*=n,this.wmsParams.height*=n;var r=this.options.crs||this.getMap().getProjection().code,i=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[i]=r,t.prototype.onAdd.call(this)},n.getTileUrl=function(e,n,r){var i=this.getSpatialReference().getResolution(r),o=this._getTileConfig().getTilePrjExtent(e,n,i),s=o.getMax(),a=o.getMin(),l=(this._wmsVersion>=1.3&&("EPSG:4326"===this.wmsParams.crs||"EPSG:4490"===this.wmsParams.crs)?[a.y,a.x,s.y,s.x]:[a.x,a.y,s.x,s.y]).join(","),h=t.prototype.getTileUrl.call(this,e,n,r);return h+function(t,e,n){var r=[];for(var i in t)r.push(encodeURIComponent(n?i.toUpperCase():i)+"="+encodeURIComponent(t[i]));return(e&&-1!==e.indexOf("?")?"&":"?")+r.join("&")}(this.wmsParams,h,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+l},n.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(wf);Rf.registerJSONType("WMSTileLayer"),Rf.mergeOptions(Ef);var kf=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).options.hasOwnProperty("forceRenderOnMoving")||(r.options.forceRenderOnMoving=!1),r}kt(e,t);var n=e.prototype;return n.drawTile=function(){},n.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(wf);function Lf(t,e,n){var r=t.createShader(e);if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(r);throw t.deleteShader(r),new Error("Failed to compile shader: "+i)}return r}function Df(t,e,n){var r=Lf(t,t.VERTEX_SHADER,e),i=Lf(t,t.FRAGMENT_SHADER,n);if(!r||!i)return null;var o=t.createProgram();return o?(t.attachShader(o,r),t.attachShader(o,i),t.linkProgram(o),{program:o,vertexShader:r,fragmentShader:i}):null}function Nf(t,e,n){if(Array.isArray(n[0])){for(var r=Float32Array.BYTES_PER_ELEMENT,i=0,o=0;o<n.length;o++)i+=n[o][1]||0;for(var s=0,a=0;a<n.length;a++){var l=t.getAttribLocation(e,n[a][0]);if(l<0)throw new Error("Failed to get the storage location of "+n[a][0]);t.vertexAttribPointer(l,n[a][1],t[n[a][2]||"FLOAT"],!1,r*i,r*s),s+=n[a][1]||0,t.enableVertexAttribArray(l)}}else{var h=t.getAttribLocation(e,n[0]);t.vertexAttribPointer(h,n[1],t[n[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(h)}}kf.registerJSONType("CanvasTileLayer");var Ff={never:512,"<":513,"=":514,"<=":515,">":516,"!=":517,">=":518,always:519};var zf=[1,1,1,1],Bf=new Float32Array(8),Hf=new Int16Array(8),jf="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",Uf="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n        uniform vec4 u_base_color;\n        uniform float u_alpha_test;\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n            gl_FragColor *= u_base_color;\n            if (gl_FragColor.a < u_alpha_test) {\n                discard;\n            }\n        }\n    ",Vf=["",0],Gf=[0,0,0],Wf=new Array(16),qf=new Vt(20,20),Xf=function(t){var e=function(t){function e(){var e;return(e=t.apply(this,arguments)||this)._layerAlt=0,e._layerAltitude=0,e}kt(e,t);var n=e.prototype;return n.drawGLImage=function(t,e,n,r,i,o,s,a,l){this.gl.program!==this.program&&this.useProgram(this.program);var h=this.gl;if(this.loadTexture(t),this.canvas.gl&&this.canvas.gl.wrap){var u=this.layer&&this.layer.options.opacity;U(u)&&(u=1),s*=u}Gf[0]=e||0,Gf[1]=n||0,Gf[2]=0;var c=this.layer;if(c){var{altitude:f}=c.options,d=V(f);if(d||(this._layerAlt=0),this._layerAltitude!==f&&d){var p=c.getMap();if(p){var g=p.altitudeToPoint(f,p.getGLRes());this._layerAltitude=f,this._layerAlt=g}}}Gf[2]=this._layerAlt||0;var m=Pr(Wf);Mr(m,m,Gf),Cr(m,m,[o,o,1]),Sr(m,this.getMap().projViewMatrix,m),h.uniformMatrix4fv(this.program.u_matrix,!1,m),h.uniform1f(this.program.u_opacity,s),h.uniform1f(this.program.u_debug_line,0),h.uniform4fv(this.program.u_base_color,l||zf),h.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0);var{glBuffer:A}=t;!A||A.width===r&&A.height===i||(this.saveImageBuffer(A),delete t.glBuffer),t.glBuffer?h.bindBuffer(h.ARRAY_BUFFER,A):t.glBuffer=this.bufferTileData(0,0,r,i),Vf[0]="a_position",Vf[1]=2,Vf[2]=t.glBuffer.type,this.enableVertexAttrib(Vf),h.bindBuffer(h.ARRAY_BUFFER,this.texBuffer),Vf[0]="a_texCoord",Vf[1]=2,Vf[2]="UNSIGNED_BYTE",this.enableVertexAttrib(Vf),h.drawArrays(h.TRIANGLE_STRIP,0,4),a&&this.drawDebug(m,0,0,r,i,a)},n.drawDebug=function(t,e,n,r,i,o){var s=this.gl;s.disable(s.DEPTH_TEST),s.bindBuffer(s.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),s.bufferData(s.ARRAY_BUFFER,new Float32Array([e,n,e+r,n,e+r,n-i,e,n-i,e,n]),s.DYNAMIC_DRAW),s.uniformMatrix4fv(this.program.u_matrix,!1,t),s.uniform1f(this.program.u_opacity,1),s.uniform1f(this.program.u_debug_line,1),s.uniform4fv(this.program.u_base_color,zf),s.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0),s.drawArrays(s.LINE_STRIP,0,5);var a=this._debugInfoCanvas;if(!a){var l=this.getMap().getDevicePixelRatio()>1?2:1;(a=this._debugInfoCanvas=document.createElement("canvas")).width=256*l,a.height=32*l;var h=a.getContext("2d");h.font="20px monospace",h.scale(l,l)}var u=a.getContext("2d");u.clearRect(0,0,a.width,a.height);var c=this.layer.options.debugOutline;Oo.fillText(u,o,qf,c),this.loadTexture(a),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,a);var f=e,d=e+(r=256),p=n-i+32,g=n-i;s.bufferData(s.ARRAY_BUFFER,this.set8(f,p,f,g,d,p,d,g),s.DYNAMIC_DRAW),s.uniform1f(this.program.u_debug_line,0),s.bindBuffer(s.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),s.drawArrays(s.TRIANGLE_STRIP,0,4),s.enable(s.DEPTH_TEST)},n.bufferTileData=function(t,e,n,r,i){var o,s=t,a=t+n,l=e,h=e-r;o=G(s)&&G(a)&&G(l)&&G(h)?this.set8Int(s,l,s,h,a,l,a,h):this.set8(s,l,s,h,a,l,a,h);var u=this.loadImageBuffer(o,i);return u.width=n,u.height=r,u.type=o instanceof Int16Array?"SHORT":"FLOAT",u},n.createCanvas2=function(){this.canvas2=Oo.createCanvas(this.canvas.width,this.canvas.height)},n.createGLContext=function(){this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():this.gl=function(t,e){for(var n={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},r=["webgl","experimental-webgl"],i=null,o=0;o<r.length;++o){try{i=t.getContext(r[o],e||n)}catch(Wp){}if(i)break}return i}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(jf,this.layer.options.fragmentShader||Uf),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),t.bufferData(t.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},n.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},n.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)),this.gl.wrap||this.gl.clear(this.gl.DEPTH_BUFFER_BIT)},n.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},n._createTexture=function(t){var e=this.gl,n=this.getTexture()||e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var r=this.layer.options.mipmapTexture;return!r||Zf(t.width)&&Zf(t.height)||(t=function(t){if(Zf(t.width)&&Zf(t.height))return t;var e=t.width,n=t.height;Zf(e)||(e=Yf(e));Zf(n)||(n=Yf(n));var r=document.createElement("canvas");r.width=e,r.height=n;var i=r.getContext("2d");return i.imageSmoothingEnabled=!1,i.drawImage(t,0,0,e,n),r}(t)),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),r&&e.generateMipmap(e.TEXTURE_2D),n},n.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},n.saveTexture=function(t){this._textures.push(t)},n.loadTexture=function(t){var e=this.getMap(),n=this.gl,r=t.texture;return r||(r=this._createTexture(t),t.texture=r),n.bindTexture(n.TEXTURE_2D,r),this.layer.options.mipmapTexture&&(e.isMoving()&&e.getRenderer().isViewChanged()?n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR):n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR)),r},n.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},n.saveImageBuffer=function(t){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(t)},n.loadImageBuffer=function(t,e){var n=this.gl,r=e||this.createImageBuffer();return n.bindBuffer(n.ARRAY_BUFFER,r),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW),r},n.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},n.removeGLCanvas=function(){var t=this.gl;if(t){if(this._debugBuffer&&(t.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(e){t.deleteBuffer(e)})),delete this._buffers),this._textures&&(this._textures.forEach((function(e){return t.deleteTexture(e)})),delete this._textures),this._debugInfoCanvas){var e=this._debugInfoCanvas.texture;e&&t.deleteTexture(e),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var n=t.program;t.deleteShader(n.fragmentShader),t.deleteShader(n.vertexShader),t.deleteProgram(n),delete this.gl,delete this.canvas2}},n.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},n.enableVertexAttrib=function(t){Nf(this.gl,this.gl.program,t)},n.createProgram=function(t,e){for(var n=this.gl,{program:r,vertexShader:i,fragmentShader:o}=Df(n,t,e),s=n.getProgramParameter(r,35718),a=[],l=0;l<s;++l){var h=n.getActiveUniform(r,l);a.push(h.name)}return r.vertexShader=i,r.fragmentShader=o,this._initUniforms(r,a),r},n.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},n.enableSampler=function(t,e){var n=this.gl,r=this._getUniform(n.program,t);return e||(e=0),n.uniform1i(r,e),r},n._initUniforms=function(t,e){for(var n=0;n<e.length;n++){var r=e[n],i=e[n],o=r.indexOf("[");o>=0&&(r=r.substring(0,o),z||(i=i.substring(0,o))),t[r]=this._getUniform(t,i)}},n._getUniform=function(t,e){var n=this.gl.getUniformLocation(t,e);if(!n)throw new Error("Failed to get the storage location of "+e);return n},n.set8=function(t,e,n,r,i,o,s,a){var l=Bf;return l[0]=t,l[1]=e,l[2]=n,l[3]=r,l[4]=i,l[5]=o,l[6]=s,l[7]=a,l},n.set8Int=function(t,e,n,r,i,o,s,a){var l=Hf;return l[0]=t,l[1]=e,l[2]=n,l[3]=r,l[4]=i,l[5]=o,l[6]=s,l[7]=a,l},e}(t);return e};function Zf(t){return!(t&t-1)&&0!==t}function Yf(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}var Jf={renderer:Pt.webgl?"gl":"canvas",crossOrigin:null,alphaTest:!1,depthMask:!0,depthFunc:"<="},Qf=new Vt(0,0),Kf=function(t){function e(e,n,r){var i;return!n||Array.isArray(n)||n.url||(r=n,n=null),(i=t.call(this,e,r)||this)._images=n,i}kt(e,t);var n=e.prototype;return n.onAdd=function(){this._prepareImages(this._images)},n.setImages=function(t){return this._images=t,this._prepareImages(t),this},n.getImages=function(){return this._images},n._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap(),n=e.getGLRes();this._imageData=t.map((function(t){var r=new As(t.extent);return j({},t,{extent:r,extent2d:r.convertTo((function(t){return e.coordToPointAtRes(t,n)}))})})),this._images=t;var r=this.getRenderer();r&&r.refreshImages()},n.getRenderer=function(){return t.prototype.getRenderer.call(this)},e}(ch);Kf.mergeOptions(Jf);var $f,td,ed=[],nd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},n.checkResources=function(){var t=this;if(this._imageLoaded)return ed;var e=this.layer._imageData.map((function(t){return[t.url,null,null]}));if(this.resources){var n=[],r=new xa;e.forEach((function(e){if(t.resources.isResourceLoaded(e)){var i=t.resources.getImage(e);r.addResource(e,i)}else n.push(e)})),this.resources.forEach((function(e,n){r.isResourceLoaded(e)||t.retireImage(n.image)})),this.resources=r,e=n}return this._imageLoaded=!0,e},n.retireImage=function(t){var e=t;e.close&&e.close()},n.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},n.draw=function(t,e){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(t,e),this.completeRender())},n._drawImages=function(t,e){var n=this.layer._imageData,r=this.getMap(),i=r.get2DExtentAtRes(r.getGLRes());if(n&&n.length)for(var o=0;o<n.length;o++){var s=n[o].extent2d,a=this.resources&&this.resources.getImage(n[o].url);if(a&&i.intersects(s)){this._painted=!0;var l=n[o].opacity;V(l)||(l=1),this._drawImage(a,s,l)}}},n._drawImage=function(t,e,n){var r=0,i=this.context;n<1&&(r=i.globalAlpha,i.globalAlpha=n);var o=this.getMap(),s=Qf.set(e.xmin,e.ymax),a=o._pointAtResToContainerPoint(s,o.getGLRes()),l=a.x,h=a.y,u=o.getBearing();u&&(i.save(),i.translate(l,h),u&&i.rotate(-u*Math.PI/180),l=h=0);var c=o.getGLScale();i.drawImage(t,l,h,e.getWidth()/c,e.getHeight()/c),u&&i.restore(),r&&(i.globalAlpha=r)},n.drawOnInteracting=function(t,e,n){this.draw()},e}(va),rd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.drawOnInteracting=function(t,e,n){this.draw(e,n)},n._prepareGLContext=function(){var t,e=this.gl;if(e){e.disable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc((t=this.layer.options.depthFunc,Ff[t]));var n=!!this.layer.options.depthMask;e.depthMask(n)}},n._drawImages=function(e,n){var r=this.gl;if(n&&n.renderTarget){var i=n.renderTarget.fbo;if(i){var o=n.renderTarget.getFramebuffer(i);r.bindFramebuffer(r.FRAMEBUFFER,o)}}(this._prepareGLContext(),t.prototype._drawImages.call(this),n&&n.renderTarget)&&(n.renderTarget.fbo&&r.bindFramebuffer(r.FRAMEBUFFER,null))},n.isDrawable=function(){return!0},n._drawImage=function(t,e,n){this.drawGLImage(t,e.xmin,e.ymax,e.getWidth(),e.getHeight(),1,n)},n.createContext=function(){this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.retireImage=function(t){var e=t;e.close&&e.close(),this.disposeImage(t)},n.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(Xf(nd));Kf.registerRenderer("canvas",nd),Kf.registerRenderer("gl",rd),(td=$f||($f={}))[td.never=0]="never",td[td["<"]=1]="<",td[td["="]=2]="=",td[td["<="]=3]="<=",td[td[" >"]=4]=" >",td[td["!="]=5]="!=",td[td[">="]=6]=">=",td[td.always=7]="always";var id=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[]},n.getDrawParams=function(){return[]},n.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=Oo.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},n.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},n.draw=function(...t){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer(...t)},n.drawOnInteracting=function(...t){this._drawLayerOnInteracting(...t)},n.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var n=e.image;this.buffer.width===n.width&&this.buffer.height===n.height||(this.buffer.width=n.width,this.buffer.height=n.height);var r=this.buffer.getContext("2d"),i=this.layer.doubleBuffer(r,this.context);(void 0===i||i)&&(Oo.image(r,n,0,0),e.image=this.buffer)}return e},n.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},n.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},n.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},n.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},n.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},n.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},n.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},n.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},n.prepareDrawContext=function(){if(!this._predrawed){var t=od(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw(this.context,...t),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},n._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();return t.maskExtent&&!t.extent.intersects(t.maskExtent)?(this.completeRender(),null):[...[this.context,t],...od(this.getDrawParams()),...this._drawContext]},n._drawLayer=function(...t){var e=this._prepareDrawParams();e&&(this.layer.draw.apply(this.layer,e.concat(t)),this.completeRender())},n._drawLayerOnInteracting=function(...t){if(this.layer.drawOnInteracting){var e=this._prepareDrawParams();e&&(this.layer.drawOnInteracting(...e,...t),this.completeRender())}},e}(va);function od(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var sd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.isCanvasRender=function(){return!0},n.prepareToDraw=function(){},n.draw=function(...t){},n.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},n.play=function(){return this.config("animation",!0),this},n.pause=function(){return this.config("animation",!1),this},n.isPlaying=function(){return this.options.animation},n.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},n.requestMapToRender=function(){var t=this._getRenderer();return t&&t.requestMapToRender&&t.requestMapToRender(),this},n.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},n.onCanvasCreate=function(){return this},n.onZoomStart=function(){},n.onZooming=function(){},n.onZoomEnd=function(){},n.onMoveStart=function(){},n.onMoving=function(){},n.onMoveEnd=function(){},n.onResize=function(){},n.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},n._getRenderer=function(){return t.prototype._getRenderer.call(this)},e}(ch);sd.mergeOptions({doubleBuffer:!1,animation:!1}),sd.registerRenderer("canvas",id);var ad=new Vt(0,0),ld=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.getParticles=function(t){},n.draw=function(t,e){var n=this.getParticles(H());if(n&&0!==n.length){var r=this.getMap(),i=e.extent;e.maskExtent&&(i=e.extent.intersection(e.maskExtent)),i=i.convertTo((function(t){return r._pointToContainerPoint(t,void 0,0,ad)}));for(var o=2*Math.PI,s=0,a=n.length;s<a;s++){var l=n[s].point;if(i.contains(l)){var h=n[s].color||this.options.lineColor||"#fff",u=n[s].r;t.fillStyle!==h&&(t.fillStyle=h),u<=2?t.fillRect(l.x-u/2,l.y-u/2,u,u):(t.beginPath(),t.arc(l.x,l.y,u/2,0,o),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},n._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var n=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/n+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(sd);ld.mergeOptions({animation:!0}),ld.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},n.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},n.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(id));var hd,ud,cd=new xa,fd=function(t){function e(e,n,r){var i;(i=t.call(this,r)||this).target=e,e.once("remove",i.delete,i);var o=i.options.symbol,s=o.markerLineWidth||1;return i.w=o.markerWidth+s,i.h=o.markerHeight+s,i.opacity=U(o.opacity)?1:o.opacity,i.map=n,i.events=r.events,i._fetchImage(),i.addTo(n),i}kt(e,t);var n=e.prototype;return n.getCursor=function(){return this.options.cursor||"default"},n._fetchImage=function(){var t=this.map,e=this.options.symbol,{markerFile:n}=e;this.url=n||Ar(e);var r=cd.getImage(this.url);if(!r){var i=this.w,o=this.h;if(n)(r=new Image).onload=function(){var e=t.getRenderer();e&&e.setToRedraw()},r.src=this.url;else{var s=document.createElement("canvas");s.width=i,s.height=o,r=el(s.getContext("2d"),{x:i/2,y:o/2},e,cd)}cd.addResource([this.url,i,o],r)}cd.login(this.url),this._img=r},n.setContainerPoint=function(t){this._point=t,this._point._sub(this.w/2,this.h/2)},n.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},n.offset=function(t){this._point._add(t)},n.render=function(t){if(!this._img)return!1;var e=this.options.symbol,n=e.markerDx||0,r=e.markerDy||0,i=this.map,{x:o,y:s}=this._point,a=this.w,l=this.h;if(o+a>0&&o<i.width&&s+l>0&&s<i.height){var h=i.getDevicePixelRatio();return t.globalAlpha=this.opacity,t.drawImage(this._img,Math.round((o+n)*h),Math.round((s+r)*h),Math.round(a*h),Math.round(l*h)),!0}return!1},n.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}cd.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},n.hitTest=function(t){var e=this.options.symbol,n=e.markerDx||0,r=e.markerDy||0,i=this.w,o=this.h,s=this._point.x+n,a=this._point.y+r;return t.x>=s&&t.x<=s+i&&t.y>=a&&t.y<=a+o},n.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},n.onEvent=function(t){this.fire(t.type,t)},n.mousedown=function(t){var e=t.target,n=this.options.cursor;n&&e.setCursor(n),this.onDragstart(t)},n.onDragstart=function(t){var{containerPoint:e,target:n}=t,r=n.getPanels().mapWrapper||n.getContainer(),i=this._dragger=new ns(r);i.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),i.onMouseDown(t.domEvent),hd=e.x,ud=e.y,this.fire("dragstart",{containerPoint:e})},n.onDragging=function(t){if(this._dragger){var e=this.map,n=ln(t.domEvent,e.getContainer()),r={x:n.x-hd,y:n.y-ud},i=e.containerPointToCoord(new Vt(hd,ud)),o=e.containerPointToCoord(n);hd=n.x,ud=n.y,this.offset(r),this.fire("dragging",{containerPoint:n,coordOffset:o._sub(i)})}},n.onDragend=function(t){if(this._dragger){var e=this.map;e.resetCursor();var n=ln(t.domEvent,e.getContainer()),r={x:n.x-hd,y:n.y-ud};this.offset(r),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:n})}},n.needCollision=function(){var{target:t}=this;return!this.options.ignoreCollision&&(t&&t.options&&t.options.collision)},n.getRenderBBOX=function(t){var{target:e,map:n}=this;if(!e||!e.options||!n)return null;var r=this.options.symbol,i=r.markerDx||0,o=r.markerDy||0,{x:s,y:a}=this._point,l=this.w,h=this.h;t=t||n.getDevicePixelRatio(),this.bbox=this.bbox||jr();var u=Math.round((s+i)*t),c=Math.round((a+o)*t),f=Math.round(l*t),d=Math.round(h*t);this.bbox[0]=u,this.bbox[1]=c,this.bbox[2]=u+f,this.bbox[3]=c+d;var{options:p}=e,g=p.collisionBufferSize||0;return Xr(this.bbox,g),this.bbox},n.setZIndex=function(t){this.options.zIndex=t},e}(zo(Ho)),dd=function(){function t(t,e,n){this.target=t,t.once("remove",this.delete,this),this.map=e,this.options=n,this.addTo(e)}var e=t.prototype;return e.setPoints=function(t){this.points=t;var e=t.map((function(t){return t.x})),n=t.map((function(t){return t.y}));this.xmin=Math.min(...e),this.xmax=Math.max(...e),this.ymin=Math.min(...n),this.ymax=Math.max(...n)},e.hitTest=function(){return!1},e.render=function(t){var e=this.map;if(!(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)){var n=e.getDevicePixelRatio();t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var r=this.points;t.moveTo(o(r[0].x),o(r[0].y));for(var i=1;i<this.points.length;i++)t.lineTo(o(r[i].x),o(r[i].y));t.closePath(),t.stroke()}function o(t){return Math.round(t)*n+.5}},e.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},e.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},t}(),pd=xe+"_edit_stage_";function gd(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}function md(t,e){var n=t.getGLRes(),r=t.coordToPointAtRes(e,n),i=e.z||0;return t._pointAtResToContainerPoint(r,n,i)}function Ad(t,e,n){var r=t.getMap();if(!e||0===e.z)return r.containerPointToCoord(n);var i=e.z,o=r.getGLRes(),s=r.coordToPointAtRes(e,o),a=r._pointAtResToContainerPoint(s,o,0),l=r._pointAtResToContainerPoint(s,o,i).sub(a),h=n.sub(l),u=r.containerPointToCoord(h);return u.z=0,!t.getGeometries&&t.isPoint&&(u.z=i),u}function yd(t){var e=this.target,n=this.paramOptions;return e._updating=!0,n.onDown&&(n.onDown.call(e,t.containerPoint,t),e._geometry.fire("handledragstart")),!1}function vd(t){var e=this.target,n=this.paramOptions;return e._hideContext(),n.onMove&&(n.onMove.call(e,t),e._geometry.fire("handledragging")),!1}function xd(t){var e=this.target,n=this.paramOptions;return n.onUp&&(n.onUp.call(e,t),e._geometry.fire("handledragend")),e._updating=!1,!1}var _d={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:gd("ellipse",1),vertexHandleSymbol:gd("square",1),newVertexHandleSymbol:gd("square",.4),collision:!1,collisionBufferSize:0,vertexZIndex:0,newVertexZIndex:0},bd=function(t){function e(e,n){var r;return(r=t.call(this,n)||this)._geometry=e,r._geometry?r:Ft(r)}kt(e,t);var n=e.prototype;return n.getMap=function(){return this._geometry.getMap()},n.prepare=function(){var t=this.getMap();t&&(t.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},n._prepareEditStageLayer=function(){var t=this._geometry.getLayer();if("canvas"===t.options.renderer){var e=this.getMap(),n=Xt(),r=pd+n+"_shadow";if(this._shadowLayer=e.getLayer(r),!this._shadowLayer){var i=t.constructor;this._shadowLayer=new i(r),e.addLayer(this._shadowLayer)}}},n.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var t,e=this._geometry,n="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=e.options.draggable,n?(e.config("draggable",!1),(t=e.copy()).setSymbol(e._getInternalSymbol()),t.copyEventListeners(e),e._getParent()&&t.copyEventListeners(e._getParent()),t._setEventTarget(e),t.setId(null).config({draggable:!1}),this._shadow=t,e.hide()):e instanceof Vh&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof Vh||e instanceof ou||e instanceof au||e instanceof su)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(t),e instanceof Vh?t&&(t.config("draggable",!0),t.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof Vh&&!1!==this.options.resize?this.createMarkerEditor():e instanceof ou?this.createCircleEditor():e instanceof au||e instanceof su?this.createEllipseOrRectEditor():e instanceof lu||(e instanceof Hh||e instanceof Wh)&&this.createPolygonEditor()}},n.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},n.isEditing=function(){return!U(this.editing)&&this.editing},n._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},n._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var n in e)this._geometry[t](n,e[n],this)}},n._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},n._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},n._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;e||(this._editOutline=new dd(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var n=this._editOutline.points;if(t instanceof Vh)this._editOutline.setPoints(t.getContainerExtent().toArray(n));else{var r=t.getShell(),i=t._getEditCenter(),o=jr();Gr(r,o);var s=new As(o[0],o[1],o[2],o[3]),a=this.getMap(),l=s.toArray().map((function(t){return t.z=i.z,md(a,t)}));this._editOutline.setPoints(l)}return e},n._createCenterHandle=function(){var t,e=this,n=this.getMap(),r=this.options.centerHandleSymbol,i=md(n,this._geometry._getEditCenter()),o=this.createHandle(i,{ignoreCollision:!0,symbol:r,cursor:"move",onDown:function(){if(e._shadow){var n=yr((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(n).addTo(e._geometry.getLayer())}},onMove:function(n){var r=n.coordOffset;t?t.translate(r):e._geometry.translate(r)},onUp:function(){if(t){var n=t.getFirstCoordinate(),r=e._geometry.getFirstCoordinate(),i=n.sub(r);e._update("translate",i),t.remove()}}});this._addRefreshHook((function(){var t=e._geometry._getEditCenter();o.setContainerPoint(md(n,t))}))},n._createHandleInstance=function(t,e){e=e||{};var n=this.getMap(),r=Wn(e.symbol,(function(){return[n.getZoom(),{"{bearing}":n.getBearing(),"{pitch}":n.getPitch(),"{zoom}":n.getZoom()}]})),i=this.options.removeVertexOn,o=new fd(this,n,{symbol:r,cursor:e.cursor,events:i,ignoreCollision:e.ignoreCollision});return o.setContainerPoint(t),o},n.createHandle=function(t,e){e||(e={});var n=this._createHandleInstance(t,e);return n.paramOptions=e,n.on("dragstart",yd),n.on("dragging",vd),n.on("dragend",xd),e.onRefresh&&(n.refresh=e.onRefresh),n},n._createResizeHandles=function(t,e,n){var r=this,i=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],s=this._geometry,a=s instanceof Vh,l=[];t||(t=[]);var h=this,u=[],c={},f=this.getMap(),d=this.options.vertexHandleSymbol,p=function(){for(var p=function(){if(a){var t=s.getContainerExtent();return[new Vt(t.xmin,t.ymin),new Vt((t.xmax+t.xmin)/2,t.ymin),new Vt(t.xmax,t.ymin),new Vt(t.xmin,(t.ymin+t.ymax)/2),new Vt(t.xmax,(t.ymin+t.ymax)/2),new Vt(t.xmin,t.ymax),new Vt((t.xmax+t.xmin)/2,t.ymax),new Vt(t.xmax,t.ymax)]}var e=s.getShell(),n=s._getEditCenter(),r=jr();Gr(e,r);var i=new As(r[0],r[1],r[2],r[3]);return(l=[new rs(i.xmin,i.ymax),new rs((i.xmax+i.xmin)/2,i.ymax),new rs(i.xmax,i.ymax),new rs(i.xmin,(i.ymax+i.ymin)/2),new rs(i.xmax,(i.ymax+i.ymin)/2),new rs(i.xmin,i.ymin),new rs((i.xmax+i.xmin)/2,i.ymin),new rs(i.xmax,i.ymin)]).map((function(t){return t.z=n.z,md(f,t)}))}(),g=function(a){if(Array.isArray(t)&&t.some((function(t){return t===a})))return 1;var f=p[a],g=l[a];if(u.length<p.length-t.length){var m=r.createHandle(f,{symbol:d,cursor:i[a],axis:o[a],onMove:function(t){return function(n){h._updating=!0,e(n.containerPoint,t),s.fire("resizing")}}(a),onUp:function(){h._updating=!1,n()}});c[a]=u.length,u.push(m),m.coord=g}else u[c[a]].coord=g,u[c[a]].setContainerPoint(f)},m=0;m<p.length;m++)g(m)};return p(),this._addRefreshHook(p),u},n.createMarkerEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();if(e._canEdit()){this._history||this._recordHistory(d());var r=e._getInternalSymbol(),i=new Vt(0,0);V(r.markerDx)&&(i.x=r.markerDx),V(r.markerDy)&&(i.y=r.markerDy);var o=null,s="middle",a="middle";if(Cl.test(r)){var l=r.markerType;"pin"===l||"pie"===l||"bar"===l?(o=[5,6,7],s="bottom"):"rectangle"===l&&(o=[0,1,2,3,5],s="top",a="left")}else(fl.test(r)||Sl.test(r))&&(s="bottom",o=[5,6,7]);var h,u=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var c=e.getSize();h=c.width/c.height}var f=this._createResizeHandles(o,(function(r,l){if(o&&o.indexOf(l)>=0){var c=n.containerPointToCoordinate(r.sub(i)),d=e.getCoordinates();c.x=d.x,e.setCoordinates(c),t._updateCoordFromShadow(!0),r=f[f.length-1-l].getContainerPoint()}var p=md(n,e._getEditCenter()).add(i),g=e._getInternalSymbol(),m=r.sub(p);"bottom"===s&&r.y>p.y&&(m.y=0);var A="middle"===s?2:1,y="left"===a?1:2,v=Math.abs(m.x)*y,x=Math.abs(m.y)*A;h&&(x=(v=Math.max(v,x*h))/h);var _=u[l];e instanceof mu?((h||0===_||2===_)&&(e.setWidth(v),e!==t._geometry&&t._geometry.setWidth(v)),(h||1===_||2===_)&&(e.setHeight(x),e!==t._geometry&&t._geometry.setHeight(x))):((h||0===_||2===_)&&(g.markerWidth=Math.min(v,t._geometry.options.maxMarkerWidth||1/0)),(h||1===_||2===_)&&(g.markerHeight=Math.min(x,t._geometry.options.maxMarkerHeight||1/0)),e.setSymbol(g),e!==t._geometry&&t._geometry.setSymbol(g))}),(function(){t._update(d())}))}else console&&console.warn("A marker can't be resized with symbol:",e.getSymbol());function d(){var t=[["setCoordinates",e.getCoordinates().toArray()]];return e instanceof mu?(t.push(["setWidth",e.getWidth()]),t.push(["setHeight",e.getHeight()])):t.push(["setSymbol",e.getSymbol()]),t}},n.createCircleEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();this._history||this._recordHistory([["setCoordinates",e.getCoordinates().toArray()],["setRadius",e.getRadius()]]),this._createResizeHandles(null,(function(r){var i=e.getCenter(),o=Ad(e,i,r),s=new Wh([[i.x,i.y],[o.x,i.y]]),a=new Wh([[i.x,i.y],[i.x,o.y]]),l=Math.max(n.computeGeometryLength(s),n.computeGeometryLength(a));e.setRadius(l),e!==t._geometry&&t._geometry.setRadius(l)}),(function(){t._update("setRadius",e.getRadius())}))},n.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],n=this._shadow||this._geometry;this._history||this._recordHistory(a());var r,i=this.getMap(),o=this._geometry instanceof au;this.options.fixAspectRatio&&(r=n.getWidth()/n.getHeight());var s=this._createResizeHandles(null,(function(a,l){var h,u,c,f=o?1:2,d=s[l].getContainerPoint(),p=e[l];if(o){var g=s[7-l],m=g.getContainerPoint(),A=(h=d.sub(m)).abs();u=i.pixelToDistance(A.x,0),c=i.pixelToDistance(0,A.y);var y=n.getSize(),v=n.getCoordinates(),x=n.getWidth(),_=n.getHeight(),b=g.coord,w=Ad(n,v,a),T=new Wh([[b.x,b.y],[w.x,b.y]]),M=new Wh([[b.x,b.y],[b.x,w.y]]);if(u=i.computeGeometryLength(T),c=i.computeGeometryLength(M),0===p)if(r&&(A.y=A.x/r,y.height=Math.abs(A.y),c=u/r),d.y=m.y-y.height/2,w.y=v.y,4===l)w.x=Math.min(w.x,v.x);else{var C=i.locate(v,x,0);w.x=i.locate(new rs(C.x,w.y),-u,0).x}else if(1===p)r&&(A.x=A.y*r,y.width=Math.abs(A.x),u=c*r),d.x=m.x-y.width/2,w.x=v.x,w.y=Math.max(w.y,b.y);else{if(r&&(u>c*r?(c=u/r,d.y=m.y+A.x*te(h.y)/r):(u=c*r,d.x=m.x+A.y*te(h.x)*r)),0===l||5===l){var S=0===l?i.locate(v,x,0):i.locate(v,x,-_);w.x=i.locate(new rs(S.x,w.y),-u,0).x}else w.x=Math.min(w.x,b.x);w.y=Math.max(w.y,b.y)}w.z=v.z,n.setCoordinates(w),t._updateCoordFromShadow(!0)}else{var I=n.getCenter(),P=Ad(n,I,a),E=new Wh([[I.x,I.y],[P.x,I.y]]),O=new Wh([[I.x,I.y],[I.x,P.y]]);u=i.computeGeometryLength(E),c=i.computeGeometryLength(O),r&&(c=(u=Math.max(u,c*r))/r)}(r||0===p||2===p)&&(n.setWidth(u*f),n!==t._geometry&&t._geometry.setWidth(u*f)),(r||1===p||2===p)&&(n.setHeight(c*f),n!==t._geometry&&t._geometry.setHeight(c*f))}),(function(){t._update(a())}));function a(){return[["setCoordinates",n.getCoordinates().toArray()],["setWidth",n.getWidth()],["setHeight",n.getHeight()]]}},n.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow||this._geometry,n=this;this._history||this._recordHistory("setCoordinates",rs.toNumberArrays(e.getCoordinates()));var r=e instanceof Hh?3:2,i="maptalks--editor-vertex-index",{vertexZIndex:o,newVertexZIndex:s}=this.options,a={0:[]},l={0:[]};function h(t,n){if(e instanceof Hh){var r=e.getCoordinates();r[n]=t,e.setCoordinates(r)}else e.setCoordinates(t)}function u(t=0){if(e instanceof Hh){var n=e.getCoordinates()[t]||[];return n.slice(0,n.length-1)}return e.getCoordinates()}function c(){for(var t in a){for(var e=a[t].length-1;e>=0;e--)a[t][e][i]=e;for(var r=l[t].length-1;r>=0;r--)l[t][r][i]=r}n._updateCoordFromShadow()}function f(o){n._updating=!0;var s=o.target,f=s[i],d=V(s._ringIndex)?s._ringIndex:0,p=u(d);if(p.length<=r)console.warn(" Geometry."+e.type+" Require at least "+r+" vertices,Geometry: ",e);else{if(p.splice(f,1),h(p,d),0===f)l[d][0].delete(),l[d].splice(0,1);else if(f===a[d].length-1){var g=l[d].length;l[d][g-1].delete(),l[d].splice(g-1,1)}else l[d][f-1].delete(),l[d].splice(f-1,1),l[d][f-1].delete(),l[d].splice(f-1,1),l[d].splice(f-1,0,y.call(n,f-1,d));if(a[d].splice(f,1)[0].delete(),d>0){var m=e.getCoordinates(),A=m[d];A&&Array.isArray(A)&&A.length>1&&e!==this._geometry&&e.setCoordinates(m)}c(),n._updating=!1,n._geometry.fire("handleremove",Object.assign({},o,{coordinate:t.containerPointToCoordinate(o.containerPoint),vertex:o.target}))}}function d(t,r,i=0){var o=n._geometry.snapTo;o&&X(o)&&(t=n._geometry.snapTo(t)||t);var s,a=u(i),h=t.sub(g()),c=Ad(n._geometry,a[r],h),f=a[r];f.x=c.x,f.y=c.y,e.setCoordinates(e.getCoordinates()),n._updateCoordFromShadow(!0),s=0===r?l[i].length-1:r-1,l[i][r]&&l[i][r].refresh(),l[i][s]&&l[i][s].refresh()}var p=new Vt(0,0);function g(){var t=e._getCompiledSymbol();return p.x=t.lineDx||0,p.y=t.lineDy||0,p}function m(e,r=0,s){var a=(s||u(r))[e],l=md(t,a)._add(g()),h=n.createHandle(l,{symbol:n.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){d(h.getContainerPoint(),h[i],r)},onRefresh:function(e,n){if(a=(n||u(r))[h[i]]){var o=md(t,a);h.setContainerPoint(o._add(g()))}},onUp:function(){n._updateCoordFromShadow()},onDown:function(t,e){!e||!e.domEvent||e.domEvent.button}});return h[i]=e,h._ringIndex=r,h.on(n.options.removeVertexOn,f),h.setZIndex(o),h}var A=!1;function y(e,r=0,o){var f,p=o||u(r);f=e+1>=p.length?p[0]:p[e+1];var v=p[e].add(f).multi(.5),x=n.createHandle(v,{symbol:n.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(t,e){if(!e||!e.domEvent||2!==e.domEvent.button){var o=u(r),s=x[i],a=o[s],c=o[s+1]||o[0],f=a.add(c).multi(.5);o.splice(s+1,0,f),h(o,r),x.opacity=1,l[r].splice(s,0,y.call(n,s,r),y.call(n,s+1,r)),A=!0}},onMove:function(){d(x.getContainerPoint(),x[i]+1,r)},onUp:function(t){if(t&&t.domEvent&&2===t.domEvent.button)A=!1;else{var e=x[i];Qt(x,l[r]),x.delete(),a[r].splice(e,0,m.call(n,e,r)),c(),n._updateCoordFromShadow(),A=!1}},onRefresh:function(e,n){p=n||u(e);var r,o=x[i];if(r=o===p.length-1?0:o+1,p[o]&&p[r]){var s=p[o].add(p[r]).multi(.5),a=md(t,s);x.setContainerPoint(a._add(g()))}}});return x[i]=e,x.setZIndex(s),x}if(e instanceof Hh)for(var v=e.getHoles().length+1,x=0;x<v;x++){a[x]=[],l[x]=[];for(var _=u(x),b=0,w=_.length;b<w;b++)a[x].push(m.call(this,b,x,_)),b<w-1&&l[x].push(y.call(this,b,x,_));l[x].push(y.call(this,_.length-1,x,_))}else{for(var T=u(0),M=0,C=T.length;M<C;M++)a[0].push(m.call(this,M,0,T)),M<C-1&&l[0].push(y.call(this,M,0,T));l[0].length&&2===e.getCoordinates().length&&(l[0][0].options.symbol.markerDx=12)}var S=t.getRenderer();S&&S.sortTopElements(),this._addRefreshHook((function(){if(!A){for(var t in l)for(var n=u(t),r=l[t].length-1;r>=0;r--)l[t][r].refresh(t,n);for(var i in l[0].length&&e instanceof Wh&&(2===e.getCoordinates().length?l[0][0].options.symbol.markerDx=12:e.getCoordinates().length>2&&(l[0][0].options.symbol.markerDx=0)),a)for(var o=u(i),s=a[i].length-1;s>=0;s--)a[i][s].refresh(i,o)}}))},n._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},n._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},n._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},n._update=function(t,...e){this._exeHistory([t,e]),this._recordHistory(t,...e)},n._updateCoordFromShadow=function(t){var e=(this._shadow||this._geometry).getCoordinates(),n=this._geometry,r=this._updating;this._updating=!0,n.setCoordinates(e),t||this._recordHistory("setCoordinates",rs.toNumberArrays(n.getCoordinates())),this._updating=r},n._recordHistory=function(t,...e){if(this._history||(this._history=[],this._historyPointer=0),this._history.length){var n=this._history[this._history.length-1];if(n[0]===t&&JSON.stringify(n[1])===JSON.stringify(e))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([t,e]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},n.cancel=function(){if(!this._history||0===this._historyPointer)return this;this._historyPointer=0;var t=this._history[0];return this._exeAndReset(t),this},n.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},n.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return this;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},n._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,n=this._historyPointer;this.stop(),this._history=e,this._historyPointer=n,this.start()}},n._onDragStart=function(){this._updating=!0},n._onDragEnd=function(){this._updating=!1},n._exeHistory=function(t){if(Array.isArray(t)){var e=this._updating;this._updating=!0;var n=this._shadow||this._geometry,r=this._geometry;Array.isArray(t[0])?t[0].forEach((function(t){var e=t[0],i=t.slice(1);n[e].call(n,...i),n!==r&&r[e].call(r,...i)})):(n[t[0]].call(n,...t[1]),n!==r&&r[t[0]].call(r,...t[1])),this._updating=e}},e}(zo(Ho));bd.mergeOptions(_d);var wd={startEditText:function(){return this.getMap()?(this._recordVisible(),this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),mn(this._textEditor,"mousedown dblclick",on),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this._recoveryVisible(),this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var n=this._getEditorOffset();this._editUIMarker=new Pc(this.getCoordinates(),{animation:null,content:e,dx:n.dx,dy:n.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,n=0,r=t.textHorizontalAlignment;return"middle"===r||U(r)?(e=(t.textDx||0)-2,n=(t.textDy||0)-2):(e=(t.markerDx||0)-2,n=(t.markerDy||0)-2),{dx:e,dy:n}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),n=this._getInternalSymbol()||{},r=e.width,i=n.textFill||"#000000",o=n.textSize||12,s=e.height,a=n.markerLineColor||"#000",l=n.markerFill||"#3398CC",h=n.textLineSpacing||0,u=Qe("div");return u.contentEditable=!0,u.style.cssText="background:"+l+"; border:1px solid "+a+";\n            color:"+i+";font-size:"+o+"px;width:"+(r-2)+"px;height:"+(s-2)+"px;margin: auto;\n            line-height:"+(o+h)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",u.innerText=t,gn(u,"mousedown dblclick",on),u.onkeyup=function(t){var e=u.style.height||0;13===t.keyCode&&(u.style.height=parseInt(e)+o/2+"px")},u},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}};gu.include(wd),rh.include({animate:function(t,e,n){var r=this;this._animPlayer&&this._animPlayer.finish(),X(e)&&(n=e),e||(e={});var i,o=this.getMap(),s=this._getProjection(),a=this._prepareAnimationStyles(t),l=e.focus;if(delete this._animationStarted,o){var h=o._getRenderer();e.framer=function(t){h.callInNextFrame(t)}}if(s||!l){var u=kh.animate(a,e,(function(t){if(o&&o.isRemoved())u.finish();else{o&&!r._animationStarted&&l&&o.onMoveStart();var e=t.styles;for(var a in e)if("symbol"!==a&&"translate"!==a&&e.hasOwnProperty(a)){var h="set"+a[0].toUpperCase()+a.slice(1);r[h](e[a])}var c=e.translate;if(c){var f=c;i&&(f=c.sub(i)),i=c,r.translate(f)}var d=e.symbol;if(d){var p=r.getSymbol()||{};r.setSymbol(vr(p,d))}if(o&&l){var g=s.project(r.getCenter());o._setPrjCenter(g);var m=o._parseEventFromCoord(s.unproject(g));"running"!==u.playState?o.onMoveEnd(m):o.onMoving(m)}r._fireAnimateEvent(u.playState),n&&n(t)}}),this);return this._animPlayer=u,this._animPlayer.play()}console.error(Fh)},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),n={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if("translate"!==r&&"symbol"!==r){var o=this["get"+r[0].toUpperCase()+r.substring(1)]();n[r]=[o,i]}else if("symbol"===r){var s=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");s=[];for(var a=t.symbol,l=0;l<a.length;l++)if(a[l]){var h={};for(var u in a[l])a[l].hasOwnProperty(u)&&(h[u]=[e[l][u],a[l][u]]);s.push(h)}else s.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var c in s={},i)i.hasOwnProperty(c)&&(s[c]=[e[c],i[c]])}n.symbol=s}else"translate"===r&&(n.translate=new rs(i))}return n},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var Td=xe+"_drag_stage",Md=Pt.touch?"touchstart mousedown":"mousedown";function Cd(t,e,n){var r=t._getEditCenter(),i=t.getMap();if(!r||0===r.z)return n||i.containerPointToCoord(e);var o=r.z,s=i.getGLRes(),a=i.coordToPointAtRes(r,s),l=i._pointAtResToContainerPoint(a,s,0),h=i._pointAtResToContainerPoint(a,s,o).sub(l),u=e.sub(h),c=i.containerPointToCoord(u);return c.z=0,!t.getGeometries&&t.isPoint&&(c.z=o),c}var Sd=function(t){function e(e){return t.call(this,e)||this}kt(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(Md,this._startDrag,this)},n.removeHooks=function(){this._endDrag(),this.target.off(Md,this._startDrag,this),delete this.container},n._prepareDragHandler=function(){this._dragHandler=new ns(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},n._prepareShadow=function(){var t=this,e=this.target;if("canvas"===e.getLayer().options.renderer&&e.options.dragShadow){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var n=this._shadow=e.copy();if(n.getGeometries){var r=n.getGeometries(),i=e.getGeometries();r.forEach((function(e,n){t._updateShadowSymbol(e,i[n])}))}else this._updateShadowSymbol(n,e);n.setId(null),this._prepareShadowConnectors()}},n._updateShadowSymbol=function(t,e){if(t.setSymbol(e._getInternalSymbol()),e.options.dragShadow){var n=yr(t._getInternalSymbol(),.5);t.setSymbol(n)}},n._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,n=this._dragStageLayer._getRenderer().resources,r=[];if(xu._hasConnectors(t))for(var i=xu._getConnectors(t),o=0,s=i.length;o<s;o++){var a=i[o],l=a.config(),h=a._getInternalSymbol();l.symbol=yr(h,.5);var u=void 0;u=a.getConnectSource()===t?new a.constructor(e,a.getConnectTarget(),l):new a.constructor(a.getConnectSource(),e,l),r.push(u),a.getLayer()&&a.getLayer()._getRenderer()&&n.merge(a.getLayer()._getRenderer().resources)}this._shadowConnectors=r,r.push(e),this._dragStageLayer.bringToFront().addGeometry(r)},n._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},n._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer(Td),this._dragStageLayer||(this._dragStageLayer=new Su(Td,{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var n=new xa;n.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=n},n._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var n=t.domEvent;if(!(n.touches&&n.touches.length>1||2===n.button)){this.container=e.getPanels().mapWrapper||e.getContainer(),this.target.on("click",this._endDrag,this);var r=this._correctCoord(t.coordinate);this._lastCoord=Cd(this.target,t.containerPoint,r),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),gn(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1}}},n._dragging=function(t){var e=this.target,n=e.getMap();if(!n._isEventOutMap(t.domEvent)){var r=n._parseEvent(t.domEvent),i=r.domEvent;if(!(i.touches&&i.touches.length>1||n._isContainerPointOutOfMap(r.containerPoint))){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",r)),this.target._fireEvent("dragstart",this._startParam||r),void delete this._startParam;var o=this._shadow||e,s=o.options.dragOnAxis,a=o.options.dragOnScreenAxis,l=r.containerPoint,h=r.coordinate;this._lastPoint=this._lastPoint||l,this._lastCoord=this._lastCoord||h,a?("x"===s?l.y=this._lastPoint.y:"y"===s&&(l.x=this._lastPoint.x),h=n.containerPointToCoord(l)):h=this._correctCoord(h),h=Cd(e,r.containerPoint,h);var u=l.sub(this._lastPoint),c=h.sub(this._lastCoord);a||("x"===s?u.y=c.y=0:"y"===s&&(u.x=c.x=0)),this._lastPoint=l,this._lastCoord=h;var f=!o.getGeometries&&o.isPoint;f?o.setCoordinates(h):o.translate(c),o===e||e.options.dragShadow||(f?e.setCoordinates(h):e.translate(c)),r.coordOffset=c,r.pointOffset=u,o._fireEvent("dragging",r),o!==e&&e._fireEvent("dragging",r)}}},n._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&mn(this.container,"mouseleave",this._endDrag),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var n=e.getMap();if(this.enabled()&&n){var r=n._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(r),this._moved&&e._fireEvent("dragend",r)}}},n.isDragging=function(){return!!this._isDragging},n._updateTargetAndRemoveShadow=function(t){if(this._shadow){var e=this.target,n=e.getMap();e.options.dragShadow||e.show();var r=this._shadow;if(r){if(e.options.dragShadow){var i=r.getFirstCoordinate(),o=e.getFirstCoordinate(),s=i.sub(o);e.translate(s)}r._fireEvent("dragend",t),r.remove(),delete this._shadow}this._shadowConnectors&&(n.getLayer(Td).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=new xa,this._dragStageLayer.remove())}},n._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var n=this.target;if(!n.getMinAltitude())return t;var r=(n.getMinAltitude()+n.getMaxAltitude())/2;return e.locateByPoint(t,0,-r)},e}(Bo);rh.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),rh.addInitHook("addHandler","draggable",Sd),rh.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),rh.include({startEdit:function(t){var e=this.getMap();return e&&this.options.editable?(this._editor&&this.endEdit(),this._recordVisible(),this._editor=new bd(this,t),this._editor.start(),this._getParent()||this.fire("editstart"),e.getRenderer().setToRedraw(),this):this},endEdit:function(){if(this._editor){this._editor.stop(),delete this._editor,this._recoveryVisible(),this._getParent()||this.fire("editend");var t=this.getMap();t&&t.getRenderer().setToRedraw()}return this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._recoveryVisible(),this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),rh.include({_onEvent:function(t,e){var n=this.getMap();if(n){var r=e||this._getEventTypeToFire(t);"contextmenu"===r&&this.listens("contextmenu")&&(on(t),rn(t));var i=n._getEventParams(t);V(this._pickGeometryIndex)&&(i.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(r,i)}},_getEventTypeToFire:function(t){return t.type}}),rh.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof Dc?(this._infoWindow=t,this._infoWinOptions=j({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=j({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var t=this._infoWinOptions;return t?(this._infoWindow=new Dc(t),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),rh.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],n=0,r=t.length;n<r;n++){var i=rh.fromJSON(t[n]);Array.isArray(t)?e=e.concat(i):e.push(i)}return e}return t&&!t.feature?iu.toGeometry(t):(t.subType?(o=rh.getJSONClass(t.subType).fromJSON(t),U(t.feature.id)||o.setId(t.feature.id)):(o=iu.toGeometry(t.feature),t.options&&o.config(t.options)),t.symbol&&o.setSymbol(t.symbol),t.infoWindow&&o.setInfoWindow(t.infoWindow),o);var o};var Id=new Vt(0,0),Pd=new Vt(0,0),Ed=new Vt(0,0),Od=new Vt(0,0),Rd=[],kd=function(t){function e(){return t.call(this,gi)||this}kt(e,t);var n=e.prototype;return n.checkUrl=function(t){return t&&q(t)?Ae(t):t},n.fetchImage=function(t,e,n,r){var i={url:t=this.checkUrl(t),fetchOptions:r};this.send(i,Rd,n,e)},e}(da),Ld=function(t){function e(e){var n;(n=t.call(this,e)||this).tilesInView={},n.tilesLoading={},n._parentTiles=[],n._childTiles=[],n._tileQueue=[],n._tileQueueIds=new Set;var r=e.getTileSize().width;return n.tileCache=new Wi(e.options.maxCacheSize*r/512*r/512,(function(t){n.deleteTile(t)})),Pt.decodeImageInWorker&&n.layer.options.decodeImageInWorker&&("gl"===e.options.renderer||!Pt.safari&&!Pt.iosWeixin)&&(n._tileImageWorkerConn=new kd),n._compareTiles=Nd.bind(n),n}kt(e,t);var n=e.prototype;return n.getCurrentTileZoom=function(){return this._tileZoom},n.draw=function(t,e){var n=this.getMap();if(this.isDrawable()){var r=this.prepareCanvas();if(!r||r.intersects(this.canvasExtent2D)){var i;this._renderTimestamp!==t&&(this._consumeTileQueue(),this._computeAvgTileAltitude(),this._renderTimestamp=t);var o=!1,s=this._frameTiles;if(s&&t===s.timestamp){if(s.empty)return;i=s}else{if(!(i=this._getTilesInCurrentFrame()))return this._frameTiles={empty:!0,timestamp:t},void this.completeRender();o=!0,this._frameTiles=i,this._frameTiles.timestamp=t,i.loadingCount&&this.loadTileQueue(i.tileQueue)}var{tiles:a,childTiles:l,parentTiles:h,placeholders:u,loading:c,loadingCount:f,missedTiles:d,incompleteTiles:p}=i;this._drawTiles(a,h,l,u,e,d,p),f||c||(n.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),o&&this.retireTiles()}else this.completeRender()}},n.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},n.getCurrentTimestamp=function(){return this._renderTimestamp||0},n._getTilesInCurrentFrame=function(){var t=this.getMap(),e=this.layer,n=e._isPyramidMode()&&e.options.terrainTileMode,r=e.getTiles();if(this._frameTileGrids=r,!(r=r.tileGrids)||!r.length)return null;var i=r.reduce((function(t,e){return t+(e&&e.tiles&&e.tiles.length||0)}),0);i>=this.tileCache.max/2&&this.tileCache.setMaxSize(2*i+1);var o=0,s=!1,a={},l=[],h=[],u={},c=[],f={},d=[],p={},g={},m=this.markTiles(),A=this._getLoadLimit(),y=r.length,v=void 0===this._tileZoom&&e.options.currentTilesFirst&&!this._terrainHelper;this._tileZoom=r[0].zoom;var x=null,_=null;n&&(x=[],_=new Map);for(var b=0;b<y;b++){var w=r[b],T=w.tiles,M=w.parents||Rd,C=M.length,S=v?T:M.concat(T),I=void 0;S.length&&(I=this._generatePlaceHolder(S[0].res));for(var P=0,E=S.length;P<E;P++){var O=S[P],R=O.id,k=!v&&P<C,L=!1,D=l.length;if(this._isLoadingTile(R))L=s=!0,this.markCurrent(this.tilesLoading[R],!0);else{var N=this.getCachedTile(O,k);if(N)k||(N.image&&this.isTileFadingIn(N.image)&&(L=s=!0,this.setToRedraw()),this.isTileComplete(N)?l.push(N):(L=!0,n&&_.set(R,N)));else{L=s=!0;var F=A&&o+m[0]>A;if(!this._tileQueueIds.has(O.id)&&!F&&(!t.isInteracting()||t.isMoving()||t.isRotating()))o++,g[R]=O}}if(n&&!k&&(l.length===D?x.push(O):a[O.id]=1),!n&&!k&&L&&!a[R]){a[R]=1,I&&!p[R]&&(O.cache=!1,d.push({image:I,info:O}),p[R]=1);var z=this._findChildTiles(O);if(z.length&&z.forEach((function(t){f[t.info.id]||(c.push(t),f[t.info.id]=1)})),!z.length||4!==z.length){var B=this._findParentTile(O);if(B){var H=B.info.id;void 0===u[H]&&(u[H]=h.length,h.push(B))}}}}}var j=[];if(n)for(var U=0;U<x.length;U++){var V=x[U].info?x[U].info:x[U];if(V.parent&&!a[V.id]){var{tiles:G,missedTiles:W}=this._findChildTiles(V);G.length?(Jt(l,G),Jt(j,W)):_.has(V.id)?(l.push(_.get(V.id)),_.delete(V.id)):(a[V.id]=1,j.push(V))}}return this.tileCache.shrink(),{childTiles:c,missedTiles:j,parentTiles:h,tiles:l,incompleteTiles:_&&Array.from(_.values()),placeholders:d,loading:s,loadingCount:o,tileQueue:g}},n.removeTileCache=function(t){delete this.tilesInView[t],this.tileCache.remove(t)},n.isTileCachedOrLoading=function(t){return this.tileCache.get(t)||this.tilesInView[t]||this.tilesLoading[t]},n.isTileCached=function(t){return!(!this.tileCache.get(t)&&!this.tilesInView[t])},n.isTileFadingIn=function(t){return this._getTileFadingOpacity(t)<1},n._drawTiles=function(t,e,n,r,i,o,s){var a=this;e.length&&(e.sort(this._compareTiles),this._parentTiles=e),n.length&&(this._childTiles=n,this._childTiles.sort(this._compareTiles));var l=!0,h=this.canvas._parentTileTimestamp;this.layer.constructor!==wf&&this.layer.constructor!==Rf||(this._renderTimestamp===h?l=!1:this.canvas._parentTileTimestamp=this._renderTimestamp);var u="gl"===this.layer.options.renderer&&(!this.isGL||this.isGL()),c={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:i};if(this.onDrawTileStart(c,i),l&&1===this.layer.options.opacity){this.layer._silentConfig=!0;var f=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,u?(this._drawChildTiles(n,i),this._drawParentTiles(this._parentTiles,i)):(this._drawParentTiles(this._parentTiles,i),this._drawChildTiles(n,i)),this.layer.options.fadeAnimation=f,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,t.sort(this._compareTiles);for(var d=0,p=t.length;d<p;d++)this._drawTileAndCache(t[d],i);if(delete this.drawingCurrentTiles,l&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var g=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,u?(this._drawChildTiles(n,i),this._drawParentTiles(this._parentTiles,i)):(this._drawParentTiles(this._parentTiles,i),this._drawChildTiles(n,i)),this.layer.options.fadeAnimation=g,this.layer._silentConfig=!1}r.forEach((function(t){return a._drawTile(t.info,t.image,i)})),this.onDrawTileEnd(c,i)},n._drawChildTiles=function(t,e){var n=this;this.drawingChildTiles=!0,t.forEach((function(t){return n._drawTile(t.info,t.image,e)})),delete this.drawingChildTiles},n._drawParentTiles=function(t,e){var n=this;this.drawingParentTiles=!0,this._parentTiles.forEach((function(t){return n._drawTile(t.info,t.image,e)})),delete this.drawingParentTiles},n.onDrawTileStart=function(t,e){},n.onDrawTileEnd=function(t,e){},n._drawTile=function(t,e,n){e&&this.drawTile(t,e,n)},n._drawTileAndCache=function(t,e){this.isValidCachedTile(t)&&(this.tilesInView[t.info.id]=t),this._drawTile(t.info,t.image,e)},n.drawOnInteracting=function(t,e,n){this.draw(e,n)},n.needToRedraw=function(){var e=this.getMap();return!!this._tileQueue.length||(e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this)))},n.hitDetect=function(){return!1},n._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit||0},n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},n.clear=function(){this.retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._tileQueue=[],this._tileQueueIds.clear(),this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},n._isLoadingTile=function(t){return!!this.tilesLoading[t]},n.clipCanvas=function(e){return t.prototype.clipCanvas.call(this,e)},n._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var n=e.getContainerExtent(),r=e.getDevicePixelRatio();return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(n.ymin)*r,Math.ceil(n.getWidth())*r,Math.ceil(n.getHeight())*r),t.stroke(),t.clip(),!0},n.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e],r=this.loadTile(n);void 0===r.loadTime&&(this.tilesLoading[n.id]={image:r,current:!0,info:n})}},n.loadTile=function(t){var e=this,n={};if(this.loadTileBitmap){this.loadTileBitmap(t.url,t,(function(n){e.onTileLoad(n,t)}),(function(n,r){e.onTileError(r,t,n)}))}else if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)this._fetchImage(n,t);else{var r=this.layer.getTileSize(t.layer);(n=new Image).width=r.width,n.height=r.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url)}return n},n._fetchImage=function(t,e){var n=this;if(t instanceof Image)t.src=e.url;else{var{x:r,y:i}=e,o=Math.abs(r+i)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(e.url,o,(function(r,i){r?n.onTileError(t,e,r):me(i,(function(t){n.onTileLoad(t,e)}))}),this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},n.loadTileImage=function(t,e){var n=this.layer.options.crossOrigin;return U(n)||(t.crossOrigin=n),Wt(t,[e])},n.abortTileLoading=function(t,e){e&&void 0!==e.id&&this.removeTileLoading(e),t&&t instanceof Image&&(t.onload=Dd,t.onerror=Dd,t.src=ce)},n.onTileLoad=function(t,e){this.removeTileLoading(e),this._tileQueue.push({tileInfo:e,tileData:t}),this._tileQueueIds.add(e.id),this.setToRedraw()},n.removeTileLoading=function(t){delete this.tilesLoading[t.id],this.setToRedraw()},n._consumeTileQueue=function(){for(var t=0,e=this.layer.options.tileLimitPerFrame,n=this._tileQueue;n.length&&(e<=0||t<e);){var{tileData:r,tileInfo:i}=n.shift();this._tileQueueIds.has(i.id)&&(this._tileQueueIds.delete(i.id),this.checkTileInQueue(r,i)&&(this.consumeTile(r,i),t++))}},n._computeAvgTileAltitude=function(){var t=0,e=0,n=0;for(var r in this.tilesInView){var i=this.tilesInView[r]&&this.tilesInView[r].info;i&&(t+=i.minAltitude||0,e+=i.maxAltitude||0,n++)}this.avgMinAltitude=t/n,this.avgMaxAltitude=e/n},n.checkTileInQueue=function(t,e){return!0},n.consumeTile=function(t,e){if(this.layer&&this.tilesInView){var n={tile:e,tileImage:t};t=n.tileImage,this.resetTileLoadTime(t),this.removeTileLoading(e),this._addTileToCache(e,t),this.layer.fire("tileload",n),this.setToRedraw()}},n.resetTileLoadTime=function(t){0!==t.loadTime&&(t.loadTime=H())},n.onTileError=function(t,e,n){if(this.layer){var r=this.layer.options.reloadErrorTileFunction;if(r)r.call(this,this.layer,this,e,t);else{var i=this.layer.options.errorUrl;if(i){if(t instanceof Image&&t.src!==i)return t.src=i,void this.removeTileLoading(e);(t=new Image).src=i}this.abortTileLoading(t,e),t.loadTime=0,this.removeTileLoading(e),this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}}},n.drawTile=function(t,e,n){if(e&&this.getMap()){var{extent2d:r,offset:i}=t,o=Id.set(r.xmin-i[0],r.ymax-i[1]),s=t.z,a=t.id,l=this.getMap(),h=l.getZoom(),u=this.context,c=l._pointAtResToContainerPoint(o,t.res,0,Pd),f=l.getBearing(),d=f||h!==s,p=this.getTileOpacity(e,t),g=u.globalAlpha;p<1&&(u.globalAlpha=p),d||c._round();var m=c.x,A=c.y,y=t.extent2d.xmax-t.extent2d.xmin,v=t.extent2d.ymax-t.extent2d.ymin,x=this.layer,_=x?x.options.bufferPixel:0;if(d){u.save(),u.translate(m,A),f&&u.rotate(-f*Math.PI/180),y+=_,v+=_;var b=l._getResolution();if(b!==t.res){var w=t.res/b;u.scale(w,w)}m=A=0}if(Oo.image(u,e,m,A,y,v),this.layer.options.debug){var T=this.layer.options.debugOutline;u.save(),u.strokeStyle=T,u.fillStyle=T,u.font="20px monospace";var M=new Vt(m,A);Oo.rectangle(u,M,{width:y,height:v},1,0),Oo.fillText(u,this.getDebugInfo(a),M._add(32,v-14),T),Oo.drawCross(u,m+y/2,A+v/2,2,T),u.restore()}d&&u.restore(),u.globalAlpha!==g&&(u.globalAlpha=g),this.setCanvasUpdated()}},n.getDebugInfo=function(t){var e=t.split("_"),n=e.length;return e[n-3]+"/"+e[n-2]+"/"+e[n-1]},n.findChildTiles=function(t){return this._findChildTiles(t)},n._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer),n=e&&e.options.terrainTileMode&&e._isPyramidMode();if(!e||!e.options.background&&!n||t.z>this.layer.getMaxZoom())return Rd;var r=this.getMap(),i=[];if(e._isPyramidMode()){if(!n){for(var o=this._getLayerOfTile(t.layer),s=2*t.x,a=2*t.y,l=t.z+1,h=[],u=0;u<2;u++)for(var c=0;c<2;c++)h.push(s+u,a+c,l);for(;h.length;){var f=h.pop(),d=h.pop(),p=h.pop(),g=o._getTileId(p,d,f,t.layer),m=f+1<=t.z+2,A=this.tileCache.getAndRemove(g);if(A){if(this.isValidCachedTile(A))i.push(A),this.tileCache.add(g,A);else if(m)for(var y=0;y<2;y++)for(var v=0;v<2;v++)h.push(2*p+y,2*d+v,f+1)}else if(m)for(var x=0;x<2;x++)for(var _=0;_<2;_++)h.push(2*p+x,2*d+_,f+1)}return i}var b;n&&(b=[]);for(var w=2*t.x,T=2*t.y,M=t.z+1,C=[],S=0;S<2;S++)for(var I=0;I<2;I++){var P=w+S,E=T+I,O=M,R=e._getTileId(P,E,O,t.layer),k=this.tileCache.getAndRemove(R);k&&this.isValidCachedTile(k)?(i.push(k),this.tileCache.add(R,k),C.push(null)):C.push(R)}if(i.length<4)for(var L=0,D=0;D<2;D++)for(var N=0;N<2;N++){var F=C[L++];if(F){for(var z=w+D,B=T+N,H=M,j=i.length,U=[],V=0;V<2;V++)for(var G=0;G<2;G++){var W=2*z+V,q=2*B+G,X=H+1,Z=e._getTileId(W,q,X,t.layer),Y=this.tileCache.getAndRemove(Z);Y&&this.isValidCachedTile(Y)?(i.push(Y),this.tileCache.add(Z,Y),U.push(null)):U.push(Z)}if(n&&i.length-j<4){var J=e.tileInfoCache.get(F)||e._createChildNode(t,D,N,[0,0],F);if(i.length-j==0)b.push(J);else for(var Q=0,K=0;K<2;K++)for(var $=0;$<2;$++){var tt=U[Q++];if(tt){var et=this.layer.tileInfoCache.get(tt)||e._createChildNode(J,K,$,[0,0],tt);b.push(et)}}}}}return n?{tiles:i,missedTiles:b}:i}for(var nt=t.res,rt=t.extent2d.getMin(),it=t.extent2d.getMax(),ot=e._project(r._pointToPrjAtRes(rt,nt,Ed),Ed),st=e._project(r._pointToPrjAtRes(it,nt,Od),Od),at=1;at<1;at++)this._findChildTilesAt(i,ot,st,e,t.z+at);return i},n._findChildTilesAt=function(t,e,n,r,i){var o=r.getId(),s=r.getSpatialReference().getResolution(i);if(s)for(var a,l,h=r._getTileConfig().getTileIndex(e,s),u=r._getTileConfig().getTileIndex(n,s),c=Math.min(h.idx,u.idx),f=Math.max(h.idx,u.idx),d=Math.min(h.idy,u.idy),p=Math.max(h.idy,u.idy),g=c;g<f;g++)for(var m=d;m<p;m++)a=r._getTileId(g,m,i,o),(l=this.tileCache.getAndRemove(a))&&this.isValidCachedTile(l)&&(t.push(l),this.tileCache.add(a,l))},n.findParentTile=function(t,e){return this._findParentTile(t,e)},n._findParentTile=function(t,e){var n=this.getMap(),r=this._getLayerOfTile(t.layer);if(!r||!r.options.background&&!r.options.terrainTileMode)return null;var i=r.getMinZoom(),o=e||t.z-i;if(r._isPyramidMode()){for(var s=t.z-o,a=t.z-1;a>=s;a--){var l=t.z-a,h=Math.pow(2,l),u=Math.floor(t.x/h),c=Math.floor(t.y/h),f=void 0;f=a===t.z-1?t.parent:r._getTileId(u,c,a,t.layer);var d=this.tileCache.getAndRemove(f);if(d&&this.isValidCachedTile(d))return this.tileCache.add(f,d),d}return null}for(var p=r.getSpatialReference(),g=p.getZoomDirection(),m=t.res,A=t.extent2d.getCenter(),y=r._project(n._pointToPrjAtRes(A,m)),v=1;v<=o;v++){var x=t.z-g*v,_=p.getResolution(x);if(_){var b=r._getTileConfig().getTileIndex(y,_),w=r._getTileId(b.x,b.y,x,t.layer),T=this.tileCache.getAndRemove(w);if(T)return this.tileCache.add(w,T),T}}return null},n.isValidCachedTile=function(t){return!!t.image},n.isTileComplete=function(t){return!0},n._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},n.getCachedTile=function(t,e){var n=t.id,r=this.tilesInView,i=this.tileCache.getAndRemove(n);if(i){e||(r[n]=i);var o=this.tilesLoading;if(o&&o[n]){this.markCurrent(o[n],!1);var{image:s,info:a}=o[n];this.abortTileLoading(s,a),delete o[n]}}else i=r[n];return i&&(i.current=!0,this.isValidCachedTile(i)&&this.tileCache.add(n,i)),i},n._addTileToCache=function(t,e){if(this.isValidCachedTile({info:t,image:e})){var n={image:e,info:t};this.tileCache.add(t.id,n)}},n.getTileOpacity=function(t,e){var n=this._getTileFadingOpacity(t);if(this.layer.getChildLayer){var r=this.layer.getLayer(e.layer);r&&(n*=r.options.opacity)}return n},n._getTileFadingOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(H()-t.loadTime)/this.layer.options.fadeDuration):1},n.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,delete this._tileZoom,t.prototype.onRemove.call(this)},n.markCurrent=function(t,e){t.current=e},n.markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var n in this.tilesLoading)this.markCurrent(this.tilesLoading[n],!1),t++;if(this.tilesInView)for(var r in this.tilesInView)this.markCurrent(this.tilesInView[r],!1),e++;return[t,e]},n.retireTiles=function(t){for(var e in this.tilesLoading){var n=this.tilesLoading[e];!t&&n.current||(n.image&&this.abortTileLoading(n.image,n.info),this.deleteTile(n),this.removeTileLoading(n.info))}for(var r in this.tilesInView){var i=this.tilesInView[r];i.current||(delete this.tilesInView[r],this.tileCache.has(r)||this.deleteTile(i))}},n.deleteTile=function(t){if(t&&t.image){var e=t.info.id;this._tileQueueIds.has(e)&&this._tileQueueIds.delete(e),t.image.close&&t.image.close(),t.image instanceof Image&&(t.image.onload=null,t.image.onerror=null)}},n._generatePlaceHolder=function(t){var e=this.getMap(),n=this.layer.options.placeholder;if(!n||e.getPitch())return null;var r=this.layer.getTileSize(),i=t/e._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||Oo.createCanvas(1,1,e.CanvasClass);return o.width=r.width*i,o.height=r.height*i,X(n)?n(o):function(t){var e=t.getContext("2d"),n=t.width,r=t.height,i=n/16,o=r/16;e.beginPath();for(var s=0;s<16;s++)e.moveTo(0,s*o),e.lineTo(n,s*o),e.moveTo(s*i,0),e.lineTo(s*i,r);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var a=[[0,0],[n,0],[0,r],[n,r],[0,0],[0,r],[n,0],[n,r],[0,r/2],[n,r/2],[n/2,0],[n/2,r]],l=1;l<a.length;l+=2)e.moveTo(a[l-1][0],a[l-1][1]),e.lineTo(a[l][0],a[l][1]);e.lineWidth=4,e.stroke()}(o),o},n.setTerrainHelper=function(t){this._terrainHelper=t},e}(va);function Dd(){return!1}function Nd(t,e){return Math.abs(this._tileZoom-t.info.z)-Math.abs(this._tileZoom-e.info.z)}wf.registerRenderer("canvas",Ld);var Fd=new Vt(0,0),zd={properties:{}},Bd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.isDrawable=function(){return!0},n.needToRedraw=function(){var e=this.getMap();return!(!this.isGL()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},n.onDrawTileStart=function(t,e){var n=this.gl;n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.enable(n.POLYGON_OFFSET_FILL),n.enable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE);var r=!!this.layer.options.depthMask;if(n.depthMask(r),e&&e.renderTarget){var i=e.renderTarget.fbo;if(i){var o=e.renderTarget.getFramebuffer(i);n.bindFramebuffer(n.FRAMEBUFFER,o)}}},n.onDrawTileEnd=function(t,e){var n=this.gl;e&&e.renderTarget&&(e.renderTarget.fbo&&n.bindFramebuffer(n.FRAMEBUFFER,null))},n.drawTile=function(e,n,r){if(!r||!r.sceneFilter||r.sceneFilter(zd)){var i=this.getMap();if(e&&i&&n){var o=e._glScale=e._glScale||e.res/i.getGLRes(),s=e.extent2d.xmax-e.extent2d.xmin,a=e.extent2d.ymax-e.extent2d.ymin;if(!1!==e.cache&&this._bindGLBuffer(n,s,a),this.isGL()){var{extent2d:l,offset:h}=e,u=Fd.set(l.xmin-h[0],e.extent2d.ymax-h[1]),c=u.x*o,f=u.y*o,d=this.getTileOpacity(n,e),p=null;this.layer.options.debug&&(p=this.getDebugInfo(e.id));var g=this.gl;g.stencilFunc(g.LEQUAL,Math.abs(this.getCurrentTileZoom()-e.z),255);var m=this.layer.getPolygonOffset(),A=this.drawingCurrentTiles?m:m+1;g.polygonOffset(A,A),this.drawGLImage(n,c,f,s,a,o,d,p),this._getTileFadingOpacity(n)<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,n)}}},n._bindGLBuffer=function(t,e,n){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,n))},n.loadTileImage=function(t,e){var n=this.layer.options.crossOrigin;t.crossOrigin=null!==n?n:"",t.src=e},n.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},n.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.getCanvasImage=function(){if(!this.isGL()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},n.isGL=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var t=this.getMap();return t&&(t.getPitch()||t.getBearing())||this.layer&&!!this.layer.options.fragmentShader},n.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},n.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(Xf(Ld));function Hd(t){var e=this,n=this.layer.getTileSize(),r=this.canvas.constructor,i=this.getMap(),o=i.getDevicePixelRatio(),s=Oo.createCanvas(n.width*o,n.height*o,r);s.layer=this.layer;var a=new Vt(t.extent2d.xmin,t.extent2d.ymax),l=new As(i.pointToCoordinate(a),i.pointToCoordinate(a.add(n.width,n.height)),i.getProjection());return this.layer.drawTile(s,{url:t.url,point:a,center:i.pointToCoordinate(a.add(n.width/2,n.height/2)),extent:l,z:t.z,x:t.x,y:t.y},(function(n){n?e.onTileError(s,t):e.onTileLoad(s,t)})),s}wf.registerRenderer("gl",Bd);var jd=function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e.prototype.loadTile=function(...t){return Hd.apply(this,t)},e}(Ld),Ud=function(t){function e(){return t.apply(this,arguments)||this}return kt(e,t),e.prototype.loadTile=function(...t){return Hd.apply(this,t)},e}(Bd);kf.registerRenderer("canvas",jd),kf.registerRenderer("gl",Ud);var Vd="undefined"!=typeof Int8Array?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[];function Gd(t){return t instanceof Float32Array?"FLOAT":t instanceof Int16Array?"SHORT":t instanceof Uint16Array?"UNSIGNED_SHORT":t instanceof Int8Array?"BYTE":t instanceof Uint8Array||t instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}!function(){function t(t,e,n){this.gl=t,this.quadVertices=e||Vd,this.attributes=["a_position",3,Gd(e)],this.debug=n}var e=t.prototype;e.start=function(){var t=this.gl;t.enable(t.STENCIL_TEST),t.stencilMask(255),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),Nf(t,this.program,this.attributes),this.transformLoc||(this.transformLoc=t.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=t.getUniformLocation(this.program,"color")),this.debug||t.colorMask(!1,!1,!1,!1)},e.end=function(){var t=this.gl;t.depthMask(!0),this._restore(),this.debug||t.colorMask(!0,!0,!0,!0)},e.draw=function(t){var e=this.gl;e.uniformMatrix4fv(this.transformLoc,!1,t),e.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),e.drawArrays(e.TRIANGLE_STRIP,0,4)},e.remove=function(){var t=this.gl;return this.buffer&&t.deleteBuffer(this.buffer),this.program&&(t.deleteShader(this.program.fragmentShader),t.deleteShader(this.program.vertexShader),t.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},e.stencilMask=function(t){return this.gl.stencilMask(t),this},e.stencilFunc=function(t,e,n){return this.ref=e,this.gl.stencilFunc(t,e,n),this},e.stencilOp=function(t,e,n){return this.gl.stencilOp(t,e,n),this},e.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},e._save=function(){var t=this.gl;this._savedProgram=t.program},e._restore=function(){var t=this.gl;t.program=this._savedProgram,t.program&&t.useProgram(t.program)},e._createBuffer=function(){var t=this.gl;if(this.buffer=t.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.quadVertices,t.STATIC_DRAW)},e._createProgram=function(){var{program:t,vertexShader:e,fragmentShader:n}=Df(this.gl,"\n    attribute vec3 a_position;\n    uniform mat4 transform;\n\n    void main()\n    {\n        gl_Position = transform * vec4(a_position, 1.0);\n    }\n","\n    precision mediump float;\n    uniform vec3 color;\n    void main()\n    {\n        gl_FragColor = vec4(color, 1.0);\n    }\n");t.vertexShader=e,t.fragmentShader=n,this.program=t}}();var Wd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.checkResources=function(){var t=this._geosToCheck||[];if(!this._resourceChecked&&this.layer._geoList&&Jt(t,this.layer._geoList),!ie(t))return[];for(var e=[],n={},r=t.length-1;r>=0;r--){var i=t[r]._getExternalResources();if(i.length)if(this.resources)for(var o=0;o<i.length;o++){var s=i[o][0];this.resources.isResourceLoaded(i[o])||n[s]||(e.push(i[o]),n[s]=1)}else e.push(...i)}return this._resourceChecked=!0,delete this._geosToCheck,e},n.render=function(...e){return this.layer._sortGeometries(),t.prototype.render.apply(this,e)},n._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),Jt(this._geosToCheck,t))},n.onGeometryAdd=function(t){this._addGeoToCheckRes(t),qd(this)},n.onGeometryRemove=function(t){qd(this)},n.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),qd(this)},n.onGeometryShapeChange=function(t){qd(this)},n.onGeometryPositionChange=function(t){qd(this)},n.onGeometryZIndexChange=function(t){qd(this)},n.onGeometryShow=function(t){qd(this)},n.onGeometryHide=function(t){qd(this)},n.onGeometryPropertiesChange=function(t){qd(this)},e}(va);function qd(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var Xd=new vs,Zd=[],Yd=new vs;function Jd(t){if(!t)return null;var e=t.getContext("2d");return e.clearRect(0,0,t.width,t.height),e}function Qd(t){return t&&t.options.progressiveRender&&t.options.progressiveRenderDebug}var Kd=function(t){function e(){return t.apply(this,arguments)||this}kt(e,t);var n=e.prototype;return n.setToRedraw=function(){return t.prototype.setToRedraw.call(this),this._resetProgressiveRender(),this},n._geoIsCollision=function(t,e){if(!t)return!1;if(!t.options.collision)return!1;if(t.isPoint&&t.getContainerExtent){t.bbox||(t.bbox=[0,0,0,0]);var n=this.layer.options.collisionBufferSize,r=t.getContainerExtent();if(!r)return!1;if(t.bbox[0]=r.xmin-n,t.bbox[1]=r.ymin-n,t.bbox[2]=r.xmax+n,t.bbox[3]=r.ymax+n,e.collides(t.bbox))return t._collided=!0,!0;e.insertBox(t.bbox)}return!1},n.getImageData=function(){if(!this._lastRenderTime||H()-this._lastRenderTime<32)return null;if(!this.context||!this.context.canvas)return null;if(!this._imageData){var{width:t,height:e}=this.context.canvas;try{this._imageData=this.context.getImageData(0,0,t,e)}catch(n){console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",n)}}return this._imageData},n.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=H()},n.checkResources=function(...e){var n=this,r=t.prototype.checkResources.apply(this,e),i=this.layer.getStyle();return i&&(Array.isArray(i)||(i=[i]),i.forEach((function(t){for(var e=fr(t.symbol,!0),i=0,o=e.length;i<o;i++)n.resources.isResourceLoaded(e[i])||r.push(e[i])}))),r},n.needToRedraw=function(){if(this.isProgressiveRender()&&!this.renderEnd)return!0;var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===Su)&&t.prototype.needToRedraw.call(this)},n.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},n.isBlank=function(){return!!this.context&&(!this.isProgressiveRender()&&!this.context.canvas._drawn)},n.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount(),n=this.mapStateCache.resolution;(t.isZooming()&&t.options.seamlessZoom&&void 0!==this._drawnRes&&n>1.5*this._drawnRes&&this._geosToDraw.length<e||t.isMoving()||t.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._drawnRes=n),this._sortByDistanceToCamera(t.cameraPosition);var{collision:r,collisionDelay:i}=this.layer.options;if(r){var o=H();this._lastCollisionTime||(this._lastCollisionTime=o),o-this._lastCollisionTime<=i?this._geosToDraw=this._lastGeosToDraw||this._geosToDraw:(this._collidesGeos(),this._lastCollisionTime=o)}for(var s=0,a=this._geosToDraw.length;s<a;s++){var l=this._geosToDraw[s];l._isCheck||l.isVisible()?(l._paint(this._displayExtent),this._geosToDraw[s]._cPoint=void 0,this._geosToDraw[s]._inCurrentView=void 0):(delete l._cPoint,delete l._inCurrentView)}this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Qd(this.layer)&&this.page}},n.show=function(...e){this.layer.forEach((function(t){t._repaint()})),t.prototype.show.apply(this,e)},n.forEachGeo=function(t,e){this.layer.forEach(t,e)},n._checkGeos=function(){for(var t=this._getCurrentNeedRenderGeos(),e=0,n=t.length;e<n;e++)this.checkGeo(t[e]);return this},n.drawGeos=function(){this._drawSnapshot(),this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._sortByDistanceToCamera(this.getMap().cameraPosition),this._collidesGeos();for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint(),this._geosToDraw[t]._cPoint=void 0,this._geosToDraw[t]._inCurrentView=void 0;this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Qd(this.layer)&&this.page,this._snapshot(),this._setDrawGeosDrawTime()},n.prepareToDraw=function(){return this.layer._drawTime=H(),this._hasPoint=!1,this._geosToDraw=[],this},n._setDrawGeosDrawTime=function(){H();for(var t=this.layer._drawTime,e=this.getGeoPainterList(),n=0,r=e.length;n<r;n++){var i=e[n];i&&i._setDrawTime&&i._setDrawTime(t)}return Qd(this.layer)&&H(),this},n.checkGeo=function(t){if(t.isPoint&&void 0!==this._onlyHasPoint)(t._inCurrentView||t.hasAltitude())&&(this._hasPoint=!0,t._isCheck=!0,this._geosToDraw.push(t));else if(t._isCheck=!1,t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),n=!0;if(t._inCurrentView||!U(t.options.arcDegree)||t.hasAltitude())n=!0;else if(!1===t._inCurrentView)n=!1;else{var r=e.get2DExtent(this.resources,Xd);r&&r.intersects(this._displayExtent)||(n=!1)}n&&(e.hasPoint()&&(this._hasPoint=!0),t._isCheck=!0,this._geosToDraw.push(t))}},n._collidesGeos=function(){var t=this._geosToDraw;if(!this.layer.options.collision){for(var e=0,n=t.length;e<n;e++){var r=t[e];r.isPoint&&(r._collided=!1)}return this}var i=this.layer.options.collisionScope,o=this.layer.getCollisionIndex();"layer"===i&&o.clear(),this._geosToDraw=[];for(var s=0,a=t.length;s<a;s++){var l=t[s];l.isPoint&&(l._collided=!1,this._geoIsCollision(l,o))?l._collided=!0:this._geosToDraw.push(t[s])}return this},n.onZoomEnd=function(...e){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,e)},n.onRemove=function(){this.forEachGeo((function(t){t.onHide()})),delete this._geosToDraw,delete this.snapshotCanvas,delete this.pageGeos,delete this.geoPainterList},n.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},n._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},n.identifyAtPoint=function(t,e={}){var n=this.getGeosForIdentify();return n?this.layer._hitGeos(n,t,e):[]},n._updateMapStateCache=function(){var t=this.getMap(),e=t._pointToContainerPoint(this.middleWest)._add(0,-t.height/2),n=t.getResolution(),r=t.getPitch(),i=t.getBearing(),o=t.getGLScale(),s=t.getGLRes(),a=t.getContainerExtent(),l=t.get2DExtent(),h=t.get2DExtentAtRes(s);return this.mapStateCache={resolution:n,pitch:r,bearing:i,glScale:o,glRes:s,_2DExtent:l,glExtent:h,containerExtent:a,offset:e},this},n._batchConversionMarkers=function(t){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var e=[],n=[],r=[],i={},o=this.layer,s=o.options,a=o.getAltitude?o.getAltitude():0,l=o.isCanvasRender();this._onlyHasPoint=!0;for(var h=0,u=this._getCurrentNeedRenderGeos(),c=0,f=u.length;c<f;c++){var d=u[c];if(d.isPoint){var p=d._painter;p||(p=d._getPainter());var g=p.getRenderPoints("center")[0][0],m=s.enableAltitude?d._getAltitude():a;void 0===i[m]&&(i[m]=p.getAltitude()),e[h]=g,r[h]=i[m],n[h]=d,h++}else this._onlyHasPoint=!1}if(0===h)return[];var A=this.getMap(),y=ge(e,"_pt");y=A._pointsAtResToContainerPoints(e,t,r,y);for(var v=A.getContainerExtent(),{xmax:x,ymax:_,xmin:b,ymin:w}=v,T={},M=0,C=n.length;M<C;M++){var S=n[M];if(S._cPoint=y[M],S._cPoint){var{x:I,y:P}=y[M];if(S._inCurrentView=I>=b&&P>=w&&I<=x&&P<=_||S.hasAltitude(),!S._inCurrentView){var E=S.getSymbolHash(),O=void 0;O=E?T[E]=T[E]||S._painter.getFixedExtent():S._painter.getFixedExtent(),Yd.set(O.xmin,O.ymin,O.xmax,O.ymax),Yd._add(y[M]),S._inCurrentView=Yd.intersects(v)}S._inCurrentView&&(S.isVisible()&&l||(S._inCurrentView=!1),this._onlyHasPoint&&S._inCurrentView&&(this._hasPoint=!0,S._isCheck=!0,this._geosToDraw.push(S)))}else S._inCurrentView=!1}return y},n._sortByDistanceToCamera=function(t){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var e=this.getMap(),n=e.distanceToPoint(1e3,0,e.getGLScale()).x/1e3,r="center";this._geosToDraw.sort((function(e,i){if(!e.isPoint||!i.isPoint)return 0;var o=e._painter,s=i._painter;if(!o||!s)return 0;var a=o.getRenderPoints(r)[0][0],l=s.getRenderPoints(r)[0][0],h=o.getAltitude()*n,u=s.getAltitude()*n;Yr(Zd,a.x,a.y,h);var c=ii(Zd,t);return Yr(Zd,l.x,l.y,u),ii(Zd,t)-c}))}},n._constructorIsThis=function(){return this.constructor===e},n.isProgressiveRender=function(){var t=this.layer;if(!t)return!1;var{progressiveRender:e,collision:n}=t.options||{};return!n&&e},n.getGeosForIdentify=function(){return this.isProgressiveRender()?this.pageGeos||[]:this._geosToDraw||[]},n.getGeoPainterList=function(){if(!this.isProgressiveRender()){for(var t=[],e=this._geosToDraw||[],n=0,r=e.length;n<r;n++)t.push(e[n]._painter);return t}return this.geoPainterList||[]},n._checkSnapshotCanvas=function(){if(!this.isProgressiveRender())return delete this.snapshotCanvas,null;var t=this.canvas;if(!t)return delete this.snapshotCanvas,null;this.snapshotCanvas||(this.snapshotCanvas=Oo.createCanvas(1,1));var e=this.snapshotCanvas,{width:n,height:r,style:i}=t;return e.width===n&&e.height===r||(e.width=n,e.height=r),e.style.width===i.width&&e.style.height===i.height||(e.style.width=i.width,e.style.height=i.height),e},n._getCurrentNeedRenderGeos=function(){var t=this.layer._geoList||[];if(!this.isProgressiveRender())return t;var e=this.layer,{progressiveRenderCount:n}=e.options,r=n,i=this.page,o=(i-1)*r,s=i*r;return t.slice(o,s)},n._resetProgressiveRender=function(){Qd(this.layer),this.renderEnd=!1,this.page=1,this.pageGeos=[],this.geoPainterList=[],this.maxTolerance=0,this._clearSnapshotCanvas()},n._clearSnapshotCanvas=function(){var t=this._checkSnapshotCanvas();t&&Jd(t)},n._snapshot=function(){for(var t=this.isProgressiveRender(),e=this._geosToDraw||[],n=0,r=e.length;n<r;n++){var i=e[n],o=i._hitTestTolerance()||0;if(this.maxTolerance=Math.max(this.maxTolerance,o),t){this.pageGeos.push(i);var s=i._painter;this.geoPainterList.push(s)}}if(!t)return this;H();var a=this._checkSnapshotCanvas();a&&this.canvas&&Jd(a).drawImage(this.canvas,0,0);var l=this.layer,{progressiveRenderCount:h}=l.options,u=l._geoList||[],c=Math.ceil(u.length/h);return this.renderEnd=this.page>=c,this.renderEnd&&this._setDrawGeosDrawTime(),Qd(this.layer)&&H(),this.renderEnd||this.page++,this},n._drawSnapshot=function(){if(!this.isProgressiveRender())return this;var{snapshotCanvas:t,context:e}=this;if(!t||!e)return this;var n=this.getMap();if(!n)return this;var r=n.getDevicePixelRatio()||1,i=1/r;return this._canvasContextScale(e,i),e.drawImage(t,0,0),this._canvasContextScale(e,r),this},e}(Wd);Su.registerRenderer("canvas",Kd);var $d=function(t){function e(e){var n;return(n=t.call(this)||this).map=e,n._handlerQueue=[],n._thisDocVisibilitychange=n._onDocVisibilitychange.bind(n),n._thisDocDragStart=n._onDocDragStart.bind(n),n._thisDocDragEnd=n._onDocDragEnd.bind(n),n._thisDocDPRChange=n._onDocDPRChange.bind(n),n}kt(e,t);var n=e.prototype;return n.callInNextFrame=function(t){this._handlerQueue.push(t)},n.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]()},n.offsetPlatform=function(t,e){if(!this.map.getPanels().front)return this;if(!e&&0===t.x&&0===t.y)return this;var n=this.map.getPanels(),r=this._frontCount=n.back.layerDOM.childElementCount,i=this._backCount=n.front.layerDOM.childElementCount,o=this._uiCount=n.front.uiDOM.childElementCount;if(r||i||o){var s=this.map.offsetPlatform();s=t?s.add(t)._round():s.round(),i&&sn(n.back,s),(r||o)&&sn(n.front,s)}return this},n.domChanged=function(){var t=this.map.getPanels();if(!t.front)return!1;var e=t.back.layerDOM.childElementCount;if(void 0===this._frontCount||this._frontCount!==e)return!0;var n=t.front.layerDOM.childElementCount;if(void 0===this._backCount||this._backCount!==n)return!0;var r=t.front.uiDOM.childElementCount;return void 0===this._uiCount||this._uiCount!==r},n.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map.getPanels().front)){var t=new Vt(0,0);sn(this.map.getPanels().back,t),sn(this.map.getPanels().front,t)}},n.onZoomEnd=function(){this.resetContainer()},n.onLoad=function(){this._frameLoop()},n._onDocVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},n._getWrapPanel=function(){if(!this.map)return null;var t=this.map.getPanels();return t&&t.mapWrapper},n._onDocDragStart=function(){var t=this._getWrapPanel();t&&(t.style.overflow="visible")},n._onDocDragEnd=function(){var t=this._getWrapPanel();t&&(t.style.overflow="hidden")},n._onDocDPRChange=function(){var t=this.map;t&&t.options&&!t.options.devicePixelRatio&&t.checkSize&&t.getRenderer&&(t.getRenderer()&&t.checkSize(!0))},n._containerIsOffscreen=function(){var t=this.map.getContainer();return!t||!t.style||"none"===t.style.display||Math.min(t.clientWidth,t.clientHeight)<=0},e}(Ho),tp=new co,ep=function(t){function e(e){var n;return(n=t.call(this,e)||this)._containerIsCanvas=!!e.getContainer().getContext,n._registerEvents(),n._loopTime=0,n._resizeEventList=[],n._resizeTime=-1/0,n._frameCycleRenderCount=0,n}kt(e,t);var n=e.prototype;return n.load=function(){this.initContainer()},n.renderFrame=function(t){var e=this.map;if(!e||!e.options.renderable)return!1;if(this._handleResizeEventList(t),e.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(t),delete this._isViewChanged,e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,t),this.drawLayerCanvas(n)&&(this.drawTops(),this._drawCenterCross(),e.options.debugSky&&this._debugSky()),this._needClear=!1,e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,e.uiCollides(),!0},n.getFrameTimestamp=function(){return this._frameTimestamp||0},n.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t.getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},n._needRedrawAllLayers=function(t){var e=this;if(this.isSpatialReferenceChanged())return!0;var n=[];t.forEach((function(t){if(t&&(t._toRedraw=e._checkLayerRedraw(t))){n.push(t);var r=t.getLayers&&t.getLayers();r&&Array.isArray(r)&&Jt(n,r)}}));for(var r=0,i=n.length;r<i;r++){var o=n[r],s=o&&o.options;if(s&&s.collision&&"map"===s.collisionScope)return!0}return!1},n.drawLayers=function(t,e){for(var n=this._needRedrawAllLayers(t),r=this.map,i=r.isInteracting(),o=[],s=[],a=r.options.fpsOnInteracting||0,l=0===a?0:1e3/a,h=this.map.options.layerCanvasLimitOnInteracting,u=t.length,c=r.getBaseLayer(),f=0,d=0;d<u;d++){var p=t[d];if(p.isVisible()){var g=p.isCanvasRender();g&&o.push(p.getId());var m=p._getRenderer();if(m){var A=n||p._toRedraw;g&&m.isCanvasUpdated()&&(A||s.push(p.getId()),this.setLayerCanvasUpdated());var y=m.__zoomTransformMatrix;if(delete m.__zoomTransformMatrix,A){if(i&&g){if(h>0&&u-1-d>h&&p!==c){p._getRenderer().clearCanvas();continue}f+=this._drawCanvasLayerOnInteracting(p,f,l,e)}else i&&m.drawOnInteracting?(m.prepareRender&&m.prepareRender(),m.checkAndDraw?m.checkAndDraw(m.drawOnInteracting,this._eventParam,e):m.drawOnInteracting(this._eventParam,e)):(m.render(e),g&&y&&m.isLoadingResource()&&(m.__zoomTransformMatrix=y));g&&(s.push(p.getId()),this.setLayerCanvasUpdated())}else g&&i&&(r.isZooming()&&!r.getPitch()?(m.prepareRender(),m.__zoomTransformMatrix=this._zoomMatrix):(r.getPitch()||r.isRotating())&&m.clearCanvas())}}}var v=this._canvasIds||[],x=this._updatedIds||[];if(this._canvasIds=o,this._updatedIds=s,!this.isLayerCanvasUpdated()){var _="---";v.join(_)===o.join(_)&&x.join(_)===s.join(_)||this.setLayerCanvasUpdated()}},n._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,n=t._getRenderer();return!!n&&(t.isCanvasRender()?n.testIfNeedRedraw():!(!n.needToRedraw||!n.needToRedraw())||(e.isInteracting()||this.isViewChanged()))},n._drawCanvasLayerOnInteracting=function(t,e,n,r){var i=this.map,o=t._getRenderer(),s=o.getDrawTime(),a=0===n||n>0&&e+s<=n;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(r);else{if(o.drawOnInteracting&&(t===i.getBaseLayer()||a||i.isZooming()&&t.options.forceRenderOnZooming||i.isMoving()&&t.options.forceRenderOnMoving||i.isRotating()&&t.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.checkAndDraw?o.checkAndDraw(o.drawOnInteracting,this._eventParam,r):o.drawOnInteracting(this._eventParam,r),s;!i.isZooming()||i.getPitch()||i.isRotating()?(i.getPitch()||i.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__zoomTransformMatrix=this._zoomMatrix)}return o.drawOnInteracting&&!a&&o.onSkipDrawOnInteracting(this._eventParam,r),0},n._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach((function(e){var n=t.getLayer(e);if(n){var r=n._getRenderer();r&&r.isRenderComplete()&&n.fire("layerload")}}))}},n.isLayerCanvasUpdated=function(){return this._canvasUpdated},n.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},n.drawLayerCanvas=function(t){var e=this.map;if(!e)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged()&&!1===this._needClear)return!1;this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var n,r=e.isInteracting(),i=e.options.layerCanvasLimitOnInteracting,o=t.length,s=[],a=0;a<o;a++){if(t[a].isVisible()&&t[a].isCanvasRender())if(t[a]._getRenderer()){var l=this._getLayerImage(t[a]);l&&l.image&&(t[a]===e.getBaseLayer()?n=[t[a],l]:s.push([t[a],l]))}}var h=this.canvas.width,u=this.canvas.height;n&&(this._drawLayerCanvasImage(n[0],n[1],h,u),this._drawFog()),o=s.length;for(var c=r&&i>=0&&o>i?o-i:0;c<o;c++)this._drawLayerCanvasImage(s[c][0],s[c][1],h,u);return e._fireEvent("renderend",{context:this.context}),!0},n.setToRedraw=function(){var t=this._getAllLayerToRender();this._needClear=!0;for(var e=0,n=t.length;e<n;e++){var r=t[e].getRenderer();r&&r.canvas&&r.setToRedraw&&r.setToRedraw()}},n.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",n=t.height+"px",r=this.map.getPanels();r.mapWrapper.style.width=e,r.mapWrapper.style.height=n,this._updateCanvasSize()}},n.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map.getContainer():this.map.getPanels()?this.map.getPanels().mapWrapper:null:null},n.toDataURL=function(t,e){return this.canvas?this.canvas.toDataURL(t,e):null},n.remove=function(){Pt.webgl&&"undefined"!=typeof document&&(jo.off(Uo,this._thisDocDPRChange,this),jo.off(Vo,this._thisDocVisibilitychange,this),jo.off(Go,this._thisDocDragStart,this),jo.off(Wo,this._thisDocDragEnd,this)),this._resizeInterval&&clearInterval(this._resizeInterval),this._resizeObserver&&this._resizeObserver.disconnect(),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},n.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){var n=e._getLayers(),r="default",i=e.options.hitDetectLimit||0,o=0;t&&t._round&&t._round();for(var s=n.length-1;s>=0;s--){var a=n[s];if(!(!a.options.hitDetect||a.isEmpty&&a.isEmpty())&&a.options.geometryEvents){var l=a._getRenderer();if(l&&l.hitDetect&&(!l.isBlank||!l.isBlank())){if("default"!==a.options.cursor&&l.hitDetect(t)){r=a.options.cursor||"pointer";break}if(o++,i>0&&o>i)break}}}e._trySetCursor(r)}},n._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},n.initContainer=function(){var t=this.map.getPanels();function e(e,n,r,i){var o,s=Qe("div",n);return r&&(s.style.cssText=r),t[e]=s,i||((o=s).onselectstart=function(){return!1},o.ondragstart=function(){return!1},o.setAttribute("unselectable","on")),s}var n=this.map.getContainer();if(!this._containerIsCanvas){n.innerHTML="";var r="position:absolute;top:0px;left:0px;",i=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=e("allLayers","maptalks-all-layers",r+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),s=e("backStatic","maptalks-back-static",r+"z-index:0;",!0),a=e("back","maptalks-back",r+"z-index:1;"),l=e("backLayer","maptalks-back-layer",r),h=e("canvasContainer","maptalks-canvas-layer",r+"border:none;z-index:2;"),u=e("frontStatic","maptalks-front-static",r+"z-index:3;",!0),c=e("front","maptalks-front",r+"z-index:4;",!0),f=e("frontLayer","maptalks-front-layer",r+"z-index:0;"),d=e("ui","maptalks-ui",r+"border:none;z-index:1;",!0),p=e("control","maptalks-control","z-index:1",!0);n.appendChild(i),o.appendChild(s),a.appendChild(l),a.layerDOM=l,o.appendChild(a),o.appendChild(h),c.appendChild(f),c.layerDOM=f,c.uiDOM=d,o.appendChild(u),o.appendChild(c),c.appendChild(d),i.appendChild(o),i.appendChild(p),this.createCanvas(),this.resetContainer();var g=this.map._getContainerDomSize();this.updateMapSize(g)}},n.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var t=this._mapview,e=this._getMapView();return this._isViewChanged=!t||!fe(t,e),this._isViewChanged},n._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||fe(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},n.isSpatialReferenceChanged=function(){return this._spatialRefChanged},n._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},n._lockFrameRenderEnable=function(){var{maxFPS:t}=this.map.options||{};if(t<=0||B.maxFPS<=t)return!0;var e=Math.ceil(B.maxFPS/t);return this._frameCycleRenderCount>=e},n._frameLoop=function(t){var e=this;this.map?(this._frameCycleRenderCount++,this._lockFrameRenderEnable()?(t=t||0,this._frameTimestamp=t,this._resizeCount=0,this.renderFrame(t),this._frameCycleRenderCount=0):this.map.options.debug&&this._frameCycleRenderCount,this._animationFrame=Ht((function(t){e._frameLoop(t)}))):this._cancelFrameLoop()},n._cancelFrameLoop=function(){this._animationFrame&&jt(this._animationFrame)},n._drawLayerCanvasImage=function(t,e,n,r){var i=this.context,o=e.point.round(),s=this.map.getDevicePixelRatio();1!==s&&o._multi(s);var a=e.image,l=a.width,h=a.height;if(!(o.x+l<=0||o.y+h<=0)){var u=t.options.opacity;if(V(u)||(u=1),!(u<=0)){var c=e.opacity;if(V(c)||(c=1),!(c<=0)){var f=i.globalAlpha;u<1&&(i.globalAlpha*=u),c<1&&(i.globalAlpha*=c),t.options.cssFilter&&(i.filter=t.options.cssFilter);var d=t.getRenderer(),p=d.__zoomTransformMatrix,g=d.clipCanvas(this.context);p&&(i.save(),i.setTransform(...p)),i.drawImage(a,0,0,l,h,o.x,o.y,n,r),p&&i.restore(),g&&i.restore(),"none"!==i.filter&&(i.filter="none"),i.globalAlpha=f}}}},n._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,n=new Vt(this.canvas.width/2,this.canvas.height/2);X(t)?t(e,n):Oo.drawCross(this.context,n.x,n.y,2,"#f00")}},n._drawContainerExtent=function(){var{cascadePitches:t}=this.map.options,e=this.map.height-this.map._getVisualHeight(t[0]),n=this.map.height-this.map._getVisualHeight(t[1]),r=this.map.getContainerExtent(),i=this.context;i.beginPath(),i.moveTo(0,r.ymin),i.lineTo(r.xmax,r.ymin),i.stroke(),i.beginPath(),i.moveTo(0,e),i.lineTo(r.xmax,e),i.stroke(),i.beginPath(),i.moveTo(0,n),i.lineTo(r.xmax,n),i.stroke()},n._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),n=this.context,r=t.getContainerExtent(),i=(t.height-t._getVisualHeight(75))*e;i<0&&(i=0);var o=r.ymin*e,s=Math.ceil(o-i),a=t.options.fogColor.join(),l=n.createLinearGradient(0,i,0,o+30),h=1-30/(s+30);l.addColorStop(0,"rgba("+a+", 0)"),l.addColorStop(.3,"rgba("+a+", 0.3)"),l.addColorStop(h,"rgba("+a+", 1)"),l.addColorStop(1,"rgba("+a+", 0)"),n.beginPath(),n.fillStyle=l,n.fillRect(0,i,Math.ceil(r.getWidth())*e,Math.ceil(s+30))}},n._debugSky=function(){var t=this.map;if(!t)return this;var e=t.getContainerExtent().ymin;if(e<=0)return this;var n=this.context;return n.strokeStyle="red",n.strokeRect(0,0,t.width,e),this},n._getAllLayerToRender=function(){return this.map._getLayers()},n.clearCanvas=function(){this.canvas&&Oo.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},n._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),n=this.canvas,r=t.getDevicePixelRatio(),{width:i,height:o,cssWidth:s,cssHeight:a}=ve(e,r);return!n.style||n.style.width===s&&n.style.height===a||(n.style.width=s,n.style.height=a),(i!==n.width||o!==n.height)&&(n.height=o,n.width=i,this.topLayer.width=n.width,this.topLayer.height=n.height,!0)},n.createCanvas=function(){this.topLayer=Qe("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=Qe("canvas"),this._updateCanvasSize(),this.map.getPanels().canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},n._updateDomPosition=function(t){return void 0===this._checkPositionTime&&(this._checkPositionTime=-1/0),Math.abs(t-this._checkPositionTime)>=500&&(an(this.map.getContainer()),this._checkPositionTime=Math.min(t,this._checkPositionTime)),this},n._handleResizeEventList=function(t){if(!this._resizeEventList)return this;var e=this._resizeEventList.length;if(0===e)return this;if(this._resizeTime&&t-this._resizeTime<60)return this;var n=this._resizeEventList[e-1].contentRect;return this.map.setContainerDomRect(n),this._resizeEventList=[],this._checkSize(),this._resizeCount=this._resizeCount||0,this.renderFrame((this._frameTimestamp||0)+ ++this._resizeCount/100),this._resizeTime=t,this},n._checkSize=function(){this.map&&this.map.checkSize()},n._setCheckSizeInterval=function(t){var e=this;Pt.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(t){!e.map||e.map.isRemoved()?e._resizeObserver.disconnect():t.length&&(e._resizeEventList=e._resizeEventList||[],e._resizeEventList.push(t[0]))})),this._resizeObserver.observe(this.map.getContainer()))):(clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval((function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()}),this._checkSizeInterval))},n._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!z&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),Pt.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(e){t._eventParam=e})),e.on("_zooming",(function(n){e.getPitch()||(t._zoomMatrix=n.matrix.container),t._eventParam=n})),e.on("_zoomend",(function(e){t._eventParam=e,delete t._zoomMatrix})),e.on("_spatialreferencechange",(function(){t._spatialRefChanged=!0})),Pt.webgl&&"undefined"!=typeof document&&(jo.on(Uo,this._thisDocDPRChange,this),jo.on(Vo,this._thisDocVisibilitychange,this),jo.on(Go,this._thisDocDragStart,this),jo.on(Wo,this._thisDocDragEnd,this))},n._onMapMouseMove=function(t){var e=this,n=this.map;!n.isInteracting()&&n.options.hitDetect&&(this._hitDetectFrame&&jt(this._hitDetectFrame),this._hitDetectFrame=Ht((function(){e.hitDetect(t.containerPoint)})))},n._getCanvasLayers=function(){return this.map._getLayers((function(t){return t.isCanvasRender()}))},n.addTopElement=function(t){this._tops||(this._tops=[]),this._tops.push(t)},n.removeTopElement=function(t){if(this._tops){var e=this._tops.indexOf(t);e>=0&&this._tops.splice(e,1)}},n.getTopElements=function(){return this._tops||[]},n.sortTopElements=function(){this._tops=this._tops.sort((function(t,e){var n=t.options.zIndex||0;return(e.options.zIndex||0)-n}))},n.drawTops=function(){this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height);var t=tp;t.clear(),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var e=this.getTopElements(),n=!1,r=this.map.getDevicePixelRatio(),i=[],o=0;o<e.length;o++){var s=e[o];if(s.needCollision&&s.needCollision()){var a=s.getRenderBBOX(r);if(a){if(t.collides(a)){var l=s.target&&s.target._geometry;l&&-1===i.indexOf(l)&&(i.push(l),l.fire("handlecollision"));continue}t.insertBox(a)}}s.render(this.topCtx)&&(n=!0)}n&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},e}($d);Ah.registerRenderer("canvas",ep),Ah.mergeOptions({fog:!1,fogColor:[233,233,233]});var np={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};Vh.include(np),su.include(np),ou.include(np),lu.include(np),au.include({_getRenderPoints:function(t){var e=this.getMap(),n=e.getGLRes();if("vertex"===t){for(var r=this._trimRing(this.getShell()),i=[],o=0,s=r.length;o<s;o++)i.push(e.coordToPointAtRes(r[o],n));return[i,null]}return[[e.coordToPointAtRes(this.getCenter(),n)],null]}});var rp={_getRenderPoints:function(t){var e,n=this.getMap(),r=n.getGLRes(),i=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(i=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&e.length>0&&Array.isArray(e[0])){for(var o=0,s=e.length;o<s;o++)for(var a=0,l=e[o].length;a<l;a++)0===a?i.push([e[o][a],e[o][a+1]]):i.push([e[o][a-1],e[o][a]]);e=e[0].concat(e[1])}else for(var h=0,u=e.length;h<u;h++)0===h?i.push([e[h],e[h+1]]):i.push([e[h-1],e[h]]);else if("line"===t){e=[],i=[];var c=this._getPath2DPoints(this._getPrjCoordinates(),!1,r);if(c.length>0&&Array.isArray(c[0]))for(var f,d=1,p=c.length;d<p;d++){f=c[d],this instanceof Hh&&f.length>0&&!f[0].equals(f[f.length-1])&&f.push(f[0]);for(var g=1,m=f.length;g<m;g++)e.push(f[g].add(f[g-1])._multi(.5)),i.push([f[g-1],f[g]])}else{this instanceof Hh&&c.length>0&&!c[0].equals(c[c.length-1])&&c.push(c[0]);for(var A=1,y=c.length;A<y;A++)e.push(c[A].add(c[A-1])._multi(.5)),i.push([c[A-1],c[A]])}}else if("vertex-first"===t){var v=this._getPrjCoordinates(),x=v.length,_=x?n._prjToPointAtRes(v[0],r):null;e=x?[_]:[],i=x?[[_,v[1]?n._prjToPointAtRes(v[1],r):_]]:[]}else if("vertex-last"===t){var b=this._getPrjCoordinates(),w=b.length,T=w?n._prjToPointAtRes(b[w-1],r):null;e=w?[T]:[];var M=w>1?w-2:w-1;i=w?[[b[M]?n._prjToPointAtRes(b[M],r):T,T]]:[]}else{var C=this.getCenter();if(C){var S=this._getProjection().project(C);e=[n._prjToPointAtRes(S,r)]}else e=[]}return[e,i]}};Wh.include(rp),Hh.include(rp);var ip={within:!1,center:[0,0]};function op(t){if(t&&t._containerBbox){ip.within=!1;var{minx:e,miny:n,maxx:r,maxy:i}=t._containerBbox,o=Math.abs(r-e),s=Math.abs(i-n);o<=1&&s<=1&&(ip.within=!0,ip.center[0]=(e+r)/2,ip.center[1]=(n+i)/2),delete t._containerBbox}else ip.within=!1;return ip}var sp={_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1},_getRenderBBOX:function(t,e){return t.isHitTesting?null:(Vr(Ur),Gr(e,Ur),Ur)}};function ap(){var t=this._getPrjShell(),e=jr();Gr(t,e);var[n,r,i,o]=e;return new As(n,r,i,o)}function lp(){var t=this._getPrjShell();if(!t||!Array.isArray(t))return[];var e=this._getProjection(),n=this.getCoordinates()||{};return t.map((function(t){var r=e.unproject(t);return r.z=n.z||0,r}))}rh.include(sp);var hp={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof su||this instanceof lu},_computeRotatedPrjExtent:ap,getRotatedShell:lp,_paintAsPath:function(){if(this.isRotated())return!0;var t=this.getMap();return this._getAltitude()>0||t.getPitch()||this instanceof su&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return Hh.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),n=t._prjToPointAtRes(e,t.getGLRes());return[n,...this._getRenderSize(n)]},_paintOn:function(...t){return this._paintAsPath()?Oo.polygon(...t):Oo.ellipse(...t)},_getRenderSize:function(t){var e=this.getMap(),n=e.getGLRes(),r=this._getPrjExtent(),i=e._prjToPointAtRes(r.getMin(),n),o=e._prjToPointAtRes(r.getMax(),n);return[Math.abs(o.x-i.x)/2,Math.abs(o.y-t.y),Math.abs(t.y-i.y)]}};su.include(hp),ou.include(hp);var up={_getPaintParams:function(){var t=this.getMap(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t.getGLRes())]},_paintOn:Oo.polygon,_computeRotatedPrjExtent:ap,getRotatedShell:lp};au.include(up);var cp={_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return Hh.prototype._getPaintParams.call(this,!0);var t=this.getMap(),e=t._prjToPointAtRes(this._getPrjCoordinates(),t.getGLRes()),n=this._getRenderSize(e),[r,i]=this._correctAngles();return[e,n[0],[r,i]]},_paintOn:function(...t){if(this._paintAsPath())return Oo.polygon(...t);var e=this.getMap().getBearing();return e&&(t[3]=t[3].slice(0),t[3][0]+=e,t[3][1]+=e),Oo.sector(...t)}};lu.include(hp,cp),zh.include({_paintAsPath:function(){return!0}});var fp={arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,n,r,i){if(!t||!e||t.equals(e))return null;i||(i=0);var o,s=n*r[0],a=n*r[1]+i,l=s/2+i;(o=e.nextCtrlPoint||e.prevCtrlPoint?e.prevCtrlPoint?e.sub(new Vt(e.prevCtrlPoint)):e.sub(new Vt(e.nextCtrlPoint)):e.sub(t))._unit();var h=e.sub(o.multi(a));o._perp();var u=h.add(o.multi(l));return o._multi(-1),[u,e,h.add(o.multi(l)),u]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLRes())]},_paintOn:function(t,e,n,r,i,o){var s=op(this._painter);return s.within?Oo.pixelRect(t,s.center,n,r):this.options.smoothness?Oo.paintSmoothLine(t,e,n,this.options.smoothness,!1,this._animIdx,this._animTailRatio):(t.lineColorIn=o,Oo.path(t,e,n,null,i)),this._paintArrow(t,e,n),this._getRenderBBOX(t,e)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,n){var r=this,i=this._getArrowStyle();if(!i||t.length<2)return[];for(var o,s,a=t.length>0&&Array.isArray(t[0])?t:[t],l=this._getArrowPlacement(),h=[],u=function(){if(o&&s){var t=r._getArrowShape(o,s,e,i,n);t&&h.push(t)}},c=a.length-1;c>=0;c--){var f=a[c],d=f.length,p=f[0],g=f[d-1];"vertex-first"===l?(o=p.arrowNextPoint||f[1],s=p):"vertex-last"===l&&(o=g.arrowPrePoint||f[d-2],s=g),u(),"vertex-firstlast"===l&&(o=p.arrowNextPoint||f[1],s=p,u(),o=g.arrowPrePoint||f[d-2],s=g,u()),"point"===l&&this._getArrowPoints(h,f,e,i,n)}return h},_getArrowPoints:function(t,e,n,r,i){for(var o=0,s=e.length-1;o<s;o++){var a=e[o],l=e[o+1],h=this._getArrowShape(l.arrowPrePoint||a,l,n,r,i);h&&t.push(h)}},_paintArrow:function(t,e,n){var r=this._getInternalSymbol().lineWidth;(!V(r)||r<3)&&(r=3);var i=this._getArrows(e,r);if(i.length){t.setLineDash&&t.setLineDash([]);for(var o=i.length-1;o>=0;o--)t.fillStyle=t.strokeStyle,Oo.polygon(t,i[o],n,n)}}};Wh.include(fp);var dp={_getPaintParams:function(t){var e=this.getMap().getGLRes(),n=this._getPrjShell(),r=this._getPath2DPoints(n,t,e),i=r.length>0&&Array.isArray(r[0]);i&&(r=[[r[0]],[r[1]]]);var o=this._getPrjHoles(),s=[];if(o&&o.length>0){for(var a=this._simplified,l=0;l<o.length;l++){var h=this._getPath2DPoints(o[l],t,e);Array.isArray(h)&&i?Array.isArray(h[0])?(r[0].push(h[0]),r[1].push(h[1])):r[0].push(h):s.push(h)}a&&(this._simplified=a)}return i||Jt(r=[r],s),[r]},_paintOn:function(t,e,n,r,i,o){var s=op(this._painter);return s.within?Oo.pixelRect(t,s.center,n,r):(t.lineColorIn=o,Oo.polygon(t,e,n,r,i,this.options.smoothness)),this._getRenderBBOX(t,e)}};Hh.include(dp),Ah.VERSION="1.0.0-rc.40";var pp={exports:{}};pp.exports=function(){function t(t,e){this.id=Y++,this.type=t,this.data=e}function e(t){if(0===t.length)return[];var n=t.charAt(0),r=t.charAt(t.length-1);if(1<t.length&&n===r&&('"'===n||"'"===n))return['"'+t.substr(1,t.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t))return e(t.substr(0,n.index)).concat(e(n[1])).concat(e(t.substr(n.index+n[0].length)));if(1===(n=t.split(".")).length)return['"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(t=[],r=0;r<n.length;++r)t=t.concat(e(n[r]));return t}function n(t){return"["+e(t).join("][")+"]"}function r(e,n){return"function"==typeof e?new t(0,e):"number"==typeof e||"boolean"==typeof e?new t(5,e):Array.isArray(e)?new t(6,e.map((function(t,e){return r(t)}))):e instanceof t?e:void 0}function i(){var t={"":0},e=[""];return{id:function(n){var r=t[n];return r||(r=t[n]=e.length,e.push(n),r)},str:function(t){return e[t]}}}function o(t,e,n){function r(){var e=window.innerWidth,r=window.innerHeight;t!==document.body&&(e=(r=t.getBoundingClientRect()).right-r.left,r=r.bottom-r.top),o.width=n*e,o.height=n*r,Z(o.style,{width:e+"px",height:r+"px"})}var i,o=document.createElement("canvas");return Z(o.style,{border:0,margin:0,padding:0,top:0,left:0}),t.appendChild(o),t===document.body&&(o.style.position="absolute",Z(t.style,{margin:0,padding:0})),t!==document.body&&"function"==typeof ResizeObserver?(i=new ResizeObserver((function(){setTimeout(r)}))).observe(t):window.addEventListener("resize",r,!1),r(),{canvas:o,onDestroy:function(){i?i.disconnect():window.removeEventListener("resize",r),t.removeChild(o)}}}function s(t,e){function n(n){try{return t.getContext(n,e)}catch(r){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function a(t){return"string"==typeof t?t.split():t}function l(t){return"string"==typeof t?document.querySelector(t):t}function h(t){var e,n,r,i,h=t||{};t={};var u=[],c=[],f="undefined"==typeof window?1:window.devicePixelRatio,d=!1,p=function(t){},g=function(){};if("string"==typeof h?e=document.querySelector(h):"object"==typeof h&&("string"==typeof h.nodeName&&"function"==typeof h.appendChild&&"function"==typeof h.getBoundingClientRect?e=h:"function"==typeof h.drawArrays||"function"==typeof h.drawElements?r=(i=h).canvas:("gl"in h?i=h.gl:"canvas"in h?r=l(h.canvas):"container"in h&&(n=l(h.container)),"attributes"in h&&(t=h.attributes),"extensions"in h&&(u=a(h.extensions)),"optionalExtensions"in h&&(c=a(h.optionalExtensions)),"onDone"in h&&(p=h.onDone),"profile"in h&&(d=!!h.profile),"pixelRatio"in h&&(f=+h.pixelRatio))),e&&("canvas"===e.nodeName.toLowerCase()?r=e:n=e),!i){if(!r){if(!(e=o(n||document.body,p,f)))return null;r=e.canvas,g=e.onDestroy}void 0===t.premultipliedAlpha&&(t.premultipliedAlpha=!0),i=s(r,t)}return i?{gl:i,canvas:r,container:n,extensions:u,optionalExtensions:c,pixelRatio:f,profile:d,onDone:p,onDestroy:g}:(g(),p("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function u(t,e){function n(e){var n;e=e.toLowerCase();try{n=r[e]=t.getExtension(e)}catch(i){}return!!n}for(var r={},i=0;i<e.extensions.length;++i){var o=e.extensions[i];if(!n(o))return e.onDestroy(),e.onDone('"'+o+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return e.optionalExtensions.forEach(n),{extensions:r,restore:function(){Object.keys(r).forEach((function(t){if(r[t]&&!n(t))throw Error("(regl): error restoring extension "+t)}))}}}function c(t,e){for(var n=Array(t),r=0;r<t;++r)n[r]=e(r);return n}function f(t){var e,n;return e=(65535<t)<<4,e|=n=(255<(t>>>=e))<<3,(e|=n=(15<(t>>>=n))<<2)|(n=(3<(t>>>=n))<<1)|t>>>n>>1}function d(){function t(t){t:{for(var e=16;268435456>=e;e*=16)if(t<=e){t=e;break t}t=0}return 0<(e=n[f(t)>>2]).length?e.pop():new ArrayBuffer(t)}function e(t){n[f(t.byteLength)>>2].push(t)}var n=c(8,(function(){return[]}));return{alloc:t,free:e,allocType:function(e,n){var r=null;switch(e){case 5120:r=new Int8Array(t(n),0,n);break;case 5121:r=new Uint8Array(t(n),0,n);break;case 5122:r=new Int16Array(t(2*n),0,n);break;case 5123:r=new Uint16Array(t(2*n),0,n);break;case 5124:r=new Int32Array(t(4*n),0,n);break;case 5125:r=new Uint32Array(t(4*n),0,n);break;case 5126:r=new Float32Array(t(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r},freeType:function(t){e(t.buffer)}}}function p(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||et(t.data))}function g(t,e,n,r,i,o){for(var s=0;s<e;++s)for(var a=t[s],l=0;l<n;++l)for(var h=a[l],u=0;u<r;++u)i[o++]=h[u]}function m(t,e,n,r,i){for(var o=1,s=n+1;s<e.length;++s)o*=e[s];var a=e[n];if(4==e.length-n){var l=e[n+1],h=e[n+2];for(e=e[n+3],s=0;s<a;++s)g(t[s],l,h,e,r,i),i+=o}else for(s=0;s<a;++s)m(t[s],e,n+1,r,i),i+=o}function A(t){return 0|it[Object.prototype.toString.call(t)]}function y(t,e){for(var n=0;n<e.length;++n)t[n]=e[n]}function v(t,e,n,r,i,o,s){for(var a=0,l=0;l<n;++l)for(var h=0;h<r;++h)t[a++]=e[i*l+o*h+s]}function x(t,e,n,r){function i(e){this.id=l++,this.buffer=t.createBuffer(),this.type=e,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}function o(e,n,r){e.byteLength=n.byteLength,t.bufferData(e.type,n,r)}function s(t,e,n,r,i,s){if(t.usage=n,Array.isArray(e)){if(t.dtype=r||5126,0<e.length)if(Array.isArray(e[0])){i=lt(e);for(var a=r=1;a<i.length;++a)r*=i[a];t.dimension=r,o(t,e=at(e,i,t.dtype),n),s?t.persistentData=e:$.freeType(e)}else"number"==typeof e[0]?(t.dimension=i,y(i=$.allocType(t.dtype,e.length),e),o(t,i,n),s?t.persistentData=i:$.freeType(i)):et(e[0])&&(t.dimension=e[0].length,t.dtype=r||A(e[0])||5126,o(t,e=at(e,[e.length,e[0].length],t.dtype),n),s?t.persistentData=e:$.freeType(e))}else if(et(e))t.dtype=r||A(e),t.dimension=i,o(t,e,n),s&&(t.persistentData=new Uint8Array(new Uint8Array(e.buffer)));else if(p(e)){i=e.shape;var l=e.stride,h=(a=e.offset,0),u=0,c=0,f=0;1===i.length?(h=i[0],u=1,c=l[0],f=0):2===i.length&&(h=i[0],u=i[1],c=l[0],f=l[1]),t.dtype=r||A(e.data)||5126,t.dimension=u,v(i=$.allocType(t.dtype,h*u),e.data,h,u,c,f,a),o(t,i,n),s?t.persistentData=i:$.freeType(i)}else e instanceof ArrayBuffer&&(t.dtype=5121,t.dimension=i,o(t,e,n),s&&(t.persistentData=new Uint8Array(new Uint8Array(e))))}function a(n){e.bufferCount--,r(n),t.deleteBuffer(n.buffer),n.buffer=null,delete h[n.id]}var l=0,h={};i.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},i.prototype.destroy=function(){a(this)};var u=[];return n.profile&&(e.getTotalBufferSize=function(){var t=0;return Object.keys(h).forEach((function(e){t+=h[e].stats.size})),t}),{create:function(r,o,l,u){function c(e){var r=35044,i=null,o=0,a=0,l=f&&f.dimension||1;return Array.isArray(e)||et(e)||p(e)||e instanceof ArrayBuffer?i=e:"number"==typeof e?o=0|e:e&&("data"in e&&(i=e.data),"usage"in e&&(r=st[e.usage]),"type"in e&&(a=ot[e.type]),"dimension"in e&&(l=0|e.dimension),"length"in e&&(o=0|e.length)),f.bind(),i?s(f,i,r,a,l,u):(o&&t.bufferData(f.type,o,r),f.dtype=a||5121,f.usage=r,f.dimension=l,f.byteLength=o),n.profile&&(f.stats.size=f.byteLength*ht[f.dtype]),c}e.bufferCount++;var f=new i(o);return h[f.id]=f,l||c(r),c._reglType="buffer",c._buffer=f,c.subdata=function(e,n){var r,i=0|(n||0);if(f.bind(),et(e)||e instanceof ArrayBuffer)t.bufferSubData(f.type,i,e);else if(Array.isArray(e)){if(0<e.length)if("number"==typeof e[0]){var o=$.allocType(f.dtype,e.length);y(o,e),t.bufferSubData(f.type,i,o),$.freeType(o)}else(Array.isArray(e[0])||et(e[0]))&&(r=lt(e),o=at(e,r,f.dtype),t.bufferSubData(f.type,i,o),$.freeType(o))}else if(p(e)){r=e.shape;var s=e.stride,a=o=0,l=0,h=0;1===r.length?(o=r[0],a=1,l=s[0],h=0):2===r.length&&(o=r[0],a=r[1],l=s[0],h=s[1]),r=Array.isArray(e.data)?f.dtype:A(e.data),v(r=$.allocType(r,o*a),e.data,o,a,l,h,e.offset),t.bufferSubData(f.type,i,r),$.freeType(r)}return c},n.profile&&(c.stats=f.stats),c.destroy=function(){a(f)},c},createStream:function(t,e){var n=u.pop();return n||(n=new i(t)),n.bind(),s(n,e,35040,0,1,!1),n},destroyStream:function(t){u.push(t)},clear:function(){nt(h).forEach(a),u.forEach(a)},getBuffer:function(t){return t&&t._buffer instanceof i?t._buffer:null},restore:function(){nt(h).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))},_initBuffer:s}}function _(t,e,n,r){function i(t){this.id=l++,a[this.id]=this,this.buffer=t,this.primType=4,this.type=this.vertCount=0}function o(r,i,o,s,a,l,h){var u;if(r.buffer.bind(),i?((u=h)||et(i)&&(!p(i)||et(i.data))||(u=e.oes_element_index_uint?5125:5123),n._initBuffer(r.buffer,i,o,u,3)):(t.bufferData(34963,l,o),r.buffer.dtype=u||5121,r.buffer.usage=o,r.buffer.dimension=3,r.buffer.byteLength=l),u=h,!h){switch(r.buffer.dtype){case 5121:case 5120:u=5121;break;case 5123:case 5122:u=5123;break;case 5125:case 5124:u=5125}r.buffer.dtype=u}r.type=u,0>(i=a)&&(i=r.buffer.byteLength,5123===u?i>>=1:5125===u&&(i>>=2)),r.vertCount=i,i=s,0>s&&(i=4,1===(s=r.buffer.dimension)&&(i=0),2===s&&(i=1),3===s&&(i=4)),r.primType=i}function s(t){r.elementsCount--,delete a[t.id],t.buffer.destroy(),t.buffer=null}var a={},l=0,h={uint8:5121,uint16:5123};e.oes_element_index_uint&&(h.uint32=5125),i.prototype.bind=function(){this.buffer.bind()};var u=[];return{create:function(t,e){function a(t){if(t)if("number"==typeof t)l(t),u.primType=4,u.vertCount=0|t,u.type=5121;else{var e=null,n=35044,r=-1,i=-1,s=0,c=0;Array.isArray(t)||et(t)||p(t)?e=t:("data"in t&&(e=t.data),"usage"in t&&(n=st[t.usage]),"primitive"in t&&(r=ut[t.primitive]),"count"in t&&(i=0|t.count),"type"in t&&(c=h[t.type]),"length"in t?s=0|t.length:(s=i,5123===c||5122===c?s*=2:5125!==c&&5124!==c||(s*=4))),o(u,e,n,r,i,s,c)}else l(),u.primType=4,u.vertCount=0,u.type=5121;return a}var l=n.create(null,34963,!0),u=new i(l._buffer);return r.elementsCount++,a(t),a._reglType="elements",a._elements=u,a.subdata=function(t,e){return l.subdata(t,e),a},a.destroy=function(){s(u)},a},createStream:function(t){var e=u.pop();return e||(e=new i(n.create(null,34963,!0,!1)._buffer)),o(e,t,35040,-1,-1,0,0),e},destroyStream:function(t){u.push(t)},getElements:function(t){return"function"==typeof t&&t._elements instanceof i?t._elements:null},clear:function(){nt(a).forEach(s)}}}function b(t){for(var e=$.allocType(5123,t.length),n=0;n<t.length;++n)if(isNaN(t[n]))e[n]=65535;else if(1/0===t[n])e[n]=31744;else if(-1/0===t[n])e[n]=64512;else{ct[0]=t[n];var r=(o=ft[0])>>>31<<15,i=(o<<1>>>24)-127,o=o>>13&1023;e[n]=-24>i?r:-14>i?r+(o+1024>>-14-i):15<i?r+31744:r+(i+15<<10)+o}return e}function w(t){return Array.isArray(t)||et(t)}function T(t){return"[object "+t+"]"}function M(t){return Array.isArray(t)&&(0===t.length||"number"==typeof t[0])}function C(t){return!(!Array.isArray(t)||0===t.length||!w(t[0]))}function S(t){return Object.prototype.toString.call(t)}function I(t){if(!t)return!1;var e=S(t);return 0<=bt.indexOf(e)||M(t)||C(t)||p(t)}function P(t,e){36193===t.type?(t.data=b(e),$.freeType(e)):t.data=e}function E(t,e,n,r,i,o){if(t=void 0!==Tt[t]?Tt[t]:gt[t]*wt[e],o&&(t*=6),i){for(r=0;1<=n;)r+=t*n*n,n/=2;return r}return t*n*r}function O(t,e,n,r,i,o,s){function a(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function l(t,e){t.internalformat=e.internalformat,t.format=e.format,t.type=e.type,t.compressed=e.compressed,t.premultiplyAlpha=e.premultiplyAlpha,t.flipY=e.flipY,t.unpackAlignment=e.unpackAlignment,t.colorSpace=e.colorSpace,t.width=e.width,t.height=e.height,t.channels=e.channels}function h(t,e){if("object"==typeof e&&e){"premultiplyAlpha"in e&&(t.premultiplyAlpha=e.premultiplyAlpha),"flipY"in e&&(t.flipY=e.flipY),"alignment"in e&&(t.unpackAlignment=e.alignment),"colorSpace"in e&&(t.colorSpace=U[e.colorSpace]),"type"in e&&(t.type=V[e.type]);var n=t.width,r=t.height,i=t.channels,o=!1;"shape"in e?(n=e.shape[0],r=e.shape[1],3===e.shape.length&&(i=e.shape[2],o=!0)):("radius"in e&&(n=r=e.radius),"width"in e&&(n=e.width),"height"in e&&(r=e.height),"channels"in e&&(i=e.channels,o=!0)),t.width=0|n,t.height=0|r,t.channels=0|i,n=!1,"format"in e&&(n=e.format,r=t.internalformat=G[n],t.format=ot[r],n in V&&!("type"in e)&&(t.type=V[n]),n in W&&(t.compressed=!0),n=!0),!o&&n?t.channels=gt[t.format]:o&&!n&&t.channels!==pt[t.format]&&(t.format=t.internalformat=pt[t.channels])}}function u(e){t.pixelStorei(37440,e.flipY),t.pixelStorei(37441,e.premultiplyAlpha),t.pixelStorei(37443,e.colorSpace),t.pixelStorei(3317,e.unpackAlignment)}function c(){a.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function f(t,e){var n=null;if(I(e)?n=e:e&&(h(t,e),"x"in e&&(t.xOffset=0|e.x),"y"in e&&(t.yOffset=0|e.y),I(e.data)&&(n=e.data)),e.copy){var r=i.viewportWidth,o=i.viewportHeight;t.width=t.width||r-t.xOffset,t.height=t.height||o-t.yOffset,t.needsCopy=!0}else if(n){if(et(n))t.channels=t.channels||4,t.data=n,"type"in e||5121!==t.type||(t.type=0|it[Object.prototype.toString.call(n)]);else if(M(n)){switch(t.channels=t.channels||4,o=(r=n).length,t.type){case 5121:case 5123:case 5125:case 5126:(o=$.allocType(t.type,o)).set(r),t.data=o;break;case 36193:t.data=b(r)}t.alignment=1,t.needsFree=!0}else if(p(n)){r=n.data,Array.isArray(r)||5121!==t.type||(t.type=0|it[Object.prototype.toString.call(r)]),o=n.shape;var s,a,l,u,c=n.stride;3===o.length?(l=o[2],u=c[2]):u=l=1,s=o[0],a=o[1],o=c[0],c=c[1],t.alignment=1,t.width=s,t.height=a,t.channels=l,t.format=t.internalformat=pt[l],t.needsFree=!0,s=u,n=n.offset,l=t.width,u=t.height,a=t.channels;for(var f=$.allocType(36193===t.type?5126:t.type,l*u*a),d=0,g=0;g<u;++g)for(var m=0;m<l;++m)for(var A=0;A<a;++A)f[d++]=r[o*m+c*g+s*A+n];P(t,f)}else if(S(n)===mt||S(n)===At||S(n)===yt)S(n)===mt||S(n)===At?t.element=n:t.element=n.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(S(n)===vt)t.element=n,t.width=n.width,t.height=n.height,t.channels=4;else if(S(n)===xt)t.element=n,t.width=n.naturalWidth,t.height=n.naturalHeight,t.channels=4;else if(S(n)===_t)t.element=n,t.width=n.videoWidth,t.height=n.videoHeight,t.channels=4;else if(C(n)){for(r=t.width||n[0].length,o=t.height||n.length,c=t.channels,c=w(n[0][0])?c||n[0][0].length:c||1,s=rt.shape(n),l=1,u=0;u<s.length;++u)l*=s[u];l=$.allocType(36193===t.type?5126:t.type,l),rt.flatten(n,s,"",l),P(t,l),t.alignment=1,t.width=r,t.height=o,t.channels=c,t.format=t.internalformat=pt[c],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4}function d(e,n,i,o,s){var a=e.element,l=e.data,h=e.internalformat,c=e.format,f=e.type,d=e.width,p=e.height;u(e),a?t.texSubImage2D(n,s,i,o,c,f,a):e.compressed?t.compressedTexSubImage2D(n,s,i,o,h,d,p,l):e.needsCopy?(r(),t.copyTexSubImage2D(n,s,i,o,e.xOffset,e.yOffset,d,p)):t.texSubImage2D(n,s,i,o,d,p,c,f,l)}function g(){return st.pop()||new c}function m(t){t.needsFree&&$.freeType(t.data),c.call(t),st.push(t)}function A(){a.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function y(t,e,n){var r=t.images[0]=g();t.mipmask=1,r.width=t.width=e,r.height=t.height=n,r.channels=t.channels=4}function v(t,e){var n=null;if(I(e))l(n=t.images[0]=g(),t),f(n,e),t.mipmask=1;else if(h(t,e),Array.isArray(e.mipmap))for(var r=e.mipmap,i=0;i<r.length;++i)l(n=t.images[i]=g(),t),n.width>>=i,n.height>>=i,f(n,r[i]),t.mipmask|=1<<i;else l(n=t.images[0]=g(),t),f(n,e),t.mipmask=1;l(t,t.images[0])}function x(e,n){for(var i=e.images,o=0;o<i.length&&i[o];++o){var s=i[o],a=n,l=o,h=s.element,c=s.data,f=s.internalformat,d=s.format,p=s.type,g=s.width,m=s.height;u(s),h?t.texImage2D(a,l,d,d,p,h):s.compressed?t.compressedTexImage2D(a,l,f,Math.max(1,g),Math.max(1,m),0,c):s.needsCopy?(r(),t.copyTexImage2D(a,l,d,s.xOffset,s.yOffset,g,m,0)):t.texImage2D(a,l,d,g,m,0,d,p,c||null)}}function _(){var t=at.pop()||new A;a.call(t);for(var e=t.mipmask=0;16>e;++e)t.images[e]=null;return t}function T(t){for(var e=t.images,n=0;n<e.length;++n)e[n]&&m(e[n]),e[n]=null;at.push(t)}function O(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function R(t,e){"min"in e&&(t.minFilter=j[e.min],0<=dt.indexOf(t.minFilter)&&!("faces"in e)&&(t.genMipmaps=!0)),"mag"in e&&(t.magFilter=H[e.mag]);var n=t.wrapS,r=t.wrapT;if("wrap"in e){var i=e.wrap;"string"==typeof i?n=r=B[i]:Array.isArray(i)&&(n=B[i[0]],r=B[i[1]])}else"wrapS"in e&&(n=B[e.wrapS]),"wrapT"in e&&(r=B[e.wrapT]);if(t.wrapS=n,t.wrapT=r,"anisotropic"in e&&(t.anisotropic=e.anisotropic),"mipmap"in e){switch(n=!1,typeof e.mipmap){case"string":t.mipmapHint=z[e.mipmap],n=t.genMipmaps=!0;break;case"boolean":n=t.genMipmaps=e.mipmap;break;case"object":t.genMipmaps=!1,n=!0}!n||"min"in e||(t.minFilter=9984)}}function k(n,r){t.texParameteri(r,10241,n.minFilter),t.texParameteri(r,10240,n.magFilter),t.texParameteri(r,10242,n.wrapS),t.texParameteri(r,10243,n.wrapT),e.ext_texture_filter_anisotropic&&t.texParameteri(r,34046,n.anisotropic),n.genMipmaps&&(t.hint(33170,n.mipmapHint),t.generateMipmap(r))}function L(e){a.call(this),this.mipmask=0,this.internalformat=6408,this.id=lt++,this.refCount=1,this.target=e,this.texture=t.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new O,s.profile&&(this.stats={size:0})}function D(e){t.activeTexture(33984),t.bindTexture(e.target,e.texture)}function N(){var e=ct[0];e?t.bindTexture(e.target,e.texture):t.bindTexture(3553,null)}function F(e){var n=e.texture,r=e.unit,i=e.target;0<=r&&(t.activeTexture(33984+r),t.bindTexture(i,null),ct[r]=null),t.deleteTexture(n),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete ht[e.id],o.textureCount--}var z={"don't care":4352,"dont care":4352,nice:4354,fast:4353},B={repeat:10497,clamp:33071,mirror:33648},H={nearest:9728,linear:9729},j=Z({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},H),U={none:0,browser:37444},V={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},G={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},W={};e.ext_srgb&&(G.srgb=35904,G.srgba=35906),e.oes_texture_float&&(V.float32=V.float=5126),e.oes_texture_half_float&&(V.float16=V["half float"]=36193),e.webgl_depth_texture&&(Z(G,{depth:6402,"depth stencil":34041}),Z(V,{uint16:5123,uint32:5125,"depth stencil":34042})),e.webgl_compressed_texture_s3tc&&Z(W,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),e.webgl_compressed_texture_atc&&Z(W,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),e.webgl_compressed_texture_pvrtc&&Z(W,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),e.webgl_compressed_texture_etc1&&(W["rgb etc1"]=36196);var q=Array.prototype.slice.call(t.getParameter(34467));Object.keys(W).forEach((function(t){var e=W[t];0<=q.indexOf(e)&&(G[t]=e)}));var X=Object.keys(G);n.textureFormats=X;var Y=[];Object.keys(G).forEach((function(t){Y[G[t]]=t}));var J=[];Object.keys(V).forEach((function(t){J[V[t]]=t}));var Q=[];Object.keys(H).forEach((function(t){Q[H[t]]=t}));var K=[];Object.keys(j).forEach((function(t){K[j[t]]=t}));var tt=[];Object.keys(B).forEach((function(t){tt[B[t]]=t}));var ot=X.reduce((function(t,n){var r=G[n];return 6409===r||6406===r||6409===r||6410===r||6402===r||34041===r||e.ext_srgb&&(35904===r||35906===r)?t[r]=r:32855===r||0<=n.indexOf("rgba")?t[r]=6408:t[r]=6407,t}),{}),st=[],at=[],lt=0,ht={},ut=n.maxTextureUnits,ct=Array(ut).map((function(){return null}));return Z(L.prototype,{bind:function(){this.bindCount+=1;var e=this.unit;if(0>e){for(var n=0;n<ut;++n){var r=ct[n];if(r){if(0<r.bindCount)continue;r.unit=-1}ct[n]=this,e=n;break}s.profile&&o.maxTextureUnits<e+1&&(o.maxTextureUnits=e+1),this.unit=e,t.activeTexture(33984+e),t.bindTexture(this.target,this.texture)}return e},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&F(this)}}),s.profile&&(o.getTotalTextureSize=function(){var t=0;return Object.keys(ht).forEach((function(e){t+=ht[e].stats.size})),t}),{create2D:function(e,n){function r(e,n){var o=i.texInfo;O.call(o),o.version=t instanceof WebGL2RenderingContext?2:1;var a=_();return"number"==typeof e?y(a,0|e,"number"==typeof n?0|n:0|e):e?(R(o,e),v(a,e)):y(a,1,1),o.genMipmaps&&(a.mipmask=(Math.max(a.width,a.height)<<1)-1),i.mipmask=a.mipmask,l(i,a),i.internalformat=a.internalformat,r.width=a.width,r.height=a.height,D(i),x(a,3553),k(o,3553),N(),T(a),s.profile&&(i.stats.size=E(i.internalformat,i.type,a.width,a.height,o.genMipmaps,!1)),r.format=Y[i.internalformat],r.type=J[i.type],r.mag=Q[o.magFilter],r.min=K[o.minFilter],r.wrapS=tt[o.wrapS],r.wrapT=tt[o.wrapT],r}var i=new L(3553);return ht[i.id]=i,o.textureCount++,r(e,n),r.subimage=function(t,e,n,o){e|=0,n|=0,o|=0;var s=g();return l(s,i),s.width=0,s.height=0,f(s,t),s.width=s.width||(i.width>>o)-e,s.height=s.height||(i.height>>o)-n,D(i),d(s,3553,e,n,o),N(),m(s),r},r.resize=function(e,n){var o=0|e,a=0|n||o;if(o===i.width&&a===i.height)return r;r.width=i.width=o,r.height=i.height=a,D(i);for(var l=0;i.mipmask>>l;++l){var h=o>>l,u=a>>l;if(!h||!u)break;t.texImage2D(3553,l,i.format,h,u,0,i.format,i.type,null)}return N(),s.profile&&(i.stats.size=E(i.internalformat,i.type,o,a,!1,!1)),r},r._reglType="texture2d",r._texture=i,s.profile&&(r.stats=i.stats),r.destroy=function(){i.decRef()},r},createCube:function(e,n,r,i,a,u){function c(t,e,n,r,i,o){var a,u=p.texInfo;for(O.call(u),a=0;6>a;++a)A[a]=_();if("number"!=typeof t&&t){if("object"==typeof t)if(e)v(A[0],t),v(A[1],e),v(A[2],n),v(A[3],r),v(A[4],i),v(A[5],o);else if(R(u,t),h(p,t),"faces"in t)for(t=t.faces,a=0;6>a;++a)l(A[a],p),v(A[a],t[a]);else for(a=0;6>a;++a)v(A[a],t)}else for(t=0|t||1,a=0;6>a;++a)y(A[a],t,t);for(l(p,A[0]),p.mipmask=u.genMipmaps?(Math.max(A[0].width,A[0].height)<<1)-1:A[0].mipmask,p.internalformat=A[0].internalformat,c.width=A[0].width,c.height=A[0].height,D(p),a=0;6>a;++a)x(A[a],34069+a);for(k(u,34067),N(),s.profile&&(p.stats.size=E(p.internalformat,p.type,c.width,c.height,u.genMipmaps,!0)),c.format=Y[p.internalformat],c.type=J[p.type],c.mag=Q[u.magFilter],c.min=K[u.minFilter],c.wrapS=tt[u.wrapS],c.wrapT=tt[u.wrapT],a=0;6>a;++a)T(A[a]);return c}var p=new L(34067);ht[p.id]=p,o.cubeCount++;var A=Array(6);return c(e,n,r,i,a,u),c.subimage=function(t,e,n,r,i){n|=0,r|=0,i|=0;var o=g();return l(o,p),o.width=0,o.height=0,f(o,e),o.width=o.width||(p.width>>i)-n,o.height=o.height||(p.height>>i)-r,D(p),d(o,34069+t,n,r,i),N(),m(o),c},c.resize=function(e){if((e|=0)!==p.width){c.width=p.width=e,c.height=p.height=e,D(p);for(var n=0;6>n;++n)for(var r=0;p.mipmask>>r;++r)t.texImage2D(34069+n,r,p.format,e>>r,e>>r,0,p.format,p.type,null);return N(),s.profile&&(p.stats.size=E(p.internalformat,p.type,c.width,c.height,!1,!0)),c}},c._reglType="textureCube",c._texture=p,s.profile&&(c.stats=p.stats),c.destroy=function(){p.decRef()},c},clear:function(){for(var e=0;e<ut;++e)t.activeTexture(33984+e),t.bindTexture(3553,null),ct[e]=null;nt(ht).forEach(F),o.cubeCount=0,o.textureCount=0},getTexture:function(t){return null},restore:function(){for(var e=0;e<ut;++e){var n=ct[e];n&&(n.bindCount=0,n.unit=-1,ct[e]=null)}nt(ht).forEach((function(e){e.texture=t.createTexture(),t.bindTexture(e.target,e.texture);for(var n=0;32>n;++n)if(e.mipmask&1<<n)if(3553===e.target)t.texImage2D(3553,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);else for(var r=0;6>r;++r)t.texImage2D(34069+r,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);k(e.texInfo,e.target)}))},refresh:function(){for(var e=0;e<ut;++e){var n=ct[e];n&&(n.bindCount=0,n.unit=-1,ct[e]=null),t.activeTexture(33984+e),t.bindTexture(3553,null),t.bindTexture(34067,null)}}}}function R(t,e,n,r,i,o){function s(t,e,n){this.target=t,this.texture=e,this.renderbuffer=n;var r=t=0;e?(t=e.width,r=e.height):n&&(t=n.width,r=n.height),this.width=t,this.height=r}function a(t){t&&(t.texture&&t.texture._texture.decRef(),t.renderbuffer&&t.renderbuffer._renderbuffer.decRef())}function l(t,e,n){t&&(t.texture?t.texture._texture.refCount+=1:t.renderbuffer._renderbuffer.refCount+=1)}function h(e,n){n&&(n.texture?t.framebufferTexture2D(36160,e,n.target,n.texture._texture.texture,0):t.framebufferRenderbuffer(36160,e,36161,n.renderbuffer._renderbuffer.renderbuffer))}function u(t){var e=3553,n=null,r=null,i=t;return"object"==typeof t&&(i=t.data,"target"in t&&(e=0|t.target)),"texture2d"===(t=i._reglType)||"textureCube"===t?n=i:"renderbuffer"===t&&(r=i,e=36161),new s(e,n,r)}function c(t,e,n,o,a){return n?((t=r.create2D({width:t,height:e,format:o,type:a}))._texture.refCount=0,new s(3553,t,null)):((t=i.create({width:t,height:e,format:o}))._renderbuffer.refCount=0,new s(36161,null,t))}function f(t){return t&&(t.texture||t.renderbuffer)}function d(t,e,n){t&&(t.texture?t.texture.resize(e,n):t.renderbuffer&&t.renderbuffer.resize(e,n),t.width=e,t.height=n)}function p(){this.id=w++,T[this.id]=this,this.framebuffer=t.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function g(t){t.colorAttachments.forEach(a),a(t.depthAttachment),a(t.stencilAttachment),a(t.depthStencilAttachment)}function m(e){t.deleteFramebuffer(e.framebuffer),e.framebuffer=null,o.framebufferCount--,delete T[e.id]}function A(e,r){var i;t.bindFramebuffer(36160,e.framebuffer);var o=e.colorAttachments;for(i=0;i<o.length;++i)h(36064+i,o[i]);for(i=o.length;i<n.maxColorAttachments;++i)t.framebufferTexture2D(36160,36064+i,3553,null,0);t.framebufferTexture2D(36160,33306,3553,null,0),t.framebufferTexture2D(36160,36096,3553,null,0),t.framebufferTexture2D(36160,36128,3553,null,0),h(36096,e.depthAttachment),h(36128,e.stencilAttachment),h(33306,e.depthStencilAttachment),r||(t.checkFramebufferStatus(36160),t.isContextLost()),t.bindFramebuffer(36160,v.next?v.next.framebuffer:null),v.cur=v.next,r||t.getError()}function y(e,n){function r(t,e){var n,o=0,s=0,a=!0,h=!0;n=null;var d=!0,p="rgba",m="uint8",y=1,v=null,b=null,w=null,T=!1;if("number"==typeof t)o=0|t,s=0|e||o;else if(t){var M=t;"shape"in M?(o=(s=M.shape)[0],s=s[1]):("radius"in M&&(o=s=M.radius),"width"in M&&(o=M.width),"height"in M&&(s=M.height)),("color"in M||"colors"in M)&&(n=M.color||M.colors),n||("colorCount"in M&&(y=0|M.colorCount),"colorTexture"in M&&(d=!!M.colorTexture,p="rgba4"),"colorType"in M&&(m=M.colorType,!d)&&("half float"===m||"float16"===m?p="rgba16f":"float"!==m&&"float32"!==m||(p="rgba32f")),"colorFormat"in M&&(p=M.colorFormat,0<=x.indexOf(p)?d=!0:0<=_.indexOf(p)&&(d=!1))),("depthTexture"in M||"depthStencilTexture"in M)&&(T=!(!M.depthTexture&&!M.depthStencilTexture)),"depth"in M&&("boolean"==typeof M.depth?a=M.depth:(v=M.depth,h=!1)),"stencil"in M&&("boolean"==typeof M.stencil?h=M.stencil:(b=M.stencil,a=!1)),"depthStencil"in M&&("boolean"==typeof M.depthStencil?a=h=M.depthStencil:(w=M.depthStencil,h=a=!1))}else o=s=1;var C=null,S=null,I=null,P=null;if(Array.isArray(n))C=n.map(u);else if(n)C=[u(n)];else for(C=Array(y),n=0;n<y;++n)C[n]=c(o,s,d,p,m);for(o=o||C[0].width,s=s||C[0].height,v?S=u(v):a&&!h&&(S=c(o,s,T,"depth","uint32")),b?I=u(b):h&&!a&&(I=c(o,s,!1,"stencil","uint8")),w?P=u(w):!v&&!b&&h&&a&&(P=c(o,s,T,"depth stencil","depth stencil")),a=null,n=0;n<C.length;++n)l(C[n]),C[n]&&C[n].texture&&(h=St[C[n].texture._texture.format]*It[C[n].texture._texture.type],null===a&&(a=h));return l(S),l(I),l(P),g(i),i.width=o,i.height=s,i.colorAttachments=C,i.depthAttachment=S,i.stencilAttachment=I,i.depthStencilAttachment=P,r.color=C.map(f),r.depth=f(S),r.stencil=f(I),r.depthStencil=f(P),r.width=i.width,r.height=i.height,A(i,M&&M.ignoreStatusCheck),r}var i=new p;return o.framebufferCount++,r(e,n),Z(r,{resize:function(t,e){var n=Math.max(0|t,1),o=Math.max(0|e||n,1);if(n===i.width&&o===i.height)return r;for(var s=i.colorAttachments,a=0;a<s.length;++a)d(s[a],n,o);return d(i.depthAttachment,n,o),d(i.stencilAttachment,n,o),d(i.depthStencilAttachment,n,o),i.width=r.width=n,i.height=r.height=o,A(i),r},blit:function(e,n,r){t.bindFramebuffer(36008,e._framebuffer.framebuffer),t.bindFramebuffer(36009,i.framebuffer),n||(n=16384),t.blitFramebuffer(0,0,e.width,e.height,0,0,i.width,i.height,n,"linear"===r?9729:9728),t.bindFramebuffer(36008,null),t.bindFramebuffer(36009,null)},_reglType:"framebuffer",_framebuffer:i,destroy:function(){m(i),g(i)},use:function(t){v.setFBO({framebuffer:r},t)}})}var v={cur:null,next:null,dirty:!1,setFBO:null},x=["rgba"],_=["rgba4","rgb565","rgb5 a1"];e.ext_srgb&&_.push("srgba"),e.ext_color_buffer_half_float&&_.push("rgba16f","rgb16f"),e.webgl_color_buffer_float&&_.push("rgba32f");var b=["uint8"];e.oes_texture_half_float&&b.push("half float","float16"),e.oes_texture_float&&b.push("float","float32");var w=0,T={};return Z(v,{getFramebuffer:function(t){return"function"==typeof t&&"framebuffer"===t._reglType&&(t=t._framebuffer)instanceof p?t:null},create:y,createCube:function(t){function e(t){var i,o={color:null},s=0,a=null;i="rgba";var l="uint8",h=1;if("number"==typeof t?s=0|t:t?("shape"in t?s=t.shape[0]:("radius"in t&&(s=0|t.radius),"width"in t?s=0|t.width:"height"in t&&(s=0|t.height)),("color"in t||"colors"in t)&&(a=t.color||t.colors),a||("colorCount"in t&&(h=0|t.colorCount),"colorType"in t&&(l=t.colorType),"colorFormat"in t&&(i=t.colorFormat)),"depth"in t&&(o.depth=t.depth),"stencil"in t&&(o.stencil=t.stencil),"depthStencil"in t&&(o.depthStencil=t.depthStencil)):s=1,a)if(Array.isArray(a))for(t=[],i=0;i<a.length;++i)t[i]=a[i];else t=[a];else for(t=Array(h),a={radius:s,format:i,type:l},i=0;i<h;++i)t[i]=r.createCube(a);for(o.color=Array(t.length),i=0;i<t.length;++i)h=t[i],s=s||h.width,o.color[i]={target:34069,data:t[i]};for(i=0;6>i;++i){for(h=0;h<t.length;++h)o.color[h].target=34069+i;0<i&&(o.depth=n[0].depth,o.stencil=n[0].stencil,o.depthStencil=n[0].depthStencil),n[i]?n[i](o):n[i]=y(o)}return Z(e,{width:s,height:s,color:t})}var n=Array(6);return e(t),Z(e,{faces:n,resize:function(t){var r=0|t;if(r===e.width)return e;var i=e.color;for(t=0;t<i.length;++t)i[t].resize(r);for(t=0;6>t;++t)n[t].resize(r);return e.width=e.height=r,e},_reglType:"framebufferCube",destroy:function(){n.forEach((function(t){t.destroy()}))}})},clear:function(){nt(T).forEach(m)},restore:function(){v.cur=null,v.next=null,v.dirty=!0,nt(T).forEach((function(e){e.framebuffer=t.createFramebuffer(),A(e)}))}})}function k(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function L(t,e,n,r,i,o,s){function a(t){if(t!==A.currentVAO){var n=e.oes_vertex_array_object;t?n.bindVertexArrayOES(t.vao):n.bindVertexArrayOES(null),A.currentVAO=t}}function l(n){if(n!==A.currentVAO){if(n)n.bindAttrs();else{for(var r=e.angle_instanced_arrays,i=0;i<d.length;++i){var o=d[i];o.buffer?(t.enableVertexAttribArray(i),o.buffer.bind(),t.vertexAttribPointer(i,o.size,o.type,o.normalized,o.stride,o.offfset),r&&o.divisor&&r.vertexAttribDivisorANGLE(i,o.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,o.x,o.y,o.z,o.w))}s.elements?t.bindBuffer(34963,s.elements.buffer.buffer):t.bindBuffer(34963,null)}A.currentVAO=n}}function h(){nt(m).forEach((function(t){t.destroy()}))}function u(){this.id=++g,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var t=e.oes_vertex_array_object;this.vao=t?t.createVertexArrayOES():null,m[this.id]=this,this.buffers=[]}function c(){e.oes_vertex_array_object&&nt(m).forEach((function(t){t.refresh()}))}var f=n.maxAttributes,d=Array(f);for(n=0;n<f;++n)d[n]=new k;var g=0,m={},A={Record:k,scope:{},state:d,currentVAO:null,targetVAO:null,restore:e.oes_vertex_array_object?c:function(){},createVAO:function(t){function e(t){var r;Array.isArray(t)?(r=t,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4):(t.elements?(r=t.elements,n.ownsElements?("function"==typeof r&&"elements"===r._reglType?n.elements.destroy():n.elements(r),n.ownsElements=!1):o.getElements(t.elements)?(n.elements=t.elements,n.ownsElements=!1):(n.elements=o.create(t.elements),n.ownsElements=!0)):(n.elements=null,n.ownsElements=!1),r=t.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in t&&(n.offset=0|t.offset),"count"in t&&(n.count=0|t.count),"instances"in t&&(n.instances=0|t.instances),"primitive"in t&&(n.primitive=ut[t.primitive])),t={};var s=n.attributes;s.length=r.length;for(var a=0;a<r.length;++a){var l,h=r[a],u=s[a]=new k,c=h.data||h;Array.isArray(c)||et(c)||p(c)?(n.buffers[a]&&(l=n.buffers[a],et(c)&&l._buffer.byteLength>=c.byteLength?l.subdata(c):(l.destroy(),n.buffers[a]=null)),n.buffers[a]||(l=n.buffers[a]=i.create(h,34962,!1,!0)),u.buffer=i.getBuffer(l),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1,t[a]=1):i.getBuffer(h)?(u.buffer=i.getBuffer(h),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1):i.getBuffer(h.buffer)?(u.buffer=i.getBuffer(h.buffer),u.size=0|(+h.size||u.buffer.dimension),u.normalized=!!h.normalized||!1,u.type="type"in h?ot[h.type]:u.buffer.dtype,u.offset=0|(h.offset||0),u.stride=0|(h.stride||0),u.divisor=0|(h.divisor||0),u.state=1):"x"in h&&(u.x=+h.x||0,u.y=+h.y||0,u.z=+h.z||0,u.w=+h.w||0,u.state=2)}for(l=0;l<n.buffers.length;++l)!t[l]&&n.buffers[l]&&(n.buffers[l].destroy(),n.buffers[l]=null);return n.refresh(),e}var n=new u;return r.vaoCount+=1,e.destroy=function(){for(var t=0;t<n.buffers.length;++t)n.buffers[t]&&n.buffers[t].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},e._vao=n,e._reglType="vao",e(t)},getVAO:function(t){return"function"==typeof t&&t._vao?t._vao:null},destroyBuffer:function(e){for(var n=0;n<d.length;++n){var r=d[n];r.buffer===e&&(t.disableVertexAttribArray(n),r.buffer=null)}},setVAO:e.oes_vertex_array_object?a:l,clear:e.oes_vertex_array_object?h:function(){}};return u.prototype.bindAttrs=function(){for(var n=e.angle_instanced_arrays,r=this.attributes,i=0;i<r.length;++i){var s=r[i];s.buffer?(t.enableVertexAttribArray(i),t.bindBuffer(34962,s.buffer.buffer),t.vertexAttribPointer(i,s.size,s.type,s.normalized,s.stride,s.offset),n&&s.divisor&&n.vertexAttribDivisorANGLE(i,s.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,s.x,s.y,s.z,s.w))}for(n=r.length;n<f;++n)t.disableVertexAttribArray(n);(n=o.getElements(this.elements))?t.bindBuffer(34963,n.buffer.buffer):t.bindBuffer(34963,null)},u.prototype.refresh=function(){var t=e.oes_vertex_array_object;t&&(t.bindVertexArrayOES(this.vao),this.bindAttrs(),A.currentVAO=null,t.bindVertexArrayOES(null))},u.prototype.destroy=function(){if(this.vao){var t=e.oes_vertex_array_object;this===A.currentVAO&&(A.currentVAO=null,t.bindVertexArrayOES(null)),t.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),m[this.id]&&(delete m[this.id],--r.vaoCount)},A}function D(t,e,n,r){function i(t,e,n,r){this.name=t,this.id=e,this.location=n,this.info=r}function o(t,e){for(var n=0;n<t.length;++n)if(t[n].id===e.id)return void(t[n].location=e.location);t.push(e)}function s(n,r,i){if(!(s=(i=35632===n?h:u)[r])){var o=e.str(r),s=t.createShader(n);t.shaderSource(s,o),t.compileShader(s),i[r]=s}return s}function a(t,e){this.id=d++,this.fragId=t,this.vertId=e,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function l(n,a,l){var h;h=s(35632,n.fragId);var u=s(35633,n.vertId);if(a=n.program=t.createProgram(),t.attachShader(a,h),t.attachShader(a,u),l)for(h=0;h<l.length;++h)u=l[h],t.bindAttribLocation(a,u[0],u[1]);t.linkProgram(a),u=t.getProgramParameter(a,35718),r.profile&&(n.stats.uniformsCount=u);var c=n.uniforms;for(h=0;h<u;++h)if(l=t.getActiveUniform(a,h)){if(1<l.size)for(var f=0;f<l.size;++f){var d=l.name.replace("[0]","["+f+"]");o(c,new i(d,e.id(d),t.getUniformLocation(a,d),l))}f=l.name,1<l.size&&(f=f.replace("[0]","")),o(c,new i(f,e.id(f),t.getUniformLocation(a,f),l))}for(u=t.getProgramParameter(a,35721),r.profile&&(n.stats.attributesCount=u),n=n.attributes,h=0;h<u;++h)(l=t.getActiveAttrib(a,h))&&o(n,new i(l.name,e.id(l.name),t.getAttribLocation(a,l.name),l))}var h={},u={},c={},f=[],d=0;return r.profile&&(n.getMaxUniformsCount=function(){var t=0;return f.forEach((function(e){e.stats.uniformsCount>t&&(t=e.stats.uniformsCount)})),t},n.getMaxAttributesCount=function(){var t=0;return f.forEach((function(e){e.stats.attributesCount>t&&(t=e.stats.attributesCount)})),t}),{clear:function(){var e=t.deleteShader.bind(t);nt(h).forEach(e),h={},nt(u).forEach(e),u={},f.forEach((function(e){t.deleteProgram(e.program)})),f.length=0,c={},n.shaderCount=0},program:function(e,r,i,o){var s=c[r];s||(s=c[r]={});var d=s[e];if(d&&(d.refCount++,!o))return d;var p=new a(r,e);return n.shaderCount++,l(p,i,o),d||(s[e]=p),f.push(p),Z(p,{destroy:function(){if(p.refCount--,0>=p.refCount){t.deleteProgram(p.program);var e=f.indexOf(p);f.splice(e,1),n.shaderCount--}0>=s[p.vertId].refCount&&(t.deleteShader(u[p.vertId]),delete u[p.vertId],delete c[p.fragId][p.vertId]),Object.keys(c[p.fragId]).length||(t.deleteShader(h[p.fragId]),delete h[p.fragId],delete c[p.fragId])}})},restore:function(){h={},u={};for(var t=0;t<f.length;++t)l(f[t],null,f[t].attributes.map((function(t){return[t.location,t.name]})))},shader:s,frag:-1,vert:-1}}function N(t,e,n,r,i,o,s){function a(i){var o;o=null===e.next?5121:e.next.colorAttachments[0].texture._texture.type;var s=0,a=0,l=r.framebufferWidth,h=r.framebufferHeight,u=null;return et(i)?u=i:i&&(s=0|i.x,a=0|i.y,l=0|(i.width||r.framebufferWidth-s),h=0|(i.height||r.framebufferHeight-a),u=i.data||null),n(),i=l*h*4,u||(5121===o?u=new Uint8Array(i):5126===o&&(u=u||new Float32Array(i))),t.pixelStorei(3333,4),t.readPixels(s,a,l,h,6408,o,u),u}function l(t){var n;return e.setFBO({framebuffer:t.framebuffer},(function(){n=a(t)})),n}return function(t){return t&&"framebuffer"in t?l(t):a(t)}}function F(t){return Array.prototype.slice.call(t)}function z(t){return F(t).join("")}function B(){function t(){var t=[],e=[];return Z((function(){t.push.apply(t,F(arguments))}),{def:function(){var r="v"+n++;return e.push(r),0<arguments.length&&(t.push(r,"="),t.push.apply(t,F(arguments)),t.push(";")),r},toString:function(){return z([0<e.length?"var "+e.join(",")+";":"",z(t)])}})}function e(){function e(t,e){r(t,e,"=",n.def(t,e),";")}var n=t(),r=t(),i=n.toString,o=r.toString;return Z((function(){n.apply(n,F(arguments))}),{def:n.def,entry:n,exit:r,save:e,set:function(t,r,i){e(t,r),n(t,r,"=",i,";")},toString:function(){return i()+o()}})}var n=0,r=[],i=[],o=t(),s={};return{global:o,link:function(t){for(var e=0;e<i.length;++e)if(i[e]===t)return r[e];return e="g"+n++,r.push(e),i.push(t),e},block:t,proc:function(t,n){function r(){var t="a"+i.length;return i.push(t),t}var i=[];n=n||0;for(var o=0;o<n;++o)r();var a=(o=e()).toString;return s[t]=Z(o,{arg:r,toString:function(){return z(["function(",i.join(),"){",a(),"}"])}})},scope:e,cond:function(){var t=z(arguments),n=e(),r=e(),i=n.toString,o=r.toString;return Z(n,{then:function(){return n.apply(n,F(arguments)),this},else:function(){return r.apply(r,F(arguments)),this},toString:function(){var e=o();return e&&(e="else{"+e+"}"),z(["if(",t,"){",i(),"}",e])}})},compile:function(){var t=['"use strict";',o,"return {"];Object.keys(s).forEach((function(e){t.push('"',e,'":',s[e].toString(),",")})),t.push("}");var e=z(t).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(e)).apply(null,i)}}}function H(t){return Array.isArray(t)||et(t)||p(t)}function j(t){return t.sort((function(t,e){return"viewport"===t?-1:"viewport"===e?1:t<e?-1:1}))}function U(t,e,n,r){this.thisDep=t,this.contextDep=e,this.propDep=n,this.append=r}function V(t){return t&&!(t.thisDep||t.contextDep||t.propDep)}function G(t){return new U(!1,!1,!1,t)}function W(t,e){var n=t.type;if(0===n)return new U(!0,1<=(n=t.data.length),2<=n,e);if(4===n)return new U((n=t.data).thisDep,n.contextDep,n.propDep,e);if(5===n)return new U(!1,!1,!1,e);if(6===n){for(var r=n=!1,i=!1,o=0;o<t.data.length;++o){var s=t.data[o];1===s.type?i=!0:2===s.type?r=!0:3===s.type?n=!0:0===s.type?(n=!0,1<=(s=s.data)&&(r=!0),2<=s&&(i=!0)):4===s.type&&(n=n||s.data.thisDep,r=r||s.data.contextDep,i=i||s.data.propDep)}return new U(n,r,i,e)}return new U(3===n,2===n,1===n,e)}function q(t,e,n,r,i,o,s,a,l,h,u,f,d,p,g){function m(t){return t.replace(".","_")}function A(t,e,n){var r=m(t);pt.push(t),dt[r]=ft[r]=!!n,gt[r]=e}function y(t,e,n){var r=m(t);pt.push(t),Array.isArray(n)?(ft[r]=n.slice(),dt[r]=n.slice()):ft[r]=dt[r]=n,mt[r]=e}function v(){var t=B(),n=t.link,r=t.global;t.id=vt++,t.batchId="0";var i=n(At),o=t.shared={props:"a0"};Object.keys(At).forEach((function(t){o[t]=r.def(i,".",t)}));var s=t.next={},a=t.current={};Object.keys(mt).forEach((function(t){Array.isArray(ft[t])&&(s[t]=r.def(o.next,".",t),a[t]=r.def(o.current,".",t))}));var l=t.constants={};Object.keys(yt).forEach((function(t){l[t]=r.def(JSON.stringify(yt[t]))})),t.invoke=function(e,r){switch(r.type){case 0:var i=["this",o.context,o.props,t.batchId];return e.def(n(r.data),".call(",i.slice(0,Math.max(r.data.length+1,4)),")");case 1:return e.def(o.props,r.data);case 2:return e.def(o.context,r.data);case 3:return e.def("this",r.data);case 4:return r.data.append(t,e),r.data.ref;case 5:return r.data.toString();case 6:return r.data.map((function(n){return t.invoke(e,n)}))}},t.attribCache={};var u={};return t.scopeAttrib=function(t){if((t=e.id(t))in u)return u[t];var r=h.scope[t];return r||(r=h.scope[t]=new st),u[t]=n(r)},t}function x(t){var e,n=t.static;if(t=t.dynamic,"profile"in n){var r=!!n.profile;(e=G((function(t,e){return r}))).enable=r}else if("profile"in t){var i=t.profile;e=W(i,(function(t,e){return t.invoke(e,i)}))}return e}function _(t,e){var n=t.static,r=t.dynamic;if("framebuffer"in n){var i=n.framebuffer;return i?(i=a.getFramebuffer(i),G((function(t,e){var n=t.link(i),r=t.shared;return e.set(r.framebuffer,".next",n),r=r.context,e.set(r,".framebufferWidth",n+".width"),e.set(r,".framebufferHeight",n+".height"),n}))):G((function(t,e){var n=t.shared;return e.set(n.framebuffer,".next","null"),n=n.context,e.set(n,".framebufferWidth",n+".drawingBufferWidth"),e.set(n,".framebufferHeight",n+".drawingBufferHeight"),"null"}))}if("framebuffer"in r){var o=r.framebuffer;return W(o,(function(t,e){var n=t.invoke(e,o),r=t.shared,i=r.framebuffer;return n=e.def(i,".getFramebuffer(",n,")"),e.set(i,".next",n),r=r.context,e.set(r,".framebufferWidth",n+"?"+n+".width:"+r+".drawingBufferWidth"),e.set(r,".framebufferHeight",n+"?"+n+".height:"+r+".drawingBufferHeight"),n}))}return null}function b(t,e,n){function r(t){if(t in i){var n=i[t];t=!0;var r,s,a=0|n.x,l=0|n.y;return"width"in n?r=0|n.width:t=!1,"height"in n?s=0|n.height:t=!1,new U(!t&&e&&e.thisDep,!t&&e&&e.contextDep,!t&&e&&e.propDep,(function(t,e){var i=t.shared.context,o=r;"width"in n||(o=e.def(i,".","framebufferWidth","-",a));var h=s;return"height"in n||(h=e.def(i,".","framebufferHeight","-",l)),[a,l,o,h]}))}if(t in o){var h=o[t];return t=W(h,(function(t,e){var n=t.invoke(e,h),r=t.shared.context,i=e.def(n,".x|0"),o=e.def(n,".y|0");return[i,o,e.def('"width" in ',n,"?",n,".width|0:","(",r,".","framebufferWidth","-",i,")"),n=e.def('"height" in ',n,"?",n,".height|0:","(",r,".","framebufferHeight","-",o,")")]})),e&&(t.thisDep=t.thisDep||e.thisDep,t.contextDep=t.contextDep||e.contextDep,t.propDep=t.propDep||e.propDep),t}return e?new U(e.thisDep,e.contextDep,e.propDep,(function(t,e){var n=t.shared.context;return[0,0,e.def(n,".","framebufferWidth"),e.def(n,".","framebufferHeight")]})):null}var i=t.static,o=t.dynamic;if(t=r("viewport")){var s=t;t=new U(t.thisDep,t.contextDep,t.propDep,(function(t,e){var n=s.append(t,e),r=t.shared.context;return e.set(r,".viewportWidth",n[2]),e.set(r,".viewportHeight",n[3]),n}))}return{viewport:t,scissor_box:r("scissor.box")}}function T(t,e){if("string"==typeof(n=t.static).frag&&"string"==typeof n.vert){if(0<Object.keys(e.dynamic).length)return null;var n=e.static,r=Object.keys(n);if(0<r.length&&"number"==typeof n[r[0]]){for(var i=[],o=0;o<r.length;++o)i.push([0|n[r[o]],r[o]]);return i}}return null}function M(t,n,r){function i(t){if(t in o){var n=e.id(o[t]);return(t=G((function(){return n}))).id=n,t}if(t in s){var r=s[t];return W(r,(function(t,e){var n=t.invoke(e,r);return e.def(t.shared.strings,".id(",n,")")}))}return null}var o=t.static,s=t.dynamic,a=i("frag"),l=i("vert"),h=null;return V(a)&&V(l)?(h=u.program(l.id,a.id,null,r),t=G((function(t,e){return t.link(h)}))):t=new U(a&&a.thisDep||l&&l.thisDep,a&&a.contextDep||l&&l.contextDep,a&&a.propDep||l&&l.propDep,(function(t,e){var n,r,i=t.shared.shader;return n=a?a.append(t,e):e.def(i,".","frag"),r=l?l.append(t,e):e.def(i,".","vert"),e.def(i+".program("+r+","+n+")")})),{frag:a,vert:l,progVar:t,program:h}}function C(t,e){function n(t,e){if(t in r){var n=0|r[t];return e?s.offset=n:s.instances=n,G((function(t,r){return e&&(t.OFFSET=n),n}))}if(t in i){var o=i[t];return W(o,(function(t,n){var r=t.invoke(n,o);return e&&(t.OFFSET=r),r}))}if(e){if(u)return G((function(t,e){return t.OFFSET=0}));if(a)return new U(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.offset:0")}))}else if(a)return new U(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.instances:-1")}));return null}var r=t.static,i=t.dynamic,s={},a=!1,l=function(){if("vao"in r){var t=r.vao;return null!==t&&null===h.getVAO(t)&&(t=h.createVAO(t)),a=!0,s.vao=t,G((function(e){var n=h.getVAO(t);return n?e.link(n):"null"}))}if("vao"in i){a=!0;var e=i.vao;return W(e,(function(t,n){var r=t.invoke(n,e);return n.def(t.shared.vao+".getVAO("+r+")")}))}return null}(),u=!1,c=function(){if("elements"in r){var t=r.elements;if(s.elements=t,H(t)){var e=s.elements=o.create(t,!0);t=o.getElements(e),u=!0}else t&&(t=o.getElements(t),u=!0);return(e=G((function(e,n){if(t){var r=e.link(t);return e.ELEMENTS=r}return e.ELEMENTS=null}))).value=t,e}if("elements"in i){u=!0;var n=i.elements;return W(n,(function(t,e){var r=(i=t.shared).isBufferArgs,i=i.elements,o=t.invoke(e,n),s=e.def("null");return r=e.def(r,"(",o,")"),o=t.cond(r).then(s,"=",i,".createStream(",o,");").else(s,"=",i,".getElements(",o,");"),e.entry(o),e.exit(t.cond(r).then(i,".destroyStream(",s,");")),t.ELEMENTS=s}))}return a?new U(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.elements+".getElements("+t.shared.vao+".currentVAO.elements):null")})):null}(),f=n("offset",!0),d=function(){if("primitive"in r){var t=r.primitive;return s.primitive=t,G((function(e,n){return ut[t]}))}if("primitive"in i){var e=i.primitive;return W(e,(function(t,n){var r=t.constants.primTypes,i=t.invoke(n,e);return n.def(r,"[",i,"]")}))}return u?V(c)?c.value?G((function(t,e){return e.def(t.ELEMENTS,".primType")})):G((function(){return 4})):new U(c.thisDep,c.contextDep,c.propDep,(function(t,e){var n=t.ELEMENTS;return e.def(n,"?",n,".primType:",4)})):a?new U(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.primitive:4")})):null}(),p=function(){if("count"in r){var t=0|r.count;return s.count=t,G((function(){return t}))}if("count"in i){var e=i.count;return W(e,(function(t,n){return t.invoke(n,e)}))}return u?V(c)?c?f?new U(f.thisDep,f.contextDep,f.propDep,(function(t,e){return e.def(t.ELEMENTS,".vertCount-",t.OFFSET)})):G((function(t,e){return e.def(t.ELEMENTS,".vertCount")})):G((function(){return-1})):new U(c.thisDep||f.thisDep,c.contextDep||f.contextDep,c.propDep||f.propDep,(function(t,e){var n=t.ELEMENTS;return t.OFFSET?e.def(n,"?",n,".vertCount-",t.OFFSET,":-1"):e.def(n,"?",n,".vertCount:-1")})):a?new U(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao,".currentVAO?",t.shared.vao,".currentVAO.count:-1")})):null}(),g=n("instances",!1);return{elements:c,primitive:d,count:p,instances:g,offset:f,vao:l,vaoActive:a,elementsActive:u,static:s}}function S(t,e){var n=t.static,r=t.dynamic,i={};return pt.forEach((function(t){function e(e,s){if(t in n){var a=e(n[t]);i[o]=G((function(){return a}))}else if(t in r){var l=r[t];i[o]=W(l,(function(t,e){return s(t,e,t.invoke(e,l))}))}}var o=m(t);switch(t){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":case"lineWidth":return e((function(t){return t}),(function(t,e,n){return n}));case"depth.func":return e((function(t){return Rt[t]}),(function(t,e,n){return e.def(t.constants.compareFuncs,"[",n,"]")}));case"depth.range":return e((function(t){return t}),(function(t,e,n){return[e.def("+",n,"[0]"),e=e.def("+",n,"[1]")]}));case"blend.func":return e((function(t){return[Ot["srcRGB"in t?t.srcRGB:t.src],Ot["dstRGB"in t?t.dstRGB:t.dst],Ot["srcAlpha"in t?t.srcAlpha:t.src],Ot["dstAlpha"in t?t.dstAlpha:t.dst]]}),(function(t,e,n){function r(t,r){return e.def('"',t,r,'" in ',n,"?",n,".",t,r,":",n,".",t)}t=t.constants.blendFuncs;var i=r("src","RGB"),o=r("dst","RGB"),s=(i=e.def(t,"[",i,"]"),e.def(t,"[",r("src","Alpha"),"]"));return[i,o=e.def(t,"[",o,"]"),s,t=e.def(t,"[",r("dst","Alpha"),"]")]}));case"blend.equation":return e((function(t){return"string"==typeof t?[at[t],at[t]]:"object"==typeof t?[at[t.rgb],at[t.alpha]]:void 0}),(function(t,e,n){var r=t.constants.blendEquations,i=e.def(),o=e.def();return(t=t.cond("typeof ",n,'==="string"')).then(i,"=",o,"=",r,"[",n,"];"),t.else(i,"=",r,"[",n,".rgb];",o,"=",r,"[",n,".alpha];"),e(t),[i,o]}));case"blend.color":return e((function(t){return c(4,(function(e){return+t[e]}))}),(function(t,e,n){return c(4,(function(t){return e.def("+",n,"[",t,"]")}))}));case"stencil.mask":return e((function(t){return 0|t}),(function(t,e,n){return e.def(n,"|0")}));case"stencil.func":return e((function(t){return[Rt[t.cmp||"keep"],t.ref||0,"mask"in t?t.mask:-1]}),(function(t,e,n){return[t=e.def('"cmp" in ',n,"?",t.constants.compareFuncs,"[",n,".cmp]",":",7680),e.def(n,".ref|0"),e=e.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case"stencil.opFront":case"stencil.opBack":return e((function(e){return["stencil.opBack"===t?1029:1028,kt[e.fail||"keep"],kt[e.zfail||"keep"],kt[e.zpass||"keep"]]}),(function(e,n,r){function i(t){return n.def('"',t,'" in ',r,"?",o,"[",r,".",t,"]:",7680)}var o=e.constants.stencilOps;return["stencil.opBack"===t?1029:1028,i("fail"),i("zfail"),i("zpass")]}));case"polygonOffset.offset":return e((function(t){return[0|t.factor,0|t.units]}),(function(t,e,n){return[e.def(n,".factor|0"),e=e.def(n,".units|0")]}));case"cull.face":return e((function(t){var e=0;return"front"===t?e=1028:"back"===t&&(e=1029),e}),(function(t,e,n){return e.def(n,'==="front"?',1028,":",1029)}));case"frontFace":return e((function(t){return Lt[t]}),(function(t,e,n){return e.def(n+'==="cw"?2304:2305')}));case"colorMask":return e((function(t){return t.map((function(t){return!!t}))}),(function(t,e,n){return c(4,(function(t){return"!!"+n+"["+t+"]"}))}));case"sample.coverage":return e((function(t){return["value"in t?t.value:1,!!t.invert]}),(function(t,e,n){return[e.def('"value" in ',n,"?+",n,".value:1"),e=e.def("!!",n,".invert")]}))}})),i}function I(t,e){var n=t.static,r=t.dynamic,i={};return Object.keys(n).forEach((function(t){var e,r=n[t];if("number"==typeof r||"boolean"==typeof r)e=G((function(){return r}));else if("function"==typeof r){var o=r._reglType;"texture2d"===o||"textureCube"===o?e=G((function(t){return t.link(r)})):"framebuffer"!==o&&"framebufferCube"!==o||(e=G((function(t){return t.link(r.color[0])})))}else w(r)&&(e=G((function(t){return t.global.def("[",c(r.length,(function(t){return r[t]})),"]")})));e.value=r,i[t]=e})),Object.keys(r).forEach((function(t){var e=r[t];i[t]=W(e,(function(t,n){return t.invoke(n,e)}))})),i}function P(t,n){var r=t.static,o=t.dynamic,s={};return Object.keys(r).forEach((function(t){var n=r[t],o=e.id(t),a=new st;if(H(n))a.state=1,a.buffer=i.getBuffer(i.create(n,34962,!1,!0)),a.type=0;else if(h=i.getBuffer(n))a.state=1,a.buffer=h,a.type=0;else if("constant"in n){var l=n.constant;a.buffer="null",a.state=2,"number"==typeof l?a.x=l:Pt.forEach((function(t,e){e<l.length&&(a[t]=l[e])}))}else{var h=H(n.buffer)?i.getBuffer(i.create(n.buffer,34962,!1,!0)):i.getBuffer(n.buffer),u=0|n.offset,c=0|n.stride,f=0|n.size,d=!!n.normalized,p=0;"type"in n&&(p=ot[n.type]),n=0|n.divisor,a.buffer=h,a.state=1,a.size=f,a.normalized=d,a.type=p||h.dtype,a.offset=u,a.stride=c,a.divisor=n}s[t]=G((function(t,e){var n=t.attribCache;if(o in n)return n[o];var r={isStream:!1};return Object.keys(a).forEach((function(t){r[t]=a[t]})),a.buffer&&(r.buffer=t.link(a.buffer),r.type=r.type||r.buffer+".dtype"),n[o]=r}))})),Object.keys(o).forEach((function(t){var e=o[t];s[t]=W(e,(function(t,n){function r(t){n(l[t],"=",i,".",t,"|0;")}var i=t.invoke(n,e),o=t.shared,s=t.constants,a=o.isBufferArgs,l=(o=o.buffer,{isStream:n.def(!1)}),h=new st;h.state=1,Object.keys(h).forEach((function(t){l[t]=n.def(""+h[t])}));var u=l.buffer,c=l.type;return n("if(",a,"(",i,")){",l.isStream,"=true;",u,"=",o,".createStream(",34962,",",i,");",c,"=",u,".dtype;","}else{",u,"=",o,".getBuffer(",i,");","if(",u,"){",c,"=",u,".dtype;",'}else if("constant" in ',i,"){",l.state,"=",2,";","if(typeof "+i+'.constant === "number"){',l[Pt[0]],"=",i,".constant;",Pt.slice(1).map((function(t){return l[t]})).join("="),"=0;","}else{",Pt.map((function(t,e){return l[t]+"="+i+".constant.length>"+e+"?"+i+".constant["+e+"]:0;"})).join(""),"}}else{","if(",a,"(",i,".buffer)){",u,"=",o,".createStream(",34962,",",i,".buffer);","}else{",u,"=",o,".getBuffer(",i,".buffer);","}",c,'="type" in ',i,"?",s.glTypes,"[",i,".type]:",u,".dtype;",l.normalized,"=!!",i,".normalized;"),r("size"),r("offset"),r("stride"),r("divisor"),n("}}"),n.exit("if(",l.isStream,"){",o,".destroyStream(",u,");","}"),l}))})),s}function E(t){var e=t.static,n=t.dynamic,r={};return Object.keys(e).forEach((function(t){var n=e[t];r[t]=G((function(t,e){return"number"==typeof n||"boolean"==typeof n?""+n:t.link(n)}))})),Object.keys(n).forEach((function(t){var e=n[t];r[t]=W(e,(function(t,n){return t.invoke(n,e)}))})),r}function O(t,e,r,i,o){function s(t){var e=l[t];e&&(c[t]=e)}var a=T(t,e),l=b(t,d=_(t)),u=C(t),c=S(t),f=M(t,o,a);s("viewport"),s(m("scissor.box"));var d,p=0<Object.keys(c).length;if((d={framebuffer:d,draw:u,shader:f,state:c,dirty:p,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}}).profile=x(t),d.uniforms=I(r),d.drawVAO=d.scopeVAO=u.vao,!d.drawVAO&&f.program&&!a&&n.angle_instanced_arrays&&u.static.elements){var g=!0;if(t=f.program.attributes.map((function(t){return t=e.static[t],g=g&&!!t,t})),g&&0<t.length){var A=h.getVAO(h.createVAO({attributes:t,elements:u.static.elements}));d.drawVAO=new U(null,null,null,(function(t,e){return t.link(A)})),d.useVAO=!0}}return a?d.useVAO=!0:d.attributes=P(e),d.context=E(i),d}function R(t,e,n){var r=t.shared.context,i=t.scope();Object.keys(n).forEach((function(o){e.save(r,"."+o);var s=n[o].append(t,e);Array.isArray(s)?i(r,".",o,"=[",s.join(),"];"):i(r,".",o,"=",s,";")})),e(i)}function k(t,e,n,r){var i,o=(a=t.shared).gl,s=a.framebuffer;ht&&(i=e.def(a.extensions,".webgl_draw_buffers"));var a=(l=t.constants).drawBuffer,l=l.backBuffer;t=n?n.append(t,e):e.def(s,".next"),r||e("if(",t,"!==",s,".cur){"),e("if(",t,"){",o,".bindFramebuffer(",36160,",",t,".framebuffer);"),ht&&e(i,".drawBuffersWEBGL(",a,"[",t,".colorAttachments.length]);"),e("}else{",o,".bindFramebuffer(",36160,",null);"),ht&&e(i,".drawBuffersWEBGL(",l,");"),e("}",s,".cur=",t,";"),r||e("}")}function L(t,e,n){var r=t.shared,i=r.gl,o=t.current,s=t.next,a=r.current,l=r.next,h=t.cond(a,".dirty");pt.forEach((function(e){var r,u;if(!((e=m(e))in n.state))if(e in s){r=s[e],u=o[e];var f=c(ft[e].length,(function(t){return h.def(r,"[",t,"]")}));h(t.cond(f.map((function(t,e){return t+"!=="+u+"["+e+"]"})).join("||")).then(i,".",mt[e],"(",f,");",f.map((function(t,e){return u+"["+e+"]="+t})).join(";"),";"))}else r=h.def(l,".",e),f=t.cond(r,"!==",a,".",e),h(f),e in gt?f(t.cond(r).then(i,".enable(",gt[e],");").else(i,".disable(",gt[e],");"),a,".",e,"=",r,";"):f(i,".",mt[e],"(",r,");",a,".",e,"=",r,";")})),0===Object.keys(n.state).length&&h(a,".dirty=false;"),e(h)}function D(t,e,n,r){var i=t.shared,o=t.current,s=i.current,a=i.gl;j(Object.keys(n)).forEach((function(i){var l=n[i];if(!r||r(l)){var h=l.append(t,e);if(gt[i]){var u=gt[i];V(l)?e(a,h?".enable(":".disable(",u,");"):e(t.cond(h).then(a,".enable(",u,");").else(a,".disable(",u,");")),e(s,".",i,"=",h,";")}else if(w(h)){var c=o[i];e(a,".",mt[i],"(",h,");",h.map((function(t,e){return c+"["+e+"]="+t})).join(";"),";")}else e(a,".",mt[i],"(",h,");",s,".",i,"=",h,";")}}))}function N(t,e){lt&&(t.instancing=e.def(t.shared.extensions,".angle_instanced_arrays"))}function F(t,e,n,r,i){function o(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function s(t){t(h=e.def(),"=",o(),";"),"string"==typeof i?t(f,".count+=",i,";"):t(f,".count++;"),p&&(r?t(u=e.def(),"=",g,".getNumPendingQueries();"):t(g,".beginQuery(",f,");"))}function a(t){t(f,".cpuTime+=",o(),"-",h,";"),p&&(r?t(g,".pushScopeStats(",u,",",g,".getNumPendingQueries(),",f,");"):t(g,".endQuery();"))}function l(t){var n=e.def(d,".profile");e(d,".profile=",t,";"),e.exit(d,".profile=",n,";")}var h,u,c=t.shared,f=t.stats,d=c.current,g=c.timer;if(n=n.profile){if(V(n))return void(n.enable?(s(e),a(e.exit),l("true")):l("false"));l(n=n.append(t,e))}else n=e.def(d,".profile");s(c=t.block()),e("if(",n,"){",c,"}"),a(t=t.block()),e.exit("if(",n,"){",t,"}")}function z(t,e,n,r,i){function o(t){switch(t){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function s(n,r,i){function o(){e(l,".enableVertexAttribArray(",h,");");var n,o=i.type;n=i.size?e.def(i.size,"||",r):r,e(l,".bindBuffer(",34962,",",c,".buffer);",l,".vertexAttribPointer(",[h,n,o,i.normalized,i.stride,i.offset],");",u,".type=",o,";",u,".size=",n,";",d.map((function(t){return u+"."+t+"="+i[t]+";"})).join("")),lt&&(o=i.divisor,e("if(",u,".divisor!==",o,"){",t.instancing,".vertexAttribDivisorANGLE(",[h,o],");",u,".divisor=",o,";}"))}function s(){e("if(",u,".buffer){",l,".disableVertexAttribArray(",h,");",u,".buffer=null;","}if(",Pt.map((function(t,e){return u+"."+t+"!=="+f[e]})).join("||"),"){",l,".vertexAttrib4f(",h,",",f,");",Pt.map((function(t,e){return u+"."+t+"="+f[e]+";"})).join(""),"}")}var l=a.gl,h=e.def(n,".location"),u=e.def(a.attributes,"[",h,"]");n=i.state;var c=i.buffer,f=[i.x,i.y,i.z,i.w],d=["buffer","normalized","offset","stride"];1===n?o():2===n?s():(e("if(",n,"===",1,"){"),o(),e("}else{"),s(),e("}"))}var a=t.shared;r.forEach((function(r){var a,l=r.name,h=n.attributes[l];if(h){if(!i(h))return;a=h.append(t,e)}else{if(!i(Dt))return;var u=t.scopeAttrib(l);a={},Object.keys(new st).forEach((function(t){a[t]=e.def(u,".",t)}))}s(t.link(r),o(r.info.type),a)}))}function q(t,n,r,i,o,s){for(var a,l=t.shared,h=l.gl,u={},f=0;f<i.length;++f){var d=(v=i[f]).name,p=v.info.type,g=v.info.size,m=r.uniforms[d];if(1<g){if(!m)continue;var A=d.replace("[0]","");if(u[A])continue;u[A]=1}var y,v=t.link(v)+".location";if(m){if(!o(m))continue;if(V(m)){if(d=m.value,35678===p||35680===p)n(h,".uniform1i(",v,",",(p=t.link(d._texture||d.color[0]._texture))+".bind());"),n.exit(p,".unbind();");else if(35674===p||35675===p||35676===p)g=t.global.def("new Float32Array(["+Array.prototype.slice.call(d)+"])"),d=2,35675===p?d=3:35676===p&&(d=4),n(h,".uniformMatrix",d,"fv(",v,",false,",g,");");else{switch(p){case 5126:a="1f";break;case 35664:a="2f";break;case 35665:a="3f";break;case 35666:a="4f";break;case 35670:case 5124:a="1i";break;case 35671:case 35667:a="2i";break;case 35672:case 35668:a="3i";break;case 35673:case 35669:a="4i"}1<g?(a+="v",d=t.global.def("["+Array.prototype.slice.call(d)+"]")):d=w(d)?Array.prototype.slice.call(d):d,n(h,".uniform",a,"(",v,",",d,");")}continue}y=m.append(t,n)}else{if(!o(Dt))continue;y=n.def(l.uniforms,"[",e.id(d),"]")}switch(35678===p?n("if(",y,"&&",y,'._reglType==="framebuffer"){',y,"=",y,".color[0];","}"):35680===p&&n("if(",y,"&&",y,'._reglType==="framebufferCube"){',y,"=",y,".color[0];","}"),d=1,p){case 35678:case 35680:p=n.def(y,"._texture"),n(h,".uniform1i(",v,",",p,".bind());"),n.exit(p,".unbind();");continue;case 5124:case 35670:a="1i";break;case 35667:case 35671:a="2i",d=2;break;case 35668:case 35672:a="3i",d=3;break;case 35669:case 35673:a="4i",d=4;break;case 5126:a="1f";break;case 35664:a="2f",d=2;break;case 35665:a="3f",d=3;break;case 35666:a="4f",d=4;break;case 35674:a="Matrix2fv";break;case 35675:a="Matrix3fv";break;case 35676:a="Matrix4fv"}if(-1===a.indexOf("Matrix")&&1<g&&(a+="v",d=1),"M"===a.charAt(0)){n(h,".uniform",a,"(",v,","),v=Math.pow(p-35674+2,2);var x=t.global.def("new Float32Array(",v,")");Array.isArray(y)?n("false,(",c(v,(function(t){return x+"["+t+"]="+y[t]})),",",x,")"):n("false,(Array.isArray(",y,")||",y," instanceof Float32Array)?",y,":(",c(v,(function(t){return x+"["+t+"]="+y+"["+t+"]"})),",",x,")"),n(");")}else{if(1<d){p=[];var _=[];for(g=0;g<d;++g)Array.isArray(y)?_.push(y[g]):_.push(n.def(y+"["+g+"]")),s&&p.push(n.def());s&&n("if(!",t.batchId,"||",p.map((function(t,e){return t+"!=="+_[e]})).join("||"),"){",p.map((function(t,e){return t+"="+_[e]+";"})).join("")),n(h,".uniform",a,"(",v,",",_.join(","),");")}else s&&(p=n.def(),n("if(!",t.batchId,"||",p,"!==",y,"){",p,"=",y,";")),n(h,".uniform",a,"(",v,",",y,");");s&&n("}")}}}function X(t,e,n,r){function i(i){var o=p[i];return o?o.contextDep&&r.contextDynamic||o.propDep?o.append(t,n):o.append(t,e):e.def(d,".",i)}function o(){function t(){n(u,".drawElementsInstancedANGLE(",[m,y,v,A+"<<(("+v+"-5121)>>1)",h],");")}function e(){n(u,".drawArraysInstancedANGLE(",[m,A,y,h],");")}g&&"null"!==g?x?t():(n("if(",g,"){"),t(),n("}else{"),e(),n("}")):e()}function s(){function t(){n(f+".drawElements("+[m,y,v,A+"<<(("+v+"-5121)>>1)"]+");")}function e(){n(f+".drawArrays("+[m,A,y]+");")}g&&"null"!==g?x?t():(n("if(",g,"){"),t(),n("}else{"),e(),n("}")):e()}var a,l,h,u,c=t.shared,f=c.gl,d=c.draw,p=r.draw,g=(a=p.elements,l=e,a?((a.contextDep&&r.contextDynamic||a.propDep)&&(l=n),a=a.append(t,l),p.elementsActive&&l("if("+a+")"+f+".bindBuffer(34963,"+a+".buffer.buffer);")):(a=l.def(),l(a,"=",d,".","elements",";","if(",a,"){",f,".bindBuffer(",34963,",",a,".buffer.buffer);}","else if(",c.vao,".currentVAO){",a,"=",t.shared.elements+".getElements("+c.vao,".currentVAO.elements);",ct?"":"if("+a+")"+f+".bindBuffer(34963,"+a+".buffer.buffer);","}")),a),m=i("primitive"),A=i("offset"),y=function(){var i=p.count,o=e;return i?((i.contextDep&&r.contextDynamic||i.propDep)&&(o=n),i=i.append(t,o)):i=o.def(d,".","count"),i}();if("number"==typeof y){if(0===y)return}else n("if(",y,"){"),n.exit("}");lt&&(h=i("instances"),u=t.instancing);var v=g+".type",x=p.elements&&V(p.elements)&&!p.vaoActive;lt&&("number"!=typeof h||0<=h)?"string"==typeof h?(n("if(",h,">0){"),o(),n("}else if(",h,"<0){"),s(),n("}")):o():s()}function Y(t,e,n,r,i){return i=(e=v()).proc("body",i),lt&&(e.instancing=i.def(e.shared.extensions,".angle_instanced_arrays")),t(e,i,n,r),e.compile().body}function Q(t,e,n,r){N(t,e),n.useVAO?n.drawVAO?e(t.shared.vao,".setVAO(",n.drawVAO.append(t,e),");"):e(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(e(t.shared.vao,".setVAO(null);"),z(t,e,n,r.attributes,(function(){return!0}))),q(t,e,n,r.uniforms,(function(){return!0}),!1),X(t,e,e,n)}function K(t,e){var n=t.proc("draw",1);N(t,n),R(t,n,e.context),k(t,n,e.framebuffer),L(t,n,e),D(t,n,e.state),F(t,n,e,!1,!0);var r=e.shader.progVar.append(t,n);if(n(t.shared.gl,".useProgram(",r,".program);"),e.shader.program)Q(t,n,e,e.shader.program);else{n(t.shared.vao,".setVAO(null);");var i=t.global.def("{}"),o=n.def(r,".id"),s=n.def(i,"[",o,"]");n(t.cond(s).then(s,".call(this,a0);").else(s,"=",i,"[",o,"]=",t.link((function(n){return Y(Q,t,e,n,1)})),"(",r,");",s,".call(this,a0);"))}0<Object.keys(e.state).length&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}function $(t,e,n,r){function i(){return!0}t.batchId="a1",N(t,e),z(t,e,n,r.attributes,i),q(t,e,n,r.uniforms,i,!1),X(t,e,e,n)}function tt(t,e,n,r){function i(t){return t.contextDep&&s||t.propDep}function o(t){return!i(t)}N(t,e);var s=n.contextDep,a=e.def(),l=e.def();t.shared.props=l,t.batchId=a;var h=t.scope(),u=t.scope();e(h.entry,"for(",a,"=0;",a,"<","a1",";++",a,"){",l,"=","a0","[",a,"];",u,"}",h.exit),n.needsContext&&R(t,u,n.context),n.needsFramebuffer&&k(t,u,n.framebuffer),D(t,u,n.state,i),n.profile&&i(n.profile)&&F(t,u,n,!1,!0),r?(n.useVAO?n.drawVAO?i(n.drawVAO)?u(t.shared.vao,".setVAO(",n.drawVAO.append(t,u),");"):h(t.shared.vao,".setVAO(",n.drawVAO.append(t,h),");"):h(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(h(t.shared.vao,".setVAO(null);"),z(t,h,n,r.attributes,o),z(t,u,n,r.attributes,i)),q(t,h,n,r.uniforms,o,!1),q(t,u,n,r.uniforms,i,!0),X(t,h,u,n)):(e=t.global.def("{}"),r=n.shader.progVar.append(t,u),l=u.def(r,".id"),h=u.def(e,"[",l,"]"),u(t.shared.gl,".useProgram(",r,".program);","if(!",h,"){",h,"=",e,"[",l,"]=",t.link((function(e){return Y($,t,n,e,2)})),"(",r,");}",h,".call(this,a0[",a,"],",a,");"))}function et(t,e){function n(t){return t.contextDep&&i||t.propDep}var r=t.proc("batch",2);t.batchId="0",N(t,r);var i=!1,o=!0;Object.keys(e.context).forEach((function(t){i=i||e.context[t].propDep})),i||(R(t,r,e.context),o=!1);var s=!1;if((a=e.framebuffer)?(a.propDep?i=s=!0:a.contextDep&&i&&(s=!0),s||k(t,r,a)):k(t,r,null),e.state.viewport&&e.state.viewport.propDep&&(i=!0),L(t,r,e),D(t,r,e.state,(function(t){return!n(t)})),e.profile&&n(e.profile)||F(t,r,e,!1,"a1"),e.contextDep=i,e.needsContext=o,e.needsFramebuffer=s,(o=e.shader.progVar).contextDep&&i||o.propDep)tt(t,r,e,null);else if(o=o.append(t,r),r(t.shared.gl,".useProgram(",o,".program);"),e.shader.program)tt(t,r,e,e.shader.program);else{r(t.shared.vao,".setVAO(null);");var a=t.global.def("{}"),l=(s=r.def(o,".id"),r.def(a,"[",s,"]"));r(t.cond(l).then(l,".call(this,a0,a1);").else(l,"=",a,"[",s,"]=",t.link((function(n){return Y(tt,t,e,n,2)})),"(",o,");",l,".call(this,a0,a1);"))}0<Object.keys(e.state).length&&r(t.shared.current,".dirty=true;"),t.shared.vao&&r(t.shared.vao,".setVAO(null);")}function nt(t,n){function r(e){var r=n.shader[e];r&&i.set(o.shader,"."+e,r.append(t,i))}var i=t.proc("scope",3);t.batchId="a2";var o=t.shared,s=o.current;R(t,i,n.context),n.framebuffer&&n.framebuffer.append(t,i),j(Object.keys(n.state)).forEach((function(e){var r=n.state[e].append(t,i);w(r)?r.forEach((function(n,r){i.set(t.next[e],"["+r+"]",n)})):i.set(o.next,"."+e,r)})),F(t,i,n,!0,!0),["elements","offset","count","instances","primitive"].forEach((function(e){var r=n.draw[e];r&&i.set(o.draw,"."+e,""+r.append(t,i))})),Object.keys(n.uniforms).forEach((function(r){var s=n.uniforms[r].append(t,i);Array.isArray(s)&&(s="["+s.join()+"]"),i.set(o.uniforms,"["+e.id(r)+"]",s)})),Object.keys(n.attributes).forEach((function(e){var r=n.attributes[e].append(t,i),o=t.scopeAttrib(e);Object.keys(new st).forEach((function(t){i.set(o,"."+t,r[t])}))})),n.scopeVAO&&i.set(o.vao,".targetVAO",n.scopeVAO.append(t,i)),r("vert"),r("frag"),0<Object.keys(n.state).length&&(i(s,".dirty=true;"),i.exit(s,".dirty=true;")),i("a1(",t.shared.context,",a0,",t.batchId,");")}function rt(t){if("object"==typeof t&&!w(t)){for(var e=Object.keys(t),n=0;n<e.length;++n)if(J.isDynamic(t[e[n]]))return!0;return!1}}function it(t,e,n){function r(t,e){s.forEach((function(n){var r=i[n];J.isDynamic(r)&&(r=t.invoke(e,r),e(u,".",n,"=",r,";"))}))}var i=e.static[n];if(i&&rt(i)){var o=t.global,s=Object.keys(i),a=!1,l=!1,h=!1,u=t.global.def("{}");s.forEach((function(e){var n=i[e];if(J.isDynamic(n))"function"==typeof n&&(n=i[e]=J.unbox(n)),e=W(n,null),a=a||e.thisDep,h=h||e.propDep,l=l||e.contextDep;else{switch(o(u,".",e,"="),typeof n){case"number":o(n);break;case"string":o('"',n,'"');break;case"object":Array.isArray(n)&&o("[",n.join(),"]");break;default:o(t.link(n))}o(";")}})),e.dynamic[n]=new J.DynamicVariable(4,{thisDep:a,contextDep:l,propDep:h,ref:u,append:r}),delete e.static[n]}}var st=h.Record,at={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(at.min=32775,at.max=32776);var lt=n.angle_instanced_arrays,ht=n.webgl_draw_buffers,ct=n.oes_vertex_array_object,ft={dirty:!0,profile:g.profile},dt={},pt=[],gt={},mt={};A("dither",3024),A("blend.enable",3042),y("blend.color","blendColor",[0,0,0,0]),y("blend.equation","blendEquationSeparate",[32774,32774]),y("blend.func","blendFuncSeparate",[1,0,1,0]),A("depth.enable",2929,!0),y("depth.func","depthFunc",513),y("depth.range","depthRange",[0,1]),y("depth.mask","depthMask",!0),y("colorMask","colorMask",[!0,!0,!0,!0]),A("cull.enable",2884),y("cull.face","cullFace",1029),y("frontFace","frontFace",2305),y("lineWidth","lineWidth",1),A("polygonOffset.enable",32823),y("polygonOffset.offset","polygonOffset",[0,0]),A("sample.alpha",32926),A("sample.enable",32928),y("sample.coverage","sampleCoverage",[1,!1]),A("stencil.enable",2960),y("stencil.mask","stencilMask",-1),y("stencil.func","stencilFunc",[519,0,-1]),y("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),y("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),A("scissor.enable",3089),y("scissor.box","scissor",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]),y("viewport","viewport",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]);var At={gl:t,context:d,strings:e,next:dt,current:ft,draw:f,elements:o,buffer:i,shader:u,attributes:h.state,vao:h,uniforms:l,framebuffer:a,extensions:n,timer:p,isBufferArgs:H},yt={primTypes:ut,compareFuncs:Rt,blendFuncs:Ot,blendEquations:at,stencilOps:kt,glTypes:ot,orientationType:Lt};ht&&(yt.backBuffer=[1029],yt.drawBuffer=c(r.maxDrawbuffers,(function(t){return 0===t?[0]:c(t,(function(t){return 36064+t}))})));var vt=0;return{next:dt,current:ft,procs:function(){var t=v(),e=t.proc("poll"),i=t.proc("refresh"),o=t.block();e(o),i(o);var s,a=t.shared,l=a.gl,h=a.next,u=a.current;o(u,".dirty=false;"),k(t,e),k(t,i,null,!0),lt&&(s=t.link(lt)),n.oes_vertex_array_object&&i(t.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var f=0;f<r.maxAttributes;++f){var d=i.def(a.attributes,"[",f,"]"),p=t.cond(d,".buffer");p.then(l,".enableVertexAttribArray(",f,");",l,".bindBuffer(",34962,",",d,".buffer.buffer);",l,".vertexAttribPointer(",f,",",d,".size,",d,".type,",d,".normalized,",d,".stride,",d,".offset);").else(l,".disableVertexAttribArray(",f,");",l,".vertexAttrib4f(",f,",",d,".x,",d,".y,",d,".z,",d,".w);",d,".buffer=null;"),i(p),lt&&i(s,".vertexAttribDivisorANGLE(",f,",",d,".divisor);")}return i(t.shared.vao,".currentVAO=null;",t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"),Object.keys(gt).forEach((function(n){var r=gt[n],s=o.def(h,".",n),a=t.block();a("if(",s,"){",l,".enable(",r,")}else{",l,".disable(",r,")}",u,".",n,"=",s,";"),i(a),e("if(",s,"!==",u,".",n,"){",a,"}")})),Object.keys(mt).forEach((function(n){var r,s,a=mt[n],f=ft[n],d=t.block();d(l,".",a,"("),w(f)?(a=f.length,r=t.global.def(h,".",n),s=t.global.def(u,".",n),d(c(a,(function(t){return r+"["+t+"]"})),");",c(a,(function(t){return s+"["+t+"]="+r+"["+t+"];"})).join("")),e("if(",c(a,(function(t){return r+"["+t+"]!=="+s+"["+t+"]"})).join("||"),"){",d,"}")):(r=o.def(h,".",n),s=o.def(u,".",n),d(r,");",u,".",n,"=",r,";"),e("if(",r,"!==",s,"){",d,"}")),i(d)})),t.compile()}(),compile:function(t,e,n,r,i){var o=v();o.stats=o.link(i),Object.keys(e.static).forEach((function(t){it(o,e,t)})),Et.forEach((function(e){it(o,t,e)}));var s=O(t,e,n,r,o);return K(o,s),nt(o,s),et(o,s),Z(o.compile(),{destroy:function(){s.shader.program.destroy()}})}}}function X(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n;return-1}var Z=function(t,e){for(var n=Object.keys(e),r=0;r<n.length;++r)t[n[r]]=e[n[r]];return t},Y=0,J={DynamicVariable:t,define:function(e,r){return new t(e,n(r+""))},isDynamic:function(e){return"function"==typeof e&&!e._reglType||e instanceof t},unbox:r,accessor:n},Q={next:"function"==typeof requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,16)},cancel:"function"==typeof cancelAnimationFrame?function(t){return cancelAnimationFrame(t)}:clearTimeout},K="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date},$=d();$.zero=d();var tt=function(t,e){var n=1;e.ext_texture_filter_anisotropic&&(n=t.getParameter(34047));var r=1,i=1;e.webgl_draw_buffers&&(r=t.getParameter(34852),i=t.getParameter(36063));var o=!!e.oes_texture_float;if(o){o=t.createTexture(),t.bindTexture(3553,o),t.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var s=t.createFramebuffer();if(t.bindFramebuffer(36160,s),t.framebufferTexture2D(36160,36064,3553,o,0),t.bindTexture(3553,null),36053!==t.checkFramebufferStatus(36160))o=!1;else{t.viewport(0,0,1,1),t.clearColor(1,0,0,1),t.clear(16384);var a=$.allocType(5126,4);t.readPixels(0,0,1,1,6408,5126,a),t.getError()?o=!1:(t.deleteFramebuffer(s),t.deleteTexture(o),o=1===a[0]),$.freeType(a)}}return a=!0,"undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(a=t.createTexture(),s=$.allocType(5121,36),t.activeTexture(33984),t.bindTexture(34067,a),t.texImage2D(34069,0,6408,3,3,0,6408,5121,s),$.freeType(s),t.bindTexture(34067,null),t.deleteTexture(a),a=!t.getError()),{colorBits:[t.getParameter(3410),t.getParameter(3411),t.getParameter(3412),t.getParameter(3413)],depthBits:t.getParameter(3414),stencilBits:t.getParameter(3415),subpixelBits:t.getParameter(3408),extensions:Object.keys(e).filter((function(t){return!!e[t]})),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:t.getParameter(33901),lineWidthDims:t.getParameter(33902),maxViewportDims:t.getParameter(3386),maxCombinedTextureUnits:t.getParameter(35661),maxCubeMapSize:t.getParameter(34076),maxRenderbufferSize:t.getParameter(34024),maxTextureUnits:t.getParameter(34930),maxTextureSize:t.getParameter(3379),maxAttributes:t.getParameter(34921),maxVertexUniforms:t.getParameter(36347),maxVertexTextureUnits:t.getParameter(35660),maxVaryingVectors:t.getParameter(36348),maxFragmentUniforms:t.getParameter(36349),glsl:t.getParameter(35724),renderer:t.getParameter(7937),vendor:t.getParameter(7936),version:t.getParameter(7938),readFloat:o,npotTextureCube:a}},et=function(t){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array||t instanceof Uint8ClampedArray},nt=function(t){return Object.keys(t).map((function(e){return t[e]}))},rt={shape:function(t){for(var e=[];t.length;t=t[0])e.push(t.length);return e},flatten:function(t,e,n,r){var i=1;if(e.length)for(var o=0;o<e.length;++o)i*=e[o];else i=0;switch(n=r||$.allocType(n,i),e.length){case 0:break;case 1:for(r=e[0],e=0;e<r;++e)n[e]=t[e];break;case 2:for(r=e[0],e=e[1],o=i=0;o<r;++o)for(var s=t[o],a=0;a<e;++a)n[i++]=s[a];break;case 3:g(t,e[0],e[1],e[2],n,0);break;default:m(t,e,0,n,0)}return n}},it={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},ot={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},st={dynamic:35048,stream:35040,static:35044},at=rt.flatten,lt=rt.shape,ht=[];ht[5120]=1,ht[5122]=2,ht[5124]=4,ht[5121]=1,ht[5123]=2,ht[5125]=4,ht[5126]=4;var ut={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},ct=new Float32Array(1),ft=new Uint32Array(ct.buffer),dt=[9984,9986,9985,9987],pt=[0,6409,6410,6407,6408],gt={};gt[6409]=gt[6406]=gt[6402]=1,gt[34041]=gt[6410]=2,gt[6407]=gt[35904]=3,gt[6408]=gt[35906]=4;var mt=T("HTMLCanvasElement"),At=T("OffscreenCanvas"),yt=T("CanvasRenderingContext2D"),vt=T("ImageBitmap"),xt=T("HTMLImageElement"),_t=T("HTMLVideoElement"),bt=Object.keys(it).concat([mt,At,yt,vt,xt,_t]),wt=[];wt[5121]=1,wt[5126]=4,wt[36193]=2,wt[5123]=2,wt[5125]=4;var Tt=[];Tt[32854]=2,Tt[32855]=2,Tt[36194]=2,Tt[34041]=4,Tt[33776]=.5,Tt[33777]=.5,Tt[33778]=1,Tt[33779]=1,Tt[35986]=.5,Tt[35987]=1,Tt[34798]=1,Tt[35840]=.5,Tt[35841]=.25,Tt[35842]=.5,Tt[35843]=.25,Tt[36196]=.5;var Mt=[];Mt[32854]=2,Mt[32855]=2,Mt[36194]=2,Mt[33189]=2,Mt[36168]=1,Mt[34041]=4,Mt[35056]=4,Mt[35907]=4,Mt[34836]=16,Mt[34842]=8,Mt[34843]=6;var Ct=function(t,e,n,r,i){function o(t){this.id=h++,this.refCount=1,this.renderbuffer=t,this.format=32854,this.height=this.width=0,i.profile&&(this.stats={size:0})}function s(e){var n=e.renderbuffer;t.bindRenderbuffer(36161,null),t.deleteRenderbuffer(n),e.renderbuffer=null,e.refCount=0,delete u[e.id],r.renderbufferCount--}var a={rgba4:32854,rgba8:32856,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041,"depth24 stencil8":35056};e.ext_srgb&&(a.srgba=35907),e.ext_color_buffer_half_float&&(a.rgba16f=34842,a.rgb16f=34843),e.webgl_color_buffer_float&&(a.rgba32f=34836);var l=[];Object.keys(a).forEach((function(t){l[a[t]]=t}));var h=0,u={};return o.prototype.decRef=function(){0>=--this.refCount&&s(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var t=0;return Object.keys(u).forEach((function(e){t+=u[e].stats.size})),t}),{create:function(e,n){function s(e,n){var r=0,o=0,u=32854,c=0;if("object"==typeof e&&e?("shape"in e?(r=0|(o=e.shape)[0],o=0|o[1]):("radius"in e&&(r=o=0|e.radius),"width"in e&&(r=0|e.width),"height"in e&&(o=0|e.height)),"format"in e&&(u=a[e.format]),"samples"in e&&(c=e.samples)):"number"==typeof e?(r=0|e,o="number"==typeof n?0|n:r):e||(r=o=1),r!==h.width||o!==h.height||u!==h.format)return s.width=h.width=r,s.height=h.height=o,s.samples=c,h.format=u,h.samples=c,t.bindRenderbuffer(36161,h.renderbuffer),c&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,c,u,r,o):t.renderbufferStorage(36161,u,r,o),i.profile&&(h.stats.size=Mt[h.format]*h.width*h.height),s.format=l[h.format],s}var h=new o(t.createRenderbuffer());return u[h.id]=h,r.renderbufferCount++,s(e,n),s.resize=function(e,n){var r=0|e,o=0|n||r;if(r===h.width&&o===h.height)return s;s.width=h.width=r,s.height=h.height=o;var a=s.samples;return t.bindRenderbuffer(36161,h.renderbuffer),a&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,a,h.format,r,o):t.renderbufferStorage(36161,h.format,r,o),i.profile&&(h.stats.size=Mt[h.format]*h.width*h.height),s},s._reglType="renderbuffer",s._renderbuffer=h,i.profile&&(s.stats=h.stats),s.destroy=function(){h.decRef()},s},clear:function(){nt(u).forEach(s)},restore:function(){nt(u).forEach((function(e){e.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,e.renderbuffer),e.samples&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,e.samples,e.format,e.width,e.height):t.renderbufferStorage(36161,e.format,e.width,e.height)})),t.bindRenderbuffer(36161,null)}}},St=[];St[6408]=4,St[6407]=3;var It=[];It[5121]=1,It[5126]=4,It[36193]=2;var Pt=["x","y","z","w"],Et="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),Ot={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Rt={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},kt={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Lt={cw:2304,ccw:2305},Dt=new U(!1,!1,!1,(function(){})),Nt=function(t,e){function n(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function r(t,e,r){var i=s.pop()||new n;i.startQueryIndex=t,i.endQueryIndex=e,i.sum=0,i.stats=r,a.push(i)}if(!e.ext_disjoint_timer_query)return null;var i=[],o=[],s=[],a=[],l=[],h=[];return{beginQuery:function(t){var n=i.pop()||e.ext_disjoint_timer_query.createQueryEXT();e.ext_disjoint_timer_query.beginQueryEXT(35007,n),o.push(n),r(o.length-1,o.length,t)},endQuery:function(){e.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:r,update:function(){var t,n;if(0!==(t=o.length)){h.length=Math.max(h.length,t+1),l.length=Math.max(l.length,t+1),l[0]=0;var r=h[0]=0;for(n=t=0;n<o.length;++n){var u=o[n];e.ext_disjoint_timer_query.getQueryObjectEXT(u,34919)?(r+=e.ext_disjoint_timer_query.getQueryObjectEXT(u,34918),i.push(u)):o[t++]=u,l[n+1]=r,h[n+1]=t}for(o.length=t,n=t=0;n<a.length;++n){var c=(r=a[n]).startQueryIndex;u=r.endQueryIndex,r.sum+=l[u]-l[c],c=h[c],(u=h[u])===c?(r.stats.gpuTime+=r.sum/1e6,s.push(r)):(r.startQueryIndex=c,r.endQueryIndex=u,a[t++]=r)}a.length=t}},getNumPendingQueries:function(){return o.length},clear:function(){i.push.apply(i,o);for(var t=0;t<i.length;t++)e.ext_disjoint_timer_query.deleteQueryEXT(i[t]);o.length=0,i.length=0},restore:function(){o.length=0,i.length=0}}};return function(t){function e(){if(0===W.length)T&&T.update(),nt=null;else{nt=Q.next(e),d();for(var t=W.length-1;0<=t;--t){var n=W[t];n&&n(I,null,0)}m.flush(),T&&T.update()}}function n(){!nt&&0<W.length&&(nt=Q.next(e))}function r(){nt&&(Q.cancel(e),nt=null)}function o(t){t.preventDefault(),r(),Y.forEach((function(t){t()}))}function s(t){m.getError(),y.restore(),z.restore(),E.restore(),B.restore(),H.restore(),j.restore(),F.restore(),T&&T.restore(),U.procs.refresh(),n(),$.forEach((function(t){t()}))}function a(t){function e(t,e){var n={},r={};return Object.keys(t).forEach((function(i){var o=t[i];if(J.isDynamic(o))r[i]=J.unbox(o,i);else{if(e&&Array.isArray(o))for(var s=0;s<o.length;++s)if(J.isDynamic(o[s]))return void(r[i]=J.unbox(o,i));n[i]=o}})),{dynamic:r,static:n}}function n(t){for(;c.length<t;)c.push(null);return c}var r=e(t.context||{},!0),i=e(t.uniforms||{},!0),o=e(t.attributes||{},!1);t=e(function(t){function e(t){if(t in n){var e=n[t];delete n[t],Object.keys(e).forEach((function(r){n[t+"."+r]=e[r]}))}}var n=Z({},t);return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),e("blend"),e("depth"),e("cull"),e("stencil"),e("polygonOffset"),e("scissor"),e("sample"),"vao"in t&&(n.vao=t.vao),n}(t),!1);var s={gpuTime:0,cpuTime:0,count:0},a=U.compile(t,o,i,r,s),l=a.draw,h=a.batch,u=a.scope,c=[];return Z((function(t,e){var r;if("function"==typeof t)return u.call(this,null,t,0);if("function"==typeof e)if("number"==typeof t)for(r=0;r<t;++r)u.call(this,null,e,r);else{if(!Array.isArray(t))return u.call(this,t,e,0);for(r=0;r<t.length;++r)u.call(this,t[r],e,r)}else if("number"==typeof t){if(0<t)return h.call(this,n(0|t),0|t)}else{if(!Array.isArray(t))return l.call(this,t);if(t.length)return h.call(this,t,t.length)}}),{stats:s,destroy:function(){a.destroy()}})}function l(t,e){var n=0;U.procs.poll();var r=e.color;r&&(m.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),n|=16384),"depth"in e&&(m.clearDepth(+e.depth),n|=256),"stencil"in e&&(m.clearStencil(0|e.stencil),n|=1024),m.clear(n)}function c(t){return W.push(t),n(),{cancel:function(){function e(){var t=X(W,e);W[t]=W[W.length-1],--W.length,0>=W.length&&r()}var n=X(W,t);W[n]=e}}}function f(){var t=V.viewport,e=V.scissor_box;t[0]=t[1]=e[0]=e[1]=0,I.viewportWidth=I.framebufferWidth=I.drawingBufferWidth=t[2]=e[2]=m.drawingBufferWidth,I.viewportHeight=I.framebufferHeight=I.drawingBufferHeight=t[3]=e[3]=m.drawingBufferHeight}function d(){I.tick+=1,I.time=g(),f(),U.procs.poll()}function p(){B.refresh(),f(),U.procs.refresh(),T&&T.update()}function g(){return(K()-M)/1e3}if(!(t=h(t)))return null;var m=t.gl,A=m.getContextAttributes();m.isContextLost();var y=u(m,t);if(!y)return null;var v=i(),b={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},w=y.extensions,T=Nt(m,w),M=K(),C=m.drawingBufferWidth,S=m.drawingBufferHeight,I={tick:0,time:0,viewportWidth:C,viewportHeight:S,framebufferWidth:C,framebufferHeight:S,drawingBufferWidth:C,drawingBufferHeight:S,pixelRatio:t.pixelRatio},P=(C={elements:null,primitive:4,count:-1,offset:0,instances:-1},tt(m,w)),E=x(m,b,t,(function(t){return F.destroyBuffer(t)})),k=_(m,w,E,b),F=L(m,w,P,b,E,k,C),z=D(m,v,b,t),B=O(m,w,P,(function(){U.procs.poll()}),I,b,t),H=Ct(m,w,P,b,t),j=R(m,w,P,B,H,b),U=q(m,v,w,P,E,k,B,j,{},F,z,C,I,T,t),V=(v=N(m,j,U.procs.poll,I),U.next),G=m.canvas,W=[],Y=[],$=[],et=[t.onDestroy],nt=null;G&&(G.addEventListener("webglcontextlost",o,!1),G.addEventListener("webglcontextrestored",s,!1));var rt=j.setFBO=a({framebuffer:J.define.call(null,1,"framebuffer")});return p(),A=Z(a,{clear:function(t){if("framebuffer"in t)if(t.framebuffer&&"framebufferCube"===t.framebuffer_reglType)for(var e=0;6>e;++e)rt(Z({framebuffer:t.framebuffer.faces[e]},t),l);else rt(t,l);else l(null,t)},prop:J.define.bind(null,1),context:J.define.bind(null,2),this:J.define.bind(null,3),draw:a({}),buffer:function(t){return E.create(t,34962,!1,!1)},elements:function(t){return k.create(t,!1)},texture:B.create2D,cube:B.createCube,renderbuffer:H.create,framebuffer:j.create,framebufferCube:j.createCube,vao:F.createVAO,attributes:A,frame:c,on:function(t,e){var n;switch(t){case"frame":return c(e);case"lost":n=Y;break;case"restore":n=$;break;case"destroy":n=et}return n.push(e),{cancel:function(){for(var t=0;t<n.length;++t)if(n[t]===e){n[t]=n[n.length-1],n.pop();break}}}},limits:P,hasExtension:function(t){return 0<=P.extensions.indexOf(t.toLowerCase())},read:v,destroy:function(){W.length=0,r(),G&&(G.removeEventListener("webglcontextlost",o),G.removeEventListener("webglcontextrestored",s)),z.clear(),j.clear(),H.clear(),F.clear(),B.clear(),k.clear(),E.clear(),T&&T.clear(),et.forEach((function(t){t()}))},_gl:m,_refresh:p,poll:function(){d(),T&&T.update()},now:g,stats:b,blit:j.blit}),t.onDone(null,A),A}}();var gp=pp.exports;const mp=e(gp);var Ap,yp="undefined"!=typeof Float32Array?Float32Array:Array;function vp(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],g=e[12],m=e[13],A=e[14],y=e[15],v=n[0],x=n[1],_=n[2],b=n[3];return t[0]=v*r+x*a+_*c+b*g,t[1]=v*i+x*l+_*f+b*m,t[2]=v*o+x*h+_*d+b*A,t[3]=v*s+x*u+_*p+b*y,v=n[4],x=n[5],_=n[6],b=n[7],t[4]=v*r+x*a+_*c+b*g,t[5]=v*i+x*l+_*f+b*m,t[6]=v*o+x*h+_*d+b*A,t[7]=v*s+x*u+_*p+b*y,v=n[8],x=n[9],_=n[10],b=n[11],t[8]=v*r+x*a+_*c+b*g,t[9]=v*i+x*l+_*f+b*m,t[10]=v*o+x*h+_*d+b*A,t[11]=v*s+x*u+_*p+b*y,v=n[12],x=n[13],_=n[14],b=n[15],t[12]=v*r+x*a+_*c+b*g,t[13]=v*i+x*l+_*f+b*m,t[14]=v*o+x*h+_*d+b*A,t[15]=v*s+x*u+_*p+b*y,t}function xp(){var t=new yp(3);return yp!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function _p(t,e,n){var r=new yp(3);return r[0]=t,r[1]=e,r[2]=n,r}function bp(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function wp(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function Tp(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Mp(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Cp(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function Sp(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*s,t[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*s,t[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*s,t[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*s,t}function Ip(){var t=new yp(4);return yp!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),xp(),Ap=new yp(4),yp!=Float32Array&&(Ap[0]=0,Ap[1]=0,Ap[2]=0,Ap[3]=0);var Pp,Ep=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};xp(),_p(1,0,0),_p(0,1,0),Ip(),Ip(),Pp=new yp(9),yp!=Float32Array&&(Pp[1]=0,Pp[2]=0,Pp[3]=0,Pp[5]=0,Pp[6]=0,Pp[7]=0),Pp[0]=1,Pp[4]=1,Pp[8]=1;let Op=0;function Rp(t){return null==t}function kp(t){return!Rp(t)}function Lp(t){return!Rp(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Dp(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function Np(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function Fp(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function zp(t){const e=(i=t.substring(t.indexOf(",")+1),"undefined"!=typeof self?self.atob(i):window.atob(i)),n=e.length,r=new Uint8Array(n);var i;for(let o=0;o<n;o++)r[o]=e.charCodeAt(o);return r.buffer}const Bp=[],Hp=[],jp=[],Up=[0,0,0],Vp=((Wp=[])[0]=0,Wp[1]=0,Wp[2]=0,Wp[3]=1,Wp),Gp=[1,1,1];var Wp;function qp(t,e,n,r,i,o,s){const a=Np(s),l=a.BYTES_PER_ELEMENT;if((0===i||i===r*l)&&o%l==0){const i=new a(e,o,n*r);return t.set(i),t}0===i&&(i=r*l);const h=new Uint8Array(r*l);for(let u=0;u<n;u++){let n=null;const s=new Uint8Array(e,i*u+o,r*l);h.set(s),n=new a(h.buffer,0,r);for(let e=0;e<r;e++)t[u*r+e]=n[e]}return t}const Xp="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Zp(t,e,n){const r=new Uint8Array(t,e,n);return Xp.decode(r)}const Yp={get:function(t,e={},n){e||(e={});const r=new AbortController,i=r.signal,o=Dp({},e);o.signal=i,o.method||(o.method="GET"),o.referrerPolicy=o.referrerPolicy||"origin","undefined"==typeof window||o.referrer||(o.referrer=window.location.href),n&&(t=n(t));const s=fetch(t,o).then((t=>{const n=this._parseResponse(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return s.xhr=r,s},_parseResponse:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",Yp.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?Yp.jsonp(t):((e=e||{}).responseType="json",Yp.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+Op++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)}))}};let Jp=class{constructor(t,e,n,r,i){this._requestImage=t,this.decoders=e,this._supportedFormats=n,this.images={},this._imgRequests={},this._fetchOptions=r||{},this._urlModifier=i}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}if(this._imgRequests[t.id])return this._imgRequests[t.id].then((()=>{const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}));if(Fp(t.uri)){const r=this.buffers[t.id]=zp(t.uri),i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}let r;const i=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||i?t.uri:this.rootPath+"/"+t.uri,this._imgRequests[t.id]=Yp.getArrayBuffer(r,this._fetchOptions,this._urlModifier).then((r=>{const i=this.buffers[t.id]=r.data,o=this._createDataView(e,i);return this.getImageByBuffer(o,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this._supportedFormats}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this._getImageInfo(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this._imgRequests[t.id]?this._imgRequests[t.id].then((()=>this.images[t.id])):this._imgRequests[t.id]=this._getImageInfo(t.id,e)}_getImageInfo(t,e){return new Promise(((n,r)=>{let i=e;this._urlModifier&&(i=this._urlModifier(e)),this._requestImage(i,this._fetchOptions,((i,o)=>{i?r(i):(URL.revokeObjectURL(e),this.images[t]=o,n(this.images[t]))}))}))}};const Qp=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],Kp=[];let $p=class{constructor(t,e,n,r,i){this.rootPath=t,this.gltf=e,this._enableInterleave=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this._compareAccessor(),this._fetchOptions=r,this._urlModifier=i}_requestData(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this._toBufferData(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const i=n.bufferViews[r.bufferView];return this._requestBufferOfBufferView(i).then((n=>{const{buffer:i,byteOffset:o}=n;return this.accessors[r.id]=this._toBufferData(t,e,i,o)}))}_requestBufferOfBufferView(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(Fp(e.uri)){const t=this.buffers[e.id]=zp(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=Yp.getArrayBuffer(t,this._fetchOptions,!n&&this._urlModifier).then((r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_toBufferData(t,e,n,r=0){const i=this.gltf,o=i.accessors[e],s=void 0!==o.bufferView?i.bufferViews[o.bufferView]:{},a=(s.byteOffset||0)+r,l=this._getTypeItemSize(o.type),h=Np(o.componentType),u=s.byteStride||0,c={array:void 0,name:t,accessorName:e,byteLength:o.count*l*h.BYTES_PER_ELEMENT,componentType:o.componentType,count:o.count,type:o.type,itemSize:l,max:o.max,min:o.min,extensions:o.extensions};if(o.min&&(c.min=o.min),o.max&&(c.max=o.max),n)if(this._enableInterleave)c.byteStride=u,c.byteOffset=a+(o.byteOffset||0),!u||u===l*h.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(c.array=this._typedArray(n,o.count,l,a+(o.byteOffset||0),h),c.array.buffer.byteLength===c.byteLength&&(c.byteOffset=0)):c.array=new Uint8Array(n,a,s.byteLength);else if(o.interleaved){c.byteStride=0,c.byteOffset=0;const t=new h(o.count*l);if(c.array=qp(t,n,o.count,l,u,a+(o.byteOffset||0),o.componentType),c.extensions&&c.extensions.WEB3D_quantized_attributes&&l>2){const t=new Float32Array(c.array.length),{decodeMatrix:e}=c.extensions.WEB3D_quantized_attributes;for(let n=0;n<c.array.length;n+=l){Kp[0]=c.array[n],Kp[1]=c.array[n+1],Kp[2]=c.array[n+2],Kp[3]=1;const r=Sp(Kp,Kp,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}c.componentType=5126,c.array=t}}else c.byteStride=0,c.array=this._typedArray(n,o.count,l,a+(o.byteOffset||0),h),c.byteOffset=c.array.byteOffset;else{c.array=new h(o.count);const t=c.min||c.max;t&&(c.array[0]=t[0],c.array[1]=t[1],c.array[2]=t[2])}return c}_compareAccessor(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}_typedArray(t,e,n,r,i){return r%i.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*i.BYTES_PER_ELEMENT),r=0),new i(t,r,n*e)}_getTypeItemSize(t){const e=Qp.indexOf(t);return Qp[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this._requestBufferOfBufferView(e).then((r=>{const{buffer:i,byteOffset:o}=r,s=Zp(i,o+(e.byteOffset||0),n);return t.content=s,t}))}if(t.uri){if(Fp(t.uri)){const e=zp(t.uri),n=Zp(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return Yp.get(e,this._fetchOptions,this._urlModifier).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}},tg=class extends Jp{constructor(t,e,n,r,i,o,s,a){super(r,i,o,s,a),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new $p(t,e,n,s,a)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const i in n)t(i,n[i],r++)}createNode(t){const e={};if(kp(t.name)&&(e.name=t.name),kp(t.children)&&(e.children=t.children),kp(t.jointName)&&(e.jointName=t.jointName),kp(t.matrix)&&(e.matrix=t.matrix),kp(t.rotation)&&(e.rotation=t.rotation),kp(t.scale)&&(e.scale=t.scale),kp(t.translation)&&(e.translation=t.translation),kp(t.extras)&&(e.extras=t.extras),kp(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(Bp,e.translation||Up),r=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n+n,a=r+r,l=i+i,h=n*s,u=r*s,c=r*a,f=i*s,d=i*a,p=i*l,g=o*s,m=o*a,A=o*l;return t[0]=1-c-p,t[1]=u+A,t[2]=f-m,t[3]=0,t[4]=u-A,t[5]=1-h-p,t[6]=d+g,t[7]=0,t[8]=f+m,t[9]=d-g,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(Hp,e.rotation||Vp),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(jp,e.scale||Gp);return vp(i,r,i),vp(t,n,i)}return(n=t)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n;var n}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}_loadMaterials(t){const e={};for(const n in t){const r=t[n];let i,o;r.instanceTechnique&&r.instanceTechnique.values?(i=r.instanceTechnique,o=i.values.diffuse):(i=r,o=i.values.tex||i.values.diffuseTex||i.values.diffuse);const s={baseColorTexture:{index:o}};r.name&&(s.name=r.name),r.extensions&&(s.extensions=r.extensions),r.extras&&(s.extras=r.extras),e[n]=s}return e}_loadImage(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,i=n.byteLength,o=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,i);return this.getImageByBuffer(o,t)}return this.requestExternalImage(t)}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then((t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const i=this.gltf.textures[r];if(!i)return null;const o=this.gltf.samplers[i.sampler];return{format:i.format||6408,internalFormat:i.internalFormat||6408,type:i.type||5121,sampler:o,source:this.gltf.images[i.source]}}getMaterial(){return null}getAnimations(){return null}};const eg=9729;let ng=class extends Jp{constructor(t,e,n,r,i,o,s,a){super(r,i,o,s,a),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new $p(t,e,n,s,a)}iterate(t,e){const n=this.gltf[e];if(n)for(let r=0;r<n.length;r++)t(r,n[r],r)}createNode(t){const e={};return Dp(e,t),!kp(t.weights)&&this.gltf.meshes&&kp(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!kp(n))return null;const r=this.gltf.images[n];return this._loadImage(r).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};Dp(n,e);const i=kp(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(i&&(n.sampler=i,n.sampler.magFilter=i.magFilter||eg,n.sampler.minFilter=i.minFilter||9987,n.sampler.wrapS=i.wrapS||10497,n.sampler.wrapT=i.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==eg&&9728!==n.sampler.minFilter){const t=n.sampler.minFilter;n.sampler.minFilter=9984===t||9986===t?9728:eg}return t.format&&(n.format=t.format),n}))}_loadImage(t){if(!kp(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this._requestFromGlbBuffer(e,t)}return null}_requestFromGlbBuffer(t,e){const n=this._createDataView(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}_createDataView(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,i=t.byteLength;return new Uint8Array(e,r,i)}_transformArrayBufferToBase64(t,e){const n=new Array(t.byteLength);for(let i=0;i<t.byteLength;i++)n[i]=String.fromCharCode(t[i]);n.join("");var r;return"data:"+(e=e||"image/png")+";base64,"+(r=unescape(encodeURIComponent(n)),"undefined"!=typeof self?self.btoa(r):window.btoa(r))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(kp(t[n].input)||kp(t[n].output))&&(e.push(this.accessor._requestData("input",t[n].input)),e.push(this.accessor._requestData("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}};const rg="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let ig=class t{static read(e,n=0,r=0){r||(r=e.byteLength);const i=new DataView(e,n,r),o=i.getUint32(4,!0);if(1===o)return t.readV1(i,n);if(2===o)return t.readV2(e,n);throw new Error("Unsupported glb version : "+o)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const i=og(t.buffer,20+e,r);return{json:JSON.parse(i),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,i;const o=new DataView(t,e+12);let s=0;for(;s+8<o.byteLength;){const a=o.getUint32(s,!0);s+=4;const l=o.getUint32(s,!0);if(s+=4,1313821514===l)n=og(t,e+12+s,a);else if(5130562===l){i=e+12+s,r=a;break}s+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:i,buffer:t,byteLength:r}}}};function og(t,e,n){if(rg){const r=new Uint8Array(t,e,n);return rg.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=sg[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}(new Uint8Array(t,e,n))}const sg=[1,1,1,1,2,2,3,0],ag=[0,0,0],lg=[0,0,0,1],hg=[1,1,1],ug={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},cg={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},fg={_getTRSW(t,e,n,r,i,o,s,a){const l=kp(t)?e.animations:[e.animations[0]],h={};for(let u=0;u<l.length;u++){const e=l[u],c=e.name||u;if(kp(t)&&c!==t)continue;const f=e.channelsMap[n];if(f)for(let t=0;t<f.length;t++){const n=f[t];"translation"===n.target.path?(this._getAnimateData(i,e.samplers[n.sampler],r,1),h.translation=bp(ag,i)):"rotation"===n.target.path?(this._getQuaternion(o,e.samplers[n.sampler],r,1),h.rotation=Ep(lg,o)):"scale"===n.target.path?(this._getAnimateData(s,e.samplers[n.sampler],r,1),h.scale=bp(hg,s)):"weights"===n.target.path&&a&&(this._getAnimateData(a,e.samplers[n.sampler],r,a.length),h.weights=a)}}return h},_getAnimateData(t,e,n,r){switch(e.interpolation){case"LINEAR":{const i=this._getPreNext(cg,e,n,1*r);i&&(t=function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t}(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION));break}case"STEP":{const i=this._getPreNext(cg,e,n,1*r);i&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this._getPreNext(cg,e,n,3*r);i&&(t=this._getCubicSpline(t,i,e.input.array,3*r));break}}return t},_getQuaternion(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this._getPreNext(cg,e,n,1);r&&function(t,e,n,r){var i,o,s,a,l,h=e[0],u=e[1],c=e[2],f=e[3],d=n[0],p=n[1],g=n[2],m=n[3];(o=h*d+u*p+c*g+f*m)<0&&(o=-o,d=-d,p=-p,g=-g,m=-m),1-o>1e-6?(i=Math.acos(o),s=Math.sin(i),a=Math.sin((1-r)*i)/s,l=Math.sin(r*i)/s):(a=1-r,l=r),t[0]=a*h+l*d,t[1]=a*u+l*p,t[2]=a*c+l*g,t[3]=a*f+l*m}(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this._getPreNext(cg,e,n,1);r&&(t=Cp(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this._getPreNext(cg,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this._getCubicSpline(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},_search(t,e){const n=t.length;let r,i,o,s=0,a=n-1,l=Math.floor((s+a)/2);for(;s<=n-1&&a>=0;){if(s===a)return null;if(t[l]<=e&&e<=t[l+1]){const n=t[l];return r=l,i=l+1,o=(e-n)/(t[l+1]-n),{preIndx:r,nextIndex:i,interpolation:o}}e<t[l]?(a=l,l=Math.floor((s+a)/2)):t[l+1]<e&&(s=l,l=Math.floor((s+a)/2))}return null},_getPreNext(t,e,n,r){const i=e.input.array,o=e.output.array,s=e.output.itemSize;(n<i[0]||n>i[i.length-1])&&(n=Math.max(i[0],Math.min(i[i.length-1],n))),n===i[i.length-1]&&(n=i[0]);const a=this._search(i,n);if(!a||!a.nextIndex)return null;const{preIndx:l,nextIndex:h,interpolation:u}=a;t.PREINDEX=l,t.NEXTINDEX=h,t.INTERPOLATION=u;const c=s*r;return t.PREVIOUS=o.subarray(t.PREINDEX*c,(t.PREINDEX+1)*c),t.NEXT=o.subarray(t.NEXTINDEX*c,(t.NEXTINDEX+1)*c),t},_getCubicSpline(t,e,n,r){const i=e.INTERPOLATION,o=n[e.PREINDEX],s=n[e.NEXTINDEX];for(let a=0;a<3;a++){const n=e.PREVIOUS[r+a],l=(s-o)*e.PREVIOUS[2*r+a],h=e.NEXT[3+a],u=(s-o)*e.NEXT[a],c=(2*Math.pow(i,3)-3*Math.pow(i,2)+1)*n+(Math.pow(i,3)-2*Math.pow(i,2)+i)*l+(2*-Math.pow(i,3)+3*Math.pow(i,2))*h+(Math.pow(i,3)-Math.pow(i,2))*u;t[a]=c}return t},getAnimationClip(t,e,n,r){const i=t.nodes[e]&&t.nodes[e].weights;return wp(ag,...ug.TRANSLATION),Cp(lg,...ug.ROTATION),wp(hg,...ug.SCALE),this._getTRSW(r,t,e,n,ag,lg,hg,i)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let r=-1/0,i=1/0;const o=e.channels;for(let t=0;t<o.length;t++){const n=o[t],s=e.samplers[n.sampler].input.array;s[s.length-1]>r&&(r=s[s.length-1]),s[0]<i&&(i=s[0])}const s=e.name||n;t.timeSpan[s]={max:r,min:i}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?kp(e)?n[e]:n[Object.keys(n)[0]]:null}};let dg=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(I6){}t&&"undefined"!=typeof createImageBitmap&&(dg=!0)}const pg="undefined"==typeof document?null:document.createElement("canvas");let gg=class{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this._fetchOptions=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=ig.read(e.buffer,e.byteOffset,e.byteLength);this._init(t,n,r)}else this._init(t,e);this._accessor=new $p(this.rootPath,this.gltf,this.glbBuffer,this._fetchOptions,this.options.urlModifier),this._checkExtensions()}_checkExtensions(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}_loadExtensions(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this._accessor.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this._loadScene(t),n=this._loadAnimations(),r=this._loadTextures(),i=this._loadExtensions();return Promise.all([e,n,r,i]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let n=0;n<e.length;n++){const t=e[n];t.channelsMap={};for(let e=0;e<t.channels.length;e++){const n=t.channels[e];t.channelsMap[n.target.node]||(t.channelsMap[n.target.node]=[]),t.channelsMap[n.target.node].push(n)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let r=0;r<e.length;r++)e[r].uri&&e[r].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[r].uri});for(let r=0;r<n.length;r++)n[r].uri&&n[r].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[r].uri})}return t}static getAnimationClip(t,e,n,r){return fg.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return fg.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return Np(t)}static readInterleavedArray(t,e,n,r,i,o,s){return qp(t,e,n,r,i,o,s)}_init(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=dg?bg.bind(this):this.options.requestImage||mg,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new ng(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new tg(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}_parseNodes(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||Lp(t.children[0])))return t;const r=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this._parseNodes(n,e)}));t.children=r}var n;return t}_loadScene(t){return this._loadNodes(t).then((t=>{const e=this.scenes=[];let n;for(const i in t)t[i]=this._parseNodes(t[i],t),t[i].nodeIndex=Number(i)?Number(i):i;this.adapter.iterate(((r,i,o)=>{const s={};i.name&&(s.name=i.name),i.nodes&&(s.nodes=i.nodes.map((e=>t[e]))),this.gltf.scene===r&&(n=o),e.push(s)}),"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter._loadMaterials(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r}))}_loadNodes(t){return this._loadMeshes(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r}),"nodes"),t}))}_loadSkins(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,r)=>{t.push(this._loadSkin(n).then((t=>{t.index=r,this.skins.push(t)})))}),"skins"),t}_loadSkin(t){const e=t.inverseBindMatrices;return this.adapter.accessor._requestData("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}_loadAnimations(){const t=this.gltf.animations;return kp(t)?this.adapter.getAnimations(t):null}_loadMeshes(t){this.meshes={};let e=[];return this.adapter.iterate(((n,r,i)=>{e.push(this._loadMesh(r,t).then((t=>{t.index=i,this.meshes[n]=t})))}),"meshes"),e=e.concat(this._loadSkins()),Promise.all(e)}_loadMesh(t,e){const n=t.primitives.map((t=>this._loadPrimitive(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return Dp(n,t),n.primitives=e,n}))}_loadTextures(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter._getTexture(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image.array;if(n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e}))}_loadPrimitive(t,e){let n;const r=[],i=t.extensions;if(kp(t.targets))for(let o=0;o<t.targets.length;o++){const e=t.targets[o];for(const t in e){const n=this.adapter.accessor._requestData(`morphTargets_${t}_${o}`,e[t]);n&&r.push(n)}}if(i&&i.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:o,attributes:s}=i.KHR_draco_mesh_compression,a=this.gltf.bufferViews[o],l=this._accessor._requestBufferOfBufferView(a).then((n=>{const{buffer:r,byteOffset:i}=n;let{byteOffset:o}=a;const l=a.byteLength;o||(o=0);const h=new DataView(r,i+o,l),u={attributes:s,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(h,u).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));r.push(l),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._requestData(t,e[t]);n&&r.push(n)}if(kp(t.indices)){const e=this.adapter.accessor._requestData("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then((e=>{if(i&&i.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const o={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:i}=e,o=i.length/r;for(let e=0;e<o;e++)for(let o=0;o<r;o++){const s=e*r+o;i[s]<t[o]&&(t[o]=i[s]),i[s]>n[o]&&(n[o]=i[s])}if(e.quantization){const r=e.quantization,i=r.range/(1<<r.quantizationBits),o=r.minValues;Mp(t,t,i),Tp(t,t,o),Mp(n,n,i),Tp(n,n,o)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(o.indices=n),r&&(o.morphTargets=r),o.mode=kp(t.mode)?t.mode:4,kp(t.extras)&&(o.extras=t.extras),o}))}};function mg(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!pg)return void n(new Error("There is no canvas to draw image!"));pg.width=r.width,pg.height=r.height;const t=pg.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),i={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,i)},r.onerror=function(t){n(t)},r.src=t}const Ag=[],yg=[],vg=30;let xg,_g;function bg(t,e,n){xg||(xg=new OffscreenCanvas(2,2),_g=xg.getContext("2d",{willReadFrequently:!0}));let r=null;if(Lp(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),Ag.push([t,e,n,this]),wg();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(Tg.bind(this)).then((t=>{n(null,t)})).catch((t=>{console.warn(t),n(t)}))}}function wg(){if(!Ag.length||yg.length>vg)return;const t=Ag.shift(),[e,n,r,i]=t;yg.push(t),fetch(e,n).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then(Tg.bind(i)).then((e=>{r.call(i,null,e);const n=yg.indexOf(t);yg.splice(n,1),wg()})).catch((e=>{console.warn(e),r.call(i,e);const n=yg.indexOf(t);yg.splice(n,1),wg()}))}function Tg(t){let{width:e,height:n}=t;Mg(e)||(e=Cg(e)),Mg(n)||(n=Cg(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),xg.width=e,xg.height=n,_g.drawImage(t,0,0,e,n),t.close();const i=_g.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(i.data)}}function Mg(t){return!(t&t-1)&&0!==t}function Cg(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}var Sg=1e-6,Ig="undefined"!=typeof Float32Array?Float32Array:Array,Pg=Math.random;var Eg=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});const Og=Object.freeze(Object.defineProperty({__proto__:null,get ARRAY_TYPE(){return Ig},EPSILON:Sg,RANDOM:Pg,equals:function(t,e){return Math.abs(t-e)<=Sg*Math.max(1,Math.abs(t),Math.abs(e))},setMatrixArrayType:function(t){Ig=t},toRadian:function(t){return t*Eg}},Symbol.toStringTag,{value:"Module"}));function Rg(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function kg(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=n[0],l=n[1],h=n[2],u=n[3];return t[0]=r*a+o*l,t[1]=i*a+s*l,t[2]=r*h+o*u,t[3]=i*h+s*u,t}function Lg(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=-n,t[3]=r,t}function Dg(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}var Ng=kg,Fg=Dg;const zg=Object.freeze(Object.defineProperty({__proto__:null,LDU:function(t,e,n,r){return t[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-t[2]*n[1],[t,e,n]},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},adjoint:function(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t},clone:function(t){var e=new Ig(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},create:function(){var t=new Ig(4);return Ig!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=e[0],a=e[1],l=e[2],h=e[3];return Math.abs(n-s)<=Sg*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-a)<=Sg*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=Sg*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(o-h)<=Sg*Math.max(1,Math.abs(o),Math.abs(h))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3])},fromRotation:Lg,fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},fromValues:function(t,e,n,r){var i=new Ig(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},invert:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*o-i*r;return s?(s=1/s,t[0]=o*s,t[1]=-r*s,t[2]=-i*s,t[3]=n*s,t):null},mul:Ng,multiply:kg,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t},rotate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+o*a,t[1]=i*l+s*a,t[2]=r*-a+o*l,t[3]=i*-a+s*l,t},scale:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=n[0],l=n[1];return t[0]=r*a,t[1]=i*a,t[2]=o*l,t[3]=s*l,t},set:Rg,str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},sub:Fg,subtract:Dg,transpose:function(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}},Symbol.toStringTag,{value:"Module"}));function Bg(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=n[0],u=n[1],c=n[2],f=n[3],d=n[4],p=n[5];return t[0]=r*h+o*u,t[1]=i*h+s*u,t[2]=r*c+o*f,t[3]=i*c+s*f,t[4]=r*d+o*p+a,t[5]=i*d+s*p+l,t}function Hg(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}var jg=Bg,Ug=Hg;const Vg=Object.freeze(Object.defineProperty({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t},clone:function(t){var e=new Ig(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},create:function(){var t=new Ig(6);return Ig!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=e[0],h=e[1],u=e[2],c=e[3],f=e[4],d=e[5];return Math.abs(n-l)<=Sg*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(r-h)<=Sg*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(i-u)<=Sg*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(o-c)<=Sg*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(s-f)<=Sg*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(a-d)<=Sg*Math.max(1,Math.abs(a),Math.abs(d))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},fromRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=-n,t[3]=r,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},fromValues:function(t,e,n,r,i,o){var s=new Ig(6);return s[0]=t,s[1]=e,s[2]=n,s[3]=r,s[4]=i,s[5]=o,s},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},invert:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=n*o-r*i;return l?(l=1/l,t[0]=o*l,t[1]=-r*l,t[2]=-i*l,t[3]=n*l,t[4]=(i*a-o*s)*l,t[5]=(r*s-n*a)*l,t):null},mul:jg,multiply:Bg,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t},rotate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=Math.sin(n),u=Math.cos(n);return t[0]=r*u+o*h,t[1]=i*u+s*h,t[2]=r*-h+o*u,t[3]=i*-h+s*u,t[4]=a,t[5]=l,t},scale:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=n[0],u=n[1];return t[0]=r*h,t[1]=i*h,t[2]=o*u,t[3]=s*u,t[4]=a,t[5]=l,t},set:function(t,e,n,r,i,o,s){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},sub:Ug,subtract:Hg,translate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=n[0],u=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=r*h+o*u+a,t[5]=i*h+s*u+l,t}},Symbol.toStringTag,{value:"Module"}));function Gg(){var t=new Ig(9);return Ig!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Wg(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function qg(t,e,n,r,i,o,s,a,l,h){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t[8]=h,t}function Xg(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function Zg(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=u*s-a*h,f=-u*o+a*l,d=h*o-s*l,p=n*c+r*f+i*d;return p?(p=1/p,t[0]=c*p,t[1]=(-u*r+i*h)*p,t[2]=(a*r-i*s)*p,t[3]=f*p,t[4]=(u*n-i*l)*p,t[5]=(-a*n+i*o)*p,t[6]=d*p,t[7]=(-h*n+r*l)*p,t[8]=(s*n-r*o)*p,t):null}function Yg(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=n[0],d=n[1],p=n[2],g=n[3],m=n[4],A=n[5],y=n[6],v=n[7],x=n[8];return t[0]=f*r+d*s+p*h,t[1]=f*i+d*a+p*u,t[2]=f*o+d*l+p*c,t[3]=g*r+m*s+A*h,t[4]=g*i+m*a+A*u,t[5]=g*o+m*l+A*c,t[6]=y*r+v*s+x*h,t[7]=y*i+v*a+x*u,t[8]=y*o+v*l+x*c,t}function Jg(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=-n,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Qg(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n+n,a=r+r,l=i+i,h=n*s,u=r*s,c=r*a,f=i*s,d=i*a,p=i*l,g=o*s,m=o*a,A=o*l;return t[0]=1-c-p,t[3]=u-A,t[6]=f+m,t[1]=u+A,t[4]=1-h-p,t[7]=d-g,t[2]=f-m,t[5]=d+g,t[8]=1-h-c,t}function Kg(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}var $g=Yg,tm=Kg;const em=Object.freeze(Object.defineProperty({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t},adjoint:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8];return t[0]=s*u-a*h,t[1]=i*h-r*u,t[2]=r*a-i*s,t[3]=a*l-o*u,t[4]=n*u-i*l,t[5]=i*o-n*a,t[6]=o*h-s*l,t[7]=r*l-n*h,t[8]=n*s-r*o,t},clone:function(t){var e=new Ig(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},create:Gg,determinant:function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],s=t[5],a=t[6],l=t[7],h=t[8];return e*(h*o-s*l)+n*(-h*i+s*a)+r*(l*i-o*a)},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=t[8],c=e[0],f=e[1],d=e[2],p=e[3],g=e[4],m=e[5],A=e[6],y=e[7],v=e[8];return Math.abs(n-c)<=Sg*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-f)<=Sg*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(i-d)<=Sg*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(o-p)<=Sg*Math.max(1,Math.abs(o),Math.abs(p))&&Math.abs(s-g)<=Sg*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(a-m)<=Sg*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(l-A)<=Sg*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(h-y)<=Sg*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(u-v)<=Sg*Math.max(1,Math.abs(u),Math.abs(v))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromMat4:Wg,fromQuat:Qg,fromRotation:Jg,fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromValues:function(t,e,n,r,i,o,s,a,l){var h=new Ig(9);return h[0]=t,h[1]=e,h[2]=n,h[3]=r,h[4]=i,h[5]=o,h[6]=s,h[7]=a,h[8]=l,h},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},invert:Zg,mul:$g,multiply:Yg,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t},normalFromMat4:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],A=e[15],y=n*a-r*s,v=n*l-i*s,x=n*h-o*s,_=r*l-i*a,b=r*h-o*a,w=i*h-o*l,T=u*g-c*p,M=u*m-f*p,C=u*A-d*p,S=c*m-f*g,I=c*A-d*g,P=f*A-d*m,E=y*P-v*I+x*S+_*C-b*M+w*T;return E?(E=1/E,t[0]=(a*P-l*I+h*S)*E,t[1]=(l*C-s*P-h*M)*E,t[2]=(s*I-a*C+h*T)*E,t[3]=(i*I-r*P-o*S)*E,t[4]=(n*P-i*C+o*M)*E,t[5]=(r*C-n*I-o*T)*E,t[6]=(g*w-m*b+A*_)*E,t[7]=(m*x-p*w-A*v)*E,t[8]=(p*b-g*x+A*y)*E,t):null},projection:function(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},rotate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=Math.sin(n),d=Math.cos(n);return t[0]=d*r+f*s,t[1]=d*i+f*a,t[2]=d*o+f*l,t[3]=d*s-f*r,t[4]=d*a-f*i,t[5]=d*l-f*o,t[6]=h,t[7]=u,t[8]=c,t},scale:function(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},set:qg,str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},sub:tm,subtract:Kg,translate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=n[0],d=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=a,t[5]=l,t[6]=f*r+d*s+h,t[7]=f*i+d*a+u,t[8]=f*o+d*l+c,t},transpose:Xg},Symbol.toStringTag,{value:"Module"}));function nm(){var t=new Ig(16);return Ig!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function rm(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function im(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function om(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],o=e[6],s=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=i,t[13]=s,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function sm(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],A=e[15],y=n*a-r*s,v=n*l-i*s,x=n*h-o*s,_=r*l-i*a,b=r*h-o*a,w=i*h-o*l,T=u*g-c*p,M=u*m-f*p,C=u*A-d*p,S=c*m-f*g,I=c*A-d*g,P=f*A-d*m,E=y*P-v*I+x*S+_*C-b*M+w*T;return E?(E=1/E,t[0]=(a*P-l*I+h*S)*E,t[1]=(i*I-r*P-o*S)*E,t[2]=(g*w-m*b+A*_)*E,t[3]=(f*b-c*w-d*_)*E,t[4]=(l*C-s*P-h*M)*E,t[5]=(n*P-i*C+o*M)*E,t[6]=(m*x-p*w-A*v)*E,t[7]=(u*w-f*x+d*v)*E,t[8]=(s*I-a*C+h*T)*E,t[9]=(r*C-n*I-o*T)*E,t[10]=(p*b-g*x+A*y)*E,t[11]=(c*x-u*b-d*y)*E,t[12]=(a*M-s*S-l*T)*E,t[13]=(n*S-r*M+i*T)*E,t[14]=(g*v-p*_-m*y)*E,t[15]=(u*_-c*v+f*y)*E,t):null}function am(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],g=e[12],m=e[13],A=e[14],y=e[15],v=n[0],x=n[1],_=n[2],b=n[3];return t[0]=v*r+x*a+_*c+b*g,t[1]=v*i+x*l+_*f+b*m,t[2]=v*o+x*h+_*d+b*A,t[3]=v*s+x*u+_*p+b*y,v=n[4],x=n[5],_=n[6],b=n[7],t[4]=v*r+x*a+_*c+b*g,t[5]=v*i+x*l+_*f+b*m,t[6]=v*o+x*h+_*d+b*A,t[7]=v*s+x*u+_*p+b*y,v=n[8],x=n[9],_=n[10],b=n[11],t[8]=v*r+x*a+_*c+b*g,t[9]=v*i+x*l+_*f+b*m,t[10]=v*o+x*h+_*d+b*A,t[11]=v*s+x*u+_*p+b*y,v=n[12],x=n[13],_=n[14],b=n[15],t[12]=v*r+x*a+_*c+b*g,t[13]=v*i+x*l+_*f+b*m,t[14]=v*o+x*h+_*d+b*A,t[15]=v*s+x*u+_*p+b*y,t}function lm(t,e,n){var r,i,o,s,a,l,h,u,c,f,d,p,g=n[0],m=n[1],A=n[2];return e===t?(t[12]=e[0]*g+e[4]*m+e[8]*A+e[12],t[13]=e[1]*g+e[5]*m+e[9]*A+e[13],t[14]=e[2]*g+e[6]*m+e[10]*A+e[14],t[15]=e[3]*g+e[7]*m+e[11]*A+e[15]):(r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=a,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=f,t[10]=d,t[11]=p,t[12]=r*g+a*m+c*A+e[12],t[13]=i*g+l*m+f*A+e[13],t[14]=o*g+h*m+d*A+e[14],t[15]=s*g+u*m+p*A+e[15]),t}function hm(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function um(t,e,n,r){var i,o,s,a,l,h,u,c,f,d,p,g,m,A,y,v,x,_,b,w,T,M,C,S,I=r[0],P=r[1],E=r[2],O=Math.hypot(I,P,E);return O<Sg?null:(I*=O=1/O,P*=O,E*=O,i=Math.sin(n),s=1-(o=Math.cos(n)),a=e[0],l=e[1],h=e[2],u=e[3],c=e[4],f=e[5],d=e[6],p=e[7],g=e[8],m=e[9],A=e[10],y=e[11],v=I*I*s+o,x=P*I*s+E*i,_=E*I*s-P*i,b=I*P*s-E*i,w=P*P*s+o,T=E*P*s+I*i,M=I*E*s+P*i,C=P*E*s-I*i,S=E*E*s+o,t[0]=a*v+c*x+g*_,t[1]=l*v+f*x+m*_,t[2]=h*v+d*x+A*_,t[3]=u*v+p*x+y*_,t[4]=a*b+c*w+g*T,t[5]=l*b+f*w+m*T,t[6]=h*b+d*w+A*T,t[7]=u*b+p*w+y*T,t[8]=a*M+c*C+g*S,t[9]=l*M+f*C+m*S,t[10]=h*M+d*C+A*S,t[11]=u*M+p*C+y*S,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function cm(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function fm(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function dm(t,e,n){var r,i,o,s=n[0],a=n[1],l=n[2],h=Math.hypot(s,a,l);return h<Sg?null:(s*=h=1/h,a*=h,l*=h,r=Math.sin(e),o=1-(i=Math.cos(e)),t[0]=s*s*o+i,t[1]=a*s*o+l*r,t[2]=l*s*o-a*r,t[3]=0,t[4]=s*a*o-l*r,t[5]=a*a*o+i,t[6]=l*a*o+s*r,t[7]=0,t[8]=s*l*o+a*r,t[9]=a*l*o-s*r,t[10]=l*l*o+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function pm(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=r+r,l=i+i,h=o+o,u=r*a,c=r*l,f=r*h,d=i*l,p=i*h,g=o*h,m=s*a,A=s*l,y=s*h;return t[0]=1-(d+g),t[1]=c+y,t[2]=f-A,t[3]=0,t[4]=c-y,t[5]=1-(u+g),t[6]=p+m,t[7]=0,t[8]=f+A,t[9]=p-m,t[10]=1-(u+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function gm(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function mm(t,e){var n=e[0],r=e[1],i=e[2],o=e[4],s=e[5],a=e[6],l=e[8],h=e[9],u=e[10];return t[0]=Math.hypot(n,r,i),t[1]=Math.hypot(o,s,a),t[2]=Math.hypot(l,h,u),t}function Am(t,e){var n=new Ig(3);mm(n,e);var r=1/n[0],i=1/n[1],o=1/n[2],s=e[0]*r,a=e[1]*i,l=e[2]*o,h=e[4]*r,u=e[5]*i,c=e[6]*o,f=e[8]*r,d=e[9]*i,p=e[10]*o,g=s+u+p,m=0;return g>0?(m=2*Math.sqrt(g+1),t[3]=.25*m,t[0]=(c-d)/m,t[1]=(f-l)/m,t[2]=(a-h)/m):s>u&&s>p?(m=2*Math.sqrt(1+s-u-p),t[3]=(c-d)/m,t[0]=.25*m,t[1]=(a+h)/m,t[2]=(f+l)/m):u>p?(m=2*Math.sqrt(1+u-s-p),t[3]=(f-l)/m,t[0]=(a+h)/m,t[1]=.25*m,t[2]=(c+d)/m):(m=2*Math.sqrt(1+p-s-u),t[3]=(a-h)/m,t[0]=(f+l)/m,t[1]=(c+d)/m,t[2]=.25*m),t}function ym(t,e,n,r){var i=e[0],o=e[1],s=e[2],a=e[3],l=i+i,h=o+o,u=s+s,c=i*l,f=i*h,d=i*u,p=o*h,g=o*u,m=s*u,A=a*l,y=a*h,v=a*u,x=r[0],_=r[1],b=r[2];return t[0]=(1-(p+m))*x,t[1]=(f+v)*x,t[2]=(d-y)*x,t[3]=0,t[4]=(f-v)*_,t[5]=(1-(c+m))*_,t[6]=(g+A)*_,t[7]=0,t[8]=(d+y)*b,t[9]=(g-A)*b,t[10]=(1-(c+p))*b,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function vm(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n+n,a=r+r,l=i+i,h=n*s,u=r*s,c=r*a,f=i*s,d=i*a,p=i*l,g=o*s,m=o*a,A=o*l;return t[0]=1-c-p,t[1]=u+A,t[2]=f-m,t[3]=0,t[4]=u-A,t[5]=1-h-p,t[6]=d+g,t[7]=0,t[8]=f+m,t[9]=d-g,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function xm(t,e,n,r,i){var o,s=1/Math.tan(e/2);return t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(r-i),t[10]=(i+r)*o,t[14]=2*i*r*o):(t[10]=-1,t[14]=-2*r),t}var _m=xm;function bm(t,e,n,r,i,o,s){var a=1/(e-n),l=1/(r-i),h=1/(o-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*a,t[13]=(i+r)*l,t[14]=(s+o)*h,t[15]=1,t}var wm=bm;function Tm(t,e,n,r){var i,o,s,a,l,h,u,c,f,d,p=e[0],g=e[1],m=e[2],A=r[0],y=r[1],v=r[2],x=n[0],_=n[1],b=n[2];return Math.abs(p-x)<Sg&&Math.abs(g-_)<Sg&&Math.abs(m-b)<Sg?im(t):(u=p-x,c=g-_,f=m-b,i=y*(f*=d=1/Math.hypot(u,c,f))-v*(c*=d),o=v*(u*=d)-A*f,s=A*c-y*u,(d=Math.hypot(i,o,s))?(i*=d=1/d,o*=d,s*=d):(i=0,o=0,s=0),a=c*s-f*o,l=f*i-u*s,h=u*o-c*i,(d=Math.hypot(a,l,h))?(a*=d=1/d,l*=d,h*=d):(a=0,l=0,h=0),t[0]=i,t[1]=a,t[2]=u,t[3]=0,t[4]=o,t[5]=l,t[6]=c,t[7]=0,t[8]=s,t[9]=h,t[10]=f,t[11]=0,t[12]=-(i*p+o*g+s*m),t[13]=-(a*p+l*g+h*m),t[14]=-(u*p+c*g+f*m),t[15]=1,t)}function Mm(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function Cm(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}var Sm=am,Im=Mm;const Pm=Object.freeze(Object.defineProperty({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t},adjoint:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],A=e[15];return t[0]=a*(f*A-d*m)-c*(l*A-h*m)+g*(l*d-h*f),t[1]=-(r*(f*A-d*m)-c*(i*A-o*m)+g*(i*d-o*f)),t[2]=r*(l*A-h*m)-a*(i*A-o*m)+g*(i*h-o*l),t[3]=-(r*(l*d-h*f)-a*(i*d-o*f)+c*(i*h-o*l)),t[4]=-(s*(f*A-d*m)-u*(l*A-h*m)+p*(l*d-h*f)),t[5]=n*(f*A-d*m)-u*(i*A-o*m)+p*(i*d-o*f),t[6]=-(n*(l*A-h*m)-s*(i*A-o*m)+p*(i*h-o*l)),t[7]=n*(l*d-h*f)-s*(i*d-o*f)+u*(i*h-o*l),t[8]=s*(c*A-d*g)-u*(a*A-h*g)+p*(a*d-h*c),t[9]=-(n*(c*A-d*g)-u*(r*A-o*g)+p*(r*d-o*c)),t[10]=n*(a*A-h*g)-s*(r*A-o*g)+p*(r*h-o*a),t[11]=-(n*(a*d-h*c)-s*(r*d-o*c)+u*(r*h-o*a)),t[12]=-(s*(c*m-f*g)-u*(a*m-l*g)+p*(a*f-l*c)),t[13]=n*(c*m-f*g)-u*(r*m-i*g)+p*(r*f-i*c),t[14]=-(n*(a*m-l*g)-s*(r*m-i*g)+p*(r*l-i*a)),t[15]=n*(a*f-l*c)-s*(r*f-i*c)+u*(r*l-i*a),t},clone:function(t){var e=new Ig(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:rm,create:nm,determinant:function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],s=t[5],a=t[6],l=t[7],h=t[8],u=t[9],c=t[10],f=t[11],d=t[12],p=t[13],g=t[14],m=t[15];return(e*s-n*o)*(c*m-f*g)-(e*a-r*o)*(u*m-f*p)+(e*l-i*o)*(u*g-c*p)+(n*a-r*s)*(h*m-f*d)-(n*l-i*s)*(h*g-c*d)+(r*l-i*a)*(h*p-u*d)},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=t[8],c=t[9],f=t[10],d=t[11],p=t[12],g=t[13],m=t[14],A=t[15],y=e[0],v=e[1],x=e[2],_=e[3],b=e[4],w=e[5],T=e[6],M=e[7],C=e[8],S=e[9],I=e[10],P=e[11],E=e[12],O=e[13],R=e[14],k=e[15];return Math.abs(n-y)<=Sg*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(r-v)<=Sg*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(i-x)<=Sg*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(o-_)<=Sg*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(s-b)<=Sg*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(a-w)<=Sg*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-T)<=Sg*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(h-M)<=Sg*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(u-C)<=Sg*Math.max(1,Math.abs(u),Math.abs(C))&&Math.abs(c-S)<=Sg*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(f-I)<=Sg*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(d-P)<=Sg*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(p-E)<=Sg*Math.max(1,Math.abs(p),Math.abs(E))&&Math.abs(g-O)<=Sg*Math.max(1,Math.abs(g),Math.abs(O))&&Math.abs(m-R)<=Sg*Math.max(1,Math.abs(m),Math.abs(R))&&Math.abs(A-k)<=Sg*Math.max(1,Math.abs(A),Math.abs(k))},exactEquals:Cm,frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},fromQuat:vm,fromQuat2:function(t,e){var n=new Ig(3),r=-e[0],i=-e[1],o=-e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=r*r+i*i+o*o+s*s;return c>0?(n[0]=2*(a*s+u*r+l*o-h*i)/c,n[1]=2*(l*s+u*i+h*r-a*o)/c,n[2]=2*(h*s+u*o+a*i-l*r)/c):(n[0]=2*(a*s+u*r+l*o-h*i),n[1]=2*(l*s+u*i+h*r-a*o),n[2]=2*(h*s+u*o+a*i-l*r)),pm(t,e,n),t},fromRotation:dm,fromRotationTranslation:pm,fromRotationTranslationScale:ym,fromRotationTranslationScaleOrigin:function(t,e,n,r,i){var o=e[0],s=e[1],a=e[2],l=e[3],h=o+o,u=s+s,c=a+a,f=o*h,d=o*u,p=o*c,g=s*u,m=s*c,A=a*c,y=l*h,v=l*u,x=l*c,_=r[0],b=r[1],w=r[2],T=i[0],M=i[1],C=i[2],S=(1-(g+A))*_,I=(d+x)*_,P=(p-v)*_,E=(d-x)*b,O=(1-(f+A))*b,R=(m+y)*b,k=(p+v)*w,L=(m-y)*w,D=(1-(f+g))*w;return t[0]=S,t[1]=I,t[2]=P,t[3]=0,t[4]=E,t[5]=O,t[6]=R,t[7]=0,t[8]=k,t[9]=L,t[10]=D,t[11]=0,t[12]=n[0]+T-(S*T+E*M+k*C),t[13]=n[1]+M-(I*T+O*M+L*C),t[14]=n[2]+C-(P*T+R*M+D*C),t[15]=1,t},fromScaling:fm,fromTranslation:cm,fromValues:function(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g){var m=new Ig(16);return m[0]=t,m[1]=e,m[2]=n,m[3]=r,m[4]=i,m[5]=o,m[6]=s,m[7]=a,m[8]=l,m[9]=h,m[10]=u,m[11]=c,m[12]=f,m[13]=d,m[14]=p,m[15]=g,m},fromXRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,n,r,i,o,s){var a=1/(n-e),l=1/(i-r),h=1/(o-s);return t[0]=2*o*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*l,t[6]=0,t[7]=0,t[8]=(n+e)*a,t[9]=(i+r)*l,t[10]=(s+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=s*o*2*h,t[15]=0,t},getRotation:Am,getScaling:mm,getTranslation:gm,identity:im,invert:sm,lookAt:Tm,mul:Sm,multiply:am,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t[9]=e[9]+n[9]*r,t[10]=e[10]+n[10]*r,t[11]=e[11]+n[11]*r,t[12]=e[12]+n[12]*r,t[13]=e[13]+n[13]*r,t[14]=e[14]+n[14]*r,t[15]=e[15]+n[15]*r,t},ortho:wm,orthoNO:bm,orthoZO:function(t,e,n,r,i,o,s){var a=1/(e-n),l=1/(r-i),h=1/(o-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=h,t[11]=0,t[12]=(e+n)*a,t[13]=(i+r)*l,t[14]=o*h,t[15]=1,t},perspective:_m,perspectiveFromFieldOfView:function(t,e,n,r){var i=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),s=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(s+a),h=2/(i+o);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(s-a)*l*.5,t[9]=(i-o)*h*.5,t[10]=r/(n-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*n/(n-r),t[15]=0,t},perspectiveNO:xm,perspectiveZO:function(t,e,n,r,i){var o,s=1/Math.tan(e/2);return t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(r-i),t[10]=i*o,t[14]=i*r*o):(t[10]=-1,t[14]=-r),t},rotate:um,rotateX:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[4],s=e[5],a=e[6],l=e[7],h=e[8],u=e[9],c=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+h*r,t[5]=s*i+u*r,t[6]=a*i+c*r,t[7]=l*i+f*r,t[8]=h*i-o*r,t[9]=u*i-s*r,t[10]=c*i-a*r,t[11]=f*i-l*r,t},rotateY:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],s=e[1],a=e[2],l=e[3],h=e[8],u=e[9],c=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-h*r,t[1]=s*i-u*r,t[2]=a*i-c*r,t[3]=l*i-f*r,t[8]=o*r+h*i,t[9]=s*r+u*i,t[10]=a*r+c*i,t[11]=l*r+f*i,t},rotateZ:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],s=e[1],a=e[2],l=e[3],h=e[4],u=e[5],c=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+h*r,t[1]=s*i+u*r,t[2]=a*i+c*r,t[3]=l*i+f*r,t[4]=h*i-o*r,t[5]=u*i-s*r,t[6]=c*i-a*r,t[7]=f*i-l*r,t},scale:hm,set:function(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g,m){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t[8]=h,t[9]=u,t[10]=c,t[11]=f,t[12]=d,t[13]=p,t[14]=g,t[15]=m,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},sub:Im,subtract:Mm,targetTo:function(t,e,n,r){var i=e[0],o=e[1],s=e[2],a=r[0],l=r[1],h=r[2],u=i-n[0],c=o-n[1],f=s-n[2],d=u*u+c*c+f*f;d>0&&(u*=d=1/Math.sqrt(d),c*=d,f*=d);var p=l*f-h*c,g=h*u-a*f,m=a*c-l*u;return(d=p*p+g*g+m*m)>0&&(p*=d=1/Math.sqrt(d),g*=d,m*=d),t[0]=p,t[1]=g,t[2]=m,t[3]=0,t[4]=c*m-f*g,t[5]=f*p-u*m,t[6]=u*g-c*p,t[7]=0,t[8]=u,t[9]=c,t[10]=f,t[11]=0,t[12]=i,t[13]=o,t[14]=s,t[15]=1,t},translate:lm,transpose:om},Symbol.toStringTag,{value:"Module"}));function Em(){var t=new Ig(3);return Ig!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Om(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function Rm(t,e,n){var r=new Ig(3);return r[0]=t,r[1]=e,r[2]=n,r}function km(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Lm(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function Dm(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Nm(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Fm(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function zm(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function Bm(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Hm(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function jm(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.hypot(n,r,i)}function Um(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}function Vm(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}function Gm(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function Wm(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function qm(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=i*l-o*a,t[1]=o*s-r*l,t[2]=r*a-i*s,t}function Xm(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[3]*r+n[7]*i+n[11]*o+n[15];return s=s||1,t[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/s,t[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/s,t[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/s,t}function Zm(t,e){var n=t[0],r=t[1],i=t[2],o=e[0],s=e[1],a=e[2],l=Math.sqrt(n*n+r*r+i*i)*Math.sqrt(o*o+s*s+a*a),h=l&&Wm(t,e)/l;return Math.acos(Math.min(Math.max(h,-1),1))}function Ym(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Jm(t,e){var n=t[0],r=t[1],i=t[2],o=e[0],s=e[1],a=e[2];return Math.abs(n-o)<=Sg*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=Sg*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-a)<=Sg*Math.max(1,Math.abs(i),Math.abs(a))}var Qm,Km=Nm,$m=Fm,tA=zm,eA=jm,nA=Um,rA=Om,iA=Vm,oA=(Qm=Em(),function(t,e,n,r,i,o){var s,a;for(e||(e=3),n||(n=0),a=r?Math.min(r*e+n,t.length):t.length,s=n;s<a;s+=e)Qm[0]=t[s],Qm[1]=t[s+1],Qm[2]=t[s+2],i(Qm,Qm,o),t[s]=Qm[0],t[s+1]=Qm[1],t[s+2]=Qm[2];return t});const sA=Object.freeze(Object.defineProperty({__proto__:null,add:Dm,angle:Zm,bezier:function(t,e,n,r,i,o){var s=1-o,a=s*s,l=o*o,h=a*s,u=3*o*a,c=3*l*s,f=l*o;return t[0]=e[0]*h+n[0]*u+r[0]*c+i[0]*f,t[1]=e[1]*h+n[1]*u+r[1]*c+i[1]*f,t[2]=e[2]*h+n[2]*u+r[2]*c+i[2]*f,t},ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},clone:function(t){var e=new Ig(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},copy:km,create:Em,cross:qm,dist:eA,distance:jm,div:tA,divide:zm,dot:Wm,equals:Jm,exactEquals:Ym,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},forEach:oA,fromValues:Rm,hermite:function(t,e,n,r,i,o){var s=o*o,a=s*(2*o-3)+1,l=s*(o-2)+o,h=s*(o-1),u=s*(3-2*o);return t[0]=e[0]*a+n[0]*l+r[0]*h+i[0]*u,t[1]=e[1]*a+n[1]*l+r[1]*h+i[1]*u,t[2]=e[2]*a+n[2]*l+r[2]*h+i[2]*u,t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},len:rA,length:Om,lerp:function(t,e,n,r){var i=e[0],o=e[1],s=e[2];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=s+r*(n[2]-s),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},mul:$m,multiply:Fm,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},normalize:Gm,random:function(t,e){e=e||1;var n=2*Pg()*Math.PI,r=2*Pg()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t},rotateX:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},rotateY:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},rotateZ:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:Bm,scaleAndAdd:Hm,set:Lm,sqrDist:nA,sqrLen:iA,squaredDistance:Um,squaredLength:Vm,str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},sub:Km,subtract:Nm,transformMat3:function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=r*n[0]+i*n[3]+o*n[6],t[1]=r*n[1]+i*n[4]+o*n[7],t[2]=r*n[2]+i*n[5]+o*n[8],t},transformMat4:Xm,transformQuat:function(t,e,n){var r=n[0],i=n[1],o=n[2],s=n[3],a=e[0],l=e[1],h=e[2],u=i*h-o*l,c=o*a-r*h,f=r*l-i*a,d=i*f-o*c,p=o*u-r*f,g=r*c-i*u,m=2*s;return u*=m,c*=m,f*=m,d*=2,p*=2,g*=2,t[0]=a+u+d,t[1]=l+c+p,t[2]=h+f+g,t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t}},Symbol.toStringTag,{value:"Module"}));function aA(){var t=new Ig(4);return Ig!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function lA(t){var e=new Ig(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function hA(t,e,n,r){var i=new Ig(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i}function uA(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function cA(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function fA(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function dA(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function pA(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function gA(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function mA(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function AA(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return Math.hypot(n,r,i,o)}function yA(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return n*n+r*r+i*i+o*o}function vA(t){var e=t[0],n=t[1],r=t[2],i=t[3];return Math.hypot(e,n,r,i)}function xA(t){var e=t[0],n=t[1],r=t[2],i=t[3];return e*e+n*n+r*r+i*i}function _A(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*n+r*r+i*i+o*o;return s>0&&(s=1/Math.sqrt(s)),t[0]=n*s,t[1]=r*s,t[2]=i*s,t[3]=o*s,t}function bA(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function wA(t,e,n,r){var i=e[0],o=e[1],s=e[2],a=e[3];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=s+r*(n[2]-s),t[3]=a+r*(n[3]-a),t}function TA(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*s,t[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*s,t[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*s,t[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*s,t}function MA(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function CA(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=e[0],a=e[1],l=e[2],h=e[3];return Math.abs(n-s)<=Sg*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-a)<=Sg*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=Sg*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(o-h)<=Sg*Math.max(1,Math.abs(o),Math.abs(h))}var SA=dA,IA=pA,PA=gA,EA=AA,OA=yA,RA=vA,kA=xA,LA=function(){var t=aA();return function(e,n,r,i,o,s){var a,l;for(n||(n=4),r||(r=0),l=i?Math.min(i*n+r,e.length):e.length,a=r;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],o(t,t,s),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}}();const DA=Object.freeze(Object.defineProperty({__proto__:null,add:fA,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},clone:lA,copy:uA,create:aA,cross:function(t,e,n,r){var i=n[0]*r[1]-n[1]*r[0],o=n[0]*r[2]-n[2]*r[0],s=n[0]*r[3]-n[3]*r[0],a=n[1]*r[2]-n[2]*r[1],l=n[1]*r[3]-n[3]*r[1],h=n[2]*r[3]-n[3]*r[2],u=e[0],c=e[1],f=e[2],d=e[3];return t[0]=c*h-f*l+d*a,t[1]=-u*h+f*s-d*o,t[2]=u*l-c*s+d*i,t[3]=-u*a+c*o-f*i,t},dist:EA,distance:AA,div:PA,divide:gA,dot:bA,equals:CA,exactEquals:MA,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},forEach:LA,fromValues:hA,inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},len:RA,length:vA,lerp:wA,max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},mul:IA,multiply:pA,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},normalize:_A,random:function(t,e){var n,r,i,o,s,a;e=e||1;do{s=(n=2*Pg()-1)*n+(r=2*Pg()-1)*r}while(s>=1);do{a=(i=2*Pg()-1)*i+(o=2*Pg()-1)*o}while(a>=1);var l=Math.sqrt((1-s)/a);return t[0]=e*n,t[1]=e*r,t[2]=e*i*l,t[3]=e*o*l,t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:mA,scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t},set:cA,sqrDist:OA,sqrLen:kA,squaredDistance:yA,squaredLength:xA,str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},sub:SA,subtract:dA,transformMat4:TA,transformQuat:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2],h=n[3],u=h*r+a*o-l*i,c=h*i+l*r-s*o,f=h*o+s*i-a*r,d=-s*r-a*i-l*o;return t[0]=u*h+d*-s+c*-l-f*-a,t[1]=c*h+d*-a+f*-s-u*-l,t[2]=f*h+d*-l+u*-a-c*-s,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}},Symbol.toStringTag,{value:"Module"}));function NA(){var t=new Ig(4);return Ig!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function FA(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function zA(t,e,n){n*=.5;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t}function BA(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=n[0],l=n[1],h=n[2],u=n[3];return t[0]=r*u+s*a+i*h-o*l,t[1]=i*u+s*l+o*a-r*h,t[2]=o*u+s*h+r*l-i*a,t[3]=s*u-r*a-i*l-o*h,t}function HA(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+s*a,t[1]=i*l+o*a,t[2]=o*l-i*a,t[3]=s*l-r*a,t}function jA(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l-o*a,t[1]=i*l+s*a,t[2]=o*l+r*a,t[3]=s*l-i*a,t}function UA(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+i*a,t[1]=i*l-r*a,t[2]=o*l+s*a,t[3]=s*l-o*a,t}function VA(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=Math.sqrt(n*n+r*r+i*i),a=Math.exp(o),l=s>0?a*Math.sin(s)/s:0;return t[0]=n*l,t[1]=r*l,t[2]=i*l,t[3]=a*Math.cos(s),t}function GA(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=Math.sqrt(n*n+r*r+i*i),a=s>0?Math.atan2(s,o)/s:0;return t[0]=n*a,t[1]=r*a,t[2]=i*a,t[3]=.5*Math.log(n*n+r*r+i*i+o*o),t}function WA(t,e,n,r){var i,o,s,a,l,h=e[0],u=e[1],c=e[2],f=e[3],d=n[0],p=n[1],g=n[2],m=n[3];return(o=h*d+u*p+c*g+f*m)<0&&(o=-o,d=-d,p=-p,g=-g,m=-m),1-o>Sg?(i=Math.acos(o),s=Math.sin(i),a=Math.sin((1-r)*i)/s,l=Math.sin(r*i)/s):(a=1-r,l=r),t[0]=a*h+l*d,t[1]=a*u+l*p,t[2]=a*c+l*g,t[3]=a*f+l*m,t}function qA(t,e){var n,r=e[0]+e[4]+e[8];if(r>0)n=Math.sqrt(r+1),t[3]=.5*n,n=.5/n,t[0]=(e[5]-e[7])*n,t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;n=Math.sqrt(e[3*i+i]-e[3*o+o]-e[3*s+s]+1),t[i]=.5*n,n=.5/n,t[3]=(e[3*o+s]-e[3*s+o])*n,t[o]=(e[3*o+i]+e[3*i+o])*n,t[s]=(e[3*s+i]+e[3*i+s])*n}return t}function XA(t,e,n,r){var i=.5*Math.PI/180;e*=i,n*=i,r*=i;var o=Math.sin(e),s=Math.cos(e),a=Math.sin(n),l=Math.cos(n),h=Math.sin(r),u=Math.cos(r);return t[0]=o*l*u-s*a*h,t[1]=s*a*u+o*l*h,t[2]=s*l*h-o*a*u,t[3]=s*l*u+o*a*h,t}var ZA,YA,JA,QA,KA,$A,ty=lA,ey=hA,ny=uA,ry=cA,iy=fA,oy=BA,sy=mA,ay=bA,ly=wA,hy=vA,uy=hy,cy=xA,fy=cy,dy=_A,py=MA,gy=CA,my=(ZA=Em(),YA=Rm(1,0,0),JA=Rm(0,1,0),function(t,e,n){var r=Wm(e,n);return r<-.999999?(qm(ZA,YA,e),rA(ZA)<1e-6&&qm(ZA,JA,e),Gm(ZA,ZA),zA(t,ZA,Math.PI),t):r>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(qm(ZA,e,n),t[0]=ZA[0],t[1]=ZA[1],t[2]=ZA[2],t[3]=1+r,dy(t,t))}),Ay=(QA=NA(),KA=NA(),function(t,e,n,r,i,o){return WA(QA,e,i,o),WA(KA,n,r,o),WA(t,QA,KA,2*o*(1-o)),t}),yy=($A=Gg(),function(t,e,n,r){return $A[0]=n[0],$A[3]=n[1],$A[6]=n[2],$A[1]=r[0],$A[4]=r[1],$A[7]=r[2],$A[2]=-e[0],$A[5]=-e[1],$A[8]=-e[2],dy(t,qA(t,$A))});const vy=Object.freeze(Object.defineProperty({__proto__:null,add:iy,calculateW:function(t,e){var n=e[0],r=e[1],i=e[2];return t[0]=n,t[1]=r,t[2]=i,t[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t},clone:ty,conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},copy:ny,create:NA,dot:ay,equals:gy,exactEquals:py,exp:VA,fromEuler:XA,fromMat3:qA,fromValues:ey,getAngle:function(t,e){var n=ay(t,e);return Math.acos(2*n*n-1)},getAxisAngle:function(t,e){var n=2*Math.acos(e[3]),r=Math.sin(n/2);return r>Sg?(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r):(t[0]=1,t[1]=0,t[2]=0),n},identity:FA,invert:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*n+r*r+i*i+o*o,a=s?1/s:0;return t[0]=-n*a,t[1]=-r*a,t[2]=-i*a,t[3]=o*a,t},len:uy,length:hy,lerp:ly,ln:GA,mul:oy,multiply:BA,normalize:dy,pow:function(t,e,n){return GA(t,e),sy(t,t,n),VA(t,t),t},random:function(t){var e=Pg(),n=Pg(),r=Pg(),i=Math.sqrt(1-e),o=Math.sqrt(e);return t[0]=i*Math.sin(2*Math.PI*n),t[1]=i*Math.cos(2*Math.PI*n),t[2]=o*Math.sin(2*Math.PI*r),t[3]=o*Math.cos(2*Math.PI*r),t},rotateX:HA,rotateY:jA,rotateZ:UA,rotationTo:my,scale:sy,set:ry,setAxes:yy,setAxisAngle:zA,slerp:WA,sqlerp:Ay,sqrLen:fy,squaredLength:cy,str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}},Symbol.toStringTag,{value:"Module"}));function xy(t,e,n){var r=.5*n[0],i=.5*n[1],o=.5*n[2],s=e[0],a=e[1],l=e[2],h=e[3];return t[0]=s,t[1]=a,t[2]=l,t[3]=h,t[4]=r*h+i*l-o*a,t[5]=i*h+o*s-r*l,t[6]=o*h+r*a-i*s,t[7]=-r*s-i*a-o*l,t}function _y(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var by=ny;var wy=ny;function Ty(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=n[4],l=n[5],h=n[6],u=n[7],c=e[4],f=e[5],d=e[6],p=e[7],g=n[0],m=n[1],A=n[2],y=n[3];return t[0]=r*y+s*g+i*A-o*m,t[1]=i*y+s*m+o*g-r*A,t[2]=o*y+s*A+r*m-i*g,t[3]=s*y-r*g-i*m-o*A,t[4]=r*u+s*a+i*h-o*l+c*y+p*g+f*A-d*m,t[5]=i*u+s*l+o*a-r*h+f*y+p*m+d*g-c*A,t[6]=o*u+s*h+r*l-i*a+d*y+p*A+c*m-f*g,t[7]=s*u-r*a-i*l-o*h+p*y-c*g-f*m-d*A,t}var My=Ty;var Cy=ay;var Sy=hy,Iy=Sy,Py=cy,Ey=Py;const Oy=Object.freeze(Object.defineProperty({__proto__:null,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t},clone:function(t){var e=new Ig(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},copy:_y,create:function(){var t=new Ig(8);return Ig!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},dot:Cy,equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=e[0],c=e[1],f=e[2],d=e[3],p=e[4],g=e[5],m=e[6],A=e[7];return Math.abs(n-u)<=Sg*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(r-c)<=Sg*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(i-f)<=Sg*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(o-d)<=Sg*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(s-p)<=Sg*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(a-g)<=Sg*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-m)<=Sg*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(h-A)<=Sg*Math.max(1,Math.abs(h),Math.abs(A))},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},fromMat4:function(t,e){var n=NA();Am(n,e);var r=new Ig(3);return gm(r,e),xy(t,n,r),t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromRotationTranslation:xy,fromRotationTranslationValues:function(t,e,n,r,i,o,s){var a=new Ig(8);a[0]=t,a[1]=e,a[2]=n,a[3]=r;var l=.5*i,h=.5*o,u=.5*s;return a[4]=l*r+h*n-u*e,a[5]=h*r+u*t-l*n,a[6]=u*r+l*e-h*t,a[7]=-l*t-h*e-u*n,a},fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromValues:function(t,e,n,r,i,o,s,a){var l=new Ig(8);return l[0]=t,l[1]=e,l[2]=n,l[3]=r,l[4]=i,l[5]=o,l[6]=s,l[7]=a,l},getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},getReal:by,getTranslation:function(t,e){var n=e[4],r=e[5],i=e[6],o=e[7],s=-e[0],a=-e[1],l=-e[2],h=e[3];return t[0]=2*(n*h+o*s+r*l-i*a),t[1]=2*(r*h+o*a+i*s-n*l),t[2]=2*(i*h+o*l+n*a-r*s),t},identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},invert:function(t,e){var n=Py(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t},len:Iy,length:Sy,lerp:function(t,e,n,r){var i=1-r;return Cy(e,n)<0&&(r=-r),t[0]=e[0]*i+n[0]*r,t[1]=e[1]*i+n[1]*r,t[2]=e[2]*i+n[2]*r,t[3]=e[3]*i+n[3]*r,t[4]=e[4]*i+n[4]*r,t[5]=e[5]*i+n[5]*r,t[6]=e[6]*i+n[6]*r,t[7]=e[7]*i+n[7]*r,t},mul:My,multiply:Ty,normalize:function(t,e){var n=Py(e);if(n>0){n=Math.sqrt(n);var r=e[0]/n,i=e[1]/n,o=e[2]/n,s=e[3]/n,a=e[4],l=e[5],h=e[6],u=e[7],c=r*a+i*l+o*h+s*u;t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=(a-r*c)/n,t[5]=(l-i*c)/n,t[6]=(h-o*c)/n,t[7]=(u-s*c)/n}return t},rotateAroundAxis:function(t,e,n,r){if(Math.abs(r)<Sg)return _y(t,e);var i=Math.hypot(n[0],n[1],n[2]);r*=.5;var o=Math.sin(r),s=o*n[0]/i,a=o*n[1]/i,l=o*n[2]/i,h=Math.cos(r),u=e[0],c=e[1],f=e[2],d=e[3];t[0]=u*h+d*s+c*l-f*a,t[1]=c*h+d*a+f*s-u*l,t[2]=f*h+d*l+u*a-c*s,t[3]=d*h-u*s-c*a-f*l;var p=e[4],g=e[5],m=e[6],A=e[7];return t[4]=p*h+A*s+g*l-m*a,t[5]=g*h+A*a+m*s-p*l,t[6]=m*h+A*l+p*a-g*s,t[7]=A*h-p*s-g*a-m*l,t},rotateByQuatAppend:function(t,e,n){var r=n[0],i=n[1],o=n[2],s=n[3],a=e[0],l=e[1],h=e[2],u=e[3];return t[0]=a*s+u*r+l*o-h*i,t[1]=l*s+u*i+h*r-a*o,t[2]=h*s+u*o+a*i-l*r,t[3]=u*s-a*r-l*i-h*o,a=e[4],l=e[5],h=e[6],u=e[7],t[4]=a*s+u*r+l*o-h*i,t[5]=l*s+u*i+h*r-a*o,t[6]=h*s+u*o+a*i-l*r,t[7]=u*s-a*r-l*i-h*o,t},rotateByQuatPrepend:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=n[0],l=n[1],h=n[2],u=n[3];return t[0]=r*u+s*a+i*h-o*l,t[1]=i*u+s*l+o*a-r*h,t[2]=o*u+s*h+r*l-i*a,t[3]=s*u-r*a-i*l-o*h,a=n[4],l=n[5],h=n[6],u=n[7],t[4]=r*u+s*a+i*h-o*l,t[5]=i*u+s*l+o*a-r*h,t[6]=o*u+s*h+r*l-i*a,t[7]=s*u-r*a-i*l-o*h,t},rotateX:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=a*s+u*r+l*o-h*i,f=l*s+u*i+h*r-a*o,d=h*s+u*o+a*i-l*r,p=u*s-a*r-l*i-h*o;return HA(t,e,n),r=t[0],i=t[1],o=t[2],s=t[3],t[4]=c*s+p*r+f*o-d*i,t[5]=f*s+p*i+d*r-c*o,t[6]=d*s+p*o+c*i-f*r,t[7]=p*s-c*r-f*i-d*o,t},rotateY:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=a*s+u*r+l*o-h*i,f=l*s+u*i+h*r-a*o,d=h*s+u*o+a*i-l*r,p=u*s-a*r-l*i-h*o;return jA(t,e,n),r=t[0],i=t[1],o=t[2],s=t[3],t[4]=c*s+p*r+f*o-d*i,t[5]=f*s+p*i+d*r-c*o,t[6]=d*s+p*o+c*i-f*r,t[7]=p*s-c*r-f*i-d*o,t},rotateZ:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=a*s+u*r+l*o-h*i,f=l*s+u*i+h*r-a*o,d=h*s+u*o+a*i-l*r,p=u*s-a*r-l*i-h*o;return UA(t,e,n),r=t[0],i=t[1],o=t[2],s=t[3],t[4]=c*s+p*r+f*o-d*i,t[5]=f*s+p*i+d*r-c*o,t[6]=d*s+p*o+c*i-f*r,t[7]=p*s-c*r-f*i-d*o,t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t},set:function(t,e,n,r,i,o,s,a,l){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t},setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},setReal:wy,sqrLen:Ey,squaredLength:Py,str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},translate:function(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=.5*n[0],l=.5*n[1],h=.5*n[2],u=e[4],c=e[5],f=e[6],d=e[7];return t[0]=r,t[1]=i,t[2]=o,t[3]=s,t[4]=s*a+i*h-o*l+u,t[5]=s*l+o*a-r*h+c,t[6]=s*h+r*l-i*a+f,t[7]=-r*a-i*l-o*h+d,t}},Symbol.toStringTag,{value:"Module"}));function Ry(){var t=new Ig(2);return Ig!=Float32Array&&(t[0]=0,t[1]=0),t}function ky(t,e){return t[0]=e[0],t[1]=e[1],t}function Ly(t,e,n){return t[0]=e,t[1]=n,t}function Dy(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Ny(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function Fy(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function zy(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function By(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function Hy(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.hypot(n,r)}function jy(t,e){var n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r}function Uy(t){var e=t[0],n=t[1];return Math.hypot(e,n)}function Vy(t){var e=t[0],n=t[1];return e*e+n*n}function Gy(t,e){return t[0]*e[0]+t[1]*e[1]}function Wy(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i,t[1]=n[1]*r+n[3]*i,t}function qy(t,e,n,r){var i=e[0]-n[0],o=e[1]-n[1],s=Math.sin(r),a=Math.cos(r);return t[0]=i*a-o*s+n[0],t[1]=i*s+o*a+n[1],t}function Xy(t,e){return t[0]===e[0]&&t[1]===e[1]}var Zy=Uy,Yy=Ny,Jy=Fy,Qy=zy,Ky=Hy,$y=jy,tv=Vy,ev=function(){var t=Ry();return function(e,n,r,i,o,s){var a,l;for(n||(n=2),r||(r=0),l=i?Math.min(i*n+r,e.length):e.length,a=r;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],o(t,t,s),e[a]=t[0],e[a+1]=t[1];return e}}();const nv=Object.freeze(Object.defineProperty({__proto__:null,add:Dy,angle:function(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],s=Math.sqrt(n*n+r*r)*Math.sqrt(i*i+o*o),a=s&&(n*i+r*o)/s;return Math.acos(Math.min(Math.max(a,-1),1))},ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},clone:function(t){var e=new Ig(2);return e[0]=t[0],e[1]=t[1],e},copy:ky,create:Ry,cross:function(t,e,n){var r=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=r,t},dist:Ky,distance:Hy,div:Qy,divide:zy,dot:Gy,equals:function(t,e){var n=t[0],r=t[1],i=e[0],o=e[1];return Math.abs(n-i)<=Sg*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(r-o)<=Sg*Math.max(1,Math.abs(r),Math.abs(o))},exactEquals:Xy,floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},forEach:ev,fromValues:function(t,e){var n=new Ig(2);return n[0]=t,n[1]=e,n},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},len:Zy,length:Uy,lerp:function(t,e,n,r){var i=e[0],o=e[1];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t},mul:Jy,multiply:Fy,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},normalize:function(t,e){var n=e[0],r=e[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t},random:function(t,e){e=e||1;var n=2*Pg()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t},rotate:qy,round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:By,scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t},set:Ly,sqrDist:$y,sqrLen:tv,squaredDistance:jy,squaredLength:Vy,str:function(t){return"vec2("+t[0]+", "+t[1]+")"},sub:Yy,subtract:Ny,transformMat2:Wy,transformMat2d:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i+n[4],t[1]=n[1]*r+n[3]*i+n[5],t},transformMat3:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[3]*i+n[6],t[1]=n[1]*r+n[4]*i+n[7],t},transformMat4:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[4]*i+n[12],t[1]=n[1]*r+n[5]*i+n[13],t},zero:function(t){return t[0]=0,t[1]=0,t}},Symbol.toStringTag,{value:"Module"}));var rv="undefined"!=typeof Float32Array?Float32Array:Array;function iv(){var t=new rv(3);return rv!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ov(t,e,n){var r=new rv(3);return r[0]=t,r[1]=e,r[2]=n,r}function sv(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function av(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function lv(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function hv(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function uv(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function cv(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=i*l-o*a,t[1]=o*s-r*l,t[2]=r*a-i*s,t}var fv=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};function dv(){var t=new rv(4);return rv!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function pv(t,e){var n=e[0]+e[4]+e[8],r=void 0;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*o+o]-e[3*s+s]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*o+s]-e[3*s+o])*r,t[o]=(e[3*o+i]+e[3*i+o])*r,t[s]=(e[3*s+i]+e[3*i+s])*r}return t}!function(){var t=iv()}(),function(){var t,e=(t=new rv(4),rv!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var gv=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},mv=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*n+r*r+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=r*s,t[2]=i*s,t[3]=o*s),t};!function(){var t=iv(),e=ov(1,0,0),n=ov(0,1,0)}(),function(){var t=dv(),e=dv()}(),function(){var t,e=(t=new rv(9),rv!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t)}();const Av=8,yv=[],vv=[],xv=[],_v=[];function bv(t,e,n){const r=cv(vv,e,n);t=pv(t,function(t,e,n,r,i,o,s,a,l,h){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t[8]=h,t}(yv,n[0],n[1],n[2],...r,...e)),t=function(t){return t[3]<0?gv(t,t,-1):t}(t=mv(t,t));const i=1/((1<<2*Av-1)-1);if(t[3]<i){t[3]=i;const e=Math.sqrt(1-i*i);t[0]*=e,t[1]*=e,t[2]*=e}const o=n[3]>0?cv(xv,n,e):cv(xv,e,n);return uv(cv(_v,n,e),o)<0&&gv(t,t,-1),t}const wv=[];function Tv(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const i=wv;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const o=void 0===e.length?e:e.length;for(let s=0;s<o/3;s++)void 0===e.length?Rv(t,3*s,3*s+1,3*s+2,r,i):Rv(t,e[3*s],e[3*s+1],e[3*s+2],r,i);for(let s=0;s<r.length;s+=3){const t=i[s/3];0!==t?(r[s]/=t,r[s+1]/=t,r[s+2]/=t):(r[s]=0,r[s+1]=0,r[s+2]=0)}return r}const Mv=[],Cv=[],Sv=[],Iv=[],Pv=[],Ev=[],Ov=[];function Rv(t,e,n,r,i,o){av(Iv,t[3*e],t[3*e+1],t[3*e+2]),av(Pv,t[3*n],t[3*n+1],t[3*n+2]),av(Ev,t[3*r],t[3*r+1],t[3*r+2]);const s=fv(Mv,Ev,Pv),a=fv(Cv,Iv,Pv),l=cv(Sv,s,a);hv(Ov,l),i[3*e]=i[3*e]||0,i[3*n]=i[3*n]||0,i[3*r]=i[3*r]||0,i[3*e+1]=i[3*e+1]||0,i[3*n+1]=i[3*n+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*e+2]=i[3*e+2]||0,i[3*n+2]=i[3*n+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*e]+=Ov[0],i[3*n]+=Ov[0],i[3*r]+=Ov[0],i[3*e+1]+=Ov[1],i[3*n+1]+=Ov[1],i[3*r+1]+=Ov[1],i[3*e+2]+=Ov[2],i[3*n+2]+=Ov[2],i[3*r+2]+=Ov[2],o[e]+=1,o[n]+=1,o[r]+=1}function kv(t,e,n,r,i){const o=t.length/3,s=i||new Array(4*o),a=[],l=[];for(let C=0;C<o;C++)a[C]=[0,0,0],l[C]=[0,0,0];const h=[0,0,0],u=[0,0,0],c=[0,0,0],f=[0,0],d=[0,0],p=[0,0],g=[0,0,0],m=[0,0,0];function A(e,r,i){Lv(h,t,3*e),Lv(u,t,3*r),Lv(c,t,3*i),Dv(f,n,2*e),Dv(d,n,2*r),Dv(p,n,2*i);const o=u[0]-h[0],s=c[0]-h[0],A=u[1]-h[1],y=c[1]-h[1],v=u[2]-h[2],x=c[2]-h[2],_=d[0]-f[0],b=p[0]-f[0],w=d[1]-f[1],T=p[1]-f[1],M=1/(_*T-b*w);av(g,(T*o-w*s)*M,(T*A-w*y)*M,(T*v-w*x)*M),av(m,(_*s-b*o)*M,(_*y-b*A)*M,(_*x-b*v)*M),lv(a[e],a[e],g),lv(a[r],a[r],g),lv(a[i],a[i],g),lv(l[e],l[e],m),lv(l[r],l[r],m),lv(l[i],l[i],m)}for(let C=0,S=r.length;C<S;C+=3)A(r[C+0],r[C+1],r[C+2]);const y=[],v=[],x=[],_=[];let b,w,T;function M(t){Lv(x,e,3*t),sv(_,x),w=a[t],sv(y,w),fv(y,y,function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(x,x,uv(x,w))),hv(y,y),cv(v,_,w),T=uv(v,l[t]),b=T<0?-1:1,s[4*t]=y[0],s[4*t+1]=y[1],s[4*t+2]=y[2],s[4*t+3]=b}for(let C=0,S=r.length;C<S;C+=3)M(r[C+0]),M(r[C+1]),M(r[C+2]);return s}function Lv(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function Dv(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}function Nv(t){return!Fv(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Fv(t){return null==t}function zv(t){return!Fv(t)}function Bv(t){return!Fv(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function Hv(t,...e){return Object.assign(t,...e),t}function jv(t,...e){for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)null!=r[e]&&(t[e]=r[e])}return t}function Uv(t){return"number"==typeof t&&!isNaN(t)}function Vv(t,e,n){return t*(1-n)+e*n}function Gv(t){return Array.isArray(t)||t instanceof Uint8Array||t instanceof Int8Array||t instanceof Uint16Array||t instanceof Int16Array||t instanceof Uint32Array||t instanceof Int32Array||t instanceof Uint8ClampedArray||t instanceof Float32Array||t instanceof Float64Array}function Wv(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function qv(t,e,n){return Math.min(n,Math.max(e,t))}function Xv(t){return t&&t.hasExtension("oes_vertex_array_object")}function Zv(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Yv(t){if(t.data){if(t.data.BYTES_PER_ELEMENT)return t.data.length*t.data.BYTES_PER_ELEMENT;if(t.data.length)return 4*t.data.length}else{if(t.BYTES_PER_ELEMENT)return t.length*t.BYTES_PER_ELEMENT;if(t.length)return 4*t.length;if(t.buffer&&t.buffer.destroy)return t.buffer._buffer.byteLength}return 0}function Jv(t){return t.width*t.height*Kv(t.format)*Qv(t.type)*("textureCube"===t._reglType?6:1)}function Qv(t){return"uint8"===t?1:"uint16"===t||"float16"===t||"half float"===t?2:"uint32"===t||"float"===t||"float32"===t?4:0}function Kv(t){return"depth"===t||"alpha"===t||"luminance"===t?1:"luminance alpha"===t||"depth stencil"===t?2:"srgba"===t||"rgb5 a1"===t||"rgba"===t.substring(0,4)?4:"srgb"===t||"rgb"===t.substring(0,3)?3:1}function $v(t){if(!t.componentType)return!1;const e=gg.getTypedArrayCtor(t.componentType);return t.byteStride>0&&t.byteStride!==t.itemSize*e.BYTES_PER_ELEMENT}function tx(t){return t&&(t.stride>0||$v(t))}function ex(t){let e=0;const n=t&&t.length||0;if(!n)return e;let r;for(let i=0;i<n;i++)r=t.charCodeAt(i),e=(e<<5)-e+r,e|=0;return e}function nx(t){return!(t&t-1)&&0!==t}function rx(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function ix(t,e,n){if(Gv(t))return nx(e)&&nx(n)?t:function(t,e,n){let r=e,i=n;nx(e)||(r=rx(e)),nx(n)||(i=rx(n));const o=new ImageData(new Uint8ClampedArray(t),e,n),s=document.createElement("canvas");s.width=e,s.height=n,s.getContext("2d").putImageData(o,0,0);const a=document.createElement("canvas");a.width=r,a.height=i,a.getContext("2d").drawImage(s,0,0,e,n,0,0,i,i),console.warn(`Texture's size is not power of two, resize from (${e}, ${n}) to (${r}, ${i})`);let l=document.getElementById("_debug_resize_canvas");return l||(l=document.createElement("canvas"),l.id="_debug_resize_canvas",document.body.appendChild(l)),l.width=r,l.height=i,l.getContext("2d").drawImage(a,0,0),a}(t,e,n);if(nx(t.width)&&nx(t.height))return t;n=t.height,nx(e=t.width)||(e=rx(e)),nx(n)||(n=rx(n));const r=document.createElement("canvas");r.width=e,r.height=n,r.getContext("2d").drawImage(t,0,0,e,n);const i=t.src,o=i.lastIndexOf("/")+1,s=i.substring(o);return console.warn(`Texture(${s})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),r}function ox(t){return t._gl instanceof WebGL2RenderingContext}var sx=Object.freeze({__proto__:null,clamp:qv,defined:zv,extend:Hv,extendWithoutNil:jv,getBufferSize:Yv,getPosArrayType:Wv,getSupportedFormats:function(t){return{etc:!!t.getExtension("WEBGL_compressed_texture_etc"),etc1:!!t.getExtension("WEBGL_compressed_texture_etc1"),s3tc:!!t.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:!!t.getExtension("WEBGL_compressed_texture_pvrtc"),astc:!!t.getExtension("WEBGL_compressed_texture_astc"),bc7:!!t.getExtension("EXT_texture_compression_bptc")}},getTexMemorySize:Jv,getTextureByteWidth:Qv,getTextureChannels:Kv,hasOwn:Zv,hashCode:ex,interpolate:Vv,isArray:Gv,isFunction:Bv,isInStride:$v,isInterleaved:tx,isNil:Fv,isNumber:Uv,isPowerOfTwo:nx,isString:Nv,isSupportVAO:Xv,lerp:function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t},log2:function(t){return Math.log2(t)},normalize:function(t,e){let n=0;for(let r=0,i=e.length;r<i;r++)n+=e[r];for(let r=0,i=e.length;r<i;r++)t[r]=e[r]/n;return t},resizeToPowerOfTwo:ix,set:function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t},supportNPOT:ox});function ax(t){return class extends t{on(t,e){return this._events||(this._events={type:[e]}),this._events[t]=this._events[t]||[],this._events[t].push(e),this}once(t,e){return this.on(t,this._wrapOnce(t,e))}off(t,e){return this._events&&this._events[t]?(this._events[t].splice(this._events[t].indexOf(e),1),this):this}fire(t,e={}){if(!this._events||!this._events[t])return this;e.target||(e.target=this);const n=this._events[t].slice(0);for(const r of n)r(e);return this}_wrapOnce(t,e){const n=this;let r=!1;return function i(o){r||(r=!0,e(o),n.off(t,i))}}}}const lx="__reshader_disposed";var hx=Object.freeze({__proto__:null,KEY_DISPOSED:lx,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]});const ux="_reshader_refCount";let cx=class{},fx=class extends(ax(cx)){constructor(t,e){if(super(),Bv(t)){this._texture=t,t=this.config={};for(const e in this._texture)Zv(this._texture,e)&&(Bv(this._texture[e])||(t[e]=this._texture[e]))}else if(this.config=t||{},this.resLoader=e,(t.url||t.promise)&&!t.data){this._loading=!0;const n=this;let r;if(t.promise)r=t.promise;else{let n;n=t.arrayBuffer?e.getArrayBuffer:e.get,r=n.call(e,t.url)}t.data=e.getDefaultTexture(t.url),this.promise=r,r.then((t=>(delete this.promise,n._loading=!1,n.config?(n.onLoad(t),Array.isArray(t)||(t=[t]),n.fire("complete",{target:this,resources:t}),t):t))).catch((t=>{console.error("error when loading texture image.",t),n.fire("error",{target:this,error:t})}))}}onLoad(t){}isReady(){return!this._loading}set(t,e){return this.config[t]=e,this.dirty=!0,this}get(t){return this.config[t]}createREGLTexture(t){return null}getREGLTexture(t){return this._texture||(this._texture=this.createREGLTexture(t),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap||(this.config.data=[])),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._updateREGL(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:t,height:e,type:n,format:r}=this.config;return t*e*Qv(n||"uint8")*Kv(r||"rgba")}_updateREGL(){this._texture&&!this._texture[lx]&&this._texture(this.config),this.dirty=!1}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this.config&&this.config.data instanceof ImageBitmap&&(this.config.data.close(),this.config.data=[]),this._texture&&!this._texture[lx]&&(this._texture[ux]&&this._texture[ux]--,this._texture[ux]||(this._texture.destroy(),this._texture[lx]=!0,delete this._texture)),delete this.resLoader,delete this._regl;const t=this.config&&this.config.url;delete this.config,t&&this.fire("disposed",{target:this,url:t})}_needPowerOf2(t){if(ox(t))return!1;const e=this.config;return e.wrap&&"clamp"!==e.wrap||e.wrapS&&"clamp"!==e.wrapS||e.wrapT&&"clamp"!==e.wrapT||e.min&&"nearest"!==e.min&&"linear"!==e.min}};const dx=im([]),px=im([]);let gx=class t{constructor(t,e){this.min=t||[1/0,1/0,1/0],this.max=e||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(t,e){km(t.min,e.min),km(t.max,e.max);for(let n=0;n<e.vertex.length;n++)km(t.vertex[n],e.vertex[n]);return t}combine(t){if(!t)return this;let e,n;return Array.isArray(t)?(e=t[0],n=t[1]):(e=t.min,n=t.max),e[0]<this.min[0]&&(this.min[0]=e[0],this._dirty=!0),e[1]<this.min[1]&&(this.min[1]=e[1],this._dirty=!0),e[2]<this.min[2]&&(this.min[2]=e[2],this._dirty=!0),n[0]>this.max[0]&&(this.max[0]=n[0],this._dirty=!0),n[1]>this.max[1]&&(this.max[1]=n[1],this._dirty=!0),n[2]>this.max[2]&&(this.max[2]=n[2],this._dirty=!0),this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[0,0,0],this._dirty=!0),this._dirty&&(Dm(this.center,this.min,this.max),Bm(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(t){const e=this.min,n=this.max;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&n[0]>=t[0]&&n[1]>=t[1]&&n[2]>=t[2]}isFinite(){const t=this.min,e=this.max;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let t=0;t<8;t++)this.vertex.push([0,0,0])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(e){return e?t.copy(e,this):new t(this.min.slice(),this.max.slice())}equals(t){if(!Jm(this.min,t.min)||!Jm(this.max,t.max))return!1;const e=t.vertex;for(let n=0;n<this.vertex.length;n++)if(!Jm(e[n],this.vertex[n]))return!1;return!0}transform(t,e){if(t=t||px,(e=e||px)[1]||e[2]||e[4]||e[6]||e[8]||e[9]){const n=this.vertex,r=am(dx,e,t);for(let t=0;t<n.length;t++)Xm(this.vertex[t],this.vertex[t],r);const i=this.vertex.map((t=>t[0])),o=this.vertex.map((t=>t[1])),s=this.vertex.map((t=>t[2])),a=Math.min(...i),l=Math.max(...i),h=Math.min(...o),u=Math.max(...o),c=Math.min(...s),f=Math.max(...s);Lm(this.min,a,h,c),Lm(this.max,l,u,f)}else{const n=am(dx,e,t);Xm(this.min,this.min,n),Xm(this.max,this.max,n)}return this}};const mx=[],Ax={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},yx={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},vx={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId",textureCoordMatrixAttribute:"aTextureCoordMatrix"};let xx=1;const _x="_reshader_refCount";let bx=class{constructor(t,e,n,r){this._version=0,this.data=t,this.elements=e,this.desc=Hv({},vx,r);const i=this._getPosAttritute();this.data[this.desc.positionAttribute]=i,n||(this.elements?n=wx(this.elements):i&&i.length?n=i.length/this.desc.positionSize:i&&i.interleavedArray?n=i.interleavedArray.length/this.desc.positionSize:i&&i.array&&(n=i.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(!0),this.updateBoundingBox()}set version(t){throw new Error("Geometry.version is read only.")}get version(){return this._version}_getPosAttritute(){return this.data[this.desc.positionAttribute]}_prepareData(t){if(!this.data)return;const e=this._buffers||{};for(const r in this.data){const n=this.data[r];if(n)if(n.buffer&&n.buffer.destroy){const e=n.buffer;e[_x]||(e[_x]=0),t&&e[_x]++}else if(n&&n.array)if($v(n)){let t=n.array.buffer.__id;t||(t=n.array.buffer.__id=xx++),this.data[r]={buffer:t,offset:n.byteOffset,stride:n.byteStride,type:Ax[n.componentType],size:n.itemSize,count:n.count,componentType:n.componentType},e[t]||(e[t]={data:n.array.buffer})}else this.data[r]=n.array}this._buffers=e;const n=this.elements;n&&n.array&&(this.elements=n.array)}getAttrData(t){const e=t.key,n=!this._reglData||!this._reglData[e];if(this._reglData||(this._reglData={}),n){const t=this._reglData[e]={},n=this.data,{positionAttribute:r,normalAttribute:i,uv0Attribute:o,uv1Attribute:s,tangentAttribute:a,color0Attribute:l,pickingIdAttribute:h,textureCoordMatrixAttribute:u}=this.desc;Hv(t,this.data),t.aPosition=n[r],n[i]&&(t.aNormal=n[i]),n[o]&&(t.aTexCoord=n[o]),n[s]&&(t.aTexCoord1=n[s]),n[a]&&(t.aTangent=n[a]),n[l]&&(t.aColor0=n[l]),n[h]&&(t.aPickingId=n[h]),n[u]&&(t.aTextureCoordMatrix=n[u])}return this._reglData[e]}getREGLData(t,e,n){this.getAttrData(e);const r=!this._reglData||!this._reglData[e.key];if(Xv(t)&&!n){const n=e&&e.key||"default";if(!this._vao[n]||r||this._vao[n].dirty){const r=this._reglData[e.key],i=this._vertexCount,o=[];for(let t=0;t<e.length;t++){const n=e[t].name,s=r[n]&&r[n].buffer;if(s&&s.destroy)o.push(void 0!==r[n].stride?r[n]:s);else{const t=r[n];if(!t){o.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*i):mx);continue}const e=(t.data&&Gv(t.data)?t.data.length:t.length)/i;t.data?(t.dimension=e,o.push(t)):o.push({data:t,dimension:e})}}const s={attributes:o,primitive:this.getPrimitive()};if(this.elements&&!Uv(this.elements))if(this.elements.destroy)s.elements=this.elements;else{s.elements={primitive:this.getPrimitive(),data:this.elements};const t=this.getElementsType(this.elements);t&&(s.elements.type=t)}this._vao[n]?this._vao[n].vao(s):this._vao[n]={vao:t.vao(s)}}return delete this._vao[n].dirty,this._vao[n]}return this._reglData[e.key]}_isAttrChanged(t){if(t===this._activeAttributes)return!1;if(t.length!==this._activeAttributes.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==this._activeAttributes[e])return!0;return!1}generateBuffers(t){const e=this._buffers;for(const a in e)e[a].buffer||(e[a].buffer=t.buffer(e[a].data)),delete e[a].data;const n=this.desc.positionAttribute,r=this.desc.altitudeAttribute,i=this.data,o=this._vertexCount,s={};for(const a in i)if(i[a]){if(void 0===i[a].buffer||i[a].buffer instanceof ArrayBuffer){const e=i[a].data?i[a]:{data:i[a]};e.dimension=(i[a].data?i[a].data:i[a]).length/o;const l=t.buffer(e);l[_x]=1,s[a]={buffer:l},a!==n&&a!==r||(s[a].array=i[a])}else i[a].buffer.destroy?s[a]=i[a]:e[i[a].buffer]&&(s[a]=Hv({},i[a]),s[a].buffer=e[i[a].buffer].buffer);(this.desc.static||a!==n)&&delete i[a].array}if(this.data=s,delete this._reglData,this.elements&&!Uv(this.elements)){const e={primitive:this.getPrimitive(),data:this.elements},n=this.getElementsType(this.elements);if(n&&(e.type=n),!this.desc.static&&!this.elements.destroy){const t=this.elements;this.indices=new Uint16Array(t.length);for(let e=0;e<t.length;e++)this.indices[e]=t[e]}this.elements=this.elements.destroy?this.elements:t.elements(e);const r=this.elements;r[_x]||(r[_x]=0),r[_x]++}}getVertexCount(){const{positionAttribute:t,positionSize:e,color0Attribute:n}=this.desc;let r=this.data[t];r.data&&(r=r.data),r.array&&(r=r.array),Gv(r)?this._vertexCount=Math.ceil(r.length/e):r&&void 0!==r.count&&(this._vertexCount=r.count);const i=n;if(this.data[i]){const t=this.data[i].data||this.data[i].array||this.data[i];Array.isArray(t)?this._color0Size=t.length/this._vertexCount:t&&t.count?this._color0Size=t.count/this._vertexCount:this.data[i].buffer&&this.data[i].buffer.destroy&&(this._color0Size=this.data[i].buffer._buffer.dimension)}return this._vertexCount}getColor0Size(){return this._color0Size||0}addBuffer(t,e){return this._buffers[t]={data:e},delete this._reglData,this._deleteVAO(),this}updateBuffer(t,e){if(!this._buffers[t])throw new Error(`invalid buffer ${t} in geometry`);return this._buffers[t].buffer?this._buffers[t].buffer.subdata(e):this._buffers[t].data=e,delete this._reglData,this._deleteVAO(),this}deleteData(t){const e=this.data[t];return e?(this._incrVersion(),e.buffer&&e.buffer.destroy&&e.buffer.destroy(),delete this.data[t],delete this._reglData,this._markVAODirty(!1),this):this}updateData(t,e){const n=this.data[t];if(!n)return this;let r;return this._incrVersion(),this.data[t]=e,n.buffer&&n.buffer.destroy&&(r=n),t===this.desc.positionAttribute&&this.updateBoundingBox(),this.getVertexCount(),r&&(r.buffer(e),this.data[t]=r),this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}updateSubData(t,e,n){const r=this.data[t];if(!r)return this;let i;if(this._incrVersion(),r.buffer&&r.buffer.destroy&&(i=r),t===this.desc.positionAttribute&&this._updateSubBoundingBox(e),i){const t=yx[i.buffer._buffer.dtype];if(e.BYTES_PER_ELEMENT!==t){e=new(s=t,(o=e)instanceof Uint8Array||o instanceof Uint16Array||o instanceof Uint32Array||o instanceof Uint8ClampedArray?1===s?Uint8Array:2===s?Uint16Array:Uint32Array:o instanceof Int8Array||o instanceof Int16Array||o instanceof Int32Array?1===s?Int8Array:2===s?Int16Array:Int32Array:o instanceof Float32Array||o instanceof Float64Array?4===s?Float32Array:Float64Array:null)(e)}i.buffer.subdata(e,n*t)}else{const r=this.data[t].data?this.data[t].data:this.data[t];for(let t=0;t<e.length;t++)r[n+t]=e[t]}var o,s;return this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(t,e){if(!t)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;return this.count=void 0===e?wx(t):e,this.elements=t&&t.destroy?t:n.destroy?n(t):t,this._markVAODirty(!0),this}deleteElements(){return this.elements&&0!==this.elements.length?(this._incrVersion(),this.elements&&this.elements.destroy&&!this.elements[lx]&&(this.elements.destroy(),this.elements[lx]=1),this.elements=[],this._markVAODirty(!0),this):this}_markVAODirty(t){if(this._vao){for(const e in this._vao)t?this._vao[e].vao.destroy():this._vao[e].dirty=!0;t&&(this._vao={})}}setDrawCount(t){return this._incrVersion(),this.count1=t,this}getDrawCount(){return this.count1>=0?this.count1:this.count}setDrawOffset(t){return this._incrVersion(),this.offset=t,this}getDrawOffset(){return this.offset||0}dispose(){if(this._deleteVAO(),this._forEachBuffer((t=>{if(!t[lx]){let e=t[_x];e&&e--,e<=0?(t[lx]=!0,t.destroy()):t[_x]=e}})),this.properties){const t=this.properties.oldElementsBeforeHighlight;t&&!t[lx]&&t.destroy&&(t.destroy(),t[lx]=!0),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible}this.data={},this._buffers={},delete this._reglData,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}isDisposed(){return!!this._disposed}updateBoundingBox(){let t=this.boundingBox;t||(t=this.boundingBox=new gx);let e,n,r=this.data[this.desc.positionAttribute];if(Gv(r)||(r.data?r=r.data:tx(r)?r=this._getAttributeData(this.desc.positionAttribute):r.array&&(e=r.min,n=r.max,r=r.array)),r&&r.length){const i=t.min,o=t.max;if(e&&n)Lm(i,...e),Lm(o,...n);else{Lm(i,r[0],r[1],r[2]),Lm(o,r[0],r[1],r[2]);for(let t=3;t<r.length;){const e=r[t++],n=r[t++],s=r[t++];e<i[0]&&(i[0]=e),n<i[1]&&(i[1]=n),s<i[2]&&(i[2]=s),e>o[0]&&(o[0]=e),n>o[1]&&(o[1]=n),s>o[2]&&(o[2]=s)}}t.updateVertex(),t.dirty()}}_updateSubBoundingBox(t){const e=this.boundingBox,n=e.min,r=e.max,i=this.desc.positionSize;for(let o=0;o<t.length;){const e=t[o++],s=t[o++];let a=0;3===i&&(a=t[o++]),e<n[0]&&(n[0]=e),s<n[1]&&(n[1]=s),a<n[2]&&(n[2]=a),e>r[0]&&(r[0]=e),s>r[1]&&(r[1]=s),a>r[2]&&(r[2]=a)}e.updateVertex(),e.dirty()}_getAttributeData(t){const e=this.data[t]&&this.data[t].array?this.data[t].array:this.data[t],n=e.buffer;if(tx(e)){const r=this._buffers[n]?this._buffers[n].data:e.array,{count:i,size:o,stride:s,offset:a,componentType:l}=e,h=gg.getTypedArrayCtor(l);if((0===s||s===o*h.BYTES_PER_ELEMENT)&&a%h.BYTES_PER_ELEMENT==0)return new h(r,a,i*o);if(t===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<o*i?(this._tempPosArray=new h(o*i),gg.readInterleavedArray(this._tempPosArray,r,i,o,s,a,l)):this._posDirty?(this._posDirty=!1,gg.readInterleavedArray(this._tempPosArray,r,i,o,s,a,l)):this._tempPosArray;{const t=new h(o*i);return gg.readInterleavedArray(t,r,i,o,s,a,l)}}return e}createTangent(t="aTangent"){this._incrVersion();const{normalAttribute:e,positionAttribute:n,uv0Attribute:r}=this.desc,i=this._getAttributeData(e),o=kv(this._getAttributeData(n),i,this.data[r],this.elements),s=this.data[t]=new Float32Array(o.length),a=[0,0,0,0],l=[0,0,0],h=[0,0,0,0];for(let u=0;u<o.length;u+=4){const t=u/4*3;Lm(l,i[t],i[t+1],i[t+2]),cA(a,o[u],o[u+1],o[u+2],o[u+3]),bv(h,l,a),uA(s.subarray(u,u+4),h)}delete this._reglData}createNormal(t="aNormal"){this._incrVersion();const e=this._getAttributeData(this.desc.positionAttribute);this.data[t]=Tv(e.array||e,this.elements),delete this._reglData}createBarycentric(t="aBarycentric"){if("triangles"!==this.desc.primitive)throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const e=new Uint8Array(3*this._vertexCount);for(let n=0,r=this.elements.length;n<r;)for(let t=0;t<3;t++)e[3*this.elements[n++]+t]=1;this.data[t]=e,delete this._reglData}buildUniqueVertex(){this._incrVersion();const t=this.data,e=this.elements;if(!Gv(e))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(t),r={};let i=t[this.desc.positionAttribute];if(i=i.length?i:i.array,!Gv(i))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const o=this._vertexCount,s=e.length;for(let l=0;l<n.length;l++){const e=n[l],i=Gv(t[e])?t[e]:t[e].array,a=i.length/o;if(!Gv(i))throw new Error(e+" must be array to build unique vertex.");r[e]=i,t[e]=new i.constructor(s*a)}let a=0;for(let l=0;l<s;l++){const i=e[l];for(let e=0;e<n.length;e++){const s=n[e],l=t[s],h=r[s].length/o;for(let t=0;t<h;t++)l[a*h+t]=r[s][i*h+t]}e[l]=a++}i=this.data[this.desc.positionAttribute],this._vertexCount=Math.ceil(i.length/this.desc.positionSize),delete this._reglData}getMemorySize(){let t=0;for(const e in this.data)Zv(this.data,e)&&(t+=Yv(this.data[e]));if(this.elements){const e=this.elements;e.destroy?t+=e._elements.buffer.byteLength:e.BYTES_PER_ELEMENT?t+=e.length*e.BYTES_PER_ELEMENT:e.length&&(t+=4*e.length)}return t}_deleteVAO(){for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}_forEachBuffer(t){this.elements&&this.elements.destroy&&t(this.elements);for(const e in this.data)Zv(this.data,e)&&this.data[e]&&this.data[e].buffer&&this.data[e].buffer.destroy&&t(this.data[e].buffer);for(const e in this._buffers)Zv(this._buffers,e)&&this._buffers[e]&&this._buffers[e].buffer&&this._buffers[e].buffer.destroy&&t(this._buffers[e].buffer)}getElementsType(t){return t instanceof Uint8Array?"uint8":t instanceof Uint16Array?"uint16":t instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}};function wx(t){if(Uv(t))return t;if(void 0!==t.count)return t.count;if(t.destroy)return t._elements.vertCount;if(void 0!==t.length)return t.length;if(t.data)return t.data.length;throw new Error("invalid elements length")}const Tx=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function Mx(t){return Tx[t]}const Cx={5121:"uint8",5123:"uint16",5125:"uint32",5126:"float",36193:"half float"};function Sx(t){return Cx[t]}const Ix={6406:"alpha",6407:"rgb",6408:"rgba",6409:"luminance",6410:"luminance alpha",33776:"rgb s3tc dxt1",33777:"rgba s3tc dxt1",33778:"rgba s3tc dxt3",33779:"rgba s3tc dxt5",35840:"rgb pvrtc 4bppv1",35841:"rgb pvrtc 2bppv1",35842:"rgba pvrtc 4bppv1",35843:"rgba pvrtc 2bppv1",35986:"rgb atc",35987:"rgba atc explicit alpha",34798:"rgba atc interpolated alpha",36196:"rgb etc1"};function Px(t){return Ix[t]}const Ex={9729:"linear",9728:"nearest"};function Ox(t){return Ex[t]}const Rx={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function kx(t){return Rx[t]}const Lx={10497:"repeat",33071:"clamp",33648:"mirror"};function Dx(t){return Lx[t]}const Nx="__reshader_webgl_buffer",Fx="__reshader_webgl_tex";function zx(t,e,n){let r;if(Gv(e)?e.buffer&&void 0!==e.byteOffset&&(r=e):e.array&&e.array.buffer&&void 0!==e.array.byteOffset&&(r=e.array),!r)return null;const i=r.buffer,o=r.byteOffset;i[Nx]||(i[Nx]={});let s=i[Nx][o];if(!s){const e={};n&&Hv(e,n),e.data=r,s=t.buffer(e),i[Nx][o]=s}return s}function Bx(t,e){const n=e.data;if(!n||!n.buffer)return t.texture(e);const r=n.buffer,i=n.byteOffset;r[Fx]||(r[Fx]={});let o=r[Fx][i];return o||(o=t.texture(e),r[Fx][i]=o),o}var Hx=Object.freeze({__proto__:null,getMaterialFormat:Px,getMaterialType:Sx,getPrimitive:Mx,getTextureMagFilter:Ox,getTextureMinFilter:kx,getTextureWrap:Dx,getUniqueREGLBuffer:zx,getUniqueTexture:Bx});const jx=[0,0,0],Ux=[0,0,0],Vx=[0,0,0],Gx=[],Wx=[],qx=[],Xx=["a","b","c"];let Zx=class extends bx{constructor(t,e,n,r){super(t,e,n,{primitive:Mx(1),positionAttribute:r.positionAttribute})}_getPosAttritute(){const t=this.data[this.desc.positionAttribute];if(!t.length)return[];const e=Math.pow(10,4),n=Math.cos(Math.PI/180*.8),r=this.elements,i=t.length?t:t.array,o=r.length?r?r.length:i.length/3:r,s=[0,0,0],a=new Array(3),l={},h=[],u=new Yx;for(let c=0;c<o;c+=3){r.length?(s[0]=r[c],s[1]=r[c+1],s[2]=r[c+2]):(s[0]=c,s[1]=c+1,s[2]=c+2),u.a=Jx(Gx,i,s[0]),u.b=Jx(Wx,i,s[1]),u.c=Jx(qx,i,s[2]);const t=u.getNormal(),o=u.a,f=u.b,d=u.c;if(a[0]=`${Math.round(o[0]*e)},${Math.round(o[1]*e)},${Math.round(o[2]*e)}`,a[1]=`${Math.round(f[0]*e)},${Math.round(f[1]*e)},${Math.round(f[2]*e)}`,a[2]=`${Math.round(d[0]*e)},${Math.round(d[1]*e)},${Math.round(d[2]*e)}`,a[0]!==a[1]&&a[1]!==a[2]&&a[2]!==a[0])for(let e=0;e<3;e++)this._calEdgeData(e,s,u,l,a,n,t,h)}for(const c in l)if(l[c]){const{index0:t,index1:e}=l[c];h.push(i[3*t],i[3*t+1],i[3*t+2]),h.push(i[3*e],i[3*e+1],i[3*e+2])}return this.elements=this._createElements(h),h}_calEdgeData(t,e,n,r,i,o,s,a){const l=(t+1)%3,h=i[t],u=i[l],c=n[Xx[t]],f=n[Xx[l]],d=`${h}_${u}`,p=`${u}_${h}`;p in r&&r[p]?(Wm(s,r[p].normal)<=o&&(a.push(c[0],c[1],c[2]),a.push(f[0],f[1],f[2])),r[p]=null):d in r||(r[d]={index0:e[t],index1:e[l],normal:km([0,0,0],s)})}_createElements(t){const e=[],n=t.length/3;for(let r=0;r<n;r++)e.push(r);return e}},Yx=class{constructor(t=[0,0,0],e=[0,0,0],n=[0,0,0]){this.a=t,this.b=e,this.c=n}getNormal(){const t=Km(jx,this.a,this.b),e=Km(Ux,this.a,this.c);qm(Vx,t,e);const n=Om(Vx);return Lm(Vx,Vx[0]/n,Vx[1]/n,Vx[2]/n)}};function Jx(t,e,n){return Lm(t,e[3*n],e[3*n+1],e[3*n+2])}let Qx=class{},Kx=class extends(ax(Qx)){constructor(t={},e){super(),this._version=0,this._propVerion=0,this.uniforms=jv({},e||{},t);for(const n in t){const e=Object.getOwnPropertyDescriptor(t,n).get;e&&Object.defineProperty(this.uniforms,n,{get:e})}this.unlit=!1,this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=(...t)=>this._onTextureComplete.call(this,...t),this._genUniformKeys(),this._checkTextures()}set version(t){throw new Error("Material.version is read only.")}get version(){return this._version}get propVersion(){return this._propVerion}set doubleSided(t){this.uniforms.doubleSided=t}get doubleSided(){return!!this.uniforms.doubleSided}isReady(){return this._loadingCount<=0}set(t,e){const n=Fv(this.uniforms[t])&&!Fv(e)||!Fv(this.uniforms[t])&&Fv(e);if(this.uniforms[t]&&this.isTexture(t)&&this.uniforms[t].dispose(),Fv(e))Fv(this.uniforms[t])||delete this.uniforms[t];else if(this.uniforms[t]=e,this._reglUniforms){const n=Object.getOwnPropertyDescriptor(this._reglUniforms,t);n&&!n.get&&(this._propVerion++,this._reglUniforms[t]=e)}return this.isTexture(t)&&this._checkTextures(),n&&(this._genUniformKeys(),this._incrVersion()),this}setFunctionUniform(t,e){return this._genUniformKeys(),this._incrVersion(),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,t)}get(t){return this.uniforms[t]}isDirty(){return this._uniformVer!==this.version}appendDefines(t,e){const n=this.uniforms;return n?(n.jointTexture&&(t.HAS_SKIN=1),n.morphWeights1&&(t.HAS_MORPH=1),(n.khr_offset||n.khr_rotation||n.khr_scale)&&(t.HAS_KHR_TEXTURE_TRANSFORM=1),t):t}hasSkinAnimation(){return!!(this.uniforms&&this.uniforms.jointTexture&&this.uniforms.skinAnimation)}getUniforms(t){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const e=this.uniforms,n={};for(const r in e)this.isTexture(r)?Object.defineProperty(n,r,{enumerable:!0,configurable:!0,get:function(){return e[r].getREGLTexture(t)}}):Object.getOwnPropertyDescriptor(e,r).get?Object.defineProperty(n,r,{enumerable:!0,configurable:!0,get:function(){return e[r]}}):n[r]=e[r];return this._reglUniforms=n,this._uniformVer=this.version,n}isTexture(t){return this.uniforms[t]instanceof fx}dispose(){for(const t in this.uniforms){const e=this.uniforms[t];e&&(e.dispose?e.dispose():e.destroy&&!e[lx]&&(e.destroy(),e[lx]=!0))}delete this.uniforms,delete this._reglUniforms,delete this._bindedOnTextureComplete,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const t in this.uniforms)if(this.isTexture(t)){const e=this.uniforms[t];e.isReady()||(this._loadingCount++,e.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const t=[];for(const e in this.uniforms)Zv(this.uniforms,e)&&!Fv(this.uniforms[e])&&t.push(e);this._uniformKeys=t.join()}_incrVersion(){this._version++}getMemorySize(){const t=this.uniforms;let e=0;for(const n in t)this.isTexture(n)?e+=t[n].getMemorySize():this.uniforms[n]&&this.uniforms[n].destroy&&(e+=Jv(this.uniforms[n]));return e}};const $x={time:0,seeThrough:!0,thickness:.03,fill:[1,.5137254902,.98,1],stroke:[.7019607843,.9333333333,.2274509804,1],dashEnabled:!1,dashAnimate:!1,dashRepeats:1,dashLength:.8,dashOverlap:!0,insideAltColor:!1,squeeze:!1,squeezeMin:.5,squeezeMax:1,dualStroke:!1,secondThickness:.05,opacity:1,noiseEnable:!1};const t_={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0],alphaTest:0};let e_=class t extends Kx{constructor(t){super(t,t_)}static convertFrom(e){const n={};for(const t in t_)n[t]=e.get(t);return new t(n)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t):t}};const n_={baseColorFactor:[1,1,1,1],uvScale:[1,1],uvOffset:[0,0],opacity:1,envMapExposure:128,emissiveFactor:[.1,.1,.1],specularFactor:[0,0,0],envRotationSin:0,envRotationCos:1,reflectivity:.01,themingColor:[0,0,0,0],exposureBias:.6};let r_=class extends Kx{constructor(t){super(t,n_)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t.ALPHATEST=.01,t.GAMMA_INPUT=1,t.GAMMA_FACTOR=1,t.TONEMAP_OUTPUT=1,t.ENVMAP_MODE_REFLECTION=1,t.ENV_RGBM=1,t.IRR_RGBM=1,t):t}};const i_={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null};function o_(t){return class extends t{constructor(...t){let e=t[0];e=Hv({},i_,e||{}),super(e,t)}appendDefines(t,e){if(super.appendDefines(t,e),t.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!e.data[e.desc.uv0Attribute])return t;const n=this.uniforms;return n.diffuseTexture&&(t.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(t.HAS_SPECULARGLOSSINESS_MAP=1),(t.HAS_SPECULARGLOSSINESS_MAP||t.HAS_DIFFUSE_MAP)&&(t.HAS_MAP=1),t}}}let s_=class extends(o_(e_)){};const a_=new Array(16);let l_=0,h_=class{constructor(t,e,n={}){this._version=0,this._geometry=t,this._material=e,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this._castShadow=Fv(n.castShadow)||n.castShadow,this.needUpdateShadow=!1,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=im(new Array(16)),this._positionMatrix=im(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:l_++}),l_>Number.MAX_VALUE-10&&(l_=0)}set material(t){this._material!==t&&this.setMaterial(t)}get material(){return this._material}set version(t){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(t){this._geometry!==t&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=t}set localTransform(t){this._prevTMat||(this._prevTMat=new Array(16)),Array.isArray(t)&&!Cm(this._prevTMat,t)&&(this._incrVersion(),this._prevTMat=rm(this._prevTMat,t)),this._localTransform=t}get localTransform(){return Bv(this._localTransform)?this._localTransform():this._localTransform}set positionMatrix(t){this._prevPMat||(this._prevPMat=new Array(16)),Array.isArray(t)&&!Cm(this._prevPMat,t)&&(this._incrVersion(),this._prevPMat=rm(this._prevPMat,t)),this._positionMatrix=t}get positionMatrix(){return Bv(this._positionMatrix)?this._positionMatrix():this._positionMatrix}get config(){return this._options||(this._options={}),this._options.transparent=this.transparent,this._options.castShadow=this.castShadow,this._options.bloom=this.bloom,this._options.ssr=this.ssr,this._options.picking=this.picking,this._options}get defines(){return this._getDefines()}set defines(t){this.setDefines(t)}get castShadow(){return this._castShadow&&(!this.material||!this.material.unlit)}set castShadow(t){this._castShadow=t}setMaterial(t){return this._material=t,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(t){return this.parent=t,this}setLocalTransform(t){return this.localTransform=t,this}setPositionMatrix(t){this.positionMatrix=t}setUniform(t,e){return this._updateUniformState(t),this.uniforms[t]=e,this}setFunctionUniform(t,e){return this._updateUniformState(t),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,t)}_updateUniformState(t){void 0===this.uniforms[t]?this._dirtyUniforms=!0:(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(t))}getUniform(t){return this.uniforms[t]}getDefines(){const t={};return Hv(t,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(t,this._geometry),t}_getDefines(){this._defines||(this._defines={});const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],r=t.data[t.desc.normalAttribute];return e&&e.quantization&&(this._defines.HAS_DRACO_POSITION=1),n&&n.quantization&&(this._defines.HAS_DRACO_TEXCOORD=1),r&&r.quantization&&(this._defines.HAS_DRACO_NORMAL=1),this._defines}setDefines(t){const e=this._bakDefines;return this._defines=t,this.dirtyDefines=this.dirtyDefines||!!e!=!!t||!function(t,e){if(!t&&!e)return!0;const n=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(e);if(n.length!==r.length)return!1;for(let i=0;i<n.length;i++)if(t[n[i]]!==e[n[i]])return!1;return!0}(e,t),this.dirtyDefines&&(this._bakDefines=Hv({},t)),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(t){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let t=this._getDefinesKey();t+="_"+(Uv(this.getElements())?"count":"elements"),t+="_"+ +!!this.disableVAO,this._material&&(t+="_"+ +!!this._material.doubleSided),this._commandKey=t,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getUniforms(t){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){this._uniformDescriptors=new Set,this._realUniforms={},this._prepareUniformsForDraco();const e=this.uniforms;for(const t in this.uniforms)Zv(this.uniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?(this._uniformDescriptors.add(t),Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}})):this._realUniforms[t]=e[t]);if(this._material){const e=this._material.getUniforms(t);for(const t in e)Zv(e,t)&&!Zv(this._realUniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?(this._uniformDescriptors.add(t),Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}})):void 0===this._realUniforms[t]&&(this._realUniforms[t]=e[t]))}this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version,this._materialPropVer=this._material&&this._material.propVersion,this._dirtyProps=null}else if(this._dirtyProps||this._material&&this._material.propVersion!==this._materialPropVer){if(this._dirtyProps)for(const t of this._dirtyProps)this._realUniforms[t]=this.uniforms[t];if(this._material&&this._material.propVersion!==this._materialPropVer){const e=this._material.getUniforms(t);for(const t in e)Zv(e,t)&&!this._uniformDescriptors.has(t)&&(Object.getOwnPropertyDescriptor(e,t).get||this._realUniforms[t]===e[t]||(this._realUniforms[t]=e[t]));this._materialPropVer=this._material.propVersion}this._dirtyProps=null}return this._realUniforms.modelMatrix=this.localTransform,this._realUniforms.positionMatrix=this.positionMatrix,this._realUniforms}_prepareUniformsForDraco(){const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],r=t.data[t.desc.normalAttribute];if(e&&e.quantization){const t=e.quantization,n=t.range/(1<<t.quantizationBits);this._realUniforms.minValues_pos=t.minValues,this._realUniforms.gltf_u_dec_position_normConstant=n}if(n&&n.quantization){const t=n.quantization;this._realUniforms.minValues_tex=t.minValues,this._realUniforms.gltf_u_dec_texcoord_0_normConstant=t.range/(1<<t.quantizationBits)}r&&r.quantization&&(this._realUniforms.gltf_u_dec_normal_rangeConstant=(1<<r.quantization.quantizationBits)-1)}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}_getREGLAttrData(t,e){return this._geometry.getREGLData(t,e,this.disableVAO)}getREGLProps(t,e){const n=this.getUniforms(t);return Hv(n,this._getREGLAttrData(t,e)),Xv(t)&&!this.disableVAO||(n.elements=this._geometry.getElements()),n.meshProperties=this.properties,n.geometryProperties=this._geometry.properties,n.meshConfig=this.config,n.count=this._geometry.getDrawCount(),n.offset=this._geometry.getDrawOffset(),n.primitive=this._geometry.getPrimitive(),n}dispose(){return delete this._geometry,delete this._material,this.uniforms=null,this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._geometry?(this._bbox||this.updateBoundingBox(),am(a_,this.localTransform,this.positionMatrix),Cm(a_,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr):null}updateBoundingBox(){const t=this._geometry.boundingBox;this._bbox||(this._bbox=new gx),this._bboxArr||(this._bboxArr=[[0,0,0],[0,0,0]]),this._geoBox||(this._geoBox=new gx),gx.copy(this._bbox,t),this._bbox.updateVertex(),"InstancedMesh"===this.constructor.name?(this._bbox.transform(this.localTransform,this.positionMatrix),this._currentTransform=am(this._currentTransform||new Array(16),this.positionMatrix,this.localTransform)):(this._bbox.transform(this.positionMatrix,this.localTransform),this._currentTransform=am(this._currentTransform||new Array(16),this.localTransform,this.positionMatrix)),gx.copy(this._geoBox,t),km(this._bboxArr[0],this._bbox.min),km(this._bboxArr[1],this._bbox.max)}_createDefinesKey(t){const e=[];for(const n in t)e.push(n,t[n]);return e.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}getWorldTransform(){const t=this.parent;return t?am(new Array(16),t.getWorldTransform(),this.localTransform):this.localTransform}},u_=class extends h_{constructor(t,e,n,r,i={}){super(n,r,i),this._instanceCount=e,this.instancedData=t||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(t){this._incrVersion(),this._instanceCount=t}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let t=0;for(const e in this.instancedData)Zv(this.instancedData,e)&&(t+=Yv(this.instancedData[e]));return t}_checkInstancedProp(){for(const t in this.instancedData)if(this.geometry.data[t])throw new Error(`Duplicate attribute ${t} defined in geometry and instanced data`)}_getREGLAttrData(t,e){const n=this.geometry.getAttrData(e);if(Xv(t)){const r=e.key;if(!this._vao[r]||this._vao[r].dirty){const i=e.map((t=>t.name)),o=[];for(let t=0;t<i.length;t++){const e=n[i[t]];o.push(e&&e.buffer||this.instancedData[i[t]])}const s={attributes:o,primitive:this.geometry.getPrimitive()};this._vao[r]?this._vao[r].vao(s):this._vao[r]={vao:t.vao(s)},delete this._vao[r].dirty}return this._vao[r]}return n}getDefines(){const t=super.getDefines();return t.HAS_INSTANCE=1,t}getCommandKey(t){return"i_"+super.getCommandKey(t)}updateInstancedData(t,e){const n=this.instancedData[t];if(!n)return this;if(this._incrVersion(),this.instancedData[t]=e,n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._vao)for(const r in this._vao)this._vao[r].dirty=!0;return this}generateInstancedBuffers(t){const e=this.instancedData,n={};for(const r in e){if(!e[r])continue;const i=e[r];void 0!==i.buffer&&i.buffer.destroy?(n[r]=i,n[r].divisor&&(n[r].divisor=1)):n[r]=e[r].destroy?{buffer:e[r],divisor:1}:{buffer:t.buffer({data:e[r],dimension:e[r].length/this._instanceCount}),divisor:1}}return this.instancedData=n,this}getREGLProps(t,e){const n=super.getREGLProps(t,e);return Xv(t)||Hv(n,this.instancedData),n.elements=this.geometry.getElements(),n.instances=this._instanceCount,n}disposeInstancedData(){const t=this.instancedData;if(t)for(const e in t){if(!t[e])continue;const n=t[e].destroy?t[e]:t[e].buffer;n.destroy&&!n[lx]&&(n[lx]=1,n.destroy())}this.instancedData={};for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}};const c_={};let f_=class{constructor(t){this.regl=t}render(t,e,n,r){t.setUniforms(e||c_),t.setFramebuffer(r);let i=0;if(n){const{opaques:e,transparents:r}=n.getSortedMeshes();i+=t.draw(this.regl,e),i+=t.draw(this.regl,r)}else i+=t.draw(this.regl);return i}clear(t){this.regl.clear(t)}};const d_={getArrayBuffer:(t,e)=>d_.get(t,{responseType:"arraybuffer"},e),get:function(t,e,n){const r=d_._getClient(n);if(r.open("GET",t,!0),e){for(const t in e.headers)r.setRequestHeader(t,e.headers[t]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(null),r},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(I6){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){}}}return e.onreadystatechange=d_._wrapCallback(e,t),e}};let p_=class{constructor(t,e){this.defaultTexture=t,this.defaultCubeTexture=new Array(6),this.urlModifier=e,this.resources={}}setURLModifier(t){this.urlModifier=t}get(t){return Array.isArray(t)?this._loadImages(t):this._loadImage(t)}getArrayBuffer(t){if(Array.isArray(t)){const e=t.map((t=>this.getArrayBuffer(t)));return Promise.all(e)}return new Promise(((e,n)=>{let r=t;this.urlModifier&&(r=this.urlModifier(t)),d_.getArrayBuffer(r,((r,i)=>{r?n(r):e({url:t,data:i})}))}))}disposeRes(t){return Array.isArray(t)?t.forEach((t=>this._disposeOne(t))):this._disposeOne(t),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(t){return Array.isArray(t)?this._getBlankTextures(t.length):this.defaultTexture}_disposeOne(t){const e=this.resources;e[t]&&(e[t].count--,e[t].count<=0&&delete e[t])}_loadImage(t){const e=this.resources;return e[t]?Promise.resolve({url:t,data:e[t].image}):new Promise(((n,r)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=function(){e[t]={image:i,count:1},n({url:t,data:i})},i.onerror=function(t){r(t)},i.onabort=function(){r(`image(${t}) loading aborted.`)},i.src=this.urlModifier?this.urlModifier(t):t}))}_loadImages(t){const e=t.map((t=>this._loadImage(t)));return Promise.all(e)}_getBlankTextures(t){const e=new Array(t);for(let n=0;n<6;n++)e.push(this.defaultTexture);return e}},g_=class extends(ax(p_)){};const m_=[0,0,0],A_=[0,0,0];let y_,v_=0;function x_(t,e){return Xm(m_,t.geometry.boundingBox.getCenter(),t.localTransform),Xm(A_,e.geometry.boundingBox.getCenter(),e.localTransform),eA(A_,y_)-eA(m_,y_)}let __=class{constructor(t){this._id=v_++,this.sortedMeshes={},this.setMeshes(t),this.dirty()}setMeshes(t){if(this.clear(),!t||Array.isArray(t)&&!t.length||t===this.meshes)return this;t=Array.isArray(t)?t:[t],this.meshes=[];for(let e=0;e<t.length;e++){const n=t[e];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t))t.forEach((t=>{const e=t._scenes=t._scenes||{};e[this._id]||(e[this._id]=1,this.meshes.push(t),this.dirty())}));else{const e=t._scenes=t._scenes||{};e[this._id]||(e[this._id]=1,this.meshes.push(t),this.dirty())}return this}removeMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t)){let e=!1;for(let n=0;n<t.length;n++){const r=t[n]._scenes;r&&r[this._id]&&(e=!0,this.dirty(),delete r[this._id])}e&&(this.meshes=this.meshes.filter((e=>t.indexOf(e)<0)))}else{const e=t._scenes;if(!e||!e[this._id])return this;const n=this.meshes.indexOf(t);n>=0&&this.meshes.splice(n,1),delete e[this._id],this.dirty()}return this}getMeshes(){return this.meshes||[]}clear(){if(this.meshes)for(let t=0;t<this.meshes.length;t++)delete this.meshes[t]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(t){const e=this.meshes;this.sortFunction&&e.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const t=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let r=0,i=e.length;r<i;r++)e[r].transparent?n.push(e[r]):t.push(e[r])}t&&n.length>1&&(y_=t,n.sort(x_)),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes||{}}};const b_=String.fromCharCode,w_=8,T_=32767;function M_(t,e,n,r){if(t[3]>0){const i=Math.pow(2,t[3]-128-8+r);e[n+0]=t[0]*i,e[n+1]=t[1]*i,e[n+2]=t[2]*i}else e[n+0]=0,e[n+1]=0,e[n+2]=0;return e[n+3]=1,e}function C_(t,e,n,r){let i=0,o=0,s=r;for(;s>0;)if(t[o][0]=e[n++],t[o][1]=e[n++],t[o][2]=e[n++],t[o][3]=e[n++],1===t[o][0]&&1===t[o][1]&&1===t[o][2]){for(let e=t[o][3]<<i>>>0;e>0;e--)(l=t[o])[0]=(a=t[o-1])[0],l[1]=a[1],l[2]=a[2],l[3]=a[3],o++,s--;i+=8}else o++,s--,i=0;var a,l;return n}function S_(t,e,n,r){if(r<w_|r>T_)return C_(t,e,n,r);let i=e[n++];if(2!==i)return C_(t,e,n-1,r);if(t[0][1]=e[n++],t[0][2]=e[n++],i=e[n++],(t[0][2]<<8>>>0|i)>>>0!==r)return null;for(let o=0;o<4;o++)for(let i=0;i<r;){let r=e[n++];if(r>128){r=(127&r)>>>0;const s=e[n++];for(;r--;)t[i++][o]=s}else for(;r--;)t[i++][o]=e[n++]}return n}function I_(t,e=0){const n=new Uint8Array(t),r=n.length;if("#?"!==function(t){let e="";for(let n=0;n<2;n++)e+=b_(t[n]);return e}(n))return null;for(var i=2;i<r&&("\n"!==b_(n[i])||"\n"!==b_(n[i+1]));i++);if(i>=r)return null;i+=2;let o="";for(;i<r;i++){const t=b_(n[i]);if("\n"===t)break;o+=t}const s=o.split(" "),a=parseInt(s[1]),l=parseInt(s[3]);if(!l||!a)return null;let h=i+1;const u=[];for(let d=0;d<l;d++){u[d]=[];for(let t=0;t<4;t++)u[d][t]=0}const c=new Float32Array(l*a*4);let f=0;for(let d=0;d<a;d++){if(h=S_(u,n,h,l),!h)return null;for(let t=0;t<l;t++)M_(u[t],c,f,e),f+=4}return{width:l,height:a,pixels:c}}const P_=function(){const t=new ArrayBuffer(4),e=new Float32Array(t),n=new Uint32Array(t),r=new Uint32Array(512),i=new Uint32Array(512);for(let l=0;l<256;++l){const t=l-127;t<-27?(r[l]=0,r[256|l]=32768,i[l]=24,i[256|l]=24):t<-14?(r[l]=1024>>-t-14,r[256|l]=1024>>-t-14|32768,i[l]=-t-1,i[256|l]=-t-1):t<=15?(r[l]=t+15<<10,r[256|l]=t+15<<10|32768,i[l]=13,i[256|l]=13):t<128?(r[l]=31744,r[256|l]=64512,i[l]=24,i[256|l]=24):(r[l]=31744,r[256|l]=64512,i[l]=13,i[256|l]=13)}const o=new Uint32Array(2048),s=new Uint32Array(64),a=new Uint32Array(64);for(let l=1;l<1024;++l){let t=l<<13,e=0;for(;!(8388608&t);)t<<=1,e-=8388608;t&=-8388609,e+=947912704,o[l]=t|e}for(let l=1024;l<2048;++l)o[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)s[l]=l<<23;s[31]=1199570944,s[32]=2147483648;for(let l=33;l<63;++l)s[l]=2147483648+(l-32<<23);s[63]=3347054592;for(let l=1;l<64;++l)32!==l&&(a[l]=1024);return{floatView:e,uint32View:n,baseTable:r,shiftTable:i,mantissaTable:o,exponentTable:s,offsetTable:a}}();const E_=function(t){Math.abs(t)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),t=qv(t,-65504,65504),P_.floatView[0]=t;const e=P_.uint32View[0],n=e>>23&511;return P_.baseTable[n]+((8388607&e)>>P_.shiftTable[n])};let O_=class extends fx{onLoad({data:t}){const e=this.config;if(e){if(e.hdr){if(!(t=I_(t.data,0)))throw new Error("Invalid hdr data"+(e.url?":"+e.url:""));{const n=new Uint16Array(t.pixels.length);for(let e=0;e<t.pixels.length;e++)n[e]=Math.min(E_(t.pixels[e]),65504);e.data=n,e.type="float16",e.colorSpace="browser",e.min="linear",e.mag="linear"}}else e.data=t;e.width=e.width||t.width,e.height=e.height||t.height,this._regl&&this._checkNPOT(this._regl),this._updateREGL()}}createREGLTexture(t){return this._regl=t,this._checkNPOT(t),t.texture(this.config)}_checkNPOT(t){const e=this.config;if(e.data&&this._needPowerOf2(t)&&(e.data instanceof Image?(e.data=ix(e.data),e.width=e.data.width,e.height=e.data.height):e.hdr||!Gv(e.data)||nx(e.width)&&nx(e.height)||(e.data=ix(e.data,e.width,e.height),e.width=e.data.width,e.height=e.data.height)),Gv(this.config.data)||Gv(this.config.mipmap)){const e=Bx(t,this.config);return e[ux]||(e[ux]=0),e[ux]++,e}}},R_=class extends bx{constructor(t){super({aPosition:new(Wv(t=t||0))([-1,-1,t,1,-1,t,-1,1,t,1,1,t]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}};const k_={vsm_shadow_vert:"\nuniform mat4 shadow_lightProjViewModelMatrix;\nvarying vec4 shadow_vLightSpacePos;\nvoid shadow_computeShadowPars(vec4 position) {\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\n}",vsm_shadow_frag:"\nuniform sampler2D shadow_shadowMap;\nuniform float shadow_opacity;\nuniform vec3 shadow_color;\n#if defined(USE_ESM)\n    uniform float esm_shadow_threshold;\n#endif\nvarying vec4 shadow_vLightSpacePos;\n#ifdef PACK_FLOAT\n    #include <common_pack_float>\n#endif\n#if defined(USE_ESM)\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\n    float compare = projCoords.z;\n    float c = 120.0;\n    #ifdef PACK_FLOAT\n        float depth = common_decodeDepth(shadowTexel);\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\n            return 1.0;\n        }\n    #else\n        float depth = shadowTexel.r;\n    #endif\n    depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, esm_shadow_threshold, 1.0);\n}\n#endif\n#if defined(USE_VSM)\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\n    vec2 moments = shadowTexel.rg;\n    float distance = projCoords.z;\n    if (distance >= 1.0 || distance <= moments.x)\n        return 1.0 ;\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, 0.00002);\n    float d = distance - moments.x;\n    float p_max = variance / (variance + d * d);\n    return p_max;\n}\n#endif\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\n    vec2 uv = projCoords.xy;\n    vec4 shadowTexel = texture2D(shadowMap, uv);\n    #if defined(USE_ESM)\n        float esm_coeff = esm(projCoords, shadowTexel);\n        float coeff = esm_coeff * esm_coeff;\n    #endif\n    #if defined(USE_VSM)\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\n        float coeff = vsm_coeff;\n    #endif\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\n}\nfloat shadow_computeShadow() {\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\nvec3 shadow_blend(vec3 color, float coeff) {\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\n    return color;\n}",fbo_picking_vert:"\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 1\nattribute float aPickingId;\n#elif HAS_PICKING_ID == 2\nuniform float uPickingId;\n#endif\nvarying float vPickingId;\nvarying float vFbo_picking_viewZ;\nvarying float vFbo_picking_visible;\n#endif\nvarying float vFbo_picking_fragDepth;\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n       vPickingId = aPickingId;\n    #elif HAS_PICKING_ID == 2\n        vPickingId = uPickingId;\n    #endif\n        vFbo_picking_viewZ = viewPosZ;\n    #endif\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\nfloat common_packFloat(vec4 val){\n    vec4 scl = floor(255.0 * val + 0.5);\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\n    float man = 1.0 +\n        (scl.r / 8388608.0) +\n        (scl.g / 32768.0) +\n        mod(scl.b, 128.0) / 128.0;\n    return sgn * man * pow(2.0, exn);\n}\nvec4 common_unpackFloat(highp float v) {\n    highp float av = abs(v);\n    if(av < COMMON_FLOAT_MIN) {\n        return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > COMMON_FLOAT_MAX) {\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if(v < -COMMON_FLOAT_MAX) {\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n    highp vec4 c = vec4(0,0,0,0);\n    highp float e = floor(log2(av));\n    highp float m = av * pow(2.0, -e) - 1.0;\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n    highp float ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n    c[0] += 128.0 * step(0.0, -v);\n    return c / 255.0;\n}\nvec4 common_encodeDepth(const in float depth) {\n    float alpha = 1.0;\n    vec4 pack = vec4(0.0);\n    pack.a = alpha;\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n    pack.rgb = vec3(code * depth);\n    pack.gb = fract(pack.gb);\n    pack.rg -= pack.gb * (1.0 / 256.0);\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n    return pack;\n}\nfloat common_decodeDepth(const in vec4 pack) {\n    return pack.r + pack.g / 255.0;\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return inverse(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\n        float b00 = a00 * a11 - a01 * a10;\n        float b01 = a00 * a12 - a02 * a10;\n        float b02 = a00 * a13 - a03 * a10;\n        float b03 = a01 * a12 - a02 * a11;\n        float b04 = a01 * a13 - a03 * a11;\n        float b05 = a02 * a13 - a03 * a12;\n        float b06 = a20 * a31 - a21 * a30;\n        float b07 = a20 * a32 - a22 * a30;\n        float b08 = a20 * a33 - a23 * a30;\n        float b09 = a21 * a32 - a22 * a31;\n        float b10 = a21 * a33 - a23 * a31;\n        float b11 = a22 * a33 - a23 * a32;\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n        det = 1.0 / det;\n        mat4 m = mat4(\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\n        );\n        return m;\n    #endif\n}\nmat4 transpose_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return transpose(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a12 = vector2.z, a13 = vector2.w;\n        float a23 = vector3.w;\n        mat4 m = mat4(\n            vector1.x,\n            vector2.x,\n            vector3.x,\n            vector4.x,\n            a01,\n            vector2.y,\n            vector3.y,\n            vector4.y,\n            a02,\n            a12,\n            vector3.z,\n            vector4.z,\n            a03,\n            a13,\n            a23,\n            vector4.w\n        );\n        return m;\n    #endif\n}",get_output:"#include <invert_matrix>\n#include <draco_decode_vert>\n#ifdef HAS_INSTANCE\n    #include <instance_vert>\n    #ifdef HAS_INSTANCE_COLOR\n        varying vec4 vInstanceColor;\n    #endif\n#endif\n#ifdef HAS_SKIN\n    uniform int skinAnimation;\n    #include <skin_vert>\n#endif\n#include <mask_vert>\n#ifdef HAS_MORPH\n    attribute vec3 POSITION0;\n    attribute vec3 POSITION1;\n    attribute vec3 POSITION2;\n    attribute vec3 POSITION3;\n    attribute vec3 POSITION4;\n    attribute vec3 POSITION5;\n    attribute vec3 POSITION6;\n    attribute vec3 POSITION7;\n    #ifdef HAS_MORPHNORMALS\n        attribute vec3 NORMAL0;\n        attribute vec3 NORMAL1;\n        attribute vec3 NORMAL2;\n        attribute vec3 NORMAL3;\n    #endif\n    uniform vec4 morphWeights1;\n    uniform vec4 morphWeights2;\n#endif\n#ifdef HAS_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\n#endif\nmat4 getPositionMatrix() {\n    mat4 worldMatrix;\n    #ifdef HAS_INSTANCE\n        #ifdef HAS_INSTANCE_COLOR\n            vInstanceColor = instance_getInstanceColor();\n        #endif\n        mat4 attributeMatrix = instance_getAttributeMatrix();\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n            } else {\n                worldMatrix = attributeMatrix * positionMatrix;\n            }\n        #else\n            worldMatrix = attributeMatrix * positionMatrix;\n        #endif\n    #else\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\n            } else {\n                worldMatrix = positionMatrix;\n            }\n        #else\n            worldMatrix = positionMatrix;\n        #endif\n    #endif\n    return worldMatrix;\n}\n#ifdef HAS_MIN_ALTITUDE\nuniform float minAltitude;\n#endif\nvec4 getPosition(vec3 aPosition) {\n    vec3 position = decode_getPosition(aPosition);\n    #ifdef HAS_MORPH\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\n        , 1.0);\n    #else\n        vec4 POSITION = vec4(position, 1.0);\n    #endif\n    #ifdef HAS_TERRAIN_ALTITUDE\n        POSITION.z += aTerrainAltitude * 100.0;\n    #endif\n    #ifdef HAS_MIN_ALTITUDE\n        POSITION.z += minAltitude * 100.0;\n    #endif\n    return POSITION;\n}\nvec3 appendMorphNormal(vec3 NORMAL) {\n    #ifdef HAS_MORPHNORMALS\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\n    #else\n        vec3 normal = NORMAL;\n    #endif\n    return normal;\n}",instance_vert:"attribute vec4 instance_vectorA;\nattribute vec4 instance_vectorB;\nattribute vec4 instance_vectorC;\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\nuniform float terrainAltitudeScale;\n#endif\nmat4 instance_getAttributeMatrix() {\n    mat4 mat =  mat4(\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\n    );\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\n        mat4 terrainMat = mat4(\n            1., 0., 0., 0.,\n            0., 1., 0., 0.,\n            0., 0., 1., 0.,\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\n        );\n        mat = terrainMat * mat;\n    #endif\n    return mat;\n}\n#ifdef HAS_INSTANCE_HIGHLIGHT\n    attribute vec4 highlight_color;\n#endif\n#ifdef HAS_INSTANCE_COLOR\n   \n    attribute vec4 instance_color;\n    vec4 instance_getInstanceColor() {\n        vec4 color = instance_color;\n        #ifdef HAS_INSTANCE_HIGHLIGHT\n            color = instance_color * highlight_color;\n        #endif\n        return color;\n    }\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\nattribute vec4 JOINTS_0;\nuniform sampler2D jointTexture;\nuniform vec2 jointTextureSize;\nuniform float numJoints;\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\nmat4 skin_getBoneMatrix(float jointNdx) {\n    float v = (jointNdx + 0.5) / numJoints;\n    return mat4(\n        texture2D(jointTexture, vec2(ROW0_U, v)),\n        texture2D(jointTexture, vec2(ROW1_U, v)),\n        texture2D(jointTexture, vec2(ROW2_U, v)),\n        texture2D(jointTexture, vec2(ROW3_U, v)));\n}\nmat4 skin_getSkinMatrix() {\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n        return skinMatrix;\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\nvarying vec2 heatmap_vTexCoord;\nvoid heatmap_compute(mat4 matrix, vec3 position) {\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\n}\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\nuniform sampler2D heatmap_inputTexture;\nuniform sampler2D heatmap_colorRamp;\nuniform float heatmap_heatmapOpacity;\nvarying vec2 heatmap_vTexCoord;\nvec4 heatmap_getColor(vec4 color) {\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\n}\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n    attribute vec2 aExtrude;\n    #ifdef HAS_LINE_WIDTH\n        attribute float aLineWidth;\n    #else\n        uniform float lineWidth;\n    #endif\n    #ifdef HAS_LINE_HEIGHT\n        attribute float aLineHeight;\n    #else\n        uniform float lineHeight;\n    #endif\n    uniform float linePixelScale;\n    vec3 getLineExtrudePosition(vec3 position) {\n        #ifdef HAS_LINE_WIDTH\n            float lineWidth = aLineWidth / 2.0;\n        #endif\n        #ifdef HAS_LINE_HEIGHT\n            float lineHeight = aLineHeight / 10.0;\n        #endif\n        float halfwidth = lineWidth / 2.0;\n        float outset = halfwidth;\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\n        position.z *= lineHeight / ALTITUDE_SCALE;\n        return position + vec3(dist, 0.0) * linePixelScale;\n    }\n#endif",gl2_vert:"#if __VERSION__ == 300\n    #define texture2D texture\n    #define varying out\n    #define attribute in\n#endif",gl2_frag:"#if __VERSION__ == 300\n    #define varying in\n    #define gl_FragDepthEXT gl_FragDepth\n    #define texture2D texture\n    #define textureCube texture\n    #define texture2DProj textureProj\n    #define texture2DLodEXT textureLod\n    #define texture2DProjLodEXT textureProjLod\n    #define textureCubeLodEXT textureLod\n    #define texture2DGradEXT textureGrad\n    #define texture2DProjGradEXT textureProjGrad\n    #define textureCubeGradEXT textureGrad\n    #define texture2D texture\n    out vec4 glFragColor;\n#else\n    vec4 glFragColor;\n#endif",hsv_frag:"\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst mediump float HSV_E = 1.0e-10;\nvec3 hsv_rgb2hsv(vec3 c) {\n    vec4 K = HSV_K0;\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = HSV_E;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\nvec3 hsv_hsv2rgb(vec3 c) {\n    vec4 K = HSV_K1;\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return vec4(hsv_hsv2rgb(hsv), c.a);\n}\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return hsv_hsv2rgb(hsv);\n}\nmat4 contrastMatrix(float contrast)\n{\n    float t = (1.0 - contrast) / 2.0;\n    return mat4(\n        contrast, 0., 0., 0.,\n        0., contrast, 0., 0.,\n        0., 0., contrast, 0.,\n        t, t, t, 1\n    );\n}",snow_frag:"#ifdef HAS_SNOW\n    float lerp(float a, float b, float w) {\n        return a + w * (b - a);\n    }\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\n        float snowIntense = normalColor.b;\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\n        if (height < 1.0) {\n            float r = lerp(0.5, fixedC.x, snowIntense);\n            float g = lerp(0.5, fixedC.y, snowIntense);\n            float b = lerp(0.5, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        } else {\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        }\n    }\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\n    attribute vec4 aTangent;\n#elif defined(HAS_NORMAL)\n    #ifdef HAS_DRACO_NORMAL\n        attribute vec2 aNormal;\n        uniform float gltf_u_dec_normal_rangeConstant;\n    #else\n        attribute vec3 aNormal;\n    #endif\n#endif\n#ifdef HAS_DRACO_POSITION\n    uniform float gltf_u_dec_position_normConstant;\n    uniform vec3 minValues_pos;\n    vec3 decodeDracoPosition(vec3 aPosition) {\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\n    }\n#endif\n#ifdef HAS_DRACO_TEXCOORD\n    uniform vec2 minValues_tex;\n    uniform float gltf_u_dec_texcoord_0_normConstant;\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\n    }\n#endif\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\n    uniform mat3 decodeMatrix;\n#endif\n#ifdef HAS_DRACO_NORMAL\n    float czm_signNotZero(float value) {\n        return value >= 0.0 ? 1.0 : -1.0;\n    }\n    vec2 czm_signNotZero(vec2 value) {\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n    vec3 decodeDracoNormal(vec2 encoded, float range)\n    {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n    vec3 decode_getNormal(vec2 aNormal) {\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\n    }\n#endif\n#ifdef HAS_COMPRESSED_INT16\n    #ifdef HAS_COMPRESSED_INT16_POSITION\n      uniform vec2 compressedPositionRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\n      uniform vec2 compressedTexcoordRange_0;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\n      uniform vec2 compressedTexcoordRange_1;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n      uniform vec2 compressedNormalRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_RATIO\n      uniform float compressed_ratio;\n    #endif\n    float int16ToFloat32(float value, vec2 range) {\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\n    }\n#endif\nvec3 decode_getPosition(vec3 aPosition) {\n    vec3 position = aPosition;\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\n        #ifdef HAS_COMPRESSED_INT16_RATIO\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\n        #else\n          position = vec3(x, y, z);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_POSITION\n        return decodeDracoPosition(position);\n    #else\n        return position;\n    #endif\n}\nvec2 decode_getTexcoord(vec2 aTexCoord) {\n    vec2 texcoord = aTexCoord;\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\n        texcoord = vec2(x, y);\n    #endif\n    #ifdef HAS_DRACO_TEXCOORD\n        return decodeDracoTexcoord(texcoord);\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\n    #else\n        return texcoord;\n    #endif\n}\nvec3 decode_getNormal(vec3 aNormal) {\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\n    #endif\n    return aNormal;\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\n    attribute vec4 aHighlightColor;\n    varying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    attribute float aHighlightOpacity;\n    varying float vHighlightOpacity;\n#endif\nvoid highlight_setVarying() {\n    #if defined(HAS_HIGHLIGHT_COLOR)\n        vHighlightColor = aHighlightColor / 255.0;\n    #endif\n    #if defined(HAS_HIGHLIGHT_OPACITY)\n        vHighlightOpacity = aHighlightOpacity / 255.0;\n    #endif\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\n\tvarying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    varying float vHighlightOpacity;\n#endif\nvec4 highlight_blendColor(vec4 color) {\n\tvec4 outColor;\n\t#if defined(HAS_HIGHLIGHT_COLOR)\n\t\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\n\t\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\n        \tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\n        #endif\n        outColor = color;\n\t#else\n\t\toutColor = color;\n\t#endif\n\t#if defined(HAS_HIGHLIGHT_OPACITY)\n\t\toutColor *= vHighlightOpacity;\n\t#endif\n\treturn outColor;\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\n    uniform vec4 mask_extent;\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_maskMode;\n    uniform float mask_hasFlatOut;\n    uniform mat4 viewMatrix;\n    uniform float mask_heightRatio;\n    uniform float mask_heightOffset;\n    varying vec4 vWorldPosition;\n    varying vec2 vUVInExtent;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    const float CLIPINSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float ELEVATE_MODE = 0.7;\n    float random (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\n    }\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n          return flatHeight + height;\n      } else {\n        return flatHeight;\n      }\n    }\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\n      float deltaY = realPos.y - tempPos.y;\n      float deltaZ = realPos.z - tempPos.z;\n      pos.x = pos.x + deltaX;\n      pos.y = pos.y + deltaY;\n      pos.z = pos.z + deltaZ;\n      return pos;\n    }\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\n        vWorldPosition = modelMatrix * position;\n        float w = mask_extent.z - mask_extent.x;\n        float h = mask_extent.y - mask_extent.w;\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\n        float maskMode = maskOptionColor.r;\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\n        vUVInExtent = uvInExtent;\n        vHeightRatio = mask_heightRatio;\n        vHeightOffset = mask_heightOffset;\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\n            return modelViewMatrix * position;;\n        } else if (mask_hasFlatOut == 1.0) {\n            return getNoErrorPosition(position, wPosition);\n        }\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\n            return getNoErrorPosition(position, wPosition);\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n            return getNoErrorPosition(position, wPosition);\n        } else {\n            return modelViewMatrix * position;\n        }\n    }\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_hasClipOut;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    varying vec2 vUVInExtent;\n    varying vec4 vWorldPosition;\n    const float CLIPINSIDE_MODE = 0.1;\n    const float CLIPOUTSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float COLOR_MODE = 0.5;\n    const float VIDEO_MODE = 0.6;\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    vec4 setMask(vec4 glFragColor) {\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\n        float maskMode = modeColor.r;\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                return glFragColor;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                return glFragColor;\n            } else {\n              discard;\n            }\n        } else if (mask_hasClipOut == 1.0) {\n            discard;\n        }\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                discard;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                discard;\n            } else {\n              return glFragColor;\n            }\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            }\n        }\n        return glFragColor;\n    }\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    uniform vec2 khr_offset;\n    uniform float khr_rotation;\n    uniform vec2 khr_scale;\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\n        rotation = -rotation;\n        mat3 transform = mat3(\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\nvarying highp vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\n    varying vec4 vUvRegion;\n#endif\nvec2 computeTexCoord(vec2 texCoord) {\n    #ifdef HAS_I3S_UVREGION\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\n        return uvAtlas;\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\n    #else\n        return texCoord;\n    #endif\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\n    uniform sampler2D terrainHeightTexture;\n    uniform vec2 terrainHeightMapResolution;\n    uniform vec2 terrainResolution;\n    uniform float terrainHeightScale;\n    uniform float terrainTileResolution;\n    uniform vec4 terrainUnpackFactors;\n    float getHeight(vec2 uv) {\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\n        color.a = -1.0;\n        return dot(color, terrainUnpackFactors) / 4.0;\n    }\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\n        uv.y = 1.0 - uv.y;\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\n        float b = getHeight(uv + vec2(0, -epsilon.y));\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\n        float e = getHeight(uv + vec2(epsilon.x, 0));\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\n        float g = getHeight(uv + vec2(0, epsilon.y));\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\n        vec2 dxy = vec2(\n            (c + e + e + h) - (a + d + d + f),\n            (f + g + g + h) - (a + b + b + c)\n        );\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\n    }\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\nattribute float aVertexColorType;\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\nvarying vec4 vertexColor_color;\nvoid vertexColor_update() {\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\n}\n#endif",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\nvarying vec4 vertexColor_color;\nvec4 vertexColor_get() {\n\treturn vertexColor_color;\n}\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform vec4 excavateExtent;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  float getWorldHeight() {\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\n    return wPosition.z;\n  }\n  vec2 getCoordinateTexcoord() {\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\n    return vec2(x, y);\n  }\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform sampler2D heightmap;\n  uniform float excavateHeight;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  const vec2 range = vec2(-100.0, 1000.0);\n  float decodeHeight(const in vec4 pack) {\n      return pack.r + pack.g / 255.0;\n  }\n  vec4 excavateColor(vec4 fragColor) {\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\n      if(realHeight < range.x || realHeight > range.y) {\n          realHeight = 0.0;\n      }\n      if(vHeight > realHeight) {\n          discard;\n      }\n      return fragColor;\n  }\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\n    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);\n}\nvec3 sRGBToLinear(const in vec3 color) {\n    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));\n}"};var L_={register(t,e){if(k_[t])throw new Error(`Key of ${t} is already registered in ShaderLib.`);k_[t]=e},compile:t=>N_(t)};const D_=/^[ \t]*#include +<([\w\d.]+)>/gm;function N_(t){return t.replace(D_,F_)}function F_(t,e){const n=k_[e];if(!n)throw new Error("Can not resolve #include <"+e+">");return N_(n)}let z_=0;const B_={};let H_=class{constructor({vert:t,frag:e,uniforms:n,defines:r,extraCommandProps:i}){this.vert=t,this.frag=e;const o=z_++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>o}),this.shaderDefines=r&&Hv({},r)||{},n=this.uniforms=(n||[]).slice(),this.contextDesc={};for(let s=0,a=n.length;s<a;s++){const t=n[s];if(Nv(t))if(t.indexOf("[")>0){const{name:e,len:n}=j_(t);this.contextDesc[e]={name:e,type:"array",length:n}}else this.contextDesc[t]=null;else if(t.name.indexOf("[")>0){const{name:e,len:n}=j_(t.name);this.contextDesc[e]={name:e,type:"array",length:n,fn:t.fn}}else this.contextDesc[t.name]=t}this.extraCommandProps=i&&Hv({},i)||{},this.commands={},this._compileSource()}set shaderDefines(t){this._shaderDefines=t,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(t){this.shaderDefines=t}setFramebuffer(t){return this.context.framebuffer=t,this}appendDescUniforms(t,e){const n=e,r=this.contextDesc;for(const i in r)if(r[i])if("array"===r[i].type){const o=i,s=r[i].length;let a=e[i];if(r[i].fn&&(a=r[i].fn(null,e)),!a)continue;if(a.length!==s)throw new Error(`${o} uniform's length is not ${s}`);n[o]=n[o]||{};for(let e=0;e<s;e++)n[o][`${e}`]=a[e].getREGLTexture?a[e].getREGLTexture(t):a[e]}else"function"===r[i].type&&(Object.getOwnPropertyDescriptor(n,i)||Object.defineProperty(n,i,{configurable:!1,enumerable:!0,get:function(){return r[i].fn(null,e)}}));return n}setUniforms(t){if(t.modelMatrix||t.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=t?Object.keys(t).join():null,this.context=t,this}getVersion(t,e){return"#version"===e.substring(0,8)?"":0===t.limits.version.indexOf("WebGL 2.0")&&300===this.version?"#version 300 es\n":"#version 100\n"}getActiveVars(t,e,n,r){const i=r;if(B_[i])return B_[i];const o=t._gl,s=o.createProgram(),a=o.createShader(35633);o.shaderSource(a,e),o.compileShader(a);const l=o.createShader(35632);o.shaderSource(l,n),o.compileShader(l),o.attachShader(s,l),o.attachShader(s,a),o.linkProgram(s);const h=o.getProgramParameter(s,35721),u=[];for(let d=0;d<h;++d){const t=o.getActiveAttrib(s,d);t&&u.push({name:t.name,type:t.type})}const c=o.getProgramParameter(s,35718),f=[];for(let d=0;d<c;++d){const t=o.getActiveUniform(s,d);let e=t.name;t.name.indexOf("[")>0&&(e=e.replace("[0]","")),f.push(e)}return o.deleteProgram(s),o.deleteShader(a),o.deleteShader(l),B_[i]={activeUniforms:f,activeAttributes:u},B_[i]}createREGLCommand(t,e,n,r,i,o={}){const s=Xv(t)&&!i,a=Hv({},this.shaderDefines||{},e||{}),l=this._insertDefines(this.vert,a),h=this.getVersion(t,l)+l,u=this._insertDefines(this.frag,a),c=this.getVersion(t,u)+u,f=ex(h)+"_"+ex(c),{activeAttributes:d,activeUniforms:p}=this.getActiveVars(t,h,c,f),g={};d.forEach(((e,n)=>{const r=e.name;g[r]=s?n:t.prop(r)}));const m={};p.forEach((e=>{m[e]=t.prop(e)}));const A=this.contextDesc;for(const x in A)if(A[x]&&"function"===A[x].type)m[x]=A[x].fn;else if(A[x]&&"array"===A[x].type){const e=A[x].name,n=A[x].length;for(let r=0;r<n;r++){const n=`${e}[${r}]`;m[n]=t.prop(n)}}else m[x]=t.prop(x);const y={vert:h,frag:c,uniforms:m,attributes:g};s&&(y.vao=t.prop("vao")),s&&!r||!n||Uv(n)||(y.elements=t.prop("elements")),y.count=t.prop("count"),y.offset=t.prop("offset"),y.primitive=t.prop("primitive"),y.framebuffer=t.prop("framebuffer"),r&&(y.instances=t.prop("instances")),Hv(y,this.extraCommandProps,o);const v=t(y);return d.key=d.map((t=>t.name)).join(),v.activeAttributes=d,v}dispose(){for(const t in this.commands){const e=this.commands[t];e&&e.destroy&&!e[lx]&&(e[lx]=!0,e.destroy())}this.commands={},delete this.vert,delete this.frag}_insertDefines(t,e){const n=[];for(const r in e)Zv(e,r)&&!Bv(e[r])&&n.push(`#define ${r} ${e[r]}\n`);return n.join("")+t}_compileSource(){this.vert=L_.compile(this.vert),this.frag=L_.compile(this.frag)}};function j_(t){const e=t.indexOf("["),n=t.indexOf("]");return{name:t.substring(0,e),len:+t.substring(e+1,n)}}let U_=class extends H_{draw(t,e){if(!e||!e.length)return 0;const n=[];let r,i=0;for(let o=0,s=e.length;o<s;o++){if(!e[o].isValid()){o===s-1&&r&&n.length&&r(n);continue}if(!e[o].geometry.getDrawCount()||!this._runFilter(e[o])){o===s-1&&r&&n.length&&r(n);continue}const a=this.getMeshCommand(t,e[o]);n.length&&r!==a&&(r(n),n.length=0);const l=e[o].getREGLProps(t,a.activeAttributes);this._ensureContextDefines(l),l.shaderContext=this.context,this.appendDescUniforms(t,l),n.push(l),i++,o<s-1?r=a:o===s-1&&a(n)}return i}_ensureContextDefines(t){if(this.context&&(t.contextKeys||(t.contextKeys={}),t.contextKeys[this.uid]!==this.contextKeys)){for(const e in this.context)"framebuffer"===e||Object.getOwnPropertyDescriptor(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext[e]}});Object.getOwnPropertyDescriptor(t,"framebuffer")||Object.defineProperty(t,"framebuffer",{configurable:!1,enumerable:!0,get:function(){return this.targetFramebuffer||this.shaderContext&&this.shaderContext.framebuffer}}),t.contextKeys[this.uid]=this.contextKeys}}_runFilter(t){const e=this.filter;if(!e)return!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}return e(t)}getMeshCommand(t,e){this._cmdKeys||(this._cmdKeys={});const n=this.dkey||"default";let r=this._cmdKeys[n];r||(r=this._cmdKeys[n]={});const i=e.getCommandKey(t);r[i]||(r[i]=n+"_"+e.getCommandKey(t));const o=r[i];let s=this.commands[o];if(!s){const n=e.getDefines(),r=e.getMaterial(),i={};r&&r.doubleSided&&this.extraCommandProps&&(i.cull={enable:!1}),s=this.commands[o]=this.createREGLCommand(t,n,e.getElements(),e instanceof u_,e.disableVAO,i)}return s}},V_=class extends U_{constructor(t={}){const e=[],n=[],r=t.uniforms,i=[{name:"modelNormalMatrix",type:"function",fn:function(t,n){return Wg(e,n.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(n,e.viewMatrix,e.modelMatrix)}}];r&&i.push(...r),super({vert:t.vert||"#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nvarying vec3 vFragPos;\nvarying vec3 vNormal;\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <highlight_vert>\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nattribute float aExtrusionOpacity;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_TANGENT)\nvarying vec4 vTangent;\n#endif\nvoid c(const highp vec4 q, out highp vec3 d) {\n  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {\n  c(q, d);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 e = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 e = getPosition(aPosition);\n#endif\nmat4 f = getPositionMatrix();\n  vFragPos = vec3(modelMatrix * f * e);\n#if defined(HAS_NORMAL) || defined(HAS_TANGENT)\nmat3 h = modelNormalMatrix * mat3(f);\n  vec3 i;\n#if defined(HAS_TANGENT)\nvec3 t;\n  c(aTangent, i, t);\n  vTangent = vec4(h * t, aTangent.w);\n#else\ni = decode_getNormal(aNormal);\n#endif\nvec3 j = appendMorphNormal(i);\n  vNormal = normalize(h * j);\n#else\nvNormal = vec3(.0);\n#endif\nmat4 k = projMatrix;\n  k[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = k * getMaskPosition(f * e, modelMatrix);\n#else\ngl_Position = k * modelViewMatrix * f * e;\n#endif\n#ifdef HAS_MAP\nvec2 l = decode_getTexcoord(aTexCoord);\n  vTexCoord = l * uvScale + uvOffset;\n#endif\n#ifdef HAS_AO_MAP\nvec2 m = decode_getTexcoord(aTexCoord1);\n  vTexCoord1 = m * uvScale + uvOffset;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nvExtrusionOpacity = aExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(f * e);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * f, e);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\nhighlight_setVarying();\n}",frag:t.frag||"precision mediump float;\n#include <gl2_frag>\nuniform vec4 baseColorFactor;\nuniform float materialShininess;\nuniform float environmentExposure;\nuniform float specularStrength;\nuniform vec3 light0_viewDirection;\nuniform vec3 ambientColor;\nuniform vec4 light0_diffuse;\nuniform vec3 lightSpecular;\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#ifdef HAS_TOON\nuniform float toons;\nuniform float specularToons;\n#endif\n#ifdef HAS_TANGENT\nvarying vec4 vTangent;\n#endif\n#ifdef HAS_MAP\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vNormal;\nvarying vec3 vFragPos;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nuniform vec2 extrusionOpacityRange;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_AO_MAP\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#include <heatmap_render_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#include <mask_frag>\nvec3 c() {\n  \n#if defined(HAS_NORMAL_MAP)\nvec3 d = normalize(vNormal);\n  vec3 e = texture2D(normalTexture, computeTexCoord(vTexCoord)).xyz * 2. - 1.;\n#if defined(HAS_TANGENT)\nvec3 t = normalize(vTangent.xyz);\n  vec3 b = normalize(cross(d, t) * sign(vTangent.w));\n  mat3 f = mat3(t, b, d);\n  return normalize(f * e);\n#else\nreturn normalize(e);\n#endif\n#else\nreturn normalize(vNormal);\n#endif\n}\nvec4 h(const in vec4 i) {\n  return vec4(i.r < .0031308 ? i.r * 12.92 : 1.055 * pow(i.r, 1. / 2.4) - .055, i.g < .0031308 ? i.g * 12.92 : 1.055 * pow(i.g, 1. / 2.4) - .055, i.b < .0031308 ? i.b * 12.92 : 1.055 * pow(i.b, 1. / 2.4) - .055, i.a);\n}\nvec4 j() {\n  \n#if defined(HAS_BASECOLOR_MAP)\nreturn texture2D(baseColorTexture, computeTexCoord(vTexCoord));\n#elif defined(HAS_DIFFUSE_MAP)\nreturn texture2D(diffuseTexture, computeTexCoord(vTexCoord));\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn diffuseFactor;\n#else\nreturn baseColorFactor;\n#endif\n}\nvec3 k() {\n  \n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn specularFactor;\n#else\nreturn vec3(1.);\n#endif\n}\nvoid main() {\n  vec4 l = j();\n  vec3 m = environmentExposure * ambientColor * l.rgb;\n#ifdef HAS_INSTANCE_COLOR\nm *= vInstanceColor.rgb;\n#endif\nvec3 o = c();\n  vec3 u = normalize(-light0_viewDirection);\n  float v = max(dot(o, u), .0);\n#ifdef HAS_TOON\nfloat A = floor(v * toons);\n  v = A / toons;\n#endif\nvec3 B = light0_diffuse.rgb * v * l.rgb;\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvec3 i = vColor.rgb;\n#elif defined(IS_LINE_EXTRUSION)\nvec3 i = lineColor.rgb;\n#else\nvec3 i = polygonFill.rgb;\n#endif\n#ifdef HAS_INSTANCE_COLOR\ni *= vInstanceColor.rgb;\n#endif\nm *= i.rgb;\n  B *= i.rgb;\n  vec3 C = normalize(cameraPosition - vFragPos);\n  vec3 D = normalize(u + C);\n  float E = pow(max(dot(o, D), .0), materialShininess);\n#ifdef HAS_TOON\nfloat F = floor(E * specularToons);\n  E = F / specularToons;\n#endif\nvec3 G = specularStrength * lightSpecular * E * k();\n#ifdef HAS_OCCLUSION_MAP\nfloat H = texture2D(occlusionTexture, computeTexCoord(vTexCoord1)).r;\n  m *= H;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat I = shadow_computeShadow();\n  B = shadow_blend(B, I).rgb;\n  G = shadow_blend(G, I).rgb;\n  m = shadow_blend(m, I).rgb;\n#endif\nvec3 J = m + B + G;\n#ifdef HAS_EMISSIVE_MAP\nvec3 K = texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n  J += K;\n#endif\n#ifdef IS_LINE_EXTRUSION\nglFragColor = vec4(J, lineOpacity * l.a);\n#else\nglFragColor = vec4(J, polygonOpacity * l.a);\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nfloat L = vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nfloat L = lineColor.a;\n#else\nfloat L = polygonFill.a;\n#endif\nglFragColor *= L;\n#ifdef HAS_EXTRUSION_OPACITY\nfloat M = extrusionOpacityRange.x;\n  float N = extrusionOpacityRange.y;\n  float O = M + vExtrusionOpacity * (N - M);\n  O = clamp(O, .0, 1.);\n  glFragColor *= O;\n#endif\nif(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:i,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),e}};var G_="#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}";const W_=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),q_=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);let X_=class extends U_{constructor(t){t.vert=t.vert||G_,t.extraCommandProps=t.extraCommandProps||{},t.extraCommandProps.depth||(t.extraCommandProps.depth={enable:!1,mask:!1}),t.extraCommandProps.stencil||(t.extraCommandProps.stencil={enable:!1}),super(t)}draw(t){return this._quadMesh||this._createQuadMesh(t),super.draw(t,this._quadMesh)}getMeshCommand(t){const e=this.dkey||"";return this.commands[e+"_quad"]||(this.commands[e+"_quad"]=this.createREGLCommand(t,null,this._quadMesh[0].getElements())),this.commands[e+"_quad"]}_createQuadMesh(t){const e=new bx({aPosition:W_,aTexCoord:q_},null,W_.length/2,{positionSize:2,primitive:"triangles"});e.generateBuffers(t),this._quadMesh=[new h_(e)]}dispose(){if(this._quadMesh){const t=this._quadMesh[0];t.geometry.dispose(),t.dispose()}return delete this._quadMesh,super.dispose()}},Z_=class extends X_{constructor(){super({vert:G_,frag:"#define SHADER_NAME FXAA\n#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision mediump float;\nvarying vec2 vTexCoord;\nuniform float enableFXAA;\nuniform float enableToneMapping;\nuniform float enableSharpen;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\n#ifdef HAS_TAA_TEX\nuniform sampler2D taaTextureSource;\n#ifdef HAS_FXAA_TEX\nuniform sampler2D fxaaTextureSource;\n#endif\n#endif\nuniform float pixelRatio;\nuniform float sharpFactor;\n#ifdef HAS_OUTLINE_TEX\nuniform sampler2D textureOutline;\nuniform float enableOutline;\nuniform float highlightFactor;\nuniform float outlineFactor;\nuniform float outlineWidth;\nuniform vec3 outlineColor;\n#endif\nvec2 c;\nvec4 d(vec2 e) {\n  \n#ifdef HAS_TAA_TEX\nvec4 f = texture2D(textureSource, e);\n  vec4 taa = texture2D(taaTextureSource, e);\n#ifdef HAS_FXAA_TEX\nvec4 h = texture2D(fxaaTextureSource, e);\n#else\nvec4 h = vec4(.0);\n#endif\nvec4 i = taa + f * (1. - taa.a);\n  return h + i * (1. - h.a);\n#else\nreturn texture2D(textureSource, e);\n#endif\n}\nvec4 j(vec2 k) {\n  vec4 l;\n  mediump vec2 m = vec2(1. / resolution.x, 1. / resolution.y);\n  vec3 n = d((k + vec2(-1., -1.)) * m).xyz;\n  vec3 o = d((k + vec2(1., -1.)) * m).xyz;\n  vec3 u = d((k + vec2(-1., 1.)) * m).xyz;\n  vec3 v = d((k + vec2(1.)) * m).xyz;\n  vec4 A = d(k * m);\n  vec3 B = A.xyz;\n  vec3 C = vec3(.299, .587, .114);\n  float D = dot(n, C);\n  float E = dot(o, C);\n  float F = dot(u, C);\n  float G = dot(v, C);\n  float H = dot(B, C);\n  float I = min(H, min(min(D, E), min(F, G)));\n  float J = max(H, max(max(D, E), max(F, G)));\n  mediump vec2 K;\n  K.x = -((D + E) - (F + G));\n  K.y = (D + F) - (E + G);\n  float L = max((D + E + F + G) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float M = 1. / (min(abs(K.x), abs(K.y)) + L);\n  K = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), K * M)) * m;\n  vec4 N = .5 * (d(k * m + K * (1. / 3. - .5)) + d(k * m + K * (2. / 3. - .5)));\n  vec4 O = N * .5 + .25 * (d(k * m + K * -.5) + d(k * m + K * .5));\n  float P = dot(O.xyz, C);\n  if(P < I || P > J)\n    l = N;\n  else\n    l = O;\n  return l;\n}\nvec3 Q(const in vec3 l, const float R) {\n  vec2 S = pixelRatio / resolution.xy;\n  float T = .0;\n  vec4 n = texture2D(textureSource, c + S * vec2(-1., -1.));\n  n.rgb = mix(vec3(.0), n.rgb, sign(n.a));\n  T += mix(.0, 1., sign(n.a));\n  vec4 v = texture2D(textureSource, c + S * vec2(1.));\n  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));\n  T += mix(.0, 1., sign(v.a));\n  vec4 o = texture2D(textureSource, c + S * vec2(1., -1.));\n  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));\n  T += mix(.0, 1., sign(o.a));\n  vec4 u = texture2D(textureSource, c + S * vec2(-1., 1.));\n  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));\n  T += mix(.0, 1., sign(u.a));\n  return l + R * (T * l - n.rgb - o.rgb - u.rgb - v.rgb);\n}\nvec4 U(const in vec4 l) {\n  return vec4(Q(l.rgb, sharpFactor), l.a);\n}\nvec3 V(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float W = 2.43;\n  const float X = .59;\n  const float Y = .14;\n  return (x * (a * x + b)) / (x * (W * x + X) + Y);\n}\nvec3 Z(vec3 l) {\n  l = l / (l + vec3(1.));\n  return l = pow(l, vec3(1. / 2.2));\n}\n#ifdef HAS_OUTLINE_TEX\nvec4 ba() {\n  float bb = 2.;\n  float bc = 1.;\n  float bd = pixelRatio / resolution[0] * outlineWidth;\n  float be = pixelRatio / resolution[1] * outlineWidth;\n  vec4 bf = (texture2D(textureOutline, c + vec2(bd, be)));\n  vec4 bg = (texture2D(textureOutline, c + vec2(bd, .0)));\n  vec4 bh = (texture2D(textureOutline, c + vec2(bd, -be)));\n  vec4 bi = (texture2D(textureOutline, c + vec2(.0, -be)));\n  vec4 bj = (texture2D(textureOutline, c + vec2(-bd, -be)));\n  vec4 bk = (texture2D(textureOutline, c + vec2(-bd, .0)));\n  vec4 bl = (texture2D(textureOutline, c + vec2(-bd, be)));\n  vec4 bm = (texture2D(textureOutline, c + vec2(.0, be)));\n  vec4 bn = -bb * bk + bb * bg + -bc * bl + bc * bf + -bc * bj + bc * bh;\n  vec4 bo = -bb * bi + bb * bm + -bc * bj + bc * bl + -bc * bh + bc * bf;\n  float bp = sqrt(dot(bo, bo) + dot(bn, bn));\n  bool bq = bp < 1. / 65025.;\n  vec3 br = (texture2D(textureOutline, c)).r * outlineColor;\n  if(br == vec3(.0) || (highlightFactor == .0 && bq)) {\n    return vec4(.0);\n  }\n  float bs = bq ? highlightFactor : min(1., sqrt(bp) * outlineFactor);\n  return bs * vec4(br, 1.);\n}\nvec4 bt(const in vec4 l) {\n  vec4 ba = ba();\n  return ba + vec4(l) * (1. - ba.a);\n}\n#endif\nvoid main() {\n  c = vTexCoord;\n  vec4 l;\n  if(enableFXAA == 1.) {\n    l = j(c * resolution);\n  } else {\n    l = d(vTexCoord);\n  }\n  if(enableSharpen == 1.) {\n    l = U(l);\n  }\n#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)\nvec4 bu = vec4(.0);\n  vec4 bv = vec4(.0);\n#ifdef HAS_POINT_TEX\nbu = texture2D(pointTextureSource, vTexCoord);\n#endif\n#ifdef HAS_NOAA_TEX\nbv = texture2D(noAaTextureSource, vTexCoord);\n#endif\nvec4 bw = bu + bv * (1. - bu.a);\n  l = bw + l * (1. - bw.a);\n#endif\nif(enableToneMapping == 1.) {\n    l.rgb = Z(l.rgb);\n  }\n#ifdef HAS_OUTLINE_TEX\nl = bt(l);\n#endif\ngl_FragColor = l;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createREGLCommand(t,null,e.getElements())),this.commands[n+"_fxaa"]}},Y_=class extends X_{constructor(){super({vert:G_,frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\nuniform float enableVignette;\nuniform float enableGrain;\nuniform float enableLut;\nuniform float timeGrain;\nuniform float grainFactor;\nuniform vec2 lensRadius;\nuniform float frameMod;\nuniform sampler2D lookupTable;\nfloat c(const in vec2 d) {\n  vec3 e = fract(vec3(d.xyx) * .1031);\n  e += dot(e, e.yzx + 19.19);\n  return fract((e.x + e.y) * e.z);\n}\nfloat f() {\n  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));\n  float i = h * 2. - 1.;\n  h = i * inversesqrt(abs(i));\n  h = max(-1., h);\n  h = h - sign(i) + .5;\n  return (h + .5) * .5;\n}\nvec4 j(const in vec4 k) {\n  float l = f();\n  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);\n}\nfloat m(const in float k) {\n  return k < .0031308 ? k * 12.92 : 1.055 * pow(k, 1. / 2.4) - .055;\n}\nvec3 m(const in vec3 k) {\n  return vec3(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055);\n}\nvec4 m(const in vec4 k) {\n  return vec4(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055, k.a);\n}\nfloat n(const in float k) {\n  return k < .04045 ? k * (1. / 12.92) : pow((k + .055) * (1. / 1.055), 2.4);\n}\nvec3 n(const in vec3 k) {\n  return vec3(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4));\n}\nvec4 n(const in vec4 k) {\n  return vec4(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4), k.a);\n}\nfloat o(const in vec2 d, const in float u) {\n  vec3 v = vec3(.06711056, .00583715, 52.9829189);\n  return fract(v.z * fract(dot(d.xy + u * vec2(47., 17.) * .695, v.xy)));\n}\nfloat A() {\n  vec2 B = lensRadius;\n  B.y = min(B.y, B.x - 1e-4);\n  float C = o(gl_FragCoord.xy, frameMod);\n  C = (B.x - B.y) * (B.x + B.y) * .07 * (C - .5);\n  return smoothstep(B.x, B.y, C + distance(vTexCoord, vec2(.5)));\n}\nvec4 D(const in vec4 k) {\n  float l = A();\n  return vec4(m(n(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));\n}\nvec4 E(in vec4 F, in sampler2D G) {\n  mediump float H = F.b * 63.;\n  mediump vec2 I;\n  I.y = floor(floor(H) / 8.);\n  I.x = floor(H) - I.y * 8.;\n  mediump vec2 J;\n  J.y = floor(ceil(H) / 8.);\n  J.x = ceil(H) - J.y * 8.;\n  highp vec2 K;\n  K.x = I.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  K.y = I.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nK.y = 1. - K.y;\n#endif\nhighp vec2 L;\n  L.x = J.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  L.y = J.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nL.y = 1. - L.y;\n#endif\nlowp vec4 M = texture2D(G, K);\n  lowp vec4 N = texture2D(G, L);\n  lowp vec4 O = mix(M, N, fract(H));\n  return O;\n}\nvoid main() {\n  vec4 k = texture2D(textureSource, vTexCoord);\n  if(enableLut == 1.) {\n    k = E(k, lookupTable);\n  }\n  if(enableVignette == 1.) {\n    k = D(k);\n  }\n  if(enableGrain == 1.) {\n    k = j(k);\n  }\n  gl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){return this.commands.postprocess||(this.commands.postprocess=this.createREGLCommand(t,null,e.getElements())),this.commands.postprocess}};const J_=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],Q_=J_.length,K_=[0,0];for(let E6=0;E6<J_.length;E6++)K_[0]+=J_[E6][0],K_[1]+=J_[E6][1];K_[0]/=Q_,K_[1]/=Q_;let $_=class{constructor(t){this._frameNum=0,this._ratio=t||.05,this._avg=[K_[0]*this._ratio,K_[1]*this._ratio]}getRatio(){return this._ratio}setRatio(t){this._ratio!==t&&(this._ratio=t,this.reset()),this._avg=[K_[0]*this._ratio,K_[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(t){const e=this._frameNum%Q_,n=this._ratio;return Ly(t,J_[e][0]*n,J_[e][1]*n),t}frame(){this._frameNum++,this._frameNum%Q_==0&&(this._frameNum=0)}getSampleCount(){return Q_}},tb=class{constructor(t,e,n=5){this._regl=t,this._renderer=new f_(t),this._inputRGBM=e,this._level=n}render(t,e){this._initShaders(),this._createTextures(t),this._blur(t,e||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(t,e){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),Ly(n.outSize,t.width,t.height),this._blurOnce(this._blur0Shader,t,this._blur00FBO,this._blur01FBO,.5,e),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(t,e,n,r,i,o){const s=Math.ceil(i*e.width),a=Math.ceil(i*e.height);n.width===s&&n.height===a||n.resize(s,a),r.width===s&&r.height===a||r.resize(s,a);const l=this._blurUniforms;l.luminThreshold=o,l.TextureBlurInput=e,l.inputRGBM=+this._inputRGBM,Ly(l.blurDir,0,1),Ly(l.outputSize,n.width,n.height),this._renderer.render(t,l,null,n),l.luminThreshold=0,l.inputRGBM=1,Ly(l.blurDir,1,0),l.TextureBlurInput=n.color[0],this._renderer.render(t,l,null,r)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(t){if(this._blur00Tex)return;let e=t.width,n=t.height;this._blur00Tex=this._createColorTex(t,e,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(t),this._blur01FBO=this._createBlurFBO(this._blur01Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(t,e,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(t,e,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(t,e,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(t,e,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(t,e,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(t,e,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(t,e,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(t,e,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(t,e,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(t,e,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(t,e,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(t,e,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(t,e,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const t={vert:G_,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}},frag:"#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\nuniform float inputRGBM;\nuniform float luminThreshold;\n#define SHADER_NAME GAUSSIAN_BLUR0\nconst vec3 c = vec3(.2126, .7152, .0722);\nfloat d(const in vec3 e) {\n  return dot(e, c);\n}\nvec4 f(vec4 e) {\n  float h = max(sign(d(e.rgb) - luminThreshold), .0);\n  return e * h;\n}\nvec2 i;\nvec4 j(const in vec3 e, const in float k) {\n  vec4 l;\n  vec3 m = e / k;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvec3 n(const in vec4 e, const in float k) {\n  if(inputRGBM == .0)\n    return e.rgb;\n  return k * e.rgb * e.a;\n}\nvec4 o() {\n  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;\n  vec2 v;\n  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  v = A * 1.2;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;\n  return vec4(u, 1.);\n}\nvoid main(void) {\n  i = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = o();\n  e = j(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}"};this._blur0Shader=new X_(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR1\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.2857142857142858;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur1Shader=new X_(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR2\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3333333333333333;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.111111111111111;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur2Shader=new X_(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR3\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3636363636363635;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.1818181818181817;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur3Shader=new X_(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR4\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3846153846153846;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.230769230769231;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.076923076923077;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur4Shader=new X_(t),this._level>5&&(t.frag="precision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR5\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.4;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2666666666666666;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.133333333333334;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur5Shader=new X_(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR6\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.411764705882353;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2941176470588234;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.176470588235294;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur6Shader=new X_(t))}}},eb=class{constructor(t){this._regl=t,this._renderer=new f_(t)}render(t,e,n,r,i,o,s,a,l){this._initShaders(),this._createTextures(t);const h=this._blurPass.render(e,n);return this._combine(t,h,e,r,i,o,s,a,l)}_combine(t,e,n,r,i,o,s,a,l){l||this._combineTex.width===t.width&&this._combineTex.height===t.height||this._combineFBO.resize(t.width,t.height);let h=this._combineUniforms;const{blurTex0:u,blurTex1:c,blurTex2:f,blurTex3:d,blurTex4:p}=e;h||(h=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:u,TextureBloomBlur2:c,TextureBloomBlur3:f,TextureBloomBlur4:d,TextureBloomBlur5:p,TextureInput:null,TextureSource:null,outputSize:[0,0]}),h.noAaTextureSource=o,h.pointTextureSource=s,h.enableAA=a,h.bloomFactor=r,h.bloomRadius=i,h.TextureInput=n,h.TextureSource=t,Ly(h.outputSize,t.width,t.height);const g={};return o?g.HAS_NOAA_TEX=1:delete g.HAS_NOAA_TEX,s?g.HAS_POINT_TEX=1:delete g.HAS_POINT_TEX,this._combineShader.setDefines(g),this._renderer.render(this._combineShader,h,null,l?null:this._combineFBO),l?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(t){this._combineTex||(this._combineTex=this._createColorTex(t,t.width,t.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex))}_createColorTex(t,e,n,r){return this._renderer.regl.texture({min:"linear",mag:"linear",type:r,width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const t={x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]};this._blurPass=new tb(this._regl,!1),this._combineShader=new X_({vert:G_,frag:"#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision highp float;\nuniform float bloomFactor;\nuniform float bloomRadius;\nuniform float rgbmRange;\nuniform sampler2D TextureBloomBlur1;\nuniform sampler2D TextureBloomBlur2;\nuniform sampler2D TextureBloomBlur3;\nuniform sampler2D TextureBloomBlur4;\nuniform sampler2D TextureBloomBlur5;\nuniform sampler2D TextureInput;\nuniform sampler2D TextureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\nuniform float enableAA;\nuniform vec2 outputSize;\n#define SHADER_NAME bloomCombine\nvec2 c;\nvec3 d(const in vec3 e) {\n  return vec3(e.r < .0031308 ? e.r * 12.92 : 1.055 * pow(e.r, 1. / 2.4) - .055, e.g < .0031308 ? e.g * 12.92 : 1.055 * pow(e.g, 1. / 2.4) - .055, e.b < .0031308 ? e.b * 12.92 : 1.055 * pow(e.b, 1. / 2.4) - .055);\n}\nvec3 f(const in vec4 e, const in float h) {\n  if(h <= .0)\n    return e.rgb;\n  return h * e.rgb * e.a;\n}\nfloat i(const float j, const float k) {\n  return mix(j, k * 2. - j, bloomRadius);\n}\nvec4 l(sampler2D m, vec2 n) {\n  vec4 e;\n  mediump vec2 o = vec2(1. / outputSize.x, 1. / outputSize.y);\n  vec3 u = texture2D(m, (n + vec2(-1., -1.)) * o).xyz;\n  vec3 v = texture2D(m, (n + vec2(1., -1.)) * o).xyz;\n  vec3 A = texture2D(m, (n + vec2(-1., 1.)) * o).xyz;\n  vec3 B = texture2D(m, (n + vec2(1.)) * o).xyz;\n  vec4 C = texture2D(m, n * o);\n  vec3 D = C.xyz;\n  vec3 E = vec3(.299, .587, .114);\n  float F = dot(u, E);\n  float G = dot(v, E);\n  float H = dot(A, E);\n  float I = dot(B, E);\n  float J = dot(D, E);\n  float K = min(J, min(min(F, G), min(H, I)));\n  float L = max(J, max(max(F, G), max(H, I)));\n  mediump vec2 M;\n  M.x = -((F + G) - (H + I));\n  M.y = (F + H) - (G + I);\n  float N = max((F + G + H + I) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float O = 1. / (min(abs(M.x), abs(M.y)) + N);\n  M = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), M * O)) * o;\n  vec4 P = .5 * (texture2D(m, n * o + M * (1. / 3. - .5)) + texture2D(m, n * o + M * (2. / 3. - .5)));\n  vec4 Q = P * .5 + .25 * (texture2D(m, n * o + M * -.5) + texture2D(m, n * o + M * .5));\n  float R = dot(Q.xyz, E);\n  if(R < K || R > L)\n    e = P;\n  else\n    e = Q;\n  return e;\n}\nvec4 S() {\n  vec3 T = vec3(.0);\n  const float U = .6;\n  const float V = 1.1;\n  const float W = .9;\n  const float X = .6;\n  const float Y = .3;\n  const float Z = .1;\n  T += (vec4(f(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * i(V, U);\n  T += (vec4(f(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * i(W, U);\n  T += (vec4(f(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * i(X, U);\n  T += (vec4(f(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * i(Y, U);\n  T += (vec4(f(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * i(Z, U);\n  vec4 ba;\n  if(enableAA == 1.) {\n    ba = l(TextureInput, gl_FragCoord.xy);\n  } else {\n    ba = texture2D(TextureInput, c);\n  }\n  ba.rgb = mix(vec3(.0), ba.rgb, sign(ba.a));\n  vec4 bb = texture2D(TextureSource, c);\n#ifdef HAS_NOAA_TEX\nvec4 bc = texture2D(noAaTextureSource, c);\n  bb = bc + bb * (1. - bc.a);\n#endif\nvec4 bd = vec4(.0);\n#ifdef HAS_POINT_TEX\nbd = texture2D(pointTextureSource, c);\n#endif\nfloat be = sqrt((T.r + T.g + T.b) / 3.);\n  vec4 bf = vec4(d(T * bloomFactor), be);\n  return bd + (ba + bb * (1. - ba.a)) * (1. - bd.a) + bf;\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = S();\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:t}})}}},nb=class extends X_{constructor(){const t=[];super({vert:G_,frag:"precision highp float;\n#include <gl2_frag>\n#define SHADER_NAME COPY_DEPTH\nuniform sampler2D TextureDepth;\nuniform vec2 textureSize;\n#include <common_pack_float>\nvoid main(void) {\n  vec2 c = gl_FragCoord.xy / textureSize.xy;\n  float d = texture2D(TextureDepth, c).r;\n  glFragColor = common_encodeDepth(d);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"textureSize",type:"function",fn:(e,n)=>(t[0]=n.TextureDepth.width,t[1]=n.TextureDepth.height,t)}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.TextureDepth.width,height:(t,e)=>e.TextureDepth.height}}}),this.version=300}getMeshCommand(t,e){return this.commands.copy_depth||(this.commands.copy_depth=this.createREGLCommand(t,null,e.getElements())),this.commands.copy_depth}},rb=class{static getUniformDeclares(){const t=[[0,0,0,0],[0,0,0,0]],e=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(t,n)=>sm(e,n.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(e,n){const r=Math.tan(.5*n.fov),i=n.outSize[0]/n.outSize[1]*r;return cA(t[0],i,r,i,-r),cA(t[1],-i,r,-i,-r),t}},{name:"reprojViewProjMatrix",type:"function",fn:(t,e)=>am([],e.prevProjViewMatrix,e.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(t){this._regl=t,this._renderer=new f_(t),this._inputRGBM=0}setup(t){this._initShaders(),this._createTextures(t)}getSSRUniforms(t,e,n){if(!this._depthCopy)return null;const r=this._depthCopy;return{TextureDepth:r,TextureReflected:this.getMipmapTexture(),ssrFactor:e||1,ssrQuality:n||2,outSize:[r.width,r.height],fov:t.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||t.projViewMatrix,cameraWorldMatrix:t.cameraWorldMatrix}}genMipMap(t,e,n){return this.setup(t),this._mipmap(t),this.copyDepthTex(e),this._projViewMatrix||(this._projViewMatrix=[]),rm(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(t){return this._depthCopied?null:(this.setup(t),this._depthCopy?t.width===this._depthCopy.width&&t.height===this._depthCopy.height||this._depthCopyFBO.resize(t.width,t.height):(this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:t.width,height:t.height}),this._depthCopyFBO=this._regl.framebuffer({width:t.width,height:t.height,colors:[this._depthCopy],colorFormat:"rgba"})),this._renderer.render(this._copyDepthShader,{TextureDepth:t},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy)}_mipmap(t){const e=this._targetFBO,n=Math.ceil(.5*t.width),r=Math.ceil(.5*t.height);e.width===n&&e.height===r||e.resize(n,r);let i=this._blurUniforms;i||(i=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),i.TextureInput=t,i.inputRGBM=+this._inputRGBM,Ly(i.outputSize,e.width,e.height),this._renderer.render(this._ssrQuadShader,i,null,e)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){this._copyDepthShader||(this._copyDepthShader=new nb,this._ssrQuadShader=new X_({vert:G_,frag:"#version 100\nprecision mediump float;\nuniform sampler2D TextureInput;\nuniform vec2 outputSize;\n#define SHADER_NAME QUAD\nvec2 c;\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 d = texture2D(TextureInput, c.xy);\n  gl_FragColor = d;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}))}_createTextures(t){if(!this._targetFBO){const e=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=e.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height}),this._targetFBO=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1})}}},ib=class extends U_{constructor(t){const e=[];super({vert:"#define SHADER_NAME HEATMAP\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\nuniform float heatmapIntensity;\nattribute vec3 aPosition;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nattribute highp float aWeight;\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\nuniform mediump float heatmapRadius;\nconst highp float c = 1. / 255. / 16.;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float d = aWeight / 255.;\n  weight = d;\n#else\nhighp float d = heatmapWeight;\n#endif\nmediump float e = heatmapRadius;\n  vec2 f = vec2(mod(aPosition.xy, 2.) * 2. - 1.);\n  float h = sqrt(-2. * log(c / d / heatmapIntensity / GAUSS_COEF)) / 3.;\n  vExtrude = h * f;\n  vec2 i = vExtrude * e * extrudeScale;\n  vec4 j = vec4(floor(aPosition.xy * .5) + i, aPosition.z, 1);\n  gl_Position = projViewModelMatrix * j;\n}",frag:"#define SHADER_NAME HEATMAP\nprecision mediump float;\nuniform highp float heatmapIntensity;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float c = weight;\n#else\nhighp float c = heatmapWeight;\n#endif\nfloat d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);\n  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);\n  gl_FragColor = vec4(e, 1., 1., 1.);\n}",uniforms:[{name:"extrudeScale",type:"function",fn:function(t,e){return e.resolution/e.dataResolution*e.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return am(e,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:Hv({},t&&t.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}};var ob=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],sb="#define SHADER_NAME SKYBOX\n#if __VERSION__ == 100\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\nprecision highp float;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nvarying vec3 vWorldPos;\n#ifdef USE_AMBIENT\nuniform vec3 diffuseSPH[9];\n#else\nuniform samplerCube cubeMap;\nuniform float bias;\nuniform float size;\n#endif\nuniform float environmentExposure;\nuniform float backgroundIntensity;\nvec4 c(const in samplerCube d, const in vec3 e, const in float f, const in float h) {\n  vec3 i = e;\n  return textureCubeLod(d, i, h);\n}\nvec3 j(const in vec3 k, const in vec3 l[9]) {\n  float x = k.x;\n  float y = k.y;\n  float z = k.z;\n  vec3 m = (l[0] + l[1] * x + l[2] * y + l[3] * z + l[4] * z * x + l[5] * y * z + l[6] * y * x + l[7] * (3. * z * z - 1.) + l[8] * (x * x - y * y));\n  return max(m, vec3(.0));\n}\nfloat n(const in vec2 o) {\n  vec3 u = fract(vec3(o.xyx) * .1031);\n  u += dot(u, u.yzx + 19.19);\n  return fract((u.x + u.y) * u.z);\n}\n#if defined(TONE_MAPPING)\nconst float v = 1.;\nvec3 A(vec3 B) {\n  vec3 a = B * (B + .0245786) - .000090537;\n  vec3 b = B * (.983729 * B + .4329510) + .238081;\n  return a / b;\n}\nvec3 C(vec3 D) {\n  const mat3 E = mat3(vec3(.59719, .07600, .02840), vec3(.35458, .90834, .13383), vec3(.04823, .01566, .83777));\n  const mat3 F = mat3(vec3(1.60475, -.10208, -.00327), vec3(-.53108, 1.10813, -.07276), vec3(-.07367, -.00605, 1.07602));\n  D *= v / .6;\n  D = E * D;\n  D = A(D);\n  D = F * D;\n  return saturate(D);\n}\nvec3 G(vec3 D) {\n  return C(D);\n}\nvec4 H(in vec4 I) {\n  return vec4(mix(pow(I.rgb, vec3(.41666)) * 1.055 - vec3(.055), I.rgb * 12.92, vec3(lessThanEqual(I.rgb, vec3(.0031308)))), I.a);\n}\nvec4 J(vec4 I) {\n  return (H(I));\n}\n#endif\nvoid main() {\n  vec4 K;\n#ifdef USE_AMBIENT\nvec3 k = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., n(gl_FragCoord.xy)) * 2.);\n  K = vec4(j(k, diffuseSPH), 1.);\n#else\nK = c(cubeMap, vWorldPos, size, bias);\n#endif\nK.rgb *= environmentExposure;\n  K.rgb *= backgroundIntensity;\n  glFragColor = K;\n  if(length(hsv) > .0) {\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\n  }\n#if defined(TONE_MAPPING)\nglFragColor.rgb = G(glFragColor.rgb);\n  glFragColor = J(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}";let ab=class extends U_{constructor(){super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 transformMatrix;\nvarying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = aPosition;\n  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);\n  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);\n  gl_Position = d.xyww;\n}",frag:sb,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this.version=300}setMode(t,e){const n={};return t&&(n.TONE_MAPPING=1),0===e&&(n.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(n):this._meshDefines=n,this}draw(t){return this._skyboxMesh||this._createSkyboxMesh(t),super.draw(t,this._skyboxMesh)}_createSkyboxMesh(t){const e=new bx({aPosition:new Int8Array(ob)},null,ob.length/3);e.generateBuffers(t),this._skyboxMesh=[new h_(e)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const t=this._skyboxMesh[0];t.geometry.dispose(),t.dispose()}return delete this._skyboxMesh,super.dispose()}},lb=class extends U_{constructor(t,e){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:t};e&&e.extraCommandProps&&Hv(n,e.extraCommandProps);const r=[];super({vert:"#define SHADER_NAME HEATMAP_DISPLAY\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n}",frag:"#define SHADER_NAME HEATMAP_DISPLAY\nprecision mediump float;\nuniform sampler2D inputTexture;\nuniform sampler2D colorRamp;\nuniform vec2 textureOutputSize;\nuniform float heatmapOpacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;\n  float t = texture2D(inputTexture, c).r;\n  vec4 d = texture2D(colorRamp, vec2(t, .5));\n  gl_FragColor = d * heatmapOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(r,e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:n})}},hb=class extends X_{constructor(){super({vert:G_,frag:"precision highp float;\nuniform sampler2D texture;\nuniform vec2 size;\nuniform float enableSharpen;\nuniform float sharpFactor;\nuniform float pixelRatio;\nvec2 c;\nvec3 d(const in vec3 e, const float f) {\n  vec2 h = pixelRatio / size.xy;\n  float i = .0;\n  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));\n  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));\n  i += mix(.0, 1., sign(j.a));\n  vec4 k = texture2D(texture, c + h * vec2(1.));\n  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));\n  i += mix(.0, 1., sign(k.a));\n  vec4 l = texture2D(texture, c + h * vec2(1., -1.));\n  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));\n  i += mix(.0, 1., sign(l.a));\n  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));\n  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));\n  i += mix(.0, 1., sign(m.a));\n  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);\n}\nvoid main() {\n  c = gl_FragCoord.xy / size;\n  vec4 e = texture2D(texture, c);\n  if(enableSharpen == 1.) {\n    e.rgb = d(e.rgb, sharpFactor);\n  }\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.size[0],height:(t,e)=>e.size[1]}}})}getMeshCommand(t,e){return this.commands.copy||(this.commands.copy=this.createREGLCommand(t,null,e.getElements())),this.commands.copy}},ub=class extends U_{constructor(t={}){const e=[],n=t.uniforms,r=[{name:"modelViewMatrix",type:"function",fn:function(t,n){return am(e,n.viewMatrix,n.modelMatrix)}}];n&&r.push(...n),super({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n}",frag:"precision mediump float;\nuniform vec4 lineColor;\nuniform float lineOpacity;\nvoid main() {\n  gl_FragColor = lineColor;\n  gl_FragColor.a *= lineOpacity;\n}",uniforms:r,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}};const cb=[],fb=[];const db=[];let pb=class{constructor(t,e,n){this._regl=t,this._layer=n,this._viewport=e,this._init()}_init(){this._shader=new U_({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec4 vWorldPosition;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  vec4 e = modelMatrix * d * c;\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vWorldPosition = e;\n}",frag:"precision mediump float;\nvarying vec4 vWorldPosition;\nuniform vec2 fogDist;\nuniform vec3 cameraPosition;\nuniform float rainDepth;\nvoid main() {\n  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);\n  float d = length(c);\n  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);\n  if(vWorldPosition[2] < rainDepth) {\n    gl_FragColor = vec4(e, .0, .0, 1.);\n  } else {\n    gl_FragColor = vec4(e, 1., .0, 1.);\n  }\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(db,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}});const t=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(t),this._scene=new __,this.renderer=new f_(this._regl)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,fogDist:e.fogDist,rainDepth:e.rainDepth},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Bv(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Bv(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}},gb=class extends X_{constructor(){super({vert:G_,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_RAIN\nuniform sampler2D ripplesMap;\n#endif\n#ifdef HAS_SNOW\nuniform sampler2D normalMap;\n#endif\n#ifdef HAS_FOG\nuniform vec3 fogColor;\n#endif\nuniform sampler2D sceneMap;\nuniform sampler2D mixFactorMap;\nuniform float time;\nuniform vec2 resolution;\nuniform float snowIntensity;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\n#define HASHSCALE1 .1031\n#define HASHSCALE3 vec3(.1031, .1030, .0973)\n#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)\nfloat d = .5;\nfloat e = .2;\nfloat f = .5;\nfloat h = 20.;\nfloat i(float p) {\n  vec3 j = fract(vec3(p) * HASHSCALE1);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.x + j.y) * j.z);\n}\nvec2 k(vec2 p) {\n  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.xx + j.yz) * j.zy);\n}\nvec2 l(vec2 m) {\n  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);\n  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);\n  return vec2(x, y);\n}\nvec3 n(vec2 o, float u) {\n  vec3 v = vec3(.0);\n  o = o * (2. + u);\n  float A = e * snowIntensity;\n  float B = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * A);\n  float C = (f * time);\n  o += vec2(B, C);\n  vec2 D = k(floor(o) + 31.1759 * u);\n  o = fract(o);\n  o -= (D * 2. - 1.) * .35;\n  o -= .5;\n  float r = length(o);\n  float E = .05 * (1. + .3 * sin(time * d));\n  float F = smoothstep(E, -E, r);\n  vec3 G = vec3(F) * D.x;\n  return G;\n}\nvec3 H() {\n  vec3 v = vec3(0);\n  vec2 o = gl_FragCoord.xy / resolution.xy;\n  o *= vec2(resolution.x / resolution.y, 1.);\n  float I = h * snowIntensity;\n  for(float J = 0.; J < I; J++) {\n    v += n(o, J);\n  }\n  return v;\n}\nvec3 K(vec4 L, vec4 M, float N) {\n  float O = M.b;\n  vec3 P = vec3(1.);\n  if(N < 1.) {\n    float r = c(.5, P.x, O);\n    float g = c(.5, P.y, O);\n    float b = c(.5, P.z, O);\n    return vec3(r, g, b);\n  } else {\n    float r = c(L.r, P.x, O);\n    float g = c(L.g, P.y, O);\n    float b = c(L.b, P.z, O);\n    return vec3(r, g, b);\n  }\n}\nvoid main() {\n  vec4 L = texture2D(sceneMap, vTexCoord);\n  glFragColor = L;\n  vec4 Q = texture2D(mixFactorMap, vTexCoord);\n#ifdef HAS_RAIN\nvec4 R = texture2D(ripplesMap, vTexCoord);\n  if(Q.g < 1.) {\n    L = mix(L, R, .4);\n  }\n  glFragColor = L;\n#endif\n#ifdef HAS_SNOW\nvec3 S = H();\n  glFragColor = vec4(L.rgb + S, L.a);\n#endif\n#ifdef HAS_FOG\nfloat T = Q.r;\n  vec3 U = mix(fogColor, glFragColor.rgb, T);\n  glFragColor = vec4(U, L.a);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}};const mb=[],Ab=[.03,.03,.03],yb=[],vb=[],xb=[],_b=pm([],XA([],90,0,0),[0,0,0]);let bb=class{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new U_({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec2 vTexCoord;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform float rippleRadius;\nuniform float density;\nuniform float time;\nvec3 c(vec2 p) {\n  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));\n  return fract(sin(q) * 43758.5453);\n}\nfloat d(in vec2 x) {\n  vec2 e = x * density / 4000.0;\n  vec2 p = floor(e);\n  vec2 f = fract(e);\n  float h = .0;\n  for(int i = -4; i <= 4; i++)\n    for(int k = -4; k <= 4; k++) {\n      vec2 g = vec2(float(k), float(i));\n      vec3 l = c(p + g);\n      vec2 r = g - f + l.xy;\n      float m = sqrt(dot(r, r));\n      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);\n      h += n;\n    }\n  return h;\n}\nvoid main() {\n  vec2 u = vTexCoord;\n  float A = 24. / (rippleRadius * .01);\n  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));\n  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));\n  glFragColor = vec4(B, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(mb,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new __,this.renderer=new f_(this._regl)}_transformRipples(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),r=Lm(vb,n,n,n),i=Fm(r,Ab,r),o=im(xb);ym(o,XA(yb,0,0,0),[e.x,e.y,0],i),am(o,o,_b),this._mesh.setLocalTransform(o)}_createRipplesMask(t){this._fixZoom=t.getZoom();const e=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const r=new bx(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});r.generateBuffers(this._regl);const i=new Kx;return new h_(r,i)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(t),this._scene.setMeshes(this._mesh),this._transformRipples(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,time:e.time,rippleRadius:e.rippleRadius,density:e.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Bv(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Bv(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}};var wb="attribute vec3 aPosition;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\n#ifdef HAS_VIDEO\nattribute vec2 aTexCoord;\nvarying vec2 uv;\n#endif\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = c * getPosition(aPosition);\n  gl_Position = projViewModelMatrix * d;\n#ifdef HAS_VIDEO\nuv = aTexCoord;\n#endif\n}";const Tb=[0,0,0,1];let Mb=class{constructor(t,e){this.regl=t,this._viewport=e,this.renderer=new f_(t),this._init()}_init(){this._maskColorFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const t=[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am([],e.projViewMatrix,e.modelMatrix)}];this._maskColorShader=new U_({vert:wb,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 maskColor;\n#ifdef HAS_VIDEO\nuniform sampler2D maskTexture;\nvarying vec2 uv;\n#endif\nvoid main() {\n  \n#ifdef HAS_VIDEO\ngl_FragColor = texture2D(maskTexture, uv);\n  gl_FragColor.a = maskColor.a;\n#else\ngl_FragColor = maskColor;\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._maskModeShader=new U_({vert:wb,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float maskMode;\n#ifdef HAS_MASK_FLAT\nuniform float flatHeight;\n#endif\n#ifdef HAS_MASK_COLOR\nuniform vec2 heightRange;\n#endif\nvoid main() {\n  \n#if defined(HAS_MASK_FLAT)\ngl_FragColor = vec4(maskMode, flatHeight, .0, 1.);\n#elif defined(HAS_MASK_COLOR)\ngl_FragColor = vec4(maskMode, .0, heightRange.x, heightRange.y);\n#else\ngl_FragColor = vec4(maskMode, .0, .0, .0);\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._scene=new __}render(t,e){this._resize(),this.renderer.clear({color:Tb,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:Tb,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this._maskColorShader,n,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,n,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_resize(){const t=Bv(this._viewport.width)?this._viewport.width():this._viewport.width.data(),e=Bv(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===t&&this._maskColorFbo.height===e||(this._maskColorFbo.resize(t,e),this._maskModeFbo.resize(t,e))}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader)}};const Cb=[],Sb={width:4,type:"float"};let Ib=class{constructor(t,e,n){this._regl=t,this.joints=e,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*e.length);for(let r=0;r<e.length;++r)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*r,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*r,16));this.jointTextureSize=[4,6]}update(t,e,n){sm(Cb,t);for(let i=0;i<this.joints.length;++i){const t=this.jointMatrices[i];am(t,Cb,e[this.joints[i].nodeIndex]),am(t,t,this.inverseBindMatrices[i])}Sb.height=this.joints.length,Sb.data=this.jointData;const r=Sb;return n?n(r):n=this._regl.texture(r),n}};const Pb=[0,0,0],Eb=[0,0,0,1],Ob=[1,1,1],Rb=[];let kb=class{constructor(t=[0,0,0],e=[0,0,0,1],n=[1,1,1]){this.translation=t,this.rotation=e,this.scale=n}getMatrix(){return ym(Rb,this.rotation,this.translation,this.scale)}decompose(t){gm(this.translation,t),Am(this.rotation,t),mm(this.scale,t)}update(t){t&&(t.translation&&!Jm(t.translation,Pb)&&km(this.translation,t.translation),t.rotation&&!gy(t.rotation,Eb)&&ny(this.rotation,t.rotation),t.scale&&!Jm(t.scale,Ob)&&km(this.scale,t.scale))}},Lb=class{constructor(t){this._init(t)}_init(t){this.bbox=t.bbox,this.geometry=t.geometry,this.nodeMatrix=t.nodeMatrix,this.materialInfo=t.materialInfo,this.extraInfo=t.extraInfo,this.animationMatrix=t.animationMatrix,this.morphWeights=t.morphWeights,this.skin=t.skin,this.nodeIndex=t.nodeIndex}copyEdgeGeometry(){this.copyGeometry||(this.copyGeometry=this._copyEdgeGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyEdgeGeometry(t){const e=t.data,n=t.indices||t.elements,r={};for(const a in e)if(a===t.desc.positionAttribute)if(Gv(e[a]))r[a]=e[a].slice();else if(e[a].buffer&&e[a].buffer.destroy)r[a]={buffer:e[a].buffer},Gv(e[a].array)&&(r[a].array=e[a].array.slice());else{const e=t._getAttributeData(a);r[a]=a!==t.desc.positionAttribute?e:e.slice()}const i=void 0!==n.length?n.slice():n,o=JSON.parse(JSON.stringify(t.desc)),s=new Zx(r,i,0,o);return s.properties=t.properties,s}},Db=0;const Nb=[];let Fb=class{constructor(t,e){this.gltf=t,this.regl=e,this.geometries=[],e&&(this._emptyTexture=e.texture({width:2,height:2}))}getMeshesInfo(){return this.gltf?(this.geometries.length||(this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins),this.gltf.scenes[0].nodes.forEach((t=>{this._parserNode(t,this.geometries)})),this._checkBaseColorFactor()),this.geometries):null}getGLTFBBox(){if(!this.gltf)return null;const t=this.geometries;if(!t||!t.length)return null;const e=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(let r=0;r<t.length;r++){const i=t[r].bbox,o=i.min,s=i.max;o[0]<e[0]&&(e[0]=o[0]),o[1]<e[1]&&(e[1]=o[1]),o[2]<e[2]&&(e[2]=o[2]),s[0]>n[0]&&(n[0]=s[0]),s[1]>n[1]&&(n[1]=s[1]),s[2]>n[2]&&(n[2]=s[2])}return{min:e,max:n}}_createSkins(t){if(t){this._skinMap={};for(let e=0;e<t.length;e++){const n=t[e];n.joints=n.joints.map((t=>this.gltf.nodes[t])),this._skinMap[e]=new Ib(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(t){if(t){this._textureMap={};for(let e=0;e<t.length;e++){const n=t[e];this._textureMap[e]||(this._textureMap[e]=this._toTexture(n),delete n.image)}}}_checkBaseColorFactor(){if(!this._checkBaseColorFactorAlpha())for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;e&&0===e[3]&&(e[3]=1)}}_checkBaseColorFactorAlpha(){for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;if(e&&e[3]>0)return!0}return!1}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const t=this.getMeshesInfo();if(t){t.forEach((t=>{t.geometry.dispose();for(const e in t.materialInfo){const n=t.materialInfo[e];n&&n.destroy&&!n[lx]&&n.destroy()}}));for(const t in this._textureMap){const e=this._textureMap[t];e&&e.destroy&&!e[lx]&&e.destroy()}delete this.gltf}}updateAnimation(t,e,n,r,i,o,s,a){const l=this.gltf;if(!l)return;if(Db=l.animations?gg.getAnimationTimeSpan(l,r):null,!Db)return;t-=i;let h=0;h=e||!e&&this._isFirstLoop(t,n,r,i)?t*n*.001%(Db.max-Db.min)+Db.min:t*n*.001+Db.min,l.scenes[0].nodes.forEach((t=>{this._updateNodeMatrix(r,h,t,null,o,a)}));for(const u in this.gltf.nodes){const t=this.gltf.nodes[u],e=o[t.nodeIndex];if(t.skin&&e){const n=t.skin.update(e,o,s[t.nodeIndex]&&s[t.nodeIndex].jointTexture);s[t.nodeIndex]||(s[t.nodeIndex]={jointTextureSize:t.skin.jointTextureSize,numJoints:t.skin.joints.length}),s[t.nodeIndex].jointTexture=n}}}_isFirstLoop(t,e,n,r){const i=this.gltf;return!r||!i||(Db=i.animations?gg.getAnimationTimeSpan(i,n):null,t*e*.001/(Db.max-Db.min)<1)}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(t,e,n,r,i,o){n.trs&&(o?o.indexOf(Number(n.nodeIndex))>-1&&this._updateNodeTRS(n,e,t):this._updateNodeTRS(n,e,t)),i[n.nodeIndex]=r?am(i[n.nodeIndex]||[],r,n.matrix||n.trs.getMatrix()):rm(i[n.nodeIndex]||[],n.matrix||n.trs.getMatrix()),n.children&&n.children.forEach((r=>{this._updateNodeMatrix(t,e,r,i[n.nodeIndex],i,o)}))}_updateNodeTRS(t,e,n){const r=gg.getAnimationClip(this.gltf,Number(t.nodeIndex),e,n);r.weights&&this._updateMorph(t,r.weights),t.trs.update(r)}_updateMorph(t,e){const n=e.length;if(!t.influencesList){t.influencesList=[];for(let e=0;e<n;e++)t.influencesList[e]=[e,0]}const r=t.influencesList;for(let o=0;o<r.length;o++){const t=r[o];t[0]=o,t[1]=e[o]}r.sort(Bb);const i=[];for(let o=0;o<8;o++)i[o]=[o,0];for(let o=0;o<8;o++)o<n&&r[o][1]?(i[o][0]=r[o][0],i[o][1]=r[o][1]):(i[o][0]=Number.MAX_SAFE_INTEGER,i[o][1]=0);i.sort(zb),t.geometries.forEach((t=>{const e=t.properties.morphTargets;for(let n=0;n<8;n++){const r=i[n],o=r[0],s=r[1];o!==Number.MAX_SAFE_INTEGER&&s?(t.updateData("POSITION"+n,e["POSITION_"+o].array),t.properties.morphWeights[n]=s):t.properties.morphWeights[n]=0}}))}_parserNode(t,e,n){if(t.isParsed)return;t.nodeMatrix=t.nodeMatrix||im([]),t.localMatrix=t.localMatrix||im([]),t.matrix?(t.trs=new kb,t.trs.decompose(t.matrix)):t.trs=new kb(t.translation,t.rotation,t.scale),t.localMatrix=t.trs.getMatrix(),n?am(t.nodeMatrix,n,t.matrix||t.localMatrix):rm(t.nodeMatrix,t.matrix||t.localMatrix);const r=t.nodeMatrix;if(t.children)for(let i=0;i<t.children.length;i++)this._parserNode(t.children[i],e,r);if(zv(t.skin)){this._isAnimation=!0;const e=t.skin;t.trs=new kb,t.skin=this._skinMap[e]}zv(t.mesh)&&(t.mesh=this.gltf.meshes[t.mesh],t.mesh.node=t,t.geometries=t.geometries||[],t.mesh.primitives.forEach((n=>{const i=this._createMaterialInfo(n.material),o=function(t,e,n){const r=t.attributes,i=r.COLOR_0;if(i&&i.array instanceof Float32Array){const t=new Uint8Array(i.array.length);for(let e=0;e<t.length;e++)t[e]=Math.round(255*i.array[e]);i.array=t}else if(i&&(i.array instanceof Uint16Array||i.array instanceof Int16Array||i.array instanceof Uint32Array||i.array instanceof Int32Array)){const t=new Uint8Array(i.array);i.array=t}n&&r.TEXCOORD_0&&!r.TEXCOORD_0&&(r.TEXCOORD_1=r.TEXCOORD_0);const o={};for(const l in r)o[l]=Hv({},r[l]),e&&(o[l].buffer=zx(e,r[l],{dimension:r[l].itemSize}));if(t.morphTargets){const t=tx(o.POSITION)?o.POSITION.itemSize*o.POSITION.count:o.POSITION.array.length;for(let e=0;e<8;e++)o[`POSITION${e}`]||(o[`POSITION${e}`]=new Float32Array(t).fill(0));for(let e=0;e<4;e++)o[`NORMAL${e}`]||(o[`NORMAL${e}`]=new Float32Array(o.NORMAL.array?o.NORMAL.array.length:o.NORMAL.length).fill(0))}let s=t.indices;s&&void 0===s.bufferView&&s.array&&(s=s.array);const a=new bx(o,s,0,{primitive:Uv(t.mode)?Mx(t.mode):t.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});return t.morphTargets&&(a.properties.morphWeights=[]),t.mode>3&&!a.data.NORMAL&&a.createNormal("NORMAL"),a}(n,this.regl,i.occlusionTexture);o.properties.morphTargets=n.morphTargets,t.geometries.push(o);let s=o.boundingBox.copy();s=s.transform(im(Nb),r);const a={geometry:o,bbox:s,nodeMatrix:r,materialInfo:i,extraInfo:this._createExtralInfo(n.material),animationMatrix:t.trs.getMatrix(),morphWeights:t.weights,nodeIndex:t.nodeIndex};t.skin&&(a.skin={jointTextureSize:[4,6],numJoints:t.skin.joints.length,jointTexture:t.skin.jointTexture});const l=new Lb(a);e.push(l)}))),t.isParsed=!0}_createMaterialInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t],r=n.pbrMetallicRoughness;if(r){const t=r.metallicRoughnessTexture,n=r.baseColorTexture;n&&(e.baseColorTexture=this._getTexture(n),n.KHR_texture_transform&&(e.khr_offset=n.KHR_texture_transform.offset||[0,0],e.khr_rotation=n.KHR_texture_transform.rotation||0,e.khr_scale=n.KHR_texture_transform.scale||[1,1])),r.baseColorFactor&&(e.baseColorFactor=r.baseColorFactor),t?e.metallicRoughnessTexture=this._getTexture(t):(e.metallicFactor=zv(r.metallicFactor)?r.metallicFactor:1,e.roughnessFactor=zv(r.roughnessFactor)?r.roughnessFactor:1)}const i=n.extensions;if(i&&i.KHR_materials_pbrSpecularGlossiness){const t=i.KHR_materials_pbrSpecularGlossiness;e.name="pbrSpecularGlossiness";for(const n in t)e[n]=zv(t[n].index)?this._getTexture(t[n]):t[n]}n.normalTexture&&(e.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(e.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(e.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(e.emissiveFactor=n.emissiveFactor),e.alphaCutoff=n.alphaCutoff||.5,e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_createExtralInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t];e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_getTexture(t){const e=t.extensions,n=t.index;if(!zv(n))return null;e&&e.KHR_texture_transform&&(t.KHR_texture_transform=e.KHR_texture_transform);const r=this._textureMap[n];return r.texInfo=t,r}_toTexture(t){if(!t)return this._emptyTexture;const e=t.sampler||{};return new O_({width:t.image.width,height:t.image.height,data:t.image.array,mag:Ox(e.magFilter)||"linear",min:kx(e.minFilter)||"linear mipmap linear",wrapS:Dx(e.wrapS)||"repeat",wrapT:Dx(e.wrapT)||"repeat"})}};function zb(t,e){return t[0]-e[0]}function Bb(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Hb(t,e){const{fetchOptions:n,gltfLoaderOptions:r,urlModifier:i}=e,o=r||{};o.urlModifier=i;const s=t.lastIndexOf("/"),a=t.slice(0,s),l=t.slice(t.lastIndexOf(".")).toLowerCase();return".gltf"===l?Yp.getJSON(t,n,i).then((t=>Ub(a,t,o))):".glb"===l?Yp.getArrayBuffer(t,n,i).then((t=>Ub(a,{buffer:t.data,byteOffset:0},o))):null}function jb(t,e){return new Fb(t,e)}function Ub(t,e,n){return new gg(t,e,n).load()}var Vb=Object.freeze({__proto__:null,exportGLTFPack:jb,load:Hb,loadGLTF:Ub});const Gb=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],Wb=[3,1,0,0,2,3],qb=[0,0,1,0,0,1,1,1],Xb={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},Zb=["cube","plane","pyramid"],Yb={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])},TEXCOORD_0:{array:new Int8Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},"plane-cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(Gb)},TEXCOORD_0:{array:new Int8Array(qb)}},indices:new Uint16Array(Wb),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60],translation:[0,-60,0]},{mesh:0,scale:[60,60,60],translation:[0,60,0]},{mesh:0,scale:[60,60,60],translation:[60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[-60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,60],rotation:[.7071067811865475,0,0,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,-60],rotation:[.7071067811865475,0,0,.7071067811865476]}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(Gb)},NORMAL:{array:new Int8Array([0,1,0,0,1,0,0,1,0,0,1,0])},TEXCOORD_0:{array:new Int8Array(qb)}},indices:new Uint16Array(Wb),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(Xb.vertices)},NORMAL:{array:new Float32Array(Xb.normals)},TEXCOORD_0:{array:new Float32Array(Xb.uv)}},indices:new Uint16Array(Xb.indices),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]}};let Jb=class{constructor(t,e){this.regl=t,this.resourceMap={},this.options=e||{}}getGLTF(t){return this.resourceMap[t]}loginGLTF(t,e){if(this.resourceMap[t])this.resourceMap[t].refCount+=1;else{if(Yb[t]){const e=function(t){let e=null;return Yb[t]&&(e={meshes:Yb[t].meshes},e.scenes=JSON.parse(JSON.stringify(Yb[t].scenes))),e}(t);this.resourceMap[t]=this._exportGLTFResource(e,t,!1)}else this.resourceMap[t]=e?e(t).then((e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t]))):this._loadGLTFModel(t);this.resourceMap[t].refCount=1}}logoutGLTF(t){if(this.resourceMap[t]&&(this.resourceMap[t].refCount-=1,this.resourceMap[t].refCount<1)){const e=this.resourceMap[t].resources;if(e)for(let t=0;t<e.length;t++)e[t].geometry.dispose(),e[t].copyGeometry&&e[t].copyGeometry.dispose(),e[t].material&&e[t].material.dispose();this.resourceMap[t].gltfPack&&this.resourceMap[t].gltfPack.dispose(),delete this.resourceMap[t]}}isSimpleModel(t){return Yb[t]}addSimpleModel(t,e){var n,r;r=e,"string"==typeof(n=t)&&Zb.indexOf(n)<0&&(Yb[n]=r)}removeSimpleModel(t){delete Yb[t]}_exportGLTFResource(t,e,n=!0){if(!t)return null;const r=jb(t,n?this.regl:null),i=r.getMeshesInfo();return{bbox:r.getGLTFBBox(),gltfPack:r,resources:i,json:t.json,refCount:this.resourceMap[e]?this.resourceMap[e].refCount:0}}fetchGLTF(t){return Hb(t,this.options).then((t=>t))}_loadGLTFModel(t){return this.fetchGLTF(t).then((e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t])))}};const Qb=function(){const t=[0,0,0],e=90*Math.PI/180,n=[0,0,0,0],r=new Array(16);return function(i,o,s,a,l,h){const u=[Tm([],t,[1,0,0],h&&h[0]||[0,-1,0]),Tm([],t,[-1,0,0],h&&h[1]||[0,-1,0]),Tm([],t,[0,1,0],h&&h[2]||[0,0,1]),Tm([],t,[0,-1,0],h&&h[3]||[0,0,-1]),Tm([],t,[0,0,1],h&&h[4]||[0,-1,0]),Tm([],t,[0,0,-1],h&&h[5]||[0,-1,0])],c={context:{viewMatrix:function(t,e,n){return u[n]},projMatrix:_m(r,e,1,.5,1.1)}};return o&&(c.framebuffer=o.faces?function(t,e,n){return o.faces[n]}:o),i(c)(6,((t,e,r)=>{const h={color:n,depth:1};o&&(h.framebuffer=o.faces?o.faces[r]:o),i.clear(h),s(a),l&&l()})),o}}();var Kb={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},$b="#define SHADER_NAME CUBE_MAP\nattribute vec3 aPosition;\nvarying vec3 vWorldPos;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nvoid main() {\n  vWorldPos = aPosition;\n  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);\n}";function tw(t,e){const n=t[0],r=t[1],i=t[2];return 0===e?1:1===e?n:2===e?r:3===e?i:4===e?n*i:5===e?r*i:6===e?n*r:7===e?3*i*i-1:n*n-r*r}const ew={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},nw=["px","nx","py","ny","pz","nz"],rw=L_.compile(sb);function iw(t,e,n,r,i=1,o=!1){const s=t({frag:(o?"#define ENCODE_RGBM\n":"")+"#define SHADER_NAME CUBEMAP\nprecision highp float;\nuniform samplerCube cubeMap;\nuniform float exposure;\nvarying vec3 vWorldPos;\n#ifdef ENCODE_RGBM\nvec4 c(const in vec3 d, const in float e) {\n  if(e <= .0)\n    return vec4(d, 1.);\n  vec4 f;\n  vec3 h = d / e;\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\n  f.a = ceil(f.a * 255.) / 255.;\n  f.rgb = h / f.a;\n  return f;\n}\n#endif\nvoid main() {\n  vec4 i = textureCube(cubeMap, vWorldPos);\n  i.rgb *= exposure;\n#ifdef ENCODE_RGBM\ni = c(i.rgb, 7.);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = i;\n#endif\n}",vert:$b,attributes:{aPosition:Kb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,exposure:i},elements:Kb.indices}),a=[],l=t.texture({radius:n,min:"linear",mag:"linear",type:r?"float":"uint8",format:"rgba"}),h=t.framebuffer({radius:n,color:l});return Qb(t,h,s,{size:n},(function(){const e=t.read();if(r){const t=new Uint16Array(e.length);for(let n=0;n<e.length;n++)t[n]=Math.min(E_(e[n]),65504);a.push(t)}else a.push(e)})),s.destroy(),h.destroy(),a}const ow=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),sw=new Int8Array([0,1,0,0,1,1,1,0]);function aw(t,e,n,r){e=e||256;const i=lw(n=n||1024,r=r||256),o=t.texture({data:i,width:r,height:n,min:"nearest",mag:"nearest"}),s=t.buffer(ow),a=t.buffer(sw),l=t.framebuffer({radius:e,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),h=t({frag:"precision highp float;\nvarying vec2 vTexCoords;\nuniform sampler2D distributionMap;\nconst float c = 3.14159265359;\nvec4 d(float a, float b) {\n  a *= 65535.;\n  b *= 65535.;\n  vec4 rgba;\n  rgba[0] = mod(a, 255.);\n  rgba[1] = (a - rgba[0]) / 65280.0;\n  rgba[2] = mod(b, 255.);\n  rgba[3] = (b - rgba[2]) / 65280.0;\n  return rgba;\n}\nvec3 e(float f, vec3 h, float i) {\n  vec4 j = texture2D(distributionMap, vec2(i, f));\n  vec3 k = j.xyz;\n  float l = sign(j.w - .5);\n  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);\n  k.x *= l;\n  k.y *= m;\n  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 o = normalize(cross(n, h));\n  vec3 u = cross(h, o);\n  vec3 v = o * k.x + u * k.y + h * k.z;\n  return normalize(v);\n}\nfloat A(float B, float i) {\n  float a = i;\n  float C = (a * a) / 2.;\n  float D = B;\n  float E = B * (1. - C) + C;\n  return D / E;\n}\nfloat F(float B, float G, float i) {\n  float I = A(B, i);\n  float J = A(G, i);\n  return J * I;\n}\nvec2 K(float B, float i) {\n  vec3 L;\n  L.x = sqrt(1. - B * B);\n  L.y = .0;\n  L.z = B;\n  float M = .0;\n  float O = .0;\n  vec3 h = vec3(.0, .0, 1.);\n  const int P = 1024;\n  for(int Q = 0; Q < P; ++Q) {\n    vec3 k = e(float(Q) / float(P), h, i);\n    vec3 R = normalize(2. * dot(L, k) * k - L);\n    float G = max(R.z, .0);\n    float S = max(k.z, .0);\n    float T = max(dot(L, k), .0);\n    float B = max(dot(h, L), .0);\n    if(G > .0) {\n      float U = F(B, G, i);\n      float W = (U * T) / (S * B);\n      float X = pow(1. - T, 5.);\n      M += (1. - X) * W;\n      O += X * W;\n    }\n  }\n  M /= float(P);\n  O /= float(P);\n  return vec2(M, O);\n}\nvoid main() {\n  vec2 Y = K(vTexCoords.x, vTexCoords.y);\n  gl_FragColor = d(Y.x, Y.y);\n}",vert:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoords;\nvoid main() {\n  vTexCoords = aTexCoord;\n  gl_Position = vec4(aPosition, 1.);\n}",attributes:{aPosition:{buffer:s},aTexCoord:{buffer:a}},uniforms:{distributionMap:o},framebuffer:l,viewport:{x:0,y:0,width:e,height:e},count:ow.length/3,primitive:"triangle strip"});return h(),h.destroy(),s.destroy(),a.destroy(),o.destroy(),l}function lw(t,e){const n=new Float32Array(t*e*4);for(let r=0;r<t;r++){const{x:i,y:o}=hw(r,t);for(let t=0;t<e;t++){const s=t/e,a=s*s,l=2*Math.PI*i,h=Math.sqrt((1-o)/(1+(a*a-1)*o)),u=Math.sqrt(1-h*h),c=4*(r*e+t),f=u*Math.cos(l),d=u*Math.sin(l);n[c]=Math.abs(255*f),n[c+1]=Math.abs(255*d),n[c+2]=255*h,n[c+3]=(f>0?200:0)+(d>0?55:0)}}return n}function hw(t,e){let n=(t<<16|t>>>16)>>>0;return n=((1431655765&n)<<1|(2863311530&n)>>>1)>>>0,n=((858993459&n)<<2|(3435973836&n)>>>2)>>>0,n=((252645135&n)<<4|(4042322160&n)>>>4)>>>0,n=(((16711935&n)<<8|(4278255360&n)>>>8)>>>0)/4294967296,{x:t/e,y:n}}function uw(t){return t._gl instanceof WebGL2RenderingContext||t.hasExtension("OES_texture_half_float")}var cw=Object.freeze({__proto__:null,createIBLMaps:function(t,e={}){const n=e.envTexture,r=e.envCubeSize||512,i=e.sampleSize||1024,o=e.roughnessLevels||256,s=e.prefilterCubeSize||256;let a,l=!1;if(Array.isArray(n)){const e=t.cube({flipY:!0,faces:n});a=function(t,e,n){const r=t({frag:rw,vert:$b,attributes:{aPosition:Kb.vertices},uniforms:{hsv:[0,0,0],projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,bias:0,size:e.width,environmentExposure:1,backgroundIntensity:1},elements:Kb.indices}),i=t.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),o=t.framebufferCube({radius:n,color:i});return Qb(t,o,r,{size:n},null,[[0,0,-1],[0,0,-1],[0,0,1],[0,0,1],[0,-1,0],[0,-1,0]]),r.destroy(),o}(t,e,r),e.destroy()}else a=function(t,e,n){if(!uw(t))throw new Error("HDR is not supported for lack of support for float 16 texture");n=n||512;const r=t({frag:"precision highp float;\n#define PI 3.1415926\nvarying vec3 vWorldPos;\nuniform sampler2D equirectangularMap;\nconst vec2 c = vec2(.1591, .3183);\nvec2 d(vec3 e) {\n  vec2 f = vec2(atan(e.y, e.x), asin(e.z));\n  f *= c;\n  f += .5;\n  return f;\n}\nvoid main() {\n  vec2 f = d(normalize(vWorldPos));\n  vec4 h = texture2D(equirectangularMap, f);\n  gl_FragColor = vec4(h.rgb, 1.);\n}",vert:$b,attributes:{aPosition:Kb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),equirectangularMap:e},elements:Kb.indices}),i=t.cube({width:n,height:n,min:"linear mipmap linear",mag:"linear",type:"float16",format:"rgba"}),o=t.framebufferCube({radius:n,color:i});return Qb(t,o,r),r.destroy(),o}(t,n,r),l=!0;const{prefilterMap:h,prefilterMipmap:u}=function(t,e,n,r,i,o){const s=function(t,e,n,r,i,o){const s=lw(r=r||1024,i=i||256),a=t.texture({data:s,width:i,height:r,min:"nearest",mag:"nearest"}),l=t({frag:"#define SHADER_NAME PBR_prefilter\nprecision highp float;\nvarying vec3 vWorldPos;\nuniform samplerCube environmentMap;\nuniform sampler2D distributionMap;\nuniform float roughness;\nuniform float resolution;\nconst float c = 3.14159265359;\nfloat d(vec3 e, vec3 f, float h) {\n  float a = h * h;\n  float i = a * a;\n  float j = max(dot(e, f), .0);\n  float k = j * j;\n  float l = i;\n  float m = (k * (i - 1.) + 1.);\n  m = c * m * m;\n  return l / m;\n}\nvec3 n(float o, vec3 e, float h) {\n  vec4 u = texture2D(distributionMap, vec2(h, o));\n  vec3 f = u.xyz;\n  float v = sign(u.w - .5);\n  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);\n  f.x *= v;\n  f.y *= A;\n  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 C = normalize(cross(B, e));\n  vec3 D = cross(e, C);\n  vec3 E = C * f.x + D * f.y + e * f.z;\n  return normalize(E);\n}\nvoid main() {\n  vec3 e = normalize(vWorldPos);\n  vec3 F = e;\n  vec3 G = F;\n  const int I = 1024;\n  vec3 J = vec3(.0);\n  float K = .0;\n  for(int L = 0; L < I; ++L) {\n    vec3 f = n(float(L) / float(I), e, roughness);\n    vec3 M = normalize(2. * dot(G, f) * f - G);\n    float O = max(dot(e, M), .0);\n    if(O > .0) {\n      J += textureCube(environmentMap, M).rgb * O;\n      K += O;\n    }\n  }\n  J = J / K;\n  gl_FragColor = vec4(J, 1.);\n}",vert:$b,attributes:{aPosition:Kb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),environmentMap:e,distributionMap:a,roughness:t.prop("roughness"),resolution:n},elements:Kb.indices,viewport:{x:0,y:0,width:t.prop("size"),height:t.prop("size")}});let h=n;const u=t.texture({radius:n,min:"linear",mag:"linear",type:o?"float":"uint8"}),c=t.framebuffer({radius:n,color:u}),f=Math.log(h)/Math.log(2),d=[];for(let p=0;p<=f;p++){let e=0;Qb(t,c,l,{roughness:p/(f-1),size:h},(function(){const n=t.read({framebuffer:c});let r=n;if(o){r=new Uint16Array(n.length);for(let t=0;t<n.length;t++)r[t]=Math.min(E_(n[t]),65504)}d[e]||(d[e]={mipmap:[]}),d[e].mipmap.push(r),e++})),h/=2,c.resize(h)}return a.destroy(),c.destroy(),l.destroy(),d}(t,e,n,r,i,o);return{prefilterMap:t.cube({radius:n,min:"linear",mag:"linear",type:o?"float16":"uint8",faces:s,format:"rgba"}),prefilterMipmap:s}}(t,a,s,i,o,l);let c;if(!e.ignoreSH){const n=s;c=function(t,e,n){const r=new Array(9),i=[],o=[],s=[];for(let a=0;a<9;a++){const l=[0,0,0];for(let r=0;r<nw.length;r++){const h=t[r],u=[0,0,0];let c=0,f=0;const d=ew[nw[r]];for(let t=0;t<n;t++)for(let r=0;r<e;r++){i[0]=r/(e-1)*2-1,i[1]=t/(n-1)*2-1,i[2]=-1,Gm(i,i),s[0]=i[d[0]]*d[3],s[1]=i[d[1]]*d[4],s[2]=i[d[2]]*d[5],o[0]=h[f++]/255,o[1]=h[f++]/255,o[2]=h[f++]/255;const l=h[f++]/255*7;o[0]*=l,o[1]*=l,o[2]*=l,Hm(u,u,o,tw(s,a)*-i[2]),c+=-i[2]}Hm(l,l,u,1/c)}r[a]=Bm(l,l,1/6)}return r}(iw(t,h,n,!1,e.environmentExposure,!0),n,n);const r=[];for(let t=0;t<c.length;t++)r.push(...c[t]);c=r}const f={envMap:a,isHDR:l,prefilterMap:h};return c&&(f.sh=c),"array"===e.format&&(f.envMap={width:a.width,height:a.height,faces:iw(t,a,r,l)},f.prefilterMap={width:h.width,height:h.height,faces:u},a.destroy(),h.destroy()),f},generateDFGLUT:aw,supportFloat16:uw});const fw={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,textureOrigin:null,textureWidth:null,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20,alphaTest:0};let dw=class extends Kx{constructor(t){const e=Hv({},fw);(t.metallicRoughnessTexture||t.metallicRoughnessTexture)&&(e.roughnessFactor=1,e.metallicFactor=1),super(t,e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;if(n.GAMMA_CORRECT_INPUT&&(t.GAMMA_CORRECT_INPUT=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data.aVertexColorType&&(t.HAS_VERTEX_COLOR=1),!e.data[e.desc.uv0Attribute])return t;n.baseColorTexture&&(t.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(t.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),n.bumpTexture&&(t.HAS_BUMP_MAP=1),n.skinTexture&&(t.HAS_SKIN_MAP=1),(t.HAS_ALBEDO_MAP||t.HAS_METALLICROUGHNESS_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP||t.HAS_BUMP_MAP||t.HAS_SKIN_MAP)&&(t.HAS_MAP=1),n.noiseTexture&&(t.HAS_RANDOM_TEX=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1);const r=n.alphaMode&&n.alphaMode.toUpperCase();return"MASK"===r?t.ALPHA_MODE=1:"OPAQUE"===r&&(t.ALPHA_MODE=2),t}},pw=class extends(o_(dw)){};function gw(t,e,n){if(n.ambientUpdate){const{iblTexes:r}=t,i=n.target;r?(yw(r),t.iblTexes=Aw(e,i)):t.iblTexes=Aw(e,i),i.getRenderer().setToRedraw()}}const mw=[0,0];function Aw(t,e){const n=e.getLightManager(),r=n&&n.getAmbientResource();if(!r)return null;const i=r.isHDR;return{prefilterMap:t.cube({width:r.prefilterMap.width,height:r.prefilterMap.height,faces:r.prefilterMap.faces,min:"linear",mag:"linear",format:"rgba",type:i?"float16":"uint8"}),envMap:t.cube({width:r.envMap.width,height:r.envMap.height,faces:r.envMap.faces,min:"linear",mag:"linear",format:"rgba",type:i?"float16":"uint8"}),sh:r.sh}}function yw(t){for(const e in t)t[e]&&t[e].destroy&&t[e].destroy(),delete t[e]}var vw=Object.freeze({__proto__:null,createIBLTextures:Aw,disposeIBLTextures:yw,getIBLResOnCanvas:function(t){const{dfgLUT:e,iblTexes:n}=t;return{dfgLUT:e,iblTexes:n}},getPBRUniforms:function(t,e,n,r,i){const o=t.viewMatrix,s=t.projMatrix,a=t.cameraPosition,l=t.getRenderer().canvas,h=function(t,e){const n=t.getLightManager(),r=n&&n.getAmbientResource(),i=n&&n.getAmbientLight()||{},o=n&&n.getDirectionalLight()||{};let s;if(r){const t=e.prefilterMap.width,n=Math.log(t)/Math.log(2);s={prefilterMap:e.prefilterMap,diffuseSPH:e.sh,prefilterMiplevel:[n,n],prefilterSize:[t,t],hdrHSV:i.hsv||[0,0,0]}}else s={ambientColor:i.color||[.2,.2,.2]};return s.environmentExposure=Uv(i.exposure)?i.exposure:1,s.environmentOrientation=i.orientation||0,s.light0_diffuse=[...o.color||[1,1,1],1],s.light0_viewDirection=o.direction||[1,1,-1],s}(t,e),u=Hv({viewMatrix:o,projMatrix:s,projViewMatrix:t.projViewMatrix,cameraPosition:a,outSize:[l.width,l.height],cameraNearFar:[t.cameraNear,t.cameraFar]},h);return u.brdfLUT=n,r&&r.renderUniforms&&Hv(u,r.renderUniforms),u.halton=i||mw,u},isSupported:function(t){return t.hasExtension("EXT_shader_texture_lod")},loginIBLResOnCanvas:function(t,e,n){if(!t.dfgLUT&&(t.dfgLUT=aw(e),t.dfgLUT.mtkRefCount=0,n)){const r=(...n)=>gw.call(this,t,e,...n);n.on("updatelights",r),t._iblResListener=r}t.dfgLUT.mtkRefCount++;const r=n.getLightManager();return r&&r.getAmbientResource()?(t.iblTexes||(t.iblTexes=Aw(e,n)),{dfgLUT:t.dfgLUT,iblTexes:t.iblTexes}):{dfgLUT:t.dfgLUT,iblTexes:null}},logoutIBLResOnCanvas:function(t,e){let n=!1;t.dfgLUT&&(t.dfgLUT.mtkRefCount--,t.dfgLUT.mtkRefCount<=0)&&(n=!0,e&&e.off("updatelights",t._iblResListener),t.dfgLUT.destroy(),delete t.dfgLUT),t.iblTexes&&n&&(yw(t.iblTexes),delete t.iblTexes)}});let xw=class extends U_{constructor(t){super({vert:"attribute vec3 aPosition;\nuniform mat4 lightProjViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vPosition;\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 d = getLineExtrudePosition(aPosition);\n  vec4 e = getPosition(d);\n#else\nvec4 e = getPosition(aPosition);\n#endif\ngl_Position = lightProjViewModelMatrix * c * e;\n  vPosition = gl_Position;\n}",frag:"#define SHADER_NAME vsm_mapping\n#ifdef USE_VSM\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\nvarying vec4 vPosition;\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\nvoid main() {\n  \n#if defined(USE_VSM)\nfloat c = vPosition.z / vPosition.w;\n  c = c * .5 + .5;\n  float d = c;\n  float e = c * c;\n  float f = dFdx(c);\n  float h = dFdy(c);\n  e += .25 * (f * f + h * h);\n  gl_FragColor = vec4(d, e, c, .0);\n#endif\n#if defined(USE_ESM)\n#ifdef PACK_FLOAT\ngl_FragColor = common_encodeDepth(gl_FragCoord.z);\n#else\ngl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);\n#endif\n#endif\n}",uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(t,e){return am([],e.lightProjViewMatrix,e.modelMatrix)}}],extraCommandProps:{},defines:t})}filter(t){return t.castShadow}},_w=class extends X_{constructor({blurOffset:t}){super({vert:G_,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\n#include <common_pack_float>\nvoid main() {\n  float c = .0;\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      float f = common_decodeDepth(texture2D(textureSource, e));\n      float s = max(.0, sign(1. - f));\n      d += sign(f) * s;\n      c += f;\n    }\n  float h = c / max(1., d);\n  gl_FragColor = common_encodeDepth(h);\n}",defines:{BOXBLUR_OFFSET:t||2}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}},bw=null,ww=null,Tw=class{constructor(t,{width:e,height:n,blurOffset:r,defines:i}){this.renderer=t,this.width=e||512,this.height=n||512,this.blurOffset=Fv(r)?2:r,this._init(i)}render(t,{cameraProjViewMatrix:e,lightDir:n,farPlane:r,cameraLookAt:i}){return{lightProjViewMatrix:this._renderShadow(t,e,n,r,i),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(t,e){return this.depthTex&&(this.depthTex.resize(t,e),this.depthFBO.resize(t,e)),this.width=t,this.blurFBO&&(this.blurTex.resize(t,e),this.blurFBO.resize(t,e)),this.height=e,this}_renderShadow(t,e,n,r,i){const o=this.renderer,s=bw(e);if(r)for(let l=4;l<8;l++)s[l]=r[l-4];const a=ww(i,s,n);return o.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),o.render(this.shadowMapShader,{lightProjViewMatrix:a},t,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new _w({blurOffset:this.blurOffset})),o.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),o.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),a}_init(t){const e=this.renderer.regl,n="uint8",r=this.width,i=this.height;this.depthTex=e.texture({width:r,height:i,format:"rgb",type:n,min:"nearest",mag:"nearest"}),this.shadowMapShader=new xw(t),this.shadowMapShader.filter=t=>t.castShadow,this.depthFBO=e.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=e.texture({width:r,height:i,format:"rgb",type:n,min:"linear",mag:"linear"}),this.blurFBO=e.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}};bw=function(){const t=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],e=new Array(16);return function(n){sm(e,n);const r=[];for(let i=0;i<t.length;i++){const n=TA([],t[i],e);mA(n,n,1/n[3]),r.push(n)}return r}}(),ww=function(){let t=new Array(4);const e=new Array(3),n=[0,0,0,0],r=[0,1,0],i=new Array(3);let o=new Array(16),s=new Array(16);const a=new Array(16),l=[1,1,1],h=[0,0,0];return function(u,c,f){cA(n,...u,1),Bm(e,f,-1),o=Tm(o,Dm(i,n,Gm(i,e)),n,r),TA(t,c[0],o);let d=t[2],p=t[2],g=t[0],m=t[0],A=t[1],y=t[1];for(let e=1;e<8;e++)t=TA(t,c[e],o),t[2]>p&&(p=t[2]),t[2]<d&&(d=t[2]),t[0]>m&&(m=t[0]),t[0]<g&&(g=t[0]),t[1]>y&&(y=t[1]),t[1]<A&&(A=t[1]);s=wm(s,-1,1,-1,1,-p,-d);const v=l[0]=2/(m-g),x=l[1]=-2/(y-A);h[0]=-.5*(g+m)*v,h[1]=-.5*(A+y)*x,im(a),lm(a,a,h),hm(a,a,l);const _=am(s,a,s);return am(new Array(16),_,o)}}();let Mw=class extends U_{constructor(t){super({vert:"#define SHADER_NAME SHADOW_DISPLAY\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelViewMatrix;\nuniform vec2 halton;\nuniform vec2 globalTexSize;\nvarying vec4 vPosition;\n#include <vsm_shadow_vert>\nvoid main() {\n  vec4 c = vec4(aPosition, 1.);\n  vec4 d = modelViewMatrix * c;\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / globalTexSize.xy;\n  gl_Position = e * d;\n  vPosition = gl_Position;\n  shadow_computeShadowPars(c);\n}",frag:"#define SHADER_NAME SHADOW_DISPLAY\nprecision mediump float;\nuniform vec3 color;\n#include <vsm_shadow_frag>\nvoid main() {\n  float c = shadow_computeShadow();\n  float d = 1. - c;\n  gl_FragColor = vec4(color * d, d);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.viewMatrix,e.modelMatrix),n}}],defines:t||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(t,e)=>e.globalTexSize[0],height:(t,e)=>e.globalTexSize[1]}}})}getMeshCommand(t,e){return this.commands.shadow_display||(this.commands.shadow_display=this.createREGLCommand(t,null,e.getElements())),this.commands.shadow_display}};function Cw(t){return 256*t[2]*256+256*t[1]+t[0]}const Sw=new Uint8Array(4),Iw=new Float32Array(Sw.buffer);let Pw,Ew;const Ow=[1,1],Rw="\n    vec3 unpack(highp float f) {\n        highp vec3 color;\n        color.b = floor(f / 65536.0);\n        color.g = floor((f - color.b * 65536.0) / 256.0);\n        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!\n        return color / 255.0;\n    }\n",kw=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    uniform float fbo_picking_meshId;\n\n    ${Rw}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);\n    }\n`,Lw=`\n    precision highp float;\n\n    uniform int fbo_picking_meshId;\n    varying float vFbo_picking_visible;\n\n    ${Rw}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);\n        // gl_FragColor = vec4(unpack(float(35)), 1.0);\n    }\n`,Dw=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    ${Rw}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), 1.0);\n    }\n`;let Nw=class{constructor(t,{vert:e,uniforms:n,defines:r,extraCommandProps:i},o,s){this._renderer=t,this._fbo=o,this._map=s,this._clearFbo(o),this._vert=e,this._uniforms=n,this._defines=r,this._extraCommandProps=Hv({},i),delete this._extraCommandProps.blend,delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const t=[];this._uniforms&&t.push(...this._uniforms);const e={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const o in this._defines)e[o]=this._defines[o];const n=this._vert,r=this._extraCommandProps;this._shader0=new U_({vert:n,frag:kw,uniforms:t,defines:e,extraCommandProps:r}),this._shader2=new U_({vert:n,frag:Dw,uniforms:t,defines:e,extraCommandProps:r});const i={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const o in this._defines)i[o]=this._defines[o];this._shader1=new U_({vert:n,frag:Lw,uniforms:t,defines:i,extraCommandProps:r}),this._depthShader=new U_({vert:n,frag:"\n    #ifdef GL_ES\n        precision highp float;\n    #endif\n    #if __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n        #extension GL_EXT_frag_depth : enable\n    #endif\n    #include <gl2_frag>\n    #include <common_pack_float>\n    varying float vFbo_picking_viewZ;\n    uniform float logDepthBufFC;\n    varying float vFbo_picking_fragDepth;\n\n    const float PackUpscale = 256. / 255.;\n    const float UnpackDownscale = 255. / 256.;\n    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n    const float ShiftRight8 = 1. / 256.;\n    vec4 packDepthToRGBA(const in float v ) {\n        vec4 r = vec4(fract(v * PackFactors), v);\n        r.yzw -= r.xyz * ShiftRight8;\n        return r * PackUpscale;\n    }\n\n    void main() {\n        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;\n        #if __VERSION__ == 300 || __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;\n        #endif\n        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);\n        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n        #if __VERSION__ == 100\n            gl_FragColor = glFragColor;\n        #endif\n    }\n",uniforms:t,defines:i,extraCommandProps:r}),this._scene=new __,this._scene1=new __}filter(){return!0}render(t,e,n=!1){if(!t||!t.length)return this;const r=this._fbo;n&&this.clear(),t=t.filter((t=>t&&t.isValid&&t.isValid())),this._scene.setMeshes(t);const i=this._getShader(t,n);i.filter=this.filter,this._currentShader&&i!==this._currentShader&&this.clear(),this._currentShader=i,t.forEach(((t,e)=>{t.setUniform("fbo_picking_meshId",e+this._currentMeshes.length)}));for(let o=0;o<t.length;o++)this._currentMeshes.push(t[o]);return this._renderer.render(i,e,this._scene,r),this}pickAll(t,e,n,r,i){n=zw(n);const{meshIds:o,pickingIds:s,coords:a,points:l}=this._pick(t,e,n,r,i),h=[];if(s&&o){const t={};for(let e=0;e<o.length;e++){const n=`${s[e]}_${o[e]}`;null==o[e]||null==s[e]||t[n]||(t[n]=!0,h.push({meshId:o[e],pickingId:s[e],point:l[e]||null,coordinate:a[e]||null}))}}return h}pick(t,e,n,r,i={}){n=zw(n);const{meshIds:o,pickingIds:s,width:a,coords:l,points:h}=this._pick(t,e,n,r,i);if(s&&o){const t=[];for(let e=0;e<=n[0];e++)t.push(e),e>0&&t.push(-e);for(let e=0;e<t.length;e++)for(let r=0;r<t.length;r++){const i=(t[r]+n[1])*a+(t[e]+n[0]);if(null!=o[i])return{meshId:o[i],pickingId:s[i],point:h[i]||null,coordinate:l[i]||null}}}return{pickingId:null,meshId:null,point:null}}_pick(t,e,n,r,i={}){const o=this._currentShader,s=this._currentMeshes;if(!o||!s||!s.length)return{pickingId:null,meshId:null,point:null};t=Math.round(t),e=Math.round(e);const a=this._fbo;if(t<=2||t>=a.width-2||e<=2||e>=a.height-2)return{pickingId:null,meshId:null,point:null};const{px:l,py:h,width:u,height:c}=this._getParams(t,e,n,a),f=new Uint8Array(4*u*c),d=this._renderer.regl.read({data:f,x:l,y:h,framebuffer:a,width:u,height:c}),p=[];let g=[];for(let b=0;b<d.length;b+=4){const{pickingId:t,meshId:e}=this._packData(d.subarray(b,b+4),o);p.push(e),g.push(t)}const m={},A=p.filter((t=>null!=t&&!m[t]&&(m[t]=1,!0))).map((t=>s[t]));let y;for(let b=0;b<A.length;b++)if(A[b]&&A[b].geometry){y=A[b];break}if(!y)return{pickingId:null,meshId:null,point:null};const v=y.geometry.desc.pickingIdAttribute;p.length&&o===this._shader1&&(void 0!==y.getUniform("uPickingId")||y.geometry.data[v])&&(g=this._getPickingId(l,h,u,c,f,A,r));const x=[],_=[];if(p.length&&i.returnPoint){const{viewMatrix:n,projMatrix:o}=i,s=this._pickDepth(l,h,u,c,f,A,r);for(let r=0;r<s.length;r++)if(s[r]&&null!=p[r]){const i=this._getWorldPos(t,e,s[r],n,o),a=this._convertPickPoint(i);x.push(i),_.push(a)}else x.push(null),_.push(null)}return{meshIds:p,pickingIds:g,coords:_,points:x,width:u,height:c}}_convertPickPoint(t){const e=this._map;if(!e)return null;const n=e.getGLRes();if(!Pw){const t=e.getCenter();Ew=new t.constructor(0,0,0);const n=e.coordToPoint(t);Pw=new n.constructor(0,0)}Pw.set(t[0],t[1]);const r=e.pointAtResToCoord(Pw,n,Ew),i=e.pointAtResToAltitude(t[2],n);return[r.x,r.y,i]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(t){return this._currentMeshes?this._currentMeshes[t]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(t,e,n,r,i){const o=this._fbo,s=[],a=o.width/2||1,l=o.height/2||1,h=[(t-a)/a,(l-e)/l,0,1],u=[(t-a)/a,(l-e)/l,1,1],c=sm(s,i),f=[],d=[];Fw(f,h,c),Fw(d,u,c);const p=-f[2],g=(n-p)/(-d[2]-p),m=sm(s,am(s,i,r)),A=Fw(h,h,m),y=Fw(u,u,m);return[Vv(A[0],y[0],g),Vv(A[1],y[1],g),Vv(A[2],y[2],g)]}_getPickingId(t,e,n,r,i,o,s){const a=this._renderer.regl,l=this._getFBO1();this._clearFbo(l),this._scene1.setMeshes(o),this._renderer.render(this._shader2,s,this._scene1,l);const h=a.read({data:i,x:t,y:e,framebuffer:l,width:n,height:r}),u=[];for(let c=0;c<h.length;c+=4)u.push(Cw(h.subarray(c,c+4)));return u}_pickDepth(t,e,n,r,i,o,s){const a=this._renderer.regl,l=this._getFBO1();this._scene1.setMeshes(o),this._clearFbo(l),s.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,s,this._scene1,l);const h=a.read({data:i,x:t,y:e,framebuffer:l,width:n,height:r}),u=[];for(let f=0;f<h.length;f+=4)u.push((c=h.subarray(f,f+4),Sw[0]=c[3],Sw[1]=c[2],Sw[2]=c[1],Sw[3]=c[0],Iw[0]));var c;return u}_packData(t,e){if(255===t[0]&&255===t[1]&&255===t[2]&&255===t[3])return{meshId:null,pickingId:null};let n=null,r=null;return e===this._shader1?r=Cw(t):e===this._shader0?(r=t[3],n=Cw(t)):(r=null,n=Cw(t)),{meshId:r,pickingId:n}}_clearFbo(t){this._renderer.regl.clear({color:[1,1,1,1],depth:1,stencil:0,framebuffer:t})}_getShader(t,e){return e&&t.length<256?this._shader0:this._shader1}_getFBO1(){const t=this._renderer.regl,e=this._fbo;return this._fbo1?this._fbo1.width===e.width&&this._fbo1.height===e.height||this._fbo1.resize(e.width,e.height):this._fbo1=t.framebuffer(e.width,e.height),this._fbo1}_getParams(t,e,n,r){const i=n[0],o=n[1];e=r.height-e;let s=2*i+1,a=2*o+1;const l=(t-=i)+s,h=(e-=o)+a;return l>r.width&&(s-=l-r.width),h>r.height&&(a-=h-r.height),{px:t=t<0?0:t,py:e=e<0?0:e,width:s,height:a}}getPickingVert(){return this._vert}getUniformDeclares(){return this._uniforms}};function Fw(t,e,n){const r=e[0],i=e[1],o=e[2],s=1/(n[3]*r+n[7]*i+n[11]*o+n[15]);return t[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])*s,t[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])*s,t[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])*s,t}function zw(t){return Uv(t)&&(Ow[0]=Ow[1]=t,t=Ow),t}const Bw=t=>t&&t.geometry&&void 0===t.geometry.properties.shaderHash,Hw=[],jw=[],Uw=[{name:"modelViewMatrix",type:"function",fn:(t,e)=>am(Hw,e.viewMatrix,e.modelMatrix)},{name:"modelViewProjMatrix",type:"function",fn:(t,e)=>{const n=am(Hw,e.viewMatrix,e.modelMatrix);return am(Hw,e.projMatrix,n)}},{name:"modelMatrixInverse",type:"function",fn:(t,e)=>sm(Hw,e.modelMatrix)},{name:"projMatrixInverse",type:"function",fn:(t,e)=>sm(Hw,e.projMatrix)},{name:"modelViewMatrixInverse",type:"function",fn:(t,e)=>(am(Hw,e.viewMatrix,e.modelMatrix),sm(Hw,Hw))},{name:"modelViewProjMatrixInverse",type:"function",fn:(t,e)=>{const n=am(Hw,e.viewMatrix,e.modelMatrix);return am(Hw,e.projMatrix,n),sm(Hw,Hw)}},{name:"modelInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=Wg(jw,e.modelMatrix),r=Xg(n,n);return Zg(r,r)}},{name:"modelViewInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=am(Hw,e.viewMatrix,e.modelMatrix),r=Wg(jw,n),i=Xg(r,r);return Zg(i,i)}}],Vw={LOCAL:"positionMatrix",MODEL:"modelMatrix",VIEW:"viewMatrix",PROJECTION:"projMatrix",MODELVIEW:"modelViewMatrix",MODELVIEWPROJECTION:"modelViewProjMatrix",MODELINVERSE:"modelMatrixInverse",VIEWINVERSE:"viewMatrixInverse",PROJECTIONINVERSE:"projMatrixInverse",MODELVIEWINVERSE:"modelViewMatrixInverse",MODELVIEWPROJECTIONINVERSE:"modelViewProjMatrixInverse",MODELINVERSETRANSPOSE:"modelInverseTransposeMatrix",MODELVIEWINVERSETRANSPOSE:"modelViewInverseTransposeMatrix",VIEWPORT:"viewport",JOINTMATRIX:"jointMatrix",ALPHACUTOFF:"alphaCutoff"};let Gw=class{constructor(t,e,n){this._regl=t,this._khrShaders={},this._commandProps=e,this._resLoader=n}getExcludeFilter(){return Bw}forEachShader(t){for(const e in this._khrShaders){const n=this._khrShaders[e];t(n.shader,n.filter,n.uniformSemantics)}}createMesh(t,e,n,r){const i=e.extensions.KHR_techniques_webgl,o=e.materials[t.material].extensions.KHR_techniques_webgl,{technique:s,values:a}=o,l=i.techniques[s],h=i.programs[l.program],u=i.shaders[h.vertexShader],c=i.shaders[h.fragmentShader];var f;c.content=(f=c.content)&&f.indexOf("precision")<0?"precision mediump float;\n"+f:f;const d=ex(u.content)+"-"+ex(c.content);this._khrShaders[d]||(this._khrShaders[d]=this._createTechniqueShader(d,i,s,this._commandProps,r));const{attributeSemantics:p}=this._khrShaders[d],g=this._createGeometry(t,p,n,d),m=Hv({},a);for(const A in a)l.uniforms[A]&&35678===l.uniforms[A].type&&(m[A]=this._getTexture(e.textures[a[A].index]));return{geometry:g,material:new Kx(m)}}_createGeometry(t,e,n,r){const i=t.attributes,o="COLOR_0";if(i[o]){const t=i[o].array||i[o];if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);i[o].array?(i[o].array=e,i[o].componentType=5121):i[o]=e}}const s={};for(const h in i){const t=zx(this._regl,i[h],{dimension:i[h].itemSize}),n=e[h]||h;s[n]={buffer:t},i[h].quantization&&(s[n].quantization=i[h].quantization),n===e.POSITION&&(s[n].array=i[h].array)}const a=new bx(s,t.indices.array?t.indices.array:t.indices,0,{positionAttribute:e.POSITION,normalAttribute:e.NORMAL,uv0Attribute:e.TEXCOORD_0,uv1Attribute:e.TEXCOORD_1,color0Attribute:e.COLOR_0,tangentAttribute:e.TANGENT,textureCoordMatrixAttribute:e.TextureCoordMatrix,primitive:void 0===t.mode?"triangles":Mx(t.mode)});a.generateBuffers(this._regl,{excludeElementsInVAO:n}),a.properties.shaderHash=r;const l=a.data[a.desc.positionAttribute];return l&&l.array&&delete l.array,a}_getTexture(t){const e={type:t.type?Sx(t.type):"uint8",format:t.format?Px(t.format):"rgba",flipY:!!t.flipY},n=t.image;n.array?e.data=n.array:n.mipmap&&(e.mipmap=n.mipmap),e.width=n.width,e.height=n.height;const r=t.sampler||t.texture.sampler;return r&&(r.magFilter&&(e.mag=Ox(r.magFilter)),r.minFilter&&(e.min=kx(r.minFilter)),r.wrapS&&(e.wrapS=Dx(r.wrapS)),r.wrapT&&(e.wrapT=Dx(r.wrapT))),new O_(e,this._resLoader)}_createTechniqueShader(t,e,n,r,i){const{techniques:o,programs:s,shaders:a}=e,l=o[n],h=s[l.program],u=a[h.vertexShader].content,c=a[h.fragmentShader].content,f={};for(const m in l.uniforms){const t=l.uniforms[m];t.semantic&&(f[t.semantic]=m)}const d=Uw.slice();for(const m in f)d.push({name:f[m],type:"function",fn:(t,e)=>e[Vw[m]]});const p=new U_({vert:u,frag:c,uniforms:d,extraCommandProps:r});i&&(p.version=300);const g={};for(const m in l.attributes)g[l.attributes[m].semantic]=m;return{shader:p,filter:e=>e&&e.geometry&&e.geometry.properties.shaderHash===t,uniformSemantics:f,attributeSemantics:g}}dispose(){for(const t in this._khrShaders){const{shader:e}=this._khrShaders[t];e.dispose()}this._khrShaders={}}};var Ww={exports:{}};function qw(t,e,n){n=n||2;var r,i,o,s,a,l,h,u=e&&e.length,c=u?e[0]*n:t.length,f=Xw(t,0,c,n,!0),d=[];if(!f||f.next===f.prev)return d;if(u&&(f=function(t,e,n,r){var i,o,s,a=[];for(i=0,o=e.length;i<o;i++)(s=Xw(t,e[i]*r,i<o-1?e[i+1]*r:t.length,r,!1))===s.next&&(s.steiner=!0),a.push(iT(s));for(a.sort(tT),i=0;i<a.length;i++)n=eT(a[i],n);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=s=t[1];for(var p=n;p<c;p+=n)(a=t[p])<r&&(r=a),(l=t[p+1])<i&&(i=l),a>o&&(o=a),l>s&&(s=l);h=0!==(h=Math.max(o-r,s-i))?32767/h:0}return Yw(f,d,n,r,i,h,0),d}function Xw(t,e,n,r,i){var o,s;if(i===AT(t,e,n,r)>0)for(o=e;o<n;o+=r)s=pT(o,t[o],t[o+1],s);else for(o=n-r;o>=e;o-=r)s=pT(o,t[o],t[o+1],s);return s&&lT(s,s.next)&&(gT(s),s=s.next),s}function Zw(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!lT(r,r.next)&&0!==aT(r.prev,r,r.next))r=r.next;else{if(gT(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function Yw(t,e,n,r,i,o,s){if(t){!s&&o&&function(t,e,n,r){var i=t;do{0===i.z&&(i.z=rT(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,s,a,l,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,r=n,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,h*=2}while(s>1)}(i)}(t,r,i,o);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,o?Qw(t,r,i,o):Jw(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),gT(t),t=l.next,h=l.next;else if((t=l)===h){s?1===s?Yw(t=Kw(Zw(t),e,n),e,n,r,i,o,2):2===s&&$w(t,e,n,r,i,o):Yw(Zw(t),e,n,r,i,o,1);break}}}function Jw(t){var e=t.prev,n=t,r=t.next;if(aT(e,n,r)>=0)return!1;for(var i=e.x,o=n.x,s=r.x,a=e.y,l=n.y,h=r.y,u=i<o?i<s?i:s:o<s?o:s,c=a<l?a<h?a:h:l<h?l:h,f=i>o?i>s?i:s:o>s?o:s,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=u&&p.x<=f&&p.y>=c&&p.y<=d&&oT(i,a,o,l,s,h,p.x,p.y)&&aT(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function Qw(t,e,n,r){var i=t.prev,o=t,s=t.next;if(aT(i,o,s)>=0)return!1;for(var a=i.x,l=o.x,h=s.x,u=i.y,c=o.y,f=s.y,d=a<l?a<h?a:h:l<h?l:h,p=u<c?u<f?u:f:c<f?c:f,g=a>l?a>h?a:h:l>h?l:h,m=u>c?u>f?u:f:c>f?c:f,A=rT(d,p,e,n,r),y=rT(g,m,e,n,r),v=t.prevZ,x=t.nextZ;v&&v.z>=A&&x&&x.z<=y;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&oT(a,u,l,c,h,f,v.x,v.y)&&aT(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==i&&x!==s&&oT(a,u,l,c,h,f,x.x,x.y)&&aT(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=A;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&oT(a,u,l,c,h,f,v.x,v.y)&&aT(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==i&&x!==s&&oT(a,u,l,c,h,f,x.x,x.y)&&aT(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Kw(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!lT(i,o)&&hT(i,r,r.next,o)&&fT(i,o)&&fT(o,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(o.i/n|0),gT(r),gT(r.next),r=t=o),r=r.next}while(r!==t);return Zw(r)}function $w(t,e,n,r,i,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&sT(s,a)){var l=dT(s,a);return s=Zw(s,s.next),l=Zw(l,l.next),Yw(s,e,n,r,i,o,0),void Yw(l,e,n,r,i,o,0)}a=a.next}s=s.next}while(s!==t)}function tT(t,e){return t.x-e.x}function eT(t,e){var n=function(t,e){var n,r=e,i=t.x,o=t.y,s=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var a=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>s&&(s=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,u=n.x,c=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=u&&i!==r.x&&oT(o<c?i:s,o,u,c,o<c?s:i,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(i-r.x),fT(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&nT(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}(t,e);if(!n)return e;var r=dT(n,t);return Zw(r,r.next),Zw(n,n.next)}function nT(t,e){return aT(t.prev,t,e.prev)<0&&aT(e.next,t,t.next)<0}function rT(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function iT(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function oT(t,e,n,r,i,o,s,a){return(i-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(r-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(i-s)*(r-a)}function sT(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&hT(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(fT(t,e)&&fT(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(aT(t.prev,t,e.prev)||aT(t,e.prev,e))||lT(t,e)&&aT(t.prev,t,t.next)>0&&aT(e.prev,e,e.next)>0)}function aT(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function lT(t,e){return t.x===e.x&&t.y===e.y}function hT(t,e,n,r){var i=cT(aT(t,e,n)),o=cT(aT(t,e,r)),s=cT(aT(n,r,t)),a=cT(aT(n,r,e));return i!==o&&s!==a||!(0!==i||!uT(t,n,e))||!(0!==o||!uT(t,r,e))||!(0!==s||!uT(n,t,r))||!(0!==a||!uT(n,e,r))}function uT(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function cT(t){return t>0?1:t<0?-1:0}function fT(t,e){return aT(t.prev,t,t.next)<0?aT(t,e,t.next)>=0&&aT(t,t.prev,e)>=0:aT(t,e,t.prev)<0||aT(t,t.next,e)<0}function dT(t,e){var n=new mT(t.i,t.x,t.y),r=new mT(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function pT(t,e,n,r){var i=new mT(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function gT(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function mT(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function AT(t,e,n,r){for(var i=0,o=e,s=n-r;o<n;o+=r)i+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return i}Ww.exports=qw,Ww.exports.default=qw,qw.deviation=function(t,e,n,r){var i=e&&e.length,o=Math.abs(AT(t,0,i?e[0]*n:t.length,n));if(i)for(var s=0,a=e.length;s<a;s++)o-=Math.abs(AT(t,e[s]*n,s<a-1?e[s+1]*n:t.length,n));var l=0;for(s=0;s<r.length;s+=3){var h=r[s]*n,u=r[s+1]*n,c=r[s+2]*n;l+=Math.abs((t[h]-t[c])*(t[u+1]-t[h+1])-(t[h]-t[u])*(t[c+1]-t[h+1]))}return 0===o&&0===l?0:Math.abs((l-o)/o)},qw.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[i][o][s]);i>0&&n.holes.push(r+=t[i-1].length)}return n};var yT=function(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}(Ww.exports);const vT={parseHDR:I_},xT={PBRHelper:cw,StandardMaterial:dw,StandardSpecularGlossinessMaterial:pw,StandardShader:class extends U_{constructor(t={}){let e=t.extraCommandProps||{};const n=t.uniforms;e=Hv({},e);const r=t.defines||{},i=[],o=[],s=[],a=[],l=[],h=[{name:"modelNormalMatrix",type:"function",fn:(t,e)=>Wg(i,e.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=am(o,e.viewMatrix,e.modelMatrix),r=sm(n,n),i=om(r,r);return Wg(s,i)}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>am(a,e.viewMatrix,e.modelMatrix)},{name:"environmentTransform",type:"function",fn:(t,e)=>Jg(l,Math.PI*(e.environmentOrientation||0)/180)}];n&&h.push(...n),super({vert:t.vert||"#include <gl2_vert>\n#define SHADER_NAME PBR\nprecision highp float;\nattribute vec3 aPosition;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nuniform float uvRotation;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\nvec3 c;\nvec3 d;\nvec4 e;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform mediump vec3 cameraPosition;\nuniform mat3 modelNormalMatrix;\n#ifdef HAS_SSR\nuniform mat3 modelViewNormalMatrix;\nvarying vec3 vViewNormal;\n#ifdef HAS_TANGENT\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\nvarying vec3 vModelVertex;\n#if defined(HAS_MAP)\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\n#include <highlight_vert>\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\nvarying vec3 vColor0;\n#else\nattribute vec4 aColor0;\nvarying vec4 vColor0;\n#endif\n#endif\n#include <line_extrusion_vert>\n#include <get_output>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <heatmap_render_vert>\n#include <vertex_color_vert>\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#if __VERSION__ == 100\nmat3 f(in mat3 h) {\n  vec3 i = h[0];\n  vec3 j = h[1];\n  vec3 k = h[2];\n  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));\n}\n#else\nmat3 f(in mat3 h) {\n  return transpose(h);\n}\n#endif\n#endif\nvoid l(const highp vec4 q, out highp vec3 m) {\n  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {\n  l(q, m);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nconst float o = .5;\nvec2 u(vec2 v, float A) {\n  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);\n}\n#if defined(HAS_MAP)\nvec2 B(vec2 v) {\n  vec2 C = decode_getTexcoord(v);\n#ifdef HAS_RANDOM_TEX\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale + uvOffset;\n  return mod(D, 1.) + E;\n#else\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale;\n  if(uvRotation != .0) {\n    D = u(D, uvRotation);\n    E = u(E, uvRotation);\n  }\n  return mod(D, 1.) + E + uvOffset;\n#endif\n}\n#endif\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <excavate_vert>\nvoid main() {\n  mat4 F = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 G = getLineExtrudePosition(aPosition);\n  vec4 H = getPosition(G);\n#else\nvec4 H = getPosition(aPosition);\n#endif\nvModelVertex = (modelMatrix * H).xyz;\n  vec4 I = F * H;\n  vec4 J = modelViewMatrix * I;\n  vViewVertex = J;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(I, modelMatrix);\n#else\ngl_Position = projMatrix * J;\n#endif\n#ifdef PICKING_MODE\nfloat K = 1.;\n#if defined(HAS_COLOR)\nK *= aColor.a;\n#endif\n#if defined(HAS_COLOR0) && COLOR0_SIZE == 4\nK *= aColor0.a;\n#endif\nfbo_picking_setData(gl_Position.w, K != .0);\n#else\n#if defined(HAS_MAP)\nvTexCoord = B(aTexCoord);\n#ifdef HAS_AO_MAP\nvTexCoord1 = B(aTexCoord1);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\n#endif\n#if defined(HAS_TANGENT) || defined(HAS_NORMAL)\nmat3 L = mat3(F);\n  mat3 M = modelNormalMatrix * L;\n#if defined(HAS_TANGENT)\nvec3 t;\n  l(aTangent, d, t);\n  vModelTangent = vec4(M * t, aTangent.w);\n#else\nd = decode_getNormal(aNormal);\n#endif\nvec3 N = d;\n  vModelNormal = M * N;\n#else\nd = vec3(.0);\n  vModelNormal = vec3(.0);\n#endif\n#if defined(HAS_TANGENT)\nvModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);\n#endif\n#ifdef HAS_SSR\nmat3 O = modelViewNormalMatrix * L;\n  vViewNormal = O * d;\n#if defined(HAS_TANGENT)\nvec4 P = vec4(t, aTangent.w);\n  vViewTangent = vec4(O * P.xyz, P.w);\n#endif\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\nhighlight_setVarying();\n#if defined(HAS_COLOR0)\nvColor0 = aColor0 / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(I);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * F, H);\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nmat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));\n  vTangentViewPos = Q * cameraPosition;\n  vTangentFragPos = Q * vModelVertex;\n#endif\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nvCoordinateTexcoord = getCoordinateTexcoord();\n  vHeight = getWorldHeight();\n#endif\n#endif\n}",frag:t.frag||"#define PI 3.141593\n#define RECIPROCAL_PI 1.0\n#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\n#include <srgb_frag>\nuniform vec3 hsv;\nuniform float contrast;\nstruct MaterialUniforms {\n  vec2 roughnessMetalness;\n  vec3 albedo;\n  float alpha;\n  vec3 normal;\n  vec3 emit;\n  float ao;\n  vec3 specularColor;\n  float glossiness;\n  vec4 skinColor;\n} c;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\nuniform float glossinessFactor;\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\nuniform vec3 emissiveFactor;\nuniform vec4 baseColorFactor;\nuniform float baseColorIntensity;\nuniform float emitColorFactor;\nuniform float occlusionFactor;\nuniform float environmentExposure;\nuniform float roughnessFactor;\nuniform float metallicFactor;\nuniform float normalMapFactor;\nuniform float specularF0;\nuniform int emitMultiplicative;\nuniform int normalMapFlipY;\nuniform int outputSRGB;\nuniform mat3 environmentTransform;\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#if defined(HAS_EMISSIVE_MAP)\nuniform sampler2D emissiveTexture;\n#endif\n#if defined(HAS_AO_MAP)\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nuniform sampler2D normalTexture;\n#endif\n#if defined(HAS_SKIN_MAP)\nuniform sampler2D skinTexture;\n#endif\n#if defined(ALPHA_MODE) && ALPHA_MODE == 1\nuniform float alphaCutoff;\n#endif\n#ifdef HAS_RANDOM_TEX\nuniform highp vec2 uvOrigin;\nuniform sampler2D noiseTexture;\n#endif\nuniform sampler2D brdfLUT;\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\nuniform vec2 cameraNearFar;\nuniform vec3 light0_viewDirection;\nuniform vec4 light0_diffuse;\n#ifdef HAS_SSR\nvarying vec3 vViewNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelVertex;\nvarying vec4 vViewVertex;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vModelNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvarying vec3 vColor0;\n#else\nvarying vec4 vColor0;\n#endif\n#endif\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\nvarying float vOpacity;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\nuniform float currentTime;\nuniform float animSpeedScale;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatternGapColor;\nuniform vec2 uvScale;\nvarying float vPatternHeight;\nvarying float vLinesofar;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvec2 d(vec2 e) {\n  vec2 f = mod(e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#include <heatmap_render_frag>\n#include <snow_frag>\n#include <mask_frag>\n#include <terrain_normal_frag>\n#include <vertex_color_frag>\n#include <excavate_frag>\n#ifdef HAS_RANDOM_TEX\nconst float j = .5;\nvec2 k(vec2 f, float l) {\n  return vec2(cos(l) * (f.x - j) + sin(l) * (f.y - j) + j, cos(l) * (f.y - j) - sin(l) * (f.x - j) + j);\n}\nfloat m(vec3 n) {\n  return n.x + n.y + n.z;\n}\n#endif\nvec4 o(sampler2D u, in vec2 f) {\n  \n#ifdef HAS_RANDOM_TEX\nhighp vec2 A = uvOrigin;\n  highp vec2 B = f + A - mod(A, 1.);\n  float C = texture2D(noiseTexture, .005 * B).x;\n  vec2 D = dFdx(B);\n  vec2 E = dFdx(B);\n  float F = C * 8.;\n  float G = fract(F);\n#if 1\nfloat H = floor(F);\n  float I = H + 1.;\n#else\nfloat H = floor(F + .5);\n  float I = floor(F);\n  G = min(G, 1. - G) * 2.;\n#endif\nvec2 J = sin(vec2(3., 7.) * H);\n  vec2 K = sin(vec2(3., 7.) * I);\n  float L = .5;\n  vec4 M = texture2DGradEXT(u, f + L * J, D, E);\n  vec4 N = texture2DGradEXT(u, f + L * K, D, E);\n  return mix(M, N, smoothstep(.2, .8, G - .1 * m(M.xyz - N.xyz)));\n#else\nreturn texture2D(u, f);\n#endif\n}\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nuniform sampler2D bumpTexture;\nuniform float bumpScale;\nuniform float bumpMaxLayers;\nuniform float bumpMinLayers;\nvec2 O(vec2 f, vec3 P) {\n  float Q = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), P)));\n  float R = 1. / Q;\n  float S = .0;\n  vec2 T = P.xy * bumpScale / (P.z * Q);\n  vec2 U = f;\n  float V = o(bumpTexture, U).r;\n  for(int W = 0; W < 30; W++) {\n    S += R;\n    U -= T;\n    V = o(bumpTexture, U).r;\n    if(V < S) {\n      break;\n    }\n  }\n  vec2 X = U + T;\n  float Y = V - S;\n  float Z = o(bumpTexture, X).r - S + R;\n  return mix(U, X, Y / (Y - Z));\n}\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#endif\n#define SHADER_NAME PBR\nvec3 ba() {\n  return c.albedo;\n}\nfloat bb() {\n  return c.alpha;\n}\nfloat bc() {\n  return c.roughnessMetalness.y;\n}\nfloat bd() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn 1. - c.glossiness;\n#else\nreturn c.roughnessMetalness.x;\n#endif\n}\nvec3 be() {\n  return c.emit;\n}\nvec4 bf() {\n  return c.skinColor;\n}\nvec3 bg() {\n  return c.normal;\n}\nfloat bh() {\n  return c.ao;\n}\nfloat bi(const in vec4 bj) {\n  return bj.r + bj.g / 255.;\n}\nvec3 bk(const in float bl, in vec3 bm, const in vec3 t, const in vec3 b, in vec3 bn) {\n  bm.xy = bl * bm.xy;\n  mat3 bo = mat3(t, b, bn);\n  return normalize(bo * bm);\n}\nfloat bp(const float bq, const vec3 bm, const vec3 br) {\n  float bs = clamp(dot(bm, br), 0., 1.);\n  float a = bq * bq;\n  float bt = a * a;\n  float bu = (bs * bt - bs) * bs + 1.;\n  return bt / (PI * bu * bu);\n}\nvec3 bv(const vec3 bw, const float bx, const in vec3 by, const in vec3 br) {\n  float bz = clamp(dot(by, br), 0., 1.);\n  bz = pow(1. - bz, 5.);\n  return bx * bz + (1. - bz) * bw;\n}\nfloat bA(const in vec3 bm, const in vec3 bB, const in float bq, const float bC) {\n  float bD = clamp(dot(bm, bB), 0., 1.);\n  float a = bq * bq;\n  float bE = bD * (bC * (1. - a) + a);\n  float bF = bC * (bD * (1. - a) + a);\n  return .5 / (bF + bE);\n}\nvec3 bG(const float bq, const vec3 bm, const vec3 bB, const vec3 by, const vec3 bH, const float bC, const float bx) {\n  vec3 br = normalize(bB + by);\n  float bI = bp(bq, bm, br);\n  float bJ = bA(bm, bB, bq, bC);\n  vec3 bK = bv(bH, bx, by, br);\n  return (bI * bJ * PI) * bK;\n}\nvec3 bL(const in vec3 bM) {\n  return RECIPROCAL_PI * bM;\n}\nvoid bN(const in vec3 bm, const in vec3 bB, const in float bC, const in float bq, const in vec3 bO, const in vec3 bH, const in vec3 bP, const in vec3 by, const in float bx, out vec3 bQ, out vec3 bR) {\n  if(bC <= .0) {\n    bR = bQ = vec3(.0);\n    return;\n  }\n  vec3 a = bC * bP;\n  vec3 bS = bG(bq, bm, bB, by, bH, bC, bx);\n  bR = a * bS;\n  bQ = a * bL(bO);\n}\n#if defined(HAS_IBL_LIGHTING)\nvec3 bT(const in vec3 bm) {\n  vec3 bn = environmentTransform * bm;\n  float x = bn.x;\n  float y = bn.y;\n  float z = bn.z;\n  vec3 bU = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bU = hsv_apply(bU, hdrHSV);\n  }\n  return max(bU, vec3(.0));\n}\nvec3 bV(const in float bq, const in vec3 bW) {\n  vec3 bX = bW;\n  float bY = prefilterMiplevel.x;\n  float bZ = min(bY, bq * prefilterMiplevel.y);\n  vec3 ca = textureCubeLod(prefilterMap, bX, bZ).rgb;\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(ca, hdrHSV);\n  } else {\n    return ca;\n  }\n}\nvec3 cb(const in vec3 cc, const in vec3 bB, const in float bq, const in vec3 cd, const in vec3 bO) {\n  float ce = 1. - bq;\n  vec3 bW = mix(cc, reflect(-bB, cc), ce * (sqrt(ce) + bq));\n  float bl = clamp(1. + dot(bW, cd), .0, 1.);\n  vec3 cf = bV(bq, environmentTransform * bW) * bl * bl;\n  return cf;\n}\n#else\nvec3 cb(const in vec3 bm, const in vec3 cg, const in float bq, const in vec3 cd, const in vec3 bO) {\n  return ambientColor * bL(bO);\n}\n#endif\nvec3 ch(const in vec3 ci, const in float bq, const in float bD, const in float bx) {\n  vec4 rgba = texture2D(brdfLUT, vec2(bD, bq)) * vec4(255., 65280.0, 255., 65280.0);\n  float b = (rgba[3] + rgba[2]);\n  float a = (rgba[1] + rgba[0]);\n  return (ci * a + b * bx) / 65535.;\n}\nvec3 cj(const in vec3 bm, const in vec3 cg, const in float bD, const in float bq, const in vec3 bH, const in vec3 cd, const in float bx, const in vec3 bO) {\n  return cb(bm, cg, bq, cd, bO) * ch(bH, bq, bD, bx);\n}\nfloat ck(const in float cl, const in float bD) {\n  float bu = bD + cl;\n  return clamp(bu * bu - 1. + cl, .0, 1.);\n}\nvoid cm() {\n  \n#ifdef HAS_MAP\nvec2 f = computeTexCoord(vTexCoord);\n#endif\n#ifdef HAS_UV_FLIP\nf.y = 1. - f.y;\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nf = O(f, normalize(vTangentViewPos - vTangentFragPos));\n#endif\nc.albedo = baseColorIntensity * baseColorFactor.rgb;\n  c.alpha = baseColorFactor.a * vOpacity;\n#if defined(HAS_PATTERN)\nfloat cn = vLinesofar;\n  vec2 i = vTexInfo.zw;\n#ifdef HAS_PATTERN_GAP\nfloat co = vLinePatternGap;\n#else\nfloat co = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat cp = vLinePatternAnimSpeed;\n#else\nfloat cp = linePatternAnimSpeed;\n#endif\nfloat cq = ceil(i.x * vPatternHeight / i.y);\n  float cr = cq * (1. + co);\n  cp /= animSpeedScale;\n  cn += mod(currentTime * -cp * .2, cr);\n  float cs = mod(cn / cr, 1.);\n  float ct = mod(flipY * vNormalY, 1.);\n  vec2 f = d(vec2(cs * (1. + co) * uvScale[0], ct * uvScale[1]));\n  vec4 cu = texture2D(linePatternFile, f);\n  float cv = clamp(sign(1. / (1. + co) - cs) + .000001, .0, 1.);\n  cu = mix(linePatternGapColor, cu, cv);\n#ifdef IS_SQUARE_TUBE\nfloat n = clamp(sign(abs(vNormalY) - .999999), .0, 1.);\n  cu = mix(cu, vec4(1.), n);\n#endif\nc.albedo *= cu.rgb;\n  c.alpha *= cu.a;\n#endif\n#if defined(HAS_ALBEDO_MAP)\nvec4 cw = o(baseColorTexture, f);\n  c.albedo *= sRGBToLinear(cw.rgb);\n  c.alpha *= cw.a;\n#endif\n#if defined(HAS_SKIN_MAP)\nvec4 cx = o(skinTexture, f);\n  c.skinColor = cx;\n#endif\n#if defined(HAS_COLOR0)\nc.albedo *= vColor0.rgb;\n#if COLOR0_SIZE == 4\nc.alpha *= vColor0.a;\n#endif\n#endif\n#if defined(HAS_COLOR)\nc.albedo *= vColor.rgb;\n  c.alpha *= vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nc.albedo *= lineColor.rgb;\n  c.alpha *= lineColor.a;\n#else\nc.albedo *= polygonFill.rgb;\n  c.alpha *= polygonFill.a;\n#endif\n#if defined(HAS_INSTANCE_COLOR)\nc.albedo *= vInstanceColor.rgb;\n  c.alpha *= vInstanceColor.a;\n#endif\n#if defined(IS_LINE_EXTRUSION)\nc.alpha *= lineOpacity;\n#else\nc.alpha *= polygonOpacity;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nc.roughnessMetalness = o(metallicRoughnessTexture, f).gb * vec2(roughnessFactor, metallicFactor);\n#else\nc.roughnessMetalness = vec2(roughnessFactor, metallicFactor);\n#endif\nc.emit = emissiveFactor;\n#if defined(HAS_EMISSIVE_MAP)\nif(emitMultiplicative == 1) {\n    c.emit *= sRGBToLinear(o(emissiveTexture, f).rgb);\n  } else {\n    c.emit += sRGBToLinear(o(emissiveTexture, f).rgb);\n  }\n#endif\nc.emit *= emitColorFactor;\n#if defined(HAS_AO_MAP)\nvec2 cy = computeTexCoord(vTexCoord1);\n  c.ao = o(occlusionTexture, cy).r;\n#else\nc.ao = 1.;\n#endif\nc.ao *= occlusionFactor;\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nvec3 cz = o(normalTexture, f).xyz * 2. - 1.;\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#else\nc.normal = normalize(vModelNormal);\n#endif\n#if defined(HAS_TERRAIN_NORMAL) && defined(HAS_TANGENT)\nvec3 cz = convertTerrainHeightToNormalMap(f);\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#endif\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nc.albedo *= diffuseFactor.rgb;\n  c.alpha *= diffuseFactor.a;\n#if defined(HAS_DIFFUSE_MAP)\nvec4 cA = o(diffuseTexture, f);\n  c.albedo *= sRGBToLinear(cA.rgb);\n  c.alpha *= cA.a;\n#endif\nc.specularColor = specularFactor;\n  c.glossiness = glossinessFactor;\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nvec4 cB = o(specularGlossinessTexture, f);\n  c.specularColor *= sRGBToLinear(cB.rgb);\n  c.glossiness *= cB.a;\n#endif\n#endif\n}\nvec3 cC(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float cD = 2.43;\n  const float bu = .59;\n  const float cE = .14;\n  return (x * (a * x + b)) / (x * (cD * x + bu) + cE);\n}\nvec3 cF(vec3 cG) {\n  cG = cC(cG);\n  return cG = pow(cG, vec3(1. / 2.2));\n}\nuniform float specularAAVariance;\nuniform float specularAAThreshold;\nfloat cH(float bq, const vec3 cI) {\n  \n#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300\nvec3 cJ = dFdx(cI);\n  vec3 cK = dFdy(cI);\n  float cL = specularAAVariance * (dot(cJ, cJ) + dot(cK, cK));\n  float cM = min(2. * cL, specularAAThreshold);\n  float cN = saturate(bq * bq + cM);\n  return sqrt(cN);\n#else\nreturn bq;\n#endif\n}\n#ifdef HAS_SSR\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nvec3 cO(const in mat4 cP, const in vec3 cQ) {\n  vec4 cR = cP * vec4(cQ, 1.);\n  return vec3(.5 + .5 * cR.xy / cR.w, cR.w);\n}\nvec3 cS(const in float cT, const in vec2 f) {\n  return texture2D(TextureReflected, f).rgb;\n}\nfloat cU(float cV) {\n  highp mat4 cP = projMatrix;\n  highp float z = cV * 2. - 1.;\n  return -cP[3].z / (z + cP[2].z);\n}\nfloat cW(const vec2 f) {\n  float cV = bi(texture2D(TextureDepth, f));\n  return cV;\n}\nfloat cX(const in vec2 cY, const in float cZ) {\n  vec3 da = vec3(.06711056, .00583715, 52.9829189);\n  return fract(da.z * fract(dot(cY.xy + cZ * vec2(47., 17.) * .695, da.xy))) * .5;\n}\nvec3 db(const in float cZ, const in vec3 dc, const in vec3 dd, const in vec3 de, const in vec3 cg, const in float df) {\n  vec2 dg;\n  dg.x = cX(gl_FragCoord.yx, cZ);\n  dg.y = fract(dg.x * 52.9829189);\n  dg.y = mix(dg.y, 1., .7);\n  float dh = 2. * 3.14159 * dg.x;\n  float di = pow(max(dg.y, .000001), df / (2. - df));\n  float dj = sqrt(1. - di * di);\n  vec3 dk = vec3(dj * cos(dh), dj * sin(dh), di);\n  dk = dk.x * dc + dk.y * dd + dk.z * de;\n  return normalize((2. * dot(cg, dk)) * dk - cg);\n}\nfloat dl(const in float cZ) {\n  return (cX(gl_FragCoord.xy, cZ) - .5);\n}\nvec3 dm(const in vec3 dn, const in float dp, const in vec3 dq) {\n  vec3 dr = cO(projMatrix, vViewVertex.xyz + dq * dp);\n  dr.z = 1. / dr.z;\n  dr -= dn;\n  float ds = min(1., .99 * (1. - dn.x) / max(1e-5, dr.x));\n  float dt = min(1., .99 * (1. - dn.y) / max(1e-5, dr.y));\n  float dw = min(1., .99 * dn.x / max(1e-5, -dr.x));\n  float dx = min(1., .99 * dn.y / max(1e-5, -dr.y));\n  return dr * min(ds, dt) * min(dw, dx);\n}\nfloat dy(const in vec3 dn, const in vec3 dr, inout float dz, inout float dA) {\n  float dB = (dA + dz) * .5;\n  vec3 dC = dn + dr * dB;\n  float z = cW(dC.xy);\n  float cV = cU(z);\n  float dD = -1. / dC.z;\n  dz = cV > dD ? dz : dB;\n  dA = cV > dD ? dB : dA;\n  return dB;\n}\nvec4 dE(const in vec3 dn, const in float dp, in float dF, const in vec3 dq, const in float bq, const in float cZ) {\n  int dG = 20;\n  float dH = 1. / float(dG);\n  dF *= dH;\n  vec3 dr = dm(dn, dp, dq);\n  float dI = dH;\n  vec3 dJ = vec3(.0, dI, 1.);\n  vec3 dC;\n  float z, cV, dD, dK, dL, dM;\n  bool dN;\n  float dO = 1.;\n  float dB;\n  for(int W = 0; W < dG; W++) {\n    dC = dn + dr * dJ.y;\n    z = cW(dC.xy);\n    cV = cU(z);\n    dD = -1. / dC.z;\n    float dP = clamp(sign(.999 - z), .0, 1.);\n    dK = dP * (dD - cV);\n    dK *= clamp(sign(abs(dK) - dp * dH * dH), .0, 1.);\n    dN = abs(dK + dF) < dF;\n    dL = clamp(dJ.x / (dJ.x - dK), .0, 1.);\n    dM = dN ? dJ.y + dL * dH - dH : 1.;\n    dJ.z = min(dJ.z, dM);\n    dJ.x = dK;\n    if(dN) {\n      float dz = dJ.y - dH;\n      float dA = dJ.y;\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dO = dB;\n      break;\n    }\n    dJ.y += dH;\n  }\n  return vec4(dn + dr * dO, 1. - dO);\n}\nvec4 dQ(in vec4 dR, const in float dS, const in vec3 dT, const in vec3 dU, const in float bq) {\n  vec4 dV = mix(outputFovInfo[0], outputFovInfo[1], dR.x);\n  dR.xyz = vec3(mix(dV.xy, dV.zw, dR.y), 1.) * -1. / dR.z;\n  dR.xyz = (reprojViewProjMatrix * vec4(dR.xyz, 1.)).xyw;\n  dR.xy /= dR.z;\n  float dW = clamp(6. - 6. * max(abs(dR.x), abs(dR.y)), .0, 1.);\n  dR.xy = .5 + .5 * dR.xy;\n  vec3 dX = dU * cS(bq * (1. - dR.w), dR.xy);\n  return vec4(mix(dT, dX, dS * dW), 1.);\n}\nvec3 ssr(const in vec3 dT, const in vec3 dU, const in float bq, const in vec3 bm, const in vec3 cg) {\n  float dY = .0;\n  vec4 bU = vec4(.0);\n  float df = bq * bq;\n  df = df * df;\n  vec3 dZ = abs(bm.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 dc = normalize(cross(dZ, bm));\n  vec3 dd = cross(bm, dc);\n  float dS = ssrFactor * clamp(-4. * dot(cg, bm) + 3.8, .0, 1.);\n  dS *= clamp(4.7 - bq * 5., .0, 1.);\n  vec3 dn = cO(projMatrix, vViewVertex.xyz);\n  dn.z = 1. / dn.z;\n  vec3 dq = db(dY, dc, dd, bm, cg, df);\n  float dp = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, dq.z * .5 + .5);\n  float dF = .5 * dp;\n  vec4 dR;\n  if(dot(dq, bm) > .001 && dS > .0) {\n    dR = dE(dn, dp, dF, dq, bq, dY);\n    if(dR.w > .0)\n      bU += dQ(dR, dS, dT, dU, bq);\n    \n  }\n  return bU.w > .0 ? bU.rgb / bU.w : dT;\n}\n#endif\n#include <highlight_frag>\nvec4 ea(in vec4 eb) {\n  return vec4(mix(pow(eb.rgb, vec3(.41666)) * 1.055 - vec3(.055), eb.rgb * 12.92, vec3(lessThanEqual(eb.rgb, vec3(.0031308)))), eb.a);\n}\nvec4 ec(vec4 eb) {\n  return (ea(eb));\n}\nvoid main() {\n  cm();\n  vec3 cg = normalize(cameraPosition - vModelVertex.xyz);\n#if defined(HAS_DOUBLE_SIDE)\nvec3 cd = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);\n#else\nvec3 cd = normalize(vModelNormal);\n#endif\n#if defined(HAS_TANGENT)\nvec4 ed;\n  ed = vModelTangent;\n#if defined(HAS_DOUBLE_SIDE)\ned.xyz = gl_FrontFacing ? normalize(ed.xyz) : -normalize(ed.xyz);\n#else\ned.xyz = normalize(ed.xyz);\n#endif\nvec3 ee = normalize(vModelBiTangent);\n#endif\nfloat bw = .08 * specularF0;\n  float ef = bc();\n  vec3 bO = ba();\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 eg = c.specularColor;\n#else\nvec3 eg = mix(vec3(bw), bO, ef);\n#endif\nbO *= 1. - ef;\n  float eh = clamp(50.0 * eg.g, .0, 1.);\n  float ei = bd();\n  if(specularAAVariance > .0) {\n    ei = cH(ei, cd);\n  }\n  vec3 ej = be();\n  vec3 ek = bg();\n  vec3 el = vec3(ek);\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nel = bk(normalMapFactor, el, ed.xyz, ee, cd);\n#endif\nvec3 cA = vec3(.0);\n  vec3 bH = vec3(.0);\n#if defined(HAS_IBL_LIGHTING)\ncA = bO * bT(el) * .5;\n#else\ncA = bO * ambientColor;\n#endif\nfloat bD = dot(el, cg);\n  bH = cj(el, cg, bD, ei, eg, cd, eh, bO);\n  float em;\n  float en = 1.;\n  float eo = bh();\n  cA *= environmentExposure * eo;\n#ifdef HAS_IBL_LIGHTING\nen = ck(eo, bD);\n#endif\n#ifdef HAS_SSR\nvec3 ep = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);\n  vec3 eq = ep;\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nvec4 er;\n  er = vViewTangent;\n  er = gl_FrontFacing ? er : -er;\n  er.xyz = normalize(er.xyz);\n  vec3 es = normalize(cross(ep, er.xyz)) * er.w;\n  eq = bk(normalMapFactor, ek, er.xyz, es, ep);\n#endif\nbH = ssr(bH, eg * en, ei, eq, -normalize(vViewVertex.xyz));\n#endif\nbH *= environmentExposure * en;\n  vec3 et, eu;\n  vec3 ev = vModelNormal;\n  vec3 ew = -light0_viewDirection;\n  float ex = saturate(dot(ew, el));\n  bN(el, cg, ex, max(.045, ei), bO, eg, light0_diffuse.rgb, ew, eh, eu, et);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat ey = shadow_computeShadow();\n  eu = shadow_blend(eu, ey).rgb;\n  et = shadow_blend(et, ey).rgb;\n#endif\ncA += eu;\n  bH += et;\n  cA += ej;\n  vec3 ez = bH + cA;\n  if(outputSRGB == 1)\n    ez = linearTosRGB(ez);\n  \n#ifdef HAS_SKIN_MAP\nvec4 eA = bf();\n  ez.rgb = ez.rgb * (1. - eA.a) + eA.rgb * eA.a;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nez.rgb = shadow_blend(ez.rgb, ey).rgb;\n#endif\n#endif\nfloat eB = bb();\n#if defined(ALPHA_MODE)\n#if ALPHA_MODE == 1\nif(eB < alphaCutoff) {\n    discard;\n  } else {\n    eB = 1.;\n  }\n#else\neB = 1.;\n#endif\n#endif\nglFragColor = vec4(ez * eB, eB);\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nglFragColor = excavateColor(glFragColor);\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_SNOW\nglFragColor.rgb = snow(glFragColor, bg(), 1.);\n#endif\nif(contrast != 1.) {\n    glFragColor = contrastMatrix(contrast) * glFragColor;\n  }\n  if(length(hsv) > .0) {\n    glFragColor = hsv_apply(glFragColor, hsv);\n  }\n#ifdef OUTPUT_NORMAL\nglFragColor = vec4(cd, 1.);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:h,extraCommandProps:e,defines:r}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1),t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),e}},StandardDepthShader:class extends U_{constructor(t={}){const e=[];super({vert:"#define SHADER_NAME depth_vert\nprecision highp float;\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec4 d = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 d = getPosition(aPosition);\n#endif\nvec4 e = modelViewMatrix * c * d;\n  mat4 f = projMatrix;\n  f[2].xy += halton.xy / outSize.xy;\n  gl_Position = f * e;\n}",frag:"#define SHADER_NAME depth_frag\nprecision highp float;\nvoid main() {\n  gl_FragColor = vec4(1., .0, .0, 1.);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,n)=>am(e,n.viewMatrix,n.modelMatrix)}],extraCommandProps:t.extraCommandProps,defines:t.defines})}},PBRUtils:vw},_T=Object.freeze(Object.defineProperty({__proto__:null,AbstractTexture:fx,BloomPass:eb,BoundingBox:gx,BoxBlurShader:class extends X_{constructor({blurOffset:t}){super({vert:G_,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\nuniform float ignoreTransparent;\nvoid main() {\n  vec4 c = vec4(.0);\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      vec4 f = texture2D(textureSource, e);\n      float h;\n      if(ignoreTransparent == 1.) {\n        h = sign(f.a);\n      } else {\n        h = 1.;\n      }\n      d += h;\n      c += h * f;\n    }\n  gl_FragColor = c / max(d, 1.) * clamp(sign(d - 1.), .0, 1.);\n}",defines:{BOXBLUR_OFFSET:t||2},extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}},Constants:hx,CopyShader:hb,EdgeGeometry:Zx,EdgeShader:ub,ExtentPass:Mb,FBORayPicking:Nw,FogPass:pb,FogShader:gb,FxaaShader:Z_,GLTFHelper:Vb,GLTFManager:Jb,Geometry:bx,HDR:vT,HeatmapDisplayShader:lb,HeatmapShader:ib,InstancedMesh:u_,Jitter:$_,KHRTechniquesWebglManager:Gw,Material:Kx,Mesh:h_,MeshShader:U_,PhongMaterial:e_,PhongShader:V_,PhongSpecularGlossinessMaterial:s_,Plane:R_,PointLineShader:class extends U_{constructor(t={}){const e=[];super({vert:"attribute vec3 aPosition;\n#ifdef HAS_COLOR0\nattribute vec4 aColor0;\nvarying vec4 vColor;\n#endif\nuniform mat4 modelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float pointSize;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#endif\n#include <get_output>\n#include <heatmap_render_vert>\n#ifdef HAS_FLOODANALYSE\nvarying float vHeight;\n#endif\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_PointSize = pointSize;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * d * c;\n#endif\n#ifdef HAS_COLOR0\nvColor = aColor0 / 255.;\n#endif\n#ifdef HAS_MAP\nvTexCoord = aTexCoord;\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * d, c);\n#endif\n}",frag:"precision mediump float;\n#include <gl2_frag>\n#if defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#include <heatmap_render_frag>\nuniform vec4 baseColorFactor;\n#if defined(HAS_MAP)\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec2 vTexCoord;\n#endif\n#include <mask_frag>\nvoid main() {\n  \n#ifdef HAS_COLOR0\nglFragColor = vColor * baseColorFactor;\n#else\nglFragColor = vec4(1.) * baseColorFactor;\n#endif\n#ifdef HAS_MAP\n#ifdef HAS_ALBEDO_MAP\nglFragColor *= texture2D(baseColorTexture, vTexCoord);\n#endif\n#ifdef HAS_DIFFUSE_MAP\nglFragColor *= texture2D(diffuseTexture, vTexCoord);\n#endif\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,n)=>am(e,n.projViewMatrix,n.modelMatrix)}],defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}},PostProcessShader:Y_,QuadShader:X_,REGLHelper:Hx,RainRipplesPass:bb,Renderer:f_,ResourceLoader:g_,Scene:__,Shader:H_,ShaderLib:L_,ShadowDisplayShader:Mw,ShadowMapShader:xw,ShadowPass:Tw,SkyboxShader:ab,SsrPass:rb,StandardLiteMaterial:r_,StandardLiteShader:class extends U_{constructor(t={}){const e=[],n=t.uniforms,r=[{name:"viewMatrixInverse",type:"function",fn:(t,e)=>sm(cb,e.viewMatrix)},{name:"modelViewMatrix",type:"function",fn:function(t,n){return am(e,n.viewMatrix,n.modelMatrix)}},{name:"environmentTransform",type:"function",fn:(t,e)=>Jg(fb,Math.PI*(e.environmentOrientation||0)/180)}];n&&r.push(...n),super({vert:"precision mediump float;\n#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvarying vec3 vViewPosition;\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 c = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 c = getPosition(aPosition);\n#endif\nmat4 d = getPositionMatrix();\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = e * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = e * modelViewMatrix * d * c;\n#endif\nvec4 f = modelViewMatrix * d * c;\n  vViewPosition = -f.xyz;\n#ifdef HAS_MAP\nvec2 h = decode_getTexcoord(aTexCoord);\n  vTexCoord = h * uvScale + uvOffset;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n}",frag:"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\n#define GET_BASEMAP(UV) (texture2D(baseColorTexture, (UV)))\nuniform mat4 viewMatrix;\nuniform mat4 projMatrix;\nuniform vec3 cameraPosition;\n#if defined(HAS_IBL_LIGHTING)\nuniform mat4 viewMatrixInverse;\n#endif\nuniform vec4 baseColorFactor;\nuniform vec3 emissiveFactor;\nuniform vec3 specularFactor;\nuniform float opacity;\nuniform float envRotationSin;\nuniform float envRotationCos;\nuniform float rgbmRange;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\nvec3 c(vec3 d, vec3 e) {\n  vec3 f = dFdx(d.xyz);\n  vec3 h = dFdy(d.xyz);\n  vec3 i = normalize(f - h);\n  vec3 j = normalize(-f + h);\n  vec3 k = normalize(e);\n  vec3 l = texture2D(normalTexture, computeTexCoord(vTexCoord)).rgb * 2. - 1.;\n  mat3 m = mat3(i, j, k);\n  return normalize(m * l);\n}\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#ifdef GAMMA_INPUT\nvec3 n(vec3 o) {\n  return o * o;\n}\nfloat n(float o) {\n  return o * o;\n}\n#else\nvec3 n(vec3 o) {\n  return o;\n}\nfloat n(float o) {\n  return o;\n}\n#endif\nvec3 u() {\n  \n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn specularFactor;\n#endif\n#else\nreturn specularFactor;\n#endif\n}\nvec3 v() {\n  \n#ifdef HAS_EMISSIVE_MAP\nreturn texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn emissiveFactor;\n#endif\n}\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\nfloat A(vec3 rgb) {\n  return dot(rgb, vec3(.299, .587, .114));\n}\nfloat B(vec3 rgb) {\n  return dot(rgb, vec3(.212671, .715160, .072169));\n}\nvec3 C(vec3 xyz) {\n  vec3 D = vec3(3.240479, -1.53715, -.498535);\n  vec3 E = vec3(-.969256, 1.875992, .041556);\n  vec3 F = vec3(.055648, -.204043, 1.057311);\n  vec3 rgb;\n  rgb.b = dot(xyz, F);\n  rgb.g = dot(xyz, E);\n  rgb.r = dot(xyz, D);\n  return rgb;\n}\nvec3 H(vec3 rgb) {\n  vec3 I = vec3(.412453, .35758, .180423);\n  vec3 J = vec3(.212671, .71516, .0721688);\n  vec3 K = vec3(.0193338, .119194, .950227);\n  vec3 xyz;\n  xyz.x = dot(rgb, I);\n  xyz.y = dot(rgb, J);\n  xyz.z = dot(rgb, K);\n  return xyz;\n}\nvec3 L(vec3 xyz) {\n  float M = xyz.x + xyz.y + xyz.z;\n  M = 1. / M;\n  vec3 O;\n  O.z = xyz.y;\n  O.x = xyz.x * M;\n  O.y = xyz.y * M;\n  return O;\n}\nvec3 P(vec3 O) {\n  float x = O.x;\n  float y = O.y;\n  float J = O.z;\n  vec3 xyz;\n  xyz.y = J;\n  xyz.x = x * (J / y);\n  xyz.z = (1. - x - y) * (J / y);\n  return xyz;\n}\nfloat Q(float x) {\n  float U = pow(x, 1.60525727);\n  float V = ((1.05542877 * 4.68037409) * U) / (4.68037409 * U + 1.);\n  return clamp(V, .0, 1.);\n}\nconst float W = 1. / .18;\nfloat ba(float x) {\n  x *= W;\n  const float bb = .2;\n  const float F = .34;\n  const float bc = .002;\n  const float bd = 1.68;\n  const float be = .0005;\n  const float bf = .252;\n  const float bg = 1. / .833837;\n  return ((x * (bb * x + bc * F) + bd * be) / (x * (bb * x + F) + bd * bf) - be / bf) * bg;\n}\nvec3 bh(vec3 x) {\n  x *= W;\n  const float bb = .27;\n  const float F = .29;\n  const float bc = .052;\n  const float bd = .2;\n  const float bf = .18;\n  const float bg = 1. / .897105;\n  return ((x * (bb * x + bc * F)) / (x * (bb * x + F) + bd * bf)) * bg;\n}\nvec3 bi(vec3 x) {\n  vec3 bj = x.rgb;\n  bj = min(bj, vec3(3.));\n  float bk = B(bj);\n  if(bk > .0) {\n    float bl = Q(bk);\n    bj = bj * (bl / bk);\n    bj = clamp(bj, vec3(.0), vec3(1.));\n  }\n  float bm = 1. / 2.2;\n  bj = pow(bj, vec3(bm));\n  return bj;\n}\n#endif\n#endif\n#if defined(IRR_RGBM) || defined(ENV_RGBM) || defined(ENV_GAMMA) || defined(IRR_GAMMA)\nuniform float envMapExposure;\n#endif\nuniform vec4 themingColor;\nuniform mat3 environmentTransform;\nvec3 bn(vec3 bo, vec3 bp) {\n  \n#if defined(HAS_SHADOWMAP)\nfloat bq = dot(shadowLightDir, bp);\n  float br = (bq + 1.) / 2.;\n  br = min(1., br * 1.5);\n  float bs = 1.;\n  vec3 bt = bo * min(bs, br);\n  return bt;\n#else\nreturn bo;\n#endif\n}\n#ifdef HAS_IBL_LIGHTING\nuniform float reflectivity;\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\n#if defined(HAS_IBL_LIGHTING)\nvec3 bu(const in vec3 bv) {\n  vec3 bw = environmentTransform * bv;\n  float x = bw.x;\n  float y = bw.y;\n  float z = bw.z;\n  vec3 bt = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bt = hsv_apply(bt, hdrHSV);\n  }\n  return max(bt, vec3(.0));\n}\nvec3 bx(const in vec4 by, const in float bz) {\n  if(bz <= .0)\n    return by.rgb;\n  return bz * by.rgb * by.a;\n}\nfloat bA(const in float bB) {\n  return bB;\n}\nvec3 bC(const in float bD, const in vec3 D) {\n  vec3 bE = D;\n  float bF = prefilterMiplevel.x;\n  float bG = min(bF, bA(bD) * prefilterMiplevel.y);\n  vec3 bH = bx(textureCubeLod(prefilterMap, bE, bG), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(bH, hdrHSV);\n  } else {\n    return bH;\n  }\n}\nvec3 bI(const in vec3 k, const in vec3 D, const in float bJ) {\n  float bK = 1. - bJ;\n  float bL = bK * (sqrt(bK) + bJ);\n  return mix(k, D, bL);\n}\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  vec3 D = reflect(-bN, bv);\n  D = bI(bv, D, bO);\n  vec3 bQ = bC(bO, environmentTransform * D);\n  float bR = clamp(1. + dot(D, bP), .0, 1.);\n  bQ *= bR * bR;\n  return bQ;\n}\n#else\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  return ambientColor;\n}\n#endif\nvarying highp vec3 vViewPosition;\nvec3 bS(vec3 bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nfloat bW(float bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nvec3 bX(const in vec3 by) {\n  return vec3(by.r < .0031308 ? by.r * 12.92 : 1.055 * pow(by.r, 1. / 2.4) - .055, by.g < .0031308 ? by.g * 12.92 : 1.055 * pow(by.g, 1. / 2.4) - .055, by.b < .0031308 ? by.b * 12.92 : 1.055 * pow(by.b, 1. / 2.4) - .055);\n}\nvoid main() {\n  glFragColor = vec4(vec3(1.), opacity);\n#ifdef HAS_BASECOLOR_MAP\nvec4 bY = GET_BASEMAP(computeTexCoord(vTexCoord));\n#ifdef GAMMA_INPUT\nbY.xyz *= bY.xyz;\n#endif\nglFragColor = glFragColor * bY;\n#endif\n#ifdef ALPHATEST\nif(glFragColor.a < ALPHATEST)\n    discard;\n  \n#endif\nfloat bZ = 1.;\n  vec3 ca = dFdx(vViewPosition);\n  vec3 cb = dFdy(vViewPosition);\n  vec3 bv = normalize(cross(ca, cb));\n  vec3 cc;\n  if(projMatrix[3][3] == .0) {\n    cc = normalize(vViewPosition);\n  } else {\n    cc = vec3(.0, .0, 1.);\n  }\n  bv = faceforward(bv, -cc, bv);\n  vec3 cd = bv;\n#ifdef HAS_NORMAL_MAP\nbv = c(-vViewPosition, bv);\n#endif\nvec3 ce = vec3(.0);\n  vec3 cf = vec3(.0);\n#ifdef HAS_IBL_LIGHTING\nvec3 bp = mat3(viewMatrixInverse) * bv;\n  vec3 cg = glFragColor.rgb * bu(bp) * .5;\n  cg = bn(cg, bp);\n  ce += n(baseColorFactor.rgb) * cg;\n#endif\nvec3 ch = v();\n#ifdef METAL\nglFragColor.xyz = glFragColor.xyz * (n(ch) + ce + n(baseColorFactor.rgb) + cf);\n#else\nglFragColor.xyz = glFragColor.xyz * (n(ch) + ce + n(baseColorFactor.rgb)) + cf;\n#endif\nvec3 ci;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat cj = shadow_computeShadow();\n  ci = shadow_blend(ci, cj).rgb;\n#endif\n#ifdef HAS_COLOR\nglFragColor = glFragColor * vColor;\n#endif\nglFragColor.rgb += ci;\n  glFragColor.rgb = bX(glFragColor.rgb);\n#if defined(HAS_IBL_LIGHTING)\nvec3 ck;\n#if defined(HAS_NORMAL_MAP)\n#ifdef ENVMAP_MODE_REFLECTION\nck = reflect(-cc, bv);\n#else\nck = refract(-cc, bv, 1.);\n#endif\n#else\nck = reflect(-cc, bv);\n#endif\nck = mat3(viewMatrixInverse) * ck;\n  float cl = 1.;\n  vec3 cm;\n#ifdef HAS_IBL_LIGHTING\ncm = vec3(.0);\n#elif\ncm = ambientColor;\n#endif\ncm *= cl;\n  float bV = dot(cc, bv);\n  if(bV < -1e-2 || reflectivity == .0)\n    bV = 1.;\n  else\n    bV = max(1e-6, bV);\n  vec3 cn;\n  vec3 co = u();\n#ifdef METAL\ncn = n(co);\n#else\ncn = bS(n(co), bV) * (1. - envRotationSin);\n  glFragColor.a = mix(glFragColor.a, bW(glFragColor.a, bV), reflectivity) * envRotationCos;\n  float cp = pow(1. - bV * .5, 5.);\n  float cq = (28. / 23.) * (1. - cp) * (1. - cp);\n  glFragColor.rgb *= cq * (1. - n(co));\n#endif\nglFragColor.rgb += cm.rgb * bZ * cn.rgb;\n#endif\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT == 1\nglFragColor.rgb = bi(exposureBias * glFragColor.rgb);\n#elif TONEMAP_OUTPUT == 2\nglFragColor.rgb = bh(exposureBias * glFragColor.rgb);\n#endif\n#endif\nglFragColor.rgb = mix(glFragColor.rgb, themingColor.rgb, themingColor.a);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:r,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}},Texture2D:O_,Util:sx,WaterShader:class extends U_{constructor(t={}){super({vert:"precision highp float;\nprecision highp sampler2D;\nconst float c = 3.141592653589793;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nvec4 d(mat4 e, mat4 f, vec3 h) {\n  return e * modelMatrix * f * vec4(h, 1.);\n}\nvec3 i(in vec3 h, in vec3 j) {\n  return normalize(h + j);\n}\nmat3 k(in vec3 l) {\n  vec3 t = normalize(cross(vec3(.0, .0, 1.), l));\n  vec3 b = normalize(cross(l, t));\n  return mat3(t, b, l);\n}\nvoid m() {\n  \n}\nvoid main(void) {\n  vuv = aTexCoord;\n  vpos = (modelMatrix * vec4(aPosition, 1.)).xyz;\n  vnormal = aNormal;\n  vtbnMatrix = k(vnormal);\n  gl_Position = d(projMatrix, viewMatrix, vpos);\n  m();\n}",frag:"precision highp float;\nprecision highp sampler2D;\nuniform sampler2D texWaveNormal;\nuniform sampler2D texWavePerturbation;\nuniform vec3 octaveTextureRepeat;\nuniform vec4 waveParams;\nuniform vec2 waveDirection;\nuniform vec4 waterColor;\nuniform vec3 lightingDirection;\nuniform vec3 lightingIntensity;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nconst vec2 c = vec2(6. / 25., 5. / 24.);\nvec2 d(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rg - 1.;\n}\nfloat h(vec2 f) {\n  return texture2D(texWavePerturbation, f).b;\n}\nvec3 i(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rgb - 1.;\n}\nfloat j(vec2 f, float k) {\n  return fract(k);\n}\nfloat l(vec2 f, float k) {\n  float m = j(f, k);\n  return 1. - abs(1. - 2. * m);\n}\nvec3 n(sampler2D o, vec2 f, float k, float u) {\n  float v = waveParams[2];\n  float A = waveParams[3];\n  vec2 B = d(o, f) * v;\n  float m = j(f, k + u);\n  float C = l(f, k + u);\n  vec2 D = f;\n  D -= B * (m + A);\n  D += u;\n  D += (k - m) * c;\n  return vec3(D, C);\n}\nconst float E = .3737;\nconst float F = 7.77;\nvec3 G(sampler2D H, sampler2D I, vec2 f, vec2 J, float k) {\n  float K = waveParams[0];\n  vec2 L = k * -J;\n  float M = h(f * E) * F;\n  vec3 N = n(I, f + L, k + M, .0);\n  vec3 O = n(I, f + L, k + M, .5);\n  vec3 P = i(H, N.xy) * N.z;\n  vec3 Q = i(H, O.xy) * O.z;\n  vec3 R = normalize(P + Q);\n  R.xy *= K;\n  R.z = sqrt(1. - dot(R.xy, R.xy));\n  return R;\n}\nvec3 S(vec2 f, float k) {\n  float T = waveParams[1];\n  return G(texWaveNormal, texWavePerturbation, f * T, waveDirection, k);\n}\nconst float U = 3.141592653589793;\nconst float V = 1. / U;\nconst float W = .3183098861837907;\nconst float X = 1.570796326794897;\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nfloat Y = 2.2;\nvec3 Z(float ba, vec3 bb, float bc) {\n  return bb + (bc - bb) * pow(1. - ba, 5.);\n}\nfloat bd(float be, float bf) {\n  float bg = bf * bf;\n  float bh = be * be;\n  float bi = pow((bh * (bg - 1.) + 1.), Y) * U;\n  return bg / bi;\n}\nfloat bj(float bk) {\n  return .25 / (bk * bk);\n}\nvec3 bl(in PBRShadingWater bm, float bf, vec3 bn, float bo) {\n  vec3 bp = Z(bm.VdotH, bn, bo);\n  float bq = bd(bm.NdotH, bf);\n  float br = bj(bm.LdotH);\n  return (bq * br) * bp;\n}\nvec3 bs(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float bt = 2.2;\nconst float bu = .4545454545;\nvec4 bv(vec4 bw) {\n  return vec4(pow(bw.rgb, vec3(bu)), bw.w);\n}\nvec3 bx(vec3 bw) {\n  return pow(bw, vec3(bt));\n}\nconst vec3 by = vec3(.02, 1., 5.);\nconst vec2 bz = vec2(.02, .1);\nconst float bf = .06;\nconst vec3 bA = vec3(0, .6, .9);\nconst vec3 bB = vec3(.72, .92, 1.);\nPBRShadingWater bC;\nvec3 bD(in float bE, in vec3 bF, in vec3 bG) {\n  float bH = pow((1. - bE), by[2]);\n  return mix(bG, bF, bH);\n}\nvec3 bI(in vec3 bJ, in vec3 bK, in vec3 bL, vec3 bw, in vec3 bM, in vec3 bN, in float bO) {\n  vec3 bP = bx(bw);\n  vec3 bQ = normalize(bL + bK);\n  bC.NdotL = clamp(dot(bJ, bL), .0, 1.);\n  bC.NdotV = clamp(dot(bJ, bK), .001, 1.);\n  bC.VdotN = clamp(dot(bK, bJ), .001, 1.);\n  bC.NdotH = clamp(dot(bJ, bQ), .0, 1.);\n  bC.VdotH = clamp(dot(bK, bQ), .0, 1.);\n  bC.LdotH = clamp(dot(bL, bQ), .0, 1.);\n  float bR = max(dot(bN, bK), .0);\n  vec3 bS = bx(bB);\n  vec3 bT = bx(bA);\n  vec3 bB = bD(bR, bS, bT);\n  float bU = max(dot(bN, bL), .0);\n  bB *= .1 + bU * .9;\n  float bV = clamp(bO, .8, 1.);\n  vec3 bW = Z(bC.VdotN, vec3(by[0]), by[1]) * bB * bV;\n  vec3 bX = bP * mix(bB, bU * bM * V, 2. / 3.) * bV;\n  vec3 bY = vec3(.0);\n  if(bR > .0 && bU > .0) {\n    vec3 bZ = bl(bC, bf, vec3(bz[0]), bz[1]);\n    vec3 ca = bM * V * bO;\n    bY = bC.NdotL * ca * bZ;\n  }\n  return bs(bW + bX + bY);\n}\nvoid main() {\n  vec3 bN = vnormal;\n  vec3 cb = S(vuv, timeElapsed);\n  vec3 bJ = normalize(vtbnMatrix * cb);\n  vec3 bK = -normalize(vpos - camPos);\n  vec3 bL = normalize(-lightingDirection);\n  float bO = 1.;\n  vec4 cc = vec4(bI(bJ, bK, bL, waterColor.rgb, lightingIntensity, bN, bO), waterColor.w);\n  gl_FragColor = bv(cc);\n}",defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}},WireFrameMaterial:class extends Kx{constructor(t){super(t,$x)}},WireframeShader:class extends U_{constructor(t={}){let e=t.extraCommandProps||{};const n=[];e=Hv({},e,{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},sample:{alpha:!0}}),super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aBarycentric;\nvarying vec3 vBarycentric;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nvarying vec3 vPosition;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(c * d, modelMatrix);\n#else\ngl_Position = projMatrix * modelViewMatrix * c * d;\n#endif\nvBarycentric = aBarycentric;\n  vPosition = aPosition;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec3 vBarycentric;\nuniform float time;\nuniform float thickness;\nuniform float secondThickness;\nuniform float dashRepeats;\nuniform float dashLength;\nuniform bool dashOverlap;\nuniform bool dashEnabled;\nuniform bool dashAnimate;\nuniform bool seeThrough;\nuniform bool insideAltColor;\nuniform bool dualStroke;\nuniform bool squeeze;\nuniform float squeezeMin;\nuniform float squeezeMax;\nuniform vec4 stroke;\nuniform vec4 fill;\nuniform float opacity;\nuniform bool noiseEnable;\nvarying vec3 vPosition;\n#ifdef HAS_INSTANCE\nvarying vec4 vInstanceColor;\n#endif\n#include <mask_frag>\n#define F4 0.309016994374947451\n#define halfDist 0.5\nvec4 c(vec4 x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nfloat c(float x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nvec4 d(vec4 x) {\n  return c((x * 34. + 1.) * x);\n}\nfloat d(float x) {\n  return c((x * 34. + 1.) * x);\n}\nvec4 e(vec4 r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nfloat e(float r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nvec4 f(float h, vec4 i) {\n  const vec4 k = vec4(1., 1., 1., -1.);\n  vec4 p, s;\n  p.xyz = floor(fract(vec3(h) * i.xyz) * 7.) * i.z - 1.;\n  p.w = 1.5 - dot(abs(p.xyz), k.xyz);\n  s = vec4(lessThan(p, vec4(.0)));\n  p.xyz = p.xyz + (s.xyz * 2. - 1.) * s.www;\n  return p;\n}\nfloat l(vec4 m) {\n  const vec4 n = vec4(.138196601125011, .276393202250021, .414589803375032, -.447213595499958);\n  vec4 o = floor(m + dot(m, vec4(F4)));\n  vec4 u = m - o + dot(o, n.xxxx);\n  vec4 A;\n  vec3 B = step(u.yzw, u.xxx);\n  vec3 D = step(u.zww, u.yyz);\n  A.x = B.x + B.y + B.z;\n  A.yzw = 1. - B;\n  A.y += D.x + D.y;\n  A.zw += 1. - D.xy;\n  A.z += D.z;\n  A.w += 1. - D.z;\n  vec4 E = clamp(A, .0, 1.);\n  vec4 F = clamp(A - 1., .0, 1.);\n  vec4 G = clamp(A - 2., .0, 1.);\n  vec4 H = u - G + n.xxxx;\n  vec4 I = u - F + n.yyyy;\n  vec4 J = u - E + n.zzzz;\n  vec4 K = u + n.wwww;\n  o = c(o);\n  float L = d(d(d(d(o.w) + o.z) + o.y) + o.x);\n  vec4 M = d(d(d(d(o.w + vec4(G.w, F.w, E.w, 1.)) + o.z + vec4(G.z, F.z, E.z, 1.)) + o.y + vec4(G.y, F.y, E.y, 1.)) + o.x + vec4(G.x, F.x, E.x, 1.));\n  vec4 i = vec4(1. / 294., 1. / 49., 1. / 7., .0);\n  vec4 N = f(L, i);\n  vec4 O = f(M.x, i);\n  vec4 P = f(M.y, i);\n  vec4 Q = f(M.z, i);\n  vec4 R = f(M.w, i);\n  vec4 S = e(vec4(dot(N, N), dot(O, O), dot(P, P), dot(Q, Q)));\n  N *= S.x;\n  O *= S.y;\n  P *= S.z;\n  Q *= S.w;\n  R *= e(dot(R, R));\n  vec3 T = max(.6 - vec3(dot(u, u), dot(H, H), dot(I, I)), .0);\n  vec2 U = max(.6 - vec2(dot(J, J), dot(K, K)), .0);\n  T = T * T;\n  U = U * U;\n  return 49. * (dot(T * T, vec3(dot(N, u), dot(O, H), dot(P, I))) + dot(U * U, vec2(dot(Q, J), dot(R, K))));\n}\nconst float V = 3.14159265359;\nfloat W(float X, float Y) {\n  float Z = fwidth(Y) * halfDist;\n  return smoothstep(X - Z, X + Z, Y);\n}\nvec4 ba(vec3 bb) {\n  float bc = min(min(bb.x, bb.y), bb.z);\n  float bd = .0;\n  if(noiseEnable)\n    bd += l(vec4(vPosition.xyz * 80.0, time * halfDist)) * .12;\n  bc += bd;\n  float be = max(bb.x, bb.y);\n  if(bb.y < bb.x && bb.y < bb.z) {\n    be = 1. - be;\n  }\n  float bf = thickness;\n  if(squeeze) {\n    bf *= mix(squeezeMin, squeezeMax, (1. - sin(be * V)));\n  }\n  if(dashEnabled) {\n    float bg = 1. / dashRepeats * dashLength / 2.;\n    if(!dashOverlap) {\n      bg += 1. / dashRepeats / 2.;\n    }\n    if(dashAnimate) {\n      bg += time * .22;\n    }\n    float bh = fract((be + bg) * dashRepeats);\n    bf *= 1. - W(dashLength, bh);\n  }\n  float bi = 1. - W(bf, bc);\n#ifdef HAS_INSTANCE\nvec4 bj = vInstanceColor;\n#else\nvec4 bj = stroke;\n#endif\nvec4 bk = vec4(.0);\n  if(seeThrough) {\n    bk = vec4(bj.xyz, bi);\n    if(insideAltColor && !gl_FrontFacing) {\n      bk.rgb = fill.xyz;\n    }\n  } else {\n    vec3 bl = mix(fill.xyz, bj.xyz, bi);\n    bk.a = fill.a;\n    if(dualStroke) {\n      float bm = 1. - W(secondThickness, bc);\n      vec3 bn = mix(fill.xyz, stroke.xyz, abs(bm - bi));\n      bk.rgb = bn;\n    } else {\n      bk.rgb = bl;\n    }\n  }\n  return bk;\n}\nvoid main() {\n  glFragColor = ba(vBarycentric);\n  glFragColor *= halfDist + opacity;\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>am(n,e.viewMatrix,e.modelMatrix)}],extraCommandProps:e}),this.version=300}},earcut:yT,glMatrix:Og,mat2:zg,mat2d:Vg,mat3:em,mat4:Pm,pbr:xT,quat:vy,quat2:Oy,vec2:nv,vec3:sA,vec4:DA},Symbol.toStringTag,{value:"Module"}));var bT=Array.isArray,wT=Object.keys,TT=Object.prototype.hasOwnProperty,MT=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){var r,i,o,s=bT(e),a=bT(n);if(s&&a){if((i=e.length)!=n.length)return!1;for(r=i;0!=r--;)if(!t(e[r],n[r]))return!1;return!0}if(s!=a)return!1;var l=e instanceof Date,h=n instanceof Date;if(l!=h)return!1;if(l&&h)return e.getTime()==n.getTime();var u=e instanceof RegExp,c=n instanceof RegExp;if(u!=c)return!1;if(u&&c)return e.toString()==n.toString();var f=wT(e);if((i=f.length)!==wT(n).length)return!1;for(r=i;0!=r--;)if(!TT.call(n,f[r]))return!1;for(r=i;0!=r--;)if(!t(e[o=f[r]],n[o]))return!1;return!0}return e!=e&&n!=n};const CT=e(MT);function ST(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function IT(t,...e){for(let n=0;n<e.length;n++)ST(t,e[n])}class PT{constructor(t){this.context=t,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class ET{constructor(t){this.context=t,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class OT{constructor(t){this.context=t,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const RT={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},kT={has(t,e){const n=t.t,r=t.i;return!(!n&&!r.getExtension(e))&&(e=e.toLowerCase(),n&&RT[e]||"webgl_draw_buffers"===e||"oes_vertex_array_object"===e||"angle_instanced_arrays"===e)},mock:(t,e)=>(e=e.toLowerCase(),RT[e]?t.t?("oes_texture_float"!==e&&"oes_texture_half_float"!==e||t.i.getExtension("EXT_color_buffer_float"),RT[e]):t.i.getExtension(e):"webgl_draw_buffers"===e?new PT(t):"oes_vertex_array_object"===e?new ET(t):"angle_instanced_arrays"===e?new OT(t):null),getInternalFormat:(t,e,n)=>6402===e?33190:34041===e?35056:36193===n&&e===t.RGBA?34842:36193===n&&e===t.RGB?34843:n===t.FLOAT&&e===t.RGBA?34836:n===t.FLOAT&&e===t.RGB?34837:e,getTextureType:(t,e)=>36193===e?t.HALF_FLOAT:e};let LT=1,DT=class{constructor(t){var e;this.uid=LT++,this.states={scissor:[0,0,(e=t).canvas.width,e.canvas.height],viewport:[0,0,e.canvas.width,e.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[e.FUNC_ADD,e.FUNC_ADD],blendFuncSeparate:[e.ONE,e.ZERO,e.ONE,e.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[e.BACK],depthFunc:[e.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[e.CCW],hint:{33170:[e.DONT_CARE],35723:[e.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[e.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[e.ALWAYS,0,4294967295],1029:[e.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[e.KEEP,e.KEEP,e.KEEP],1029:[e.KEEP,e.KEEP,e.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const t=[],n=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let e=0;e<n;e++)t.push({3553:null,34067:null});return t[-1]={3553:null,34067:null},t}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null},this.i=t,this.i._fusiongl_drawCalls=0,this.t=void 0!==window.WebGL2RenderingContext&&this.i instanceof window.WebGL2RenderingContext;const n=Object.getPrototypeOf(this);this.t?Object.setPrototypeOf(n,window.WebGL2RenderingContext.prototype):Object.setPrototypeOf(n,WebGLRenderingContext.prototype),this.s=t.getParameter(t.MAX_VERTEX_ATTRIBS)}get canvas(){return this.i.canvas}get drawingBufferWidth(){return this.i.drawingBufferWidth}get drawingBufferHeight(){return this.i.drawingBufferHeight}get drawingBufferColorSpace(){return this.i.drawingBufferColorSpace}set drawingBufferColorSpace(t){this.i.drawingBufferColorSpace=t}get gl(){return this.i}get buffersOES(){return this.h||(this.h=this.i.getExtension("WEBGL_draw_buffers")),this.h}get vaoOES(){return this.u||(this.u=this.i.getExtension("OES_vertex_array_object")),this.u}get angleOES(){return this.o||(this.o=this.i.getExtension("ANGLE_instanced_arrays")),this.o}get standOES(){return this.l||(this.l=this.i.getExtension("OES_standard_derivatives")),this.l}attachShader(t,e){return this.i.attachShader(t,e)}shaderSource(t,e){return this.i.shaderSource(t,e)}compileShader(t){return this.i.compileShader(t)}createShader(t){return this.i.createShader(t)}createProgram(){return this.i.createProgram()}deleteProgram(t){return this.states.program===t&&(this.states.program=null),this.i.deleteProgram(t)}deleteShader(t){return this.i.deleteShader(t)}detachShader(t,e){return this.i.detachShader(t,e)}getAttachedShaders(t){return this.i.getAttachedShaders(t)}linkProgram(t){return this.i.linkProgram(t)}makeXRCompatible(){return this.i.makeXRCompatible()}getShaderParameter(t,e){return this.i.getShaderParameter(t,e)}getShaderPrecisionFormat(t,e){return this.i.getShaderPrecisionFormat(t,e)}getShaderInfoLog(t){return this.i.getShaderInfoLog(t)}getShaderSource(t){return this.i.getShaderSource(t)}getProgramInfoLog(t){return this.i.getProgramInfoLog(t)}getProgramParameter(t,e){return this.i.getProgramParameter(t,e)}getError(){return this.i.getError()}getContextAttributes(){return this.i.getContextAttributes()}getExtension(t){return kT.has(this,t)?kT.mock(this,t):this.i.getExtension(t)}getSupportedExtensions(){return this.i.getSupportedExtensions()}getParameter(t){return this.i.getParameter(t)}isEnabled(t){return this.i.isEnabled(t)}isProgram(t){return this.i.isProgram(t)}isShader(t){return this.i.isShader(t)}validateProgram(t){return this.i.validateProgram(t)}clear(t){return this.m(),this.i.clear(t)}drawArrays(t,e,n){return this.m(),this.g(),this.i.drawArrays(t,e,n)}drawElements(t,e,n,r){return this.m(),this.g(),this.i.drawElements(t,e,n,r)}drawBuffers(t){return this.m(),this.g(),this.t?this.i.drawBuffers(t):this.buffersOES.drawBuffersWEBGL(t)}g(){this.i._fusiongl_drawCalls++}resetDrawCalls(){this.i._fusiongl_drawCalls=0}getDrawCalls(){return this.i._fusiongl_drawCalls}v(){const t=this.i,e=t.getParameter(t.CURRENT_PROGRAM),n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),r=[];for(let i=0;i<n;i++)r.push(t.getVertexAttrib(i,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this._={buffers:r,elements:t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(this.uid,this._,this.uid,this.states.attributes,this.states.attributes[0].buffer,this._.buffers[0],this.states.attributes[1].buffer,this._.buffers[1],this.states.attributes[2].buffer,this._.buffers[2])}finish(){return this.i.finish()}flush(){return this.m(),this.i.flush()}commit(){return this.m(),this.i.commit()}isContextLost(){return this.i.isContextLost()}getFragDataLocation(t,e){return this.i.getFragDataLocation(t,e)}createSampler(){return this.i.createSampler()}deleteSampler(){return this.i.deleteSampler()}bindSampler(){return this.i.bindSampler()}isSampler(){return this.i.isSampler()}getSamplerParameter(){return this.i.getSamplerParameter()}isQuery(t){return this.i.beginQuery(t)}beginQuery(t,e){return this.i.beginQuery(t,e)}deleteQuery(t){return this.i.query(t)}isTransformFeedback(t){return this.i.isTransformFeedback(t)}beginTransformFeedback(t){return this.i.beginTransformFeedback(t)}deleteTransformFeedback(t){return this.i.deleteTransformFeedback(t)}pauseTransformFeedback(){return this.i.pauseTransformFeedback()}resumeTransformFeedback(){return this.i.resumeTransformFeedback()}transformFeedbackVaryings(t,e,n){return this.i.transformFeedbackVaryings(t,e,n)}bindBufferBase(t,e,n){return this.i.bbindBufferBase(t,e,n)}bindBufferRange(t,e,n,r,i){return this.i.bindBufferRange(t,e,n,r,i)}bindTransformFeedback(t,e){return this.i.bindTransformFeedback(t,e)}fenceSync(t,e){return this.i.fenceSync(t,e)}isSync(t){return this.i.isSync(t)}deleteSync(t){return this.i.deleteSync(t)}clientWaitSync(t,e,n){return this.i.clientWaitSync(t,e,n)}waitSync(t,e,n){return this.i.waitSync(t,e,n)}getSyncParameter(t,e){return this.i.getSyncParameter(t,e)}getIndexedParameter(t,e){return this.i.getIndexedParameter(t,e)}};IT(DT.prototype,{bufferData(...t){return this.m(),this.i.bufferData(...t)},bufferSubData(...t){return this.m(),this.i.bufferSubData(...t)},createBuffer(){return this.i.createBuffer()},deleteBuffer(t){const e=this.states;e.arrayBuffer===t?e.arrayBuffer=null:e.elementArrayBuffer===t&&(e.elementArrayBuffer=null);const n=e.attributes;for(const r in n)n[r].buffer===t&&(n[r].buffer=null);return this.i.deleteBuffer(t)},getBufferParameter(t,e){return this.m(),this.i.getBufferParameter(t,e)},isBuffer(t){return this.i.isBuffer(t)},copyBufferSubData(t,e,n,r,i){return this.i.isBuffer(t,e,n,r,i)},readBuffer(t){return this.i.readBuffer(t)}}),IT(DT.prototype,{checkFramebufferStatus(t){return this.i.checkFramebufferStatus(t)},createFramebuffer(){return this.i.createFramebuffer()},deleteFramebuffer(t){const e=this.states.framebuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteFramebuffer(t)},framebufferRenderbuffer(t,e,n,r){return this.m(),this.i.framebufferRenderbuffer(t,e,n,r)},framebufferTexture2D(t,e,n,r,i){return this.m(),this.i.framebufferTexture2D(t,e,n,r,i)},getFramebufferAttachmentParameter(t,e,n){return this.m(),this.i.getFramebufferAttachmentParameter(t,e,n)},isFramebuffer(t){return this.i.isFramebuffer(t)},readPixels(t,e,n,r,i,o,s){return this.m(),this.i.readPixels(t,e,n,r,i,o,s)},blitFramebuffer(t,e,n,r,i,o,s,a,l,h){return this.m(),this.i.blitFramebuffer(t,e,n,r,i,o,s,a,l,h)}}),IT(DT.prototype,{createRenderbuffer(){return this.i.createRenderbuffer()},deleteRenderbuffer(t){const e=this.states.renderbuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteRenderbuffer(t)},getRenderbufferParameter(t,e){return this.m(),this.i.getRenderbufferParameter(t,e)},isRenderbuffer(t){return this.i.isRenderbuffer(t)},renderbufferStorage(t,e,n,r){return this.m(),this.i.renderbufferStorage(t,e,n,r)},renderbufferStorageMultisample(t,e,n,r,i){return this.m(),this.i.renderbufferStorageMultisample(t,e,n,r,i)}}),IT(DT.prototype,{scissor(t,e,n,r){this.m();const i=this.states.scissor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.scissor(t,e,n,r))},viewport(t,e,n,r){this.m();const i=this.states.viewport;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.viewport(t,e,n,r))},blendColor(t,e,n,r){this.m();const i=this.states.blendColor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.blendColor(t,e,n,r))},blendEquation(t){this.m();const e=this.states.blendEquationSeparate;e[0]===t&&e[1]===t||(e[0]=t,e[1]=t,this.i.blendEquation(t))},blendEquationSeparate(t,e){this.m();const n=this.states.blendEquationSeparate;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.blendEquationSeparate(t,e))},blendFunc(t,e){this.m();const n=this.states.blendFuncSeparate;n[0]===t&&n[2]===t&&n[1]===e&&n[3]===e||(n[0]=t,n[1]=e,n[2]=t,n[3]=e,this.i.blendFunc(t,e))},blendFuncSeparate(t,e,n,r){this.m();const i=this.states.blendFuncSeparate;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.blendFuncSeparate(t,e,n,r))},clearColor(t,e,n,r){this.m();const i=this.states.clearColor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.clearColor(t,e,n,r))},clearDepth(t){this.m();const e=this.states.clearDepth;e[0]!==t&&(e[0]=t,this.i.clearDepth(t))},clearStencil(t){this.m();const e=this.states.clearStencil;e[0]!==t&&(e[0]=t,this.i.clearStencil(t))},colorMask(t,e,n,r){this.m();const i=this.states.colorMask;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.colorMask(t,e,n,r))},cullFace(t){this.m();const e=this.states.cullFace;e[0]!==t&&(e[0]=t,this.i.cullFace(t))},depthFunc(t){this.m();const e=this.states.depthFunc;e[0]!==t&&(e[0]=t,this.i.depthFunc(t))},depthMask(t){this.m();const e=this.states.depthMask;e[0]!==t&&(e[0]=t,this.i.depthMask(t))},depthRange(t,e){this.m();const n=this.states.depthRange;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.depthRange(t,e))},disable(t){this.m();const e=this.states.capabilities;e[t]&&(e[t]=!1,this.i.disable(t))},enable(t){this.m();const e=this.states.capabilities;e[t]||(e[t]=!0,this.i.enable(t))},frontFace(t){this.m();const e=this.states.frontFace;e[0]!==t&&(e[0]=t,this.i.frontFace(t))},hint(t,e){this.m();const n=this.states.hint;n[t][0]!==e&&(n[t][0]=e,this.i.hint(t,e))},lineWidth(t){this.m();const e=this.states.lineWidth;e[0]!==t&&(e[0]=t,this.i.lineWidth(t))},pixelStorei(t,e){this.m();const n=this.states.pixelStorei;n[t]!==e&&(n[t]&&(n[t][0]=e),this.i.pixelStorei(t,e))},polygonOffset(t,e){this.m();const n=this.states.polygonOffset;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.polygonOffset(t,e))},sampleCoverage(t,e){this.m();const n=this.states.sampleCoverage;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.sampleCoverage(t,e))},stencilFunc(t,e,n){this.m();const r=this.states.stencilFuncSeparate,i=this.i;r[i.FRONT][0]===t&&r[i.FRONT][1]===e&&r[i.FRONT][2]===n&&r[i.BACK][0]===t&&r[i.BACK][1]===e&&r[i.BACK][2]===n||(r[i.FRONT][0]=r[i.BACK][0]=t,r[i.FRONT][1]=r[i.BACK][1]=e,r[i.FRONT][2]=r[i.BACK][2]=n,this.i.stencilFunc(t,e,n))},stencilFuncSeparate(t,e,n,r){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilFunc(e,n,r);const i=this.states.stencilFuncSeparate;i[t][0]===e&&i[t][1]===n&&i[t][2]===r||(i[t][0]=e,i[t][1]=n,i[t][2]=r,this.i.stencilFuncSeparate(t,e,n,r))},stencilMask(t){this.m();const e=this.i,n=this.states.stencilMaskSeparate;n[e.FRONT][0]===t&&n[e.BACK][0]===t||(n[e.FRONT][0]=t,n[e.BACK][0]=t,this.i.stencilMask(t))},stencilMaskSeparate(t,e){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilMask(e);const n=this.states.stencilMaskSeparate;n[t][0]!==e&&(n[t][0]=e,this.i.stencilMaskSeparate(t,e))},stencilOp(t,e,n){this.m();const r=this.states.stencilOpSeparate,i=this.i;r[i.FRONT][0]===t&&r[i.FRONT][1]===e&&r[i.FRONT][2]===n&&r[i.BACK][0]===t&&r[i.BACK][1]===e&&r[i.BACK][2]===n||(r[i.FRONT][0]=r[i.BACK][0]=t,r[i.FRONT][1]=r[i.BACK][1]=e,r[i.FRONT][2]=r[i.BACK][2]=n,this.i.stencilOp(t,e,n))},stencilOpSeparate(t,e,n,r){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilOp(e,n,r);const i=this.states.stencilOpSeparate;i[t][0]===e&&i[t][1]===n&&i[t][2]===r||(i[t][0]=e,i[t][1]=n,i[t][2]=r,this.i.stencilOpSeparate(t,e,n,r))},bindFramebuffer(t,e){this.m();const n=this.states.framebuffer;n[t]!==e&&(n[t]=e,this.i.bindFramebuffer(t,e))},bindRenderbuffer(t,e){this.m();const n=this.states.renderbuffer;n[t]!==e&&(n[t]=e,this.i.bindRenderbuffer(t,e))},bindTexture(t,e){this.m();const n=this.states.textures,r=-1!==n.active?n.active-33984:-1;n.units[r][t]=e,this.i.bindTexture(t,e)},activeTexture(t){this.m();const e=this.i,n=this.states.textures,r=n.active;n.active=t,this.activeUnit!==t&&(e.activeTexture(t),this.activeUnit=t),-1===r&&(n.units[t-33984][e.TEXTURE_2D]=n.units[-1][e.TEXTURE_2D],n.units[t-33984][e.TEXTURE_CUBE_MAP]=n.units[-1][e.TEXTURE_CUBE_MAP],n.units[-1][e.TEXTURE_2D]=null,n.units[-1][e.TEXTURE_CUBE_MAP]=null)},useProgram(t){this.m();const e=this.states;e.program!==t&&(this.states.activeAttribType=0,e.program=t,void 0===t.fid&&(t.fid=0),this.S(),this.i.useProgram(t))},S(){const t=this.states.program;if(!t)return;const e=t.cachedUniforms=t.cachedUniforms||{};for(const n in e)Array.isArray(e[n])?e[n].fill(null):e[n]=null},bindBuffer(t,e){this.m();const n=this.i,r=this.states;t===n.ELEMENT_ARRAY_BUFFER?r.elementArrayBuffer=e:r.arrayBuffer=e,n.bindBuffer(t,e)},bindVertexArray(t){this.m(),this.states.activeAttribType=1;const e=this.i,n=this.states;n.vao!==t&&(n.vao=t,this.t?e.bindVertexArray(t):this.vaoOES.bindVertexArrayOES(t))},vertexAttribPointer(t,e,n,r,i,o){this.m(),this.states.attributes[t]||(this.states.attributes[t]={enable:!0});const s=this.states.attributes[t];return s.buffer=this.states.arrayBuffer,s.args?(s.args[0]=t,s.args[1]=e,s.args[2]=n,s.args[3]=r,s.args[4]=i,s.args[5]=o):s.args=[t,e,n,r,i,o],this.i.vertexAttribPointer(t,e,n,r,i,o)},vertexAttribDivisor(t,e){return this.m(),this.states.attributes[t].divisor=e,this.t?this.i.vertexAttribDivisor(t,e):this.angleOES.vertexAttribDivisorANGLE(t,e)}},{m(){const t=this.i;if(t.A!==this)if(t.A){const e=t.A;this.p(e.states),t.A=this}else t.A=this},p(t){if(!t)return;delete this.activeUnit;const e=this.states,n=this.i;let r=0;for(const u in e)if("capabilities"!==u&&"textures"!==u&&"attributes"!==u&&"arrayBuffer"!==u&&"elementArrayBuffer"!==u&&"vao"!==u)if("program"===u)e.program!==t.program&&(n.useProgram(e.program),e.program&&(r=n.getProgramParameter(e.program,n.ACTIVE_ATTRIBUTES)));else if("framebuffer"===u)for(const r in e[u])e[u][r]!==t[u][r]&&n.bindFramebuffer(+r,e[u][r]);else if("renderbuffer"===u)for(const r in e[u])e[u][r]!==t[u][r]&&n.bindRenderbuffer(+r,e[u][r]);else if(!CT(e[u],t[u]))if(Array.isArray(t[u]))n[u](...e[u]);else if(t[u])for(const r in e[u])CT(e[u][r],t[u][r])||n[u](+r,...e[u][r]);this.S();for(const u in e.capabilities)e.capabilities[u]!==t.capabilities[u]&&n[e.capabilities[u]?"enable":"disable"](+u);const i=e.textures,o=t.textures,s=i.units,a=o.units,l=i.active-n.TEXTURE0;for(let u=0;u<s.length;u++)u===l||s[u][n.TEXTURE_2D]===a[u][n.TEXTURE_2D]&&s[u][n.TEXTURE_CUBE_MAP]===a[u][n.TEXTURE_CUBE_MAP]||(n.activeTexture(n.TEXTURE0+u),n.bindTexture(n.TEXTURE_2D,s[u][n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,s[u][n.TEXTURE_CUBE_MAP]));if(i.active>-1){const t=s[l];t[n.TEXTURE_2D]===a[l][n.TEXTURE_2D]&&t[n.TEXTURE_CUBE_MAP]===a[l][n.TEXTURE_CUBE_MAP]||(n.activeTexture(i.active),n.bindTexture(n.TEXTURE_2D,t[n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,t[n.TEXTURE_CUBE_MAP]))}this.t?n.bindVertexArray(null):this.u&&this.u.bindVertexArrayOES(null);const h=this.s;if(this.t||this.angleOES)for(let u=0;u<h;u++)this.t?n.vertexAttribDivisor(u,0):this.angleOES.vertexAttribDivisorANGLE(u,0);n.bindBuffer(n.ARRAY_BUFFER,e.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.elementArrayBuffer),1===e.activeAttribType?this.N(e,n):this.F(e,n,r)},N(t,e){const n=t.vao;n&&(this.t?e.bindVertexArray(n||null):this.u&&this.u.bindVertexArrayOES(n||null))},F(t,e,n){const r=this.s,i=t.attributes;let o=0;for(let s=0;s<r;s++){const t=i[s];if(o<n&&t){if(t.buffer){if(e.bindBuffer(e.ARRAY_BUFFER,t.buffer),e.vertexAttribPointer(...t.args),t.divisor&&(this.t?e.vertexAttribDivisor(s,t.divisor):this.angleOES.vertexAttribDivisorANGLE(s,t.divisor)),t.enable){e.enableVertexAttribArray(s),o++;continue}e.disableVertexAttribArray(s)}e.disableVertexAttribArray(s)}else e.disableVertexAttribArray(s)}}}),IT(DT.prototype,{compressedTexImage2D(t,e,n,r,i,o,s){return this.m(),this.i.compressedTexImage2D(t,e,n,r,i,o,s)},copyTexImage2D(t,e,n,r,i,o,s,a){return this.m(),this.i.copyTexImage2D(t,e,n,r,i,o,s,a)},copyTexSubImage2D(t,e,n,r,i,o,s,a){return this.m(),this.i.copyTexSubImage2D(t,e,n,r,i,o,s,a)},createTexture(){return this.i.createTexture()},deleteTexture(t){const e=this.states.textures.units;for(let n=0;n<e.length;n++)for(const r in e[n])e[n][r]===t&&(e[n][r]=null);return this.i.deleteTexture(t)},generateMipmap(t){return this.m(),this.i.generateMipmap(t)},getTexParameter(t,e){return this.m(),this.i.getTexParameter(t,e)},isTexture(t){return this.i.isTexture(t)},texImage2D(...t){if(this.m(),this.t){const e=t[t.length-2],n=kT.getInternalFormat(this.i,t[2],e);n!==t[2]&&(t[2]=n);const r=kT.getTextureType(this.i,e);r!==e&&(t[t.length-2]=r)}return this.i.texImage2D(...t)},texSubImage2D(...t){if(this.m(),this.t){const e=t[t.length-2],n=kT.getTextureType(this.i,e);n!==e&&(t[t.length-2]=n)}return this.i.texSubImage2D(...t)},texParameterf(t,e,n){return this.m(),this.i.texParameterf(t,e,n)},texParameteri(t,e,n){return this.m(),this.i.texParameteri(t,e,n)},texStorage2D(t,e,n,r,i){return this.m(),this.i.texStorage2D(t,e,n,r,i)},texImage3D(t,e,n,r,i,o,s,a,l,h){return this.m(),this.i.texImage3D(t,e,n,r,i,o,s,a,l,h)},texStorage3D(t,e,n,r,i,o){return this.m(),this.i.texStorage3D(t,e,n,r,i,o)},texSubImage3D(t,e,n,r,i,o,s,a,l,h,u){return this.m(),this.i.texSubImage3D(t,e,n,r,i,o,s,a,l,h,u)},copyTexSubImage3D(t,e,n,r,i,o,s,a,l){return this.m(),this.i.copyTexSubImage3D(t,e,n,r,i,o,s,a,l)},compressedTexSubImage3D(t,e,n,r,i,o,s,a,l,h,u){return this.m(),this.i.compressedTexSubImage3D(t,e,n,r,i,o,s,a,l,h,u)}});const NT=[];function FT(t,e){const n=e.length;for(let r=0;r<n;r++)t[r]=e[r];return t}IT(DT.prototype,{bindAttribLocation(t,e,n){return this.i.bindAttribLocation(t,e,n)},enableVertexAttribArray(t){return this.m(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!0,this.i.enableVertexAttribArray(t)},disableVertexAttribArray(t){return this.m(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!1,this.i.disableVertexAttribArray(t)},getActiveAttrib(t,e){return this.i.getActiveAttrib(t,e)},getActiveUniform(t,e){return this.i.getActiveUniform(t,e)},getAttribLocation(t,e){return this.i.getAttribLocation(t,e)},getUniformLocation(t,e){return this.i.getUniformLocation(t,e)},getVertexAttrib(t,e){return this.m(),this.i.getVertexAttrib(t,e)},getVertexAttribOffset(t,e){return this.m(),this.i.getVertexAttribOffset(t,e)},uniformBlockBinding(t,e,n){return this.m(),this.i.uniformBlockBinding(t,e,n)},L(t,...e){const n=this.states.program;if(!n)return!1;let r=t.fid;void 0===r&&(r=t.fid=n.fid++);const i=n.cachedUniforms[r];return!!function(t,e){if(!t)return!1;const n=e.length;for(let r=0;r<n;r++)if(t[r]&&void 0!==t[r].length){const n=t[r].length;for(let i=0;i<n;i++)if(t[r][i]!==e[r][i])return!1}else if(t[r]!==e[r])return!1;return!0}(i,e)||(n.cachedUniforms[r]=function(t,e){t=t||new Array(e.length);const n=e.length;for(let r=0;r<n;r++)t[r]=void 0!==e[r].length?FT(t[r]||[],e[r]):e[r];return t}(i,e),!1)},uniformMatrix2fv(t,e,n){this.L(t,e,n)||(this.m(),this.i.uniformMatrix2fv(t,e,n))},uniformMatrix3fv(t,e,n){this.L(t,e,n)||(this.m(),this.i.uniformMatrix3fv(t,e,n))},uniformMatrix4fv(t,e,n){n=this.B(n),this.L(t,e,n)||this.i.uniformMatrix4fv(t,e,n)},B:t=>t?(NT[0]=isNaN(t[0])?-1e30:t[0],NT[1]=isNaN(t[1])?-1e30:t[1],NT[2]=isNaN(t[2])?-1e30:t[2],NT[3]=isNaN(t[3])?-1e30:t[3],NT[4]=isNaN(t[4])?-1e30:t[4],NT[5]=isNaN(t[5])?-1e30:t[5],NT[6]=isNaN(t[6])?-1e30:t[6],NT[7]=isNaN(t[7])?-1e30:t[7],NT[8]=isNaN(t[8])?-1e30:t[8],NT[9]=isNaN(t[9])?-1e30:t[9],NT[10]=isNaN(t[10])?-1e30:t[10],NT[11]=isNaN(t[11])?-1e30:t[11],NT[12]=isNaN(t[12])?-1e30:t[12],NT[13]=isNaN(t[13])?-1e30:t[13],NT[14]=isNaN(t[14])?-1e30:t[14],NT[15]=isNaN(t[15])?-1e30:t[15],NT):t,uniform1f(t,e){return this.m(),this.i.uniform1f(t,e)},uniform1i(t,e){return this.m(),this.i.uniform1i(t,e)},uniform2f(t,e,n){return this.m(),this.i.uniform2f(t,e,n)},uniform2i(t,e,n){return this.m(),this.i.uniform2i(t,e,n)},uniform3f(t,e,n,r){return this.m(),this.i.uniform3f(t,e,n,r)},uniform3i(t,e,n,r){return this.m(),this.i.uniform3i(t,e,n,r)},uniform4f(t,e,n,r,i){return this.m(),this.i.uniform4f(t,e,n,r,i)},uniform4i(t,e,n,r,i){return this.m(),this.i.uniform4i(t,e,n,r,i)},uniform1ui(t,e){return this.m(),this.i.uniform1ui(t,e)},uniform2ui(t,e,n){return this.m(),this.i.uniform2ui(t,e,n)},uniform3ui(t,e,n,r){return this.m(),this.i.uniform3ui(t,e,n,r)},uniform4ui(t,e,n,r,i){return this.m(),this.i.uniform4ui(t,e,n,r,i)},uniform1fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1fv(t,e,n,r):void 0!==n?this.i.uniform1fv(t,e,n):this.i.uniform1fv(t,e)},uniform2fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2fv(t,e,n,r):void 0!==n?this.i.uniform2fv(t,e,n):this.i.uniform2fv(t,e)},uniform3fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3fv(t,e,n,r):void 0!==n?this.i.uniform3fv(t,e,n):this.i.uniform3fv(t,e)},uniform4fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4fv(t,e,n,r):void 0!==n?this.i.uniform4fv(t,e,n):this.i.uniform4fv(t,e)},uniform1iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1iv(t,e,n,r):void 0!==n?this.i.uniform1iv(t,e,n):this.i.uniform1iv(t,e)},uniform2iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2iv(t,e,n,r):void 0!==n?this.i.uniform2iv(t,e,n):this.i.uniform2iv(t,e)},uniform3iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3iv(t,e,n,r):void 0!==n?this.i.uniform3iv(t,e,n):this.i.uniform3iv(t,e)},uniform4iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4iv(t,e,n,r):void 0!==n?this.i.uniform4iv(t,e,n):this.i.uniform4iv(t,e)},uniform1uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1uiv(t,e,n,r):void 0!==n?this.i.uniform1uiv(t,e,n):this.i.uniform1uiv(t,e)},uniform2uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2uiv(t,e,n,r):void 0!==n?this.i.uniform2uiv(t,e,n):this.i.uniform2uiv(t,e)},uniform3uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3uiv(t,e,n,r):void 0!==n?this.i.uniform3uiv(t,e,n):this.i.uniform3uiv(t,e)},uniform4uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4uiv(t,e,n,r):void 0!==n?this.i.uniform4uiv(t,e,n):this.i.uniform4uiv(t,e)},vertexAttrib1f(t,e){return this.m(),this.i.vertexAttrib1f(t,e)},vertexAttrib2f(t,e,n){return this.m(),this.i.vertexAttrib2f(t,e,n)},vertexAttrib3f(t,e,n,r){return this.m(),this.i.vertexAttrib3f(t,e,n,r)},vertexAttrib4f(t,e,n,r,i){return this.m(),this.i.vertexAttrib4f(t,e,n,r,i)},vertexAttrib1fv(t,e){return this.m(),this.i.vertexAttrib1fv(t,e)},vertexAttrib2fv(t,e){return this.m(),this.i.vertexAttrib2fv(t,e)},vertexAttrib3fv(t,e){return this.m(),this.i.vertexAttrib3fv(t,e)},vertexAttrib4fv(t,e){return this.m(),this.i.vertexAttrib4fv(t,e)},vertexAttribI4i(t,e,n,r,i){return this.m(),this.i.vertexAttribI4i(t,e,n,r,i)},vertexAttribI4ui(t,e,n,r,i){return this.m(),this.i.vertexAttribI4ui(t,e,n,r,i)},vertexAttribI4iv(t,e){return this.m(),this.i.vertexAttribI4iv(t,e)},vertexAttribI4uiv(t,e){return this.m(),this.i.vertexAttribI4uiv(t,e)}}),IT(DT.prototype,{createVertexArray(){return this.t?this.i.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(t){const e=this.states;return e.vao===t&&(e.vao=null),this.t?this.i.deleteVertexArray(t):this.vaoOES.deleteVertexArrayOES(t)},isVertexArray(t){return this.t?this.i.isVertexArray(t):this.vaoOES.isVertexArrayOES(t)}}),IT(DT.prototype,{drawArraysInstanced(t,e,n,r){return this.m(),this.g(),this.t?this.i.drawArraysInstanced(t,e,n,r):this.angleOES.drawArraysInstancedANGLE(t,e,n,r)},drawElementsInstanced(t,e,n,r,i){return this.m(),this.g(),this.t?this.i.drawElementsInstanced(t,e,n,r,i):this.angleOES.drawElementsInstancedANGLE(t,e,n,r,i)}});var zT="undefined"!=typeof Float32Array?Float32Array:Array;function BT(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],d=e[10],p=e[11],g=e[12],m=e[13],A=e[14],y=e[15],v=n[0],x=n[1],_=n[2],b=n[3];return t[0]=v*r+x*a+_*c+b*g,t[1]=v*i+x*l+_*f+b*m,t[2]=v*o+x*h+_*d+b*A,t[3]=v*s+x*u+_*p+b*y,v=n[4],x=n[5],_=n[6],b=n[7],t[4]=v*r+x*a+_*c+b*g,t[5]=v*i+x*l+_*f+b*m,t[6]=v*o+x*h+_*d+b*A,t[7]=v*s+x*u+_*p+b*y,v=n[8],x=n[9],_=n[10],b=n[11],t[8]=v*r+x*a+_*c+b*g,t[9]=v*i+x*l+_*f+b*m,t[10]=v*o+x*h+_*d+b*A,t[11]=v*s+x*u+_*p+b*y,v=n[12],x=n[13],_=n[14],b=n[15],t[12]=v*r+x*a+_*c+b*g,t[13]=v*i+x*l+_*f+b*m,t[14]=v*o+x*h+_*d+b*A,t[15]=v*s+x*u+_*p+b*y,t}function HT(){var t=new zT(3);return zT!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function jT(t,e,n){var r=new zT(3);return r[0]=t,r[1]=e,r[2]=n,r}function UT(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function VT(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function GT(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function WT(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function qT(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function XT(t,e,n){var r=e[0],i=e[1],o=e[2],s=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*s,t[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*s,t[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*s,t[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*s,t}function ZT(){var t=new zT(4);return zT!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),HT(),function(){var t;t=new zT(4),zT!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var YT,JT=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};HT(),jT(1,0,0),jT(0,1,0),ZT(),ZT(),YT=new zT(9),zT!=Float32Array&&(YT[1]=0,YT[2]=0,YT[3]=0,YT[5]=0,YT[6]=0,YT[7]=0),YT[0]=1,YT[4]=1,YT[8]=1;let QT=0;function KT(t){return null==t}function $T(t){return!KT(t)}function tM(t){return!KT(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function eM(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function nM(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function rM(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function iM(t){const e=(i=t.substring(t.indexOf(",")+1),"undefined"!=typeof self?self.atob(i):window.atob(i)),n=e.length,r=new Uint8Array(n);var i;for(let o=0;o<n;o++)r[o]=e.charCodeAt(o);return r.buffer}const oM=[],sM=[],aM=[],lM=[0,0,0],hM=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),uM=[1,1,1];function cM(t,e,n,r,i,o,s){const a=nM(s),l=a.BYTES_PER_ELEMENT;if((0===i||i===r*l)&&o%l==0){const i=new a(e,o,n*r);return t.set(i),t}0===i&&(i=r*l);const h=new Uint8Array(r*l);for(let u=0;u<n;u++){let n=null;const s=new Uint8Array(e,i*u+o,r*l);h.set(s),n=new a(h.buffer,0,r);for(let e=0;e<r;e++)t[u*r+e]=n[e]}return t}const fM="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function dM(t,e,n){const r=new Uint8Array(t,e,n);return fM.decode(r)}const pM={get:function(t,e={},n){e||(e={});const r=new AbortController,i=r.signal,o=eM({},e);o.signal=i,o.method||(o.method="GET"),o.referrerPolicy=o.referrerPolicy||"origin","undefined"==typeof window||o.referrer||(o.referrer=window.location.href),n&&(t=n(t));const s=fetch(t,o).then((t=>{const n=this._parseResponse(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return s.xhr=r,s},_parseResponse:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",pM.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?pM.jsonp(t):((e=e||{}).responseType="json",pM.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+QT++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)}))}};let gM=class{constructor(t,e,n,r,i){this._requestImage=t,this.decoders=e,this._supportedFormats=n,this.images={},this._imgRequests={},this._fetchOptions=r||{},this._urlModifier=i}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}if(this._imgRequests[t.id])return this._imgRequests[t.id].then((()=>{const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}));if(rM(t.uri)){const r=this.buffers[t.id]=iM(t.uri),i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}let r;const i=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||i?t.uri:this.rootPath+"/"+t.uri,this._imgRequests[t.id]=pM.getArrayBuffer(r,this._fetchOptions,this._urlModifier).then((r=>{const i=this.buffers[t.id]=r.data,o=this._createDataView(e,i);return this.getImageByBuffer(o,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this._supportedFormats}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this._getImageInfo(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this._imgRequests[t.id]?this._imgRequests[t.id].then((()=>this.images[t.id])):this._imgRequests[t.id]=this._getImageInfo(t.id,e)}_getImageInfo(t,e){return new Promise(((n,r)=>{let i=e;this._urlModifier&&(i=this._urlModifier(e)),this._requestImage(i,this._fetchOptions,((i,o)=>{i?r(i):(URL.revokeObjectURL(e),this.images[t]=o,n(this.images[t]))}))}))}};const mM=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],AM=[];let yM=class{constructor(t,e,n,r,i){this.rootPath=t,this.gltf=e,this._enableInterleave=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this._compareAccessor(),this._fetchOptions=r,this._urlModifier=i}_requestData(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this._toBufferData(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const i=n.bufferViews[r.bufferView];return this._requestBufferOfBufferView(i).then((n=>{const{buffer:i,byteOffset:o}=n;return this.accessors[r.id]=this._toBufferData(t,e,i,o)}))}_requestBufferOfBufferView(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(rM(e.uri)){const t=this.buffers[e.id]=iM(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=pM.getArrayBuffer(t,this._fetchOptions,!n&&this._urlModifier).then((r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_toBufferData(t,e,n,r=0){const i=this.gltf,o=i.accessors[e],s=void 0!==o.bufferView?i.bufferViews[o.bufferView]:{},a=(s.byteOffset||0)+r,l=this._getTypeItemSize(o.type),h=nM(o.componentType),u=s.byteStride||0,c={array:void 0,name:t,accessorName:e,byteLength:o.count*l*h.BYTES_PER_ELEMENT,componentType:o.componentType,count:o.count,type:o.type,itemSize:l,max:o.max,min:o.min,extensions:o.extensions};if(o.min&&(c.min=o.min),o.max&&(c.max=o.max),n)if(this._enableInterleave)c.byteStride=u,c.byteOffset=a+(o.byteOffset||0),!u||u===l*h.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(c.array=this._typedArray(n,o.count,l,a+(o.byteOffset||0),h),c.array.buffer.byteLength===c.byteLength&&(c.byteOffset=0)):c.array=new Uint8Array(n,a,s.byteLength);else if(o.interleaved){c.byteStride=0,c.byteOffset=0;const t=new h(o.count*l);if(c.array=cM(t,n,o.count,l,u,a+(o.byteOffset||0),o.componentType),c.extensions&&c.extensions.WEB3D_quantized_attributes&&l>2){const t=new Float32Array(c.array.length),{decodeMatrix:e}=c.extensions.WEB3D_quantized_attributes;for(let n=0;n<c.array.length;n+=l){AM[0]=c.array[n],AM[1]=c.array[n+1],AM[2]=c.array[n+2],AM[3]=1;const r=XT(AM,AM,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}c.componentType=5126,c.array=t}}else c.byteStride=0,c.array=this._typedArray(n,o.count,l,a+(o.byteOffset||0),h),c.byteOffset=c.array.byteOffset;else{c.array=new h(o.count);const t=c.min||c.max;t&&(c.array[0]=t[0],c.array[1]=t[1],c.array[2]=t[2])}return c}_compareAccessor(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}_typedArray(t,e,n,r,i){return r%i.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*i.BYTES_PER_ELEMENT),r=0),new i(t,r,n*e)}_getTypeItemSize(t){const e=mM.indexOf(t);return mM[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this._requestBufferOfBufferView(e).then((r=>{const{buffer:i,byteOffset:o}=r,s=dM(i,o+(e.byteOffset||0),n);return t.content=s,t}))}if(t.uri){if(rM(t.uri)){const e=iM(t.uri),n=dM(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return pM.get(e,this._fetchOptions,this._urlModifier).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}},vM=class extends gM{constructor(t,e,n,r,i,o,s,a){super(r,i,o,s,a),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new yM(t,e,n,s,a)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const i in n)t(i,n[i],r++)}createNode(t){const e={};if($T(t.name)&&(e.name=t.name),$T(t.children)&&(e.children=t.children),$T(t.jointName)&&(e.jointName=t.jointName),$T(t.matrix)&&(e.matrix=t.matrix),$T(t.rotation)&&(e.rotation=t.rotation),$T(t.scale)&&(e.scale=t.scale),$T(t.translation)&&(e.translation=t.translation),$T(t.extras)&&(e.extras=t.extras),$T(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(oM,e.translation||lM),r=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n+n,a=r+r,l=i+i,h=n*s,u=r*s,c=r*a,f=i*s,d=i*a,p=i*l,g=o*s,m=o*a,A=o*l;return t[0]=1-c-p,t[1]=u+A,t[2]=f-m,t[3]=0,t[4]=u-A,t[5]=1-h-p,t[6]=d+g,t[7]=0,t[8]=f+m,t[9]=d-g,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(sM,e.rotation||hM),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(aM,e.scale||uM);return BT(i,r,i),BT(t,n,i)}return(n=t)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n;var n}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}_loadMaterials(t){const e={};for(const n in t){const r=t[n];let i,o;r.instanceTechnique&&r.instanceTechnique.values?(i=r.instanceTechnique,o=i.values.diffuse):(i=r,o=i.values.tex||i.values.diffuseTex||i.values.diffuse);const s={baseColorTexture:{index:o}};r.name&&(s.name=r.name),r.extensions&&(s.extensions=r.extensions),r.extras&&(s.extras=r.extras),e[n]=s}return e}_loadImage(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,i=n.byteLength,o=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,i);return this.getImageByBuffer(o,t)}return this.requestExternalImage(t)}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then((t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const i=this.gltf.textures[r];if(!i)return null;const o=this.gltf.samplers[i.sampler];return{format:i.format||6408,internalFormat:i.internalFormat||6408,type:i.type||5121,sampler:o,source:this.gltf.images[i.source]}}getMaterial(){return null}getAnimations(){return null}};const xM=9729;let _M=class extends gM{constructor(t,e,n,r,i,o,s,a){super(r,i,o,s,a),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new yM(t,e,n,s,a)}iterate(t,e){const n=this.gltf[e];if(n)for(let r=0;r<n.length;r++)t(r,n[r],r)}createNode(t){const e={};return eM(e,t),!$T(t.weights)&&this.gltf.meshes&&$T(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!$T(n))return null;const r=this.gltf.images[n];return this._loadImage(r).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};eM(n,e);const i=$T(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(i&&(n.sampler=i,n.sampler.magFilter=i.magFilter||xM,n.sampler.minFilter=i.minFilter||9987,n.sampler.wrapS=i.wrapS||10497,n.sampler.wrapT=i.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==xM&&9728!==n.sampler.minFilter){const t=n.sampler.minFilter;n.sampler.minFilter=9984===t||9986===t?9728:xM}return t.format&&(n.format=t.format),n}))}_loadImage(t){if(!$T(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this._requestFromGlbBuffer(e,t)}return null}_requestFromGlbBuffer(t,e){const n=this._createDataView(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}_createDataView(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,i=t.byteLength;return new Uint8Array(e,r,i)}_transformArrayBufferToBase64(t,e){const n=new Array(t.byteLength);for(let i=0;i<t.byteLength;i++)n[i]=String.fromCharCode(t[i]);n.join("");var r;return"data:"+(e=e||"image/png")+";base64,"+(r=unescape(encodeURIComponent(n)),"undefined"!=typeof self?self.btoa(r):window.btoa(r))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)($T(t[n].input)||$T(t[n].output))&&(e.push(this.accessor._requestData("input",t[n].input)),e.push(this.accessor._requestData("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}};const bM="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let wM=class t{static read(e,n=0,r=0){r||(r=e.byteLength);const i=new DataView(e,n,r),o=i.getUint32(4,!0);if(1===o)return t.readV1(i,n);if(2===o)return t.readV2(e,n);throw new Error("Unsupported glb version : "+o)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const i=TM(t.buffer,20+e,r);return{json:JSON.parse(i),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,i;const o=new DataView(t,e+12);let s=0;for(;s+8<o.byteLength;){const a=o.getUint32(s,!0);s+=4;const l=o.getUint32(s,!0);if(s+=4,1313821514===l)n=TM(t,e+12+s,a);else if(5130562===l){i=e+12+s,r=a;break}s+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:i,buffer:t,byteLength:r}}}};function TM(t,e,n){if(bM){const r=new Uint8Array(t,e,n);return bM.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=MM[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}(new Uint8Array(t,e,n))}const MM=[1,1,1,1,2,2,3,0],CM=[0,0,0],SM=[0,0,0,1],IM=[1,1,1],PM={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},EM={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},OM={_getTRSW(t,e,n,r,i,o,s,a){const l=$T(t)?e.animations:[e.animations[0]],h={};for(let u=0;u<l.length;u++){const e=l[u],c=e.name||u;if($T(t)&&c!==t)continue;const f=e.channelsMap[n];if(f)for(let t=0;t<f.length;t++){const n=f[t];"translation"===n.target.path?(this._getAnimateData(i,e.samplers[n.sampler],r,1),h.translation=UT(CM,i)):"rotation"===n.target.path?(this._getQuaternion(o,e.samplers[n.sampler],r,1),h.rotation=JT(SM,o)):"scale"===n.target.path?(this._getAnimateData(s,e.samplers[n.sampler],r,1),h.scale=UT(IM,s)):"weights"===n.target.path&&a&&(this._getAnimateData(a,e.samplers[n.sampler],r,a.length),h.weights=a)}}return h},_getAnimateData(t,e,n,r){switch(e.interpolation){case"LINEAR":{const i=this._getPreNext(EM,e,n,1*r);i&&(t=function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t}(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION));break}case"STEP":{const i=this._getPreNext(EM,e,n,1*r);i&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this._getPreNext(EM,e,n,3*r);i&&(t=this._getCubicSpline(t,i,e.input.array,3*r));break}}return t},_getQuaternion(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this._getPreNext(EM,e,n,1);r&&function(t,e,n,r){var i,o,s,a,l,h=e[0],u=e[1],c=e[2],f=e[3],d=n[0],p=n[1],g=n[2],m=n[3];(o=h*d+u*p+c*g+f*m)<0&&(o=-o,d=-d,p=-p,g=-g,m=-m),1-o>1e-6?(i=Math.acos(o),s=Math.sin(i),a=Math.sin((1-r)*i)/s,l=Math.sin(r*i)/s):(a=1-r,l=r),t[0]=a*h+l*d,t[1]=a*u+l*p,t[2]=a*c+l*g,t[3]=a*f+l*m}(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this._getPreNext(EM,e,n,1);r&&(t=qT(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this._getPreNext(EM,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this._getCubicSpline(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},_search(t,e){const n=t.length;let r,i,o,s=0,a=n-1,l=Math.floor((s+a)/2);for(;s<=n-1&&a>=0;){if(s===a)return null;if(t[l]<=e&&e<=t[l+1]){const n=t[l];return r=l,i=l+1,o=(e-n)/(t[l+1]-n),{preIndx:r,nextIndex:i,interpolation:o}}e<t[l]?(a=l,l=Math.floor((s+a)/2)):t[l+1]<e&&(s=l,l=Math.floor((s+a)/2))}return null},_getPreNext(t,e,n,r){const i=e.input.array,o=e.output.array,s=e.output.itemSize;(n<i[0]||n>i[i.length-1])&&(n=Math.max(i[0],Math.min(i[i.length-1],n))),n===i[i.length-1]&&(n=i[0]);const a=this._search(i,n);if(!a||!a.nextIndex)return null;const{preIndx:l,nextIndex:h,interpolation:u}=a;t.PREINDEX=l,t.NEXTINDEX=h,t.INTERPOLATION=u;const c=s*r;return t.PREVIOUS=o.subarray(t.PREINDEX*c,(t.PREINDEX+1)*c),t.NEXT=o.subarray(t.NEXTINDEX*c,(t.NEXTINDEX+1)*c),t},_getCubicSpline(t,e,n,r){const i=e.INTERPOLATION,o=n[e.PREINDEX],s=n[e.NEXTINDEX];for(let a=0;a<3;a++){const n=e.PREVIOUS[r+a],l=(s-o)*e.PREVIOUS[2*r+a],h=e.NEXT[3+a],u=(s-o)*e.NEXT[a],c=(2*Math.pow(i,3)-3*Math.pow(i,2)+1)*n+(Math.pow(i,3)-2*Math.pow(i,2)+i)*l+(2*-Math.pow(i,3)+3*Math.pow(i,2))*h+(Math.pow(i,3)-Math.pow(i,2))*u;t[a]=c}return t},getAnimationClip(t,e,n,r){const i=t.nodes[e]&&t.nodes[e].weights;return VT(CM,...PM.TRANSLATION),qT(SM,...PM.ROTATION),VT(IM,...PM.SCALE),this._getTRSW(r,t,e,n,CM,SM,IM,i)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let r=-1/0,i=1/0;const o=e.channels;for(let t=0;t<o.length;t++){const n=o[t],s=e.samplers[n.sampler].input.array;s[s.length-1]>r&&(r=s[s.length-1]),s[0]<i&&(i=s[0])}const s=e.name||n;t.timeSpan[s]={max:r,min:i}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?$T(e)?n[e]:n[Object.keys(n)[0]]:null}};let RM=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(I6){}t&&"undefined"!=typeof createImageBitmap&&(RM=!0)}const kM="undefined"==typeof document?null:document.createElement("canvas");function LM(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!kM)return void n(new Error("There is no canvas to draw image!"));kM.width=r.width,kM.height=r.height;const t=kM.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),i={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,i)},r.onerror=function(t){n(t)},r.src=t}const DM=[],NM=[],FM=30;let zM,BM;function HM(t,e,n){zM||(zM=new OffscreenCanvas(2,2),BM=zM.getContext("2d",{willReadFrequently:!0}));let r=null;if(tM(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),DM.push([t,e,n,this]),jM();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(UM.bind(this)).then((t=>{n(null,t)})).catch((t=>{console.warn(t),n(t)}))}}function jM(){if(!DM.length||NM.length>FM)return;const t=DM.shift(),[e,n,r,i]=t;NM.push(t),fetch(e,n).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then(UM.bind(i)).then((e=>{r.call(i,null,e);const n=NM.indexOf(t);NM.splice(n,1),jM()})).catch((e=>{console.warn(e),r.call(i,e);const n=NM.indexOf(t);NM.splice(n,1),jM()}))}function UM(t){let{width:e,height:n}=t;VM(e)||(e=GM(e)),VM(n)||(n=GM(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),zM.width=e,zM.height=n,BM.drawImage(t,0,0,e,n),t.close();const i=BM.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(i.data)}}function VM(t){return!(t&t-1)&&0!==t}function GM(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}var WM=Object.freeze({__proto__:null,Ajax:pM,GLTFLoader:class{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this._fetchOptions=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=wM.read(e.buffer,e.byteOffset,e.byteLength);this._init(t,n,r)}else this._init(t,e);this._accessor=new yM(this.rootPath,this.gltf,this.glbBuffer,this._fetchOptions,this.options.urlModifier),this._checkExtensions()}_checkExtensions(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}_loadExtensions(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this._accessor.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this._loadScene(t),n=this._loadAnimations(),r=this._loadTextures(),i=this._loadExtensions();return Promise.all([e,n,r,i]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let n=0;n<e.length;n++){const t=e[n];t.channelsMap={};for(let e=0;e<t.channels.length;e++){const n=t.channels[e];t.channelsMap[n.target.node]||(t.channelsMap[n.target.node]=[]),t.channelsMap[n.target.node].push(n)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let r=0;r<e.length;r++)e[r].uri&&e[r].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[r].uri});for(let r=0;r<n.length;r++)n[r].uri&&n[r].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[r].uri})}return t}static getAnimationClip(t,e,n,r){return OM.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return OM.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return nM(t)}static readInterleavedArray(t,e,n,r,i,o,s){return cM(t,e,n,r,i,o,s)}_init(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=RM?HM.bind(this):this.options.requestImage||LM,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new _M(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new vM(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}_parseNodes(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||tM(t.children[0])))return t;const r=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this._parseNodes(n,e)}));t.children=r}var n;return t}_loadScene(t){return this._loadNodes(t).then((t=>{const e=this.scenes=[];let n;for(const i in t)t[i]=this._parseNodes(t[i],t),t[i].nodeIndex=Number(i)?Number(i):i;this.adapter.iterate(((r,i,o)=>{const s={};i.name&&(s.name=i.name),i.nodes&&(s.nodes=i.nodes.map((e=>t[e]))),this.gltf.scene===r&&(n=o),e.push(s)}),"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter._loadMaterials(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r}))}_loadNodes(t){return this._loadMeshes(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r}),"nodes"),t}))}_loadSkins(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,r)=>{t.push(this._loadSkin(n).then((t=>{t.index=r,this.skins.push(t)})))}),"skins"),t}_loadSkin(t){const e=t.inverseBindMatrices;return this.adapter.accessor._requestData("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}_loadAnimations(){const t=this.gltf.animations;return $T(t)?this.adapter.getAnimations(t):null}_loadMeshes(t){this.meshes={};let e=[];return this.adapter.iterate(((n,r,i)=>{e.push(this._loadMesh(r,t).then((t=>{t.index=i,this.meshes[n]=t})))}),"meshes"),e=e.concat(this._loadSkins()),Promise.all(e)}_loadMesh(t,e){const n=t.primitives.map((t=>this._loadPrimitive(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return eM(n,t),n.primitives=e,n}))}_loadTextures(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter._getTexture(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image.array;if(n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e}))}_loadPrimitive(t,e){let n;const r=[],i=t.extensions;if($T(t.targets))for(let o=0;o<t.targets.length;o++){const e=t.targets[o];for(const t in e){const n=this.adapter.accessor._requestData(`morphTargets_${t}_${o}`,e[t]);n&&r.push(n)}}if(i&&i.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:o,attributes:s}=i.KHR_draco_mesh_compression,a=this.gltf.bufferViews[o],l=this._accessor._requestBufferOfBufferView(a).then((n=>{const{buffer:r,byteOffset:i}=n;let{byteOffset:o}=a;const l=a.byteLength;o||(o=0);const h=new DataView(r,i+o,l),u={attributes:s,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(h,u).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));r.push(l),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._requestData(t,e[t]);n&&r.push(n)}if($T(t.indices)){const e=this.adapter.accessor._requestData("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then((e=>{if(i&&i.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const o={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:i}=e,o=i.length/r;for(let e=0;e<o;e++)for(let o=0;o<r;o++){const s=e*r+o;i[s]<t[o]&&(t[o]=i[s]),i[s]>n[o]&&(n[o]=i[s])}if(e.quantization){const r=e.quantization,i=r.range/(1<<r.quantizationBits),o=r.minValues;WT(t,t,i),GT(t,t,o),WT(n,n,i),GT(n,n,o)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(o.indices=n),r&&(o.morphTargets=r),o.mode=$T(t.mode)?t.mode:4,$T(t.extras)&&(o.extras=t.extras),o}))}}});function qM(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var XM={exports:{}},ZM={exports:{}},YM=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},JM=Array.prototype.concat,QM=Array.prototype.slice,KM=ZM.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];YM(i)?e=JM.call(e,QM.call(i)):e.push(i)}return e};KM.wrap=function(t){return function(){return t(KM(arguments))}};var $M=ZM.exports,tC={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},eC=$M,nC=Object.hasOwnProperty,rC=Object.create(null);for(var iC in tC)nC.call(tC,iC)&&(rC[tC[iC]]=iC);var oC=XM.exports={to:{},get:{}};function sC(t,e,n){return Math.min(Math.max(e,t),n)}function aC(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}oC.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=oC.get.hsl(t),n="hsl";break;case"hwb":e=oC.get.hwb(t),n="hwb";break;default:e=oC.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},oC.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var o=2*n;i[n]=parseInt(e.slice(o,o+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:nC.call(tC,e[1])?((i=tC[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=sC(i[n],0,255);return i[3]=sC(i[3],0,1),i},oC.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,sC(parseFloat(e[2]),0,100),sC(parseFloat(e[3]),0,100),sC(isNaN(n)?1:n,0,1)]}return null},oC.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,sC(parseFloat(e[2]),0,100),sC(parseFloat(e[3]),0,100),sC(isNaN(n)?1:n,0,1)]}return null},oC.to.hex=function(){var t=eC(arguments);return"#"+aC(t[0])+aC(t[1])+aC(t[2])+(t[3]<1?aC(Math.round(255*t[3])):"")},oC.to.rgb=function(){var t=eC(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},oC.to.rgb.percent=function(){var t=eC(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},oC.to.hsl=function(){var t=eC(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},oC.to.hwb=function(){var t=eC(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},oC.to.keyword=function(t){return rC[t.slice(0,3)]};var lC=XM.exports,hC={exports:{}},uC={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},cC={};for(var fC in uC)uC.hasOwnProperty(fC)&&(cC[uC[fC]]=fC);var dC=hC.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var pC in dC)if(dC.hasOwnProperty(pC)){if(!("channels"in dC[pC]))throw new Error("missing channels property: "+pC);if(!("labels"in dC[pC]))throw new Error("missing channel labels property: "+pC);if(dC[pC].labels.length!==dC[pC].channels)throw new Error("channel and label counts mismatch: "+pC);var gC=dC[pC].channels,mC=dC[pC].labels;delete dC[pC].channels,delete dC[pC].labels,Object.defineProperty(dC[pC],"channels",{value:gC}),Object.defineProperty(dC[pC],"labels",{value:mC})}dC.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.min(r,i,o),a=Math.max(r,i,o),l=a-s;return a===s?e=0:r===a?e=(i-o)/l:i===a?e=2+(o-r)/l:o===a&&(e=4+(r-i)/l),(e=Math.min(60*e,360))<0&&(e+=360),n=(s+a)/2,[e,100*(a===s?0:n<=.5?l/(a+s):l/(2-a-s)),100*n]},dC.rgb.hsv=function(t){var e,n,r,i,o,s=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(s,a,l),u=h-Math.min(s,a,l),c=function(t){return(h-t)/6/u+.5};return 0===u?i=o=0:(o=u/h,e=c(s),n=c(a),r=c(l),s===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*o,100*h]},dC.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[dC.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},dC.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},dC.rgb.keyword=function(t){var e=cC[t];if(e)return e;var n,r,i,o=1/0;for(var s in uC)if(uC.hasOwnProperty(s)){var a=uC[s],l=(r=t,i=a,Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));l<o&&(o=l,n=s)}return n},dC.keyword.rgb=function(t){return uC[t]},dC.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},dC.rgb.lab=function(t){var e=dC.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},dC.hsl.rgb=function(t){var e,n,r,i,o,s=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return[o=255*l,o,o];e=2*l-(n=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(r=s+1/3*-(h-1))<0&&r++,r>1&&r--,o=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*o;return i},dC.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,o=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=o<=1?o:2-o,[e,100*(0===r?2*i/(o+i):2*n/(r+n)),100*((r+n)/2)]},dC.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,o=e-Math.floor(e),s=255*r*(1-n),a=255*r*(1-n*o),l=255*r*(1-n*(1-o));switch(r*=255,i){case 0:return[r,l,s];case 1:return[a,r,s];case 2:return[s,r,l];case 3:return[s,a,r];case 4:return[l,s,r];case 5:return[r,s,a]}},dC.hsv.hsl=function(t){var e,n,r,i=t[0],o=t[1]/100,s=t[2]/100,a=Math.max(s,.01);return r=(2-o)*s,n=o*a,[i,100*(n=(n/=(e=(2-o)*a)<=1?e:2-e)||0),100*(r/=2)]},dC.hwb.rgb=function(t){var e,n,r,i,o,s,a,l=t[0]/360,h=t[1]/100,u=t[2]/100,c=h+u;switch(c>1&&(h/=c,u/=c),r=6*l-(e=Math.floor(6*l)),1&e&&(r=1-r),i=h+r*((n=1-u)-h),e){default:case 6:case 0:o=n,s=i,a=h;break;case 1:o=i,s=n,a=h;break;case 2:o=h,s=n,a=i;break;case 3:o=h,s=i,a=n;break;case 4:o=i,s=h,a=n;break;case 5:o=n,s=h,a=i}return[255*o,255*s,255*a]},dC.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},dC.xyz.rgb=function(t){var e,n,r,i=t[0]/100,o=t[1]/100,s=t[2]/100;return n=-.9689*i+1.8758*o+.0415*s,r=.0557*i+-.204*o+1.057*s,e=(e=3.2406*i+-1.5372*o+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},dC.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},dC.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(r,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},dC.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},dC.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},dC.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:dC.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var o=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(o+=60),o},dC.hsv.ansi16=function(t){return dC.rgb.ansi16(dC.hsv.rgb(t),t[2])},dC.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},dC.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},dC.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},dC.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},dC.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},dC.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,o=Math.max(Math.max(n,r),i),s=Math.min(Math.min(n,r),i),a=o-s;return e=a<=0?0:o===n?(r-i)/a%6:o===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?s/(1-a):0)]},dC.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},dC.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},dC.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,o=[0,0,0],s=e%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return i=(1-n)*r,[255*(n*o[0]+i),255*(n*o[1]+i),255*(n*o[2]+i)]},dC.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},dC.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},dC.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},dC.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},dC.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},dC.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},dC.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},dC.gray.hsl=dC.gray.hsv=function(t){return[0,0,t[0]]},dC.gray.hwb=function(t){return[0,100,t[0]]},dC.gray.cmyk=function(t){return[0,0,0,t[0]]},dC.gray.lab=function(t){return[t[0],0,0]},dC.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},dC.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var AC=hC.exports,yC=AC;function vC(t){var e=function(){for(var t={},e=Object.keys(yC),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(yC[r]),o=i.length,s=0;s<o;s++){var a=i[s],l=e[a];-1===l.distance&&(l.distance=e[r].distance+1,l.parent=r,n.unshift(a))}return e}function xC(t,e){return function(n){return e(t(n))}}function _C(t,e){for(var n=[e[t].parent,t],r=yC[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=xC(yC[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var bC=AC,wC=function(t){for(var e=vC(t),n={},r=Object.keys(e),i=r.length,o=0;o<i;o++){var s=r[o];null!==e[s].parent&&(n[s]=_C(s,e))}return n},TC={};Object.keys(bC).forEach((function(t){TC[t]={},Object.defineProperty(TC[t],"channels",{value:bC[t].channels}),Object.defineProperty(TC[t],"labels",{value:bC[t].labels});var e=wC(t);Object.keys(e).forEach((function(n){var r=e[n];TC[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),TC[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var MC=lC,CC=TC,SC=[].slice,IC=["keyword","gray","hex"],PC={};Object.keys(CC).forEach((function(t){PC[SC.call(CC[t].labels).sort().join("")]=t}));var EC={};function OC(t,e){if(!(this instanceof OC))return new OC(t,e);if(e&&e in IC&&(e=null),e&&!(e in CC))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof OC)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=MC.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=CC[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=CC[this.model].channels;var o=SC.call(t,0,r);this.color=LC(o,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var s=Object.keys(t);"alpha"in t&&(s.splice(s.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=s.sort().join("");if(!(a in PC))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=PC[a];var l=CC[this.model].labels,h=[];for(n=0;n<l.length;n++)h.push(t[l[n]]);this.color=LC(h)}if(EC[this.model])for(r=CC[this.model].channels,n=0;n<r;n++){var u=EC[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function RC(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(EC[t]||(EC[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function kC(t){return function(e){return Math.max(0,Math.min(t,e))}}function LC(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}OC.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in MC.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return MC.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return MC.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=CC[this.model].channels,n=CC[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new OC(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new OC(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:RC("rgb",0,kC(255)),green:RC("rgb",1,kC(255)),blue:RC("rgb",2,kC(255)),hue:RC(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:RC("hsl",1,kC(100)),lightness:RC("hsl",2,kC(100)),saturationv:RC("hsv",1,kC(100)),value:RC("hsv",2,kC(100)),chroma:RC("hcg",1,kC(100)),gray:RC("hcg",2,kC(100)),white:RC("hwb",1,kC(100)),wblack:RC("hwb",2,kC(100)),cyan:RC("cmyk",0,kC(100)),magenta:RC("cmyk",1,kC(100)),yellow:RC("cmyk",2,kC(100)),black:RC("cmyk",3,kC(100)),x:RC("xyz",0,kC(100)),y:RC("xyz",1,kC(100)),z:RC("xyz",2,kC(100)),l:RC("lab",0,kC(100)),a:RC("lab",1),b:RC("lab",2),keyword:function(t){return arguments.length?new OC(t):CC[this.model].keyword(this.color)},hex:function(t){return arguments.length?new OC(t):MC.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return OC.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,o=2*i-1,s=n.alpha()-r.alpha(),a=((o*s==-1?o:(o+s)/(1+o*s))+1)/2,l=1-a;return OC.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(CC).forEach((function(t){if(-1===IC.indexOf(t)){var e=CC[t].channels;OC.prototype[t]=function(){if(this.model===t)return new OC(this);if(arguments.length)return new OC(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new OC((n=CC[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},OC[t]=function(n){return"number"==typeof n&&(n=LC(SC.call(arguments),e)),new OC(n,t)}}}));var DC=qM(OC);const NC="function"==typeof Object.assign,FC=[];function zC(t){if(NC)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function BC(t){return null==t}function HC(t){return"number"==typeof t&&!isNaN(t)}const jC=[];function UC(t,e){const n=e._get2DExtentAtRes(e.getGLRes()),r=n.getWidth(),i=n.getHeight(),o=t;im(o);const s=km(FC,e.cameraLookAt);return s[2]=0,lm(o,o,s),hm(o,o,Lm(jC,r,i,1)),o}function VC(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function GC(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}const WC={};function qC(t,e){if(!Array.isArray(e)){const t=e;e=WC[t]=WC[t]||DC(e).array()}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}function XC(t,e){if(Array.isArray(e))for(let n=0;n<e.length;n++)t[n]=255*e[n];else{const n=e;e=WC[n]=WC[n]||DC(e).array();for(let r=0;r<e.length;r++)t[r]=e[r]}return 3===t.length&&t.push(255),t}function ZC(t,e,r=0){if(!(t&&e instanceof n))return null;const i=t.coordinateToPointAtRes(e,t.getGLRes());return[i.x,i.y,r]}const YC=[0,0],JC=[0,0,0];let QC;class KC{static getUniformDeclares(){const t=[],e=[];return e.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(e,n){const r=n.shadow_lightProjViewMatrix,i=n.modelMatrix;return am(t,r,i)}}),e}constructor(t,e){this.renderer=new f_(t),this._esmShadowThreshold=.3,this._layer=e,this._init()}resize(){const t=this.canvas;t.width=this._layer.getRenderer().canvas.width,t.height=this._layer.getRenderer().canvas.height}_init(){const t=(this._layer._getSceneConfig()||{}).shadow||{},e=this._getShadowRes(),n=this.getDefines();this._shadowPass=new Tw(this.renderer,{width:e,height:e,blurOffset:t.blurOffset,defines:n}),this._shadowDisplayShader=new Mw(n),this._createGround()}_getShadowRes(){let t=2048;const e=((this._layer._getSceneConfig()||{}).shadow||{}).quality;return"medium"===e?t=1024:"low"===e&&(t=512),t}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(t,e,n,r,i,o,s,a,l,h){this._transformGround();const u=this._layer.getMap(),c=this._getShadowRes();let f,d;if(h||c!==this._shadowPass.width||this._shadowChanged(u,s,!!t)){c!==this._shadowPass.width&&this._shadowPass.resize(c,c),this._tempMat0=this._tempMat0||[],this._tempMat1=this._tempMat1||[];const r=am(this._tempMat0,e,n),i=Gm(this._tempMat1,o);QC||(QC=u.getContainerExtent());let a=u.height;u.getPitch()>62&&(a=u._getVisualHeight(62));const l=QC.set(0,u.height-a,u.width,u.height).convertTo((t=>u._containerPointToPointAtRes(t,u.getGLRes()))),h=l.toArray();t&&s.addMesh(this._ground);const p=h.map((t=>[t.x,t.y,0,1])),{lightProjViewMatrix:g,shadowMap:m,blurFBO:A}=this._shadowPass.render(s,{cameraProjViewMatrix:r,lightDir:i,farPlane:p,cameraLookAt:u.cameraLookAt});f=this._lightProjViewMatrix=g,d=this._shadowMap=m,this._blurFBO=A,this._renderedShadows=s.getMeshes().reduce(((t,e)=>(e.castShadow&&e.geometry&&(t[e.uuid]={v0:e.version,v1:e.geometry.version}),t)),{}),this._renderedView={count:s.getMeshes().length-+!!t,displayShadow:!!t},this._updated=!0}else f=this._lightProjViewMatrix,d=this._shadowMap,this._updated=!1;this._projMatrix=e,this._viewMatrix=n,BC(i)&&(i=1),t&&s.getMeshes().length&&this.displayShadow(r,i,a,l);return{shadow_lightProjViewMatrix:f,shadow_shadowMap:d,shadow_opacity:i,shadow_color:r||JC,esm_shadow_threshold:this._esmShadowThreshold}}displayShadow(t,e,n,r){const i=this._lightProjViewMatrix,o=this._ground,s=this._groundLightProjViewModelMatrix||[],a=this._layer.getRenderer().canvas,l=this._texSize=this._texSize||[];l[0]=a.width,l[1]=a.height,this.renderer.render(this._shadowDisplayShader,{halton:n||YC,globalTexSize:l,projMatrix:this._projMatrix,viewMatrix:this._viewMatrix,shadow_lightProjViewModelMatrix:am(s,i,o.localTransform),shadow_shadowMap:this._shadowMap,esm_shadow_threshold:this._esmShadowThreshold,shadow_opacity:e,color:t||JC},this._groundScene,r)}dispose(){this._shadowPass.dispose(),this._shadowDisplayShader.dispose(),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose()),delete this.renderer}isUpdated(){return!1!==this._updated}_shadowChanged(t,e,n){if(!this._renderedShadows)return!0;const r=this._renderedView;if(e.getMeshes().length!==r.count||n!==r.displayShadow)return!0;const i=e.getMeshes();for(let o=0;o<i.length;o++){const t=this._renderedShadows[i[o].uuid];if(i[o].castShadow&&(i[o].hasSkinAnimation()||!t||t.v0!==i[o].version||t.v1!==i[o].geometry.version))return!0}return!1}_createGround(){const t=new R_;t.generateBuffers(this.renderer.regl),this._ground=new h_(t),this._groundScene=new __([this._ground])}_transformGround(){const t=this._layer.getMap(),e=UC(this._ground.localTransform,t);this._ground.setLocalTransform(e)}}const $C=[0,0],tS=new n(0,0),eS=new n(0,0),nS=[],rS=[],iS=[];function oS(t,e,n,r){const i=t.getGLRes(),o=t.distanceToPointAtRes(e,e,i,n?tS:null,eS);return r?o.y:o.x}const{getIBLResOnCanvas:sS,logoutIBLResOnCanvas:aS,getPBRUniforms:lS,loginIBLResOnCanvas:hS}=xT.PBRUtils,uS=[0,0],cS=[1,1],fS=[],dS=[],pS=[],gS=[],mS=[];class AS{static getGroundTransform(t,e){return UC(t,e)}constructor(t,e){this._regl=t,this.renderer=new f_(t),this._layer=e,this._loader=new g_,this._bindOnMaterialComplete=(...t)=>this._onMaterialComplete.call(this,...t),this._init();const n=this.getMap().getRenderer().canvas;hS(n,t,this.getMap())}needToRedraw(){const t=this._getUVOffsetAnim();return t&&(t[0]||t[1])}getMap(){return this._layer&&this._layer.getMap()}getSymbol(){const t=this._layer.getGroundConfig();return t&&t.symbol}isEnable(){const t=this._layer.getGroundConfig();return t&&t.enable}paint(t){if(!this.isEnable())return!1;const e=this._getShader();if(this._isInSSRPhase(t)&&e===this._fillShader)return!1;const n=this._getGroundDefines(t);n&&this._ground.setDefines(n),this._ground.material!==this.material&&this._ground.setMaterial(this.material);const r=this._layer.getGroundConfig();(r&&r.symbol).ssr?this._ground.ssr=1:this._ground.ssr=0,this._transformGround();const i=this._getUniformValues(t);i.offsetFactor=t.offsetFactor,i.offsetUnits=t.offsetUnits;const o=t&&t.renderTarget&&t.renderTarget.fbo;return e===this._fillShader?(this.renderer.render(e,i,this._groundScene,o),this._layer.getRenderer().setCanvasUpdated(),!0):(e.filter=t.sceneFilter,this.renderer.render(e,i,this._groundScene,o),this._layer.getRenderer().setCanvasUpdated(),!0)}_isInSSRPhase(t){return!(!this._layer.getRenderer().isEnableSSR||!this._layer.getRenderer().isEnableSSR())&&!(!t||!t.ssr)}update(){const t=this._layer.getGroundConfig();if(!t)return;const e=t&&t.symbol,n=t.urlModifier;if(e){this._polygonFill=this._parseColor(e.polygonFill||[1,1,1,1]),this._polygonOpacity=void 0===e.polygonOpacity?1:e.polygonOpacity;const t=e.polygonPatternFile;if(t){if(!this._polygonPatternFile||this._polygonPatternFile._pattern_src!==t){const e=new Image;e.onload=()=>{this._polygonPatternFile&&this._polygonPatternFile.destroy(),this._polygonPatternFile=this._createPatternTexture(e),this._polygonPatternFile._pattern_src=t,this.setToRedraw()},e.src=n&&n(t)||t}}else this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile)}else this._polygonFill=[1,1,1,1],this._polygonOpacity=1,this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile);this._updateMaterial()}setToRedraw(){const t=this._layer.getRenderer();t&&t.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this._ground&&(this._ground.geometry.dispose(),this._ground.material&&this._ground.material.dispose(),this._ground.dispose(),delete this._ground),this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile),this._fillShader&&(this._fillShader.dispose(),delete this._fillShader),this._standardShader&&(this._standardShader.dispose(),delete this._standardShader),this._disposeIblTextures()}_getShader(){const t=this._layer.getGroundConfig();if(!t||!t.renderPlugin)return this._fillShader;const e=t.renderPlugin.type;if("lit"===e)return this._standardShader;if("fill"===e)return this._fillShader;throw new Error("unsupported render plugin of "+e+" for layer ground")}_getUniformValues(t){const e=this._getCommonUniforms(t);e.polygonFill=this._polygonFill,e.polygonOpacity=this._polygonOpacity;return this._getShader()===this._fillShader&&this._polygonPatternFile&&(e.polygonPatternFile=this._polygonPatternFile),e}_getCommonUniforms(t){let e;if("lit"===this._layer.getGroundConfig().renderPlugin.type){const n=this.getMap().getRenderer().canvas,{iblTexes:r,dfgLUT:i}=sS(n);e=lS(this.getMap(),r,i,t&&t.ssr,t&&t.jitter)}else{e={projViewMatrix:this.getMap().projViewMatrix}}return this._setIncludeUniformValues(e,t),e}_setIncludeUniformValues(t,e){const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&zC(t,e[r].renderUniforms)}_disposeIblTextures(){const t=this.getMap().getRenderer().canvas;aS(t,this.getMap())}_init(){const t=this._getExtraCommandProps(),e=KC.getUniformDeclares(),n=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(n,e.projViewMatrix,e.modelMatrix)}}),this._fillShader=new U_({vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\n#ifdef HAS_PATTERN\n    attribute vec2 aTexCoord;\n    uniform vec2 uvScale;\n    uniform vec2 uvOffset;\n    varying vec2 vTexCoord;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main () {\n    #ifdef HAS_PATTERN\n        vTexCoord = aTexCoord * uvScale + uvOffset;\n    #endif\n    vec3 position = vec3(aPosition);\n    gl_Position = projViewModelMatrix * vec4(position, 1.0);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(vec4(position, 1.0));\n    #endif\n}",frag:"precision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n    uniform sampler2D polygonPatternFile;\n    varying vec2 vTexCoord;\n#endif\nuniform vec4 polygonFill;\nuniform float polygonOpacity;\nvoid main() {\n    #ifdef HAS_PATTERN\n        vec4 color = texture2D(polygonPatternFile, vTexCoord);\n    #else\n        vec4 color = polygonFill;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, shadowCoeff);\n    #endif\n}",uniforms:e,extraCommandProps:t});const r=KC.getUniformDeclares();r.push(...rb.getUniformDeclares()),this._standardShader=new xT.StandardShader({uniforms:r,extraCommandProps:t}),this._createGround(),this.update()}_getExtraCommandProps(){const t=[0,1],e=this._layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},cull:{enable:!0},depth:{enable:!0,mask:()=>{const t=this._layer.getGroundConfig();return t.depth||void 0===t.depth},range:()=>{const e=this._layer.getGroundConfig(),n=e&&e.renderPlugin.sceneConfig;return n&&n.depthRange||t},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(t,e)=>e.offsetFactor,units:(t,e)=>e.offsetUnits}}}}_hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}_createGround(){const t=new R_;t.data.aTexCoord=new Uint8Array([0,0,1,0,0,1,1,1]),t.createTangent(),t.generateBuffers(this.renderer.regl),this._ground=new h_(t,null,{castShadow:!1});const e=this._standardShader.getGeometryDefines(t);this._ground.setDefines(e),this._groundScene=new __([this._ground])}_transformGround(){const t=this.getMap(),e=AS.getGroundTransform(this._ground.localTransform,t);this._ground.setLocalTransform(e);const n=t.getGLRes(),r=t._get2DExtentAtRes(n),i=r.getWidth(),o=r.getHeight(),s=t.cameraLookAt,a=s[0]-i,l=s[1]-o,h=this._polygonPatternFile?this._polygonPatternFile.width/this._polygonPatternFile.height:1,u=this.getSymbol(),c=this.material?this.material.get("textureOrigin"):u.polygonPatternFileOrigin,f=!!(this.material?this.material.get("uvOffsetInMeter"):u.uvOffsetInMeter),d=(this.material?this.material.get("uvOffset"):u.uvOffset)||uS,p=this.material&&this.material.get("uvScale")||cS,g=this.material?this.material.get("textureWidth"):u.polygonPatternFileWidth,m=this.material?g*(p[1]/p[0]):u.polygonPatternFileHeight,A=this._getUVOffsetAnim(),[y,v,x,_,b]=function(t,e,n,r,i,o,s,a,l,h,u){const c=t.getGLRes();r&&(tS.set(r[0],r[1]),t.coordToPointAtRes(tS,c,eS),e-=eS.x,n-=eS.y);const f=r?tS:null;h=ky(rS,h);const d=!l&&h||$C;let p=l&&h||$C;p=ky(nS,p),p[0]&&(p[0]=oS(t,p[0],f)),p[1]&&(p[1]=oS(t,p[1],f,1));let g=.5;i&&(g=oS(t,i,f));let m=g/s;if(o&&(m=oS(t,o,f,1)),u&&(u[0]||u[1])){const e=performance.now()/1e3;let n=u[0],r=u[1];l&&(n=-oS(t,u[0],f),r=-oS(t,u[1],f,1)),u[0]&&(l?p[0]=e*n:d[0]=e*n),u[1]&&(l?p[1]=e*r:d[1]=e*r)}const A=(e+p[0])/(g/a[0]),y=(n-p[1])/(m/a[1]);return iS[0]=g/a[0],iS[1]=m/a[1],iS[2]=A,iS[3]=y,iS[4]=d,iS}(t,a,l,c,g,m,h,p,f,d,A),w=2*r.getWidth()/y,T=2*r.getHeight()/v;if(!this.material)return this._ground.setUniform("uvScale",Ly(fS,w,T)),void this._ground.setUniform("uvOffset",Ly(dS,x%1+b[0],_%1+b[1]));this._ground.setUniform("uvScale",Ly(mS,w,T)),this._ground.setUniform("uvOffset",Ly(pS,x%1+b[0],_%1+b[1])),this._ground.setUniform("uvOrigin",Ly(gS,x-x%1,_-_%1)),this._ground.setUniform("uvRotation",0)}_getGroundDefines(t){let e=!1;const n=this._ground.defines,r=this._layer._getSceneConfig&&this._layer._getSceneConfig(),i=this._layer.getGroundConfig();function o(t,r){t?n[r]||(n[r]=1,e=!0):n[r]&&(delete n[r],e=!0)}o(this._hasIBL(),"HAS_IBL_LIGHTING");o(t&&t.ssr&&i&&i.symbol&&i.symbol.ssr,"HAS_SSR");const s=t&&r&&r.shadow&&r.shadow.enable;o(s,"HAS_SHADOWING"),o(s,"USE_ESM");return o(!!this._polygonPatternFile,"HAS_PATTERN"),e?n:null}_updateMaterial(){const t=this.getSymbol()&&this.getSymbol().material;if(!t)return;const e={};let n=!1;const r=this._layer.getGroundConfig();this._loader.setURLModifier(r.urlModifier);for(const i in t)if(VC(t,i))if(i.indexOf("Texture")>0){let r=t[i];if(!r)continue;r="string"==typeof r?{url:r,wrap:"repeat"}:r,r.flipY=!0,r.min="linear mipmap linear",r.mag="linear",r.flipY=!0,e[i]=new O_(r,this._loader),n=!0}else e[i]=t[i];this.material?(this._loadingMaterial=new xT.StandardMaterial(e),this._loadingMaterial.isReady()?this._onMaterialComplete():this._loadingMaterial.once("complete",this._bindOnMaterialComplete)):(this.material=new xT.StandardMaterial(e),this.material.once("complete",this._bindOnMaterialComplete,this)),n||this._onMaterialComplete()}_onMaterialComplete(){this._loadingMaterial&&(this.material.dispose(),this.material=this._loadingMaterial,delete this._loadingMaterial),this.setToRedraw(!0)}_createPatternTexture(t){t=sx.resizeToPowerOfTwo(t);const e=this._regl,n={width:t.width,height:t.height,data:t,mag:"linear",min:"linear mipmap linear",flipY:!0,wrap:"repeat"};return e.texture(n)}_parseColor(t){return qC([],t)}_getUVOffsetAnim(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this._groundScene.getMeshes()}}const{createIBLTextures:yS,disposeIBLTextures:vS}=xT.PBRUtils,xS=[0,0,0],_S=[],bS=[];class wS{constructor(t,e){this._maxLevel=4,this._regl=t,this.renderer=new f_(t),this._layer=e,this._init(),this._updateMode()}paint(t){if(!this.isEnable()||!this._resource)return;const e=this._getUniformValues(t),n=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this._shader,e,null,n)}update(){const t=this.getMap();if(!t||!this.isEnable())return;const e=t.getLightManager(),n=e&&e.getAmbientResource();n!==this._resource&&this._iblTexes&&(vS(this._iblTexes),delete this._iblTexes),this._resource=n,this._updateMode()}dispose(){this._shader.dispose(),vS(this._iblTexes),delete this._shader,delete this._iblTexes,delete this._resource}getMap(){return this._layer.getMap()}_updateMode(){if(!this._resource)return;const t=this._layer._getSceneConfig().environment||{};this._shader.setMode(t.toneMapping,t.mode?1:0)}isEnable(){const t=this._layer._getSceneConfig();return this._hasIBL()&&t&&t.environment&&t.environment.enable}_hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}_getUniformValues(){const t=this.getMap(),e=this.getMap().getLightManager(),n=e&&e.getAmbientLight();let r=this._iblTexes;r||(r=this._iblTexes=yS(this._regl,t));const i=this._layer.getRenderer().canvas,o=this._layer._getSceneConfig().environment||{},s=o.level||0,a=r.prefilterMap.width,l=this._transform=this._transform||[],h=n&&n.hsv||xS,u=o.brightness||0,c=o.intensity||1;return km(_S,h),u&&(_S[2]+=u),bS[0]=i.width,bS[1]=i.height,{cubeMap:r.prefilterMap,bias:s,size:a/Math.pow(2,Math.max(0,s-1)),environmentExposure:HC(n&&n.exposure)?n.exposure:1,backgroundIntensity:c,diffuseSPH:r.sh,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,resolution:bS,hsv:_S,transformMatrix:Jg(l,n&&Math.PI/180*-n.orientation||0)}}_init(){const t=this.getMap();if(t.on("updatelights",this.update,this),this._shader=new ab,t.options.lights){const t=this.getMap().getLightManager().getAmbientResource();this._resource=t}}}const TS=[],MS=[.03,.03,.03],CS=[],SS=[],IS=[],PS=[1,1,1],ES=[-1200,-1200,0],OS=[1200,1200,1e3],RS={min:[],max:[]},kS=pm([],XA([],90,0,0),[0,0,0]);class LS{constructor(t,e){this._regl=t,this.renderer=new f_(t),this._layer=e,this._timer=new DS,this._init()}getMap(){return this._layer&&this._layer.getMap()}_init(){const t=this._layer.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this._shader=new U_({vert:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform vec3 cameraPosition;\nuniform float top;\nuniform float bottom;\nuniform float time;\nvarying vec2 vTexCoord;\n#include <get_output>\nfloat angle(float x, float y){\n    return atan(y, x);\n}\nvec2 getFoot(vec2 camera, vec2 normal, vec2 pos) {\n    vec2 position = vec2(0.0, 0.0);\n    float distanceLen = distance(pos, normal);\n    float a = angle(camera.x - normal.x, camera.y - normal.y);\n    pos.x > normal.x ? a -= 0.785 : a += 0.785;\n    position.x = cos(a) * distanceLen;\n    position.y = sin(a) * distanceLen;\n    return position + normal;\n    return position;\n}\nvoid main()\n{\n    vec4 localPosition = getPosition(aPosition);\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(localPosition.x, localPosition.z));\n    float height = top - bottom;\n    float y = aNormal.y - bottom - height * time;\n    y = y + (y < 0.0 ? height : 0.0);\n    float ratio = (1.0 - y / height) * (1.0 - y / height);\n    y = height * (1.0 - ratio);\n    y += bottom;\n    y += aPosition.y - aNormal.y;\n    localPosition = vec4( foot.x, y, foot.y , 1.0);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D rainMap;\nvoid main() {\n    vec4 rainColor = texture2D(rainMap, vTexCoord);\n    vec4 diffuseColor = vec4(diffuse, opacity);\n    diffuseColor *= rainColor;\n    gl_FragColor = diffuseColor;\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(TS,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this._createScene()}_createScene(){const t=this._regl.texture({width:2,height:2});if(this._mesh=this._createRain(),!this._mesh)return;this._scene=new __(this._mesh);const e=this._getRainConfig();e.rainTexture?this._creatRainTexture(e.rainTexture).then((t=>{this._mesh.material.set("rainMap",t)})):(this._mesh.material.set("rainMap",t),console.warn("should set rain texture."))}_createRain(){const t=this.getMap(),e=this._getRainConfig();if(!e)return null;this._fixZoom=t.getZoom();const n=this._getFixExtent(),r=this._rainDensity=e.density,i=this._rainWidth=e.rainWidth||1,o=this._rainHeight=e.rainHeight||1,s=[],a=[],l=[],h=[];for(let p=0;p<r;p++){const t={};t.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],t.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],t.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const e=(n.max[2]-n.min[2])/37.5*o,r=e/3*i;s.push(t.x+r,t.y+e,t.z,t.x-r,t.y+e,t.z,t.x-r,t.y,t.z,t.x+r,t.y,t.z),a.push(t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z),l.push(1,1,0,1,0,0,1,0),h.push(4*p+0,4*p+1,4*p+2,4*p+0,4*p+2,4*p+3)}const u={};u.POSITION=s,u.NORMAL=a,u.TEXCOORD_0=l;const c=new bx(u,h,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});c.generateBuffers(this.renderer.regl);const f=new Kx({rainMap:this._regl.texture({width:2,height:2}),diffuse:e.color||[1,1,1],opacity:e.opacity||1}),d=new h_(c,f);return d.setUniform("top",n.max[2]),d.setUniform("bottom",n.min[2]),this._transformRain(d),d.transparent=!0,d}_creatRainTexture(t){const e=new Image;return e.src=this._rainTexture=t,new Promise(((t,n)=>{e.onload=()=>{const n=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:e});t(n)},e.onerror=t=>{n(t)}}))}paint(t){if(!this._scene)return;const e=this._getRainConfig(),n={},r=this.getMap();n.projMatrix=r.projMatrix,n.viewMatrix=r.viewMatrix,n.cameraPosition=r.cameraPosition;const i=e.speed||1,o=this._timer.getElapsedTime()/(2/i)%1;n.time=o,this._mesh.material.set("diffuse",e.color||PS),this._mesh.material.set("opacity",e.opacity||1),this._transformRain(this._mesh);const s=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this._shader,n,this._scene,s),this._layer.getRenderer().setCanvasUpdated()}_transformRain(t){const e=this.getMap(),n=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),r=e.getGLScale()/e.getGLScale(this._fixZoom),i=Lm(SS,r,r,r),o=Fm(i,MS,i),s=im(IS),a=this._getRainConfig(),l=e.getBearing();ym(s,XA(CS,a.windDirectionX||0,a.windDirectionY||0,90-l),[n.x,n.y,0],o),am(s,s,kS),t.setLocalTransform(s)}setToRedraw(){const t=this._layer.getRenderer();t&&t.setToRedraw()}update(){const t=this._getRainConfig();if(t){if(this._mesh||this._createScene(),t.density!==this._rainDensity||t.rainWidth!==this._rainWidth||t.rainHeight!==this._rainHeight){const t=this._mesh.material.get("rainMap");this._mesh.geometry.dispose(),this._mesh.dispose(),this._scene.clear(),this._mesh=this._createRain(),this._mesh.material.set("rainMap",t),this._scene.setMeshes(this._mesh)}t.rainTexture!==this._rainTexture&&this._creatRainTexture(t.rainTexture).then((t=>{this._mesh.material.set("rainMap",t)}))}}dispose(){this._mesh&&(this._mesh.geometry.dispose(),this._mesh.material&&this._mesh.material.dispose(),this._mesh.dispose(),delete this._mesh),this._shader&&(this._shader.dispose(),delete this._shader)}isEnable(){const t=this._getRainConfig();return t&&t.enable}_getRainConfig(){const t=this._layer.getWeatherConfig();return t&&t.rain}_getFixExtent(){const t=16.685648411389433-this.getMap().getZoom();return Bm(RS.min,ES,Math.pow(2,t)),Bm(RS.max,OS,Math.pow(2,t)),RS}}class DS{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return 0}}const NS=[],FS=[.03,.03,.03],zS=[],BS=[],HS=[],jS=pm([],XA([],90,0,0),[0,0,0]);class US{constructor(t,e){this._regl=t,this._layer=e,this._init()}_init(){const t=this._layer.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this._shader=new U_({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 localPosition = getPosition(aPosition);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nprecision mediump float;\nuniform sampler2D perlinTexture;\nvarying vec2 vTexCoord;\nfloat lerp(float a, float b, float w) {\n    return a + w * (b - a);\n}\nvoid main() {\n    float snowIntense = texture2D(perlinTexture, vTexCoord).r;\n    vec3 fixedC = vec3(1.0, 1.0, 1.0);\n    float r = lerp(0.5, fixedC.x, snowIntense);\n    float g = lerp(0.5, fixedC.y, snowIntense);\n    float b = lerp(0.5, fixedC.z, snowIntense);\n    glFragColor = vec4(r, g, b, 1.0);\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(NS,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e}}),this._shader.version=300,this._scene=new __,this._groundMask=this._createGroundMask(),this._scene.setMeshes(this._groundMask),this.renderer=new f_(this._regl);const n=this._getSnowConfig();n&&(n.snowGroundTexture?this._createSnowTexture(n.snowGroundTexture):(this._groundNormal=this._regl.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(t){this._groundNormal&&this._groundMask.material.set("perlinTexture",this._groundNormal);const e=this._layer.getMap();this._transformMask(e);const n={projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition},r=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this._shader,n,this._scene,r),this._layer.getRenderer().setCanvasUpdated()}_transformMask(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),r=Lm(BS,n,n,n),i=Fm(r,FS,r),o=im(HS);ym(o,XA(zS,0,0,0),[e.x,e.y,.005],i),am(o,o,jS),this._groundMask.setLocalTransform(o)}_createSnowTexture(t){const e=new Image;e.onload=()=>{this._groundNormal=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:e})},e.onerror=t=>{},e.src=this._snowGroundTexture=t}_createGroundMask(){const t=this._layer.getMap();this._fixZoom=t.getZoom();const e=16e3*Math.pow(2,16.685648411389433-this._fixZoom),n=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],r={};r.POSITION=n,r.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],r.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new bx(r,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const o=new Kx({perlinTexture:this._regl.texture({with:2,height:2})});return new h_(i,o)}getMeshes(){return this._groundMask}dispose(){this._groundMask&&(this._groundMask.geometry.dispose(),this._groundMask.material&&this._groundMask.material.dispose(),this._groundMask.dispose(),delete this._groundMask),this._shader&&(this._shader.dispose(),delete this._shader)}update(){const t=this._getSnowConfig();t&&t.snowGroundTexture===!this._snowGroundTexture&&this._createSnowTexture(t.snowGroundTexture)}isEnable(){const t=this._getSnowConfig();return t&&t.enable}_getSnowConfig(){const t=this._layer.getWeatherConfig();return t&&t.snow}}const VS=[];class GS{constructor(t,e,n){this._regl=t,this._layer=e,this._config=n,this._init()}_init(){this.renderer=new f_(this._regl);const t=this._layer.getRenderer(),e=this._viewport={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this._width=e.width,this._height=e.height,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this._regl.texture({with:2,height:2}),this._rainPainter=new LS(this._regl,this._layer),this._rainRipplesPass=new bb(this._regl,e),this._snowPainter=new US(this._regl,this._layer),this._fogPass=new pb(this._regl,e,this._layer),this._weatherShader=new gb,this._weatherShader.version=300}getMap(){return this._layer&&this._layer.getMap()}renderScene(t){this.renderSnowMask(t),this.renderRain(t)}renderRain(t){this.isEnableRain()&&this._rainPainter.paint(t)}renderSnowMask(t){if(!this.isEnableSnow()||!this._showSnowGround())return;const e=this.getMap();this._snowPainter.render(t,e)}paint(t,e){if(!e||!e.length)return t;this._resize();const n=this._layer.getWeatherConfig(),r={};if(this.isEnableRain()?(r.ripplesMap=this._renderRainRipples(),this._weatherShader.shaderDefines.HAS_RAIN=1):delete this._weatherShader.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this._weatherShader.shaderDefines.HAS_SNOW=1,r.snowIntensity=sx.isNumber(n.snow.snowIntensity)?n.snow.snowIntensity:.5,e.forEach((t=>{t.defines.HAS_SNOW=1}))):(delete this._weatherShader.shaderDefines.HAS_SNOW,e.forEach((t=>{delete t.defines.HAS_SNOW}))),this.isEnableFog()){const t=n.fog;r.fogColor=t.color||[.9,.9,.9],this._weatherShader.shaderDefines.HAS_FOG=1}else delete this._weatherShader.shaderDefines.HAS_FOG;return this._weatherShader.setDefines(this._weatherShader.shaderDefines),r.mixFactorMap=this._renderMixFactor(e)||this.EMPTY_TEXTURE,r.sceneMap=t,r.time=this._getTimeSpan()/1e3,r.resolution=Ly(VS,this._fbo.width,this._fbo.height),this.renderer.render(this._weatherShader,r,null,this._fbo),this._renderMeshes=e,this._fbo}_renderMixFactor(t){const e={},n=this.getMap(),r=n.getZoom(),i=Math.pow(2,16.685648411389433-r),o=this._layer.getWeatherConfig(),s=o.fog;if(!s||!s.enable)return null;const a=s.start||.1,l=s.end||100;e.projMatrix=n.projMatrix,e.viewMatrix=n.viewMatrix,e.cameraPosition=n.cameraPosition,e.fogDist=[a*i,l*i],e.rainDepth=n.altitudeToPoint(o.rain&&o.rain.rainDepth||.1,n.getGLRes());const h=this._fogPass.render(t,e);return this._layer.getRenderer()._getFBOColor(h)}_renderRainRipples(){const t=this.getMap(),e=this._layer.getWeatherConfig(),n=e.rain.rippleRadius||24,r={};r.projMatrix=t.projMatrix,r.viewMatrix=t.viewMatrix,r.time=this._getTimeSpan()/1e3,r.rippleRadius=n,r.density=e.rain.density||2e3;return this._rainRipplesPass.render(t,r)}_getTimeSpan(){if(!this._layer)return 0;if(void 0===this._currentFrameTime&&(this._currentFrameTime=0),this.isPlaying()){const t=this._layer.getRenderer();this._currentFrameTime=t.getFrameTime()}return this._currentFrameTime}isEnable(){const t=this._layer.getWeatherConfig();return t&&t.enable}isEnableRain(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.rain&&t.rain.enable}isEnableFog(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.fog&&t.fog.enable}isEnableSnow(){const t=this._layer.getWeatherConfig();return t&&t.enable&&t.snow&&t.snow.enable}_showSnowGround(){const t=this._layer.getWeatherConfig();return this.isEnableSnow()&&!1===t.snow.showGround}isPlaying(){const t=this._layer.getWeatherConfig();return!!t&&!1!==t.playing}_hasWeather(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){!this.isEnable()&&this._renderMeshes&&this._renderMeshes.forEach((t=>{delete t.defines.HAS_SNOW,delete t.defines.HAS_RAIN,delete t.defines.HAS_FOG})),this.isEnableRain()&&(this._rainPainter=this._rainPainter||new LS(this._regl,this._layer),this._rainPainter.update()),this.isEnableSnow()&&(this._snowPainter=this._snowPainter||new US(this._regl,this._layer),this._snowPainter.update())}getShadowMeshes(){return this._snowPainter.getMeshes()}_resize(){const t=this._width(),e=this._height();!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}dispose(){this._fbo&&this._fbo.destroy(),this._weatherShader&&(this._weatherShader.dispose(),delete this._weatherShader),this._rainPainter&&(this._rainPainter.dispose(),delete this._rainPainter),this._snowPainter&&(this._snowPainter.dispose(),delete this._snowPainter)}}const WS=[],qS=t=>!!t.bloom,XS=t=>!!t.ssr;class ZS{constructor(t,e){this._regl=t,this._layer=e,this._renderer=new f_(t),this._fxaaShader=new Z_,this._copyShader=new hb,this._ssrPass=new rb(this._regl)}setContextIncludes(){}bloom(t,e,n,r,i,o,s){this._bloomPass||(this._bloomPass=new eb(this._regl));const a=this._layer.getRenderer()._getFBOColor(this._bloomFBO);return this._bloomPass.render(t,a,r,i,o,e,n,s)}drawBloom(t){const e=this._layer.getRenderer(),n=this._regl,r=this._bloomFBO;if(r){const{width:e,height:i}=t;r.width===e&&r.height===i||r.resize(e,i),n.clear({color:[0,0,0,0],framebuffer:r})}else{const e=this._createFBOInfo(t);this._bloomFBO=n.framebuffer(e)}const i=e.getFrameTime(),o=e.getFrameEvent(),s=e.getFrameContext(),a=s.renderMode,l=s.sceneFilter,h=s.renderTarget;s.isPostProcess=!0,s.renderMode="default",s.sceneFilter=qS,s.renderTarget={fbo:this._bloomFBO,getFramebuffer:YS,getDepthTexture:JS};const u=e.glCtx;return u.resetDrawCalls(),o?e.forEachRenderer((t=>{e.clearStencil(t,r),t.drawOnInteracting(o,i,s)})):e.forEachRenderer((t=>{e.clearStencil(t,r),t.draw(i,s)})),delete s.isPostProcess,s.renderMode=a,s.sceneFilter=l,s.renderTarget=h,u.getDrawCalls()}genSsrMipmap(t,e){const n=this._layer.getMap().projViewMatrix;this._ssrPass.genMipMap(t,e,n)}getPrevSsrProjViewMatrix(){return this._ssrPass&&this._ssrPass.getPrevProjViewMatrix()}drawSSR(t,e,n){n&&this._ssrPass.copyDepthTex(t);const r=this._layer.getRenderer(),i=r.getFrameTime(),o=r.getFrameEvent(),s=r.getFrameContext();s.isPostProcess=!0,s.ssr=this.getSSRContext();const a=s.renderMode,l=s.sceneFilter;s.renderMode="default",s.sceneFilter=XS,s.renderTarget.fbo=e;const h=r.glCtx;let u=!1;o?r.forEachRenderer((t=>{r.clearStencil(t,e),u||(h.resetDrawCalls(),u=!0),t.drawOnInteracting(o,i,s)})):r.forEachRenderer((t=>{r.clearStencil(t,e),u||(h.resetDrawCalls(),u=!0),t.draw(i,s)}));const c=r.drawGround();return delete s.ssr,delete s.isPostProcess,s.renderMode=a,s.sceneFilter=l,this._ssrPainted=h.getDrawCalls()>0,c}getSSRUniforms(){const t=this._layer._getSceneConfig(),e=t&&t.postProcess,n=this._layer.getMap();return this._ssrPass.getSSRUniforms(n,e.ssr.factor,e.ssr.quality)}getSSRContext(){const t=this._layer._getSceneConfig(),e=t&&t.postProcess,n=this._layer.getMap(),r=this._ssrPass.getSSRUniforms(n,e.ssr.factor,e.ssr.quality);if(!r)return null;return{renderUniforms:r,defines:{HAS_SSR:1}}}fxaa(t,e,n,r,i,o,s,a,l,h,u,c){!t||t.width===e.fbo&&t.height===e.height||t.resize(e.width,e.height);const f={};a?f.HAS_OUTLINE_TEX=1:delete f.HAS_OUTLINE_TEX,this._fxaaShader.setDefines(f),this._renderer.render(this._fxaaShader,{textureSource:e,resolution:Ly(WS,e.width,e.height),enableFXAA:n,enableToneMapping:r,enableSharpen:i,pixelRatio:o,sharpFactor:s,textureOutline:a,highlightFactor:l,outlineFactor:h,outlineWidth:u,outlineColor:c},null,t)}renderFBOToScreen(t,e,n,r){this._copyFBOSize||(this._copyFBOSize=[]),this._copyFBOSize[0]=t.width,this._copyFBOSize[1]=t.height;const i=this._layer.getRenderer();this._renderer.render(this._copyShader,{texture:t.color&&i._getFBOColor(t)||t,size:this._copyFBOSize,enableSharpen:+!!e,sharpFactor:n,pixelRatio:r})}postprocess(t,e,n){this._postProcessShader||(this._postProcessShader=new Y_);const r=this._layer&&this._layer.getRenderer(),i=n||r._getFBOColor(t);return e.resolution=Ly(WS,i.width,i.height),e.textureSource=i,e.timeGrain=performance.now(),this._renderer.render(this._postProcessShader,e),this._target}dispose(){this._bloomFBO&&(this._bloomFBO.destroy(),delete this._bloomFBO),this._bloomPass&&(this._bloomPass.dispose(),delete this._bloomPass),this._postProcessShader&&(this._postProcessShader.dispose(),delete this._postProcessShader),this._fxaaShader&&(this._fxaaShader.dispose(),delete this._fxaaShader),this._copyShader&&(this._copyShader.dispose(),delete this._copyShader)}_createFBOInfo(t,e){const{width:n,height:r}=this._layer.getRenderer().canvas,i=this._regl;let o;o=this._layer.getRenderer()._isUseMultiSample()?i.renderbuffer({width:n,height:r,samples:this._layer.options.multiSamples,format:"rgba8"}):i.texture({min:"nearest",mag:"nearest",format:e||"rgba",width:n,height:r});const s={width:n,height:r,colors:[o]};return t&&(s.depthStencil=t),s}}function YS(t){return t._framebuffer.framebuffer}function JS(t){return t.depthStencil._texture.texture}class QS extends X_{constructor(t){super({vert:"#if __VERSION__ == 300\n\t#define attribute in\n\t#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_FLOODANALYSE\n    uniform vec3 flood_waterColor;\n    uniform float flood_waterOpacity;\n    uniform sampler2D floodMap;\n#endif\n#ifdef HAS_SKYLINE\n    uniform sampler2D skylineMap;\n#endif\n#ifdef HAS_VIEWSHED\n    uniform vec4 viewshed_visibleColor;\n    uniform vec4 viewshed_invisibleColor;\n    uniform sampler2D viewshedMap;\n#endif\n#ifdef HAS_INSIGHT\n    uniform vec4 insight_visibleColor;\n    uniform vec4 insight_invisibleColor;\n    uniform sampler2D insightMap;\n#endif\n#ifdef HAS_CUT\n    uniform sampler2D meshesMap;\n    uniform sampler2D invisibleMap;\n#endif\n#ifdef HAS_EXCAVATE\n    uniform sampler2D excavateMap;\n#endif\n#ifdef HAS_CROSSCUT\n    uniform sampler2D crosscutMap;\n    uniform vec4 cutLineColor;\n#endif\n#ifdef HAS_HEIGHTLIMIT\n    uniform vec3 limitColor;\n    uniform sampler2D heightLimitMap;\n#endif\nuniform sampler2D sceneMap;\nvoid main() {\n    vec4 sceneColor = texture2D(sceneMap, vTexCoord);\n    glFragColor = sceneColor;\n    #ifdef HAS_VIEWSHED\n        vec4 viewshedColor = texture2D(viewshedMap, vTexCoord);\n        if (viewshedColor.r > 0.99) {\n            glFragColor = vec4(mix(viewshed_invisibleColor.rgb, sceneColor.rgb, viewshed_invisibleColor.a), sceneColor.a);\n        } else if (viewshedColor.g > 0.99) {\n            glFragColor = vec4(mix(viewshed_visibleColor.rgb, sceneColor.rgb, viewshed_visibleColor.a), sceneColor.a);\n        } else if (viewshedColor.a < 0.01) {\n            glFragColor = vec4(viewshedColor.rgb, 1.0);\n        }\n    #endif\n    #ifdef HAS_FLOODANALYSE\n        vec4 floodColor = texture2D(floodMap, vTexCoord);\n        if (floodColor.r > 0.0) {\n            glFragColor = vec4(mix(glFragColor.rgb, flood_waterColor, flood_waterOpacity), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_SKYLINE\n        vec4 skylineColor = texture2D(skylineMap, vTexCoord);\n        if (skylineColor.r > 0.0 || skylineColor.g > 0.0 || skylineColor.b > 0.0) {\n            glFragColor = skylineColor;\n        }\n    #endif\n    #ifdef HAS_INSIGHT\n        vec4 insightColor = texture2D(insightMap, vTexCoord);\n        if (insightColor.g > 0.0) {\n            glFragColor = insight_visibleColor;\n        } else if (insightColor.r > 0.0) {\n            glFragColor = insight_invisibleColor;\n        }\n    #endif\n    #ifdef HAS_CUT\n        vec4 cutColor = texture2D(invisibleMap, vTexCoord);\n        vec4 meshesMapColor = texture2D(meshesMap, vTexCoord);\n        if (cutColor.r == 1.0 && cutColor.g == 0.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 1.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 0.0 && cutColor.b == 1.0) {\n          glFragColor = sceneColor;\n        }\n    #endif\n    #ifdef HAS_EXCAVATE\n        vec4 excavateColor = texture2D(excavateMap, vTexCoord);\n        if (excavateColor.r == 1.0 && excavateColor.g == 0.0 && excavateColor.b == 0.0) {\n          glFragColor = sceneColor;\n        }  else {\n          glFragColor = excavateColor;\n        }\n    #endif\n    #ifdef HAS_CROSSCUT\n        vec4 crosscutColor = texture2D(crosscutMap, vTexCoord);\n        if (crosscutColor.r > 0.0) {\n            glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, 0.99), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_HEIGHTLIMIT\n        vec4 heightLimitColor = texture2D(heightLimitMap, vTexCoord);\n        if (heightLimitColor.r > 0.0) {\n            glFragColor = vec4(mix(limitColor, glFragColor.rgb, 0.6), glFragColor.a);\n        }\n    #endif\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",extraCommandProps:{viewport:t,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}}class KS{constructor(t,e,n){this._regl=t,this._layer=e,this._config=n,this._init()}_init(){this.renderer=new f_(this._regl);const t=this._layer.getRenderer(),e=this._viewport={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this._fbo=this._regl.framebuffer({color:this._regl.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._shader=new QS(e)}getMap(){return this._layer&&this._layer.getMap()}paint(t,e){if(!e&&e.length)return t;this._resize();const n={},r=this._layer._analysisTaskList;if(!this._hasAnalysis())return t;this._regl.clear({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this._fbo}),delete this._shader.shaderDefines.HAS_FLOODANALYSE,delete this._shader.shaderDefines.HAS_VIEWSHED,delete this._shader.shaderDefines.HAS_SKYLINE,delete this._shader.shaderDefines.HAS_INSIGHT,delete this._shader.shaderDefines.HAS_CUT,delete this._shader.shaderDefines.HAS_CROSSCUT,delete this._shader.shaderDefines.HAS_HEIGHTLIMIT;for(let i=0;i<r.length;i++){const t=r[i];if(!t.isEnable())continue;const o=t.getDefines();zC(this._shader.shaderDefines,o);const s=this.getMap(),a=s.width,l=s.height,h=this._getToAnalysisMeshes(e,t.getExcludeLayers()),u=t.renderAnalysis(h,a,l);u&&zC(n,u)}return n.sceneMap=t,this._shader.setDefines(this._shader.shaderDefines),this.renderer.render(this._shader,n,null,this._fbo),this._fbo}_getToAnalysisMeshes(t,e){let n=[];for(let r=0;r<t.length;r++){if(e.indexOf(t[r].getId())>-1)continue;const i=t[r].getRenderer();if(i&&i.getAnalysisMeshes){const t=i.getAnalysisMeshes();t.forEach((t=>{t.setUniform("useAnalysis",1)})),n=n.concat(t)}}return n}_resize(){const t=s.isFunction(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=s.isFunction(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}_hasAnalysis(){const t=this._layer&&this._layer._analysisTaskList;if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].isEnable())return!0;return!1}}const $S=[0,0,0,0],tI=[1,1,-1],eI=[0,0],nI=t=>!t.bloom&&!t.ssr,rI=t=>!t.bloom,iI=t=>!t.ssr;class oI extends r.CanvasRenderer{setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this._groundPainter&&this._groundPainter.update(),this._envPainter&&this._envPainter.update(),this._weatherPainter&&this._weatherPainter.update(),this.setToRedraw()}render(...t){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer((t=>{t._replacedDrawFn||(t.draw=this._buildDrawFn(t.draw),t.drawOnInteracting=this._buildDrawOnInteractingFn(t.drawOnInteracting),t.setToRedraw=this._buildSetToRedrawFn(t.setToRedraw),t._replacedDrawFn=!0)})),this.prepareRender(),this.prepareCanvas(),this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("render",t),this._renderOutlines(),this._postProcess())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer((t=>{t.prepareCanvas()}))}drawOnInteracting(...t){this.getMap()&&this.layer.isVisible()&&(this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("drawOnInteracting",t),this._renderOutlines(),this._postProcess())}_renderChildLayers(t,e){this._renderMode="default";const n=this.hasRenderTarget(),r=this._getDrawContext(e);if(n&&(this._drawContext.renderTarget=this._getFramebufferTarget()),this._envPainter.paint(r),this.drawGround(!0),!n)return void this._renderInMode("default",null,t,e,!0);const i=this.glCtx,o=this.layer._getSceneConfig(),s=o&&o.postProcess,a=this.isSSROn();r.jitter=eI;const l=this.layer.getGroundConfig();r.hasSSRGround=!!(a&&l&&l.enable&&l.symbol&&l.symbol.ssr),i.resetDrawCalls(),this._renderInMode("default",this._targetFBO,t,e),a&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO);s.bloom&&s.bloom.enable&&(this._bloomPainted=this._postProcessor.drawBloom(this._depthTex)),2===a&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO,!0),i.resetDrawCalls(),this._weatherPainter.renderScene(r),this._pointDrawCount=i.getDrawCalls()}_renderInMode(t,e,n,r,i){this._renderMode=t;const o=this._getDrawContext(r);o.renderMode=this._renderMode,o.renderTarget&&(o.renderTarget.fbo=e),i&&(o.isFinalRender=!0),this.forEachRenderer(((t,i)=>{i.isVisible()&&(this.clearStencil(t,e),t[n].apply(t,r))}))}_getDrawContext(t){let e=t[0];return sI(e)||(e=t[1]),e!==this._contextFrameTime&&(this.forEachRenderer(((t,e)=>{e.isVisible()&&t.needRetireFrames&&t.needRetireFrames()&&this.setRetireFrames()})),this._drawContext=this._prepareDrawContext(e),this._contextFrameTime=e,this._frameEvent=sI(t[0])?null:t[0]),this._drawContext}_renderOutlines(){if(!this.isEnableOutline())return;const t=this._getOutlineFBO(),e=this.glCtx;e.resetDrawCalls(),this.forEachRenderer(((e,n)=>{n.isVisible()&&e.drawOutline&&e.drawOutline(t)})),this._outlineCounts=e.getDrawCalls()}_getOutlineFBO(){const{width:t,height:e}=this.canvas;let n=this._outlineFBO;if(n)t===n.width&&e===n.height||n.resize(t,e);else{const r=this.regl.texture({width:t,height:e,format:"rgba4"});n=this._outlineFBO=this.regl.framebuffer({width:t,height:e,colors:[r],depth:!1,stencil:!1})}return n}_getFBOColor(t){if(this._isUseMultiSample()){const e=this._getBlitFBO(t);return e.width!==t.width||e.height!==t.height?e.resize(t.width,t.height):this.regl.clear({color:[0,0,0,0],fbo:e}),e.blit(t),e.color[0]}return t.color[0]}_blitDepthTex(){if(this._depthTex.subimage)return this._depthTex;const{width:t,height:e}=this._depthTex;if(!this._blitDepthFBO){const n=this.regl,r={depthStencil:n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:t,height:e,format:"depth stencil"}),colors:[n.renderbuffer({width:t,height:e,format:"rgba4"})],colorFormat:"rgba4",width:t,height:e};this._blitDepthFBO=n.framebuffer(r)}return this._blitDepthFBO.width===t&&this._blitDepthFBO.height===e||this._blitDepthFBO.resize(t,e),this.regl.clear({color:[0,0,0,0],depth:1,fbo:this._blitDepthFBO}),this._blitDepthFBO.blit(this._targetFBO,256,"nearest"),this._blitDepthFBO.depthStencil}_getBlitFBO(t){if(this._blitFBOs||(this._blitFBOs=[]),!t._blitFBO){const e=this._createSimpleFBOInfo(!0,t.width,t.height),n=this.regl.framebuffer(e);this._blitFBOs.push(n),t._blitFBO=n}return t._blitFBO}_isUseMultiSample(){return 0===this.regl.limits.version.indexOf("WebGL 2.0")&&this.layer.options.antialias}hasRenderTarget(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return!(!e||!e.enable)}testIfNeedRedraw(){if(this.layer.options.forceRedrawPerFrame)return!0;if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this._groundPainter&&this._groundPainter.isEnable()||this._envPainter&&this._envPainter.isEnable()))return!0;if(this._weatherPainter&&this._weatherPainter.isEnable())return!0;const t=this.layer.getTerrainLayer();if(t){const e=t.getRenderer();if(e&&e.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}const e=this._getLayers();for(const n of e){if(!n||!n.isVisible())continue;const t=n.getRenderer();if(t&&t.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}return!1}isRenderComplete(){const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&!t.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&t.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&t.isCanvasUpdated())return!0}return!1}isBlank(){if(this._groundPainter&&this._groundPainter.isEnable())return!1;if(this._envPainter&&this._envPainter.isEnable())return!1;const t=this.layer.getTerrainLayer();if(t){const e=t.getRenderer();if(e&&!e.isBlank())return!1}const e=this._getLayers();for(const n of e){const t=n.getRenderer();if(t&&!t.isBlank())return!1}return!0}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0};e.preserveDrawingBuffer=!0,e.antialias=!!t.options.antialias,this.glOptions=e;const n=this.gl=function(t,e,n){const r=n?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let i=null;for(let o=0;o<r.length;++o){try{i=t.getContext(r[o],e)}catch(Wp){}if(i)break}return i||console.error("Browser doesn't support WebGL."),i}(this.canvas,e,t.options.onlyWebGL1);this._initGL(n),n.wrap=()=>new DT(this.gl),this.glCtx=n.wrap(),this.canvas.gl=this.gl,this.reglGL=n.wrap(),this.regl=mp({gl:this.reglGL,attributes:e,extensions:t.options.extensions,optionalExtensions:t.options.optionalExtensions}),this.gl.regl=this.regl,this._jitter=[0,0],this._groundPainter=new AS(this.regl,this.layer),this._envPainter=new wS(this.regl,this.layer);const r=this.layer.getWeatherConfig();this._weatherPainter=new GS(this.regl,t,r),this._analysisPainter=new KS(this.regl,t);const i=this.layer._getSceneConfig()||{},o=i&&i.postProcess,s=o&&o.antialias&&o.antialias.jitterRatio||.2;this._jitGetter=new $_(s),this._postProcessor=new ZS(this.regl,this.layer,this._jitGetter),this._shadowProcess=new KC(this.regl,this.layer)}_initGL(){const t=this.layer,e=this.gl,n=t.options.extensions;n&&n.forEach((t=>{e.getExtension(t)}));const r=t.options.optionalExtensions;r&&r.forEach((t=>{e.getExtension(t)})),this.gl.clearColor(0,0,0,0)}clearCanvas(){super.clearCanvas(),this._clearFramebuffers()}_clearFramebuffers(){const t=this.regl;this._targetFBO&&t.clear({color:$S,depth:1,stencil:255,framebuffer:this._targetFBO}),this._outlineFBO&&t.clear({color:$S,framebuffer:this._outlineFBO}),t.clear({color:$S,depth:1,stencil:255})}resizeCanvas(){const t=this.canvas.width,e=this.canvas.height;!this._targetFBO||this._targetFBO.width===t&&this._targetFBO.height===e||(super.resizeCanvas(),this._targetFBO.resize(t,e),this._clearFramebuffers(),this.forEachRenderer((t=>{t.canvas&&t.resizeCanvas()})))}getCanvasImage(){return this.forEachRenderer((t=>{t.getCanvasImage()})),super.getCanvasImage()}_getLayers(){return this.layer._getLayers()}forEachRenderer(t){const e=this._getLayers();for(const r of e){if(!r.isVisible()||!r.options.beneathTerrain)continue;const e=r.getRenderer();e&&t(e,r)}const n=this.layer.getTerrainLayer();if(n){const e=n.getRenderer();e&&t(e,n)}for(const r of e){if(!r.isVisible()||r.options.beneathTerrain)continue;const e=r.getRenderer();e&&t(e,r)}}clearStencil(t,e){const n={stencil:t.getStencilValue?t.getStencilValue():255};e&&(n.framebuffer=e),this.regl.clear(n)}onRemove(){this.canvas.pickingFBO&&this.canvas.pickingFBO.destroy&&this.canvas.pickingFBO.destroy(),this._destroyFramebuffers(),this._groundPainter&&(this._groundPainter.dispose(),delete this._groundPainter),this._envPainter&&(this._envPainter.dispose(),delete this._envPainter),this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),this._postProcessor&&(this._postProcessor.dispose(),delete this._postProcessor),this._outlineFBO&&(this._outlineFBO.destroy(),delete this._outlineFBO),this._weatherPainter&&(this._weatherPainter.dispose(),delete this._weatherPainter),super.onRemove()}_destroyFramebuffers(){if(this._targetFBO&&(this._targetFBO.destroy(),delete this._targetFBO,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO),this._blitDepthFBO&&(this._blitDepthFBO.destroy(),delete this._blitDepthFBO),this._blitFBOs)){for(let t=0;t<this._blitFBOs.length;t++)this._blitFBOs[t]&&this._blitFBOs[t].destroy();delete this._blitFBOs}}setRetireFrames(){this._needRetireFrames=!0}getFrameTime(){return this._contextFrameTime}getFrameEvent(){return this._frameEvent}getFrameContext(){return this._drawContext}drawGround(t){const e=this.layer.getGroundConfig();if(!e||!e.enable)return!1;if(!this._groundPainter)return!1;const n=this.getFrameContext(),r=n.jitter;n.jitter=eI;const i=this.layer.getPolygonOffsetCount();let o;n.offsetFactor=i+1,n.offsetUnits=i+1,t&&(o=n.sceneFilter,delete n.sceneFilter);const s=this._groundPainter.paint(n);return this._groundPainter.needToRedraw()&&this.setToRedraw(),o&&(n.sceneFilter=o),n.jitter=r,s}_buildDrawFn(t){const e=this;return function(n,r){return(r=r||e._drawContext)&&r.renderTarget&&(r.renderTarget.getFramebuffer=aI,r.renderTarget.getDepthTexture=lI),t.call(this,n,r)}}_buildDrawOnInteractingFn(t){const e=this;return function(n,r,i){return(i=i||e._drawContext)&&i.renderTarget&&(i.renderTarget.getFramebuffer=aI,i.renderTarget.getDepthTexture=lI),t.call(this,n,r,i)}}_buildSetToRedrawFn(t){return function(...e){return t.apply(this,e)}}isEnableSSR(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return e&&e.enable&&e.ssr&&e.ssr.enable}isSSROn(){const t=this.isEnableSSR(),e=this.getMap();if(!t||e.getPitch()<=-.001)return 0;const n=e.projViewMatrix,r=this._postProcessor.getPrevSsrProjViewMatrix();return r&&Cm(r,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){return!1}isEnableOutline(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;return e&&e.enable&&e.outline&&e.outline.enable}isEnableWeather(){const t=this.layer._getSceneConfig(),e=t&&t.weather;return e&&e.enable}_getViewStates(){const t=this.layer.getMap();if(!this._renderedView){this._renderedView={center:t.getCenter(),bearing:t.getBearing(),pitch:t.getPitch(),res:t.getResolution()};let e=!1;if(t.options.lights){const n=t.getLightManager().getDirectionalLight().direction||tI;this._renderedView.lightDirection=km([],n),e=!0}return{viewChanged:!0,lightDirectionChanged:e}}const e=t.getResolution()/this._renderedView.res,n=t.coordToContainerPoint(this._renderedView.center),r=this.layer.options.viewMoveThreshold,i=n._sub(t.width/2,t.height/2).mag()>r||e<.95||e>1.05;let o=!1;if(t.options.lights){const e=t.getLightManager().getDirectionalLight().direction||tI;o=!Jm(this._renderedView.lightDirection,e),o&&(this._renderedView.lightDirection=km([],e))}return i&&(this._renderedView.center=t.getCenter(),this._renderedView.bearing=t.getBearing(),this._renderedView.pitch=t.getPitch(),this._renderedView.res=t.getResolution()),{viewChanged:i,lightDirectionChanged:o}}_prepareDrawContext(t){const e=this.layer._getSceneConfig(),n=e&&e.postProcess,r=e&&e.weather,i={timestamp:t,renderMode:this._renderMode||"default",includes:{},states:this._getViewStates(),testSceneFilter:t=>!i.sceneFilter||i.sceneFilter(t),isFinalRender:!1,weather:{fog:r&&r.fog}},o=n&&n.antialias&&n.antialias.jitterRatio||.2,s=this._jitGetter;s&&s.setRatio(o);const a=this.isSSROn();let l;if(n&&n.enable){if(this.isEnableTAA()){(this.getMap().isInteracting()||this._needRetireFrames)&&s.reset(),s.getJitter(this._jitter),s.frame()}else Ly(this._jitter,0,0);i.jitter=this._jitter;const t=n.bloom&&n.bloom.enable;t&&a?(i.bloom=1,i.sceneFilter=nI):t?(i.bloom=1,i.sceneFilter=rI):a&&(i.sceneFilter=iI),l=this._getFramebufferTarget(),l&&(i.renderTarget=l)}else this._destroyFramebuffers();return"noAa"!==this._renderMode&&(this._shadowContext=this._prepareShadowContext(i),this._shadowContext&&(i.includes.shadow=1),this._includesState=this._updateIncludesState(i)),this._shadowContext&&(i.shadow=this._shadowContext,i.includes.shadow=1),i.states.includesChanged=this._includesState,n&&n.enable&&this._postProcessor&&this._postProcessor.setContextIncludes(i),i}_renderAnalysis(t){const e=this._getLayers().filter((t=>t.isVisible()));return this.layer.getTerrainLayer()&&e.push(this.layer.getTerrainLayer()),this._analysisPainter.paint(t,e)}_updateIncludesState(t){let e=!1;const n=Object.keys(t.includes),r=this._prevIncludeKeys;if(r){const t=n.filter((t=>-1===r.indexOf(t))).concat(r.filter((t=>-1===n.indexOf(t))));t.length&&(e=t.reduce(((t,e)=>(t[e]=1,t)),{}))}return this._prevIncludeKeys=n,e}_prepareShadowContext(t){const e=this.layer._getSceneConfig();if(!e||!e.shadow||!e.shadow.enable)return this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),null;this._shadowProcess||(this._shadowProcess=new KC(this.regl,this.layer));const n={config:e.shadow,defines:this._shadowProcess.getDefines(),uniformDeclares:KC.getUniformDeclares()};return n.renderUniforms=this._renderShadow(t),n}_renderShadow(t){const e=t.renderTarget&&t.renderTarget.fbo,n=this.layer._getSceneConfig(),r=[];let i=t.states.lightDirectionChanged||t.states.viewChanged;this.forEachRenderer(((t,e)=>{if(!t.getShadowMeshes||!e.isVisible())return;const n=t.getShadowMeshes();if(Array.isArray(n))for(let o=0;o<n.length;o++)n[o]&&(n[o].needUpdateShadow&&(i=!0,n[o].needUpdateShadow=!1),n[o].hasFunctionUniform&&(n[o].hasFunctionUniform("minAltitude")||n[o].setFunctionUniform("minAltitude",(()=>e&&e.options.altitude||0)),r.push(n[o])))})),this._shadowScene||(this._shadowScene=new __),this._shadowScene.setMeshes(r);const o=this.getMap(),s=n.shadow,a=o.getLightManager(),l=a&&a.getDirectionalLight().direction||tI,h=!n.ground||!n.ground.enable;return this._shadowProcess.render(h,o.projMatrix,o.viewMatrix,s.color,s.opacity,l,this._shadowScene,this._jitter,e,i)}_renderWeather(t){let e=[];if(this.forEachRenderer(((t,n)=>{if(!t.getAnalysisMeshes||!n.isVisible())return;const r=t.getAnalysisMeshes();e=e.concat(r)})),this._groundPainter){const t=this._groundPainter.getRenderMeshes();e=e.concat(t)}const n=this.layer.getWeatherConfig();return this._weatherPainter.paint(t,e,n)}getGroundMesh(){if(this._groundPainter){return this._groundPainter.getRenderMeshes()}return[]}_getFramebufferTarget(){const t=this.layer._getSceneConfig(),e=t&&t.postProcess;if(!this._targetFBO){const t=this.regl;let n=this._depthTex;(!n||!n._texture||n._texture.refCount<=0)&&(n=null);const r=this.createFBOInfo(e,n);this._depthTex=r.depth||r.depthStencil,this._targetFBO=t.framebuffer(r),this._clearFramebuffers()}return{fbo:this._targetFBO}}_createSimpleFBOInfo(t,e,n){e=e||this.canvas.width,n=n||this.canvas.height;const r=this.regl,i=this._isUseMultiSample();let o;if(!t&&i)o=r.renderbuffer({width:e,height:n,samples:this.layer.options.multiSamples,format:"rgba8"});else{const t="uint8";o=r.texture({min:"nearest",mag:"nearest",type:t,width:e,height:n})}return{width:e,height:n,colors:[o],colorFormat:i?"rgba8":"rgba"}}createFBOInfo(t,e){let{width:n,height:r}=this.canvas;n=n||1,r=r||1;const i=this.regl,o=this._createSimpleFBOInfo(),s=this._isUseMultiSample(),a=i.hasExtension("WEBGL_depth_texture");if(s){const t=e||i.renderbuffer({width:n,height:r,format:"depth24 stencil8",samples:this.layer.options.multiSamples});o.depthStencil=t}else if(a){const t=e||i.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:r,format:"depth stencil"});o.depthStencil=t}else{const t=e||i.renderbuffer({width:n,height:r,format:"depth stencil"});o.depthStencil=t}return o}_postProcess(){if(!this._targetFBO)return void(this._needRetireFrames=!1);const t=this.layer._getSceneConfig(),e=t&&t.postProcess;if(!e||!e.enable){if(this.isEnableWeather())throw new Error("you must enable the post process to turn on weather");return}this.layer.fire("postprocessstart");const n=this.layer.getMap();let r=e.sharpen&&e.sharpen.factor;r||0===r||(r=.2);let i=0,o=.2,s=.3,a=1,l=[1,1,0];e.outline&&(i=+!!e.outline.enable,o=hI(e.outline,"highlightFactor",o),s=hI(e.outline,"outlineFactor",s),a=hI(e.outline,"outlineWidth",a),l=hI(e.outline,"outlineColor",l));const h=e.ssr&&e.ssr.enable,u=e.bloom&&e.bloom.enable,c=this._analysisPainter._hasAnalysis(),f=this._weatherPainter._hasWeather(),d=u||h||c||f;let p=this._postFBO;if(d){if(!p){const t=this._createSimpleFBOInfo();this._isUseMultiSample()&&(t.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),p=this._postFBO=this.regl.framebuffer(t)}const{width:t,height:e}=this.canvas;p.width===t&&p.height===e||p.resize(t,e)}else p=null,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO);let g=this._getFBOColor(this._targetFBO);if(this._postProcessor.fxaa(p,g,0,+!(!e.toneMapping||!e.toneMapping.enable),+!(d||!e.sharpen||!e.sharpen.enable),n.getDevicePixelRatio(),r,i&&this._outlineCounts>0&&this._getOutlineFBO(),o,s,a,l),p&&(g=this._getFBOColor(p)),u&&this._bloomPainted){const t=e.bloom,n=+t.threshold||0,r=hI(t,"factor",1),i=hI(t,"radius",1);g=this._postProcessor.bloom(g,null,null,n,r,i,0)}if(h&&(this._postProcessor.genSsrMipmap(g,this._blitDepthTex()),this._needUpdateSSR)){const t=this._needRetireFrames;this.setToRedraw(),this._needRetireFrames=t,this._needUpdateSSR=!1}this._analysisPainter&&(g=this._renderAnalysis(g)),this.isEnableWeather()&&(g=this._renderWeather(g)),d&&this._postProcessor.renderFBOToScreen(g,+!(!e.sharpen||!e.sharpen.enable),r,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}}function sI(t){return"number"==typeof t&&!isNaN(t)}function aI(t){return t._framebuffer.framebuffer}function lI(t){return t.depthStencil._texture.texture}function hI(t,e,n){return null==t[e]?n:t[e]}class uI extends h.Actor{constructor(t){super("@maptalks/terrain"),this.mapId=t}checkUrl(t){return t&&s.isString(t)?s.getAbsoluteURL(t):t}fetchTerrain(t,e,n){t=this.checkUrl(t);const r={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:t,origin:location.origin,terrainWidth:e.terrainWidth,type:e.type,accessToken:e.accessToken,cesiumIonTokenURL:e.cesiumIonTokenURL,error:e.error,colors:e.colors,tileSize:e.tileSize}};this.send(r,null,((t,e)=>{t?n(t):n(t,e)}))}abortTerrain(t,e){const n={actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:t}};this.broadcast(n,null,e)}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{}};this.broadcast(r,null,n)}createTerrainMesh(t,e){const n={actorId:this.actorId,command:"createTerrainMesh",params:t};this.send(n,[t.terrainHeights.data.buffer],((t,n)=>{t?e(t):e(t,n)}))}removeLayer(t,e,n){const r={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(r,null,n)}}class cI{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let n=0;n<this.numTriangles;n++){let t=n+2,r=0,i=0,o=0,s=0,a=0,l=0;for(1&t?o=s=a=e:r=i=l=e;(t>>=1)>1;){const e=r+o>>1,n=i+s>>1;1&t?(o=r,s=i,r=a,i=l):(r=o,i=s,o=a,s=l),a=e,l=n}const h=4*n;this.coords[h+0]=r,this.coords[h+1]=i,this.coords[h+2]=o,this.coords[h+3]=s}}createTile(t){return new fI(t,this)}}class fI{constructor(t,e){const n=e.gridSize;if(t.length!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${t.length}.`);this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:n,gridSize:r}=this.martini,{terrain:i,errors:o}=this;for(let s=t-1;s>=0;s--){const t=4*s,a=n[t+0],l=n[t+1],h=n[t+2],u=n[t+3],c=a+h>>1,f=l+u>>1,d=c+f-l,p=f+a-c,g=(i[l*r+a]+i[u*r+h])/2,m=f*r+c,A=Math.abs(g-i[m]);if(o[m]=Math.max(o[m],A),s<e){const t=(l+p>>1)*r+(a+d>>1),e=(u+p>>1)*r+(h+d>>1);o[m]=Math.max(o[m],o[t],o[e])}}}getMesh(t=0){const{gridSize:e,indices:n}=this.martini,{errors:r}=this;let i=0,o=0;const s=e-1;function a(s,l,h,u,c,f){const d=s+h>>1,p=l+u>>1;Math.abs(s-c)+Math.abs(l-f)>1&&r[p*e+d]>t?(a(c,f,s,l,d,p),a(h,u,c,f,d,p)):(n[l*e+s]=n[l*e+s]||++i,n[u*e+h]=n[u*e+h]||++i,n[f*e+c]=n[f*e+c]||++i,o++)}n.fill(0),a(0,0,s,s,s,0),a(s,s,0,0,0,s);const l=new Uint16Array(2*i),h=new Uint32Array(3*o);let u=0;function c(i,o,s,a,f,d){const p=i+s>>1,g=o+a>>1;if(Math.abs(i-f)+Math.abs(o-d)>1&&r[g*e+p]>t)c(f,d,i,o,p,g),c(s,a,f,d,p,g);else{const t=n[o*e+i]-1,r=n[a*e+s]-1,c=n[d*e+f]-1;l[2*t]=i,l[2*t+1]=o,l[2*r]=s,l[2*r+1]=a,l[2*c]=f,l[2*c+1]=d,h[u++]=t,h[u++]=r,h[u++]=c}}return c(0,0,s,s,s,0),c(s,s,0,0,0,s),{vertices:l,triangles:h}}getMeshWithSkirts(t=0,e){const{gridSize:n,indices:r}=this.martini,{errors:i}=this;let o=0,s=0;const a=n-1;let l,h,u=0;const c=[],f=[],d=[],p=[];function g(e,m,A,y,v,x){const _=e+A>>1,b=m+y>>1;Math.abs(e-v)+Math.abs(m-x)>1&&i[b*n+_]>t?(g(v,x,e,m,_,b),g(A,y,v,x,_,b)):(l=m*n+e,h=y*n+A,u=x*n+v,0===r[l]&&(0===e?c.push(o):e===a&&f.push(o),0===m?d.push(o):m===a&&p.push(o),r[l]=++o),0===r[h]&&(0===A?c.push(o):A===a&&f.push(o),0===y?d.push(o):y===a&&p.push(o),r[h]=++o),0===r[u]&&(0===v?c.push(o):v===a&&f.push(o),0===x?d.push(o):x===a&&p.push(o),r[u]=++o),s++)}let m;r.fill(0),g(0,0,a,a,a,0),g(a,a,0,0,0,a),m=e?2*(o+3*c.length-2+3*f.length-2+3*d.length-2+3*p.length-2):2*(o+c.length+f.length+d.length+p.length);const A=3*(s+2*(c.length-1)+2*(f.length-1)+2*(d.length-1)+2*(p.length-1)),y=new Uint16Array(m),v=new Uint32Array(A);let x=0;function _(e,o,s,a,l,h){const u=e+s>>1,c=o+a>>1;if(Math.abs(e-l)+Math.abs(o-h)>1&&i[c*n+u]>t)_(l,h,e,o,u,c),_(s,a,l,h,u,c);else{const t=r[o*n+e]-1,i=r[a*n+s]-1,u=r[h*n+l]-1;y[2*t]=e,y[2*t+1]=o,y[2*i]=s,y[2*i+1]=a,y[2*u]=l,y[2*u+1]=h,v[x++]=t,v[x++]=i,v[x++]=u}}_(0,0,a,a,a,0),_(a,a,0,0,0,a),c.sort(((t,e)=>y[2*t+1]-y[2*e+1])),f.sort(((t,e)=>y[2*e+1]-y[2*t+1])),d.sort(((t,e)=>y[2*e]-y[2*t])),p.sort(((t,e)=>y[2*t]-y[2*e]));let b,w,T,M,C=2*o,S=0;function I(t){S=t.length;for(let n=0;n<S-1;n++)b=t[n],w=t[n+1],T=C/2,M=(C+(e?6:2))/2,y[C++]=2*b,y[C++]=2*b+1,e&&(y[C++]=2*b,y[C++]=2*b+1,y[C++]=2*w,y[C++]=2*w+1),e?(v[x++]=T+1,v[x++]=T,v[x++]=T+2,v[x++]=T,v[x++]=M,v[x++]=T+2):(v[x++]=b,v[x++]=T,v[x++]=w,v[x++]=T,v[x++]=M,v[x++]=w);y[C++]=2*t[S-1],y[C++]=2*t[S-1]+1}I(c);const P=C;I(f);const E=C;I(d);const O=C;I(p);return{vertices:y,triangles:v,numVerticesWithoutSkirts:o,numTrianglesWithoutSkirts:s,leftSkirtIndex:P,rightSkirtIndex:E,bottomSkirtIndex:O,topSkirtIndex:C}}}const dI={};function pI(t,e,n,r){let i=dI[n];i||(i=dI[n]=new cI(n));const o=i.createTile(e).getMeshWithSkirts(t,!0),{triangles:s,vertices:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:u,topSkirtIndex:c}=o;let{numVerticesWithoutSkirts:f,numTrianglesWithoutSkirts:d}=o;f||(f=a.legnth/3,d=s.length/3);const p=a.length/2,g=new Float32Array(3*p),m=new Float32Array(2*p);let A=1/0,y=-1/0;const v=n-1;for(let x=0;x<p;x++){const t=a[2*x],r=a[2*x+1];if(x>=f){const e=t/2*3;let n,r=.001;(x-(x<l/2?f:x<h/2?l/2:x<u/2?h/2:u/2))%3==0?(n=0,r=0):n=g[e+2];g[3*x]=g[e],g[3*x+1]=g[e+1],g[3*x+2]=n,m[2*x]=g[e]/v+r,m[2*x+1]=-g[e+1]/v+r}else g[3*x]=1*t,g[3*x+1]=1*-r,g[3*x+2]=e[r*n+t],m[2*x]=t/v,m[2*x+1]=r/v;const i=g[g.length-1];i<A&&(A=i),i>y&&(y=i)}return{positions:g,texcoords:m,triangles:s,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:u,topSkirtIndex:c,numTrianglesWithoutSkirts:d,numVerticesWithoutSkirts:f,minHeight:A,maxHeight:y,terrainWidth:n}}function gI(t,e,n,r,i,o,s,a,l){const h={};for(let u=0;u<l;u++)h[u+""]=AI(t,e,n,r,i,o,s,a,u);return h}const mI=[];function AI(t,e,n,r,i,o,s,a,l){if((r-=l)<=0)return mI;const h=t.getTileSize().width,u=t._getTileOffset(r,i),c=o[0]-u[0],f=u[1]-o[1],d=t._getTileConfig(),p=t.getSpatialReference().getResolution(r),g=d.tileSystem.scale.y,m=1e-7;let A=0,y=0,v=a/=Math.pow(2,l),x=a;if(c<0?v+=Math.ceil(-c/h-m):c>0&&(A-=Math.ceil(c/h-m)),f>0?y-=Math.ceil(f/h-m):f<0&&(x+=Math.ceil(-f/h-m)),0===A&&0===y&&v<=1&&x<=1){const i=Math.floor(e*a);let o=Math.floor(n*a);const l=o;return g!==s&&(o=xI(d,o,p)),[{x:i,y:o,skinY:l,z:r,offset:u,tileSize:h,id:t._getTileId(i,o,r)}]}const _=[];for(let b=A;b<v;b++)for(let i=y;i<x;i++){const o=e*a+b;let l=n*a+i;const c=l;g!==s&&(l=xI(d,l,p)),_.push({x:o,y:l,skinY:c,z:r,offset:u,tileSize:h,id:t._getTileId(o,l,r)})}return _}function yI(t,e,n,r){let i=t/n*r/e;return i<1?(i=1/i,i=1/Math.round(i)):i=Math.round(i),i}function vI(t,e,n){const r=t.getResolution(e),i=e-Math.log(n/r)*Math.LOG2E;return{zoom:i,res:t.getResolution(i)}}function xI(t,e,n){const r=t.fullExtent,i=t.tileSize.width,o=Math.max(r.top,r.bottom),s=Math.min(r.top,r.bottom);return Math.ceil(o/i/n)-1-Math.floor(s/i/n)-e}function _I(t,e){const n=e*e,r=0!==t?new Float32Array(n):new Uint8Array(n);return r.fill(t),{data:r,width:e,height:e,max:t,min:t}}new i(0,0);const bI=_I(0,5),wI=pI(1,bI.data,bI.width);function TI(t,e,n){const r=n&&n.includes;if(r)for(const i in r)r[i]&&(n[i].uniformDeclares&&e.push(...n[i].uniformDeclares),n[i].defines&&zC(t,n[i].defines))}function MI(t,e){const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&zC(t,e[r].renderUniforms)}wI.empty=!0;var CI=Object.freeze({__proto__:null,fillIncludes:TI,setIncludeUniformValues:MI});const SI=[],II=[];class PI{constructor(t){this.layer=t,this.regl=t.getRenderer().regl,this.renderer=new f_(this.regl),this._leafScene=new __;const e=new Uint8Array(16);e.fill(255),this._emptyTileTexture=this.regl.texture({width:2,height:2,data:e}),this._resLoader=new g_(this._emptyTileTexture),this._createEmptyTerrainGeo()}setToRedraw(){this.layer.getRenderer().setToRedraw()}getMap(){return this.layer.getMap()}startFrame(t){t&&t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader),this.shader||this.initShader(t),this._leafScene.clear()}createTerrainMesh(t,e){const{mesh:n,image:r}=e;let i=e.terrainMesh;const{positions:o,texcoords:s,triangles:a,empty:l}=n;if(i&&i.geometry!==this._emptyTerrainGeometry)i.geometry.updateData("aPosition",o),i.geometry.updateData("aTexCoord",s),i.geometry.setElements(a);else{const t=l?this._emptyTerrainGeometry:new bx({aPosition:o,aTexCoord:s},a,0);i?i.geometry=t:(i=new h_(t,null,{disableVAO:!0}),t.generateBuffers(this.regl))}if(!i.uniforms.skin){const t=this.getEmptyTexture();i.setUniform("skin",t)}return i.setUniform("heightTexture",r),this.prepareMesh(i,t,e),i}_updateMaskDefines(t){const e=this.layer.getRenderer();e&&e.updateMaskDefines(t)}_getPositionMatrix(t){const e=this._getPointZ(100)/100,n=im(t);return hm(n,n,[1,1,e]),n}_getLocalTransform(t,e,n){const r=this.getMap(),i=this.layer.getTileSize().width,o=e.res/r.getGLRes(),s=i/(n-1),{extent2d:a,offset:l}=e;Lm(SI,(a.xmin-l[0])*o,(e.extent2d.ymax-l[1])*o,0);const h=im(t);return lm(h,h,SI),Lm(II,o*s,o*s,1),hm(h,h,II),h}prepareMesh(t,e,n){if(!t.isValid())return;const{mesh:r}=n;this._updateMaskDefines(t);const{triangles:i,numTrianglesWithoutSkirts:o,terrainWidth:s}=r;t.localTransform=this._getLocalTransform(t.localTransform||[],e,s),t.positionMatrix=this._getPositionMatrix(t.positionMatrix||[]),t.properties.skirtOffset=3*o,t.properties.skirtCount=i.length-3*o,t.properties.z=e.z,t.properties.minHeight=r.minHeight,t.properties.maxHeight=r.maxHeight,t.properties.terrainWidth=s,t.castShadow=!1,VC(t.uniforms,"minAltitude")||Object.defineProperty(t.uniforms,"minAltitude",{enumerable:!0,get:()=>n.minAltitude||0})}addTerrainImage(t,e){const n=e.terrainMesh;n&&n.geometry&&e.skin&&(n.setUniform("skin",e.skin.color[0]),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n))}endFrame(t){this.updateIBLDefines(this.shader);let e=0;const n=this.getUniformValues(),r=this._getRenderFBO(t);return this.shader.filter=t&&t.sceneFilter,MI(n,t),e+=this.renderer.render(this.shader,n,this._leafScene,r),e}delete(){this.shader&&(this.shader.dispose(),delete this.shader),this._emptyTileTexture&&(this._emptyTileTexture.destroy(),delete this._emptyTileTexture),this._emptyTerrainGeometry&&(this._emptyTerrainGeometry.dispose(),delete this._emptyTerrainGeometry)}deleteMesh(t){if(!t)return;const e=t.geometry;t.dispose(),e!==this._emptyTerrainGeometry&&e.dispose()}initShader(t){const e=[],n=[],r={},i=[];TI(r,i,t),this.shader=new U_({vert:"#define SHADER_NAME TERRAIN_MESH\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform float minAltitude;\nuniform mat4 projViewModelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform float heightScale;\nvarying vec2 vUv;\n#include <mask_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main() {\n    vec4 position = vec4(aPosition.xy, (aPosition.z + minAltitude) * heightScale, 1.0);\n    position = positionMatrix * position;\n    #ifdef HAS_MASK_EXTENT\n        gl_Position = projMatrix * getMaskPosition(position, modelMatrix);\n    #else\n        gl_Position = projViewModelMatrix * position;\n    #endif\n    vUv = aTexCoord;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(position);\n    #endif\n}",frag:"#define SHADER_NAME TERRAIN_MESH\nprecision mediump float;\nuniform sampler2D skin;\nuniform float polygonOpacity;\nvarying vec2 vUv;\n#include <mask_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\nvoid main() {\n    vec2 uv = vec2(vUv);\n    uv.y = 1.0 - uv.y;\n    vec4 color = texture2D(skin, uv);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        color.rgb = shadow_blend(color.rgb, shadowCoeff).rgb;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #ifdef HAS_MASK_EXTENT\n      gl_FragColor = setMask(gl_FragColor);\n    #endif\n}",uniforms:i.concat([{name:"modelViewMatrix",type:"function",fn:function(t,e){return am(n,e.viewMatrix,e.modelMatrix)}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return am(e,n.projViewMatrix,n.modelMatrix)}}]),defines:r,extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!1},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:()=>!!this.layer.options.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}}}_getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}getUniformValues(){const t=this.getMap(),e=t.projViewMatrix,n=this.layer.getRenderer().getMaskUniforms(),r={viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:e,heightScale:1};return zC(r,n),r}_getPointZ(t){const e=this.layer.getMap();if(!e)return null;return e.altitudeToPoint(t,e.getGLRes())}getEmptyTexture(){return this._emptyTileTexture}hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}_createEmptyTerrainGeo(){const t=wI,{positions:e,texcoords:n,triangles:r}=t;this._emptyTerrainGeometry=new bx({aPosition:e,aTexCoord:n},r,0),this._emptyTerrainGeometry.generateBuffers(this.regl)}}const{getIBLResOnCanvas:EI,getPBRUniforms:OI,loginIBLResOnCanvas:RI,logoutIBLResOnCanvas:kI}=xT.PBRUtils,LI={baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,roughnessFactor:1,metallicFactor:0,emitMultiplicative:1,outputSRGB:1,hsv:[0,0,0],contrast:1,alphaTest:0};class DI extends PI{constructor(...t){super(...t),this.createIBLTextures(),this._matVer=0}updateMaterial(t,e){this._matVer=e,this._material=this._material||{},zC(this._material,t),this.setToRedraw()}setMaterial(t,e){this._matVer=e,this._material=zC({},LI,t),this.setToRedraw()}createIBLTextures(){const t=this.getMap().getRenderer().canvas;RI(t,this.regl,this.getMap()),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.getMap().getRenderer().canvas;kI(t,this.getMap())}createTerrainMesh(t,e){const{mesh:n,image:r}=e,{positions:i,texcoords:o,triangles:s,leftSkirtIndex:a,rightSkirtIndex:l,bottomSkirtIndex:h,numVerticesWithoutSkirts:u}=n,c=new Int8Array(i.length);for(let v=2;v<c.length;v+=3)v<3*u?c[v]=1:v<a/2*3?c[v-2]=-1:v<l/2*3?c[v-2]=1:c[v-1]=v<h/2*3?-1:1;const f=new bx({aPosition:i,aTexCoord:o,aNormal:c},s,0);let d;f.createTangent(),delete f.data.aNormal,f.generateBuffers(this.regl),d=r?this.regl.texture({width:r.width,height:r.height,data:r,min:"linear",mag:"linear"}):this.getEmptyTexture();const p=this.getEmptyTexture(),g=zC({},LI,this.layer.options.material||{});g.skinTexture=p,g.terrainHeightTexture=d;const m=new xT.StandardMaterial(g),A=new h_(f,m);A.properties.matVer=this._matVer;const y=A.defines;return y.HAS_UV_FLIP=1,y.HAS_TERRAIN_NORMAL=1,y.HAS_MAP=1,A.defines=y,A.setUniform("terrainTileResolution",t.res),this.prepareMesh(A,t,e),A}addTerrainImage(t,e){const n=e.terrainMesh;if(n){if(this._material&&n.properties.matVer!==this._matVer){for(const t in this._material)n.material.set(t,this._material[t]);n.properties.matVer=this._matVer}e.skin&&n.material.set("skinTexture",e.skin),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n)}}getUniformValues(){const t=this.getMap(),e=t.getRenderer().canvas,{iblTexes:n,dfgLUT:r}=EI(e),i=OI(t,n,r),o=this.layer.getTileSize().width,s=this.layer.getRenderer().getMaskUniforms(),a=this._getPointZ(100)/100;return zC(i,{viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[e.width,e.height],polygonFill:[1,1,1,1],terrainHeightMapResolution:[o,o],terrainResolution:[e.width,e.height],terrainHeightScale:a,terrainUnpackFactors:[6553.6,25.6,.1,1e4]}),zC(i,s),i}initShader(t){const e={},n=[];TI(e,n,t),this.shader=new xT.StandardShader({uniforms:n,defines:e,extraCommandProps:this.getExtraCommandProps()})}delete(){return this.disposeIBLTextures(),super.delete()}}function NI(t,e,n,r){const i=FI.call(this,n,r);this._projViewMatrix=e;const{colorExtent:o,modeExtent:s}=this._extentPass.render(i,e);this._maskUniforms=this._maskUniforms||{},this._maskUniforms.mask_colorExtent=o,this._maskUniforms.mask_extent=t,this._maskUniforms.mask_modeExtent=s,this._maskUniforms.mask_hasFlatOut=BI.call(this,"flat-outside"),this._maskUniforms.mask_hasClipOut=BI.call(this,"clip-outside"),this._maskUniforms.mask_hasVideo=BI.call(this,"video"),this._maskUniforms.mask_heightRatio=n,this._maskUniforms.mask_heightOffset=r,this.setToRedraw()}function FI(t,e){const n=[],r=this.layer.getMasks();for(let i=0;i<r.length;i++){const o=r[i].getMesh(this.regl,t,e);o&&n.push(o)}return n}function zI(){if(!this._extentPass||!this._maskUniforms)return;const t=this._maskUniforms.mask_heightRatio,e=this._maskUniforms.mask_heightOffset,n=FI.call(this,t,e);this._extentPass.render(n,this._projViewMatrix);const r=this.layer.getMasks();for(let i=0;i<r.length;i++)"video"===r[i].getMode()&&r[i]._update()}function BI(t){const e=this.layer.getMasks();for(let n=0;n<e.length;n++)if(e[n].getMode()===t)return 1;return 0}function HI(){const t=this.layer.getMasks();if(!t)return!1;for(let e=0;e<t.length;e++)if("video"===t[e].getMode()&&t[e]._needUpdate())return!0;return!1}function jI(t){return class extends t{setMask(t,e,n,r){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this._extentPass?NI.call(this,t,e,n,r):this.regl?(this._extentPass=new Mb(this.regl,this.viewport),NI.call(this,t,e,n,r)):this.layer.once("contextcreate",(()=>{this._extentPass=new Mb(this.regl,this.viewport),NI.call(this,t,e,n,r)}),this)}needToRedraw(){return!!super.needToRedraw()||!!HI.call(this)}getMaskUniforms(){return HI.call(this)&&zI.call(this),this.layer.updateMaskExtent(),this._maskUniforms}getMaskDefines(){return this._maskDefines||(this._maskDefines={}),this._maskUniforms&&this._maskUniforms.mask_colorExtent?this._maskDefines.HAS_MASK_EXTENT=1:delete this._maskDefines.HAS_MASK_EXTENT,this._maskDefines}updateMaskDefines(t){const e=t.getDefines();delete e.HAS_MASK_EXTENT;zC(e,this.getMaskDefines()),t.setDefines(e)}_clearMask(){this._deleteMaskUniforms(),this._extentPass&&(this._extentPass.dispose(),delete this._extentPass),this.setToRedraw()}_deleteMaskUniforms(){delete this._maskUniforms}}}class UI{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){if(this.data){const t=this.data.values();for(const e of t)this.onRemove(e)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const r of n)t[e++]=r;return t}has(t){return this.data.has(t)}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),e}get(t){if(!this.has(t))return null;return this.data.get(t)}pop(){if(this.data.size<this.max)return null;const t=this.data.keys().next();return this.data.get(t.value).current?(this.max+=Math.ceil(this.max/2),null):this.getAndRemove(t.value)}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this}resetCurrent(t){this.data&&this.data.forEach((e=>{e.current=t}))}}const VI=new i(0,0),GI=new i(0,0),WI=new o(0,0,0,0),qI=new i(0,0),XI=new i(20,20),ZI={color:[0,0,0,0],depth:1,stencil:0};class YI extends(jI(r.TileLayerCanvasRenderer)){isDrawable(){return!0}getTempTileOnLoading(t,e){if(e.image&&!e.image.reset)return e;const n=this._createTerrainFromParent(t);return n.temp=!0,e.image||(e.image=n),delete e.image.reset,e.current=!0,e.info=t,zC(e.image,n),this._createMesh(e.image,t),e}_resetTerrainImage(t,e,n){e.reset=!0,delete e.data,delete e.loadTime,delete e.rendered,delete e.minAltitude;const r=t.id+"-temp",i=e.skinImages;if(i)for(let o=0;o<i.length;o++){const t=i[o];if(t){for(let e=0;e<t.length;e++){const i=t[e];i&&(i.refs.delete(r),i.refs.size||n.push(i))}delete t.currentSkins,delete t.tileIds}}delete e.sourceZoom,delete e.skinImages,delete e.skinStatus,delete e.skinTileIds,e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture)}_createTerrainFromParent(t,e){for(e=e||this.findParentTile(t);e&&e.image&&(-1===e.image.sourceZoom||e.image.originalError);)e=this.findParentTile(e.info);const n=(e&&e.info||t).res,r=this.getMap().pointAtResToDistance(1,1,n),i=e&&e.image&&e.image.data&&this._clipParentTerrain(e,t),o=i&&-1!==e.image.sourceZoom?e.info.z:-1;if(!i||i.width<=1){const n=this._findTileMinAltitude(t,e);return{data:_I(n||0,5),minAltitude:n,mesh:wI,sourceZoom:o}}const s=i.width;return{data:i,mesh:pI(r,i.data,s),sourceZoom:o}}_findTileMinAltitude(t,e){if(e&&e.minAltitude)return e.minAltitude;const{idx:n,idy:r,z:i}=t;for(let o=-1;o<=1;o++)for(let t=-1;t<=1;t++){if(0===o&&0===t)continue;const e=this.layer.getTileId(n+o,r+t,i),s=this.layer.tileInfoCache.get(e);if(s&&s.minAltitude)return s.minAltitude}return 0}consumeTile(t,e){if(t.empty&&!t.mesh){const n=this.findParentTile(e);if(!n||n.image&&n.image.empty){t.mesh=wI;const n=this._findTileMinAltitude(e);t.data=_I(n||0,5),t.minAltitude=n,t.sourceZoom=-1}else t=this._createTerrainFromParent(e,n)}this._createMesh(t,e),super.consumeTile(t,e),this._recenterMapOnTerrain(e)}_createMesh(t,e){if(t&&t.mesh){t.terrainMesh=this._painter.createTerrainMesh(e,t),e.minAltitude=t.data.min,e.maxAltitude=t.data.max,delete t.mesh;const n=this.layer.tileInfoCache;if(n&&e.parent&&!t.empty&&!t.temp){const t=n.get(e.parent);if(t){const{minAltitude:n,maxAltitude:r}=e;(void 0===t.minAltitude||t.minAltitude>n)&&(t.minAltitude=n),(void 0===t.maxAltitude||t.maxAltitude<r)&&(t.maxAltitude=r)}}}}_recenterMapOnTerrain(t){const e=this.getMap();if(e.updateCenterAltitude&&void 0===e.centerAltitude&&t.z===this.getCurrentTileZoom()){const n=e._getPrjCenter(),r=e._prjToPointAtRes(n,t.res,qI);t.extent2d.contains(r)&&e.updateCenterAltitude()}}draw(t,e){this._createPainter(),this._painter.startFrame(e),super.draw(t,e),this._endFrame(e)}drawTile(t,e){const n=this.getMap();if(!t||!n||!e)return;if(!this.drawingCurrentTiles&&!this.drawingChildTiles)return;let r=this.drawingCurrentTiles?this.getTileOpacity(e):1;r*=this.layer.options.opacity||1,this._painter.addTerrainImage(t,e,r)}_drawTiles(t,e,n,r,i,o){const s=[];GC(t,this._getTempTilesForMissed(o,s)),this._newTerrainTileCounter=0;const a=this.layer.getSkinCount(),l=new Set;for(let h=0;h<a;h++)this._renderChildTerrainSkin(h,t,l,s);for(let h=0;h<t.length;h++)this._renderTerrainMeshSkin(t[h].info,t[h].image);for(let h=0;h<s.length;h++)s[h]&&s[h].texture&&!s[h].refs.size&&(this._skinImageCache.delete(s[h].tile.id),this._deleteSkinImage(s[h]));return this._clearCachdeSkinImages(),super._drawTiles(...arguments)}_getTempTilesForMissed(t,e){const n=[];let r=this._tempTilesPool;r||(r=this._tempTilesPool=new UI(this.layer.options.tempTileCacheSize,(t=>{const{info:e,image:n}=t;this._deleteTerrainImage(e,n)}))),r.resetCurrent(!1);for(let i=0;i<t.length;i++){const o=t[i];let s;r.has(o.id)?s=r.getAndRemove(o.id):(s=r.pop(),s?s.image&&(this._resetTerrainImage(s.info,s.image,e),s.image.temp=!0):s={info:o}),s.current=!0,r.add(o.id,s),n.push(s)}for(let i=0;i<t.length;i++)this.getTempTileOnLoading(t[i],n[i]);return n}_clearCachdeSkinImages(){if(!this._skinImageCache)return;const t=this.getCurrentTimestamp();if(this._clearSkinImageTimestamp&&t-this._clearSkinImageTimestamp<1e3)return;const e=new Set;for(const n of this.tileCache.data.values())this._collectSkinImages(n,e);for(const n in this.tilesInView){const t=this.tilesInView[n];this._collectSkinImages(t,e)}if(this._tempTilesPool)for(const n of this._tempTilesPool.data.values())this._collectSkinImages(n,e);e.size&&(this._skinImageCache.forEach(((t,n)=>{e.has(n)||(this._deleteSkinImage(this._skinImageCache.get(n)),this._skinImageCache.delete(n))})),this._clearSkinImageTimestamp=t)}_collectSkinImages(t,e){const n=t.image&&t.image.skinImages;if(n&&n.length)for(let r=0;r<n.length;r++){const t=n[r]&&n.currentSkins;if(t)for(const n of t)e.add(n)}}_renderChildTerrainSkin(t,e,n,r){const i=this.layer.getSkinLayer(t).getRenderer();if(!i)return;const o=[];for(let s=0;s<e.length;s++){const{info:i,image:a}=e[s];if(this._prepareChildTerrainSkin(t,i,a,r)){const r=e[s].image.skinImages[t];for(let t=0;t<r.length;t++){const e=r[t].tile.info.id;n.has(e)||(o.push(r[t]),n.add(e))}}}i.renderTerrainSkin(this.regl,this.layer,o)}_prepareChildTerrainSkin(t,e,n,r){const i=this.getMap();if(delete n.path,!e||!i||!n)return!1;if(!n.terrainMesh)return!1;const o=this.layer.getSkinLayer(t),s=o.getRenderer();if(!s)return!1;n.skinImages||(n.skinImages=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]);const a=s.isAnimating&&s.isAnimating(),l=n.skinStatus[t],h=s.needToRefreshTerrainTileOnZooming&&s.needToRefreshTerrainTileOnZooming(),u=a||h&&n.renderedZoom!==i.getZoom();if(l&&!u)return!1;const c=o.getSpatialReference(),{x:f,y:d,z:p,res:g,offset:m}=e;let A=e.nw;A||(A=e.nw=this.getMap().pointAtResToCoord(e.extent2d.getMin(VI),e.res));const y=this.layer.getTileSize().width,{res:v,zoom:x}=vI(c,p,g),_=yI(v,o.getTileSize().width,g,y);let b=n.skinTileIds[t];if(!b){const e=this.layer._getTileConfig().tileSystem.scale.y;b=n.skinTileIds[t]=gI(o,f,d,x,A,m,e,_,JI)}const w=b[0];let T=!0;const M=[];for(let L=0;L<w.length;L++){const t=s.getCachedTile(w[L],!1);if(t)M.push(t);else{T=!1;const t=s.findParentTile(w[L]);t&&M.push(t)}}const C=n.skinImages[t]||[];C.currentSkins=C.currentSkins||new Set;const S=new Set;let I=!1;for(let L=0;L<C.length;L++){if(!C[L].tile){I=!0;continue}const t=C[L].tile.info.id;S.add(t)}if(!M.length)return C.currentSkins.clear(),n.skinImages[t]=[],!1;const P=M.length?M.map((t=>t.info.id)).join():M[0].info.id;if(!u&&!I&&C.tileIds===P)return!1;C.tileIds=P;let E=!1;C.currentSkins.clear(),C.length=0;const O=C.currentSkins;let R=e.id;n.temp&&(R+="-temp");for(let L=0;L<M.length;L++){const t=M[L].info.id;O.add(t);let e=this._getCachedSkinImage(t);e&&((k=e)&&k.texture)||(e={tile:zC({},M[L]),layer:o,refs:new Set,texture:s.createTerrainTexture(this.regl)},this._saveCachedSkinImage(t,e)),e.refs.add(R),C.push(e),E=!0}var k;return this._clearPrevSkinImages(e,n,S,O,r),E&&this._newTerrainTileCounter++,n.skinImages[t]=C,o.fire("renderterrainskin",{tile:e,skinTiles:M}),T&&(n.skinStatus[t]=1),!0}_clearPrevSkinImages(t,e,n,r,i){if(!n.size)return;let o=t.id;e.temp&&(o+="-temp");for(const s of n)if(!r||!r.has(s)){const t=this._getCachedSkinImage(s);this._deleteCachedSkinImage(t,o,i)}}_getCachedSkinImage(t){return this._skinImageCache||(this._skinImageCache=new Map),this._skinImageCache.get(t)}_saveCachedSkinImage(t,e){this._skinImageCache.set(t,e)}_renderTerrainMeshSkin(t,e){const n=this.getMap();if(!t||!n||!e)return;const r=e.skinImages,i=this._needRefreshTerrainSkins(e.renderedZoom);if(e.rendered&&!i)return;e.skin?(ZI.framebuffer=e.skin,this.regl.clear(ZI)):e.skin=this._createTerrainTexture(t,e),this._initSkinShader();const o=this.layer.options.debug,s=[],a=o&&[],l=this.layer.getTileSize().width;if(r)for(let h=0;h<r.length;h++){const e=r[h];for(let n=0;n<e.length;n++){const{tile:r,texture:i,layer:o}=e[n];if((r.info.offset[0]||r.info.offset[1])&&t.skinTileIds){const e=t.skinTileIds[o.getId()];for(let t=0;t<e.length;t++)if(r.info.x===e[t].x&&r.info.y===e[t].y){r.info.offset=e[t].offset;break}}const a=KI(t,r,l),h=e[n].skinMesh||new h_(this._skinGeometry);h.setUniform("skinTexture",i);const u=o.getOpacity();h.setUniform("opacity",BC(u)?1:u),h.setUniform("skinDim",a),h.setUniform("tileSize",l),h.setUniform("x",t.x),h.setUniform("y",t.y),e[n].skinMesh=h,s.push(h)}}if(o){const n=e.skinDebugMesh||new h_(this._skinGeometry);n.setUniform("tileSize",l);const r=e.debugTexture||this._createDebugTexture(t,l);e.debugTexture=r,e.skinDebugMesh=n,n.setUniform("opacity",1),n.setUniform("skinTexture",r),n.setUniform("skinDim",[0,0,1]),n.setUniform("tileSize",l),a.push(n)}if(s.length){this._skinScene.setMeshes(s);try{this.renderer.render(this._skinShader,null,this._skinScene,e.skin)}catch(S6){throw console.error(e),S6}}a&&a.length&&this.layer.options.debug&&(this._skinScene.setMeshes(a),this.renderer.render(this._skinShader,null,this._skinScene,e.skin)),e.rendered=this._isSkinReady(e),e.renderedZoom=n.getZoom()}_createDebugTexture(t,e){e*=2;const{x:n,y:r,z:i}=t,o=`terrain:${n}/${r}/${i}`,s=document.createElement("canvas");s.width=e,s.height=e;const a=s.getContext("2d");a.font="20px monospace";const l=this.layer.options.debugOutline;return a.fillStyle=l,a.strokeStyle=l,a.fillText(o,20,e-40),a.beginPath(),a.lineWidth=4,a.moveTo(0,0),a.lineTo(e,0),a.lineTo(e,e),a.lineTo(0,e),a.lineTo(0,0),a.stroke(),this.regl.texture({data:s,flipY:!0,mag:"linear",min:"linear"})}_createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,r=2*e,i=this.regl,o=t.colorsTexture;let s;s=o&&o instanceof Uint8Array?i.texture({data:o,min:"linear",mag:"linear",type:"uint8",width:n,height:r,flipY:!0}):i.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:r,flipY:!0});const a={width:n,height:r,colors:[s],colorFormat:"rgba",ignoreStatusCheck:!0,depthStencil:!1,depth:!1,stencil:!1},l=i.framebuffer(a);return l.colorTex=s,l}_endFrame(t){this._painter.endFrame(t)&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}_clipParentTerrain(t,e){const{image:n,info:r}=t,i=n.data,o=i.width,{extent2d:s,res:a}=r,{extent2d:l,res:h}=e,u=s.getWidth(),c=s.getHeight();let f=(l.xmin*h/a-s.xmin)/u*(o-1),d=(s.ymax-l.ymax*h/a)/c*(o-1);const p=(l.xmax*h/a-s.xmin)/u*(o-1);let g=Math.round(p-f);const m=Math.log2(g);g=Math.pow(2,Math.round(m))+1,f=Math.floor(f),d=Math.floor(d);const A=new Float32Array(g*g);let y=1/0,v=-1/0;for(let x=0;x<g;x++)for(let t=0;t<g;t++){let e=x+f,n=t+d;e>o-1?e=o-1:e<0&&(e=0),n>o-1?n=o-1:n<0&&(n=0);const r=i.data[e+n*o];A[x+t*g]=r,r<y&&(y=r),r>v&&(v=r)}return{width:g,height:g,data:A,min:y,max:v}}getTileOpacity(t){return this._isSkinReady(t)?super.getTileOpacity(t):(this.resetTileLoadTime(t),0)}_isSkinReady(t){const e=this.layer.getSkinCount();if(!e)return!0;if(!t.skinStatus)return!1;for(let n=0;n<e;n++)if(!t.skinStatus[n])return!1;return!0}_needRefreshTerrainSkins(t){const e=this.getMap().getZoom(),n=this.layer.getSkinLayers();for(let r=0;r<n.length;r++){const i=n[r]&&n[r].getRenderer();if(i){if(i.isAnimating&&i.isAnimating())return!0;if(i.needToRefreshTerrainTileOnZooming&&i.needToRefreshTerrainTileOnZooming()&&t!==e)return!0}}return!1}isValidCachedTile(t){const e=!t.image.skinStatus;return t.image&&!t.image.temp&&(e||this._isSkinReady(t.image))}isTileComplete(t){return t.image&&!t.image.temp&&this._isSkinReady(t.image)}_getTerrainWidth(){const t=this.layer.options;return BC(t.terrainWidth)?t.tileSize+1:t.terrainWidth}_getParentTileRequest(t,e){const n=this.layer.options.maxAvailableZoom-this.layer.options.zoomOffset,r=t.z-n,i=Math.pow(2,r),o=Math.floor(t.x/i),s=Math.floor(t.y/i),a=Math.floor(t.idx/i),l=Math.floor(t.idy/i),h=$I(o,s);this._parentRequests||(this._parentRequests={});const u=!this._parentRequests[h];return u&&e&&(this._parentRequests[h]=new Set,this._parentRequests[h].url=this.layer.getTileUrl(o,s,n+this.layer.options.zoomOffset)),{x:o,y:s,idx:a,idy:l,requests:this._parentRequests[h],isFirst:u,key:h}}loadTile(t){const e=this.layer,n=this._getTerrainWidth(),r=e.getSpatialReference().getResolution(t.z);let i=this.getMap().pointAtResToDistance(1,1,r);const o=e.options.zoomOffset||0,a=e.options.maxAvailableZoom&&e.options.maxAvailableZoom-o;if(a&&t.z>a){const n=this._createTerrainFromParent(t);if(-1!==n.sourceZoom)return this.onTileLoad(n,t),n;{const{requests:r,isFirst:o,x:s,y:l,idx:h,idy:u}=this._getParentTileRequest(t,!0);if(r.add(t),!o)return n;const c=t.z-a;i*=Math.pow(2,c);const f=[s,l,a,h,u,t.res*Math.pow(2,c),t.error*Math.pow(2,c)];t=e.createTileNode?e.createTileNode(...f):e._createTileNode(...f)}}const l=t.url,h={},u=e.options,c=e.getTileSize(),f={terrainWidth:n,type:u.type,accessToken:u.accessToken,cesiumIonTokenURL:u.cesiumIonTokenURL,error:i,colors:u.colors,tileSize:c?[c.width,c.height]:[256,256]};return this.workerConn.fetchTerrain(l,f,((e,n)=>{if(this._parentRequests){const e=$I(t.x,t.y),n=this._parentRequests[e];if(n&&n.size){this.tileCache.add(t.id,{info:t,image:h});for(const t of n)this.removeTileLoading(t)}delete this._parentRequests[e]}if(e){if(e.canceled)return;return console.warn(e),void this.onTileError(h,t)}s.extend(h,n),function(t,e=1){if(BC(e)||!t||!t.mesh||1===e)return;const n=t.mesh.positions;if(n)for(let r=0,i=n.length;r<i;r+=3)n[r+2]*=e}(h,this.layer.options.exaggeration),t.colorsTexture=h.colorsTexture,this.onTileLoad(h,t)})),h}deleteTile(t){if(!t||!t.image)return;super.deleteTile(t);const{info:e,image:n}=t;n.temp||(delete e.skinTileIds,this._deleteTerrainImage(t.info,n))}_deleteTerrainImage(t,e){const n=e.skin;n&&(n.destroy(),n.colorTex.destroy(),delete n.colorTex),e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture,e.skinDebugMesh.dispose(),delete e.skinDebugMesh);const r=e.skinImages;if(r&&r.length){let n=t.id;e.temp&&(n+="-temp");for(let t=0;t<r.length;t++){const e=r[t];if(e){for(let t=0;t<e.length;t++){if(!e[t]||!e[t].tile)continue;const r=e[t].tile.info.id,i=this._skinImageCache&&this._skinImageCache.get(r);i&&this._deleteCachedSkinImage(i,n)}e.length=0}}}e.terrainMesh&&this._painter.deleteMesh(e.terrainMesh),e.image&&e.image.close&&e.image.close(),delete e.skinImages,delete e.skin,delete e.skinStatus,delete e.skinTileIds,delete e.terrainMesh,delete e.image,delete e.data,delete e.mesh,delete e.rendered}_deleteCachedSkinImage(t,e,n){t&&(t.refs.delete(e),t.refs.size||(n?n.push(t):this._deleteSkinImage(t)))}_deleteSkinImage(t){if(!t||!t.tile)return;const e=t.tile.info.id,n=t.layer.getRenderer();delete t.canvas,delete t.layer,t.refs.clear(),t.texture&&(n?n.deleteTerrainTexture(t.texture):t.texture.destroy&&t.texture.destroy(),delete t.texture),t.skinMesh&&(t.skinMesh.dispose(),delete t.skinMesh),n&&(n.removeTileCache&&n.removeTileCache(e),n.deleteTile&&n.constructor.prototype.deleteTile.call(n,t.tile)),delete t.tile,this._skinImageCache.delete(e)}_clearSkinImageCache(){if(!this._skinImageCache)return;const t=this._skinImageCache.keys();for(const e of t){const t=this._getCachedSkinImage(e);this._deleteSkinImage(t)}this._skinImageCache.clear()}abortTileLoading(t,e){const n=this.layer,r=n.options.maxAvailableZoom&&n.options.maxAvailableZoom-n.options.zoomOffset;if(e)if(r&&e.z>r){const{requests:t,key:n}=this._getParentTileRequest(e);t&&t.size&&(t.delete(e),t.size||(delete this._parentRequests[n],this.workerConn&&this.workerConn.abortTerrain(t.url)))}else e&&e.url&&this.workerConn&&this.workerConn.abortTerrain(e.url);super.abortTileLoading(t,e)}onTileError(t,e){super.onTileError(t,e)}_getTerrainTileAtPrjCoord(t){const e=this.getCurrentTileZoom(),n=this.layer.getSpatialReference().getResolution(e),r=this.layer._getTileConfig().getTileIndex(t,n,this.layer.options.repeatWorld);return r.z=e,r}_queryTerrain(t,e,n,r,i){const o=this.layer.getMinZoom(),s=this._findTerrainData(e,n.x,n.y,n.z,o);if(s&&s.image&&s.image.data){const e=s.info.extent2d,o=s.info.res/i,a=r.x-e.xmin*o,l=e.ymax*o-r.y,h=this._queryAltitudeInHeights(s.image.data,a/(e.getWidth()*o),l/(e.getHeight()*o));t[0]=h,t[1]=null===h?0:+(s.info.z===n.z)}else t[0]=null,t[1]=0;return t}_findTerrainData(t,e,n,r,i){t||(t=this.layer._getTileId(e,n,r));const o=this.tilesInView[t]||this.tileCache.get(t);return!o&&r-1>=i?this._findTerrainData(null,Math.floor(e/2),Math.floor(n/2),r-1,i):o}_queryAltitudeInHeights(t,e,n){const{width:r,height:i,data:o}=t,s=Math.floor((r-1)*e),a=Math.floor((i-1)*n)*r+s;return void 0===o[a]?null:o[a]}_queryTileAltitude(t,e,n){t||(t={tiles:{},dirty:!0,complete:!1});const r=this.layer,i=this.getCurrentTileZoom(),o=r.getSpatialReference().getResolution(i),{xmin:s,ymin:a,xmax:l,ymax:h}=e,u=r._getTileConfig();VI.set(s,a)._multi(n);const c=u._getTileNum(VI,n,!0);GI.set(l,h)._multi(n);const f=u._getTileNum(GI,n,!0),d=Math.min(c.x,f.x),p=Math.max(c.x,f.x),g=Math.min(c.y,f.y),m=Math.max(c.y,f.y),A=n/o;VI.set(s,a)._multi(A),GI.set(l,h)._multi(A);const y=WI.set(VI.x,VI.y,GI.x,GI.y),v=r.getTileSize().width+1;y._expand(y.getWidth()/v),t.array=t.array||new Float32Array(v*v);const x=t.tiles;t.complete=!0,t.array.fill(0);for(let _=d;_<=p;_++)for(let e=g;e<=m;e++){const n=this.layer._getTileId(_,e,i);if(x[n])continue;const r=this.tileCache.get(n);r?(this._fillAltitudeData(t.array,r,y,v),t.dirty=!0,x[n]=1):(t.dirty=t.dirty||void 0!==t.tiles[n],t.tiles[n]&&delete t.tiles[n],t.complete=!1)}return t}_fillAltitudeData(t,e,n,r){const i=e.info.extent2d,o=i.intersection(n),{xmin:s,ymin:a,xmax:l,ymax:h}=o,{data:u}=e.image,c=u.width,f=n.getWidth()/r,d=Math.floor((s-n.xmin)/f),p=Math.floor((a-n.ymin)/f),g=Math.floor((l-n.xmin)/f)-d,m=Math.floor((h-n.ymin)/f)-p,A=i.getWidth()/c,y=Math.floor((s-i.xmin)/A),v=Math.floor((a-i.ymin)/A),x=Math.floor(f/A);for(let _=0;_<=g;_++)for(let e=0;e<=m;e++){const n=_+d+(p+e)*r;let i=0;for(let t=0;t<x;t++)for(let n=0;n<x;n++){const r=(y+Math.floor(_*x))*c+t+v+Math.floor(e*x)+n;i+=u.data[r]}t[n]=i/Math.max(x,1)}return t}clear(){return this.clearTempResources(),super.clear()}clearTempResources(){this._tempTilesPool&&(this._tempTilesPool.reset(),delete this._tempTilesPool),this._skinImageCache&&this._clearSkinImageCache()}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),this.clearTempResources(),this._skinShader&&(this._skinShader.dispose(),delete this._skinShader),this._skinGeometry&&(this._skinGeometry.dispose(),delete this._skinGeometry),delete this._parentRequests,super.onRemove(),this._painter&&(this._painter.delete(),delete this._painter)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new uI(t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},r=this.layer.getId();e.addLayer(r,n,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))}))}createContext(){this.canvas.gl&&this.canvas.gl.wrap?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this._createREGLContext(),this.renderer=new f_(this.regl),this.layer.fire("contextcreate",{regl:this.regl})}_createPainter(){const t=this._painter;"lit"===this.layer.options.shader||"pbr"===this.layer.options.shader?(t&&t.constructor===PI||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this._painter=new DI(this.layer),this.layer.fire("paintercreated")):(t&&t.constructor===DI||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this._painter=new PI(this.layer),this.layer.fire("paintercreated"))}_createREGLContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};e.preserveDrawingBuffer=!0,e.stencil=!0,this.glOptions=e,this.gl=this.gl||this._createGLContext(this.canvas,e),this.regl=gp.createREGL({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.glExtensions})}_createGLContext(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(Wp){}if(r)break}return r}resizeCanvas(t){this.canvas&&super.resizeCanvas(t)}clearCanvas(){this.canvas&&super.clearCanvas()}_initSkinShader(){if(this._skinShader)return;const t=this.layer.getTileSize().width;this._skinShader=new U_({vert:"#define SHADER_NAME TERRAIN_SKIN\nattribute vec2 aPosition;\nvoid main() {\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n}",frag:"#define SHADER_NAME TERRAIN_SKIN\nprecision mediump float;\nuniform float tileSize;\nuniform sampler2D skinTexture;\nuniform vec3 skinDim;\nuniform float opacity;\nvoid main() {\n    vec2 fragCoord = gl_FragCoord.xy / 2.0;\n    vec2 resolution = vec2(tileSize);\n    vec2 uv = (fragCoord - skinDim.xy) /  (resolution * skinDim.z);\n    if (uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0) {\n        gl_FragColor = texture2D(skinTexture, uv) * opacity;\n    } else {\n        gl_FragColor = vec4(0.0);\n    }\n}",extraCommandProps:{cull:{enable:!1},viewport:{x:0,y:0,width:2*t,height:2*t},depth:{enable:!1},stencil:{enable:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}});const e=new Int8Array([-1,-1,1,1,-1,1,1,1,-1,-1,1,-1]);this._skinGeometry=this._skinGeometry||new bx({aPosition:e},0,6,{positionSize:2}),this._skinGeometry.generateBuffers(this.regl),this._skinScene=this._skinScene||new __}updateMaterial(t){this._painter&&t&&this._painter.updateMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.updateMaterial(t,this._matVer++))}setMaterial(t){this._painter&&t&&this._painter.setMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.setMaterial(t,this._matVer++))}getAnalysisMeshes(){return this._painter&&this._painter._leafScene?this._painter._leafScene.getMeshes():[]}}const JI=1;function QI(t,e,n,r,i,o,s,a,l=0){t.font="20px monospace",t.fillStyle=n,XI.y=a-30,t.globalAlpha=1,t.fillText(e,XI.x+i,XI.y+o+l),t.globalAlpha=.6,t.strokeStyle=n,t.lineWidth=r,t.beginPath(),t.moveTo(i,o),t.lineTo(i+s,o),t.lineTo(i+s,o+a),t.lineTo(i,o+a),t.lineTo(i,o),t.stroke(),t.globalAlpha=1}function KI(t,e,n){const{res:r,extent2d:i,offset:o}=t,{info:s}=e,a=s.res/r,l=s.offset,h=s.extent2d.xmin*a,u=s.extent2d.ymin*a,c=o[0]-l[0],f=l[1]-o[1];return[h-i.xmin+c,-(i.ymin-u+f),a*s.tileSize/n]}function $I(t,e){return t+"-"+e}r.TileLayerCanvasRenderer.include({renderTerrainSkin(t,e,n){const r=this.layer.getTileSize().width,i=e.options.debug;for(let o=0;o<n.length;o++){const{tile:t,texture:e}=n[o];if(!t.image)continue;const s=document.createElement("canvas");n[o].canvas=s,s.width=r,s.height=r;const a=s.getContext("2d");if(a.drawImage(t.image,0,0),i){const{x:e,y:n,z:i}=t.info;QI(a,`${e}/${n}/${i}`,"yellow",1,0,0,r,r,-18)}e({data:s,width:r,height:r,flipY:!0,min:"linear mipmap linear",mag:"linear"})}},createTerrainTexture(t){const e=this.layer.getTileSize().width,n={width:e,height:e,flipY:!0,min:"linear mipmap linear",mag:"linear",depthStencil:!1,depth:!1,stencil:!1};return t.texture(n)},deleteTerrainTexture(t){t.destroy()}});const tP={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5,video:.6,elevate:.7},eP=[],nP=[1,1,1],rP={polygonFill:[255,0,0],polygonOpacity:.8},iP=new n(0,0),oP=new n(0,0),sP=[],aP=new n(0,0),lP=new i(0,0),hP=new i(0,0),uP=new i(0,0);class cP extends c{getMode(){return this._mode}remove(){const t=this.getLayer();return t?(t.removeMask(this),this._dispose(),super.remove(),this):this}getMesh(t,e,n){return this.isVisible()?(this._mesh||(this._mesh=this._createMesh(t,e,n)),this._updateUniforms(this._mesh,e,n),this._mesh):null}_createGeometry(t){const e=this.getMap(),n=this.toGeoJSON(),r=yT.flatten(n.geometry.coordinates),i=r.dimensions;for(let u=0;u<r.vertices.length;u+=i){aP.x=r.vertices[u],aP.y=r.vertices[u+1];const t=ZC(e,aP);r.vertices[u]=t[0],r.vertices[u+1]=t[1]}const o=ZC(e,this.getCenter()),s=[],a="video"===this.getMode()?4:r.vertices.length/i;for(let u=0;u<a;u++)s.push(r.vertices[u*i]-o[0]),s.push(r.vertices[u*i+1]-o[1]),s.push(0);const l=yT(s,r.holes,3),h=new bx({POSITION:s,TEXCOORD:this._createTexcoords(r.vertices,i)},l,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});return h.generateBuffers(t),h}_createTexcoords(t,e){const n=[0,0,1,0,1,1,0,1];if(this.hasHoles()){const r=t.length/e*2;for(let t=n.length/2-1;t<r;t+=2)n[t]=n[t+1]=0}return n}clearMesh(){this._dispose(),delete this._mesh,this.maskGeoJSON&&(this.maskGeoJSON=null)}_getMaskMode(){return tP[this._mode]}_getMaskColor(){const t=this.getSymbol(),{polygonFill:e,polygonOpacity:n}=t||rP,r=qC([],e);return r[0]/=255,r[1]/=255,r[2]/=255,r[3]=HC(n)?n:rP.polygonOpacity,r}_altitudeToPoint(t=0){const e=this.getMap(),n=e.getGLRes();return e.altitudeToPoint(t,n)}_setLocalTransform(t){const e=ZC(this.getMap(),this.getCenter()),n=ym(t.localTransform,FA(eP),e,nP);t.localTransform=n}_dispose(){this._mesh&&(this._mesh.material&&this._mesh.material.dispose(),this._mesh.geometry&&this._mesh.geometry.dispose(),this._mesh.dispose(),delete this._mesh)}containsPoint(t){const e=this.getExtent();if(aP.set(t[0],t[1]),!e||!e.contains(aP))return!1;const n=this.getHoles();for(let i=0;i<n.length;i++)if(this._contains(n[i],t))return!1;const r=this.getShell();return this._contains(r,t)}_contains(t,e){const n=this._calArea(t);let r=0;for(let i=0;i<t.length;i++){iP.x=t[i].x,iP.y=t[i].y;const n=i+1>=t.length?0:i+1;oP.x=t[n].x,oP.y=t[n].y,aP.x=e[0],aP.y=e[1],sP[0]=aP,sP[1]=iP,sP[2]=oP;r+=this._calArea(sP)}return!(Math.abs(r-n)>1e-8)}_calArea(t){const e=this.getMap();let n=0;const r=e.getGLRes(),i=e.coordToPointAtRes(t[0],r,lP);for(let l=1;l<t.length-1;l++){const h=e.coordToPointAtRes(t[l],r,hP),u=e.coordToPointAtRes(t[l+1],r,uP);n+=Math.abs((o=i,a=u,((s=h).x-o.x)*(a.y-o.y)-(s.y-o.y)*(a.x-o.x)))/2}var o,s,a;return n}}const fP=["shapechange","heightrangechange","flatheightchange"],dP=new n(0,0),pP=[0,0,0],gP=[0,0,0];function mP(){return this._maskList?(this._maskList.forEach((t=>{t.remove()})),this._maskList=[],this.updateMaskExtent("shapechange"),this):this}function AP(t){const e=this.getMap(),n=e.getView(),r=e.getFitZoom(t),i=t.getCenter();e.setView({center:i,zoom:r,pitch:0,bearing:0});const o=e.getExtent(),s=rm([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.projViewMatrix);return e.setView(n),{mapExtent:o,projViewMatrix:s}}function yP(){for(let t=0;t<this._maskList.length;t++)if(this._maskList[t].isVisible())return!0;return!1}function vP(t){return class extends t{removeMask(t){if(!this._maskList)return this;if(!t)return mP.call(this),this;const e=Array.isArray(t)?t:[t];for(let n=0;n<e.length;n++){const t=e[n],r=this._maskList.indexOf(t);r>-1&&this._maskList.splice(r,1)}return this.updateMaskExtent("shapechange"),this.fire("removemask",{masks:t}),this}setMask(t){return this.removeMask(null),this._maskList||(this._maskList=[]),Array.isArray(t)?t.forEach((t=>{this._maskList.push(t)})):this._maskList.push(t),this._maskList.forEach((t=>{t._bindLayer(this),t._updateCoordinates&&t._updateCoordinates()})),this.updateMaskExtent("shapechange"),this.fire("setmask",{masks:t}),this}onAdd(){super.onAdd(),this.updateMaskExtent("shapechange")}getMasks(){return this._maskList||[]}onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;"shapechange"===e&&t.target instanceof cP&&t.target.clearMesh(),t.target instanceof cP&&fP.indexOf(e)>-1&&this.updateMaskExtent(e),super.onGeometryEvent&&super.onGeometryEvent(t)}identifyMask(t,e){if(!this.getMap())return[];if(!this._maskList||!this._maskList.length)return[];const n=zC({},e);n.excludeMasks=!0;const r=this.identifyAtPoint(t,n),i=r.length&&r[0].coordinate;if(i){const t=this._maskList;if(!t)return[];const e=[];for(let n=0;n<t.length;n++){const r=t[n].getMode();!t[n].containsPoint(i)||"color"!==r&&"video"!==r||e.push(t[n])}return e}return[]}remove(){this._maskList&&this._maskList.length&&this._maskList.forEach((t=>{t.remove()})),super.remove()}updateMask(t){const e=this.getMap(),{projViewMatrix:n,mapExtent:r}=AP.call(this,t);dP.x=r.xmin,dP.y=r.ymin;const i=xP(pP,dP,e);dP.x=r.xmax,dP.y=r.ymax;const o=xP(gP,dP,e);return{projViewMatrix:n,extentInWorld:[i[0],i[1],o[0],o[1]]}}updateMaskExtent(t){if(!this._maskList)return;if(!this.getMap())return;const e=this.getRenderer();if(e&&!this._maskList.length)return void e._clearMask();if(e&&!yP.call(this))return e._deleteMaskUniforms(),void e.setToRedraw();const n=this.getMaskExtent();if(!n)return;const{extent:r,ratio:i,minHeight:o}=n;if(t||!this._maskProjViewMatrix||!this._maskExtentInWorld){const{projViewMatrix:t,extentInWorld:e}=this.updateMask(r);this._maskProjViewMatrix=t,this._maskExtentInWorld=e}e?e.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,o):this.once("renderercreate",(t=>{t.renderer.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,o)}))}getMaskExtent(){let t=1/0,e=1/0,n=-1/0,r=-1/0,i=-1/0,o=1/0,s=!1;const a=this.getMap().getExtent();for(let u=0;u<this._maskList.length;u++){const l=this._maskList[u];if(!l.isVisible())continue;const h=l.getExtent();if(h&&a.intersects(h)&&(s=!0,h.xmin<t&&(t=h.xmin),h.ymin<e&&(e=h.ymin),h.xmax>n&&(n=h.xmax),h.ymax>r&&(r=h.ymax),l._getHeightRange)){const t=l._getHeightRange();t[0]<o&&(o=t[0]),t[1]>i&&(i=t[1])}}if(!s)return null;const{ratio:l,minHeight:h}=function(t,e){const n=t===1/0?0:t,r=e===-1/0?0:e,i=Math.abs(r-n);return 0===i?{ratio:1,minHeight:0}:{ratio:Math.pow(i,-1),minHeight:n}}(o,i);return{extent:new f(t,e,n,r),ratio:l,minHeight:h}}}}function xP(t,e,r,i=0){if(!(r&&e instanceof n))return null;const o=r.coordinateToPointAtRes(e,r.getGLRes());return t[0]=o.x,t[1]=o.y,t[2]=i,t}const _P=new n(0,0),bP=new n(0,0),wP=new i(0,0),TP=[],MP={tileGrids:[],count:0},CP="01",SP="1";class IP extends(vP(d)){constructor(t,e){e&&!e.tileSystem&&("cesium"===e.type||"cesium-ion"===e.type?e.tileSystem=[1,1,-180,-90]:"tianditu"===e.type&&(e.tileSystem=[1,-1,-180,90])),super(t,e)}getTileUrl(t,e,n){let r=super.getTileUrl(t,e,n);return"mapbox"===this.options.type&&this.options.requireSkuToken&&(this._skuToken||(this._skuToken=this._createSkuToken()),r.indexOf("?")>-1?r+="&sku="+this._skuToken:r+="?sku="+this._skuToken),r}getMaxAvailableZoom(){return this.getSpatialReference().getMaxZoom()}_createSkuToken(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[SP,CP,t].join("")}setSkinLayers(t){this._skinLayers=t;const e=this.getRenderer();e&&(e.clear(),e.setToRedraw())}getSkinTiles(t){const e=this.getRenderer();if(!e)return MP;const n=e.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return MP;const r=t.getId(),i=this._getTileConfig().tileSystem.scale,s=t.getTileSize().width,a=n.tiles;if(!a.length)return MP;const l=this.getMap(),h=n.parents||TP,u=h.length,c=h.concat(a),f=t.getSpatialReference(),d=a[0].extent2d.getWidth(),p=i.x,g=i.y,m=[],A=[],y=new Set,v=this._getTileConfig().tileSystem.scale.y;for(let x=0;x<c.length;x++){const e=c[x],{res:n}=e;let i=e.nw;i||(i=e.nw=l.pointAtResToCoord(e.extent2d.getMin(wP),e.res));const{res:a,zoom:h}=vI(f,e.z,n),_=a/n,b=yI(a,s,n,d),{extent2d:w,offset:T}=e,M=b*e.x,C=b*e.y;if(e.skinTileIds||(e.skinTileIds={}),!e.skinTileIds[r]){const n=new Set,l=[],u=AI(t,e.x,e.y,h,i,T,g,b,0);for(let e=0;e<u.length;e++){const r=u[e];if(n.has(r.id))continue;r.idx=r.x,r.idy=r.y,r.res=a,r.url=t.getTileUrl(r.x,r.y,r.z+t.options.zoomOffset);const i=p*(r.x-M)*s,h=g*(r.skinY-C)*s,c=w.xmin*_+i,f=w.ymax*_+h,d=w.ymin*_+h;r.extent2d=v>0?new o(c,d,c+s,d+s):new o(c,f-s,c+s,f),n.add(r.id),l.push(r)}e.skinTileIds[r]=l}const S=e.skinTileIds[r];for(let t=0;t<S.length;t++)y.has(S[t].id)||(x<u?m.push(S[t]):A.push(S[t]),y.add(S[t].id))}return{tileGrids:[{extent:n.extent,tiles:A,parents:m,count:A.length}],count:A.length}}getSkinLayer(t){return this.getSkinLayers()[t]}getSkinLayers(){return this._skinLayers||TP}getSkinCount(){return this._skinLayers&&this._skinLayers.length||0}queryTerrainByProjCoord(t,e){e=e||[];const n=this.getRenderer();if(!n)return e[0]=null,e[1]=0,e;const r=this.getMap(),i=n._getTerrainTileAtPrjCoord(t);if(!i)return e[0]=null,e[1]=0,e;const o=r._prjToPointAtRes(t,1,wP);return n._queryTerrain(e,i.id,i,o,1)}queryTileTerrainByProjCoord(t,e,n,r){r=r||[];const i=this.getRenderer();if(!i)return r[0]=null,r[1]=0,r;const o=this.getMap()._prjToPointAtRes(t,1,wP);return i._queryTerrain(r,e,n,o,1)}queryTileTerrainByPointAtRes(t,e,n,r,i){i=i||[];const o=this.getRenderer();return o?o._queryTerrain(i,n,r,t,e):(i[0]=null,i[1]=0,i)}queryTerrain(t,e){e=e||[];if(!this.getRenderer())return e[0]=null,e[1]=0,e;const n=this.getMap().getProjection().project(t,_P);return this.queryTerrainByProjCoord(n,e)}queryTileMesh(t,e){const n=this.getRenderer();n&&n._queryTileMesh(t,e)}getTerrainTiles(t){const{x:e,y:n,z:r,res:i,offset:s}=t,a=t.extent2d.getWidth(),l=this._getTileConfig(),h=this.getSpatialReference(),{res:u,zoom:c}=vI(h,r,i),f=this.getTileSize().width,d=yI(u,f,i,a);let p=t.nw;p||(p=t.nw=this.getMap().pointAtResToCoord(t.extent2d.getMin(wP),t.res));const g=gI(this,e,n,c,p,s,l.tileSystem.scale.y,d,1)[0];for(let m=0;m<g.length;m++){const{x:t,y:e}=g[m],n=l.getTilePointNW(t,e,u,wP);g[m].res=u,g[m].extent2d=new o(n.x,n.y,n.x+f,n.y-f)}return g}isTerrainTileLoaded(t){const e=this.getRenderer();return!!e&&e.isTileCached(t)}updateMaterial(t){if(!t)return;this.options.material||(this.options.material={}),zC(this.options.material,t);const e=this.getRenderer();e&&e.updateMaterial(t)}setMaterial(t){if(!t)return;this.options.material=t;const e=this.getRenderer();e&&e.setMaterial(t)}_createTileNode(t,e,n,r,i,o,s,a,l,h){const u=this.getMap(),c=this.options.zoomOffset;if(!l){l=this._getTileConfig().getTilePrjExtent(t,e,o).convertTo((t=>u._prjToPointAtRes(t,o,bP)))}const f=this._getTileOffset(n);return{parent:a,layer:this.getId(),x:t,y:e,z:n,idx:r,idy:i,res:o,extent2d:l,id:h||this._getTileId(t,e,n),url:this.getTileUrl(t,e,n+c),offset:f,error:s,children:[]}}}IP.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,fadeAnimation:!1,fadeDuration:1e3/60*15,tileLimitPerFrame:2,newTerrainTileRenderLimitPerFrameOnInteracting:1,opacity:1,renderer:"gl",pyramidMode:1,tileSize:256,terrainWidth:65,backZoomOffset:0,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0,cesiumIonTokenURL:"https://api.cesium.com/v1/assets/1/endpoint?access_token=",tileRetryCount:0,shader:"default",terrainTileMode:!0,tempTileCacheSize:64,tileStackStartDepth:7,tileStackDepth:6,currentTilesFirst:!1,exaggeration:1,colors:[]}),IP.registerJSONType("TerrainLayer"),IP.registerRenderer("gl",YI);const PP=[],EP=[],OP=[],RP=[],kP=new i(0,0),LP=[],DP=[],NP=[],FP=[],zP=[],BP=[],HP=[],jP=[],UP=[];class VP{constructor(t,e,n=!0){this._from=t,this._to=e,this._isLngLat=n}setFromPoint(t){this._from=Array.isArray(t)?new n(t):t}setToPoint(t){this._to=Array.isArray(t)?new n(t):t}test(t,e,n={}){const r=n.count||0,i=[];let o=this._from,s=this._to;this._isLngLat&&(o=WP(e,this._from.x,this._from.y,this._from.z),s=WP(e,this._to.x,this._to.y,this._to.z));const a=new(void 0).Ray(o,s);for(let l=0;l<t.length;l++){const n=t[l];if(!this._checkBBox(n.getBoundingBox(),a))continue;const o=n.localTransform,s=n.geometry,h=s.data[s.desc.positionAttribute].array,u=s.data[s.desc.altitudeAttribute]&&s.data[s.desc.altitudeAttribute].array||LP,c=s.indices;if(!(h&&h.length&&c&&c.length))continue;const f=am(FP,o,n.positionMatrix),d=this._testMesh(n,a,e,h,u,c,s.desc.positionSize,f,r);if(d){const t={mesh:n,coordinates:d};if(i.push(t),0!==r&&i.length>=r)break}}return i}_testMesh(t,e,n,r,i,o,s,a,l){const h=[];for(let u=0;u<o.length&&!(u>t.properties.skirtOffset);u+=3){const t=o[u],c=o[u+1],f=o[u+2],d=Lm(zP,r[t*s],r[t*s+1],r[t*s+2]),p=this._toWorldPosition(EP,n,d,i[t]/100,a),g=Lm(BP,r[c*s],r[c*s+1],r[c*s+2]),m=this._toWorldPosition(OP,n,g,i[c]/100,a),A=Lm(HP,r[f*s],r[f*s+1],r[f*s+2]),y=this._toWorldPosition(RP,n,A,i[f]/100,a),v=Lm(PP,p,m,y),x=Km(DP,p,m),_=Km(NP,p,y),b=this._testIntersection(jP,v,e);if(b){const e=n.pointAtResToAltitude(b[2],n.getGLRes());kP.x=b[0],kP.y=b[1];const r=n.pointAtResToCoordinate(kP,n.getGLRes());if(r.z=e,h.push({coordinate:r,indices:[t,c,f],normal:qm([],x,_)}),0!==l&&h.length>=l)break}}return h.length?h:null}_toWorldPosition(t,e,n,r,i){let o;return s.isNumber(r)?(o=e.altitudeToPoint(r,e.getGLRes()),cA(t,n[0],n[1],0,1),TA(t,t,i),t[2]=o):(cA(t,n[0],n[1],n[2],1),TA(t,t,i)),t}_testIntersection(t,e,n){return n.intersectTriangle(e[0],e[1],e[2],!0,t)}_checkBBox(t,e){return!!t&&e.intersectBox(t,UP)}}const GP=new n(0,0);function WP(t,e,n,r){if(!t)return null;GP.set(e,n);const i=t.coordinateToPointAtRes(GP,t.getGLRes()),o=t.altitudeToPoint(r||0,t.getGLRes());return[i.x,i.y,o]}const qP=()=>{},XP=new n(0,0),ZP=[0,0,0],YP=[0,0,0],JP=[0,0,0];class QP extends u{static fromJSON(t){if(!t||"GroupGLLayer"!==t.type)return null;const e=t.layers.map((t=>u.fromJSON(t)));return new QP(t.id,e,t.options)}constructor(t,e,n){super(t,n),this.layers=e&&e.slice()||[],this.layers.forEach((t=>{if(t.getMap())throw new Error(`layer(${t.getId()} is already added on map`)})),this._checkChildren(),this.sortLayersByZIndex(),this._layerMap={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let t=0,e=this.layers.length;t<e;t++)this.layers[t].__group_gl_order=t;this.layers.sort($P)}}setSceneConfig(t){this.options.sceneConfig=t;const e=this.getRenderer();return e&&e.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this._getSceneConfig()))}_getSceneConfig(){return this.options.sceneConfig||{}}getGroundConfig(){return this._getSceneConfig().ground}getWeatherConfig(){return this._getSceneConfig().weather}addLayer(t,e){if(t.getMap())throw new Error(`layer(${t.getId()}) is already added on map`);if("gl"!==t.options.renderer)throw new Error(`layer(${t.getId()})'s renderer is canvas, not supported to be added to GroupGLLayer`);void 0===e?this.layers.push(t):this.layers.splice(e,0,t),this._checkChildren(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this._prepareLayer(t),this._updateTerrainSkinLayers(),n.setToRedraw(),this):this}removeLayer(t){s.isString(t)&&(t=this.getChildLayer(t));const e=this.layers.indexOf(t);if(e<0)return this;const n=t.getRenderer();n&&n.setTerrainHelper&&n.setTerrainHelper(null),t._doRemove(),this._unbindChildListeners(t),delete this._layerMap[t.getId()],this.layers.splice(e,1);const r=this.getRenderer();return r?(this._updateTerrainSkinLayers(),r.setToRedraw(),this):this}clearLayers(){const t=this.getLayers();for(let e=0;e<t.length;e++)t[e]&&t[e].remove();return this}_updatePolygonOffset(){let t=0;for(let n=0;n<this.layers.length;n++){const e=this.layers[n];e.setPolygonOffset&&e.getPolygonOffsetCount&&(t+=e.getPolygonOffsetCount())}let e=0;for(let n=this.layers.length-1;n>=0;n--){const r=this.layers[n];r.setPolygonOffset&&r.getPolygonOffsetCount&&(r.setPolygonOffset(e,t),e+=r.getPolygonOffsetCount())}this._polygonOffset=e}getPolygonOffsetCount(){return this._polygonOffset}getLayers(){return this.layers.slice()}_getLayers(){return this.layers}toJSON(){const t=[];if(this.layers)for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n&&(n&&n.toJSON&&t.push(n.toJSON()))}return{type:this.getJSONType(),id:this.getId(),layers:t,options:this.config()}}onLoadEnd(){this.layers.forEach((t=>{this._prepareLayer(t)})),this.options.terrain&&this._initTerrainLayer(),super.onLoadEnd()}_prepareLayer(t){const e=this.getMap();this._layerMap[t.getId()]=t,t._canvas=this.getRenderer().canvas,t._bindMap(e),t.once("renderercreate",this._onChildRendererCreate,this),t.remove=()=>(this.removeLayer(t),t.constructor.prototype.remove.call(t),delete t.remove,this),t.load(),this._bindChildListeners(t)}onRemove(){this._removeTerrainLayer(),this.layers.forEach((t=>{this._resetSkinLayer(t),t._doRemove(),this._unbindChildListeners(t)})),this._layerMap={},this.clearAnalysis(),super.onRemove()}getChildLayer(t){return this._layerMap[t]||null}getLayer(t){return this.getChildLayer(t)}_bindChildListeners(t){t.on("show hide",this._onLayerShowHide,this),t.on("idchange",this._onLayerIDChange,this)}_unbindChildListeners(t){t.off("show hide",this._onLayerShowHide,this),t.off("idchange",this._onLayerIDChange,this)}_onLayerShowHide(){const t=this.getRenderer();t&&t.setToRedraw()}_onLayerIDChange(t){const e=t.new,n=t.old,r=this.getLayer(n);delete this._layerMap[n],this._layerMap[e]=r}_onChildRendererCreate(t){t.renderer.clearCanvas=KP}_checkChildren(){const t={};this.layers.forEach((e=>{const n=e.getId();if(t[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);t[n]=1}))}addAnalysis(t){this._analysisTaskList=this._analysisTaskList||[],this._analysisTaskList.push(t);const e=this.getRenderer();e&&e.setToRedraw()}removeAnalysis(t){if(this._analysisTaskList){const e=this._analysisTaskList.indexOf(t);e>-1&&(this._analysisTaskList.splice(e,1),t.remove())}const e=this.getRenderer();e&&e.setToRedraw()}clearAnalysis(){this._analysisTaskList&&(this._analysisTaskList.forEach((t=>{t.remove()})),this._analysisTaskList=[]);const t=this.getRenderer();t&&t.setToRedraw()}identify(t,e){const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const o=r.coordToContainerPoint(new n(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=e.includeInternals,r=this.getLayers(),i=e&&e.childLayers||r,o=this.getMap();if(!o)return[];const s=BC(e.count)?1:e.count;let a=[];for(let l=i.length-1;l>=0;l--){const o=i[l];if(r.indexOf(o)<0||!o.identifyAtPoint)continue;const s=o.options.geometryEvents;if(n&&(void 0===s||!1===s||0===s))continue;if(o.isGeometryListening&&n&&e.eventTypes.indexOf("mousemove")>=0&&!o.isGeometryListening(e.eventTypes))continue;const h=o.identifyAtPoint(t,e);if(!h||!h.length)continue;const u=o.getId();for(let t=0;t<h.length;t++)h[t]&&(h[t].layer=u);a.push(...h)}if(e.orderByCamera){const t=o.cameraPosition;a.sort(((e,n)=>n.point?e.point?eA(e.point,t)-eA(n.point,t):1:-1))}return s&&(a=a.slice(0,s)),a}getTerrain(){return this.options.terrain}setTerrain(t){return this.options.terrain=t,this.getRenderer()?(this._initTerrainLayer(),this.getMap().updateCenterAltitude(),this):this}removeTerrain(){return this.setTerrain(null)}updateTerrainMaterial(t){this._terrainLayer&&t&&(this.options.terrain.material?zC(this.options.terrain.material,t):this.options.terrain.material=t,this._terrainLayer.updateMaterial(t))}_initTerrainLayer(){const t=this.getRenderer();t&&t.setToRedraw();const e=this.options.terrain;if(this._terrainLayer){const t=this._terrainLayer,n=t.options;if(e&&n.urlTemplate===e.urlTemplate&&n.spatialReference===e.spatialReference){for(const n in e)"material"===n?t.setMaterial(e[n]):"urlTemplate"!==n&&"spatialReference"!==n&&t.config(n,e[n]);return this}this._removeTerrainLayer()}if(this._resetTerrainSkinLayers(),!e)return this;this._terrainLayer=new IP("__terrain_in_group",e),this._updateTerrainSkinLayers();const n=this._terrainLayer;n.on("tileload",this._onTerrainTileLoad,this),this._prepareLayer(n);const r=e.masks;return r&&r.length?n.setMask(r):n.removeMask(),this.fire("terrainlayercreated"),this}queryTerrain(t,e){return this._terrainLayer?this._terrainLayer.queryTerrain(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}queryTerrainAtPoint(t){if(!this._terrainLayer)return null;const e=this._terrainLayer.getRenderer().getAnalysisMeshes();return this._queryRayCast(t,e)}query3DTilesAtPoint(t){const e=this._getLayers().filter((t=>t&&t.isGeo3DTilesLayer));if(!e.length)return null;for(let r=0;r<e.length;r++){if(!e[r].getRenderer())continue;const i=e[r].identifyAtPoint(t);if(i.length)return new n(i[0].coordinate)}return null}_queryRayCast(t,e){const n=this.getMap(),r=n.getGLRes();n.getContainerPointRay(YP,JP,t);const o=new VP(YP,JP,!1).test(e,n,{count:1}),s=[];o.forEach((t=>{t.coordinates.forEach((t=>{s.push(t.coordinate)}))}));const a=n.pointAtResToCoordinate(new i(YP[0],YP[1]),r,XP);a.z=YP[2]/n.altitudeToPoint(1,r);const l=Lm(ZP,a.x,a.y,a.z);return s.sort(((t,e)=>eA(t.toArray(),l)-eA(e.toArray(),l))),s[0]}queryTerrainByProjCoord(t,e){return this._terrainLayer?this._terrainLayer.queryTerrainByProjCoord(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}_updateTerrainSkinLayers(){if(!this._terrainLayer)return;const t=this.layers,e=[];for(let n=0;n<t.length;n++){if(!t[n])continue;const r=t[n],i=r.getRenderer();if(i.renderTerrainSkin){if(i.deleteTile===qP){e.push(t[n]);continue}r.getTiles=()=>this._terrainLayer&&this._terrainLayer.getSkinTiles(r),i.drawTileOnTerrain?i.drawTile=(...t)=>i.drawTileOnTerrain(...t):i.drawTile=qP,i.deleteTile=qP,e.push(t[n])}i.setTerrainHelper&&i.setTerrainHelper(this._terrainLayer)}this._terrainLayer.setSkinLayers(e)}_resetSkinLayer(t){if(!function(t){if(!t)return!1;const e=t.getRenderer();if(!e)return!1;return!!e.renderTerrainSkin}(t))return;const e=t.getRenderer();e&&(e.setTerrainHelper&&e.setTerrainHelper(null),e.clear&&e.clear(),delete e.drawTile,delete e.deleteTile),delete t.getTiles}_resetTerrainSkinLayers(){const t=this.layers;for(let e=0;e<t.length;e++)t[e]&&this._resetSkinLayer(t[e])}_onTerrainTileLoad(){const t=this.getRenderer();t&&t.setToRedraw()}_removeTerrainLayer(){if(this._terrainLayer){const t=this._terrainLayer;t.off("tileload",this._onTerrainTileLoad,this),this._unbindChildListeners(t),this._terrainLayer._doRemove(),delete this._terrainLayer,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this._terrainLayer}_bindMap(...t){if(this.options.single){const e=t[0].getLayers();for(let t=0;t<e.length;t++)if(e[t]instanceof QP)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...t)}fire(...t){if("layerload"===t[0]){const t=this._getLayers();for(const e of t){const t=e.getRenderer();t&&t.isRenderComplete()&&e.fire("layerload")}}super.fire(...t)}}function KP(){}function $P(t,e){const n=t.getZIndex()-e.getZIndex();return 0===n?t.__group_gl_order-e.__group_gl_order:n}var tE,eE;QP.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4,forceRedrawPerFrame:!1}),QP.registerJSONType("GroupGLLayer"),QP.registerRenderer("gl",oI),QP.registerRenderer("canvas",null),(eE=tE||(tE={}))[eE.AMBIENT=0]="AMBIENT",eE[eE.REALISTIC=1]="REALISTIC";class nE{constructor(t){this._map=t,this._loader=new g_}getDirectionalLight(){return this._config&&this._config.directional||{}}getAmbientLight(){return this._config&&this._config.ambient||{}}getAmbientResource(){return this._iblMaps}setConfig(t){const e=this._config;this._urlModifier=t.urlModifier,this._config=JSON.parse(JSON.stringify(t));let n=!1;if(t&&t.ambient&&t.ambient.resource){if(!(e&&e.ambient&&function(t,e){if(!t.resource)return!1;if(t.resource.url!==e.resource.url)return!1;return!0}(e.ambient,t.ambient)))return void this._initAmbientResources();this._iblMaps&&(t.ambient.prefilterCubeSize!==e.ambient&&e.ambient.prefilterCubeSize&&this._onHDRLoaded(),n=!0,t.ambient.resource.sh&&(this._iblMaps.sh=t.ambient.resource.sh))}else this._disposeCubeLight(),n=e&&e.ambient&&e.ambient.resource;this._map.fire("updatelights",{ambientUpdate:n})}_tryToGetREGLContext(t){const e=t.getLayers();for(let i=0;i<e.length;i++){const t=e[i]&&e[i].getRenderer();if(t&&t.regl)return t.regl}const n=document.createElement("canvas"),r=mp({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1}});return r._temp=!0,r}_initAmbientResources(){const t=this._config.ambient.resource,e=t&&t.url;if(!e)return;const n=[];let r=0,i=0;const o=()=>{i++,i>=r&&this._onSkyboxLoaded(n)},s=function(){throw new Error(`skybox image with url(${this.src}) failed to load, please check the image's url.`)},a=this._urlModifier;if(e.top||e.nx){const{front:t,back:i,right:l,left:h,top:u,bottom:c}=e,{nx:f,ny:d,px:p,py:g,nz:m,pz:A}=e;let y;y=t?[h,l,i,t,u,c]:[f,p,m,A,g,d],r=y.length;for(let e=0;e<r;e++){const t=new Image;t.onload=o,t.onerror=s,t.src=a&&a(y[e])||y[e],n[e]=t}}else{const e={url:t.url,arrayBuffer:!0,hdr:!0,flipY:!0};this._loader.setURLModifier(a),this._hdr=new O_(e,this._loader),this._hdr.once("complete",(()=>{this._onHDRLoaded()})),this._hdr.once("error",(()=>{this._onHDRError()}))}}dispose(){this._disposeCubeLight()}_onHDRLoaded(){this._hdr&&(this._iblMaps=this._createIBLMaps(this._hdr),this._map.fire("updatelights",{ambientUpdate:!0}))}_onHDRError(){this._map.fire("hdrerror")}_onSkyboxLoaded(t){this._iblMaps=this._createIBLMaps(t),this._map.fire("updatelights",{ambientUpdate:!0})}_createIBLMaps(t){const e=this._config.ambient.resource,n=e.prefilterCubeSize||512,r=this._tryToGetREGLContext(this._map),i=xT.PBRHelper.createIBLMaps(r,{envTexture:Array.isArray(t)?t:t.getREGLTexture(r),ignoreSH:!!e.sh,envCubeSize:n,prefilterCubeSize:n,environmentExposure:this._config.ambient.exposure,format:"array"});if(e.sh&&(i.sh=e.sh,Array.isArray(i.sh[0]))){const t=i.sh,e=[];for(let n=0;n<t.length;n++)e.push(...t[n]);i.sh=e}return r._temp&&(delete this._hdr,r.destroy()),i}_disposeCubeLight(){this._hdr&&(this._hdr.dispose(),delete this._hdr),delete this._iblMaps}}let rE,iE,oE,sE,aE;a.include({setLights(t){return this.options.lights=t,this._initLightManager(),this},getLights(){return this.options.lights},_initLightManager(){this._lightManager||(this._lightManager=new nE(this)),this._lightManager.setConfig(this.getLights())},getLightManager(){return this._lightManager?this._lightManager:null}}),a.addOnLoadHook((function(){this.options.lights&&this._initLightManager()}));const lE={color:[0,0,0,0]},hE={enable:!1};a.include({setPostProcessConfig(t){return this.options.postProcessConfig=t,this},getPostProcessConfig(){return this.options.postProcessConfig}});const uE=r.MapCanvasRenderer.prototype.drawLayerCanvas;r.MapCanvasRenderer.prototype.drawLayerCanvas=function(){const t=uE.apply(this,arguments);return t&&function(t,e){const n=t.map.getPostProcessConfig();if(!n||!n.enable)return;rE||(r=e.width,i=e.height,rE=document.createElement("canvas",r,i),iE=mp({canvas:rE,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),oE=iE.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:r,height:i}),sE=iE.texture());var r,i;rE.width===e.width&&rE.height===e.height||(rE.width=e.width,rE.height=e.height);iE.clear(lE);const o=n.filmicGrain||hE;void 0===o.enable&&(o.enable=!0);const s=n.vignette||hE;void 0===s.enable&&(s.enable=!0);const a=n.colorLUT||hE;void 0===a.enable&&(a.enable=!0);t._postProcessContext||(t._postProcessContext={});const l=t._postProcessContext;if(a.enable){const e=a.lut;if(!l.lutTexture||l.lutTexture.url!==e){const n=new Image;n.onload=function(){const r={data:n,min:"linear",mag:"linear"},i=l.lutTexture?l.lutTexture.texture(r):iE.texture(r);l.lutTexture={url:e,texture:i},t.setLayerCanvasUpdated()},n.src=e}}const h={enableGrain:+!!o.enable,grainFactor:void 0===o.factor?.15:o.factor,timeGrain:performance.now(),enableVignette:+!!s.enable,lensRadius:s.lensRadius||[.8,.25],frameMod:1,enableLut:+!!a.enable,lookupTable:l.lutTexture?l.lutTexture.texture:sE};aE||(aE=new ZS(iE));aE.postprocess(null,h,oE({width:rE.width,height:rE.height,data:e,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),o.enable&&t.setLayerCanvasUpdated();t.context.drawImage(rE,0,0,rE.width,rE.height)}(this,this.canvas),t};const cE=r.MapCanvasRenderer.prototype.renderFrame;r.MapCanvasRenderer.prototype.renderFrame=function(){const t=cE.apply(this,arguments),e=this.map.getPostProcessConfig(),n=e&&e.filmicGrain;return!n||void 0!==n.enable&&!0!==n.enable||this.setLayerCanvasUpdated(),t};const fE=[];function dE(t){t.properties.showOnlyTimestamp&&(delete t.properties.showOnlyTimestamp,gE(t))}function pE(t,e){const n=t.geometry.properties;n.oldElementsBeforeHighlight||(n.oldElementsBeforeHighlight=t.geometry.elements),n.elements&&(n.oldElementsArrBeforeHighlight||(n.oldElementsArrBeforeHighlight=n.elements),n.elements=e)}function gE(t){const e=t.geometry.properties.oldElementsBeforeHighlight;e&&t.geometry.elements!==e&&(t.geometry.deleteElements(),t.geometry.setElements(t.geometry.properties.oldElementsBeforeHighlight),t.geometry.properties.oldElementsArrBeforeHighlight&&(t.geometry.properties.elements=t.geometry.properties.oldElementsArrBeforeHighlight,delete t.geometry.properties.oldElementsArrBeforeHighlight),delete t.geometry.properties.hasInvisible,delete t.geometry.properties.oldElementsBeforeHighlight)}function mE(t){if(!t.properties.highlightTimestamp)return;const e=t.defines;delete e.HAS_HIGHLIGHT_COLOR,delete e.HAS_HIGHLIGHT_OPACITY,t.setDefines(e),delete t.properties.highlightTimestamp,gE(t),AE(t)}function AE(t){if(!t)return;const{hlBloomMesh:e}=t.properties;if(e){const n=e.geometry;n.elements&&n.elements.destroy&&n.deleteElements(),e.dispose(),delete t.properties.hlBloomMesh}}var yE=Object.freeze({__proto__:null,clearHighlight:mE,clearShowOnly:dE,deleteHighlightBloomMesh:AE,highlightMesh:function(t,e,n,r,i){const{highlightTimestamp:o}=e.properties;if(!n)return void(o&&mE(e));if(r===o)return;const s=e.geometry.getVertexCount();let{aHighlightColor:a,aHighlightOpacity:l}=e.geometry.properties;a&&a.fill(0),l&&l.fill(255);let h=!1,u=!1;const c=n.keys();let f=null,d=null;for(const m of c)if(i.has(m)){const t=n.get(m),{color:e,bloom:r,visible:o}=t;let c,{opacity:p}=t;if(e&&(h||(a||(a=new Uint8Array(4*s)),h=!0),c=XC(fE,e)),p=BC(p)?1:p,p<1&&(u||(l||(l=new Uint8Array(s),l.fill(255)),u=!0)),!1===o&&(d||(d=new Set),d.add(m)),c||p<1||r){const t=i.get(m);if(t)for(let e=0;e<t.length;e++){const n=t[e];c&&cA(a.subarray(4*n,4*n+4),...c),p<1&&(l[n]=255*p),r&&(f||(f=[]),f.push(n))}}}const p=e.defines;if(h?(e.geometry.data.aHighlightColor?e.geometry.updateData("aHighlightColor",a):(e.geometry.data.aHighlightColor=a,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightColor=a,p.HAS_HIGHLIGHT_COLOR=1):p.HAS_HIGHLIGHT_COLOR&&(e.geometry.updateData("aHighlightColor",a),delete p.HAS_HIGHLIGHT_COLOR),u?(e.geometry.data.aHighlightOpacity?e.geometry.updateData("aHighlightOpacity",l):(e.geometry.data.aHighlightOpacity=l,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightOpacity=l,p.HAS_HIGHLIGHT_OPACITY=1):p.HAS_HIGHLIGHT_OPACITY&&(e.geometry.updateData("aHighlightOpacity",l),delete p.HAS_HIGHLIGHT_OPACITY),d&&d.size>0){let n=[];i.forEach(((t,e)=>{d.has(e)||GC(n,t)})),e.geometry.properties.hasInvisible=!0,pE(e,n);const r={data:n,primitive:e.geometry.getPrimitive()};e.geometry.elements!==e.geometry.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.deleteElements(),n=t.elements(r),e.geometry.setElements(n),e.geometry.generateBuffers(t)}else e.geometry.properties.hasInvisible&&gE(e);e.setDefines(p),e.properties.highlightTimestamp=r;let g=e.properties.hlBloomMesh;if(f&&f.length){if(g){const t=rm(g.localTransform,e.localTransform),n=rm(g.positionMatrix,e.positionMatrix);g.setLocalTransform(t),g.setPositionMatrix(n),e.properties.hlBloomMesh.geometry.setElements(f)}else{const n=new bx(e.geometry.data,f,0,e.geometry.desc);n.generateBuffers(t);const r=e.material;g=new h_(n,r,e.config);const i=e.uniforms;for(const t in i)Object.defineProperty(g.uniforms,t,{enumerable:!0,get:function(){return e.getUniform(t)}});const o=zC({},e.defines);o.HAS_BLOOM=1;const s=rm([],e.localTransform),a=rm([],e.positionMatrix);g.setLocalTransform(s),g.setPositionMatrix(a),zC(g.properties,e.properties),zC(n.properties,e.geometry.properties),g.setDefines(o),g.bloom=1}e.properties.hlBloomMesh=g}else g&&AE(e)},showOnly:function(t,e,n,r,i){const{showOnlyTimestamp:o}=e.properties;if(!n)return void(o&&dE(e));if(r===o)return;e.properties.showOnlyTimestamp=r;const s=n.keys(),a=[];for(const h of s){if(!i.has(h))continue;const t=i.get(h);t&&GC(a,t)}pE(e,a),e.geometry.elements!==e.geometry.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.deleteElements();const l={data:a,primitive:e.geometry.getPrimitive()};e.geometry.setElements(t.elements(l)),e.geometry.generateBuffers(t)}});const vE=[0,0,0,0];class xE{constructor(t,e,n,r,i,o){this.renderer=new f_(t),this.sceneConfig=e,this._layer=n,this._colorStops=r,this._stencil=i,this._polygonOffset=o||{factor:0,units:0},this._init(),this._outputSize=[]}render(t,e,n){this._check();const r=this._layer.getMap();this.renderer.regl.clear({color:vE,depth:1,stencil:255,framebuffer:this._heatmapFBO}),this.renderer.render(this._heatmapShader,e,t,this._heatmapFBO);const i=this._layer.getRenderer().canvas;this._outputSize[0]=i.width,this._outputSize[1]=i.height;const o=zC({colorRamp:this._colorRampTex,inputTexture:this._heatmapFBO,projViewMatrix:r.projViewMatrix,textureOutputSize:this._outputSize},e);return this._transformGround(),this.renderer.render(this._displayShader,o,this._groundScene,n)}dispose(){this._heatmapShader&&(this._heatmapShader.dispose(),delete this._heatmapShader),this._displayShader&&(this._displayShader.dispose(),delete this._displayShader),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose(),delete this._ground,delete this._groundScene),this._heatmapFBO&&(this._heatmapFBO.destroy(),delete this._heatmapFBO)}_createColorRamp(){const t=this._colorStops;let e=this._rampCanvas,n=this._rampCtx;n?n.clearRect(0,0,256,1):(e=this._rampCanvas=document.createElement("canvas"),e.width=256,e.height=1,n=this._rampCtx=e.getContext("2d"));const r=n.createLinearGradient(0,0,256,1);for(let o=0;o<t.length;o++)r.addColorStop(t[o][0],t[o][1]);n.fillStyle=r,n.fillRect(0,0,256,1),this._colorRampTex&&this._colorRampTex.destroy();const i=this.renderer.regl;this._colorRampTex=i.texture({width:256,height:1,data:e,min:"linear",mag:"linear",premultiplyAlpha:!0})}_check(){const t=this._layer.getRenderer().canvas,e=Math.ceil(t.width/4),n=Math.ceil(t.height/4),r=this._heatmapFBO;r.width===e&&r.height===n||r.resize(e,n)}_init(){this._createColorRamp(),this._createShader(),this._createHeatmapTex(),this._createGround()}_createGround(){const t=new R_;t.generateBuffers(this.renderer.regl),this._ground=new h_(t),this._groundScene=new __([this._ground])}_transformGround(){const t=this._layer.getMap(),e=AS.getGroundTransform(this._ground.localTransform,t);this._ground.setLocalTransform(e)}_createHeatmapTex(){const t=this._layer.getRenderer().canvas,e=this.renderer.regl,n=e.hasExtension("OES_texture_half_float")?"half float":"float",r=Math.ceil(t.width/4),i=Math.ceil(t.height/4),o=e.texture({width:r,height:i,type:n,min:"linear",mag:"linear",format:"rgba"});this._heatmapFBO=e.framebuffer({width:r,height:i,color:[o]})}_createShader(){const t=this._layer.getRenderer().canvas,e=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>t?Math.ceil(t.width/4):1,height:()=>t?Math.ceil(t.height/4):1},depth:{enable:!0,func:"always"}};this._stencil&&(n.stencil=this._stencil),this._heatmapShader=new ib({extraCommandProps:n}),this._displayShader=new lb({x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},{extraCommandProps:{stencil:{enable:!1},depth:{enable:!0,range:e||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this._polygonOffset},scissor:{enable:!1}}})}}class _E extends cP{constructor(t,e){super(t,e)}_createMesh(t){const e=this._createGeometry(t),n=new h_(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t,e,n){const r=this._getMaskMode();t.setUniform("maskMode",r);const i=this._getMaskColor();if(t.setUniform("maskColor",i),HC(e)){const r=this._getHeightRange();r[0]=(r[0]-n)*e,r[1]=(r[1]-n)*e,t.setUniform("heightRange",r)}}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}getHeightRange(){return this.options.heightRange}_getHeightRange(){const t=[0,0];return this.options.heightRange&&(t[0]=this._altitudeToPoint(this.options.heightRange[0]),t[1]=this._altitudeToPoint(this.options.heightRange[1])),t}_setDefines(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}}class bE extends _E{constructor(t,e){super(t,e),this._mode="clip-inside"}}class wE extends _E{constructor(t,e){super(t,e),this._mode="clip-outside"}}class TE extends cP{constructor(t,e){super(t,e)}setFlatheight(t){this.options.flatHeight=t,this._fireEvent("flatheightchange")}_createMesh(t){const e=this._createGeometry(t),n=new h_(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t){const e=this._getMaskMode();t.setUniform("maskMode",e);const n=this._getMaskColor();t.setUniform("maskColor",n);const r=this._altitudeToPoint(this.options.flatHeight||0);t.setUniform("flatHeight",r)}_setDefines(t){const e=t.getDefines();e.HAS_MASK_FLAT=1,t.setDefines(e)}_getHeightRange(){const t=[0,this.options.flatHeight];return t[1]=this._altitudeToPoint(t[1]),t}}let ME=class extends TE{constructor(t,e){super(t,e),this._mode="flat-inside"}};class CE extends TE{constructor(t,e){super(t,e),this._mode="flat-outside"}}class SE extends cP{constructor(t,e){super(t,e),this._mode="color"}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}_createMesh(t){const e=this._createGeometry(t),n=new h_(e);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t,e,n){const r=this._getMaskMode();t.setUniform("maskMode",r);const i=this._getMaskColor();if(t.setUniform("maskColor",i),HC(e)){const r=this._getHeightRange();r[0]=(r[0]-n)*e,r[1]=(r[1]-n)*e,t.setUniform("heightRange",r)}}_setDefines(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}_getHeightRange(){const t=[0,0];return this.options.heightRange&&(t[0]=this._altitudeToPoint(this.options.heightRange[0]),t[1]=this._altitudeToPoint(this.options.heightRange[1])),t}}class IE extends cP{constructor(t,e){super(t,e),this._mode="video"}play(){this._video&&this._video.play()}pause(){this._video&&this._video.pause()}setAudio(t){this._video&&(this.video.muted=t)}setUrl(t){this.options.url=t,this._createVideo(t)}getState(){return this._videoState}_createMesh(t){const e=this._createGeometry(t),n=new h_(e),r=this._createVideoTexture(t);return n.material=new Kx({maskTexture:r}),this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(t){const e=this._getMaskMode();t.setUniform("maskMode",e);const n=this._getMaskColor();t.setUniform("maskColor",n)}_setDefines(t){const e=t.getDefines();e.HAS_VIDEO=1,t.setDefines(e)}_createVideoTexture(t){this._createVideo();return t.texture()}_createVideo(){this._videoState="stop";const t=this.options.url,e=this.options.elementId;let n=document.getElementById(e);if(t&&(n=document.createElement("video"),n.src=t),!n)throw new Error("there is no element or url setting for video mask");n.autoplay=this.options.autoplay||!0,n.loop=this.options.loop||!0,n.muted=this.options.muted||!0,n.play(),n.addEventListener("playing",(()=>{this._videoState="playing"})),n.addEventListener("pause",(()=>{this._videoState="pause"})),this._video=n}_update(){const t=this._mesh;if(t&&t.material){const e=t.material.get("maskTexture");e&&this._video&&this._needUpdate()&&e(this._video)}}_needUpdate(){return"playing"===this._videoState}}class PE extends TE{constructor(t,e){super(t,e),this.setElevation(e.elevation),this._mode="elevate"}setElevation(t){this.options.elevation=t,this.setFlatheight(this.options.elevation)}}const EE=new i(0,0),OE=new i(0,0),RE=new i(0,0),kE=new i(0,0);class LE extends _E{constructor(t,e){super([],e),this._position=t}setPosition(t){this._position=t,this._updateCoordinates()}getPosition(){return this._position}setWidth(t){this.options.width=t,this._updateCoordinates()}setLength(t){this.options.length=t,this._updateCoordinates()}setHeight(t){this.options.height=t,this._updateCoordinates()}setRotation(t){this.options.rotation=t,this._updateCoordinates()}_updateCoordinates(){const t=this.getLayer();if(!t)return;const e=t.getMap();if(e){const{length:t,width:n,height:r}=this.options,i=this._position,o=this.options.rotation||0,{coordinates:s,heightRange:a}=this._generateCoordinates(e,i,t,n,r,o);this.setCoordinates(s),this.setHeightRange(a)}}_generateCoordinates(t,e,n,r,i,o){const s=t.getGLRes(),a=t.distanceToPointAtRes(r/2,0,s,EE),l=t.distanceToPointAtRes(0,n/2,s,OE),h=t.coordinateToPointAtRes(e,s,RE),u=h.x-a.x,c=h.x+a.x,f=h.y+l.y,d=h.y-l.y,p=this._rotatePoint([[u,f],[c,f],[c,d],[u,d]],h,o);kE.set(p[0][0],p[0][1]);const g=t.pointAtResToCoordinate(kE,s);kE.set(p[1][0],p[1][1]);const m=t.pointAtResToCoordinate(kE,s);kE.set(p[2][0],p[2][1]);const A=t.pointAtResToCoordinate(kE,s);kE.set(p[3][0],p[3][1]);const y=t.pointAtResToCoordinate(kE,s),v=e.z-i/2,x=[v,e.z+i/2];return{coordinates:[[g.x,g.y,v],[m.x,m.y,v],[A.x,A.y,v],[y.x,y.y,v],[g.x,g.y,v]],heightRange:x}}_rotatePoint(t,e,n){for(let r=0;r<t.length;r++)qy(t[r],t[r],[e.x,e.y],n*Math.PI/180);return t}}class DE extends LE{constructor(t,e){super(t,e),this._mode="clip-inside"}}class NE extends LE{constructor(t,e){super(t,e),this._mode="clip-outside"}}"undefined"!=typeof window&&window.maptalks&&(window.maptalks.GroupGLLayer=QP,window.maptalks.ClipInsideMask=bE,window.maptalks.ClipOutsideMask=wE,window.maptalks.FlatInsideMask=ME,window.maptalks.FlatOutsideMask=CE,window.maptalks.ElevateMask=PE,window.maptalks.ColorMask=SE,window.maptalks.VideoMask=IE,window.maptalks.BoxInsideClipMask=DE,window.maptalks.BoxOutsideClipMask=NE,window.maptalks.RayCaster=VP);const FE=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},zE=FE(),BE=zE.gl_trans__coders=zE.gl_trans__coders||{};BE.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=zE.gl_trans__coders=zE.gl_trans__coders||{};let o=`${r}\n    const _____getGlobal = ${FE.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const s in i)"inject"!==s&&"getTranscoder"!==s&&"registerTranscoder"!==s&&(o+='tran_____scoders["'+s+'"] ='+i[s].toString()+"\n;");return o+="\n"+e.substring(r.length),o},BE.registerTranscoder=function(t,e){BE[t]=e},BE.getTranscoder=function(t){return BE[t]};const HE="${";let jE;l("@maptalks/terrain",`function(e){\n/*!\n     * @maptalks/gltf-loader v0.98.4\n     * LICENSE : UNLICENSED\n     * (c) 2016-2024 maptalks.org\n     */\nvar n,t,r="undefined"!=typeof Float32Array?Float32Array:Array;function o(){var e=new r(3);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function i(e,n,t){var o=new r(3);return o[0]=e,o[1]=n,o[2]=t,o}function a(){var e=new r(4);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,n=arguments.length;n--;)e+=arguments[n]*arguments[n];return Math.sqrt(e)}),o(),n=new r(4),r!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),o(),i(1,0,0),i(0,1,0),a(),a(),t=new r(9),r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1;let s=0;!function(e){e[0]=0,e[1]=0,e[2]=0,e[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const c={get:function(e,n={},t){n||(n={});const r=new AbortController,o=r.signal,i=function(e){for(let n=1;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}({},n);i.signal=o,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),t&&(e=t(e));const a=fetch(e,i).then((e=>{const t=this._(e,n.responseType);return t.message?t:t.then((t=>"arraybuffer"===n.responseType?{data:t,cacheControl:e.headers.get("Cache-Control"),expires:e.headers.get("Expires"),contentType:e.headers.get("Content-Type")}:t)).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}))})).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}));return a.xhr=r,a},_:(e,n)=>200!==e.status?{status:e.status,statusText:e.statusText,message:\`incorrect http request with status code(${HE}e.status}): ${HE}e.statusText}\`}:"arraybuffer"===n?e.arrayBuffer():"json"===n?e.json():e.text(),getArrayBuffer:(e,n={},t)=>(n||(n={}),n.responseType="arraybuffer",c.get(e,n,t)),getJSON:function(e,n={},t){return n&&n.jsonp?c.jsonp(e):((n=n||{}).responseType="json",c.get(e,n,t))},jsonp:function(e){const n="_maptalks_jsonp_"+s++;e.match(/\\?/)?e+="&callback="+n:e+="?callback="+n;let t=document.createElement("script");return t.type="text/javascript",t.src=e,new Promise((e=>{window[n]=function(r){document.getElementsByTagName("head")[0].removeChild(t),t=null,delete window[n],e(r)},document.getElementsByTagName("head")[0].appendChild(t)}))}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let e;try{e=new OffscreenCanvas(2,2).getContext("2d")}catch(r){}}"undefined"!=typeof document&&document.createElement("canvas"),function(){function e(e){throw e}var n=void 0,t=!0,r=this;function o(e,t){var o,i=e.split("."),a=r;!(i[0]in a)&&a.execScript&&a.execScript("var "+i[0]);for(;i.length&&(o=i.shift());)i.length||t===n?a=a[o]?a[o]:a[o]={}:a[o]=t}var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(n,t){this.index="number"==typeof t?t:0,this.i=0,this.buffer=n instanceof(i?Uint8Array:Array)?n:new(i?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var e,n=this.buffer,t=n.length,r=new(i?Uint8Array:Array)(t<<1);if(i)r.set(n);else for(e=0;e<t;++e)r[e]=n[e];return this.buffer=r},a.prototype.d=function(e,n,t){var r,o=this.buffer,i=this.index,a=this.i,s=o[i];if(t&&1<n&&(e=8<n?(d[255&e]<<24|d[e>>>8&255]<<16|d[e>>>16&255]<<8|d[e>>>24&255])>>32-n:d[e]>>8-n),8>n+a)s=s<<n|e,a+=n;else for(r=0;r<n;++r)s=s<<1|e>>n-r-1&1,8==++a&&(a=0,o[i++]=d[s],s=0,i===o.length&&(o=this.f()));o[i]=s,this.buffer=o,this.i=a,this.index=i},a.prototype.finish=function(){var e,n=this.buffer,t=this.index;return 0<this.i&&(n[t]<<=8-this.i,n[t]=d[n[t]],t++),i?e=n.subarray(0,t):(n.length=t,e=n),e};var s,c=new(i?Uint8Array:Array)(256);for(s=0;256>s;++s){for(var f=h=s,l=7,h=h>>>1;h;h>>>=1)f<<=1,f|=1&h,--l;c[s]=(f<<l&255)>>>0}var d=c;function u(e){this.buffer=new(i?Uint16Array:Array)(2*e),this.length=0}function v(e){var n,t,r,o,a,s,c,f,l,h,d=e.length,u=0,v=Number.POSITIVE_INFINITY;for(f=0;f<d;++f)e[f]>u&&(u=e[f]),e[f]<v&&(v=e[f]);for(n=1<<u,t=new(i?Uint32Array:Array)(n),r=1,o=0,a=2;r<=u;){for(f=0;f<d;++f)if(e[f]===r){for(s=0,c=o,l=0;l<r;++l)s=s<<1|1&c,c>>=1;for(h=r<<16|f,l=s;l<n;l+=a)t[l]=h;++o}++r,o<<=1,a<<=1}return[t,u,v]}function _(e,n){this.h=g,this.w=0,this.input=i&&e instanceof Array?new Uint8Array(e):e,this.b=0,n&&(n.lazy&&(this.w=n.lazy),"number"==typeof n.compressionType&&(this.h=n.compressionType),n.outputBuffer&&(this.a=i&&n.outputBuffer instanceof Array?new Uint8Array(n.outputBuffer):n.outputBuffer),"number"==typeof n.outputIndex&&(this.b=n.outputIndex)),this.a||(this.a=new(i?Uint8Array:Array)(32768))}u.prototype.getParent=function(e){return 2*((e-2)/4|0)},u.prototype.push=function(e,n){var t,r,o,i=this.buffer;for(t=this.length,i[this.length++]=n,i[this.length++]=e;0<t&&(r=this.getParent(t),i[t]>i[r]);)o=i[t],i[t]=i[r],i[r]=o,o=i[t+1],i[t+1]=i[r+1],i[r+1]=o,t=r;return this.length},u.prototype.pop=function(){var e,n,t,r,o,i=this.buffer;for(n=i[0],e=i[1],this.length-=2,i[0]=i[this.length],i[1]=i[this.length+1],o=0;!((r=2*o+2)>=this.length)&&(r+2<this.length&&i[r+2]>i[r]&&(r+=2),i[r]>i[o]);)t=i[o],i[o]=i[r],i[r]=t,t=i[o+1],i[o+1]=i[r+1],i[r+1]=t,o=r;return{index:e,value:n,length:this.length}};var m,g=2,x={NONE:0,r:1,k:g,N:3},p=[];for(m=0;288>m;m++)switch(t){case 143>=m:p.push([m+48,8]);break;case 255>=m:p.push([m-144+400,9]);break;case 279>=m:p.push([m-256+0,7]);break;case 287>=m:p.push([m-280+192,8]);break;default:e("invalid literal: "+m)}function A(e,n){this.length=e,this.G=n}_.prototype.j=function(){var r,o,s,c,f=this.input;switch(this.h){case 0:for(s=0,c=f.length;s<c;){var l,h,d,u=o=i?f.subarray(s,s+65535):f.slice(s,s+65535),v=(s+=o.length)===c,_=n,m=n,x=this.a,A=this.b;if(i){for(x=new Uint8Array(this.a.buffer);x.length<=A+u.length+5;)x=new Uint8Array(x.length<<1);x.set(this.a)}if(l=v?1:0,x[A++]=0|l,d=65536+~(h=u.length)&65535,x[A++]=255&h,x[A++]=h>>>8&255,x[A++]=255&d,x[A++]=d>>>8&255,i)x.set(u,A),A+=u.length,x=x.subarray(0,A);else{for(_=0,m=u.length;_<m;++_)x[A++]=u[_];x.length=A}this.b=A,this.a=x}break;case 1:var y=new a(i?new Uint8Array(this.a.buffer):this.a,this.b);y.d(1,1,t),y.d(1,2,t);var b,E,O,S=w(this,f);for(b=0,E=S.length;b<E;b++)if(O=S[b],a.prototype.d.apply(y,p[O]),256<O)y.d(S[++b],S[++b],t),y.d(S[++b],5),y.d(S[++b],S[++b],t);else if(256===O)break;this.a=y.finish(),this.b=this.a.length;break;case g:var C,M,H,k,N,P,D,R,U,L,F,z,W,G,V,j=new a(i?new Uint8Array(this.a.buffer):this.a,this.b),X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],K=Array(19);for(C=g,j.d(1,1,t),j.d(C,2,t),M=w(this,f),D=T(P=I(this.L,15)),U=T(R=I(this.K,7)),H=286;257<H&&0===P[H-1];H--);for(k=30;1<k&&0===R[k-1];k--);var B,q,Z,Y,J,$,Q=H,ee=k,ne=new(i?Uint32Array:Array)(Q+ee),te=new(i?Uint32Array:Array)(316),re=new(i?Uint8Array:Array)(19);for(B=q=0;B<Q;B++)ne[q++]=P[B];for(B=0;B<ee;B++)ne[q++]=R[B];if(!i)for(B=0,Y=re.length;B<Y;++B)re[B]=0;for(B=J=0,Y=ne.length;B<Y;B+=q){for(q=1;B+q<Y&&ne[B+q]===ne[B];++q);if(Z=q,0===ne[B])if(3>Z)for(;0<Z--;)te[J++]=0,re[0]++;else for(;0<Z;)($=138>Z?Z:138)>Z-3&&$<Z&&($=Z-3),10>=$?(te[J++]=17,te[J++]=$-3,re[17]++):(te[J++]=18,te[J++]=$-11,re[18]++),Z-=$;else if(te[J++]=ne[B],re[ne[B]]++,3>--Z)for(;0<Z--;)te[J++]=ne[B],re[ne[B]]++;else for(;0<Z;)($=6>Z?Z:6)>Z-3&&$<Z&&($=Z-3),te[J++]=16,te[J++]=$-3,re[16]++,Z-=$}for(r=i?te.subarray(0,J):te.slice(0,J),L=I(re,7),G=0;19>G;G++)K[G]=L[X[G]];for(N=19;4<N&&0===K[N-1];N--);for(F=T(L),j.d(H-257,5,t),j.d(k-1,5,t),j.d(N-4,4,t),G=0;G<N;G++)j.d(K[G],3,t);for(G=0,V=r.length;G<V;G++)if(z=r[G],j.d(F[z],L[z],t),16<=z){switch(G++,z){case 16:W=2;break;case 17:W=3;break;case 18:W=7;break;default:e("invalid code: "+z)}j.d(r[G],W,t)}var oe,ie,ae,se,ce,fe,le,he,de=[D,P],ue=[U,R];for(ce=de[0],fe=de[1],le=ue[0],he=ue[1],oe=0,ie=M.length;oe<ie;++oe)if(ae=M[oe],j.d(ce[ae],fe[ae],t),256<ae)j.d(M[++oe],M[++oe],t),se=M[++oe],j.d(le[se],he[se],t),j.d(M[++oe],M[++oe],t);else if(256===ae)break;this.a=j.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var y=function(){function n(n){switch(t){case 3===n:return[257,n-3,0];case 4===n:return[258,n-4,0];case 5===n:return[259,n-5,0];case 6===n:return[260,n-6,0];case 7===n:return[261,n-7,0];case 8===n:return[262,n-8,0];case 9===n:return[263,n-9,0];case 10===n:return[264,n-10,0];case 12>=n:return[265,n-11,1];case 14>=n:return[266,n-13,1];case 16>=n:return[267,n-15,1];case 18>=n:return[268,n-17,1];case 22>=n:return[269,n-19,2];case 26>=n:return[270,n-23,2];case 30>=n:return[271,n-27,2];case 34>=n:return[272,n-31,2];case 42>=n:return[273,n-35,3];case 50>=n:return[274,n-43,3];case 58>=n:return[275,n-51,3];case 66>=n:return[276,n-59,3];case 82>=n:return[277,n-67,4];case 98>=n:return[278,n-83,4];case 114>=n:return[279,n-99,4];case 130>=n:return[280,n-115,4];case 162>=n:return[281,n-131,5];case 194>=n:return[282,n-163,5];case 226>=n:return[283,n-195,5];case 257>=n:return[284,n-227,5];case 258===n:return[285,n-258,0];default:e("invalid length: "+n)}}var r,o,i=[];for(r=3;258>=r;r++)o=n(r),i[r]=o[2]<<24|o[1]<<16|o[0];return i}(),b=i?new Uint32Array(y):y;function w(r,o){function a(n,r){var o,i,a,s,c=n.G,f=[],l=0;switch(o=b[n.length],f[l++]=65535&o,f[l++]=o>>16&255,f[l++]=o>>24,t){case 1===c:i=[0,c-1,0];break;case 2===c:i=[1,c-2,0];break;case 3===c:i=[2,c-3,0];break;case 4===c:i=[3,c-4,0];break;case 6>=c:i=[4,c-5,1];break;case 8>=c:i=[5,c-7,1];break;case 12>=c:i=[6,c-9,2];break;case 16>=c:i=[7,c-13,2];break;case 24>=c:i=[8,c-17,3];break;case 32>=c:i=[9,c-25,3];break;case 48>=c:i=[10,c-33,4];break;case 64>=c:i=[11,c-49,4];break;case 96>=c:i=[12,c-65,5];break;case 128>=c:i=[13,c-97,5];break;case 192>=c:i=[14,c-129,6];break;case 256>=c:i=[15,c-193,6];break;case 384>=c:i=[16,c-257,7];break;case 512>=c:i=[17,c-385,7];break;case 768>=c:i=[18,c-513,8];break;case 1024>=c:i=[19,c-769,8];break;case 1536>=c:i=[20,c-1025,9];break;case 2048>=c:i=[21,c-1537,9];break;case 3072>=c:i=[22,c-2049,10];break;case 4096>=c:i=[23,c-3073,10];break;case 6144>=c:i=[24,c-4097,11];break;case 8192>=c:i=[25,c-6145,11];break;case 12288>=c:i=[26,c-8193,12];break;case 16384>=c:i=[27,c-12289,12];break;case 24576>=c:i=[28,c-16385,13];break;case 32768>=c:i=[29,c-24577,13];break;default:e("invalid distance")}for(o=i,f[l++]=o[0],f[l++]=o[1],f[l++]=o[2],a=0,s=f.length;a<s;++a)g[x++]=f[a];A[f[0]]++,y[f[3]]++,p=n.length+r-1,v=null}var s,c,f,l,h,d,u,v,_,m={},g=i?new Uint16Array(2*o.length):[],x=0,p=0,A=new(i?Uint32Array:Array)(286),y=new(i?Uint32Array:Array)(30),w=r.w;if(!i){for(f=0;285>=f;)A[f++]=0;for(f=0;29>=f;)y[f++]=0}for(A[256]=1,s=0,c=o.length;s<c;++s){for(f=h=0,l=3;f<l&&s+f!==c;++f)h=h<<8|o[s+f];if(m[h]===n&&(m[h]=[]),d=m[h],!(0<p--)){for(;0<d.length&&32768<s-d[0];)d.shift();if(s+3>=c){for(v&&a(v,-1),f=0,l=c-s;f<l;++f)_=o[s+f],g[x++]=_,++A[_];break}0<d.length?(u=E(o,s,d),v?v.length<u.length?(_=o[s-1],g[x++]=_,++A[_],a(u,0)):a(v,-1):u.length<w?v=u:a(u,0)):v?a(v,-1):(_=o[s],g[x++]=_,++A[_])}d.push(s)}return g[x++]=256,A[256]++,r.L=A,r.K=y,i?g.subarray(0,x):g}function E(e,n,t){var r,o,i,a,s,c,f=0,l=e.length;a=0,c=t.length;e:for(;a<c;a++){if(r=t[c-a-1],i=3,3<f){for(s=f;3<s;s--)if(e[r+s-1]!==e[n+s-1])continue e;i=f}for(;258>i&&n+i<l&&e[r+i]===e[n+i];)++i;if(i>f&&(o=r,f=i),258===i)break}return new A(f,n-o)}function I(e,n){var t,r,o,a,s,c=e.length,f=new u(572),l=new(i?Uint8Array:Array)(c);if(!i)for(a=0;a<c;a++)l[a]=0;for(a=0;a<c;++a)0<e[a]&&f.push(a,e[a]);if(t=Array(f.length/2),r=new(i?Uint32Array:Array)(f.length/2),1===t.length)return l[f.pop().index]=1,l;for(a=0,s=f.length/2;a<s;++a)t[a]=f.pop(),r[a]=t[a].value;for(o=function(e,n,t){function r(e){var t=v[e][_[e]];t===n?(r(e+1),r(e+1)):--d[t],++_[e]}var o,a,s,c,f,l=new(i?Uint16Array:Array)(t),h=new(i?Uint8Array:Array)(t),d=new(i?Uint8Array:Array)(n),u=Array(t),v=Array(t),_=Array(t),m=(1<<t)-n,g=1<<t-1;for(l[t-1]=n,a=0;a<t;++a)m<g?h[a]=0:(h[a]=1,m-=g),m<<=1,l[t-2-a]=(l[t-1-a]/2|0)+n;for(l[0]=h[0],u[0]=Array(l[0]),v[0]=Array(l[0]),a=1;a<t;++a)l[a]>2*l[a-1]+h[a]&&(l[a]=2*l[a-1]+h[a]),u[a]=Array(l[a]),v[a]=Array(l[a]);for(o=0;o<n;++o)d[o]=t;for(s=0;s<l[t-1];++s)u[t-1][s]=e[s],v[t-1][s]=s;for(o=0;o<t;++o)_[o]=0;for(1===h[t-1]&&(--d[0],++_[t-1]),a=t-2;0<=a;--a){for(c=o=0,f=_[a+1],s=0;s<l[a];s++)(c=u[a+1][f]+u[a+1][f+1])>e[o]?(u[a][s]=c,v[a][s]=n,f+=2):(u[a][s]=e[o],v[a][s]=o,++o);_[a]=0,1===h[a]&&r(a)}return d}(r,r.length,n),a=0,s=t.length;a<s;++a)l[t[a].index]=o[a];return l}function T(e){var n,t,r,o,a=new(i?Uint16Array:Array)(e.length),s=[],c=[],f=0;for(n=0,t=e.length;n<t;n++)s[e[n]]=1+(0|s[e[n]]);for(n=1,t=16;n<=t;n++)c[n]=f,f+=0|s[n],f<<=1;for(n=0,t=e.length;n<t;n++)for(f=c[e[n]],c[e[n]]+=1,r=a[n]=0,o=e[n];r<o;r++)a[n]=a[n]<<1|1&f,f>>>=1;return a}function O(n,t){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=i?new Uint8Array(n):n,this.s=!1,this.n=C,this.B=!1,!t&&(t={})||(t.index&&(this.c=t.index),t.bufferSize&&(this.m=t.bufferSize),t.bufferType&&(this.n=t.bufferType),t.resize&&(this.B=t.resize)),this.n){case S:this.b=32768,this.a=new(i?Uint8Array:Array)(32768+this.m+258);break;case C:this.b=0,this.a=new(i?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:e(Error("invalid inflate mode"))}}var S=0,C=1,M={D:S,C:C};O.prototype.p=function(){for(;!this.s;){var r=Z(this,3);switch(1&r&&(this.s=t),r>>>=1){case 0:var o=this.input,a=this.c,s=this.a,c=this.b,f=o.length,l=n,h=s.length,d=n;switch(this.e=this.g=0,a+1>=f&&e(Error("invalid uncompressed block header: LEN")),l=o[a++]|o[a++]<<8,a+1>=f&&e(Error("invalid uncompressed block header: NLEN")),l===~(o[a++]|o[a++]<<8)&&e(Error("invalid uncompressed block header: length verify")),a+l>o.length&&e(Error("input buffer is broken")),this.n){case S:for(;c+l>s.length;){if(l-=d=h-c,i)s.set(o.subarray(a,a+d),c),c+=d,a+=d;else for(;d--;)s[c++]=o[a++];this.b=c,s=this.f(),c=this.b}break;case C:for(;c+l>s.length;)s=this.f({v:2});break;default:e(Error("invalid inflate mode"))}if(i)s.set(o.subarray(a,a+l),c),c+=l,a+=l;else for(;l--;)s[c++]=o[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(K,q);break;case 2:var u,_,m,g,x=Z(this,5)+257,p=Z(this,5)+1,A=Z(this,4)+4,y=new(i?Uint8Array:Array)(P.length),b=n,w=n,E=n,I=n,T=n;for(T=0;T<A;++T)y[P[T]]=Z(this,3);if(!i)for(T=A,A=y.length;T<A;++T)y[P[T]]=0;for(u=v(y),b=new(i?Uint8Array:Array)(x+p),T=0,g=x+p;T<g;)switch(w=Y(this,u),w){case 16:for(I=3+Z(this,2);I--;)b[T++]=E;break;case 17:for(I=3+Z(this,3);I--;)b[T++]=0;E=0;break;case 18:for(I=11+Z(this,7);I--;)b[T++]=0;E=0;break;default:E=b[T++]=w}_=v(i?b.subarray(0,x):b.slice(0,x)),m=v(i?b.subarray(x):b.slice(x)),this.o(_,m);break;default:e(Error("unknown BTYPE: "+r))}}return this.t()};var H,k,N=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=i?new Uint16Array(N):N,D=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],R=i?new Uint16Array(D):D,U=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],L=i?new Uint8Array(U):U,F=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],z=i?new Uint16Array(F):F,W=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G=i?new Uint8Array(W):W,V=new(i?Uint8Array:Array)(288);for(H=0,k=V.length;H<k;++H)V[H]=143>=H?8:255>=H?9:279>=H?7:8;var j,X,K=v(V),B=new(i?Uint8Array:Array)(30);for(j=0,X=B.length;j<X;++j)B[j]=5;var q=v(B);function Z(n,t){for(var r,o=n.g,i=n.e,a=n.input,s=n.c,c=a.length;i<t;)s>=c&&e(Error("input buffer is broken")),o|=a[s++]<<i,i+=8;return r=o&(1<<t)-1,n.g=o>>>t,n.e=i-t,n.c=s,r}function Y(n,t){for(var r,o,i=n.g,a=n.e,s=n.input,c=n.c,f=s.length,l=t[0],h=t[1];a<h&&!(c>=f);)i|=s[c++]<<a,a+=8;return(o=(r=l[i&(1<<h)-1])>>>16)>a&&e(Error("invalid code length: "+o)),n.g=i>>o,n.e=a-o,n.c=c,65535&r}function J(e){if("string"==typeof e){var n,t,r=e.split("");for(n=0,t=r.length;n<t;n++)r[n]=(255&r[n].charCodeAt(0))>>>0;e=r}for(var o,i=1,a=0,s=e.length,c=0;0<s;){s-=o=1024<s?1024:s;do{a+=i+=e[c++]}while(--o);i%=65521,a%=65521}return(a<<16|i)>>>0}function $(n,t){var r,o;if(this.input=n,this.c=0,!t&&(t={})||(t.index&&(this.c=t.index),t.verify&&(this.M=t.verify)),r=n[this.c++],o=n[this.c++],(15&r)===Q)this.method=Q;else e(Error("unsupported compression method"));0!=((r<<8)+o)%31&&e(Error("invalid fcheck flag:"+((r<<8)+o)%31)),32&o&&e(Error("fdict flag is not supported")),this.A=new O(n,{index:this.c,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}O.prototype.o=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length-258;256!==(o=Y(this,e));)if(256>o)r>=c&&(this.b=r,t=this.f(),r=this.b),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r>=c&&(this.b=r,t=this.f(),r=this.b);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.I=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length;256!==(o=Y(this,e));)if(256>o)r>=c&&(c=(t=this.f()).length),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r+s>c&&(c=(t=this.f()).length);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.f=function(){var e,n,t=new(i?Uint8Array:Array)(this.b-32768),r=this.b-32768,o=this.a;if(i)t.set(o.subarray(32768,t.length));else for(e=0,n=t.length;e<n;++e)t[e]=o[e+32768];if(this.l.push(t),this.q+=t.length,i)o.set(o.subarray(r,r+32768));else for(e=0;32768>e;++e)o[e]=o[r+e];return this.b=32768,o},O.prototype.J=function(e){var n,t,r,o=this.input.length/this.c+1|0,a=this.input,s=this.a;return e&&("number"==typeof e.v&&(o=e.v),"number"==typeof e.F&&(o+=e.F)),2>o?t=(r=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+r:s.length<<1:t=s.length*o,i?(n=new Uint8Array(t)).set(s):n=s,this.a=n},O.prototype.t=function(){var e,n,t,r,o,a=0,s=this.a,c=this.l,f=new(i?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return i?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(n=0,t=c.length;n<t;++n)for(r=0,o=(e=c[n]).length;r<o;++r)f[a++]=e[r];for(n=32768,t=this.b;n<t;++n)f[a++]=s[n];return this.l=[],this.buffer=f},O.prototype.H=function(){var e,n=this.b;return i?this.B?(e=new Uint8Array(n)).set(this.a.subarray(0,n)):e=this.a.subarray(0,n):(this.a.length>n&&(this.a.length=n),e=this.a),this.buffer=e},$.prototype.p=function(){var n,t=this.input;return n=this.A.p(),this.c=this.A.c,this.M&&((t[this.c++]<<24|t[this.c++]<<16|t[this.c++]<<8|t[this.c++])>>>0!==J(n)&&e(Error("invalid adler-32 checksum"))),n};var Q=8;function ee(e,n){this.input=e,this.a=new(i?Uint8Array:Array)(32768),this.h=ne.k;var t,r={};for(t in!n&&(n={})||"number"!=typeof n.compressionType||(this.h=n.compressionType),n)r[t]=n[t];r.outputBuffer=this.a,this.z=new _(this.input,r)}var ne=x;function te(e,n){var t,r,i,a;if(Object.keys)t=Object.keys(n);else for(r in t=[],i=0,n)t[i++]=r;for(i=0,a=t.length;i<a;++i)o(e+"."+(r=t[i]),n[r])}ee.prototype.j=function(){var n,t,r,o,a,s,c,f=0;if(c=this.a,(n=Q)===Q)t=Math.LOG2E*Math.log(32768)-8;else e(Error("invalid compression method"));if(r=t<<4|n,c[f++]=r,n===Q)switch(this.h){case ne.NONE:a=0;break;case ne.r:a=1;break;case ne.k:a=2;break;default:e(Error("unsupported compression type"))}else e(Error("invalid compression method"));return o=a<<6,c[f++]=o|31-(256*r+o)%31,s=J(this.input),this.z.b=f,f=(c=this.z.j()).length,i&&((c=new Uint8Array(c.buffer)).length<=f+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,f+4)),c[f++]=s>>24&255,c[f++]=s>>16&255,c[f++]=s>>8&255,c[f++]=255&s,c},o("Zlib.Inflate",$),o("Zlib.Inflate.prototype.decompress",$.prototype.p),te("Zlib.Inflate.BufferType",{ADAPTIVE:M.C,BLOCK:M.D}),o("Zlib.Deflate",ee),o("Zlib.Deflate.compress",(function(e,n){return new ee(e,n).j()})),o("Zlib.Deflate.prototype.compress",ee.prototype.j),te("Zlib.Deflate.CompressionType",{NONE:ne.NONE,FIXED:ne.r,DYNAMIC:ne.k})}.call(self);var f="undefined"!=typeof Float32Array?Float32Array:Array;function l(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,n=arguments.length;n--;)e+=arguments[n]*arguments[n];return Math.sqrt(e)});function h(){var e=new f(3);return f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function d(e,n,t){var r=new f(3);return r[0]=e,r[1]=n,r[2]=t,r}function u(e,n){var t=n[0],r=n[1],o=n[2],i=t*t+r*r+o*o;return i>0&&(i=1/Math.sqrt(i)),e[0]=n[0]*i,e[1]=n[1]*i,e[2]=n[2]*i,e}function v(e,n,t){var r=n[0],o=n[1],i=n[2],a=t[0],s=t[1],c=t[2];return e[0]=o*c-i*s,e[1]=i*a-r*c,e[2]=r*s-o*a,e}var _=function(e,n,t){return e[0]=n[0]-t[0],e[1]=n[1]-t[1],e[2]=n[2]-t[2],e};function m(){var e=new f(4);return f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}h(),function(){var e,n=(e=new f(4),f!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var g;function x(e,n,t){return e[0]=n,e[1]=t,e}h(),d(1,0,0),d(0,1,0),m(),m(),g=new f(9),f!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[5]=0,g[6]=0,g[7]=0),g[0]=1,g[4]=1,g[8]=1,function(){var e=function(){var e=new f(2);return f!=Float32Array&&(e[0]=0,e[1]=0),e}()}(),\n/*!\n     * @maptalks/reshader.gl v0.101.1\n     * LICENSE : UNLICENSED\n     * (c) 2016-2024 maptalks.com\n     */\nl([]),l([]),new Array(16),function(){const e=new ArrayBuffer(4),n=new Float32Array(e),t=new Uint32Array(e),r=new Uint32Array(512),o=new Uint32Array(512);for(let e=0;e<256;++e){const n=e-127;n<-27?(r[e]=0,r[256|e]=32768,o[e]=24,o[256|e]=24):n<-14?(r[e]=1024>>-n-14,r[256|e]=1024>>-n-14|32768,o[e]=-n-1,o[256|e]=-n-1):n<=15?(r[e]=n+15<<10,r[256|e]=n+15<<10|32768,o[e]=13,o[256|e]=13):n<128?(r[e]=31744,r[256|e]=64512,o[e]=24,o[256|e]=24):(r[e]=31744,r[256|e]=64512,o[e]=13,o[256|e]=13)}const i=new Uint32Array(2048),a=new Uint32Array(64),s=new Uint32Array(64);for(let e=1;e<1024;++e){let n=e<<13,t=0;for(;!(8388608&n);)n<<=1,t-=8388608;n&=-8388609,t+=947912704,i[e]=n|t}for(let e=1024;e<2048;++e)i[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(s[e]=1024)}();const p={vsm_shadow_vert:"\\nuniform mat4 shadow_lightProjViewModelMatrix;\\nvarying vec4 shadow_vLightSpacePos;\\nvoid shadow_computeShadowPars(vec4 position) {\\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\\n}",vsm_shadow_frag:"\\nuniform sampler2D shadow_shadowMap;\\nuniform float shadow_opacity;\\nuniform vec3 shadow_color;\\n#if defined(USE_ESM)\\n    uniform float esm_shadow_threshold;\\n#endif\\nvarying vec4 shadow_vLightSpacePos;\\n#ifdef PACK_FLOAT\\n    #include <common_pack_float>\\n#endif\\n#if defined(USE_ESM)\\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\\n    float compare = projCoords.z;\\n    float c = 120.0;\\n    #ifdef PACK_FLOAT\\n        float depth = common_decodeDepth(shadowTexel);\\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\\n            return 1.0;\\n        }\\n    #else\\n        float depth = shadowTexel.r;\\n    #endif\\n    depth = exp(-c * min(compare - depth, 0.05));\\n    return clamp(depth, esm_shadow_threshold, 1.0);\\n}\\n#endif\\n#if defined(USE_VSM)\\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\\n    vec2 moments = shadowTexel.rg;\\n    float distance = projCoords.z;\\n    if (distance >= 1.0 || distance <= moments.x)\\n        return 1.0 ;\\n    float variance = moments.y - (moments.x * moments.x);\\n    variance = max(variance, 0.00002);\\n    float d = distance - moments.x;\\n    float p_max = variance / (variance + d * d);\\n    return p_max;\\n}\\n#endif\\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\\n    vec2 uv = projCoords.xy;\\n    vec4 shadowTexel = texture2D(shadowMap, uv);\\n    #if defined(USE_ESM)\\n        float esm_coeff = esm(projCoords, shadowTexel);\\n        float coeff = esm_coeff * esm_coeff;\\n    #endif\\n    #if defined(USE_VSM)\\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\\n        float coeff = vsm_coeff;\\n    #endif\\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\\n}\\nfloat shadow_computeShadow() {\\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\\n    projCoords = projCoords * 0.5 + 0.5;\\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\\n}\\nvec3 shadow_blend(vec3 color, float coeff) {\\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\\n    return color;\\n}",fbo_picking_vert:"\\n#ifdef ENABLE_PICKING\\n#if HAS_PICKING_ID == 1\\nattribute float aPickingId;\\n#elif HAS_PICKING_ID == 2\\nuniform float uPickingId;\\n#endif\\nvarying float vPickingId;\\nvarying float vFbo_picking_viewZ;\\nvarying float vFbo_picking_visible;\\n#endif\\nvarying float vFbo_picking_fragDepth;\\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\\n    #ifdef ENABLE_PICKING\\n    #if HAS_PICKING_ID == 1\\n       vPickingId = aPickingId;\\n    #elif HAS_PICKING_ID == 2\\n        vPickingId = uPickingId;\\n    #endif\\n        vFbo_picking_viewZ = viewPosZ;\\n    #endif\\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\\nfloat common_packFloat(vec4 val){\\n    vec4 scl = floor(255.0 * val + 0.5);\\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\\n    float man = 1.0 +\\n        (scl.r / 8388608.0) +\\n        (scl.g / 32768.0) +\\n        mod(scl.b, 128.0) / 128.0;\\n    return sgn * man * pow(2.0, exn);\\n}\\nvec4 common_unpackFloat(highp float v) {\\n    highp float av = abs(v);\\n    if(av < COMMON_FLOAT_MIN) {\\n        return vec4(0.0, 0.0, 0.0, 0.0);\\n    } else if(v > COMMON_FLOAT_MAX) {\\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\\n    } else if(v < -COMMON_FLOAT_MAX) {\\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\\n    }\\n    highp vec4 c = vec4(0,0,0,0);\\n    highp float e = floor(log2(av));\\n    highp float m = av * pow(2.0, -e) - 1.0;\\n    c[1] = floor(128.0 * m);\\n    m -= c[1] / 128.0;\\n    c[2] = floor(32768.0 * m);\\n    m -= c[2] / 32768.0;\\n    c[3] = floor(8388608.0 * m);\\n    highp float ebias = e + 127.0;\\n    c[0] = floor(ebias / 2.0);\\n    ebias -= c[0] * 2.0;\\n    c[1] += floor(ebias) * 128.0;\\n    c[0] += 128.0 * step(0.0, -v);\\n    return c / 255.0;\\n}\\nvec4 common_encodeDepth(const in float depth) {\\n    float alpha = 1.0;\\n    vec4 pack = vec4(0.0);\\n    pack.a = alpha;\\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\\n    pack.rgb = vec3(code * depth);\\n    pack.gb = fract(pack.gb);\\n    pack.rg -= pack.gb * (1.0 / 256.0);\\n    pack.b -= mod(pack.b, 4.0 / 255.0);\\n    return pack;\\n}\\nfloat common_decodeDepth(const in vec4 pack) {\\n    return pack.r + pack.g / 255.0;\\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return inverse(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\\n        float b00 = a00 * a11 - a01 * a10;\\n        float b01 = a00 * a12 - a02 * a10;\\n        float b02 = a00 * a13 - a03 * a10;\\n        float b03 = a01 * a12 - a02 * a11;\\n        float b04 = a01 * a13 - a03 * a11;\\n        float b05 = a02 * a13 - a03 * a12;\\n        float b06 = a20 * a31 - a21 * a30;\\n        float b07 = a20 * a32 - a22 * a30;\\n        float b08 = a20 * a33 - a23 * a30;\\n        float b09 = a21 * a32 - a22 * a31;\\n        float b10 = a21 * a33 - a23 * a31;\\n        float b11 = a22 * a33 - a23 * a32;\\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\\n        det = 1.0 / det;\\n        mat4 m = mat4(\\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\\n        );\\n        return m;\\n    #endif\\n}\\nmat4 transpose_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return transpose(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a12 = vector2.z, a13 = vector2.w;\\n        float a23 = vector3.w;\\n        mat4 m = mat4(\\n            vector1.x,\\n            vector2.x,\\n            vector3.x,\\n            vector4.x,\\n            a01,\\n            vector2.y,\\n            vector3.y,\\n            vector4.y,\\n            a02,\\n            a12,\\n            vector3.z,\\n            vector4.z,\\n            a03,\\n            a13,\\n            a23,\\n            vector4.w\\n        );\\n        return m;\\n    #endif\\n}",get_output:"#include <invert_matrix>\\n#include <draco_decode_vert>\\n#ifdef HAS_INSTANCE\\n    #include <instance_vert>\\n    #ifdef HAS_INSTANCE_COLOR\\n        varying vec4 vInstanceColor;\\n    #endif\\n#endif\\n#ifdef HAS_SKIN\\n    uniform int skinAnimation;\\n    #include <skin_vert>\\n#endif\\n#include <mask_vert>\\n#ifdef HAS_MORPH\\n    attribute vec3 POSITION0;\\n    attribute vec3 POSITION1;\\n    attribute vec3 POSITION2;\\n    attribute vec3 POSITION3;\\n    attribute vec3 POSITION4;\\n    attribute vec3 POSITION5;\\n    attribute vec3 POSITION6;\\n    attribute vec3 POSITION7;\\n    #ifdef HAS_MORPHNORMALS\\n        attribute vec3 NORMAL0;\\n        attribute vec3 NORMAL1;\\n        attribute vec3 NORMAL2;\\n        attribute vec3 NORMAL3;\\n    #endif\\n    uniform vec4 morphWeights1;\\n    uniform vec4 morphWeights2;\\n#endif\\n#ifdef HAS_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\n#endif\\nmat4 getPositionMatrix() {\\n    mat4 worldMatrix;\\n    #ifdef HAS_INSTANCE\\n        #ifdef HAS_INSTANCE_COLOR\\n            vInstanceColor = instance_getInstanceColor();\\n        #endif\\n        mat4 attributeMatrix = instance_getAttributeMatrix();\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\\n            } else {\\n                worldMatrix = attributeMatrix * positionMatrix;\\n            }\\n        #else\\n            worldMatrix = attributeMatrix * positionMatrix;\\n        #endif\\n    #else\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\\n            } else {\\n                worldMatrix = positionMatrix;\\n            }\\n        #else\\n            worldMatrix = positionMatrix;\\n        #endif\\n    #endif\\n    return worldMatrix;\\n}\\n#ifdef HAS_MIN_ALTITUDE\\nuniform float minAltitude;\\n#endif\\nvec4 getPosition(vec3 aPosition) {\\n    vec3 position = decode_getPosition(aPosition);\\n    #ifdef HAS_MORPH\\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\\n        , 1.0);\\n    #else\\n        vec4 POSITION = vec4(position, 1.0);\\n    #endif\\n    #ifdef HAS_TERRAIN_ALTITUDE\\n        POSITION.z += aTerrainAltitude * 100.0;\\n    #endif\\n    #ifdef HAS_MIN_ALTITUDE\\n        POSITION.z += minAltitude * 100.0;\\n    #endif\\n    return POSITION;\\n}\\nvec3 appendMorphNormal(vec3 NORMAL) {\\n    #ifdef HAS_MORPHNORMALS\\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\\n    #else\\n        vec3 normal = NORMAL;\\n    #endif\\n    return normal;\\n}",instance_vert:"attribute vec4 instance_vectorA;\\nattribute vec4 instance_vectorB;\\nattribute vec4 instance_vectorC;\\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\nuniform float terrainAltitudeScale;\\n#endif\\nmat4 instance_getAttributeMatrix() {\\n    mat4 mat =  mat4(\\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\\n    );\\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\n        mat4 terrainMat = mat4(\\n            1., 0., 0., 0.,\\n            0., 1., 0., 0.,\\n            0., 0., 1., 0.,\\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\\n        );\\n        mat = terrainMat * mat;\\n    #endif\\n    return mat;\\n}\\n#ifdef HAS_INSTANCE_HIGHLIGHT\\n    attribute vec4 highlight_color;\\n#endif\\n#ifdef HAS_INSTANCE_COLOR\\n   \\n    attribute vec4 instance_color;\\n    vec4 instance_getInstanceColor() {\\n        vec4 color = instance_color;\\n        #ifdef HAS_INSTANCE_HIGHLIGHT\\n            color = instance_color * highlight_color;\\n        #endif\\n        return color;\\n    }\\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\\nattribute vec4 JOINTS_0;\\nuniform sampler2D jointTexture;\\nuniform vec2 jointTextureSize;\\nuniform float numJoints;\\n#define ROW0_U ((0.5 + 0.0) / 4.)\\n#define ROW1_U ((0.5 + 1.0) / 4.)\\n#define ROW2_U ((0.5 + 2.0) / 4.)\\n#define ROW3_U ((0.5 + 3.0) / 4.)\\nmat4 skin_getBoneMatrix(float jointNdx) {\\n    float v = (jointNdx + 0.5) / numJoints;\\n    return mat4(\\n        texture2D(jointTexture, vec2(ROW0_U, v)),\\n        texture2D(jointTexture, vec2(ROW1_U, v)),\\n        texture2D(jointTexture, vec2(ROW2_U, v)),\\n        texture2D(jointTexture, vec2(ROW3_U, v)));\\n}\\nmat4 skin_getSkinMatrix() {\\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\\n        return skinMatrix;\\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\\nvarying vec2 heatmap_vTexCoord;\\nvoid heatmap_compute(mat4 matrix, vec3 position) {\\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\\n}\\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\\nuniform sampler2D heatmap_inputTexture;\\nuniform sampler2D heatmap_colorRamp;\\nuniform float heatmap_heatmapOpacity;\\nvarying vec2 heatmap_vTexCoord;\\nvec4 heatmap_getColor(vec4 color) {\\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\\n}\\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\\n    #define ALTITUDE_SCALE 32767.0;\\n    #define EXTRUDE_SCALE 63.0;\\n    attribute vec2 aExtrude;\\n    #ifdef HAS_LINE_WIDTH\\n        attribute float aLineWidth;\\n    #else\\n        uniform float lineWidth;\\n    #endif\\n    #ifdef HAS_LINE_HEIGHT\\n        attribute float aLineHeight;\\n    #else\\n        uniform float lineHeight;\\n    #endif\\n    uniform float linePixelScale;\\n    vec3 getLineExtrudePosition(vec3 position) {\\n        #ifdef HAS_LINE_WIDTH\\n            float lineWidth = aLineWidth / 2.0;\\n        #endif\\n        #ifdef HAS_LINE_HEIGHT\\n            float lineHeight = aLineHeight / 10.0;\\n        #endif\\n        float halfwidth = lineWidth / 2.0;\\n        float outset = halfwidth;\\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\\n        position.z *= lineHeight / ALTITUDE_SCALE;\\n        return position + vec3(dist, 0.0) * linePixelScale;\\n    }\\n#endif",gl2_vert:"#if __VERSION__ == 300\\n    #define texture2D texture\\n    #define varying out\\n    #define attribute in\\n#endif",gl2_frag:"#if __VERSION__ == 300\\n    #define varying in\\n    #define gl_FragDepthEXT gl_FragDepth\\n    #define texture2D texture\\n    #define textureCube texture\\n    #define texture2DProj textureProj\\n    #define texture2DLodEXT textureLod\\n    #define texture2DProjLodEXT textureProjLod\\n    #define textureCubeLodEXT textureLod\\n    #define texture2DGradEXT textureGrad\\n    #define texture2DProjGradEXT textureProjGrad\\n    #define textureCubeGradEXT textureGrad\\n    #define texture2D texture\\n    out vec4 glFragColor;\\n#else\\n    vec4 glFragColor;\\n#endif",hsv_frag:"\\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\\nconst mediump float HSV_E = 1.0e-10;\\nvec3 hsv_rgb2hsv(vec3 c) {\\n    vec4 K = HSV_K0;\\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\\n    float d = q.x - min(q.w, q.y);\\n    float e = HSV_E;\\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\\n}\\nvec3 hsv_hsv2rgb(vec3 c) {\\n    vec4 K = HSV_K1;\\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\\n}\\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return vec4(hsv_hsv2rgb(hsv), c.a);\\n}\\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return hsv_hsv2rgb(hsv);\\n}\\nmat4 contrastMatrix(float contrast)\\n{\\n    float t = (1.0 - contrast) / 2.0;\\n    return mat4(\\n        contrast, 0., 0., 0.,\\n        0., contrast, 0., 0.,\\n        0., 0., contrast, 0.,\\n        t, t, t, 1\\n    );\\n}",snow_frag:"#ifdef HAS_SNOW\\n    float lerp(float a, float b, float w) {\\n        return a + w * (b - a);\\n    }\\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\\n        float snowIntense = normalColor.b;\\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\\n        if (height < 1.0) {\\n            float r = lerp(0.5, fixedC.x, snowIntense);\\n            float g = lerp(0.5, fixedC.y, snowIntense);\\n            float b = lerp(0.5, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        } else {\\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        }\\n    }\\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\\n    attribute vec4 aTangent;\\n#elif defined(HAS_NORMAL)\\n    #ifdef HAS_DRACO_NORMAL\\n        attribute vec2 aNormal;\\n        uniform float gltf_u_dec_normal_rangeConstant;\\n    #else\\n        attribute vec3 aNormal;\\n    #endif\\n#endif\\n#ifdef HAS_DRACO_POSITION\\n    uniform float gltf_u_dec_position_normConstant;\\n    uniform vec3 minValues_pos;\\n    vec3 decodeDracoPosition(vec3 aPosition) {\\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\\n    }\\n#endif\\n#ifdef HAS_DRACO_TEXCOORD\\n    uniform vec2 minValues_tex;\\n    uniform float gltf_u_dec_texcoord_0_normConstant;\\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\\n    }\\n#endif\\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\\n    uniform mat3 decodeMatrix;\\n#endif\\n#ifdef HAS_DRACO_NORMAL\\n    float czm_signNotZero(float value) {\\n        return value >= 0.0 ? 1.0 : -1.0;\\n    }\\n    vec2 czm_signNotZero(vec2 value) {\\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\\n    }\\n    vec3 decodeDracoNormal(vec2 encoded, float range)\\n    {\\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\\n            return vec3(0.0, 0.0, 0.0);\\n        }\\n        encoded = encoded / range * 2.0 - 1.0;\\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\\n        if (v.z < 0.0) {\\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\\n        }\\n        return normalize(v);\\n    }\\n    vec3 decode_getNormal(vec2 aNormal) {\\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\\n    }\\n#endif\\n#ifdef HAS_COMPRESSED_INT16\\n    #ifdef HAS_COMPRESSED_INT16_POSITION\\n      uniform vec2 compressedPositionRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\\n      uniform vec2 compressedTexcoordRange_0;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\\n      uniform vec2 compressedTexcoordRange_1;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n      uniform vec2 compressedNormalRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_RATIO\\n      uniform float compressed_ratio;\\n    #endif\\n    float int16ToFloat32(float value, vec2 range) {\\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\\n    }\\n#endif\\nvec3 decode_getPosition(vec3 aPosition) {\\n    vec3 position = aPosition;\\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\\n        #ifdef HAS_COMPRESSED_INT16_RATIO\\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\\n        #else\\n          position = vec3(x, y, z);\\n        #endif\\n    #endif\\n    #ifdef HAS_DRACO_POSITION\\n        return decodeDracoPosition(position);\\n    #else\\n        return position;\\n    #endif\\n}\\nvec2 decode_getTexcoord(vec2 aTexCoord) {\\n    vec2 texcoord = aTexCoord;\\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\\n        texcoord = vec2(x, y);\\n    #endif\\n    #ifdef HAS_DRACO_TEXCOORD\\n        return decodeDracoTexcoord(texcoord);\\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\\n    #else\\n        return texcoord;\\n    #endif\\n}\\nvec3 decode_getNormal(vec3 aNormal) {\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\\n    #endif\\n    return aNormal;\\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\\n    attribute vec4 aHighlightColor;\\n    varying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    attribute float aHighlightOpacity;\\n    varying float vHighlightOpacity;\\n#endif\\nvoid highlight_setVarying() {\\n    #if defined(HAS_HIGHLIGHT_COLOR)\\n        vHighlightColor = aHighlightColor / 255.0;\\n    #endif\\n    #if defined(HAS_HIGHLIGHT_OPACITY)\\n        vHighlightOpacity = aHighlightOpacity / 255.0;\\n    #endif\\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\\n\\tvarying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    varying float vHighlightOpacity;\\n#endif\\nvec4 highlight_blendColor(vec4 color) {\\n\\tvec4 outColor;\\n\\t#if defined(HAS_HIGHLIGHT_COLOR)\\n\\t\\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\\n\\t\\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\\n        \\tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\\n        #endif\\n        outColor = color;\\n\\t#else\\n\\t\\toutColor = color;\\n\\t#endif\\n\\t#if defined(HAS_HIGHLIGHT_OPACITY)\\n\\t\\toutColor *= vHighlightOpacity;\\n\\t#endif\\n\\treturn outColor;\\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\\n    uniform vec4 mask_extent;\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_maskMode;\\n    uniform float mask_hasFlatOut;\\n    uniform mat4 viewMatrix;\\n    uniform float mask_heightRatio;\\n    uniform float mask_heightOffset;\\n    varying vec4 vWorldPosition;\\n    varying vec2 vUVInExtent;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    const float CLIPINSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float ELEVATE_MODE = 0.7;\\n    float random (vec2 st) {\\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\\n    }\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n          return flatHeight + height;\\n      } else {\\n        return flatHeight;\\n      }\\n    }\\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\\n      float deltaY = realPos.y - tempPos.y;\\n      float deltaZ = realPos.z - tempPos.z;\\n      pos.x = pos.x + deltaX;\\n      pos.y = pos.y + deltaY;\\n      pos.z = pos.z + deltaZ;\\n      return pos;\\n    }\\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\\n        vWorldPosition = modelMatrix * position;\\n        float w = mask_extent.z - mask_extent.x;\\n        float h = mask_extent.y - mask_extent.w;\\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\\n        float maskMode = maskOptionColor.r;\\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\\n        vUVInExtent = uvInExtent;\\n        vHeightRatio = mask_heightRatio;\\n        vHeightOffset = mask_heightOffset;\\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\\n            return modelViewMatrix * position;;\\n        } else if (mask_hasFlatOut == 1.0) {\\n            return getNoErrorPosition(position, wPosition);\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\\n            return getNoErrorPosition(position, wPosition);\\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n            return getNoErrorPosition(position, wPosition);\\n        } else {\\n            return modelViewMatrix * position;\\n        }\\n    }\\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_hasClipOut;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    varying vec2 vUVInExtent;\\n    varying vec4 vWorldPosition;\\n    const float CLIPINSIDE_MODE = 0.1;\\n    const float CLIPOUTSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float COLOR_MODE = 0.5;\\n    const float VIDEO_MODE = 0.6;\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    vec4 setMask(vec4 glFragColor) {\\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\\n        float maskMode = modeColor.r;\\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                return glFragColor;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                return glFragColor;\\n            } else {\\n              discard;\\n            }\\n        } else if (mask_hasClipOut == 1.0) {\\n            discard;\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                discard;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                discard;\\n            } else {\\n              return glFragColor;\\n            }\\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            }\\n        }\\n        return glFragColor;\\n    }\\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\\n    uniform vec2 khr_offset;\\n    uniform float khr_rotation;\\n    uniform vec2 khr_scale;\\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\\n        rotation = -rotation;\\n        mat3 transform = mat3(\\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\\n        return transformedTexCoords;\\n    }\\n#endif\\nvarying highp vec2 vTexCoord;\\n#ifdef HAS_I3S_UVREGION\\n    varying vec4 vUvRegion;\\n#endif\\nvec2 computeTexCoord(vec2 texCoord) {\\n    #ifdef HAS_I3S_UVREGION\\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\\n        return uvAtlas;\\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\\n    #else\\n        return texCoord;\\n    #endif\\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\\n    uniform sampler2D terrainHeightTexture;\\n    uniform vec2 terrainHeightMapResolution;\\n    uniform vec2 terrainResolution;\\n    uniform float terrainHeightScale;\\n    uniform float terrainTileResolution;\\n    uniform vec4 terrainUnpackFactors;\\n    float getHeight(vec2 uv) {\\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\\n        color.a = -1.0;\\n        return dot(color, terrainUnpackFactors) / 4.0;\\n    }\\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\\n        uv.y = 1.0 - uv.y;\\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\\n        float b = getHeight(uv + vec2(0, -epsilon.y));\\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\\n        float e = getHeight(uv + vec2(epsilon.x, 0));\\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\\n        float g = getHeight(uv + vec2(0, epsilon.y));\\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\\n        vec2 dxy = vec2(\\n            (c + e + e + h) - (a + d + d + f),\\n            (f + g + g + h) - (a + b + b + c)\\n        );\\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\\n    }\\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\\nattribute float aVertexColorType;\\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\\nvarying vec4 vertexColor_color;\\nvoid vertexColor_update() {\\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\\n}\\n#endif",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\\nvarying vec4 vertexColor_color;\\nvec4 vertexColor_get() {\\n\\treturn vertexColor_color;\\n}\\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform vec4 excavateExtent;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  float getWorldHeight() {\\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\\n    return wPosition.z;\\n  }\\n  vec2 getCoordinateTexcoord() {\\n    mat4 localPositionMatrix = getPositionMatrix();\\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\\n    return vec2(x, y);\\n  }\\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform sampler2D heightmap;\\n  uniform float excavateHeight;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  const vec2 range = vec2(-100.0, 1000.0);\\n  float decodeHeight(const in vec4 pack) {\\n      return pack.r + pack.g / 255.0;\\n  }\\n  vec4 excavateColor(vec4 fragColor) {\\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\\n      if(realHeight < range.x || realHeight > range.y) {\\n          realHeight = 0.0;\\n      }\\n      if(vHeight > realHeight) {\\n          discard;\\n      }\\n      return fragColor;\\n  }\\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\\n    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);\\n}\\nvec3 sRGBToLinear(const in vec3 color) {\\n    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));\\n}"};var A={register(e,n){if(p[e])throw new Error(\`Key of ${HE}e} is already registered in ShaderLib.\`);p[e]=n},compile:e=>b(e)};const y=/^[ \\t]*#include +<([\\w\\d.]+)>/gm;function b(e){return e.replace(y,w)}function w(e,n){const t=p[n];if(!t)throw new Error("Can not resolve #include <"+n+">");return b(t)}const E=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],I=E.length,T=[0,0];for(let e=0;e<E.length;e++)T[0]+=E[e][0],T[1]+=E[e][1];T[0]/=I,T[1]/=I;!function(e,n,t){var r=n[0],o=n[1],i=n[2],a=n[3],s=r+r,c=o+o,f=i+i,l=r*s,h=r*c,d=r*f,u=o*c,v=o*f,_=i*f,m=a*s,g=a*c,x=a*f;e[0]=1-(u+_),e[1]=h+x,e[2]=d-g,e[3]=0,e[4]=h-x,e[5]=1-(l+_),e[6]=v+m,e[7]=0,e[8]=d+g,e[9]=v-m,e[10]=1-(l+u),e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}([],function(e,n,t,r){var o=.5*Math.PI/180;n*=o,t*=o,r*=o;var i=Math.sin(n),a=Math.cos(n),s=Math.sin(t),c=Math.cos(t),f=Math.sin(r),l=Math.cos(r);return e[0]=i*c*l-a*s*f,e[1]=a*s*l+i*c*f,e[2]=a*c*f-i*s*l,e[3]=a*c*l+i*s*f,e}([],90,0,0),[0,0,0]),function(){const e=[0,0,0],n=90*Math.PI/180,t=[0,0,0,0],r=new Array(16)}(),A.compile("#define SHADER_NAME SKYBOX\\n#if __VERSION__ == 100\\n#ifdef GL_EXT_shader_texture_lod\\n#extension GL_EXT_shader_texture_lod : enable\\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\\n#else\\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\\n#endif\\n#else\\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\\n#endif\\nprecision highp float;\\n#define saturate(x)        clamp(x, 0.0, 1.0)\\n#include <gl2_frag>\\n#include <hsv_frag>\\nuniform vec3 hsv;\\nvarying vec3 vWorldPos;\\n#ifdef USE_AMBIENT\\nuniform vec3 diffuseSPH[9];\\n#else\\nuniform samplerCube cubeMap;\\nuniform float bias;\\nuniform float size;\\n#endif\\nuniform float environmentExposure;\\nuniform float backgroundIntensity;\\nvec4 c(const in samplerCube d, const in vec3 e, const in float f, const in float h) {\\n  vec3 i = e;\\n  return textureCubeLod(d, i, h);\\n}\\nvec3 j(const in vec3 k, const in vec3 l[9]) {\\n  float x = k.x;\\n  float y = k.y;\\n  float z = k.z;\\n  vec3 m = (l[0] + l[1] * x + l[2] * y + l[3] * z + l[4] * z * x + l[5] * y * z + l[6] * y * x + l[7] * (3. * z * z - 1.) + l[8] * (x * x - y * y));\\n  return max(m, vec3(.0));\\n}\\nfloat n(const in vec2 o) {\\n  vec3 u = fract(vec3(o.xyx) * .1031);\\n  u += dot(u, u.yzx + 19.19);\\n  return fract((u.x + u.y) * u.z);\\n}\\n#if defined(TONE_MAPPING)\\nconst float v = 1.;\\nvec3 A(vec3 B) {\\n  vec3 a = B * (B + .0245786) - .000090537;\\n  vec3 b = B * (.983729 * B + .4329510) + .238081;\\n  return a / b;\\n}\\nvec3 C(vec3 D) {\\n  const mat3 E = mat3(vec3(.59719, .07600, .02840), vec3(.35458, .90834, .13383), vec3(.04823, .01566, .83777));\\n  const mat3 F = mat3(vec3(1.60475, -.10208, -.00327), vec3(-.53108, 1.10813, -.07276), vec3(-.07367, -.00605, 1.07602));\\n  D *= v / .6;\\n  D = E * D;\\n  D = A(D);\\n  D = F * D;\\n  return saturate(D);\\n}\\nvec3 G(vec3 D) {\\n  return C(D);\\n}\\nvec4 H(in vec4 I) {\\n  return vec4(mix(pow(I.rgb, vec3(.41666)) * 1.055 - vec3(.055), I.rgb * 12.92, vec3(lessThanEqual(I.rgb, vec3(.0031308)))), I.a);\\n}\\nvec4 J(vec4 I) {\\n  return (H(I));\\n}\\n#endif\\nvoid main() {\\n  vec4 K;\\n#ifdef USE_AMBIENT\\nvec3 k = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., n(gl_FragCoord.xy)) * 2.);\\n  K = vec4(j(k, diffuseSPH), 1.);\\n#else\\nK = c(cubeMap, vWorldPos, size, bias);\\n#endif\\nK.rgb *= environmentExposure;\\n  K.rgb *= backgroundIntensity;\\n  glFragColor = K;\\n  if(length(hsv) > .0) {\\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\\n  }\\n#if defined(TONE_MAPPING)\\nglFragColor.rgb = G(glFragColor.rgb);\\n  glFragColor = J(glFragColor);\\n#endif\\n#if __VERSION__ == 100\\ngl_FragColor = glFragColor;\\n#endif\\n}"),function(){const e=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],n=new Array(16)}(),function(){let e=new Array(4);const n=new Array(3),t=[0,0,0,0],r=[0,1,0],o=new Array(3);let i=new Array(16),a=new Array(16);const s=new Array(16),c=[1,1,1],f=[0,0,0]}();const O=new Uint8Array(4);new Float32Array(O.buffer);var S={exports:{}};function C(e,n,t){t=t||2;var r,o,i,a,s,c,f,l=n&&n.length,h=l?n[0]*t:e.length,d=M(e,0,h,t,!0),u=[];if(!d||d.next===d.prev)return u;if(l&&(d=function(e,n,t,r){var o,i,a,s=[];for(o=0,i=n.length;o<i;o++)(a=M(e,n[o]*r,o<i-1?n[o+1]*r:e.length,r,!1))===a.next&&(a.steiner=!0),s.push(W(a));for(s.sort(U),o=0;o<s.length;o++)t=L(s[o],t);return t}(e,n,d,t)),e.length>80*t){r=i=e[0],o=a=e[1];for(var v=t;v<h;v+=t)(s=e[v])<r&&(r=s),(c=e[v+1])<o&&(o=c),s>i&&(i=s),c>a&&(a=c);f=0!==(f=Math.max(i-r,a-o))?32767/f:0}return k(d,u,t,r,o,f,0),u}function M(e,n,t,r,o){var i,a;if(o===ee(e,n,t,r)>0)for(i=n;i<t;i+=r)a=J(i,e[i],e[i+1],a);else for(i=t-r;i>=n;i-=r)a=J(i,e[i],e[i+1],a);return a&&X(a,a.next)&&($(a),a=a.next),a}function H(e,n){if(!e)return e;n||(n=e);var t,r=e;do{if(t=!1,r.steiner||!X(r,r.next)&&0!==j(r.prev,r,r.next))r=r.next;else{if($(r),(r=n=r.prev)===r.next)break;t=!0}}while(t||r!==n);return n}function k(e,n,t,r,o,i,a){if(e){!a&&i&&function(e,n,t,r){var o=e;do{0===o.z&&(o.z=z(o.x,o.y,n,t,r)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,function(e){var n,t,r,o,i,a,s,c,f=1;do{for(t=e,e=null,i=null,a=0;t;){for(a++,r=t,s=0,n=0;n<f&&(s++,r=r.nextZ);n++);for(c=f;s>0||c>0&&r;)0!==s&&(0===c||!r||t.z<=r.z)?(o=t,t=t.nextZ,s--):(o=r,r=r.nextZ,c--),i?i.nextZ=o:e=o,o.prevZ=i,i=o;t=r}i.nextZ=null,f*=2}while(a>1)}(o)}(e,r,o,i);for(var s,c,f=e;e.prev!==e.next;)if(s=e.prev,c=e.next,i?P(e,r,o,i):N(e))n.push(s.i/t|0),n.push(e.i/t|0),n.push(c.i/t|0),$(e),e=c.next,f=c.next;else if((e=c)===f){a?1===a?k(e=D(H(e),n,t),n,t,r,o,i,2):2===a&&R(e,n,t,r,o,i):k(H(e),n,t,r,o,i,1);break}}}function N(e){var n=e.prev,t=e,r=e.next;if(j(n,t,r)>=0)return!1;for(var o=n.x,i=t.x,a=r.x,s=n.y,c=t.y,f=r.y,l=o<i?o<a?o:a:i<a?i:a,h=s<c?s<f?s:f:c<f?c:f,d=o>i?o>a?o:a:i>a?i:a,u=s>c?s>f?s:f:c>f?c:f,v=r.next;v!==n;){if(v.x>=l&&v.x<=d&&v.y>=h&&v.y<=u&&G(o,s,i,c,a,f,v.x,v.y)&&j(v.prev,v,v.next)>=0)return!1;v=v.next}return!0}function P(e,n,t,r){var o=e.prev,i=e,a=e.next;if(j(o,i,a)>=0)return!1;for(var s=o.x,c=i.x,f=a.x,l=o.y,h=i.y,d=a.y,u=s<c?s<f?s:f:c<f?c:f,v=l<h?l<d?l:d:h<d?h:d,_=s>c?s>f?s:f:c>f?c:f,m=l>h?l>d?l:d:h>d?h:d,g=z(u,v,n,t,r),x=z(_,m,n,t,r),p=e.prevZ,A=e.nextZ;p&&p.z>=g&&A&&A.z<=x;){if(p.x>=u&&p.x<=_&&p.y>=v&&p.y<=m&&p!==o&&p!==a&&G(s,l,c,h,f,d,p.x,p.y)&&j(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,A.x>=u&&A.x<=_&&A.y>=v&&A.y<=m&&A!==o&&A!==a&&G(s,l,c,h,f,d,A.x,A.y)&&j(A.prev,A,A.next)>=0)return!1;A=A.nextZ}for(;p&&p.z>=g;){if(p.x>=u&&p.x<=_&&p.y>=v&&p.y<=m&&p!==o&&p!==a&&G(s,l,c,h,f,d,p.x,p.y)&&j(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;A&&A.z<=x;){if(A.x>=u&&A.x<=_&&A.y>=v&&A.y<=m&&A!==o&&A!==a&&G(s,l,c,h,f,d,A.x,A.y)&&j(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function D(e,n,t){var r=e;do{var o=r.prev,i=r.next.next;!X(o,i)&&K(o,r,r.next,i)&&Z(o,i)&&Z(i,o)&&(n.push(o.i/t|0),n.push(r.i/t|0),n.push(i.i/t|0),$(r),$(r.next),r=e=i),r=r.next}while(r!==e);return H(r)}function R(e,n,t,r,o,i){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&V(a,s)){var c=Y(a,s);return a=H(a,a.next),c=H(c,c.next),k(a,n,t,r,o,i,0),void k(c,n,t,r,o,i,0)}s=s.next}a=a.next}while(a!==e)}function U(e,n){return e.x-n.x}function L(e,n){var t=function(e,n){var t,r=n,o=e.x,i=e.y,a=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){var s=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=o&&s>a&&(a=s,t=r.x<r.next.x?r:r.next,s===o))return t}r=r.next}while(r!==n);if(!t)return null;var c,f=t,l=t.x,h=t.y,d=1/0;r=t;do{o>=r.x&&r.x>=l&&o!==r.x&&G(i<h?o:a,i,l,h,i<h?a:o,i,r.x,r.y)&&(c=Math.abs(i-r.y)/(o-r.x),Z(r,e)&&(c<d||c===d&&(r.x>t.x||r.x===t.x&&F(t,r)))&&(t=r,d=c)),r=r.next}while(r!==f);return t}(e,n);if(!t)return n;var r=Y(t,e);return H(r,r.next),H(t,t.next)}function F(e,n){return j(e.prev,e,n.prev)<0&&j(n.next,e,e.next)<0}function z(e,n,t,r,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-t)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*o|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function W(e){var n=e,t=e;do{(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next}while(n!==e);return t}function G(e,n,t,r,o,i,a,s){return(o-a)*(n-s)>=(e-a)*(i-s)&&(e-a)*(r-s)>=(t-a)*(n-s)&&(t-a)*(i-s)>=(o-a)*(r-s)}function V(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!function(e,n){var t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&K(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}(e,n)&&(Z(e,n)&&Z(n,e)&&function(e,n){var t=e,r=!1,o=(e.x+n.x)/2,i=(e.y+n.y)/2;do{t.y>i!=t.next.y>i&&t.next.y!==t.y&&o<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next}while(t!==e);return r}(e,n)&&(j(e.prev,e,n.prev)||j(e,n.prev,n))||X(e,n)&&j(e.prev,e,e.next)>0&&j(n.prev,n,n.next)>0)}function j(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function X(e,n){return e.x===n.x&&e.y===n.y}function K(e,n,t,r){var o=q(j(e,n,t)),i=q(j(e,n,r)),a=q(j(t,r,e)),s=q(j(t,r,n));return o!==i&&a!==s||!(0!==o||!B(e,t,n))||!(0!==i||!B(e,r,n))||!(0!==a||!B(t,e,r))||!(0!==s||!B(t,n,r))}function B(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function q(e){return e>0?1:e<0?-1:0}function Z(e,n){return j(e.prev,e,e.next)<0?j(e,n,e.next)>=0&&j(e,e.prev,n)>=0:j(e,n,e.prev)<0||j(e,e.next,n)<0}function Y(e,n){var t=new Q(e.i,e.x,e.y),r=new Q(n.i,n.x,n.y),o=e.next,i=n.prev;return e.next=n,n.prev=e,t.next=o,o.prev=t,r.next=t,t.prev=r,i.next=r,r.prev=i,r}function J(e,n,t,r){var o=new Q(e,n,t);return r?(o.next=r.next,o.prev=r,r.next.prev=o,r.next=o):(o.prev=o,o.next=o),o}function $(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Q(e,n,t){this.i=e,this.x=n,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ee(e,n,t,r){for(var o=0,i=n,a=t-r;i<t;i+=r)o+=(e[a]-e[i])*(e[i+1]+e[a+1]),a=i;return o}S.exports=C,S.exports.default=C,C.deviation=function(e,n,t,r){var o=n&&n.length,i=Math.abs(ee(e,0,o?n[0]*t:e.length,t));if(o)for(var a=0,s=n.length;a<s;a++)i-=Math.abs(ee(e,n[a]*t,a<s-1?n[a+1]*t:e.length,t));var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*t,l=r[a+1]*t,h=r[a+2]*t;c+=Math.abs((e[f]-e[h])*(e[l+1]-e[f+1])-(e[f]-e[l])*(e[h+1]-e[f+1]))}return 0===i&&0===c?0:Math.abs((c-i)/i)},C.flatten=function(e){for(var n=e[0][0].length,t={vertices:[],holes:[],dimensions:n},r=0,o=0;o<e.length;o++){for(var i=0;i<e[o].length;i++)for(var a=0;a<n;a++)t.vertices.push(e[o][i][a]);o>0&&t.holes.push(r+=e[o-1].length)}return t},function(e){e&&e.T&&Object.prototype.hasOwnProperty.call(e,"default")&&e.default}(S.exports);class ne{constructor(e=257){this.gridSize=e;const n=e-1;if(n&n-1)throw new Error(\`Expected grid size to be 2^n+1, got ${HE}e}.\`);this.numTriangles=n*n*2-2,this.numParentTriangles=this.numTriangles-n*n,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let e=0;e<this.numTriangles;e++){let t=e+2,r=0,o=0,i=0,a=0,s=0,c=0;for(1&t?i=a=s=n:r=o=c=n;(t>>=1)>1;){const e=r+i>>1,n=o+a>>1;1&t?(i=r,a=o,r=s,o=c):(r=i,o=a,i=s,a=c),s=e,c=n}const f=4*e;this.coords[f+0]=r,this.coords[f+1]=o,this.coords[f+2]=i,this.coords[f+3]=a}}createTile(e){return new te(e,this)}}class te{constructor(e,n){const t=n.gridSize;if(e.length!==t*t)throw new Error(\`Expected terrain data of length ${HE}t*t} (${HE}t} x ${HE}t}), got ${HE}e.length}.\`);this.terrain=e,this.martini=n,this.errors=new Float32Array(e.length),this.update()}update(){const{numTriangles:e,numParentTriangles:n,coords:t,gridSize:r}=this.martini,{terrain:o,errors:i}=this;for(let a=e-1;a>=0;a--){const e=4*a,s=t[e+0],c=t[e+1],f=t[e+2],l=t[e+3],h=s+f>>1,d=c+l>>1,u=h+d-c,v=d+s-h,_=(o[c*r+s]+o[l*r+f])/2,m=d*r+h,g=Math.abs(_-o[m]);if(i[m]=Math.max(i[m],g),a<n){const e=(c+v>>1)*r+(s+u>>1),n=(l+v>>1)*r+(f+u>>1);i[m]=Math.max(i[m],i[e],i[n])}}}getMesh(e=0){const{gridSize:n,indices:t}=this.martini,{errors:r}=this;let o=0,i=0;const a=n-1;function s(a,c,f,l,h,d){const u=a+f>>1,v=c+l>>1;Math.abs(a-h)+Math.abs(c-d)>1&&r[v*n+u]>e?(s(h,d,a,c,u,v),s(f,l,h,d,u,v)):(t[c*n+a]=t[c*n+a]||++o,t[l*n+f]=t[l*n+f]||++o,t[d*n+h]=t[d*n+h]||++o,i++)}t.fill(0),s(0,0,a,a,a,0),s(a,a,0,0,0,a);const c=new Uint16Array(2*o),f=new Uint32Array(3*i);let l=0;function h(o,i,a,s,d,u){const v=o+a>>1,_=i+s>>1;if(Math.abs(o-d)+Math.abs(i-u)>1&&r[_*n+v]>e)h(d,u,o,i,v,_),h(a,s,d,u,v,_);else{const e=t[i*n+o]-1,r=t[s*n+a]-1,h=t[u*n+d]-1;c[2*e]=o,c[2*e+1]=i,c[2*r]=a,c[2*r+1]=s,c[2*h]=d,c[2*h+1]=u,f[l++]=e,f[l++]=r,f[l++]=h}}return h(0,0,a,a,a,0),h(a,a,0,0,0,a),{vertices:c,triangles:f}}getMeshWithSkirts(e=0,n){const{gridSize:t,indices:r}=this.martini,{errors:o}=this;let i=0,a=0;const s=t-1;let c,f,l=0;const h=[],d=[],u=[],v=[];function _(n,m,g,x,p,A){const y=n+g>>1,b=m+x>>1;Math.abs(n-p)+Math.abs(m-A)>1&&o[b*t+y]>e?(_(p,A,n,m,y,b),_(g,x,p,A,y,b)):(c=m*t+n,f=x*t+g,l=A*t+p,0===r[c]&&(0===n?h.push(i):n===s&&d.push(i),0===m?u.push(i):m===s&&v.push(i),r[c]=++i),0===r[f]&&(0===g?h.push(i):g===s&&d.push(i),0===x?u.push(i):x===s&&v.push(i),r[f]=++i),0===r[l]&&(0===p?h.push(i):p===s&&d.push(i),0===A?u.push(i):A===s&&v.push(i),r[l]=++i),a++)}let m;r.fill(0),_(0,0,s,s,s,0),_(s,s,0,0,0,s),m=n?2*(i+3*h.length-2+3*d.length-2+3*u.length-2+3*v.length-2):2*(i+h.length+d.length+u.length+v.length);const g=3*(a+2*(h.length-1)+2*(d.length-1)+2*(u.length-1)+2*(v.length-1)),x=new Uint16Array(m),p=new Uint32Array(g);let A=0;function y(n,i,a,s,c,f){const l=n+a>>1,h=i+s>>1;if(Math.abs(n-c)+Math.abs(i-f)>1&&o[h*t+l]>e)y(c,f,n,i,l,h),y(a,s,c,f,l,h);else{const e=r[i*t+n]-1,o=r[s*t+a]-1,l=r[f*t+c]-1;x[2*e]=n,x[2*e+1]=i,x[2*o]=a,x[2*o+1]=s,x[2*l]=c,x[2*l+1]=f,p[A++]=e,p[A++]=o,p[A++]=l}}y(0,0,s,s,s,0),y(s,s,0,0,0,s),h.sort(((e,n)=>x[2*e+1]-x[2*n+1])),d.sort(((e,n)=>x[2*n+1]-x[2*e+1])),u.sort(((e,n)=>x[2*n]-x[2*e])),v.sort(((e,n)=>x[2*e]-x[2*n]));let b,w,E,I,T=2*i,O=0;function S(e){O=e.length;for(let t=0;t<O-1;t++)b=e[t],w=e[t+1],E=T/2,I=(T+(n?6:2))/2,x[T++]=2*b,x[T++]=2*b+1,n&&(x[T++]=2*b,x[T++]=2*b+1,x[T++]=2*w,x[T++]=2*w+1),n?(p[A++]=E+1,p[A++]=E,p[A++]=E+2,p[A++]=E,p[A++]=I,p[A++]=E+2):(p[A++]=b,p[A++]=E,p[A++]=w,p[A++]=E,p[A++]=I,p[A++]=w);x[T++]=2*e[O-1],x[T++]=2*e[O-1]+1}S(h);const C=T;S(d);const M=T;S(u);const H=T;S(v);return{vertices:x,triangles:p,numVerticesWithoutSkirts:i,numTrianglesWithoutSkirts:a,leftSkirtIndex:C,rightSkirtIndex:M,bottomSkirtIndex:H,topSkirtIndex:T}}}const re={};let oe;const ie={width:100,height:10};let ae,se=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),se=!0}catch(e){se=!1}function ce(){if(!oe){const{width:e,height:n}=ie;se?oe=new OffscreenCanvas(e,n):(oe=document.createElement("canvas"),oe.width=e,oe.height=n)}return oe}class fe{constructor(e,n={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let t=1/0,r=-1/0;for(let n=0,o=e.length;n<o;n++){const o=e[n][0];t=Math.min(o,t),r=Math.max(o,r)}this.min=t,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},ie,n),this.O()}getImageData(){return this.imgData}O(){const e=ce(),{width:n,height:t}=this.options;e.width=n,e.height=t;const r=e.getContext("2d");r.clearRect(0,0,e.width,e.height);const o=r.createLinearGradient(0,0,e.width,0),{colors:i,valueOffset:a}=this;for(let e=0,n=i.length;e<n;e++){const[n,t]=i[e],r=(n-this.min)/a;o.addColorStop(r,t)}r.fillStyle=o,r.fillRect(0,0,e.width,e.height),this.imgData=r.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e);const n=((e=Math.min(e,this.max))-this.min)/this.valueOffset;let t=Math.round(n*this.imgData.width);t=Math.min(t,this.imgData.width-1);const r=4*t;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}let le=null,he=null;const de=[0,0,0],ue=[256,256];function ve(){try{le||(le=new OffscreenCanvas(1,1))}catch(e){console.error(e)}}const _e={},me={},ge={width:64,height:64,elementsPerHeight:3,heightOffset:-1e3,exaggeration:1,heightScale:.001,elementMultiplier:256,stride:4,skirtHeight:.002,skirtOffset:.01},xe={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};xe["cesium-ion"]=xe.cesium;const pe=32767;let Ae=null,ye=null;function be(e,n){const t=function(e){if(e.length<1e3)return null;const n=new Zlib.Inflate(e);return n?n.decompress():null}(new Uint8Array(e));if(!t)throw new Error((r=new Uint8Array(e),we.decode(r)));var r;const o=function(e){const n=e,t=ge.width,r=ge.height,o=new Uint8Array(t*r*ge.stride);let i,a,s,c,f;for(let e=0;e<r;e++)for(let l=0;l<t;l++){c=parseInt(149*e/(r-1)),f=parseInt(149*l/(t-1)),a=2*(150*c+f),i=n[a]+256*n[a+1],(i>1e4||i<-2e3)&&(i=0),s=4*(e*t+l);const h=(i+1e3)/ge.heightScale,d=ge.elementMultiplier;o[s]=h/(d*d),o[s+1]=(h-o[s]*d*d)/d,o[s+2]=h-o[s]*d*d-o[s+1]*d,o[s+3]=255}return o}(t),i=function(e,n){const t=n,r=n,o=t+1,i=r+1,a=ge.elementsPerHeight,s=ge.heightOffset,c=ge.heightScale,f=ge.elementMultiplier,l=ge.skirtHeight,h=new Float32Array(o*i);let d=0,u=1/0,v=-1/0;for(let n=0;n<o;n++){const o=n>=r?r-1:n;for(let n=0;n<i;n++){let r=0;const i=o*(4*t)+4*(n>=t?t-1:n);for(let n=0;n<a;n++)r=r*f+e[i+n];r=1*(r*c+s),r-=l,h[d]=r,r<u&&(u=r),r>v&&(v=r),d++}}return{data:h,min:u,max:v}}(o,n-1);return i.width=i.height=n,i}const we=new TextDecoder("utf-8");function Ee(e){return e>>1^-(1&e)}const Ie=[];function Te(e){let n=0;const t=3*Float64Array.BYTES_PER_ELEMENT,r=3*Uint16Array.BYTES_PER_ELEMENT;let o=Uint16Array.BYTES_PER_ELEMENT;const i=new DataView(e);n+=t;const a=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT;const s=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT,n+=t;const c=i.getFloat64(n,!0);n+=Float64Array.BYTES_PER_ELEMENT,n+=t;const f=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const l=new Uint16Array(e,n,3*f);n+=f*r,f>65536&&(o=Uint32Array.BYTES_PER_ELEMENT);!function(e,n,t){const r=e.length;let o=0,i=0,a=0;for(let s=0;s<r;++s)o+=Ee(e[s]),i+=Ee(n[s]),e[s]=o,n[s]=i,t&&(a+=Ee(t[s]),t[s]=a)}(l.subarray(0,f),l.subarray(f,2*f),l.subarray(2*f,3*f)),n%o!=0&&(n+=o-n%o);const h=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const d=f>65536?new Uint32Array(e,n,3*h):new Uint16Array(e,n,3*h);let u=0;const v=d.length;for(let e=0;e<v;++e){const n=d[e];d[e]=u-n,0===n&&++u}const _={minimumHeight:a,maximumHeight:s,quantizedVertices:l,indices:d}.quantizedVertices,m=_.length/3,g=_.subarray(0,m),x=_.subarray(m,2*m),p=_.subarray(2*m,3*m),A=Ie;for(let e=0;e<m;++e){const n=g[e],t=x[e],r=n/pe,o=t/pe,i=(y=a,b=s,(1-(w=p[e]/pe))*y+w*b);A[3*e]=r,A[3*e+1]=1-o,A[3*e+2]=i}var y,b,w;return{positions:A,radius:c,min:a,max:s,indices:d}}const Oe=[],Se=[],Ce=[],Me=[],He=[];class ke{constructor(e,n,t,r,o){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(e,n,t,r,o)}set(e,n,t,r,o){this.radius=o;let i=3*n,a=3*n+1,s=3*n+2;this.p0[0]=e[i]*o,this.p0[1]=e[a]*o,this.p0[2]=e[s],i=3*t,a=3*t+1,s=3*t+2,this.p1[0]=e[i]*o,this.p1[1]=e[a]*o,this.p1[2]=e[s],i=3*r,a=3*r+1,s=3*r+2,this.p2[0]=e[i]*o,this.p2[1]=e[a]*o,this.p2[2]=e[s],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);const c=_(Oe,this.p1,this.p0),f=_(Se,this.p2,this.p1);this.normal=u(this.normal,v(this.normal,c,f))}contains(e,n){if(e<this.min[0]||e>this.max[0]||n<this.min[1]||n>this.max[1])return!1;x(Ce,this.p0[0],this.p0[1]),x(Me,this.p1[0],this.p1[1]),x(He,this.p2[0],this.p2[1]);const t=Re(Ce[0],Ce[1],Me[0],Me[1],He[0],He[1]);return Re(e,n,Ce[0],Ce[1],He[0],He[1])+Re(e,n,Ce[0],Ce[1],Me[0],Me[1])+Re(e,n,Me[0],Me[1],He[0],He[1])-t<=1e-4}getHeight(e,n){const t=this.normal;return this.p0[2]-((e-this.p0[0])*t[0]+(n-this.p0[1])*t[1])/t[2]}}let Ne=null;function Pe(e,n,t){if(Ne&&Ne.contains(n,t))return Ne.getHeight(n,t);for(let r=0;r<e.length;r++)if(e[r].contains(n,t))return Ne=e[r],e[r].getHeight(n,t);return 0}const De=[];function Re(e,n,t,r,o,i){return.5*Math.abs(e*r+t*i+o*n-e*i-t*n-o*r)}function Ue(e,n,t,r,o,i){"cesium-ion"===t&&(n.Authorization="Bearer "+Ae),function(e,n,t){const r={method:"GET",referrer:t,headers:n},o=c.getArrayBuffer(e,r),i=o.xhr;return me[e]=i,o.then((n=>(delete me[e],n)))}(e,n,origin).then((e=>{if(!e||e.message)i(e?{empty:!0,originalError:e}:{error:{canceled:!0}});else{const n=e.data;let a=null;if("tianditu"===t){const e=be(n,r);Fe(o,e,r,null,!0,i)}else if("cesium-ion"===t||"cesium"===t){a=Te(n);const e=function(e,n){const{positions:t,min:r,max:o,indices:i,radius:a}=e,s=[];let c=0;for(let e=0;e<i.length;e+=3){let n=De[c];n?n.set(t,i[e],i[e+1],i[e+2],2*a):n=De[c]=new ke(t,i[e],i[e+1],i[e+2],2*a),c++,s.push(n)}const f=new Float32Array(n*n);c=0;for(let e=0;e<n;e++)for(let t=0;t<n;t++)f[c++]=Pe(s,t/n*a*2,e/n*a*2);return{data:f,min:r,max:o,width:n,height:n}}(a,r);Fe(o,e,r,null,!0,i)}else"mapbox"===t&&(a=function(e){const n=new self.Blob([new Uint8Array(e)]);return self.createImageBitmap(n)}(n),a.then((e=>{const n=function(e){const{width:n,height:t}=e;le||(le=new OffscreenCanvas(1,1),he=le.getContext("2d",{willReadFrequently:!0}));return le.width=n,le.height=t,he.drawImage(e,0,0,n,t),he.getImageData(0,0,n,t)}(e),t=function(e,n){const{data:t,width:r}=e;let o=1/0,i=-1/0;const a=new Float32Array(n*n),s=Math.round(r/n);for(let e=0;e<n;e++)for(let c=0;c<n;c++){const f=e+c*n;let l=0,h=0;const d=e,u=c;for(let e=0;e<s;e++)for(let n=0;n<s;n++){let o=d*s+e,i=u*s+n;i>r-1&&(i=r-1),o>r-1&&(o=r-1);const a=o+i*r,c=t[4*a],f=t[4*a+1],v=t[4*a+2];0===t[4*a+3]?h+=1:l+=.1*(256*c*256+256*f+v)-1e4}l/=s*s-h||1,l>i&&(i=l),l<o&&(o=l),a[f]=l}return{data:a,width:n,height:n,min:o,max:i}}(n,r);Fe(o,t,r,e,!0,i)})))}})).catch((n=>{delete me[e],i({empty:!0,originalError:n})}))}function Le(e,n){const t=Math.floor(10*(e+1e4)),r=t>>16,o=t>>8&255,i=255&t;return n?(n[0]=r,n[1]=o,n[2]=i,n):[r,o,i]}function Fe(e,n,t,r,o,i){const a=function(e,n,t,r){let o=re[t];o||(o=re[t]=new ne(t));const i=o.createTile(n).getMeshWithSkirts(e,!0),{triangles:a,vertices:s,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:l,topSkirtIndex:h}=i;let{numVerticesWithoutSkirts:d,numTrianglesWithoutSkirts:u}=i;d||(d=s.legnth/3,u=a.length/3);const v=s.length/2,_=new Float32Array(3*v),m=new Float32Array(2*v);let g=1/0,x=-1/0;const p=t-1;for(let e=0;e<v;e++){const r=s[2*e],o=s[2*e+1];if(e>=d){const n=r/2*3;let t,o=.001;(e-(e<c/2?d:e<f/2?c/2:e<l/2?f/2:l/2))%3==0?(t=0,o=0):t=_[n+2],_[3*e]=_[n],_[3*e+1]=_[n+1],_[3*e+2]=t,m[2*e]=_[n]/p+o,m[2*e+1]=-_[n+1]/p+o}else _[3*e]=1*r,_[3*e+1]=1*-o,_[3*e+2]=n[o*t+r],m[2*e]=r/p,m[2*e+1]=o/p;const i=_[_.length-1];i<g&&(g=i),i>x&&(x=i)}return{positions:_,texcoords:m,triangles:a,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:l,topSkirtIndex:h,numTrianglesWithoutSkirts:u,numVerticesWithoutSkirts:d,minHeight:g,maxHeight:x,terrainWidth:t}}(e,n.data,t),s=[a.positions.buffer,a.texcoords.buffer,a.triangles.buffer];r||(r=function(e){if(ve(),!le)return;const{width:n,height:t,data:r}=e;if(n&&t&&r)try{let e=le.getContext("2d",{willReadFrequently:!0});const o=e.createImageData(n,t);for(let e=0,n=r.length;e<n;e++){const n=r[e],[t,i,a]=Le(n,de),s=4*e;o.data[s]=t,o.data[s+1]=i,o.data[s+2]=a,o.data[s+3]=255}return le.width=n,le.height=t,e=le.getContext("2d",{willReadFrequently:!0}),ze(e),e.putImageData(o,0,0),le.transferToImageBitmap()}catch(e){console.log(e)}}(n)),r&&s.push(r);const c={mesh:a};c.image=r,c.data=n,s.push(n.data.buffer),i(c,s)}function ze(e){const n=e.canvas,{width:t,height:r}=n;e.clearRect(0,0,t,r)}function We(e,n,t){if(!n||!Array.isArray(n)||n.length<2)return;if(!e||!e.image)return null;let{width:r,height:o}=e.image;(t=t||ue)[0]===r&&t[1]===o||(r=t[0],o=t[1]),r*=2,o*=2;try{if(ve(),!le)return;const t=le;t.width=r,t.height=o;const i=t.getContext("2d",{willReadFrequently:!0});ze(i),i.drawImage(e.image,0,0,r,o);const a=i.getImageData(0,0,r,o);return function(e,n){const t=JSON.stringify(n);_e[t]||(_e[t]=new fe(n));const r=_e[t],o=e.data;for(let e=0,n=o.length;e<n;e+=4){const n=o[e],t=o[e+1],i=o[e+2];let a=0;0!==o[e+3]&&(a=.1*(256*n*256+256*t+i)-1e4,a=Math.max(a,0));const[s,c,f]=r.getColor(a);o[e]=s,o[e+1]=c,o[e+2]=f,o[e+3]=255}}(a,n),new Uint8Array(a.data)}catch(e){console.error(e)}}e.initialize=function(){},e.onmessage=function(e,n){const t=e.data;if("addLayer"===t.command||"removeLayer"===t.command)ae=e.workerId,self.postMessage({type:"<response>",actorId:t.actorId,workerId:ae,params:"ok",callback:e.callback});else if("fetchTerrain"===t.command){const e=(t.params||{}).colors,r=(t.params||{}).tileSize;!function(e,n){const{url:t,origin:r,type:o,accessToken:i,terrainWidth:a,error:s}=e,c=e.headers||xe[o];if("tianditu"===o)Ue(t,c,o,a,s,n);else if("cesium-ion"===o){const f=e.cesiumIonTokenURL+i;Ae?Ue(t,c,o,a,s,n):(ye||(ye=fetch(f,{responseType:"json",method:"GET",referrer:r,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then((e=>e.json())).then((e=>{Ae=e.accessToken,ye=null}))),ye.then((()=>{Ue(t,c,o,a,s,n)})))}else("cesium"===o||"mapbox"===o)&&Ue(t,c,o,a,s,n)}(t.params,((t,o)=>{const i=We(t,e,r);i&&(t.colorsTexture=i,(o=o||[]).push(i.buffer)),n(t.error,t,o)}))}else"abortTerrain"===t.command&&(r=t.params.url,me[r]&&(me[r].abort(),delete me[r]));var r}}`);const UE={width:100,height:10};let VE=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),VE=!0}catch(S6){VE=!1}class GE{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},UE,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=function(){if(!jE){const{width:t,height:e}=UE;VE?jE=new OffscreenCanvas(t,e):(jE=document.createElement("canvas"),jE.width=t,jE.height=e)}return jE}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:s}=this;for(let a=0,l=o.length;a<l;a++){const[t,e]=o[a],n=(t-this.min)/s;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var WE;function qE(t,e){var n,r,i;if(nO(t)){var o,s=t.stops&&"object"==typeof t.stops[0][0],a=s||void 0!==t.property,l=s||!a,h=t.type||e||"exponential";if("exponential"===h)o=YE;else if("interval"===h)o=ZE;else if("categorical"===h)o=XE;else if("identity"===h)o=KE;else if("color-interpolate"===h)o=QE;else{if("calculate-expression"!==h)throw new Error('Unknown function type "'+h+'"');o=$E}if(s){var u={},c=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===u[f[0].zoom]&&(u[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in u)c.push([u[t].zoom,qE(u[t])]);n=function(e,n){const r=YE({stops:c,base:t.base},e)(e,n);return"function"==typeof r?r(e,n):r},r=!1,i=!1}else l?(n=function(e){const n=o(t,e);return"function"==typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=o(t,n?n[t.property]:null);return"function"==typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function XE(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function ZE(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function YE(t,e){for(var n=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:tO(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(WE=new Map);const JE={width:100,height:1};function QE(t,e){const n=t.stops;if(n&&n.length>1){let t;if(WE){const e=JSON.stringify(n);if(!WE.has(e)){const t=new GE(n,JE);WE.set(e,t)}t=WE.get(e)}else t=new GE(n,JE);const[r,i,o,s]=t.getColor(e);return[r/255,i/255,o/255,s/255]}return n&&1===n.length?n[0][1]:null}function KE(t,e){return n=e,r=t.default,void 0!==n?n:void 0!==r?r:null;var n,r}function $E(t,e){const n=String(t.property),r=t.expression,i=e;function o(e){return null==e||""===e||isNaN(e)?t.default:e}if(null==e||""===e||isNaN(e)||e<0)return o(t.default);{const e=function t(e,n,r){const i=Number(r),o=String(n);return Array.isArray(e)?e.map((e=>t(e,o,i))):e===o?i:e}(r,n,i);return o(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const r=n[0];if(!["+","-","*","/"].includes(r))throw new Error(`Unknown operator: ${r}`);const i=n.slice(1).map((t=>e(t)));switch(r){case"+":return i.reduce(((t,e)=>t+e),0);case"-":return i.reduce(((t,e)=>t-e));case"*":return i.reduce(((t,e)=>t*e),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${r}`)}}}(e))}}function tO(t,e,n,r,i,o){return"function"==typeof i?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return tO(t,e,n,r,s,a)}:i.length?function(t,e,n,r,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=eO(t,e,n,r,i[a],o[a]);return s}(t,e,n,r,i,o):eO(t,e,n,r,i,o)}function eO(t,e,n,r,i,o){var s,a=r-n,l=t-n;return i*(1-(s=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+o*s}function nO(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function rO(t){for(const e in t)if(nO(t[e]))return!0;return!1}function iO(t){return aO(t,"exponential")}function oO(t){return aO(t,"interval")}function sO(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var r,i=[];for(let o=0;o<t.length;o++)(r=sO(t[o],e))?(i.push(r),n=!0):i.push(t[o]);return n?i:t}var o,s={__fn_types_loaded:!0},a=[];for(o in t)t.hasOwnProperty(o)&&a.push(o);const l=function(t){Object.defineProperty(s,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=iO(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let h=0,u=a.length;h<u;h++)nO(t[o=a[h]])?(n=!0,s["_"+o]=t[o],l(o)):s[o]=t[o];return n?s:t}function aO(t,e){if(!nO(t))return function(){return t};let n=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let s=0;s<i.length;s++)if(nO(i[s][1])){const t=aO(i[s][1],e);n=n&&t.isZoomConstant,r=r&&t.isFeatureConstant,i[s]=[i[s][0],t]}const o=qE(t,e);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=r&&o.isFeatureConstant,o}var lO={exports:{}},hO={exports:{}},uO=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},cO=Array.prototype.concat,fO=Array.prototype.slice,dO=hO.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];uO(i)?e=cO.call(e,fO.call(i)):e.push(i)}return e};dO.wrap=function(t){return function(){return t(dO(arguments))}};var pO=hO.exports,gO={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},mO=pO,AO=Object.hasOwnProperty,yO=Object.create(null);for(var vO in gO)AO.call(gO,vO)&&(yO[gO[vO]]=vO);var xO=lO.exports={to:{},get:{}};function _O(t,e,n){return Math.min(Math.max(e,t),n)}function bO(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}xO.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=xO.get.hsl(t),n="hsl";break;case"hwb":e=xO.get.hwb(t),n="hwb";break;default:e=xO.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},xO.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var o=2*n;i[n]=parseInt(e.slice(o,o+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:AO.call(gO,e[1])?((i=gO[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=_O(i[n],0,255);return i[3]=_O(i[3],0,1),i},xO.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,_O(parseFloat(e[2]),0,100),_O(parseFloat(e[3]),0,100),_O(isNaN(n)?1:n,0,1)]}return null},xO.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,_O(parseFloat(e[2]),0,100),_O(parseFloat(e[3]),0,100),_O(isNaN(n)?1:n,0,1)]}return null},xO.to.hex=function(){var t=mO(arguments);return"#"+bO(t[0])+bO(t[1])+bO(t[2])+(t[3]<1?bO(Math.round(255*t[3])):"")},xO.to.rgb=function(){var t=mO(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},xO.to.rgb.percent=function(){var t=mO(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},xO.to.hsl=function(){var t=mO(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},xO.to.hwb=function(){var t=mO(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},xO.to.keyword=function(t){return yO[t.slice(0,3)]};var wO=lO.exports,TO={exports:{}},MO={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},CO={};for(var SO in MO)MO.hasOwnProperty(SO)&&(CO[MO[SO]]=SO);var IO=TO.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var PO in IO)if(IO.hasOwnProperty(PO)){if(!("channels"in IO[PO]))throw new Error("missing channels property: "+PO);if(!("labels"in IO[PO]))throw new Error("missing channel labels property: "+PO);if(IO[PO].labels.length!==IO[PO].channels)throw new Error("channel and label counts mismatch: "+PO);var EO=IO[PO].channels,OO=IO[PO].labels;delete IO[PO].channels,delete IO[PO].labels,Object.defineProperty(IO[PO],"channels",{value:EO}),Object.defineProperty(IO[PO],"labels",{value:OO})}IO.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.min(r,i,o),a=Math.max(r,i,o),l=a-s;return a===s?e=0:r===a?e=(i-o)/l:i===a?e=2+(o-r)/l:o===a&&(e=4+(r-i)/l),(e=Math.min(60*e,360))<0&&(e+=360),n=(s+a)/2,[e,100*(a===s?0:n<=.5?l/(a+s):l/(2-a-s)),100*n]},IO.rgb.hsv=function(t){var e,n,r,i,o,s=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(s,a,l),u=h-Math.min(s,a,l),c=function(t){return(h-t)/6/u+.5};return 0===u?i=o=0:(o=u/h,e=c(s),n=c(a),r=c(l),s===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*o,100*h]},IO.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[IO.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},IO.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},IO.rgb.keyword=function(t){var e=CO[t];if(e)return e;var n,r,i,o=1/0;for(var s in MO)if(MO.hasOwnProperty(s)){var a=MO[s],l=(r=t,i=a,Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));l<o&&(o=l,n=s)}return n},IO.keyword.rgb=function(t){return MO[t]},IO.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},IO.rgb.lab=function(t){var e=IO.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},IO.hsl.rgb=function(t){var e,n,r,i,o,s=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return[o=255*l,o,o];e=2*l-(n=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(r=s+1/3*-(h-1))<0&&r++,r>1&&r--,o=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*o;return i},IO.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,o=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=o<=1?o:2-o,[e,100*(0===r?2*i/(o+i):2*n/(r+n)),100*((r+n)/2)]},IO.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,o=e-Math.floor(e),s=255*r*(1-n),a=255*r*(1-n*o),l=255*r*(1-n*(1-o));switch(r*=255,i){case 0:return[r,l,s];case 1:return[a,r,s];case 2:return[s,r,l];case 3:return[s,a,r];case 4:return[l,s,r];case 5:return[r,s,a]}},IO.hsv.hsl=function(t){var e,n,r,i=t[0],o=t[1]/100,s=t[2]/100,a=Math.max(s,.01);return r=(2-o)*s,n=o*a,[i,100*(n=(n/=(e=(2-o)*a)<=1?e:2-e)||0),100*(r/=2)]},IO.hwb.rgb=function(t){var e,n,r,i,o,s,a,l=t[0]/360,h=t[1]/100,u=t[2]/100,c=h+u;switch(c>1&&(h/=c,u/=c),r=6*l-(e=Math.floor(6*l)),1&e&&(r=1-r),i=h+r*((n=1-u)-h),e){default:case 6:case 0:o=n,s=i,a=h;break;case 1:o=i,s=n,a=h;break;case 2:o=h,s=n,a=i;break;case 3:o=h,s=i,a=n;break;case 4:o=i,s=h,a=n;break;case 5:o=n,s=h,a=i}return[255*o,255*s,255*a]},IO.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},IO.xyz.rgb=function(t){var e,n,r,i=t[0]/100,o=t[1]/100,s=t[2]/100;return n=-.9689*i+1.8758*o+.0415*s,r=.0557*i+-.204*o+1.057*s,e=(e=3.2406*i+-1.5372*o+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},IO.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},IO.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(r,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},IO.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},IO.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},IO.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:IO.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var o=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(o+=60),o},IO.hsv.ansi16=function(t){return IO.rgb.ansi16(IO.hsv.rgb(t),t[2])},IO.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},IO.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},IO.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},IO.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},IO.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},IO.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,o=Math.max(Math.max(n,r),i),s=Math.min(Math.min(n,r),i),a=o-s;return e=a<=0?0:o===n?(r-i)/a%6:o===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?s/(1-a):0)]},IO.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},IO.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},IO.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,o=[0,0,0],s=e%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return i=(1-n)*r,[255*(n*o[0]+i),255*(n*o[1]+i),255*(n*o[2]+i)]},IO.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},IO.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},IO.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},IO.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},IO.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},IO.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},IO.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},IO.gray.hsl=IO.gray.hsv=function(t){return[0,0,t[0]]},IO.gray.hwb=function(t){return[0,100,t[0]]},IO.gray.cmyk=function(t){return[0,0,0,t[0]]},IO.gray.lab=function(t){return[t[0],0,0]},IO.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},IO.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var RO=TO.exports,kO=RO;function LO(t){var e=function(){for(var t={},e=Object.keys(kO),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(kO[r]),o=i.length,s=0;s<o;s++){var a=i[s],l=e[a];-1===l.distance&&(l.distance=e[r].distance+1,l.parent=r,n.unshift(a))}return e}function DO(t,e){return function(n){return e(t(n))}}function NO(t,e){for(var n=[e[t].parent,t],r=kO[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=DO(kO[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var FO=RO,zO=function(t){for(var e=LO(t),n={},r=Object.keys(e),i=r.length,o=0;o<i;o++){var s=r[o];null!==e[s].parent&&(n[s]=NO(s,e))}return n},BO={};Object.keys(FO).forEach((function(t){BO[t]={},Object.defineProperty(BO[t],"channels",{value:FO[t].channels}),Object.defineProperty(BO[t],"labels",{value:FO[t].labels});var e=zO(t);Object.keys(e).forEach((function(n){var r=e[n];BO[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),BO[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var HO=wO,jO=BO,UO=[].slice,VO=["keyword","gray","hex"],GO={};Object.keys(jO).forEach((function(t){GO[UO.call(jO[t].labels).sort().join("")]=t}));var WO={};function qO(t,e){if(!(this instanceof qO))return new qO(t,e);if(e&&e in VO&&(e=null),e&&!(e in jO))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof qO)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=HO.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=jO[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=jO[this.model].channels;var o=UO.call(t,0,r);this.color=YO(o,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var s=Object.keys(t);"alpha"in t&&(s.splice(s.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=s.sort().join("");if(!(a in GO))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=GO[a];var l=jO[this.model].labels,h=[];for(n=0;n<l.length;n++)h.push(t[l[n]]);this.color=YO(h)}if(WO[this.model])for(r=jO[this.model].channels,n=0;n<r;n++){var u=WO[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function XO(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(WO[t]||(WO[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function ZO(t){return function(e){return Math.max(0,Math.min(t,e))}}function YO(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}qO.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in HO.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return HO.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return HO.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=jO[this.model].channels,n=jO[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new qO(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new qO(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:XO("rgb",0,ZO(255)),green:XO("rgb",1,ZO(255)),blue:XO("rgb",2,ZO(255)),hue:XO(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:XO("hsl",1,ZO(100)),lightness:XO("hsl",2,ZO(100)),saturationv:XO("hsv",1,ZO(100)),value:XO("hsv",2,ZO(100)),chroma:XO("hcg",1,ZO(100)),gray:XO("hcg",2,ZO(100)),white:XO("hwb",1,ZO(100)),wblack:XO("hwb",2,ZO(100)),cyan:XO("cmyk",0,ZO(100)),magenta:XO("cmyk",1,ZO(100)),yellow:XO("cmyk",2,ZO(100)),black:XO("cmyk",3,ZO(100)),x:XO("xyz",0,ZO(100)),y:XO("xyz",1,ZO(100)),z:XO("xyz",2,ZO(100)),l:XO("lab",0,ZO(100)),a:XO("lab",1),b:XO("lab",2),keyword:function(t){return arguments.length?new qO(t):jO[this.model].keyword(this.color)},hex:function(t){return arguments.length?new qO(t):HO.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return qO.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,o=2*i-1,s=n.alpha()-r.alpha(),a=((o*s==-1?o:(o+s)/(1+o*s))+1)/2,l=1-a;return qO.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(jO).forEach((function(t){if(-1===VO.indexOf(t)){var e=jO[t].channels;qO.prototype[t]=function(){if(this.model===t)return new qO(this);if(arguments.length)return new qO(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new qO((n=jO[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},qO[t]=function(n){return"number"==typeof n&&(n=YO(UO.call(arguments),e)),new qO(n,t)}}}));const JO=e(qO),QO=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function KO(t){return new Function("f",`var p = (f && f.properties || {}); return ${tR(t)}`)}function $O(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"==typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const e of t.slice(1))if(!$O(e)&&"boolean"!=typeof e)return!1;return!0;case"contains":return!0;default:return!1}}function tR(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return`(${"=="===e?nR(t[1],t[2],"===",!1):"!="===e?nR(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?nR(t[1],t[2],e,!0):"any"===e?iR(t.slice(1),"||"):"all"===e?iR(t.slice(1),"&&"):"none"===e?aR(iR(t.slice(1),"||")):"in"===e?oR(t[1],t.slice(2)):"!in"===e?aR(oR(t[1],t.slice(2))):"has"===e?sR(t[1]):"!has"===e?aR(sR(t[1])):"contains"===e?function(t,e,n){const r=eR(t);return void 0!==n?`(${r} + '').indexOf("${e}") === ${n}`:`(${r} + '').indexOf("${e}") >= 0`}(t[1],t[2],t[3]):"true"})`}function eR(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function nR(t,e,n,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,e,n,r){const i=t.property,o=t.op;let s=eR(i);return"length"!==o?(console.error(`not support ${o} op`),"false"):(s=`((${s}+='').length)`,rR(s,i,e,n,r))}(t,e,n,r);var i;return rR(eR(t),t,e,n,r)}function rR(t,e,n,r,i){const o="$type"===e?QO.indexOf(n):JSON.stringify(n);return(i?`typeof ${t}=== typeof ${o}&&`:"")+t+r+o}function iR(t,e){return t.map(tR).join(e)}function oR(t,e){"$type"===t&&(e=e.map((t=>QO.indexOf(t))));const n=JSON.stringify(e.sort(lR)),r=eR(t);return e.length<=200?`${n}.indexOf(${r}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${r}, ${n},0,${e.length-1})`}function sR(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function aR(t){return`!(${t})`}function lR(t,e){return t<e?-1:t>e?1:0}function hR(t){if(!Array.isArray(t))return hR([t]);const e=[];for(let n=0;n<t.length;n++){let r;r=!0===t[n].filter?function(){return!0}:KO(t[n].filter),e.push(uR({},t[n],{filter:r}))}return e}function uR(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}var cR={exports:{}};cR.exports=function(){function t(t,n,i,o,s){e(t,n,i||0,o||t.length-1,s||r)}function e(t,r,i,o,s){for(;o>i;){if(o-i>600){var a=o-i+1,l=r-i+1,h=Math.log(a),u=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*u*(a-u)/a)*(l-a/2<0?-1:1);e(t,r,Math.max(i,Math.floor(r-l*u/a+c)),Math.min(o,Math.floor(r+(a-l)*u/a+c)),s)}var f=t[r],d=i,p=o;for(n(t,i,r),s(t[o],f)>0&&n(t,i,o);d<p;){for(n(t,d,p),d++,p--;s(t[d],f)<0;)d++;for(;s(t[p],f)>0;)p--}0===s(t[i],f)?n(t,i,p):n(t,++p,o),p<=r&&(i=p+1),r<=p&&(o=p-1)}}function n(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function r(t,e){return t<e?-1:t>e?1:0}return t}();const fR=e(cR.exports);var dR={exports:{}};function pR(t,e,n){n=n||2;var r,i,o,s,a,l,h,u=e&&e.length,c=u?e[0]*n:t.length,f=gR(t,0,c,n,!0),d=[];if(!f||f.next===f.prev)return d;if(u&&(f=function(t,e,n,r){var i,o,s,a=[];for(i=0,o=e.length;i<o;i++)(s=gR(t,e[i]*r,i<o-1?e[i+1]*r:t.length,r,!1))===s.next&&(s.steiner=!0),a.push(CR(s));for(a.sort(bR),i=0;i<a.length;i++)n=wR(a[i],n);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=s=t[1];for(var p=n;p<c;p+=n)(a=t[p])<r&&(r=a),(l=t[p+1])<i&&(i=l),a>o&&(o=a),l>s&&(s=l);h=0!==(h=Math.max(o-r,s-i))?32767/h:0}return AR(f,d,n,r,i,h,0),d}function gR(t,e,n,r,i){var o,s;if(i===BR(t,e,n,r)>0)for(o=e;o<n;o+=r)s=NR(o,t[o],t[o+1],s);else for(o=n-r;o>=e;o-=r)s=NR(o,t[o],t[o+1],s);return s&&ER(s,s.next)&&(FR(s),s=s.next),s}function mR(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!ER(r,r.next)&&0!==PR(r.prev,r,r.next))r=r.next;else{if(FR(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function AR(t,e,n,r,i,o,s){if(t){!s&&o&&function(t,e,n,r){var i=t;do{0===i.z&&(i.z=MR(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,s,a,l,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,r=n,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,h*=2}while(s>1)}(i)}(t,r,i,o);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,o?vR(t,r,i,o):yR(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),FR(t),t=l.next,h=l.next;else if((t=l)===h){s?1===s?AR(t=xR(mR(t),e,n),e,n,r,i,o,2):2===s&&_R(t,e,n,r,i,o):AR(mR(t),e,n,r,i,o,1);break}}}function yR(t){var e=t.prev,n=t,r=t.next;if(PR(e,n,r)>=0)return!1;for(var i=e.x,o=n.x,s=r.x,a=e.y,l=n.y,h=r.y,u=i<o?i<s?i:s:o<s?o:s,c=a<l?a<h?a:h:l<h?l:h,f=i>o?i>s?i:s:o>s?o:s,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=u&&p.x<=f&&p.y>=c&&p.y<=d&&SR(i,a,o,l,s,h,p.x,p.y)&&PR(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function vR(t,e,n,r){var i=t.prev,o=t,s=t.next;if(PR(i,o,s)>=0)return!1;for(var a=i.x,l=o.x,h=s.x,u=i.y,c=o.y,f=s.y,d=a<l?a<h?a:h:l<h?l:h,p=u<c?u<f?u:f:c<f?c:f,g=a>l?a>h?a:h:l>h?l:h,m=u>c?u>f?u:f:c>f?c:f,A=MR(d,p,e,n,r),y=MR(g,m,e,n,r),v=t.prevZ,x=t.nextZ;v&&v.z>=A&&x&&x.z<=y;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&SR(a,u,l,c,h,f,v.x,v.y)&&PR(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==i&&x!==s&&SR(a,u,l,c,h,f,x.x,x.y)&&PR(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=A;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&SR(a,u,l,c,h,f,v.x,v.y)&&PR(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=d&&x.x<=g&&x.y>=p&&x.y<=m&&x!==i&&x!==s&&SR(a,u,l,c,h,f,x.x,x.y)&&PR(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function xR(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!ER(i,o)&&OR(i,r,r.next,o)&&LR(i,o)&&LR(o,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(o.i/n|0),FR(r),FR(r.next),r=t=o),r=r.next}while(r!==t);return mR(r)}function _R(t,e,n,r,i,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&IR(s,a)){var l=DR(s,a);return s=mR(s,s.next),l=mR(l,l.next),AR(s,e,n,r,i,o,0),void AR(l,e,n,r,i,o,0)}a=a.next}s=s.next}while(s!==t)}function bR(t,e){return t.x-e.x}function wR(t,e){var n=function(t,e){var n,r=e,i=t.x,o=t.y,s=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var a=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>s&&(s=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,u=n.x,c=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=u&&i!==r.x&&SR(o<c?i:s,o,u,c,o<c?s:i,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(i-r.x),LR(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&TR(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}(t,e);if(!n)return e;var r=DR(n,t);return mR(r,r.next),mR(n,n.next)}function TR(t,e){return PR(t.prev,t,e.prev)<0&&PR(e.next,t,t.next)<0}function MR(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function CR(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function SR(t,e,n,r,i,o,s,a){return(i-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(r-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(i-s)*(r-a)}function IR(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&OR(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(LR(t,e)&&LR(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(PR(t.prev,t,e.prev)||PR(t,e.prev,e))||ER(t,e)&&PR(t.prev,t,t.next)>0&&PR(e.prev,e,e.next)>0)}function PR(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function ER(t,e){return t.x===e.x&&t.y===e.y}function OR(t,e,n,r){var i=kR(PR(t,e,n)),o=kR(PR(t,e,r)),s=kR(PR(n,r,t)),a=kR(PR(n,r,e));return i!==o&&s!==a||(!(0!==i||!RR(t,n,e))||(!(0!==o||!RR(t,r,e))||(!(0!==s||!RR(n,t,r))||!(0!==a||!RR(n,e,r)))))}function RR(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function kR(t){return t>0?1:t<0?-1:0}function LR(t,e){return PR(t.prev,t,t.next)<0?PR(t,e,t.next)>=0&&PR(t,t.prev,e)>=0:PR(t,e,t.prev)<0||PR(t,t.next,e)<0}function DR(t,e){var n=new zR(t.i,t.x,t.y),r=new zR(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function NR(t,e,n,r){var i=new zR(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function FR(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function zR(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function BR(t,e,n,r){for(var i=0,o=e,s=n-r;o<n;o+=r)i+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return i}dR.exports=pR,dR.exports.default=pR,pR.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,s=Math.abs(BR(t,0,o,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,u=a<l-1?e[a+1]*n:t.length;s-=Math.abs(BR(t,h,u,n))}var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;c+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},pR.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[i][o][s]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n};const HR=e(dR.exports);var jR=Math.pow,UR=Math.sqrt,VR=Math.sin,GR=Math.cos,WR=Math.PI,qR=1.70158,XR=1.525*qR,ZR=qR+1,YR=2*WR/3,JR=2*WR/4.5;function QR(t){var e=7.5625,n=2.75;return t<1/n?e*t*t:t<2/n?e*(t-=1.5/n)*t+.75:t<2.5/n?e*(t-=2.25/n)*t+.9375:e*(t-=2.625/n)*t+.984375}function KR(t,e){switch(t=t.toLowerCase()){case"swing":return function(t){return $R(t)}(e);case"easeinquad":return $R(e);case"easeoutquad":return function(t){return 1-(1-t)*(1-t)}(e);case"easeinoutquad":return function(t){return t<.5?2*t*t:1-jR(-2*t+2,2)/2}(e);case"easeincubic":return function(t){return t*t*t}(e);case"easeoutcubic":return function(t){return 1-jR(1-t,3)}(e);case"easeinoutcubic":return function(t){return t<.5?4*t*t*t:1-jR(-2*t+2,3)/2}(e);case"easeinquart":return function(t){return t*t*t*t}(e);case"easeoutquart":return function(t){return 1-jR(1-t,4)}(e);case"easeinoutquart":return function(t){return t<.5?8*t*t*t*t:1-jR(-2*t+2,4)/2}(e);case"easeinquint":return function(t){return t*t*t*t*t}(e);case"easeoutquint":return function(t){return 1-jR(1-t,5)}(e);case"easeinoutquint":return function(t){return t<.5?16*t*t*t*t*t:1-jR(-2*t+2,5)/2}(e);case"easeinsine":return function(t){return 1-GR(t*WR/2)}(e);case"easeoutsine":return function(t){return VR(t*WR/2)}(e);case"easeinoutsine":return function(t){return-(GR(WR*t)-1)/2}(e);case"easeinexpo":return function(t){return 0===t?0:jR(2,10*t-10)}(e);case"easeoutexpo":return function(t){return 1===t?1:1-jR(2,-10*t)}(e);case"easeinoutexpo":return function(t){return 0===t?0:1===t?1:t<.5?jR(2,20*t-10)/2:(2-jR(2,-20*t+10))/2}(e);case"easeincirc":return function(t){return 1-UR(1-jR(t,2))}(e);case"easeoutcirc":return function(t){return UR(1-jR(t-1,2))}(e);case"easeinoutcirc":return function(t){return t<.5?(1-UR(1-jR(2*t,2)))/2:(UR(1-jR(-2*t+2,2))+1)/2}(e);case"easeinelastic":return function(t){return 0===t?0:1===t?1:-jR(2,10*t-10)*VR((10*t-10.75)*YR)}(e);case"easeoutelastic":return function(t){return 0===t?0:1===t?1:jR(2,-10*t)*VR((10*t-.75)*YR)+1}(e);case"easeinoutelastic":return function(t){return 0===t?0:1===t?1:t<.5?-jR(2,20*t-10)*VR((20*t-11.125)*JR)/2:jR(2,-20*t+10)*VR((20*t-11.125)*JR)/2+1}(e);case"easeinback":return function(t){return ZR*t*t*t-qR*t*t}(e);case"easeoutback":return function(t){return 1+ZR*jR(t-1,3)+qR*jR(t-1,2)}(e);case"easeinoutback":return function(t){return t<.5?jR(2*t,2)*(2*(XR+1)*t-XR)/2:(jR(2*t-2,2)*((XR+1)*(2*t-2)+XR)+2)/2}(e);case"easeinbounce":return function(t){return 1-QR(1-t)}(e);case"easeoutbounce":return function(t){return QR(t)}(e);case"easeinoutbounce":return function(t){return t<.5?(1-QR(1-2*t))/2:(1+QR(2*t-1))/2}(e)}throw new Error("Unsupported easing function:"+t)}function $R(t){return t*t}function tk(){}const ek=tk.prototype;ek.getType=function(){return Object.getPrototypeOf(this).constructor.type},ek.isVisible=function(){throw new Error("to be implemented.")},ek.prepareRender=function(){throw new Error("to be implemented.")},ek.updateCollision=function(){throw new Error("to be implemented.")},ek.supportRenderMode=function(){throw new Error("to be implemented.")},ek.startFrame=function(){throw new Error("to be implemented.")},ek.endFrame=function(){throw new Error("to be implemented.")},ek.paintTile=function(){throw new Error("to be implemented.")},ek.getShadowMeshes=function(){throw new Error("to be implemented.")},ek.updateSceneConfig=function(){throw new Error("to be implemented.")},ek.updateDataConfig=function(){throw new Error("to be implemented.")},ek.updateSymbol=function(){throw new Error("to be implemented.")},ek.pick=function(){throw new Error("to be implemented.")},ek.resize=function(){throw new Error("to be implemented.")},ek.deleteTile=function(){throw new Error("to be implemented.")},ek.remove=function(){throw new Error("to be implemented.")},ek.needToRedraw=function(){throw new Error("to be implemented.")},ek.needToRetireFrames=function(){throw new Error("to be implemented.")},ek.outline=function(){throw new Error("to be implemented.")},ek.outlineAll=function(){throw new Error("to be implemented.")},ek.needPolygonOffset=function(){throw new Error("to be implemented.")},ek.constructor=tk;const nk=Object.prototype.hasOwnProperty;function rk(t){t.registerPlugin(this)}function ik(t,e,n,r,i){ok(t,e,n||0,r||t.length-1,i||ak)}function ok(t,e,n,r,i){for(;r>n;){if(r-n>600){var o=r-n+1,s=e-n+1,a=Math.log(o),l=.5*Math.exp(2*a/3),h=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);ok(t,e,Math.max(n,Math.floor(e-s*l/o+h)),Math.min(r,Math.floor(e+(o-s)*l/o+h)),i)}var u=t[e],c=n,f=r;for(sk(t,n,e),i(t[r],u)>0&&sk(t,n,r);c<f;){for(sk(t,c,f),c++,f--;i(t[c],u)<0;)c++;for(;i(t[f],u)>0;)f--}0===i(t[n],u)?sk(t,n,f):sk(t,++f,r),f<=e&&(n=f+1),e<=f&&(r=f-1)}}function sk(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function ak(t,e){return t<e?-1:t>e?1:0}tk.extend=function(t,e){const n=function(){this.init&&this.init()},r=Object.create(ek);r.constructor=n,n.prototype=r,n.type=t;for(const i in e)nk.call(e,i)&&(n.prototype[i]=e[i]);return n.registerAt=rk.bind(n),n};class lk{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!vk(t,e))return n;const r=this.toBBox,i=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],a=e.leaf?r(s):s;vk(t,a)&&(e.leaf?n.push(s):yk(t,a)?this._all(s,n):i.push(s))}e=i.pop()}return n}collides(t){let e=this.data;if(!vk(t,e))return!1;const n=[];for(;e;){for(let r=0;r<e.children.length;r++){const i=e.children[r],o=e.leaf?this.toBBox(i):i;if(vk(t,o)){if(e.leaf||yk(t,o))return!0;n.push(i)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=xk([]),this}remove(t,e){if(!t)return this;let n=this.data;const r=this.toBBox(t),i=[],o=[];let s,a,l;for(;n||i.length;){if(n||(n=i.pop(),a=i[i.length-1],s=o.pop(),l=!0),n.leaf){const r=hk(t,n.children,e);if(-1!==r)return n.children.splice(r,1),i.push(n),this._condense(i),this}l||n.leaf||!yk(n,r)?a?(s++,n=a.children[s],l=!1):n=null:(i.push(n),o.push(s),s=0,a=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,r){const i=n-e+1;let o,s=this._maxEntries;if(i<=s)return o=xk(t.slice(e,n+1)),uk(o,this.toBBox),o;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),o=xk([]),o.leaf=!1,o.height=r;const a=Math.ceil(i/s),l=a*Math.ceil(Math.sqrt(s));_k(t,e,n,l,this.compareMinX);for(let h=e;h<=n;h+=l){const e=Math.min(h+l-1,n);_k(t,h,e,a,this.compareMinY);for(let n=h;n<=e;n+=a){const i=Math.min(n+a-1,e);o.children.push(this._build(t,n,i,r-1))}}return uk(o,this.toBBox),o}_chooseSubtree(t,e,n,r){for(;r.push(e),!e.leaf&&r.length-1!==n;){let n,r=1/0,s=1/0;for(let a=0;a<e.children.length;a++){const l=e.children[a],h=gk(l),u=(i=t,o=l,(Math.max(o.maxX,i.maxX)-Math.min(o.minX,i.minX))*(Math.max(o.maxY,i.maxY)-Math.min(o.minY,i.minY))-h);u<s?(s=u,r=h<r?h:r,n=l):u===s&&h<r&&(r=h,n=l)}e=n||e.children[0]}var i,o;return e}_insert(t,e,n){const r=n?t:this.toBBox(t),i=[],o=this._chooseSubtree(r,this.data,e,i);for(o.children.push(t),fk(o,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)}_split(t,e){const n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);const o=this._chooseSplitIndex(n,i,r),s=xk(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,uk(n,this.toBBox),uk(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)}_splitRoot(t,e){this.data=xk([t,e]),this.data.height=t.height+1,this.data.leaf=!1,uk(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let r,i=1/0,o=1/0;for(let s=e;s<=n-e;s++){const e=ck(t,0,s,this.toBBox),a=ck(t,s,n,this.toBBox),l=Ak(e,a),h=gk(e)+gk(a);l<i?(i=l,r=s,o=h<o?h:o):l===i&&h<o&&(o=h,r=s)}return r||n-e}_chooseSplitAxis(t,e,n){const r=t.leaf?this.compareMinX:dk,i=t.leaf?this.compareMinY:pk;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)}_allDistMargin(t,e,n,r){t.children.sort(r);const i=this.toBBox,o=ck(t,0,e,i),s=ck(t,n-e,n,i);let a=mk(o)+mk(s);for(let l=e;l<n-e;l++){const e=t.children[l];fk(o,t.leaf?i(e):e),a+=mk(o)}for(let l=n-e-1;l>=e;l--){const e=t.children[l];fk(s,t.leaf?i(e):e),a+=mk(s)}return a}_adjustParentBBoxes(t,e,n){for(let r=n;r>=0;r--)fk(e[r],t)}_condense(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():uk(t[n],this.toBBox)}}function hk(t,e,n){if(!n)return e.indexOf(t);for(let r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function uk(t,e){ck(t,0,t.children.length,e,t)}function ck(t,e,n,r,i){i||(i=xk(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o=e;o<n;o++){const e=t.children[o];fk(i,t.leaf?r(e):e)}return i}function fk(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function dk(t,e){return t.minX-e.minX}function pk(t,e){return t.minY-e.minY}function gk(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function mk(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Ak(t,e){const n=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),i=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,i-n)*Math.max(0,o-r)}function yk(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function vk(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function xk(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function _k(t,e,n,r,i){const o=[e,n];for(;o.length;){if((n=o.pop())-(e=o.pop())<=r)continue;const s=e+Math.ceil((n-e)/r/2)*r;ik(t,s,e,n,i),o.push(e,s,s,n)}}const bk="${",wk=`function(t){let n;const e={width:100,height:10};let r=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),r=!0}catch(t){r=!1}function i(){if(!n){const{width:t,height:i}=e;r?n=new OffscreenCanvas(t,i):(n=document.createElement("canvas"),n.width=t,n.height=i)}return n}class s{constructor(t,n={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let r=1/0,i=-1/0;for(let n=0,e=t.length;n<e;n++){const e=t[n][0];r=Math.min(e,r),i=Math.max(e,i)}this.min=r,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},e,n),this.t()}getImageData(){return this.imgData}t(){const t=i(),{width:n,height:e}=this.options;t.width=n,t.height=e;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const s=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:a}=this;for(let t=0,n=o.length;t<n;t++){const[n,e]=o[t],r=(n-this.min)/a;s.addColorStop(r,e)}r.fillStyle=s,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const n=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let e=Math.round(n*this.imgData.width);e=Math.min(e,this.imgData.width-1);const r=4*e;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var o;function a(t,n){var e,r,i;if(g(t)){var s,o=t.stops&&"object"==typeof t.stops[0][0],c=o||void 0!==t.property,y=o||!c,m=t.type||n||"exponential";if("exponential"===m)s=h;else if("interval"===m)s=l;else if("categorical"===m)s=u;else if("identity"===m)s=d;else if("color-interpolate"===m)s=f;else{if("calculate-expression"!==m)throw new Error('Unknown function type "'+m+'"');s=p}if(o){var v={},b=[];for(let n=0;n<t.stops.length;n++){var w=t.stops[n];void 0===v[w[0].zoom]&&(v[w[0].zoom]={zoom:w[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),v[w[0].zoom].stops.push([w[0].value,w[1]])}for(let t in v)b.push([v[t].zoom,a(v[t])]);e=function(n,e){const r=h({stops:b,base:t.base},n)(n,e);return"function"==typeof r?r(n,e):r},r=!1,i=!1}else y?(e=function(n){const e=s(t,n);return"function"==typeof e?e(n):e},r=!0,i=!1):(e=function(n,e){const r=s(t,e?e[t.property]:null);return"function"==typeof r?r(n,e):r},r=!1,i=!0)}else e=function(){return t},r=!0,i=!0;return e.isZoomConstant=i,e.isFeatureConstant=r,e}function u(t,n){for(let e=0;e<t.stops.length;e++)if(n===t.stops[e][0])return t.stops[e][1];return t.default}function l(t,n){for(var e=0;e<t.stops.length&&!(n<t.stops[e][0]);e++);return t.stops[Math.max(e-1,0)][1]}function h(t,n){for(var e=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||n<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:y(n,e,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(o=new Map);const c={width:100,height:1};function f(t,n){const e=t.stops;if(e&&e.length>1){let t;if(o){const n=JSON.stringify(e);if(!o.has(n)){const t=new s(e,c);o.set(n,t)}t=o.get(n)}else t=new s(e,c);const[r,i,a,u]=t.getColor(n);return[r/255,i/255,a/255,u/255]}return e&&1===e.length?e[0][1]:null}function d(t,n){return e=n,r=t.default,void 0!==e?e:void 0!==r?r:null;var e,r}function p(t,n){const e=String(t.property),r=t.expression,i=n;function s(n){return null==n||""===n||isNaN(n)?t.default:n}if(null==n||""===n||isNaN(n)||n<0)return s(t.default);{const n=function t(n,e,r){const i=Number(r),s=String(e);return Array.isArray(n)?n.map((n=>t(n,s,i))):n===s?i:n}(r,e,i);return s(function n(e){if(!Array.isArray(e)){if("number"==typeof e)return e;throw new Error("Invalid expression format")}{const r=e[0];if(!["+","-","*","/"].includes(r))throw new Error(\`Unknown operator: ${bk}r}\`);const i=e.slice(1).map((t=>n(t)));switch(r){case"+":return i.reduce(((t,n)=>t+n),0);case"-":return i.reduce(((t,n)=>t-n));case"*":return i.reduce(((t,n)=>t*n),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,n)=>t/n));default:throw new Error(\`Unsupported operator: ${bk}r}\`)}}}(n))}}function y(t,n,e,r,i,s){return"function"==typeof i?function(){var o=i.apply(void 0,arguments),a=s.apply(void 0,arguments);return y(t,n,e,r,o,a)}:i.length?function(t,n,e,r,i,s){var o=[];for(let a=0;a<i.length;a++)o[a]=m(t,n,e,r,i[a],s[a]);return o}(t,n,e,r,i,s):m(t,n,e,r,i,s)}function m(t,n,e,r,i,s){var o,a=r-e,u=t-e;return i*(1-(o=1===n?u/a:(Math.pow(n,u)-1)/(Math.pow(n,a)-1)))+s*o}function g(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function v(t){return M(t,"exponential")}function b(t){return M(t,"interval")}function w(t,n){if(!t)return null;var e=!1;if(Array.isArray(t)){var r,i=[];for(let s=0;s<t.length;s++)(r=w(t[s],n))?(i.push(r),e=!0):i.push(t[s]);return e?i:t}var s,o={__fn_types_loaded:!0},a=[];for(s in t)t.hasOwnProperty(s)&&a.push(s);const u=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=v(this["_"+t])),this["__fn_"+t].apply(this,n())},set:function(n){this["_"+t]=n},configurable:!0,enumerable:!0})};for(let n=0,r=a.length;n<r;n++)g(t[s=a[n]])?(e=!0,o["_"+s]=t[s],u(s)):o[s]=t[s];return e?o:t}function M(t,n){if(!g(t))return function(){return t};let e=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(g(i[t][1])){const s=M(i[t][1],n);e=e&&s.isZoomConstant,r=r&&s.isFeatureConstant,i[t]=[i[t][0],s]}const s=a(t,n);return s.isZoomConstant=e&&s.isZoomConstant,s.isFeatureConstant=r&&s.isFeatureConstant,s}let x=0;const F="function"==typeof Object.assign;function k(t,...n){if(F)return Object.assign(t,...n),t;for(let e=0;e<n.length;e++){const r=n[e];for(const n in r)t[n]=r[n]}return t}function A(t){return!O(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function P(t){return"number"==typeof t&&!isNaN(t)}function S(t){return!O(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function _(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function O(t){return null==t}function C(t){return g(t)&&t.property}const E="function"==typeof fetch&&"function"==typeof AbortController,$={jsonp:function(t,n){const e="_maptalks_jsonp_"+x++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[e]=function(t){n(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[e]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,n,e){if(S(n)){const t=e;e=n,n=t}(n=n||{}).method&&(n.method=n.method.toUpperCase());const r="POST"===n.method;if(E){const r=new AbortController,i=n;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const s=new Request(t,i);return n.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then((r=>{const i=this.o(r,n.returnJSON,n.responseType);i.message?(i.url=t,e(i)):i.then((t=>{"arraybuffer"===n.responseType?e(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):e(null,t)})).catch((n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))}))})).catch((n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))})),r}{const i=$.u(e);if(i.open(n.method||"GET",t,!0),n){for(const t in n.headers)i.setRequestHeader(t,n.headers[t]);i.withCredentials="include"===n.credentials,n.responseType&&(i.responseType=n.responseType)}return i.send(r?n.body:null),i}},o:(t,n,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${bk}t.status}): ${bk}t.statusText}\`}:"arraybuffer"===e?t.arrayBuffer():n?t.json():t.text(),m:function(t,n){return function(){if(4===t.readyState)if(200===t.status)if("arraybuffer"===t.responseType){0===t.response.byteLength?n({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):n(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")})}else n(null,t.responseText);else n({status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${bk}t.status}): ${bk}t.statusText}\`})}},u:function(t){let n;try{n=new XMLHttpRequest}catch(t){try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return n.onreadystatechange=$.m(n,t),n},getArrayBuffer(t,n,e){if(S(n)){const t=e;e=n,n=t}return n||(n={}),n.responseType="arraybuffer",$.get(t,n,e)}};function I(t,n,e,r,i=3){let s=r;const o=e-n>>1;let a,u=e-n;const l=t[n],h=t[n+1],c=t[e],f=t[e+1];for(let r=n+i;r<e;r+=i){const n=z(t[r],t[r+1],l,h,c,f);if(n>s)a=r,s=n;else if(n===s){const t=Math.abs(r-o);t<u&&(a=r,u=t)}}s>r&&(a-n>i&&I(t,n,a,r,i),t[a+2]=s,e-a>i&&I(t,a,e,r,i))}function z(t,n,e,r,i,s){let o=i-e,a=s-r;if(0!==o||0!==a){const u=((t-e)*o+(n-r)*a)/(o*o+a*a);u>1?(e=i,r=s):u>0&&(e+=o*u,r+=a*u)}return o=t-e,a=n-r,o*o+a*a}function D(t,n,e,r,i,s){const o={id:null==t?null:t,type:n,geometry:e,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};i&&(o.layer=i);return function(t,n){const e=t.geometry,r=t.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)T(t,e,n);else if("Polygon"===r)T(t,e[0],n);else if("MultiLineString"===r)for(const r of e)T(t,r,n);else if("MultiPolygon"===r)for(const r of e)T(t,r[0],n)}(o,s?4:3),o}function T(t,n,e){for(let r=0;r<n.length;r+=e)t.minX=Math.min(t.minX,n[r]),t.minY=Math.min(t.minY,n[r+1]),t.maxX=Math.max(t.maxX,n[r]),t.maxY=Math.max(t.maxY,n[r+1])}function U(t,n,e,r){if(r.layer=n,"FeatureCollection"===e.type)for(let n=0;n<e.features.length;n++)j(t,e.features[n],r,n);else"Feature"===e.type?j(t,e,r):j(t,{geometry:e},r)}function j(t,n,e,r){if(!n.geometry)return;const i=n.geometry.coordinates,s=n.geometry.type,o=Math.pow(e.tolerance/((1<<e.maxZoom)*e.extent),2);let a=[],u=n.id;if(e.promoteId?u=n.properties[e.promoteId]:e.generateId&&(u=r||0),"Point"===s)N(i,a,e);else if("MultiPoint"===s)for(const t of i)N(t,a,e);else if("LineString"===s)L(i,a,o,!1,e);else if("MultiLineString"===s){if(e.lineMetrics){for(const r of i)a=[],L(r,a,o,!1,e),t.push(D(u,"LineString",a,n.properties,e.layer,e.hasAltitude));return}H(i,a,o,!1,e)}else if("Polygon"===s)H(i,a,o,!0,e);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(const i of n.geometry.geometries)j(t,{id:u,geometry:i,properties:n.properties},e,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const t of i){const n=[];H(t,n,o,!0,e),a.push(n)}}t.push(D(u,s,a,n.properties,e.layer,e.hasAltitude))}function N(t,n,e){n.push(R(t[0]),V(t[1],e.projection),0),e.hasAltitude&&(t.length>2?n.push(t[2]):n.push(0))}function L(t,n,e,r,i){let s,o,a=0;for(let e=0;e<t.length;e++){const u=R(t[e][0]),l=V(t[e][1],i.projection);n.push(u,l,0),i.hasAltitude&&(t[e].length>2?n.push(t[e][2]):n.push(0)),e>0&&(a+=r?(s*l-u*o)/2:Math.sqrt(Math.pow(u-s,2)+Math.pow(l-o,2))),s=u,o=l}const u=i.hasAltitude?4:3,l=n.length-u;n[2]=1,I(n,0,l,e,u),n[l+2]=1,n.size=Math.abs(a),n.start=0,n.end=n.size}function H(t,n,e,r,i){for(let s=0;s<t.length;s++){const o=[];L(t[s],o,e,r,i),n.push(o)}}function R(t){return t/360+.5}function V(t,n){if("EPSG:4326"===n)return(90-t)/360;const e=Math.sin(t*Math.PI/180),r=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return r<0?0:r>1?1:r}function q(t,n,e,r,i,s,o,a){if(r/=n,s>=(e/=n)&&o<r)return t;if(o<e||s>=r)return null;const u=[];for(const n of t){const t=n.geometry;let s=n.type;const o=0===i?n.minX:n.minY,l=0===i?n.maxX:n.maxY;if(o>=e&&l<r){u.push(n);continue}if(l<e||o>=r)continue;let h=[];if("Point"===s||"MultiPoint"===s)G(t,h,e,r,i,a.hasAltitude);else if("LineString"===s)J(t,h,e,r,i,!1,a.lineMetrics,a.hasAltitude);else if("MultiLineString"===s)B(t,h,e,r,i,!1,a.hasAltitude);else if("Polygon"===s)B(t,h,e,r,i,!0,a.hasAltitude);else if("MultiPolygon"===s)for(const n of t){const t=[];B(n,t,e,r,i,!0,a.hasAltitude),t.length&&h.push(t)}if(h.length){if(a.lineMetrics&&"LineString"===s){for(const t of h)u.push(D(n.id,s,t,n.tags,n.layer,a.hasAltitude));continue}"LineString"!==s&&"MultiLineString"!==s||(1===h.length?(s="LineString",h=h[0]):s="MultiLineString"),"Point"!==s&&"MultiPoint"!==s||(s=3===h.length?"Point":"MultiPoint"),u.push(D(n.id,s,h,n.tags,n.layer,a.hasAltitude))}}return u.length?u:null}function G(t,n,e,r,i,s){const o=s?4:3;for(let a=0;a<t.length;a+=o){const o=t[a+i];o>=e&&o<=r&&(X(n,t[a],t[a+1],t[a+2]),s&&n.push(t[a+3]))}}function J(t,n,e,r,i,s,o,a){let u=W(t);const l=0===i?Y:K;let h,c,f=t.start;const d=a?4:3,p=s?t.length:t.length-d;for(let y=0;y<p;y+=d){const m=t[y],g=t[y+1],v=t[y+2];let b,w,M,x;s&&y===p-d?(b=t[0],w=t[1]):(b=t[y+d],w=t[y+d+1]),a&&(M=t[y+3],x=s&&y===p-d?t[3]:t[y+d+3]);const F=0===i?m:g,k=0===i?b:w;let A=!1;o&&(h=Math.sqrt(Math.pow(m-b,2)+Math.pow(g-w,2))),F<e?k>e&&(c=l(u,m,g,b,w,e),a&&u.push(Z(M,x,c)),o&&(u.start=f+h*c)):F>r?k<r&&(c=l(u,m,g,b,w,r),a&&u.push(Z(M,x,c)),o&&(u.start=f+h*c)):(X(u,m,g,v),a&&u.push(M)),k<e&&F>=e&&(c=l(u,m,g,b,w,e),a&&u.push(Z(M,x,c)),A=!0),k>r&&F<=r&&(c=l(u,m,g,b,w,r),a&&u.push(Z(M,x,c)),A=!0),!s&&A&&(o&&(u.end=f+h*c),n.push(u),u=W(t)),o&&(f+=h)}let y=t.length-d;if(!s){const n=t[y],s=t[y+1],o=t[y+2],l=0===i?n:s;if(l>=e&&l<=r&&X(u,n,s,o),l>=e&&l<=r&&a){const n=t[y+3];u.push(n)}}y=u.length-d,s&&y>=d&&(u[y]!==u[0]||u[y+1]!==u[1])&&(X(u,u[0],u[1],u[2]),a&&u.push(u[3])),u.length&&n.push(u)}function W(t){const n=[];return n.size=t.size,n.start=t.start,n.end=t.end,n}function B(t,n,e,r,i,s,o){for(const a of t)J(a,n,e,r,i,s,!1,o)}function X(t,n,e,r){t.push(n,e,r)}function Y(t,n,e,r,i,s){const o=(s-n)/(r-n);return X(t,s,e+(i-e)*o,1),o}function K(t,n,e,r,i,s){const o=(s-e)/(i-e);return X(t,n+(r-n)*o,s,1),o}function Z(t,n,e){return t+(n-t)*e}function Q(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=t[i],o=s.type;let a;if("Point"===o||"MultiPoint"===o||"LineString"===o)a=tt(s.geometry,n,e);else if("MultiLineString"===o||"Polygon"===o){a=[];for(const t of s.geometry)a.push(tt(t,n,e))}else if("MultiPolygon"===o){a=[];for(const t of s.geometry){const r=[];for(const i of t)r.push(tt(i,n,e));a.push(r)}}r.push(D(s.id,o,a,s.tags,s.layer,e))}return r}function tt(t,n,e){const r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);const i=e?4:3;for(let s=0;s<t.length;s+=i)r.push(t[s]+n,t[s+1],t[s+2]),e&&r.push(t[s+3]);return r}function nt(t,n,e){if(t.transformed)return t;const r=1<<t.z,i=t.x,s=t.y,o=e?3:2;for(const a of t.features){const t=a.geometry,u=a.type;if(a.geometry=[],1===u)for(let u=0;u<t.length;u+=o)a.geometry.push(et(t[u],t[u+1],n,r,i,s)),e&&a.geometry[a.geometry.length-1].push(t[u+2]);else for(let u=0;u<t.length;u++){const l=[];for(let a=0;a<t[u].length;a+=o)l.push(et(t[u][a],t[u][a+1],n,r,i,s)),e&&l[l.length-1].push(t[u][a+2]);a.geometry.push(l)}}return t.transformed=!0,t}function et(t,n,e,r,i,s){return[Math.round(e*(t*r-i)),Math.round(e*(n*r-s))]}function rt(t,n,e,r,i){const s=n===i.maxZoom?0:i.tolerance/((1<<n)*i.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:e,y:r,z:n,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const n of t)it(o,n,s,i);return o}function it(t,n,e,r){const i=n.geometry,s=n.type,o=[],a=r.hasAltitude?4:3;if(t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),"Point"===s||"MultiPoint"===s)for(let n=0;n<i.length;n+=a)o.push(i[n],i[n+1]),r.hasAltitude&&o.push(i[n+3]),t.numPoints++,t.numSimplified++;else if("LineString"===s)ot(o,i,t,e,!1,!1,r);else if("MultiLineString"===s||"Polygon"===s)for(let n=0;n<i.length;n++)ot(o,i[n],t,e,"Polygon"===s,0===n,r);else if("MultiPolygon"===s)for(let n=0;n<i.length;n++){const s=i[n];for(let n=0;n<s.length;n++)ot(o,s[n],t,e,!0,0===n,r)}if(o.length){let e=n.tags||null;if("LineString"===s&&r.lineMetrics){e={};for(const t in n.tags)e[t]=n.tags[t];e.mapbox_clip_start=i.start/i.size,e.mapbox_clip_end=i.end/i.size}const a={geometry:o,type:"Polygon"===s||"MultiPolygon"===s?3:"LineString"===s||"MultiLineString"===s?2:1,tags:e};n.layer&&(a.layer=n.layer),null!==n.id&&(a.id=n.id),t.features.push(a)}}function st(t,n,e){return 0===t[n+2]&&t[n+3]>0&&e}function ot(t,n,e,r,i,s,o){const a=r*r,{hasAltitude:u,disableFilter:l}=o,h=u?4:3;if(!l&&r>0&&n.size<(i?a:r))return void(e.numPoints+=n.length/h);const c=[];for(let t=0;t<n.length;t+=h)(0===r||n[t+2]>a||st(n,t,u))&&(e.numSimplified++,c.push(n[t],n[t+1]),u&&c.push(n[t+3])),e.numPoints++;i&&function(t,n,e){const r=e?3:2;let i=0;for(let n=0,e=t.length,s=e-r;n<e;s=n,n+=r)i+=(t[n]-t[s])*(t[n+1]+t[s+1]);if(i>0===n){const n=r,i=r-1,s=r-2;for(let o=0,a=t.length;o<a/2;o+=r){const r=t[o],u=t[o+1];let l;e&&(l=t[o+2]),t[o]=t[a-n-o],t[o+1]=t[a-i-o],e&&(t[o+2]=t[a-s-o]),t[a-n-o]=r,t[a-i-o]=u,e&&(t[a-s-o]=l)}}}(c,s,u),t.push(c)}$.getJSON=function(t,n,e){if(S(n)){const t=e;e=n,n=t}const r=function(t,n){const r="string"==typeof n?JSON.parse(n):n||null;e(t,r)};return n&&n.jsonp?$.jsonp(t,r):((n=n||{}).returnJSON=!0,$.get(t,n,r))};const at={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,hasAltitude:!1,disableFilter:!1,debug:0};class ut{constructor(t,n){const e=(n=this.options=function(t,n){for(const e in n)t[e]=n[e];return t}(Object.create(at),n)).debug;if(e&&console.time("preprocess data"),n.maxZoom<0||n.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(n.promoteId&&n.generateId)throw new Error("promoteId and generateId cannot be used together.");let r=function(t,n){const e=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++)U(e,t[r].layer,t[r].data,n);return e}if("FeatureCollection"===t.type)for(let r=0;r<t.features.length;r++)j(e,t.features[r],n,r);else"Feature"===t.type?j(e,t,n):j(e,{geometry:t},n);return e}(t,n);this.tiles={},this.tileCoords=[],e&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",n.indexMaxZoom,n.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(t,n){const e=n.buffer/n.extent;let r=t;const i=q(t,1,-1-e,e,0,-1,2,n),s=q(t,1,1-e,2+e,0,-1,2,n);return(i||s)&&(r=q(t,1,-e,1+e,0,-1,2,n)||[],i&&(r=Q(i,1,n.hasAltitude).concat(r)),s&&(r=r.concat(Q(s,-1,n.hasAltitude)))),r}(r,n),r.length&&this.splitTile(r,0,0,0),e&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,n,e,r,i,s,o){const a=[t,n,e,r],u=this.options,l=u.debug;for(;a.length;){r=a.pop(),e=a.pop(),n=a.pop(),t=a.pop();const h=1<<n,c=lt(n,e,r);let f=this.tiles[c];if(!f&&(l>1&&console.time("creation"),f=this.tiles[c]=rt(t,n,e,r,u),this.tileCoords.push({z:n,x:e,y:r}),l)){l>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",n,e,r,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const t=\`z${bk}n}\`;this.stats[t]=(this.stats[t]||0)+1,this.total++}if(f.source=t,null==i){if(n===u.indexMaxZoom||f.numPoints<=u.indexMaxPoints)continue}else{if(n===u.maxZoom||n===i)continue;if(null!=i){const t=i-n;if(e!==s>>t||r!==o>>t)continue}}if(f.source=null,0===t.length)continue;l>1&&console.time("clipping");const d=.5*u.buffer/u.extent,p=.5-d,y=.5+d,m=1+d;let g=null,v=null,b=null,w=null,M=q(t,h,e-d,e+y,0,f.minX,f.maxX,u),x=q(t,h,e+p,e+m,0,f.minX,f.maxX,u);t=null,M&&(g=q(M,h,r-d,r+y,1,f.minY,f.maxY,u),v=q(M,h,r+p,r+m,1,f.minY,f.maxY,u),M=null),x&&(b=q(x,h,r-d,r+y,1,f.minY,f.maxY,u),w=q(x,h,r+p,r+m,1,f.minY,f.maxY,u),x=null),l>1&&console.timeEnd("clipping"),a.push(g||[],n+1,2*e,2*r),a.push(v||[],n+1,2*e,2*r+1),a.push(b||[],n+1,2*e+1,2*r),a.push(w||[],n+1,2*e+1,2*r+1)}}getTile(t,n,e){t=+t,n=+n,e=+e;const r=this.options,{extent:i,debug:s}=r,{hasAltitude:o,wrapX:a}=r;if(t<0||t>24)return null;if(a){const e=1<<t;n=n+e&e-1}const u=lt(t,n,e);if(this.tiles[u])return nt(this.tiles[u],i,o);s>1&&console.log("drilling down to z%d-%d-%d",t,n,e);let l,h=t,c=n,f=e;for(;!l&&h>0;)h--,c>>=1,f>>=1,l=this.tiles[lt(h,c,f)];return l&&l.source?(s>1&&(console.log("found parent tile z%d-%d-%d",h,c,f),console.time("drilling down")),this.splitTile(l.source,h,c,f,t,n,e),s>1&&console.timeEnd("drilling down"),this.tiles[u]?nt(this.tiles[u],i,o):null):null}}function lt(t,n,e){return 32*((1<<t)*e+n)+t}function ht(t,n,e,r,i,s,o){const a=e&&Array.isArray(e[0]);for(let u=0,l=e.length;u<l;u++){t[n]=(a?e[u][0]:e[u].x)*r,t[n+1]=(a?e[u][1]:e[u].y)*r,o!==Float32Array&&(t[n]=Math.round(t[n]),t[n+1]=Math.round(t[n+1]));let h=i||0;Array.isArray(i)&&(h=i[u]),h=h?Math.round(r*h):0,t[n+2]=h,n+=3,s&&0!==u&&u!==l-1&&(t[n]=t[n-3],t[n+1]=t[n-2],t[n+2]=t[n-1],n+=3)}return t.trySetLength&&t.trySetLength(n),n}function ct(t,n,e,r){const i=t[3*n],s=t[3*n+1],o=t[3*e],a=t[3*e+1];return i===o&&(i<0||i>r)||s===a&&(s<0||s>r)}var ft="undefined"!=typeof Float32Array?Float32Array:Array;function dt(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t}function pt(t,n){var e=n[0],r=n[1],i=n[2],s=e*e+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),t[0]=n[0]*s,t[1]=n[1]*s,t[2]=n[2]*s,t}function yt(t,n,e){var r=n[0],i=n[1],s=n[2],o=e[0],a=e[1],u=e[2];return t[0]=i*u-s*a,t[1]=s*o-r*u,t[2]=r*a-i*o,t}function mt(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}function gt(t,n,e,r,i){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t}function vt(t,n,e){return t[0]=n[0]/e[0],t[1]=n[1]/e[1],t[2]=n[2]/e[2],t[3]=n[3]/e[3],t}function bt(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t}function wt(t,n,e){return t[0]=n,t[1]=e,t}function Mt(t,n){var e=n[0]-t[0],r=n[1]-t[1];return Math.hypot(e,r)}Math.hypot||(Math.hypot=function(){for(var t=0,n=arguments.length;n--;)t+=arguments[n]*arguments[n];return Math.sqrt(t)}),function(){var t,n=(t=new ft(3),ft!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t)}(),function(){var t,n=(t=new ft(4),ft!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var xt=function(t){var n=t[0],e=t[1];return Math.hypot(n,e)};!function(){var t,n=(t=new ft(2),ft!=Float32Array&&(t[0]=0,t[1]=0),t)}();const Ft=Math.PI/180,kt=6378137*Math.PI/180,At=85.0511287798;function Pt(t,n,e){if("EPSG:3857"===e)return function(t,n){const e=At,r=n[0],i=Math.max(Math.min(e,n[1]),-e);let s;s=0===i?0:Math.log(Math.tan((90+i)*Ft/2))/Ft;return t[0]=r*kt,t[1]=s*kt,t}(t,n);if("EPSG:4326"===e||"EPSG:4490"===e||"identity"===e)return St(t,n);if("baidu"===e)return St(t,n);throw new Error("unsupported projection:"+e)}function St(t,n){return t[0]=n[0],t[1]=n[1],t}function _t(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){0===t?function(t,n,e,r,i,s,o,a,u,l){const h=1/(100*s[0]),c=1/(100*s[1]),f=l&&l[0]||0,d=l&&l[1]||0,p=[0,0];for(let i=t;i<n;i+=3){const t=i/3*2,n=r[i]-f,s=r[i+1]-d;e[t]=p[0]+n/o*h/a,e[t+1]=p[1]-s/o*c/u}}(n,e,r,i,0,o,a,u,l,p):1===t&&function(t,n,e,r,i,s,o,a,u,l,h){if(!t)return;let c,f,d,p;0===t[4]?(c=t[0],f=t[1],d=t[2],p=t[3]):(c=t[1],f=t[2],d=t[3],p=t[0]);const y=Mt(c,f),m=Mt(f,d),g=[],v=[],b=[];for(let t=n;t<e;t+=3){const n=t/3*2;wt(g,(s.x/u+i[t]/o)*a,s.y/u*a+(h?i[t+1]:-i[t+1])/o*a),"EPSG:4326"!==l&&"EPSG:4490"!==l||Pt(g,g,"EPSG:3857"),Ot(v,g,c,f),Ot(b,g,p,c),r[n]=Mt(c,v)/y,r[n+1]=Mt(c,b)/m}}(h,n,e,r,i,s,a,c,f,d,!!p)}function Ot(t,n,e,r){const i=e[0]-r[0],s=e[1]-r[1];let o=(n[0]-e[0])*(e[0]-r[0])+(n[1]-e[1])*(e[1]-r[1]);return o/=i*i+s*s,t[0]=e[0]+o*i,t[1]=e[1]+o*s,t}function Ct(t,n,e,r,i){const s=3*n[e-1],o=3*n[e-1]+1,a=t[s],u=t[o];return l=r,h=i,c=a,f=u,Math.sqrt((c-l)*(c-l)+(f-h)*(f-h));var l,h,c,f}"undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self&&self;function Et(t){return t&&t.M&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var $t={exports:{}};function It(t,n,e){e=e||2;var r,i,s,o,a,u,l,h=n&&n.length,c=h?n[0]*e:t.length,f=zt(t,0,c,e,!0),d=[];if(!f||f.next===f.prev)return d;if(h&&(f=function(t,n,e,r){var i,s,o,a=[];for(i=0,s=n.length;i<s;i++)(o=zt(t,n[i]*r,i<s-1?n[i+1]*r:t.length,r,!1))===o.next&&(o.steiner=!0),a.push(Gt(o));for(a.sort(Ht),i=0;i<a.length;i++)e=Rt(a[i],e);return e}(t,n,f,e)),t.length>80*e){r=s=t[0],i=o=t[1];for(var p=e;p<c;p+=e)(a=t[p])<r&&(r=a),(u=t[p+1])<i&&(i=u),a>s&&(s=a),u>o&&(o=u);l=0!==(l=Math.max(s-r,o-i))?32767/l:0}return Tt(f,d,e,r,i,l,0),d}function zt(t,n,e,r,i){var s,o;if(i===sn(t,n,e,r)>0)for(s=n;s<e;s+=r)o=nn(s,t[s],t[s+1],o);else for(s=e-r;s>=n;s-=r)o=nn(s,t[s],t[s+1],o);return o&&Xt(o,o.next)&&(en(o),o=o.next),o}function Dt(t,n){if(!t)return t;n||(n=t);var e,r=t;do{if(e=!1,r.steiner||!Xt(r,r.next)&&0!==Bt(r.prev,r,r.next))r=r.next;else{if(en(r),(r=n=r.prev)===r.next)break;e=!0}}while(e||r!==n);return n}function Tt(t,n,e,r,i,s,o){if(t){!o&&s&&function(t,n,e,r){var i=t;do{0===i.z&&(i.z=qt(i.x,i.y,n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var n,e,r,i,s,o,a,u,l=1;do{for(e=t,t=null,s=null,o=0;e;){for(o++,r=e,a=0,n=0;n<l&&(a++,r=r.nextZ);n++);for(u=l;a>0||u>0&&r;)0!==a&&(0===u||!r||e.z<=r.z)?(i=e,e=e.nextZ,a--):(i=r,r=r.nextZ,u--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;e=r}s.nextZ=null,l*=2}while(o>1)}(i)}(t,r,i,s);for(var a,u,l=t;t.prev!==t.next;)if(a=t.prev,u=t.next,s?jt(t,r,i,s):Ut(t))n.push(a.i/e|0),n.push(t.i/e|0),n.push(u.i/e|0),en(t),t=u.next,l=u.next;else if((t=u)===l){o?1===o?Tt(t=Nt(Dt(t),n,e),n,e,r,i,s,2):2===o&&Lt(t,n,e,r,i,s):Tt(Dt(t),n,e,r,i,s,1);break}}}function Ut(t){var n=t.prev,e=t,r=t.next;if(Bt(n,e,r)>=0)return!1;for(var i=n.x,s=e.x,o=r.x,a=n.y,u=e.y,l=r.y,h=i<s?i<o?i:o:s<o?s:o,c=a<u?a<l?a:l:u<l?u:l,f=i>s?i>o?i:o:s>o?s:o,d=a>u?a>l?a:l:u>l?u:l,p=r.next;p!==n;){if(p.x>=h&&p.x<=f&&p.y>=c&&p.y<=d&&Jt(i,a,s,u,o,l,p.x,p.y)&&Bt(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function jt(t,n,e,r){var i=t.prev,s=t,o=t.next;if(Bt(i,s,o)>=0)return!1;for(var a=i.x,u=s.x,l=o.x,h=i.y,c=s.y,f=o.y,d=a<u?a<l?a:l:u<l?u:l,p=h<c?h<f?h:f:c<f?c:f,y=a>u?a>l?a:l:u>l?u:l,m=h>c?h>f?h:f:c>f?c:f,g=qt(d,p,n,e,r),v=qt(y,m,n,e,r),b=t.prevZ,w=t.nextZ;b&&b.z>=g&&w&&w.z<=v;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&Jt(a,h,u,c,l,f,b.x,b.y)&&Bt(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&Jt(a,h,u,c,l,f,w.x,w.y)&&Bt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;b&&b.z>=g;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&Jt(a,h,u,c,l,f,b.x,b.y)&&Bt(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;w&&w.z<=v;){if(w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&Jt(a,h,u,c,l,f,w.x,w.y)&&Bt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Nt(t,n,e){var r=t;do{var i=r.prev,s=r.next.next;!Xt(i,s)&&Yt(i,r,r.next,s)&&Qt(i,s)&&Qt(s,i)&&(n.push(i.i/e|0),n.push(r.i/e|0),n.push(s.i/e|0),en(r),en(r.next),r=t=s),r=r.next}while(r!==t);return Dt(r)}function Lt(t,n,e,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Wt(o,a)){var u=tn(o,a);return o=Dt(o,o.next),u=Dt(u,u.next),Tt(o,n,e,r,i,s,0),void Tt(u,n,e,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function Ht(t,n){return t.x-n.x}function Rt(t,n){var e=function(t,n){var e,r=n,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,e=r.x<r.next.x?r:r.next,a===i))return e}r=r.next}while(r!==n);if(!e)return null;var u,l=e,h=e.x,c=e.y,f=1/0;r=e;do{i>=r.x&&r.x>=h&&i!==r.x&&Jt(s<c?i:o,s,h,c,s<c?o:i,s,r.x,r.y)&&(u=Math.abs(s-r.y)/(i-r.x),Qt(r,t)&&(u<f||u===f&&(r.x>e.x||r.x===e.x&&Vt(e,r)))&&(e=r,f=u)),r=r.next}while(r!==l);return e}(t,n);if(!e)return n;var r=tn(e,t);return Dt(r,r.next),Dt(e,e.next)}function Vt(t,n){return Bt(t.prev,t,n.prev)<0&&Bt(n.next,t,t.next)<0}function qt(t,n,e,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function Gt(t){var n=t,e=t;do{(n.x<e.x||n.x===e.x&&n.y<e.y)&&(e=n),n=n.next}while(n!==t);return e}function Jt(t,n,e,r,i,s,o,a){return(i-o)*(n-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(e-o)*(n-a)&&(e-o)*(s-a)>=(i-o)*(r-a)}function Wt(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var e=t;do{if(e.i!==t.i&&e.next.i!==t.i&&e.i!==n.i&&e.next.i!==n.i&&Yt(e,e.next,t,n))return!0;e=e.next}while(e!==t);return!1}(t,n)&&(Qt(t,n)&&Qt(n,t)&&function(t,n){var e=t,r=!1,i=(t.x+n.x)/2,s=(t.y+n.y)/2;do{e.y>s!=e.next.y>s&&e.next.y!==e.y&&i<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(r=!r),e=e.next}while(e!==t);return r}(t,n)&&(Bt(t.prev,t,n.prev)||Bt(t,n.prev,n))||Xt(t,n)&&Bt(t.prev,t,t.next)>0&&Bt(n.prev,n,n.next)>0)}function Bt(t,n,e){return(n.y-t.y)*(e.x-n.x)-(n.x-t.x)*(e.y-n.y)}function Xt(t,n){return t.x===n.x&&t.y===n.y}function Yt(t,n,e,r){var i=Zt(Bt(t,n,e)),s=Zt(Bt(t,n,r)),o=Zt(Bt(e,r,t)),a=Zt(Bt(e,r,n));return i!==s&&o!==a||(!(0!==i||!Kt(t,e,n))||(!(0!==s||!Kt(t,r,n))||(!(0!==o||!Kt(e,t,r))||!(0!==a||!Kt(e,n,r)))))}function Kt(t,n,e){return n.x<=Math.max(t.x,e.x)&&n.x>=Math.min(t.x,e.x)&&n.y<=Math.max(t.y,e.y)&&n.y>=Math.min(t.y,e.y)}function Zt(t){return t>0?1:t<0?-1:0}function Qt(t,n){return Bt(t.prev,t,t.next)<0?Bt(t,n,t.next)>=0&&Bt(t,t.prev,n)>=0:Bt(t,n,t.prev)<0||Bt(t,t.next,n)<0}function tn(t,n){var e=new rn(t.i,t.x,t.y),r=new rn(n.i,n.x,n.y),i=t.next,s=n.prev;return t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,s.next=r,r.prev=s,r}function nn(t,n,e,r){var i=new rn(t,n,e);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function en(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function rn(t,n,e){this.i=t,this.x=n,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function sn(t,n,e,r){for(var i=0,s=n,o=e-r;s<e;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}$t.exports=It,$t.exports.default=It,It.deviation=function(t,n,e,r){var i=n&&n.length,s=i?n[0]*e:t.length,o=Math.abs(sn(t,0,s,e));if(i)for(var a=0,u=n.length;a<u;a++){var l=n[a]*e,h=a<u-1?n[a+1]*e:t.length;o-=Math.abs(sn(t,l,h,e))}var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*e,d=r[a+1]*e,p=r[a+2]*e;c+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},It.flatten=function(t){for(var n=t[0][0].length,e={vertices:[],holes:[],dimensions:n},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<n;o++)e.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,e.holes.push(r))}return e};var on=Et($t.exports),an=un;function un(t,n){this.x=t,this.y=n}un.prototype={clone:function(){return new un(this.x,this.y)},add:function(t){return this.clone().F(t)},sub:function(t){return this.clone().k(t)},multByPoint:function(t){return this.clone().A(t)},divByPoint:function(t){return this.clone().P(t)},mult:function(t){return this.clone().S(t)},div:function(t){return this.clone().O(t)},rotate:function(t){return this.clone().C(t)},rotateAround:function(t,n){return this.clone().I(t,n)},matMult:function(t){return this.clone().D(t)},unit:function(){return this.clone().T()},perp:function(){return this.clone().U()},round:function(){return this.clone().j()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var n=t.x-this.x,e=t.y-this.y;return n*n+e*e},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,n){return Math.atan2(this.x*n-this.y*t,this.x*t+this.y*n)},D:function(t){var n=t[0]*this.x+t[1]*this.y,e=t[2]*this.x+t[3]*this.y;return this.x=n,this.y=e,this},F:function(t){return this.x+=t.x,this.y+=t.y,this},k:function(t){return this.x-=t.x,this.y-=t.y,this},S:function(t){return this.x*=t,this.y*=t,this},O:function(t){return this.x/=t,this.y/=t,this},A:function(t){return this.x*=t.x,this.y*=t.y,this},P:function(t){return this.x/=t.x,this.y/=t.y,this},T:function(){return this.O(this.mag()),this},U:function(){var t=this.y;return this.y=this.x,this.x=-t,this},C:function(t){var n=Math.cos(t),e=Math.sin(t),r=n*this.x-e*this.y,i=e*this.x+n*this.y;return this.x=r,this.y=i,this},I:function(t,n){var e=Math.cos(t),r=Math.sin(t),i=n.x+e*(this.x-n.x)-r*(this.y-n.y),s=n.y+r*(this.x-n.x)+e*(this.y-n.y);return this.x=i,this.y=s,this},j:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},un.convert=function(t){return t instanceof un?t:Array.isArray(t)?new un(t[0],t[1]):t};var ln=Et(an);const hn={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function cn(t,n={}){var e=[];if("FeatureCollection"===t.type)for(var r=0;r<t.features.length;r++)fn(e,t.features[r],n,r);else"Feature"===t.type?fn(e,t,n):fn(e,{geometry:t},n);return e}function fn(t,n,e,r){if(n.geometry&&n.geometry.geometry){var i=n.geometry.coordinates,s=n.geometry.type,o=[],a=n.id;if(e.promoteId?a=n.properties[e.promoteId]:e.generateId&&(a=r||0),"Point"===s)dn(i,o);else if("MultiPoint"===s)for(var u=0;u<i.length;u++)dn(i[u],o);else if("LineString"===s)yn([i],o);else if("MultiLineString"===s){if(e.lineMetrics){for(u=0;u<i.length;u++)o=[],pn(i[u],o),t.push(mn(a,"LineString",o,n.properties));return}yn(i,o)}else if("Polygon"===s)yn(i,o);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(u=0;u<n.geometry.geometries.length;u++)fn(t,{id:a,geometry:n.geometry.geometries[u],properties:n.properties},e,r);return}return void console.warn(\`Input data type(${bk}s}) is not a valid GeoJSON geometry type.\`)}for(u=0;u<i.length;u++){var l=[];yn(i[u],l),o.push(l)}}t.push(mn(a,s,o,n.properties))}}function dn(t,n){const e=new ln(t[0],t[1]);e.z=100*(t[2]||0),n.push([e])}function pn(t,n){for(let e=0;e<t.length;e++){const r=t[e][0],i=t[e][1],s=new ln(r,i);s.z=100*(t[e][2]||0),n.push(s)}}function yn(t,n,e,r){for(var i=0;i<t.length;i++){var s=[];pn(t[i],s),n.push(s)}}function mn(t,n,e,r){return{id:void 0===t?null:t,type:hn[n],geometry:e,properties:r}}function gn(t,n,e){e=e||{},this.w=t||64,this.h=n||64,this.autoResize=!!e.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function vn(t,n,e){this.x=0,this.y=t,this.w=this.free=n,this.h=e}function bn(t,n,e,r,i,s,o){this.id=t,this.x=n,this.y=e,this.w=r,this.h=i,this.maxw=s||r,this.maxh=o||i,this.refcount=0}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     */function wn(t,{width:n,height:e},r,i){if(i){if(i.length!==n*e*r)throw new RangeError("mismatched image size")}else i=new Uint8Array(n*e*r);return t.width=n,t.height=e,t.data=i,t}function Mn(t,{width:n,height:e},r){if(n===t.width&&e===t.height)return;const i=wn({},{width:n,height:e},r);xn(t,i,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,e)},r),t.width=n,t.height=e,t.data=i.data}function xn(t,n,e,r,i,s){if(0===i.width||0===i.height)return n;if(i.width>t.width||i.height>t.height||e.x>t.width-i.width||e.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>n.width||i.height>n.height||r.x>n.width-i.width||r.y>n.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const o=t.data,a=n.data;if(o===a)return n;for(let u=0;u<i.height;u++){const l=((e.y+u)*t.width+e.x)*s,h=((r.y+u)*n.width+r.x)*s;for(let t=0;t<i.width*s;t++)a[h+t]=o[l+t]}return n}gn.prototype.pack=function(t,n){t=[].concat(t),n=n||{};for(var e,r,i,s,o=[],a=0;a<t.length;a++)if(e=t[a].w||t[a].width,r=t[a].h||t[a].height,i=t[a].id,e&&r){if(!(s=this.packOne(e,r,i)))continue;n.inPlace&&(t[a].x=s.x,t[a].y=s.y,t[a].id=s.id),o.push(s)}return this.shrink(),o},gn.prototype.packOne=function(t,n,e){var r,i,s,o,a,u,l,h,c={freebin:-1,shelf:-1,waste:1/0},f=0;if("string"==typeof e||"number"==typeof e){if(r=this.getBin(e))return this.ref(r),r;"number"==typeof e&&(this.maxId=Math.max(e,this.maxId))}else e=++this.maxId;for(o=0;o<this.freebins.length;o++){if(n===(r=this.freebins[o]).maxh&&t===r.maxw)return this.allocFreebin(o,t,n,e);n>r.maxh||t>r.maxw||n<=r.maxh&&t<=r.maxw&&(s=r.maxw*r.maxh-t*n)<c.waste&&(c.waste=s,c.freebin=o)}for(o=0;o<this.shelves.length;o++)if(f+=(i=this.shelves[o]).h,!(t>i.free)){if(n===i.h)return this.allocShelf(o,t,n,e);n>i.h||n<i.h&&(s=(i.h-n)*t)<c.waste&&(c.freebin=-1,c.waste=s,c.shelf=o)}return-1!==c.freebin?this.allocFreebin(c.freebin,t,n,e):-1!==c.shelf?this.allocShelf(c.shelf,t,n,e):n<=this.h-f&&t<=this.w?(i=new vn(f,this.w,n),this.allocShelf(this.shelves.push(i)-1,t,n,e)):this.autoResize?(a=u=this.h,((l=h=this.w)<=a||t>l)&&(h=2*Math.max(t,l)),(a<l||n>a)&&(u=2*Math.max(n,a)),this.resize(h,u),this.packOne(t,n,e)):null},gn.prototype.allocFreebin=function(t,n,e,r){var i=this.freebins.splice(t,1)[0];return i.id=r,i.w=n,i.h=e,i.refcount=0,this.bins[r]=i,this.ref(i),i},gn.prototype.allocShelf=function(t,n,e,r){var i=this.shelves[t].alloc(n,e,r);return this.bins[r]=i,this.ref(i),i},gn.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,n=0,e=0;e<this.shelves.length;e++){var r=this.shelves[e];n+=r.h,t=Math.max(r.w-r.free,t)}this.resize(t,n)}},gn.prototype.getBin=function(t){return this.bins[t]},gn.prototype.ref=function(t){if(1==++t.refcount){var n=t.h;this.stats[n]=1+(0|this.stats[n])}return t.refcount},gn.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},gn.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},gn.prototype.resize=function(t,n){this.w=t,this.h=n;for(var e=0;e<this.shelves.length;e++)this.shelves[e].resize(t);return!0},vn.prototype.alloc=function(t,n,e){if(t>this.free||n>this.h)return null;var r=this.x;return this.x+=t,this.free-=t,new bn(e,r,this.y,t,n,t,this.h)},vn.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};class Fn{constructor(t,n){wn(this,t,1,n)}resize(t){Mn(this,t,1)}clone(){return new Fn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){xn(t,n,e,r,i,1)}}class kn{constructor(t,n){wn(this,t,4,n)}resize(t){Mn(this,t,4)}clone(){return new kn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){xn(t,n,e,r,i,4)}}function An(t){let n=0;for(let e,r,i=0,s=t.length,o=s-1;i<s;o=i++)if(e=t[i],r=t[o],void 0!==e.x){if(e.z||r.z)return 1;n+=(r.x-e.x)*(e.y+r.y)}else{if(e[2]||r[2])return 1;n+=(r[0]-e[0])*(e[1]+r[1])}return n}function Pn(t,n,e,r,i){const s=t[n*r],o=t[n*r+1],a=t[e*r],u=t[e*r+1];return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function Sn(t,n,e){let r=e;return n&&t&&(r=+t[n]),isNaN(r)&&(r=e||0),100*r}function _n(t,n,e,r,i,s,o){n||0===n||(n=1);const a=Sn(t.properties,e,r),u=a*n;let l=(s?100*s:0)||a;return i?l=Sn(t.properties,i,s):o&&(l=a-Sn(t.properties,o,s)),l*=n,{altitude:u,height:l}}function On(t,n){return n<1/0&&(t.x<0||t.x>n||t.y<0||t.y>n)}function Cn(t){return null==t}function En(t,n,e){if(t===e||t===n)return t;const r=e-n;return((t-n)%r+r)%r+n}function $n(t,n){if(!n)return null;const e=new Map;for(let r=0;r<n.length;r++){const i=n[r],s=t[i];let o=e.get(s);o||(o=[],e.set(s,o)),o.push(i)}return e}function In(t){return!(t&t-1)&&0!==t}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     */class zn{constructor(t,n,{pixelRatio:e}){this.paddedRect=t,this.pixelRatio=e||1,this.padding=n}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class Dn{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n=Object.keys(t).length,e={},r=new gn(0,0,{autoResize:!0}),i=[],s=n>1?1:0;for(const n in t){const r=t[n],o={x:0,y:0,w:r.data.width+2*s,h:r.data.height+2*s};i.push(o),e[n]=new zn(o,s,r)}if(r.pack(i,{inPlace:!0}),!In(r.w)||!In(r.h)){const t=Tn(r.w),n=Tn(r.h);r.resize(t,n)}const o=new kn({width:r.w,height:r.h});for(const n in t){const r=t[n],i=e[n].paddedRect;kn.copy(r.data,o,{x:0,y:0},{x:i.x+s,y:i.y+s},r.data)}this.image=o,this.positions=e}}function Tn(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     * TODO 升级为potpack\n     */class Un{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n={},e=new gn(0,0,{autoResize:!0}),r=[];for(const e in t){const i=t[e],s=n[e]={};for(const t in i){const n=i[+t];if(!n||0===n.bitmap.width||0===n.bitmap.height)continue;const e={x:0,y:0,w:n.bitmap.width+2,h:n.bitmap.height+2};r.push(e),s[t]={rect:e,metrics:n.metrics}}}e.pack(r,{inPlace:!0});const i=new Fn({width:e.w,height:e.h});for(const e in t){const r=t[e];for(const t in r){const s=r[+t];if(!s||0===s.bitmap.width||0===s.bitmap.height)continue;const o=n[e][t].rect;Fn.copy(s.bitmap,i,{x:0,y:0},{x:o.x+1,y:o.y+1},s.bitmap)}}this.image=i,this.positions=n}}function jn(t){return t<65536?Uint16Array:Uint32Array}function Nn(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:(Math.pow(2,24),Float32Array)}function Ln(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function Hn(t,n){const e=t.getLength?t.getLength():t.length;if(t instanceof n)return t.slice(0,e);const r=new n(e);t=t.L||t;for(let n=0;n<e;n++)r[n]=t[n]||0;return r}function Rn(t){const n=t.type,e=[];if(1===n||4===n)for(let n=0;n<t.geometry.length;n++)dn(t.geometry[n],e);else if(2===n)yn(t.geometry,e);else if(3===n)yn(t.geometry,e);else if(5===n)yn(t.geometry,e);else if(6===n)for(let n=0;n<t.geometry.length;n++){const r=[];yn(t.geometry[n],r),e.push(r)}return t.geometry=e,t}var Vn={exports:{}},qn={exports:{}},Gn=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},Jn=Array.prototype.concat,Wn=Array.prototype.slice,Bn=qn.exports=function(t){for(var n=[],e=0,r=t.length;e<r;e++){var i=t[e];Gn(i)?n=Jn.call(n,Wn.call(i)):n.push(i)}return n};Bn.wrap=function(t){return function(){return t(Bn(arguments))}};var Xn=qn.exports,Yn={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},Kn=Xn,Zn=Object.hasOwnProperty,Qn=Object.create(null);for(var te in Yn)Zn.call(Yn,te)&&(Qn[Yn[te]]=te);var ne=Vn.exports={to:{},get:{}};function ee(t,n,e){return Math.min(Math.max(n,t),e)}function re(t){var n=Math.round(t).toString(16).toUpperCase();return n.length<2?"0"+n:n}ne.get=function(t){var n,e;switch(t.substring(0,3).toLowerCase()){case"hsl":n=ne.get.hsl(t),e="hsl";break;case"hwb":n=ne.get.hwb(t),e="hwb";break;default:n=ne.get.rgb(t),e="rgb"}return n?{model:e,value:n}:null},ne.get.rgb=function(t){if(!t)return null;var n,e,r,i=[0,0,0,1];if(n=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=n[2],n=n[1],e=0;e<3;e++){var s=2*e;i[e]=parseInt(n.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(n=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(n=n[1])[3],e=0;e<3;e++)i[e]=parseInt(n[e]+n[e],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(n=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(e=0;e<3;e++)i[e]=parseInt(n[e+1],0);n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}else{if(!(n=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(n=t.match(/^(\\w+)$/))?"transparent"===n[1]?[0,0,0,0]:Zn.call(Yn,n[1])?((i=Yn[n[1]])[3]=1,i):null:null;for(e=0;e<3;e++)i[e]=Math.round(2.55*parseFloat(n[e+1]));n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}for(e=0;e<3;e++)i[e]=ee(i[e],0,255);return i[3]=ee(i[3],0,1),i},ne.get.hsl=function(t){if(!t)return null;var n=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,ee(parseFloat(n[2]),0,100),ee(parseFloat(n[3]),0,100),ee(isNaN(e)?1:e,0,1)]}return null},ne.get.hwb=function(t){if(!t)return null;var n=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,ee(parseFloat(n[2]),0,100),ee(parseFloat(n[3]),0,100),ee(isNaN(e)?1:e,0,1)]}return null},ne.to.hex=function(){var t=Kn(arguments);return"#"+re(t[0])+re(t[1])+re(t[2])+(t[3]<1?re(Math.round(255*t[3])):"")},ne.to.rgb=function(){var t=Kn(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},ne.to.rgb.percent=function(){var t=Kn(arguments),n=Math.round(t[0]/255*100),e=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+n+"%, "+e+"%, "+r+"%)":"rgba("+n+"%, "+e+"%, "+r+"%, "+t[3]+")"},ne.to.hsl=function(){var t=Kn(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},ne.to.hwb=function(){var t=Kn(arguments),n="";return t.length>=4&&1!==t[3]&&(n=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+n+")"},ne.to.keyword=function(t){return Qn[t.slice(0,3)]};var ie=Vn.exports,se={exports:{}},oe={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},ae={};for(var ue in oe)oe.hasOwnProperty(ue)&&(ae[oe[ue]]=ue);var le=se.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var he in le)if(le.hasOwnProperty(he)){if(!("channels"in le[he]))throw new Error("missing channels property: "+he);if(!("labels"in le[he]))throw new Error("missing channel labels property: "+he);if(le[he].labels.length!==le[he].channels)throw new Error("channel and label counts mismatch: "+he);var ce=le[he].channels,fe=le[he].labels;delete le[he].channels,delete le[he].labels,Object.defineProperty(le[he],"channels",{value:ce}),Object.defineProperty(le[he],"labels",{value:fe})}le.rgb.hsl=function(t){var n,e,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),u=a-o;return a===o?n=0:r===a?n=(i-s)/u:i===a?n=2+(s-r)/u:s===a&&(n=4+(r-i)/u),(n=Math.min(60*n,360))<0&&(n+=360),e=(o+a)/2,[n,100*(a===o?0:e<=.5?u/(a+o):u/(2-a-o)),100*e]},le.rgb.hsv=function(t){var n,e,r,i,s,o=t[0]/255,a=t[1]/255,u=t[2]/255,l=Math.max(o,a,u),h=l-Math.min(o,a,u),c=function(t){return(l-t)/6/h+.5};return 0===h?i=s=0:(s=h/l,n=c(o),e=c(a),r=c(u),o===l?i=r-e:a===l?i=1/3+n-r:u===l&&(i=2/3+e-n),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*l]},le.rgb.hwb=function(t){var n=t[0],e=t[1],r=t[2];return[le.rgb.hsl(t)[0],100*(1/255*Math.min(n,Math.min(e,r))),100*(r=1-1/255*Math.max(n,Math.max(e,r)))]},le.rgb.cmyk=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-e-(n=Math.min(1-e,1-r,1-i)))/(1-n)||0),100*((1-r-n)/(1-n)||0),100*((1-i-n)/(1-n)||0),100*n]},le.rgb.keyword=function(t){var n=ae[t];if(n)return n;var e,r,i,s=1/0;for(var o in oe)if(oe.hasOwnProperty(o)){var a=oe[o],u=(r=t,i=a,Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));u<s&&(s=u,e=o)}return e},le.keyword.rgb=function(t){return oe[t]},le.rgb.xyz=function(t){var n=t[0]/255,e=t[1]/255,r=t[2]/255;return[100*(.4124*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.3576*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*n+.7152*e+.0722*r),100*(.0193*n+.1192*e+.9505*r)]},le.rgb.lab=function(t){var n=le.rgb.xyz(t),e=n[0],r=n[1],i=n[2];return r/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(e-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},le.hsl.rgb=function(t){var n,e,r,i,s,o=t[0]/360,a=t[1]/100,u=t[2]/100;if(0===a)return[s=255*u,s,s];n=2*u-(e=u<.5?u*(1+a):u+a-u*a),i=[0,0,0];for(var l=0;l<3;l++)(r=o+1/3*-(l-1))<0&&r++,r>1&&r--,s=6*r<1?n+6*(e-n)*r:2*r<1?e:3*r<2?n+(e-n)*(2/3-r)*6:n,i[l]=255*s;return i},le.hsl.hsv=function(t){var n=t[0],e=t[1]/100,r=t[2]/100,i=e,s=Math.max(r,.01);return e*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[n,100*(0===r?2*i/(s+i):2*e/(r+e)),100*((r+e)/2)]},le.hsv.rgb=function(t){var n=t[0]/60,e=t[1]/100,r=t[2]/100,i=Math.floor(n)%6,s=n-Math.floor(n),o=255*r*(1-e),a=255*r*(1-e*s),u=255*r*(1-e*(1-s));switch(r*=255,i){case 0:return[r,u,o];case 1:return[a,r,o];case 2:return[o,r,u];case 3:return[o,a,r];case 4:return[u,o,r];case 5:return[r,o,a]}},le.hsv.hsl=function(t){var n,e,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,e=s*a,[i,100*(e=(e/=(n=(2-s)*a)<=1?n:2-n)||0),100*(r/=2)]},le.hwb.rgb=function(t){var n,e,r,i,s,o,a,u=t[0]/360,l=t[1]/100,h=t[2]/100,c=l+h;switch(c>1&&(l/=c,h/=c),r=6*u-(n=Math.floor(6*u)),1&n&&(r=1-r),i=l+r*((e=1-h)-l),n){default:case 6:case 0:s=e,o=i,a=l;break;case 1:s=i,o=e,a=l;break;case 2:s=l,o=e,a=i;break;case 3:s=l,o=i,a=e;break;case 4:s=i,o=l,a=e;break;case 5:s=e,o=l,a=i}return[255*s,255*o,255*a]},le.cmyk.rgb=function(t){var n=t[0]/100,e=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},le.xyz.rgb=function(t){var n,e,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return e=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,n=(n=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(n=Math.min(Math.max(0,n),1)),255*(e=Math.min(Math.max(0,e),1)),255*(r=Math.min(Math.max(0,r),1))]},le.xyz.lab=function(t){var n=t[0],e=t[1],r=t[2];return e/=100,r/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(e=e>.008856?Math.pow(e,1/3):7.787*e+16/116)-16,500*(n-e),200*(e-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},le.lab.xyz=function(t){var n,e,r,i=t[0];n=t[1]/500+(e=(i+16)/116),r=e-t[2]/200;var s=Math.pow(e,3),o=Math.pow(n,3),a=Math.pow(r,3);return e=s>.008856?s:(e-16/116)/7.787,n=o>.008856?o:(n-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[n*=95.047,e*=100,r*=108.883]},le.lab.lch=function(t){var n,e=t[0],r=t[1],i=t[2];return(n=360*Math.atan2(i,r)/2/Math.PI)<0&&(n+=360),[e,Math.sqrt(r*r+i*i),n]},le.lch.lab=function(t){var n,e=t[0],r=t[1];return n=t[2]/360*2*Math.PI,[e,r*Math.cos(n),r*Math.sin(n)]},le.rgb.ansi16=function(t){var n=t[0],e=t[1],r=t[2],i=1 in arguments?arguments[1]:le.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(e/255)<<1|Math.round(n/255));return 2===i&&(s+=60),s},le.hsv.ansi16=function(t){return le.rgb.ansi16(le.hsv.rgb(t),t[2])},le.rgb.ansi256=function(t){var n=t[0],e=t[1],r=t[2];return n===e&&e===r?n<8?16:n>248?231:Math.round((n-8)/247*24)+232:16+36*Math.round(n/255*5)+6*Math.round(e/255*5)+Math.round(r/255*5)},le.ansi16.rgb=function(t){var n=t%10;if(0===n||7===n)return t>50&&(n+=3.5),[n=n/10.5*255,n,n];var e=.5*(1+~~(t>50));return[(1&n)*e*255,(n>>1&1)*e*255,(n>>2&1)*e*255]},le.ansi256.rgb=function(t){if(t>=232){var n=10*(t-232)+8;return[n,n,n]}var e;return t-=16,[Math.floor(t/36)/5*255,Math.floor((e=t%36)/6)/5*255,e%6/5*255]},le.rgb.hex=function(t){var n=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(n.length)+n},le.hex.rgb=function(t){var n=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!n)return[0,0,0];var e=n[0];3===n[0].length&&(e=e.split("").map((function(t){return t+t})).join(""));var r=parseInt(e,16);return[r>>16&255,r>>8&255,255&r]},le.rgb.hcg=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(e,r),i),o=Math.min(Math.min(e,r),i),a=s-o;return n=a<=0?0:s===e?(r-i)/a%6:s===r?2+(i-e)/a:4+(e-r)/a+4,n/=6,[360*(n%=1),100*a,100*(a<1?o/(1-a):0)]},le.hsl.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=1,i=0;return(r=e<.5?2*n*e:2*n*(1-e))<1&&(i=(e-.5*r)/(1-r)),[t[0],100*r,100*i]},le.hsv.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=n*e,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},le.hcg.rgb=function(t){var n=t[0]/360,e=t[1]/100,r=t[2]/100;if(0===e)return[255*r,255*r,255*r];var i,s=[0,0,0],o=n%1*6,a=o%1,u=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=u,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=u,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=u}return i=(1-e)*r,[255*(e*s[0]+i),255*(e*s[1]+i),255*(e*s[2]+i)]},le.hcg.hsv=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n),r=0;return e>0&&(r=n/e),[t[0],100*r,100*e]},le.hcg.hsl=function(t){var n=t[1]/100,e=t[2]/100*(1-n)+.5*n,r=0;return e>0&&e<.5?r=n/(2*e):e>=.5&&e<1&&(r=n/(2*(1-e))),[t[0],100*r,100*e]},le.hcg.hwb=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n);return[t[0],100*(e-n),100*(1-e)]},le.hwb.hcg=function(t){var n=t[1]/100,e=1-t[2]/100,r=e-n,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},le.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},le.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},le.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},le.gray.hsl=le.gray.hsv=function(t){return[0,0,t[0]]},le.gray.hwb=function(t){return[0,100,t[0]]},le.gray.cmyk=function(t){return[0,0,0,t[0]]},le.gray.lab=function(t){return[t[0],0,0]},le.gray.hex=function(t){var n=255&Math.round(t[0]/100*255),e=((n<<16)+(n<<8)+n).toString(16).toUpperCase();return"000000".substring(e.length)+e},le.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var de=se.exports,pe=de;function ye(t){var n=function(){for(var t={},n=Object.keys(pe),e=n.length,r=0;r<e;r++)t[n[r]]={distance:-1,parent:null};return t}(),e=[t];for(n[t].distance=0;e.length;)for(var r=e.pop(),i=Object.keys(pe[r]),s=i.length,o=0;o<s;o++){var a=i[o],u=n[a];-1===u.distance&&(u.distance=n[r].distance+1,u.parent=r,e.unshift(a))}return n}function me(t,n){return function(e){return n(t(e))}}function ge(t,n){for(var e=[n[t].parent,t],r=pe[n[t].parent][t],i=n[t].parent;n[i].parent;)e.unshift(n[i].parent),r=me(pe[n[i].parent][i],r),i=n[i].parent;return r.conversion=e,r}var ve=de,be=function(t){for(var n=ye(t),e={},r=Object.keys(n),i=r.length,s=0;s<i;s++){var o=r[s];null!==n[o].parent&&(e[o]=ge(o,n))}return e},we={};Object.keys(ve).forEach((function(t){we[t]={},Object.defineProperty(we[t],"channels",{value:ve[t].channels}),Object.defineProperty(we[t],"labels",{value:ve[t].labels});var n=be(t);Object.keys(n).forEach((function(e){var r=n[e];we[t][e]=function(t){var n=function(n){if(null==n)return n;arguments.length>1&&(n=Array.prototype.slice.call(arguments));var e=t(n);if("object"==typeof e)for(var r=e.length,i=0;i<r;i++)e[i]=Math.round(e[i]);return e};return"conversion"in t&&(n.conversion=t.conversion),n}(r),we[t][e].raw=function(t){var n=function(n){return null==n?n:(arguments.length>1&&(n=Array.prototype.slice.call(arguments)),t(n))};return"conversion"in t&&(n.conversion=t.conversion),n}(r)}))}));var Me=ie,xe=we,Fe=[].slice,ke=["keyword","gray","hex"],Ae={};Object.keys(xe).forEach((function(t){Ae[Fe.call(xe[t].labels).sort().join("")]=t}));var Pe={};function Se(t,n){if(!(this instanceof Se))return new Se(t,n);if(n&&n in ke&&(n=null),n&&!(n in xe))throw new Error("Unknown model: "+n);var e,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof Se)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=Me.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=xe[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=n||"rgb",r=xe[this.model].channels;var s=Fe.call(t,0,r);this.color=Ce(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in Ae))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=Ae[a];var u=xe[this.model].labels,l=[];for(e=0;e<u.length;e++)l.push(t[u[e]]);this.color=Ce(l)}if(Pe[this.model])for(r=xe[this.model].channels,e=0;e<r;e++){var h=Pe[this.model][e];h&&(this.color[e]=h(this.color[e]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function _e(t,n,e){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(Pe[t]||(Pe[t]=[]))[n]=e})),t=t[0],function(r){var i;return arguments.length?(e&&(r=e(r)),(i=this[t]()).color[n]=r,i):(i=this[t]().color[n],e&&(i=e(i)),i)}}function Oe(t){return function(n){return Math.max(0,Math.min(t,n))}}function Ce(t,n){for(var e=0;e<n;e++)"number"!=typeof t[e]&&(t[e]=0);return t}Se.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var n=this.model in Me.to?this:this.rgb(),e=1===(n=n.round("number"==typeof t?t:1)).valpha?n.color:n.color.concat(this.valpha);return Me.to[n.model](e)},percentString:function(t){var n=this.rgb().round("number"==typeof t?t:1),e=1===n.valpha?n.color:n.color.concat(this.valpha);return Me.to.rgb.percent(e)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},n=xe[this.model].channels,e=xe[this.model].labels,r=0;r<n;r++)t[e[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new Se(this.color.map(function(t){return function(n){return function(t,n){return Number(t.toFixed(n))}(n,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new Se(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:_e("rgb",0,Oe(255)),green:_e("rgb",1,Oe(255)),blue:_e("rgb",2,Oe(255)),hue:_e(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:_e("hsl",1,Oe(100)),lightness:_e("hsl",2,Oe(100)),saturationv:_e("hsv",1,Oe(100)),value:_e("hsv",2,Oe(100)),chroma:_e("hcg",1,Oe(100)),gray:_e("hcg",2,Oe(100)),white:_e("hwb",1,Oe(100)),wblack:_e("hwb",2,Oe(100)),cyan:_e("cmyk",0,Oe(100)),magenta:_e("cmyk",1,Oe(100)),yellow:_e("cmyk",2,Oe(100)),black:_e("cmyk",3,Oe(100)),x:_e("xyz",0,Oe(100)),y:_e("xyz",1,Oe(100)),z:_e("xyz",2,Oe(100)),l:_e("lab",0,Oe(100)),a:_e("lab",1),b:_e("lab",2),keyword:function(t){return arguments.length?new Se(t):xe[this.model].keyword(this.color)},hex:function(t){return arguments.length?new Se(t):Me.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,n=[],e=0;e<t.length;e++){var r=t[e]/255;n[e]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*n[0]+.7152*n[1]+.0722*n[2]},contrast:function(t){var n=this.luminosity(),e=t.luminosity();return n>e?(n+.05)/(e+.05):(e+.05)/(n+.05)},level:function(t){var n=this.contrast(t);return n>=7.1?"AAA":n>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),n=0;n<3;n++)t.color[n]=255-t.color[n];return t},lighten:function(t){var n=this.hsl();return n.color[2]+=n.color[2]*t,n},darken:function(t){var n=this.hsl();return n.color[2]-=n.color[2]*t,n},saturate:function(t){var n=this.hsl();return n.color[1]+=n.color[1]*t,n},desaturate:function(t){var n=this.hsl();return n.color[1]-=n.color[1]*t,n},whiten:function(t){var n=this.hwb();return n.color[1]+=n.color[1]*t,n},blacken:function(t){var n=this.hwb();return n.color[2]+=n.color[2]*t,n},grayscale:function(){var t=this.rgb().color,n=.3*t[0]+.59*t[1]+.11*t[2];return Se.rgb(n,n,n)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var n=this.hsl(),e=n.color[0];return e=(e=(e+t)%360)<0?360+e:e,n.color[0]=e,n},mix:function(t,n){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var e=t.rgb(),r=this.rgb(),i=void 0===n?.5:n,s=2*i-1,o=e.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,u=1-a;return Se.rgb(a*e.red()+u*r.red(),a*e.green()+u*r.green(),a*e.blue()+u*r.blue(),e.alpha()*i+r.alpha()*(1-i))}},Object.keys(xe).forEach((function(t){if(-1===ke.indexOf(t)){var n=xe[t].channels;Se.prototype[t]=function(){if(this.model===t)return new Se(this);if(arguments.length)return new Se(arguments,t);var e,r="number"==typeof arguments[n]?n:this.valpha;return new Se((e=xe[this.model][t].raw(this.color),Array.isArray(e)?e:[e]).concat(r),t)},Se[t]=function(e){return"number"==typeof e&&(e=Ce(Fe.call(arguments),n)),new Se(e,t)}}}));var Ee=Et(Se);function $e(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];for(const n in e)t[n]=e[n]}return t}function Ie(t){return null==t}function ze(t){return"number"==typeof t&&!isNaN(t)}function De(t){return"object"==typeof t&&!!t}function Te(t){return!Ie(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}const Ue=Object.prototype.hasOwnProperty;function je(t,n){return Ue.call(t,n)}function Ne(t){return t&&g(t)&&t.property}const Le={};function He(t,n){if(!Array.isArray(n)){if(n&&void 0!==n.r&&void 0!==n.g&&void 0!==n.b)return t[0]=255*n.r,t[1]=255*n.g,t[2]=255*n.b,void 0!==n.a?t[3]=255*n.a:t[3]=255,t;const e=n;n=Le[e]=Le[e]||Ee(n).unitArray()}for(let e=0;e<n.length;e++)t[e]=255*n[e];return 3===n.length&&(t[3]=255),t}const Re={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1},Ve={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};class qe{constructor(t,n,e,r){this.feature=t,this.symbol=n,this.fnTypes=e,this.options=r}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:n}=this.fnTypes,e=n;return this.H(t,e)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:n}=this.fnTypes,e=n;return this.H(t,e)}H(t,n){if(n){const e=this.feature.properties;t=n(this.options.zoom,e)}return t}}\n/*!\n        Feature Filter by\n\n        (c) mapbox 2016 and maptalks 2018\n        www.mapbox.com | www.maptalks.org\n        License: MIT, header required.\n    */\nconst Ge=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Je(t){return new Function("f",\`var p = (f && f.properties || {}); return ${bk}Be(t)}\`)}function We(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"==typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const n of t.slice(1))if(!We(n)&&"boolean"!=typeof n)return!1;return!0;case"contains":return!0;default:return!1}}function Be(t){if(!t)return"true";const n=t[0];if(t.length<=1)return"any"===n?"false":"true";return\`(${bk}"=="===n?Ye(t[1],t[2],"===",!1):"!="===n?Ye(t[1],t[2],"!==",!1):"<"===n||">"===n||"<="===n||">="===n?Ye(t[1],t[2],n,!0):"any"===n?Ze(t.slice(1),"||"):"all"===n?Ze(t.slice(1),"&&"):"none"===n?nr(Ze(t.slice(1),"||")):"in"===n?Qe(t[1],t.slice(2)):"!in"===n?nr(Qe(t[1],t.slice(2))):"has"===n?tr(t[1]):"!has"===n?nr(tr(t[1])):"contains"===n?function(t,n,e){const r=Xe(t);return void 0!==e?\`(${bk}r} + '').indexOf("${bk}n}") === ${bk}e}\`:\`(${bk}r} + '').indexOf("${bk}n}") >= 0\`}(t[1],t[2],t[3]):"true"})\`}function Xe(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function Ye(t,n,e,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,n,e,r){const i=t.property,s=t.op;let o=Xe(i);return"length"!==s?(console.error(\`not support ${bk}s} op\`),"false"):(o=\`((${bk}o}+='').length)\`,Ke(o,i,n,e,r))}(t,n,e,r);var i;return Ke(Xe(t),t,n,e,r)}function Ke(t,n,e,r,i){const s="$type"===n?Ge.indexOf(e):JSON.stringify(e);return(i?\`typeof ${bk}t}=== typeof ${bk}s}&&\`:"")+t+r+s}function Ze(t,n){return t.map(Be).join(n)}function Qe(t,n){"$type"===t&&(n=n.map((t=>Ge.indexOf(t))));const e=JSON.stringify(n.sort(er)),r=Xe(t);return n.length<=200?\`${bk}e}.indexOf(${bk}r}) !== -1\`:\`function(v, a, i, j) {\\n        while (i <= j) { var m = (i + j) >> 1;\\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\\n        }\\n    return false; }(${bk}r}, ${bk}e},0,${bk}n.length-1})\`}function tr(t){return"$id"===t?'"id" in f':\`${bk}JSON.stringify(t)} in p\`}function nr(t){return\`!(${bk}t})\`}function er(t,n){return t<n?-1:t>n?1:0}\n/*!\n     * a compact version of mapbox-gl-style-spec\n     * based on mapbox-gl-style-spec@13.28.0\n     * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec\n     * LICENSE : ISC\n     */var rr="undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self?self:{},ir={exports:{}};function sr(t,...n){for(const e of n)for(const n in e)t[n]=e[n];return t}\n/*! https://mths.be/punycode v1.3.2 by @mathias */\n!function(t,n){!function(e){var r=n&&!n.nodeType&&n,i=t&&!t.nodeType&&t,s="object"==typeof rr&&rr;s.global!==s&&s.window!==s&&s.self!==s||(e=s);var o,a,u=2147483647,l=36,h=1,c=26,f=38,d=700,p=72,y=128,m="-",g=/^xn--/,v=/[^\\x20-\\x7E]/,b=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,w={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},M=l-h,x=Math.floor,F=String.fromCharCode;function k(t){throw RangeError(w[t])}function A(t,n){for(var e=t.length,r=[];e--;)r[e]=n(t[e]);return r}function P(t,n){var e=t.split("@"),r="";return e.length>1&&(r=e[0]+"@",t=e[1]),r+A((t=t.replace(b,".")).split("."),n).join(".")}function S(t){for(var n,e,r=[],i=0,s=t.length;i<s;)(n=t.charCodeAt(i++))>=55296&&n<=56319&&i<s?56320==(64512&(e=t.charCodeAt(i++)))?r.push(((1023&n)<<10)+(1023&e)+65536):(r.push(n),i--):r.push(n);return r}function _(t){return A(t,(function(t){var n="";return t>65535&&(n+=F((t-=65536)>>>10&1023|55296),t=56320|1023&t),n+=F(t)})).join("")}function O(t,n){return t+22+75*(t<26)-((0!=n)<<5)}function C(t,n,e){var r=0;for(t=e?x(t/d):t>>1,t+=x(t/n);t>M*c>>1;r+=l)t=x(t/M);return x(r+(M+1)*t/(t+f))}function E(t){var n,e,r,i,s,o,a,f,d,g,v,b=[],w=t.length,M=0,F=y,A=p;for((e=t.lastIndexOf(m))<0&&(e=0),r=0;r<e;++r)t.charCodeAt(r)>=128&&k("not-basic"),b.push(t.charCodeAt(r));for(i=e>0?e+1:0;i<w;){for(s=M,o=1,a=l;i>=w&&k("invalid-input"),((f=(v=t.charCodeAt(i++))-48<10?v-22:v-65<26?v-65:v-97<26?v-97:l)>=l||f>x((u-M)/o))&&k("overflow"),M+=f*o,!(f<(d=a<=A?h:a>=A+c?c:a-A));a+=l)o>x(u/(g=l-d))&&k("overflow"),o*=g;A=C(M-s,n=b.length+1,0==s),x(M/n)>u-F&&k("overflow"),F+=x(M/n),M%=n,b.splice(M++,0,F)}return _(b)}function $(t){var n,e,r,i,s,o,a,f,d,g,v,b,w,M,A,P=[];for(b=(t=S(t)).length,n=y,e=0,s=p,o=0;o<b;++o)(v=t[o])<128&&P.push(F(v));for(r=i=P.length,i&&P.push(m);r<b;){for(a=u,o=0;o<b;++o)(v=t[o])>=n&&v<a&&(a=v);for(a-n>x((u-e)/(w=r+1))&&k("overflow"),e+=(a-n)*w,n=a,o=0;o<b;++o)if((v=t[o])<n&&++e>u&&k("overflow"),v==n){for(f=e,d=l;!(f<(g=d<=s?h:d>=s+c?c:d-s));d+=l)A=f-g,M=l-g,P.push(F(O(g+A%M,0))),f=x(A/M);P.push(F(O(f,0))),s=C(e,w,r==i),e=0,++r}++e,++n}return P.join("")}if(o={version:"1.3.2",ucs2:{decode:S,encode:_},decode:E,encode:$,toASCII:function(t){return P(t,(function(t){return v.test(t)?"xn--"+$(t):t}))},toUnicode:function(t){return P(t,(function(t){return g.test(t)?E(t.slice(4).toLowerCase()):t}))}},r&&i)if(t.exports==r)i.exports=o;else for(a in o)o.hasOwnProperty(a)&&(r[a]=o[a]);else e.punycode=o}(rr)}(ir,ir.exports);class or extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}var ar=or;class ur{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[t,e]of n)this.bindings[t]=e}concat(t){return new ur(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(\`${bk}t} not found in scope.\`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var lr=ur;const hr={kind:"null"},cr={kind:"number"},fr={kind:"string"},dr={kind:"boolean"},pr={kind:"color"},yr={kind:"object"},mr={kind:"value"},gr={kind:"collator"},vr={kind:"formatted"},br={kind:"resolvedImage"};function wr(t,n){return{kind:"array",itemType:t,N:n}}function Mr(t){if("array"===t.kind){const n=Mr(t.itemType);return"number"==typeof t.N?\`array<${bk}n}, ${bk}t.N}>\`:"value"===t.itemType.kind?"array":\`array<${bk}n}>\`}return t.kind}const xr=[hr,cr,fr,dr,pr,vr,yr,wr(mr),br];function Fr(t,n){if("error"===n.kind)return null;if("array"===t.kind){if("array"===n.kind&&(0===n.N&&"value"===n.itemType.kind||!Fr(t.itemType,n.itemType))&&("number"!=typeof t.N||t.N===n.N))return null}else{if(t.kind===n.kind)return null;if("value"===t.kind)for(const t of xr)if(!Fr(t,n))return null}return\`Expected ${bk}Mr(t)} but found ${bk}Mr(n)} instead.\`}function kr(t,n){return n.some((n=>n.kind===t.kind))}function Ar(t,n){return n.some((n=>"null"===n?null===t:"array"===n?Array.isArray(t):"object"===n?t&&!Array.isArray(t)&&"object"==typeof t:n===typeof t))}var Pr,Sr={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function _r(t){return(t=Math.round(t))<0?0:t>255?255:t}function Or(t){return t<0?0:t>1?1:t}function Cr(t){return"%"===t[t.length-1]?_r(parseFloat(t)/100*255):_r(parseInt(t))}function Er(t){return"%"===t[t.length-1]?Or(parseFloat(t)/100):Or(parseFloat(t))}function $r(t,n,e){return e<0?e+=1:e>1&&(e-=1),6*e<1?t+(n-t)*e*6:2*e<1?n:3*e<2?t+(n-t)*(2/3-e)*6:t}try{Pr={}.parseCSSColor=function(t){var n,e=t.replace(/ /g,"").toLowerCase();if(e in Sr)return Sr[e].slice();if("#"===e[0])return 4===e.length?(n=parseInt(e.substr(1),16))>=0&&n<=4095?[(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1]:null:7===e.length&&(n=parseInt(e.substr(1),16))>=0&&n<=16777215?[(16711680&n)>>16,(65280&n)>>8,255&n,1]:null;var r=e.indexOf("("),i=e.indexOf(")");if(-1!==r&&i+1===e.length){var s=e.substr(0,r),o=e.substr(r+1,i-(r+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=Er(o.pop());case"rgb":return 3!==o.length?null:[Cr(o[0]),Cr(o[1]),Cr(o[2]),a];case"hsla":if(4!==o.length)return null;a=Er(o.pop());case"hsl":if(3!==o.length)return null;var u=(parseFloat(o[0])%360+360)%360/360,l=Er(o[1]),h=Er(o[2]),c=h<=.5?h*(l+1):h+l-h*l,f=2*h-c;return[_r(255*$r(f,c,u+1/3)),_r(255*$r(f,c,u)),_r(255*$r(f,c,u-1/3)),a];default:return null}}return null}}catch(t){}class Ir{constructor(t,n,e,r=1){this.r=t,this.g=n,this.b=e,this.a=r}static parse(t){if(!t)return;if(t instanceof Ir)return t;if("string"!=typeof t)return;const n=Pr(t);return n?new Ir(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,n,e,r]=this.toArray();return\`rgba(${bk}Math.round(t)},${bk}Math.round(n)},${bk}Math.round(e)},${bk}r})\`}toArray(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[255*t/r,255*n/r,255*e/r,r]}toArray01(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[t/r,n/r,e/r,r]}toArray01PremultipliedAlpha(){const{r:t,g:n,b:e,a:r}=this;return[t,n,e,r]}}Ir.black=new Ir(0,0,0,1),Ir.white=new Ir(1,1,1,1),Ir.transparent=new Ir(0,0,0,0),Ir.red=new Ir(1,0,0,1),Ir.blue=new Ir(0,0,1,1);var zr=Ir;class Dr{constructor(t,n,e){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=e,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Tr{constructor(t,n,e,r,i){this.text=t.normalize?t.normalize():t,this.image=n,this.scale=e,this.fontStack=r,this.textColor=i}}class Ur{constructor(t){this.sections=t}static fromString(t){return new Ur([new Tr(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((t=>0!==t.text.length||t.image&&0!==t.image.name.length))}static factory(t){return t instanceof Ur?t:Ur.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map((t=>t.text)).join("")}serialize(){const t=["format"];for(const n of this.sections){if(n.image){t.push(["image",n.image.name]);continue}t.push(n.text);const e={};n.fontStack&&(e["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(e["font-scale"]=n.scale),n.textColor&&(e["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(e)}return t}}class jr{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new jr({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Nr(t,n,e,r){if(!("number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255&&"number"==typeof e&&e>=0&&e<=255)){return\`Invalid rgba value [${bk}("number"==typeof r?[t,n,e,r]:[t,n,e]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.\`}return void 0===r||"number"==typeof r&&r>=0&&r<=1?null:\`Invalid rgba value [${bk}[t,n,e,r].join(", ")}]: 'a' must be between 0 and 1.\`}function Lr(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof zr)return!0;if(t instanceof Dr)return!0;if(t instanceof Ur)return!0;if(t instanceof jr)return!0;if(Array.isArray(t)){for(const n of t)if(!Lr(n))return!1;return!0}if("object"==typeof t){for(const n in t)if(!Lr(t[n]))return!1;return!0}return!1}function Hr(t){if(null===t)return hr;if("string"==typeof t)return fr;if("boolean"==typeof t)return dr;if("number"==typeof t)return cr;if(t instanceof zr)return pr;if(t instanceof Dr)return gr;if(t instanceof Ur)return vr;if(t instanceof jr)return br;if(Array.isArray(t)){const n=t.length;let e;for(const n of t){const t=Hr(n);if(e){if(e===t)continue;e=mr;break}e=t}return wr(e||mr,n)}return yr}function Rr(t){const n=typeof t;return null===t?"":"string"===n||"number"===n||"boolean"===n?String(t):t instanceof zr||t instanceof Ur||t instanceof jr?t.toString():JSON.stringify(t)}class Vr{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(2!==t.length)return n.error(\`'literal' expression requires exactly one argument, but found ${bk}t.length-1} instead.\`);if(!Lr(t[1]))return n.error("invalid value");const e=t[1];let r=Hr(e);const i=n.expectedType;return"array"!==r.kind||0!==r.N||!i||"array"!==i.kind||"number"==typeof i.N&&0!==i.N||(r=i),new Vr(r,e)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof zr?["rgba"].concat(this.value.toArray()):this.value instanceof Ur?this.value.serialize():this.value}}var qr=Vr;var Gr=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const Jr={string:fr,number:cr,boolean:dr,object:yr};class Wr{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let e,r=1;const i=t[0];if("array"===i){let i,s;if(t.length>2){const e=t[1];if("string"!=typeof e||!(e in Jr)||"object"===e)return n.error('The item type argument of "array" must be one of string, number, boolean',1);i=Jr[e],r++}else i=mr;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return n.error('The length argument to "array" must be a positive integer literal',2);s=t[2],r++}e=wr(i,s)}else e=Jr[i];const s=[];for(;r<t.length;r++){const e=n.parse(t[r],r,mr);if(!e)return null;s.push(e)}return new Wr(e,s)}evaluate(t){for(let n=0;n<this.args.length;n++){const e=this.args[n].evaluate(t);if(!Fr(this.type,Hr(e)))return e;if(n===this.args.length-1)throw new Gr(\`Expected value to be of type ${bk}Mr(this.type)}, but found ${bk}Mr(Hr(e))} instead.\`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=this.type,n=[t.kind];if("array"===t.kind){const e=t.itemType;if("string"===e.kind||"number"===e.kind||"boolean"===e.kind){n.push(e.kind);const r=t.N;("number"==typeof r||this.args.length>1)&&n.push(r)}}return n.concat(this.args.map((t=>t.serialize())))}}var Br=Wr;class Xr{constructor(t){this.type=vr,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[1];if(!Array.isArray(e)&&"object"==typeof e)return n.error("First argument must be an image or text section.");const r=[];let i=!1;for(let e=1;e<=t.length-1;++e){const s=t[e];if(i&&"object"==typeof s&&!Array.isArray(s)){i=!1;let t=null;if(s["font-scale"]&&(t=n.parse(s["font-scale"],1,cr),!t))return null;let e=null;if(s["text-font"]&&(e=n.parse(s["text-font"],1,wr(fr)),!e))return null;let o=null;if(s["text-color"]&&(o=n.parse(s["text-color"],1,pr),!o))return null;const a=r[r.length-1];a.scale=t,a.font=e,a.textColor=o}else{const s=n.parse(t[e],1,mr);if(!s)return null;const o=s.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");i=!0,r.push({content:s,scale:null,font:null,textColor:null})}}return new Xr(r)}evaluate(t){return new Ur(this.sections.map((n=>{const e=n.content.evaluate(t);return Hr(e)===br?new Tr("",e,null,null,null):new Tr(Rr(e),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null)})))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const n of this.sections){t.push(n.content.serialize());const e={};n.scale&&(e["font-scale"]=n.scale.serialize()),n.font&&(e["text-font"]=n.font.serialize()),n.textColor&&(e["text-color"]=n.textColor.serialize()),t.push(e)}return t}}class Yr{constructor(t){this.type=br,this.input=t}static parse(t,n){if(2!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,fr);return e?new Yr(e):n.error("No image name provided.")}evaluate(t){const n=this.input.evaluate(t),e=jr.fromString(n);return e&&t.availableImages&&(e.available=t.availableImages.indexOf(n)>-1),e}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Kr={"to-boolean":dr,"to-color":pr,"to-number":cr,"to-string":fr};class Zr{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[0];if(("to-boolean"===e||"to-string"===e)&&2!==t.length)return n.error("Expected one argument.");const r=Kr[e],i=[];for(let e=1;e<t.length;e++){const r=n.parse(t[e],e,mr);if(!r)return null;i.push(r)}return new Zr(r,i)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let n,e;for(const r of this.args){if(n=r.evaluate(t),e=null,n instanceof zr)return n;if("string"==typeof n){const e=t.parseColor(n);if(e)return e}else if(Array.isArray(n)&&(e=n.length<3||n.length>4?\`Invalid rbga value ${bk}JSON.stringify(n)}: expected an array containing either three or four numeric values.\`:Nr(n[0],n[1],n[2],n[3]),!e))return new zr(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Gr(e||\`Could not parse color from value '${bk}"string"==typeof n?n:String(JSON.stringify(n))}'\`)}if("number"===this.type.kind){let n=null;for(const e of this.args){if(n=e.evaluate(t),null===n)return 0;const r=Number(n);if(!isNaN(r))return r}throw new Gr(\`Could not convert ${bk}JSON.stringify(n)} to number.\`)}return"formatted"===this.type.kind?Ur.fromString(Rr(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?jr.fromString(Rr(this.args[0].evaluate(t))):Rr(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Xr([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Yr(this.args[0]).serialize();const t=[\`to-${bk}this.type.kind}\`];return this.eachChild((n=>{t.push(n.serialize())})),t}}var Qr=Zr;const ti=["Unknown","Point","LineString","Polygon"];var ni=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this.R={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?ti[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:e,y:r}=this.featureTileCoord,i=e*n-t[0],s=r*n-t[1];return this.featureDistanceData.bearing[0]*i+this.featureDistanceData.bearing[1]*s}return 0}parseColor(t){let n=this.R[t];return n||(n=this.R[t]=zr.parse(t)),n}};class ei{constructor(t,n,e,r){this.name=t,this.type=n,this.V=e,this.args=r}evaluate(t){return this.V(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((t=>t.serialize())))}static parse(t,n){const e=t[0],r=ei.definitions[e];if(!r)return n.error(\`Unknown expression "${bk}e}". If you wanted a literal array, use ["literal", [...]].\`,0);const i=Array.isArray(r)?r[0]:r.type,s=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,o=s.filter((([n])=>!Array.isArray(n)||n.length===t.length-1));let a=null;for(const[r,s]of o){a=new Ci(n.registry,n.path,null,n.scope);const o=[];let u=!1;for(let n=1;n<t.length;n++){const e=t[n],i=Array.isArray(r)?r[n-1]:r.type,s=a.parse(e,1+o.length,i);if(!s){u=!0;break}o.push(s)}if(!u)if(Array.isArray(r)&&r.length!==o.length)a.error(\`Expected ${bk}r.length} arguments, but found ${bk}o.length} instead.\`);else{for(let t=0;t<o.length;t++){const n=Array.isArray(r)?r[t]:r.type,e=o[t];a.concat(t+1).checkSubtype(n,e.type)}if(0===a.errors.length)return new ei(e,i,s,o)}}if(1===o.length)n.errors.push(...a.errors);else{const e=(o.length?o:s).map((([t])=>{return n=t,Array.isArray(n)?\`(${bk}n.map(Mr).join(", ")})\`:\`(${bk}Mr(n.type)}...)\`;var n})).join(" | "),r=[];for(let e=1;e<t.length;e++){const i=n.parse(t[e],1+r.length);if(!i)return null;r.push(Mr(i.type))}n.error(\`Expected arguments of type ${bk}e}, but found (${bk}r.join(", ")}) instead.\`)}return null}static register(t,n){ei.definitions=n;for(const e in n)t[e]=ei}}var ri=ei;class ii{constructor(t,n,e){this.type=gr,this.locale=e,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(2!==t.length)return n.error("Expected one argument.");const e=t[1];if("object"!=typeof e||Array.isArray(e))return n.error("Collator options argument must be an object.");const r=n.parse(void 0!==e["case-sensitive"]&&e["case-sensitive"],1,dr);if(!r)return null;const i=n.parse(void 0!==e["diacritic-sensitive"]&&e["diacritic-sensitive"],1,dr);if(!i)return null;let s=null;return e.locale&&(s=n.parse(e.locale,1,fr),!s)?null:new ii(r,i,s)}evaluate(t){return new Dr(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const si=8192;function oi(t,n){t[0]=Math.min(t[0],n[0]),t[1]=Math.min(t[1],n[1]),t[2]=Math.max(t[2],n[0]),t[3]=Math.max(t[3],n[1])}function ai(t,n){return!(t[0]<=n[0])&&(!(t[2]>=n[2])&&(!(t[1]<=n[1])&&!(t[3]>=n[3])))}function ui(t,n){const e=(180+t[0])/360;const r=(i=t[1],(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360);var i;const s=Math.pow(2,n.z);return[Math.round(e*s*si),Math.round(r*s*si)]}function li(t,n,e){const r=t[0]-n[0],i=t[1]-n[1],s=t[0]-e[0],o=t[1]-e[1];return r*o-s*i==0&&r*s<=0&&i*o<=0}function hi(t,n){let e=!1;for(let o=0,a=n.length;o<a;o++){const a=n[o];for(let n=0,o=a.length;n<o-1;n++){if(li(t,a[n],a[n+1]))return!1;r=t,i=a[n],s=a[n+1],i[1]>r[1]!=s[1]>r[1]&&r[0]<(s[0]-i[0])*(r[1]-i[1])/(s[1]-i[1])+i[0]&&(e=!e)}}var r,i,s;return e}function ci(t,n){for(let e=0;e<n.length;e++)if(hi(t,n[e]))return!0;return!1}function fi(t,n,e,r){const i=t[0]-e[0],s=t[1]-e[1],o=n[0]-e[0],a=n[1]-e[1],u=r[0]-e[0],l=r[1]-e[1],h=i*l-u*s,c=o*l-u*a;return h>0&&c<0||h<0&&c>0}function di(t,n,e,r){const i=[n[0]-t[0],n[1]-t[1]],s=[r[0]-e[0],r[1]-e[1]];return 0!=(o=s)[0]*(a=i)[1]-o[1]*a[0]&&!(!fi(t,n,e,r)||!fi(e,r,t,n));var o,a}function pi(t,n,e){for(const r of e)for(let e=0;e<r.length-1;++e)if(di(t,n,r[e],r[e+1]))return!0;return!1}function yi(t,n){for(let e=0;e<t.length;++e)if(!hi(t[e],n))return!1;for(let e=0;e<t.length-1;++e)if(pi(t[e],t[e+1],n))return!1;return!0}function mi(t,n){for(let e=0;e<n.length;e++)if(yi(t,n[e]))return!0;return!1}function gi(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=[];for(let r=0;r<t[i].length;r++){const o=ui(t[i][r],e);oi(n,o),s.push(o)}r.push(s)}return r}function vi(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=gi(t[i],n,e);r.push(s)}return r}function bi(t,n,e,r){if(t[0]<e[0]||t[0]>e[2]){const n=.5*r;let i=t[0]-e[0]>n?-r:e[0]-t[0]>n?r:0;0===i&&(i=t[0]-e[2]>n?-r:e[2]-t[0]>n?r:0),t[0]+=i}oi(n,t)}function wi(t,n,e,r){const i=Math.pow(2,r.z)*si,s=[r.x*si,r.y*si],o=[];if(!t)return o;for(const r of t)for(const t of r){const r=[t.x+s[0],t.y+s[1]];bi(r,n,e,i),o.push(r)}return o}function Mi(t,n,e,r){const i=Math.pow(2,r.z)*si,s=[r.x*si,r.y*si],o=[];if(!t)return o;for(const e of t){const t=[];for(const r of e){const e=[r.x+s[0],r.y+s[1]];oi(n,e),t.push(e)}o.push(t)}if(n[2]-n[0]<=i/2){!function(t){t[0]=t[1]=1/0,t[2]=t[3]=-1/0}(n);for(const t of o)for(const r of t)bi(r,n,e,i)}return o}class xi{constructor(t,n){this.type=dr,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(\`'within' expression requires exactly one argument, but found ${bk}t.length-1} instead.\`);if(Lr(t[1])){const n=t[1];if("FeatureCollection"===n.type)for(let t=0;t<n.features.length;++t){const e=n.features[t].geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new xi(n,n.features[t].geometry)}else if("Feature"===n.type){const t=n.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new xi(n,n.geometry)}else if("Polygon"===n.type||"MultiPolygon"===n.type)return new xi(n,n)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=gi(n.coordinates,r,i),o=wi(t.geometry(),e,r,i);if(!ai(e,r))return!1;for(const t of o)if(!hi(t,s))return!1}if("MultiPolygon"===n.type){const s=vi(n.coordinates,r,i),o=wi(t.geometry(),e,r,i);if(!ai(e,r))return!1;for(const t of o)if(!ci(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=gi(n.coordinates,r,i),o=Mi(t.geometry(),e,r,i);if(!ai(e,r))return!1;for(const t of o)if(!yi(t,s))return!1}if("MultiPolygon"===n.type){const s=vi(n.coordinates,r,i),o=Mi(t.geometry(),e,r,i);if(!ai(e,r))return!1;for(const t of o)if(!mi(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Fi=xi;function ki(t){if(t instanceof ri){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof Fi)return!1;let n=!0;return t.eachChild((t=>{n&&!ki(t)&&(n=!1)})),n}function Ai(t){if(t instanceof ri&&"feature-state"===t.name)return!1;let n=!0;return t.eachChild((t=>{n&&!Ai(t)&&(n=!1)})),n}function Pi(t,n){if(t instanceof ri&&n.indexOf(t.name)>=0)return!1;let e=!0;return t.eachChild((t=>{e&&!Pi(t,n)&&(e=!1)})),e}class Si{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(2!==t.length||"string"!=typeof t[1])return n.error("'var' expression requires exactly one string literal argument.");const e=t[1];return n.scope.has(e)?new Si(e,n.scope.get(e)):n.error(\`Unknown variable "${bk}e}". Make sure "${bk}e}" has been bound in an enclosing "let" expression before using it.\`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var _i=Si;class Oi{constructor(t,n=[],e,r=new lr,i=[]){this.registry=t,this.path=n,this.key=n.map((t=>\`[${bk}t}]\`)).join(""),this.scope=r,this.errors=i,this.expectedType=e}parse(t,n,e,r,i={}){return n?this.concat(n,e,r).q(t,i):this.q(t,i)}q(t,n){function e(t,n,e){return"assert"===e?new Br(n,[t]):"coerce"===e?new Qr(n,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const r=t[0];if("string"!=typeof r)return this.error(\`Expression name must be a string, but found ${bk}typeof r} instead. If you wanted a literal array, use ["literal", [...]].\`,0),null;const i=this.registry[r];if(i){let r=i.parse(t,this);if(!r)return null;if(this.expectedType){const t=this.expectedType,i=r.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==i.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==i.kind&&"string"!==i.kind){if(this.checkSubtype(t,i))return null}else r=e(r,t,n.typeAnnotation||"coerce");else r=e(r,t,n.typeAnnotation||"assert")}if(!(r instanceof qr)&&"resolvedImage"!==r.type.kind&&Ei(r)){const t=new ni;try{r=new qr(r.type,r.evaluate(t))}catch(t){return this.error(t.message),null}}return r}return this.error(\`Unknown expression "${bk}r}". If you wanted a literal array, use ["literal", [...]].\`,0)}return void 0===t?this.error("'undefined' value invalid. Use null instead."):"object"==typeof t?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(\`Expected an array, but found ${bk}typeof t} instead.\`)}concat(t,n,e){const r="number"==typeof t?this.path.concat(t):this.path,i=e?this.scope.concat(e):this.scope;return new Oi(this.registry,r,n||null,i,this.errors)}error(t,...n){const e=\`${bk}this.key}${bk}n.map((t=>\`[${bk}t}]\`)).join("")}\`;this.errors.push(new ar(e,t))}checkSubtype(t,n){const e=Fr(t,n);return e&&this.error(e),e}}var Ci=Oi;function Ei(t){if(t instanceof _i)return Ei(t.boundExpression);if(t instanceof ri&&"error"===t.name)return!1;if(t instanceof ii)return!1;if(t instanceof Fi)return!1;const n=t instanceof Qr||t instanceof Br;let e=!0;return t.eachChild((t=>{e=n?e&&Ei(t):e&&t instanceof qr})),!!e&&(ki(t)&&Pi(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"]))}function $i(t,n){const e=t.length-1;let r,i,s=0,o=e,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),r=t[a],i=t[a+1],r<=n){if(a===e||n<i)return a;s=a+1}else{if(!(r>n))throw new Gr("Input is not a number.");o=a-1}return 0}class Ii{constructor(t,n,e){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[t,n]of e)this.labels.push(t),this.outputs.push(n)}static parse(t,n){if(t.length-1<4)return n.error(\`Expected at least 4 arguments, but found only ${bk}t.length-1}.\`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const e=n.parse(t[1],1,cr);if(!e)return null;const r=[];let i=null;n.expectedType&&"value"!==n.expectedType.kind&&(i=n.expectedType);for(let e=1;e<t.length;e+=2){const s=1===e?-1/0:t[e],o=t[e+1],a=e,u=e+1;if("number"!=typeof s)return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(r.length&&r[r.length-1][0]>=s)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const l=n.parse(o,u,i);if(!l)return null;i=i||l.type,r.push([s,l])}return new Ii(i,e,r)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;if(r>=n[i-1])return e[i-1].evaluate(t);return e[$i(n,r)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){const t=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&t.push(this.labels[n]),t.push(this.outputs[n].serialize());return t}}var zi=Ii,Di=Ti;function Ti(t,n,e,r){this.cx=3*t,this.bx=3*(e-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(r-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=e,this.p2y=r}function Ui(t,n,e){return t*(1-e)+n*e}Ti.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,n){if(void 0===n&&(n=1e-6),t<0)return 0;if(t>1)return 1;for(var e=t,r=0;r<8;r++){var i=this.sampleCurveX(e)-t;if(Math.abs(i)<n)return e;var s=this.sampleCurveDerivativeX(e);if(Math.abs(s)<1e-6)break;e-=i/s}var o=0,a=1;for(e=t,r=0;r<20&&(i=this.sampleCurveX(e),!(Math.abs(i-t)<n));r++)t>i?o=e:a=e,e=.5*(a-o)+o;return e},solve:function(t,n){return this.sampleCurveY(this.solveCurveX(t,n))}};var ji=Object.freeze({__proto__:null,number:Ui,color:function(t,n,e){return new zr(Ui(t.r,n.r,e),Ui(t.g,n.g,e),Ui(t.b,n.b,e),Ui(t.a,n.a,e))},array:function(t,n,e){return t.map(((t,r)=>Ui(t,n[r],e)))}});const Ni=.95047,Li=1,Hi=1.08883,Ri=4/29,Vi=6/29,qi=3*Vi*Vi,Gi=Vi*Vi*Vi,Ji=Math.PI/180,Wi=180/Math.PI;function Bi(t){return t>Gi?Math.pow(t,1/3):t/qi+Ri}function Xi(t){return t>Vi?t*t*t:qi*(t-Ri)}function Yi(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Ki(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Zi(t){const n=Ki(t.r),e=Ki(t.g),r=Ki(t.b),i=Bi((.4124564*n+.3575761*e+.1804375*r)/Ni),s=Bi((.2126729*n+.7151522*e+.072175*r)/Li);return{l:116*s-16,a:500*(i-s),b:200*(s-Bi((.0193339*n+.119192*e+.9503041*r)/Hi)),alpha:t.a}}function Qi(t){let n=(t.l+16)/116,e=isNaN(t.a)?n:n+t.a/500,r=isNaN(t.b)?n:n-t.b/200;return n=Li*Xi(n),e=Ni*Xi(e),r=Hi*Xi(r),new zr(Yi(3.2404542*e-1.5371385*n-.4985314*r),Yi(-.969266*e+1.8760108*n+.041556*r),Yi(.0556434*e-.2040259*n+1.0572252*r),t.alpha)}function ts(t,n,e){const r=n-t;return t+e*(r>180||r<-180?r-360*Math.round(r/360):r)}const ns={forward:Zi,reverse:Qi,interpolate:function(t,n,e){return{l:Ui(t.l,n.l,e),a:Ui(t.a,n.a,e),b:Ui(t.b,n.b,e),alpha:Ui(t.alpha,n.alpha,e)}}},es={forward:function(t){const{l:n,a:e,b:r}=Zi(t),i=Math.atan2(r,e)*Wi;return{h:i<0?i+360:i,c:Math.sqrt(e*e+r*r),l:n,alpha:t.a}},reverse:function(t){const n=t.h*Ji,e=t.c;return Qi({l:t.l,a:Math.cos(n)*e,b:Math.sin(n)*e,alpha:t.alpha})},interpolate:function(t,n,e){return{h:ts(t.h,n.h,e),c:Ui(t.c,n.c,e),l:Ui(t.l,n.l,e),alpha:Ui(t.alpha,n.alpha,e)}}};var rs=Object.freeze({__proto__:null,lab:ns,hcl:es});class is{constructor(t,n,e,r,i){this.type=t,this.operator=n,this.interpolation=e,this.input=r,this.labels=[],this.outputs=[];for(const[t,n]of i)this.labels.push(t),this.outputs.push(n)}static interpolationFactor(t,n,e,r){let i=0;if("exponential"===t.name)i=ss(n,t.base,e,r);else if("linear"===t.name)i=ss(n,1,e,r);else if("cubic-bezier"===t.name){const s=t.controlPoints;i=new Di(s[0],s[1],s[2],s[3]).solve(ss(n,1,e,r))}return i}static parse(t,n){let[e,r,i,...s]=t;if(!Array.isArray(r)||0===r.length)return n.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){const t=r[1];if("number"!=typeof t)return n.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:t}}else{if("cubic-bezier"!==r[0])return n.error(\`Unknown interpolation type ${bk}String(r[0])}\`,1,0);{const t=r.slice(1);if(4!==t.length||t.some((t=>"number"!=typeof t||t<0||t>1)))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return n.error(\`Expected at least 4 arguments, but found only ${bk}t.length-1}.\`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(i=n.parse(i,2,cr),!i)return null;const o=[];let a=null;"interpolate-hcl"===e||"interpolate-lab"===e?a=pr:n.expectedType&&"value"!==n.expectedType.kind&&(a=n.expectedType);for(let t=0;t<s.length;t+=2){const e=s[t],r=s[t+1],i=t+3,u=t+4;if("number"!=typeof e)return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',i);if(o.length&&o[o.length-1][0]>=e)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',i);const l=n.parse(r,u,a);if(!l)return null;a=a||l.type,o.push([e,l])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new is(a,e,r,i,o):n.error(\`Type ${bk}Mr(a)} is not interpolatable.\`)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;if(r>=n[i-1])return e[i-1].evaluate(t);const s=$i(n,r),o=n[s],a=n[s+1],u=is.interpolationFactor(this.interpolation,r,o,a),l=e[s].evaluate(t),h=e[s+1].evaluate(t);return"interpolate"===this.operator?ji[this.type.kind.toLowerCase()](l,h,u):"interpolate-hcl"===this.operator?es.reverse(es.interpolate(es.forward(l),es.forward(h),u)):ns.reverse(ns.interpolate(ns.forward(l),ns.forward(h),u))}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)n.push(this.labels[t],this.outputs[t].serialize());return n}}function ss(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}var os=is;class as{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expectected at least one argument.");let e=null;const r=n.expectedType;r&&"value"!==r.kind&&(e=r);const i=[];for(const r of t.slice(1)){const t=n.parse(r,1+i.length,e,void 0,{typeAnnotation:"omit"});if(!t)return null;e=e||t.type,i.push(t)}const s=r&&i.some((t=>Fr(r,t.type)));return new as(s?mr:e,i)}evaluate(t){let n,e=null,r=0;for(const i of this.args){if(r++,e=i.evaluate(t),e&&e instanceof jr&&!e.available&&(n||(n=e),e=null,r===this.args.length))return n;if(null!==e)break}return e}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=["coalesce"];return this.eachChild((n=>{t.push(n.serialize())})),t}}var us=as;class ls{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(\`Expected at least 3 arguments, but found ${bk}t.length-1} instead.\`);const e=[];for(let r=1;r<t.length-1;r+=2){const i=t[r];if("string"!=typeof i)return n.error(\`Expected string, but found ${bk}typeof i} instead.\`,r);if(/[^a-zA-Z0-9_]/.test(i))return n.error("Variable names must contain only alphanumeric characters or '_'.",r);const s=n.parse(t[r+1],r+1);if(!s)return null;e.push([i,s])}const r=n.parse(t[t.length-1],t.length-1,n.expectedType,e);return r?new ls(e,r):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[n,e]of this.bindings)t.push(n,e.serialize());return t.push(this.result.serialize()),t}}var hs=ls;class cs{constructor(t,n,e){this.type=t,this.index=n,this.input=e}static parse(t,n){if(3!==t.length)return n.error(\`Expected 2 arguments, but found ${bk}t.length-1} instead.\`);const e=n.parse(t[1],1,cr),r=n.parse(t[2],2,wr(n.expectedType||mr));if(!e||!r)return null;const i=r.type;return new cs(i.itemType,e,r)}evaluate(t){const n=this.index.evaluate(t),e=this.input.evaluate(t);if(n<0)throw new Gr(\`Array index out of bounds: ${bk}n} < 0.\`);if(n>=e.length)throw new Gr(\`Array index out of bounds: ${bk}n} > ${bk}e.length-1}.\`);if(n!==Math.floor(n))throw new Gr(\`Array index must be an integer, but found ${bk}n} instead.\`);return e[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var fs=cs;class ds{constructor(t,n){this.type=dr,this.needle=t,this.haystack=n}static parse(t,n){if(3!==t.length)return n.error(\`Expected 2 arguments, but found ${bk}t.length-1} instead.\`);const e=n.parse(t[1],1,mr),r=n.parse(t[2],2,mr);return e&&r?kr(e.type,[dr,fr,cr,hr,mr])?new ds(e,r):n.error(\`Expected first argument to be of type boolean, string, number or null, but found ${bk}Mr(e.type)} instead\`):null}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(null==e)return!1;if(!Ar(n,["boolean","string","number","null"]))throw new Gr(\`Expected first argument to be of type boolean, string, number or null, but found ${bk}Mr(Hr(n))} instead.\`);if(!Ar(e,["string","array"]))throw new Gr(\`Expected second argument to be of type array or string, but found ${bk}Mr(Hr(e))} instead.\`);return e.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var ps=ds;class ys{constructor(t,n,e){this.type=cr,this.needle=t,this.haystack=n,this.fromIndex=e}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(\`Expected 3 or 4 arguments, but found ${bk}t.length-1} instead.\`);const e=n.parse(t[1],1,mr),r=n.parse(t[2],2,mr);if(!e||!r)return null;if(!kr(e.type,[dr,fr,cr,hr,mr]))return n.error(\`Expected first argument to be of type boolean, string, number or null, but found ${bk}Mr(e.type)} instead\`);if(4===t.length){const i=n.parse(t[3],3,cr);return i?new ys(e,r,i):null}return new ys(e,r)}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(!Ar(n,["boolean","string","number","null"]))throw new Gr(\`Expected first argument to be of type boolean, string, number or null, but found ${bk}Mr(Hr(n))} instead.\`);if(!Ar(e,["string","array"]))throw new Gr(\`Expected second argument to be of type array or string, but found ${bk}Mr(Hr(e))} instead.\`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return e.indexOf(n,r)}return e.indexOf(n)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var ms=ys;class gs{constructor(t,n,e,r,i,s){this.inputType=t,this.type=n,this.input=e,this.cases=r,this.outputs=i,this.otherwise=s}static parse(t,n){if(t.length<5)return n.error(\`Expected at least 4 arguments, but found only ${bk}t.length-1}.\`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let e,r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const i={},s=[];for(let o=2;o<t.length-1;o+=2){let a=t[o];const u=t[o+1];Array.isArray(a)||(a=[a]);const l=n.concat(o);if(0===a.length)return l.error("Expected at least one branch label.");for(const t of a){if("number"!=typeof t&&"string"!=typeof t)return l.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return l.error(\`Branch labels must be integers no larger than ${bk}Number.MAX_SAFE_INTEGER}.\`);if("number"==typeof t&&Math.floor(t)!==t)return l.error("Numeric branch labels must be integer values.");if(e){if(l.checkSubtype(e,Hr(t)))return null}else e=Hr(t);if(void 0!==i[String(t)])return l.error("Branch labels must be unique.");i[String(t)]=s.length}const h=n.parse(u,o,r);if(!h)return null;r=r||h.type,s.push(h)}const o=n.parse(t[1],1,mr);if(!o)return null;const a=n.parse(t[t.length-1],t.length-1,r);return a?"value"!==o.type.kind&&n.concat(1).checkSubtype(e,o.type)?null:new gs(e,r,o,i,s,a):null}evaluate(t){const n=this.input.evaluate(t);return(Hr(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),e=[],r={};for(const t of n){const n=r[this.cases[t]];void 0===n?(r[this.cases[t]]=e.length,e.push([this.cases[t],[t]])):e[n][1].push(t)}const i=t=>"number"===this.inputType.kind?Number(t):t;for(const[n,r]of e)1===r.length?t.push(i(r[0])):t.push(r.map(i)),t.push(this.outputs[n].serialize());return t.push(this.otherwise.serialize()),t}}var vs=gs;class bs{constructor(t,n,e){this.type=t,this.branches=n,this.otherwise=e}static parse(t,n){if(t.length<4)return n.error(\`Expected at least 3 arguments, but found only ${bk}t.length-1}.\`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let e;n.expectedType&&"value"!==n.expectedType.kind&&(e=n.expectedType);const r=[];for(let i=1;i<t.length-1;i+=2){const s=n.parse(t[i],i,dr);if(!s)return null;const o=n.parse(t[i+1],i+1,e);if(!o)return null;r.push([s,o]),e=e||o.type}const i=n.parse(t[t.length-1],t.length-1,e);return i?new bs(e,r,i):null}evaluate(t){for(const[n,e]of this.branches)if(n.evaluate(t))return e.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,e]of this.branches)t(n),t(e);t(this.otherwise)}outputDefined(){return this.branches.every((([t,n])=>n.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild((n=>{t.push(n.serialize())})),t}}var ws=bs;class Ms{constructor(t,n,e,r){this.type=t,this.input=n,this.beginIndex=e,this.endIndex=r}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(\`Expected 3 or 4 arguments, but found ${bk}t.length-1} instead.\`);const e=n.parse(t[1],1,mr),r=n.parse(t[2],2,cr);if(!e||!r)return null;if(!kr(e.type,[wr(mr),fr,mr]))return n.error(\`Expected first argument to be of type array or string, but found ${bk}Mr(e.type)} instead\`);if(4===t.length){const i=n.parse(t[3],3,cr);return i?new Ms(e.type,e,r,i):null}return new Ms(e.type,e,r)}evaluate(t){const n=this.input.evaluate(t),e=this.beginIndex.evaluate(t);if(!Ar(n,["string","array"]))throw new Gr(\`Expected first argument to be of type array or string, but found ${bk}Mr(Hr(n))} instead.\`);if(this.endIndex){const r=this.endIndex.evaluate(t);return n.slice(e,r)}return n.slice(e)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var xs=Ms;function Fs(t,n){return"=="===t||"!="===t?"boolean"===n.kind||"string"===n.kind||"number"===n.kind||"null"===n.kind||"value"===n.kind:"string"===n.kind||"number"===n.kind||"value"===n.kind}function ks(t,n,e,r){return 0===r.compare(n,e)}function As(t,n,e){const r="=="!==t&&"!="!==t;return class i{constructor(t,n,e){this.type=dr,this.lhs=t,this.rhs=n,this.collator=e,this.hasUntypedArgument="value"===t.type.kind||"value"===n.type.kind}static parse(t,n){if(3!==t.length&&4!==t.length)return n.error("Expected two or three arguments.");const e=t[0];let s=n.parse(t[1],1,mr);if(!s)return null;if(!Fs(e,s.type))return n.concat(1).error(\`"${bk}e}" comparisons are not supported for type '${bk}Mr(s.type)}'.\`);let o=n.parse(t[2],2,mr);if(!o)return null;if(!Fs(e,o.type))return n.concat(2).error(\`"${bk}e}" comparisons are not supported for type '${bk}Mr(o.type)}'.\`);if(s.type.kind!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error(\`Cannot compare types '${bk}Mr(s.type)}' and '${bk}Mr(o.type)}'.\`);r&&("value"===s.type.kind&&"value"!==o.type.kind?s=new Br(o.type,[s]):"value"!==s.type.kind&&"value"===o.type.kind&&(o=new Br(s.type,[o])));let a=null;if(4===t.length){if("string"!==s.type.kind&&"string"!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error("Cannot use collator to compare non-string types.");if(a=n.parse(t[3],3,gr),!a)return null}return new i(s,o,a)}evaluate(i){const s=this.lhs.evaluate(i),o=this.rhs.evaluate(i);if(r&&this.hasUntypedArgument){const n=Hr(s),e=Hr(o);if(n.kind!==e.kind||"string"!==n.kind&&"number"!==n.kind)throw new Gr(\`Expected arguments for "${bk}t}" to be (string, string) or (number, number), but found (${bk}n.kind}, ${bk}e.kind}) instead.\`)}if(this.collator&&!r&&this.hasUntypedArgument){const t=Hr(s),e=Hr(o);if("string"!==t.kind||"string"!==e.kind)return n(i,s,o)}return this.collator?e(i,s,o,this.collator.evaluate(i)):n(i,s,o)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const n=[t];return this.eachChild((t=>{n.push(t.serialize())})),n}}}const Ps=As("==",(function(t,n,e){return n===e}),ks),Ss=As("!=",(function(t,n,e){return n!==e}),(function(t,n,e,r){return!ks(0,n,e,r)})),_s=As("<",(function(t,n,e){return n<e}),(function(t,n,e,r){return r.compare(n,e)<0})),Os=As(">",(function(t,n,e){return n>e}),(function(t,n,e,r){return r.compare(n,e)>0})),Cs=As("<=",(function(t,n,e){return n<=e}),(function(t,n,e,r){return r.compare(n,e)<=0})),Es=As(">=",(function(t,n,e){return n>=e}),(function(t,n,e,r){return r.compare(n,e)>=0}));class $s{constructor(t,n,e,r,i,s){this.type=fr,this.number=t,this.locale=n,this.currency=e,this.unit=r,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(t,n){if(3!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,cr);if(!e)return null;const r=t[2];if("object"!=typeof r||Array.isArray(r))return n.error("NumberFormat options argument must be an object.");let i=null;if(r.locale&&(i=n.parse(r.locale,1,fr),!i))return null;let s=null;if(r.currency&&(s=n.parse(r.currency,1,fr),!s))return null;let o=null;if(r.unit&&(o=n.parse(r.unit,1,fr),!o))return null;let a=null;if(r["min-fraction-digits"]&&(a=n.parse(r["min-fraction-digits"],1,cr),!a))return null;let u=null;return r["max-fraction-digits"]&&(u=n.parse(r["max-fraction-digits"],1,cr),!u)?null:new $s(e,i,s,o,a,u)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class Is{constructor(t){this.type=cr,this.input=t}static parse(t,n){if(2!==t.length)return n.error(\`Expected 1 argument, but found ${bk}t.length-1} instead.\`);const e=n.parse(t[1],1);return e?"array"!==e.type.kind&&"string"!==e.type.kind&&"value"!==e.type.kind?n.error(\`Expected argument of type string or array, but found ${bk}Mr(e.type)} instead.\`):new Is(e):null}evaluate(t){const n=this.input.evaluate(t);if("string"==typeof n)return n.length;if(Array.isArray(n))return n.length;throw new Gr(\`Expected value to be of type string or array, but found ${bk}Mr(Hr(n))} instead.\`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild((n=>{t.push(n.serialize())})),t}}const zs={"==":Ps,"!=":Ss,">":Os,"<":_s,">=":Es,"<=":Cs,array:Br,at:fs,boolean:Br,case:ws,coalesce:us,collator:ii,format:Xr,image:Yr,in:ps,"index-of":ms,interpolate:os,"interpolate-hcl":os,"interpolate-lab":os,length:Is,let:hs,literal:qr,match:vs,number:Br,"number-format":$s,object:Br,slice:xs,step:zi,string:Br,"to-boolean":Qr,"to-color":Qr,"to-number":Qr,"to-string":Qr,var:_i,within:Fi};function Ds(t,[n,e,r,i]){n=n.evaluate(t),e=e.evaluate(t),r=r.evaluate(t);const s=i?i.evaluate(t):1,o=Nr(n,e,r,s);if(o)throw new Gr(o);return new zr(n/255*s,e/255*s,r/255*s,s)}function Ts(t,n){return t in n}function Us(t,n){const e=n[t];return void 0===e?null:e}function js(t){return{type:t}}ri.register(zs,{error:[{kind:"error"},[fr],(t,[n])=>{throw new Gr(n.evaluate(t))}],typeof:[fr,[mr],(t,[n])=>Mr(Hr(n.evaluate(t)))],"to-rgba":[wr(cr,4),[pr],(t,[n])=>n.evaluate(t).toArray()],rgb:[pr,[cr,cr,cr],Ds],rgba:[pr,[cr,cr,cr,cr],Ds],has:{type:dr,overloads:[[[fr],(t,[n])=>Ts(n.evaluate(t),t.properties())],[[fr,yr],(t,[n,e])=>Ts(n.evaluate(t),e.evaluate(t))]]},get:{type:mr,overloads:[[[fr],(t,[n])=>Us(n.evaluate(t),t.properties())],[[fr,yr],(t,[n,e])=>Us(n.evaluate(t),e.evaluate(t))]]},"feature-state":[mr,[fr],(t,[n])=>Us(n.evaluate(t),t.featureState||{})],properties:[yr,[],t=>t.properties()],"geometry-type":[fr,[],t=>t.geometryType()],id:[mr,[],t=>t.id()],zoom:[cr,[],t=>t.globals.zoom],pitch:[cr,[],t=>t.globals.pitch||0],"distance-from-center":[cr,[],t=>t.distanceFromCenter()],"heatmap-density":[cr,[],t=>t.globals.heatmapDensity||0],"line-progress":[cr,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[cr,[],t=>t.globals.skyRadialProgress||0],accumulated:[mr,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[cr,js(cr),(t,n)=>{let e=0;for(const r of n)e+=r.evaluate(t);return e}],"*":[cr,js(cr),(t,n)=>{let e=1;for(const r of n)e*=r.evaluate(t);return e}],"-":{type:cr,overloads:[[[cr,cr],(t,[n,e])=>n.evaluate(t)-e.evaluate(t)],[[cr],(t,[n])=>-n.evaluate(t)]]},"/":[cr,[cr,cr],(t,[n,e])=>n.evaluate(t)/e.evaluate(t)],"%":[cr,[cr,cr],(t,[n,e])=>n.evaluate(t)%e.evaluate(t)],ln2:[cr,[],()=>Math.LN2],pi:[cr,[],()=>Math.PI],e:[cr,[],()=>Math.E],"^":[cr,[cr,cr],(t,[n,e])=>Math.pow(n.evaluate(t),e.evaluate(t))],sqrt:[cr,[cr],(t,[n])=>Math.sqrt(n.evaluate(t))],log10:[cr,[cr],(t,[n])=>Math.log(n.evaluate(t))/Math.LN10],ln:[cr,[cr],(t,[n])=>Math.log(n.evaluate(t))],log2:[cr,[cr],(t,[n])=>Math.log(n.evaluate(t))/Math.LN2],sin:[cr,[cr],(t,[n])=>Math.sin(n.evaluate(t))],cos:[cr,[cr],(t,[n])=>Math.cos(n.evaluate(t))],tan:[cr,[cr],(t,[n])=>Math.tan(n.evaluate(t))],asin:[cr,[cr],(t,[n])=>Math.asin(n.evaluate(t))],acos:[cr,[cr],(t,[n])=>Math.acos(n.evaluate(t))],atan:[cr,[cr],(t,[n])=>Math.atan(n.evaluate(t))],min:[cr,js(cr),(t,n)=>Math.min(...n.map((n=>n.evaluate(t))))],max:[cr,js(cr),(t,n)=>Math.max(...n.map((n=>n.evaluate(t))))],abs:[cr,[cr],(t,[n])=>Math.abs(n.evaluate(t))],round:[cr,[cr],(t,[n])=>{const e=n.evaluate(t);return e<0?-Math.round(-e):Math.round(e)}],floor:[cr,[cr],(t,[n])=>Math.floor(n.evaluate(t))],ceil:[cr,[cr],(t,[n])=>Math.ceil(n.evaluate(t))],"filter-==":[dr,[fr,mr],(t,[n,e])=>t.properties()[n.value]===e.value],"filter-id-==":[dr,[mr],(t,[n])=>t.id()===n.value],"filter-type-==":[dr,[fr],(t,[n])=>t.geometryType()===n.value],"filter-<":[dr,[fr,mr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<i}],"filter-id-<":[dr,[mr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<r}],"filter->":[dr,[fr,mr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>i}],"filter-id->":[dr,[mr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>r}],"filter-<=":[dr,[fr,mr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[dr,[mr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<=r}],"filter->=":[dr,[fr,mr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[dr,[mr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>=r}],"filter-has":[dr,[mr],(t,[n])=>n.value in t.properties()],"filter-has-id":[dr,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[dr,[wr(fr)],(t,[n])=>n.value.indexOf(t.geometryType())>=0],"filter-id-in":[dr,[wr(mr)],(t,[n])=>n.value.indexOf(t.id())>=0],"filter-in-small":[dr,[fr,wr(mr)],(t,[n,e])=>e.value.indexOf(t.properties()[n.value])>=0],"filter-in-large":[dr,[fr,wr(mr)],(t,[n,e])=>function(t,n,e,r){for(;e<=r;){const i=e+r>>1;if(n[i]===t)return!0;n[i]>t?r=i-1:e=i+1}return!1}(t.properties()[n.value],e.value,0,e.value.length-1)],all:{type:dr,overloads:[[[dr,dr],(t,[n,e])=>n.evaluate(t)&&e.evaluate(t)],[js(dr),(t,n)=>{for(const e of n)if(!e.evaluate(t))return!1;return!0}]]},any:{type:dr,overloads:[[[dr,dr],(t,[n,e])=>n.evaluate(t)||e.evaluate(t)],[js(dr),(t,n)=>{for(const e of n)if(e.evaluate(t))return!0;return!1}]]},"!":[dr,[dr],(t,[n])=>!n.evaluate(t)],"is-supported-script":[dr,[fr],(t,[n])=>{const e=t.globals&&t.globals.isSupportedScript;return!e||e(n.evaluate(t))}],upcase:[fr,[fr],(t,[n])=>n.evaluate(t).toUpperCase()],downcase:[fr,[fr],(t,[n])=>n.evaluate(t).toLowerCase()],concat:[fr,js(mr),(t,n)=>n.map((n=>Rr(n.evaluate(t)))).join("")],"resolved-locale":[fr,[gr],(t,[n])=>n.evaluate(t).resolvedLocale()]});var Ns=zs;function Ls(t){return{result:"success",value:t}}function Hs(t){return{result:"error",value:t}}function Rs(t){return!!t.expression&&t.expression.interpolated}function Vs(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function qs(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function Gs(t){return t}function Js(t,n){const e="color"===n.type,r=t.stops&&"object"==typeof t.stops[0][0],i=r||void 0!==t.property,s=r||!i,o=t.type||(Rs(n)?"exponential":"interval");if(e&&((t=sr({},t)).stops&&(t.stops=t.stops.map((t=>[t[0],zr.parse(t[1])]))),t.default?t.default=zr.parse(t.default):t.default=zr.parse(n.default)),t.colorSpace&&"rgb"!==t.colorSpace&&!rs[t.colorSpace])throw new Error(\`Unknown color space: ${bk}t.colorSpace}\`);let a,u,l;if("exponential"===o)a=Ys;else if("interval"===o)a=Xs;else if("categorical"===o){a=Bs,u=Object.create(null);for(const n of t.stops)u[n[0]]=n[1];l=typeof t.stops[0][0]}else{if("identity"!==o)throw new Error(\`Unknown function type "${bk}o}"\`);a=Ks}if(r){const e={},r=[];for(let n=0;n<t.stops.length;n++){const i=t.stops[n],s=i[0].zoom;void 0===e[s]&&(e[s]={zoom:s,type:t.type,property:t.property,default:t.default,stops:[]},r.push(s)),e[s].stops.push([i[0].value,i[1]])}const i=[];for(const t of r)i.push([e[t].zoom,Js(e[t],n)]);const s={name:"linear"};return{kind:"composite",interpolationType:s,interpolationFactor:os.interpolationFactor.bind(void 0,s),zoomStops:i.map((t=>t[0])),evaluate:({zoom:e},r)=>Ys({stops:i,base:t.base},n,e).evaluate(e,r)}}if(s){const e="exponential"===o?{name:"exponential",base:void 0!==t.base?t.base:1}:null;return{kind:"camera",interpolationType:e,interpolationFactor:os.interpolationFactor.bind(void 0,e),zoomStops:t.stops.map((t=>t[0])),evaluate:({zoom:e})=>a(t,n,e,u,l)}}return{kind:"source",evaluate(e,r){const i=r&&r.properties?r.properties[t.property]:void 0;return void 0===i?Ws(t.default,n.default):a(t,n,i,u,l)}}}function Ws(t,n,e){return void 0!==t?t:void 0!==n?n:void 0!==e?e:void 0}function Bs(t,n,e,r,i){return Ws(typeof e===i?r[e]:void 0,t.default,n.default)}function Xs(t,n,e){if("number"!==Vs(e))return Ws(t.default,n.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[r-1][0])return t.stops[r-1][1];const i=$i(t.stops.map((t=>t[0])),e);return t.stops[i][1]}function Ys(t,n,e){const r=void 0!==t.base?t.base:1;if("number"!==Vs(e))return Ws(t.default,n.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[i-1][0])return t.stops[i-1][1];const s=$i(t.stops.map((t=>t[0])),e),o=function(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}(e,r,t.stops[s][0],t.stops[s+1][0]),a=t.stops[s][1],u=t.stops[s+1][1];let l=ji[n.type]||Gs;if(t.colorSpace&&"rgb"!==t.colorSpace){const n=rs[t.colorSpace];l=(t,e)=>n.reverse(n.interpolate(n.forward(t),n.forward(e),o))}return"function"==typeof a.evaluate?{evaluate(...t){const n=a.evaluate.apply(void 0,t),e=u.evaluate.apply(void 0,t);if(void 0!==n&&void 0!==e)return l(n,e,o)}}:l(a,u,o)}function Ks(t,n,e){return"color"===n.type?e=zr.parse(e):"formatted"===n.type?e=Ur.fromString(e.toString()):"resolvedImage"===n.type?e=jr.fromString(e.toString()):Vs(e)===n.type||"enum"===n.type&&n.values[e]||(e=void 0),Ws(e,t.default,n.default)}class Zs{constructor(t,n){this.expression=t,this.G={},this.J=new ni,this.W=n?function(t){return"color"===t.type&&(qs(t.default)||Array.isArray(t.default))?new zr(0,0,0,0):"color"===t.type?zr.parse(t.default)||null:void 0===t.default?null:t.default}(n):null,this.B=n&&"enum"===n.type?n.values:null}evaluateWithoutErrorHandling(t,n,e,r,i,s,o,a){return this.J.globals=t,this.J.feature=n,this.J.featureState=e,this.J.canonical=r||null,this.J.availableImages=i||null,this.J.formattedSection=s,this.J.featureTileCoord=o||null,this.J.featureDistanceData=a||null,this.expression.evaluate(this.J)}evaluate(t,n,e,r,i,s,o,a){this.J.globals=t,this.J.feature=n||null,this.J.featureState=e||null,this.J.canonical=r||null,this.J.availableImages=i||null,this.J.formattedSection=s||null,this.J.featureTileCoord=o||null,this.J.featureDistanceData=a||null;try{const t=this.expression.evaluate(this.J);if(null==t||"number"==typeof t&&t!=t)return this.W;if(this.B&&!(t in this.B))throw new Gr(\`Expected value to be one of ${bk}Object.keys(this.B).map((t=>JSON.stringify(t))).join(", ")}, but found ${bk}JSON.stringify(t)} instead.\`);return t}catch(t){return this.G[t.message]||(this.G[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this.W}}}function Qs(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in Ns}function to(t,n){const e=new Ci(Ns,[],n?function(t){const n={color:pr,string:fr,number:cr,enum:fr,boolean:dr,formatted:vr,resolvedImage:br};if("array"===t.type)return wr(n[t.value]||mr,t.length);return n[t.type]}(n):void 0),r=e.parse(t,void 0,void 0,void 0,n&&"string"===n.type?{typeAnnotation:"coerce"}:void 0);return r?Ls(new Zs(r,n)):Hs(e.errors)}class no{constructor(t,n){this.kind=t,this.X=n,this.isStateDependent="constant"!==t&&!Ai(n.expression)}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.X.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.X.evaluate(t,n,e,r,i,s)}}class eo{constructor(t,n,e,r){this.kind=t,this.zoomStops=e,this.X=n,this.isStateDependent="camera"!==t&&!Ai(n.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.X.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.X.evaluate(t,n,e,r,i,s)}interpolationFactor(t,n,e){return this.interpolationType?os.interpolationFactor(this.interpolationType,t,n,e):0}}function ro(t,n){if("error"===(t=to(t,n)).result)return t;const e=t.value.expression,r=ki(e);if(!r&&!function(t){return"data-driven"===t["property-type"]}(n))return Hs([new ar("","data expressions not supported")]);const i=Pi(e,["zoom","pitch","distance-from-center"]);if(!i&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(n))return Hs([new ar("","zoom expressions not supported")]);const s=so(e);if(!s&&!i)return Hs([new ar("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(s instanceof ar)return Hs([s]);if(s instanceof os&&!Rs(n))return Hs([new ar("",'"interpolate" expressions cannot be used with this property')]);if(!s)return Ls(new no(r?"constant":"source",t.value));const o=s instanceof os?s.interpolation:void 0;return Ls(new eo(r?"camera":"composite",t.value,s.labels,o))}class io{constructor(t,n){this.Y=t,this.K=n,sr(this,Js(this.Y,this.K))}static deserialize(t){return new io(t.Y,t.K)}static serialize(t){return{Y:t.Y,K:t.K}}}function so(t){let n=null;if(t instanceof hs)n=so(t.result);else if(t instanceof us){for(const e of t.args)if(n=so(e),n)break}else(t instanceof zi||t instanceof os)&&t.input instanceof ri&&"zoom"===t.input.name&&(n=t);return n instanceof ar||t.eachChild((t=>{const e=so(t);e instanceof ar?n=e:!n&&e?n=new ar("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):n&&e&&n!==e&&(n=new ar("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),n}function oo(t){if(Array.isArray(t))return t.map(oo);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const n={};for(const e in t)n[e]=oo(t[e]);return n}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(t)}function ao(t,n="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const e=t;let r=!0;try{r=function(t){if(!ho(t))return t;let n=oo(t);return lo(n),n=uo(n),n}(e)}catch(t){console.warn(\`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\\nand paste the contents of this message in the report.\\nThank you!\\nFilter Expression:\\n${bk}JSON.stringify(e,null,2)}\\n        \`)}const i=to(r,null);let s=null;if("error"===i.result)throw new Error(i.value.map((t=>\`${bk}t.key}: ${bk}t.message}\`)).join(", "));s=(t,n,e)=>i.value.evaluate(t,n,{},e);let o=null,a=null;if(r!==e){const t=to(e,null);if("error"===t.result)throw new Error(t.value.map((t=>\`${bk}t.key}: ${bk}t.message}\`)).join(", "));o=(n,e,r,i,s)=>t.value.evaluate(n,e,{},r,void 0,void 0,i,s),a=!ki(t.value.expression)}return{filter:s,dynamicFilter:o||void 0,needGeometry:fo(r),needFeature:!!a}}function uo(t){if(!Array.isArray(t))return t;const n=function(t){if(co.has(t[0]))for(let n=1;n<t.length;n++){if(ho(t[n]))return!0}return t}(t);return!0===n?n:n.map((t=>uo(t)))}function lo(t){let n=!1;const e=[];if("case"===t[0]){for(let r=1;r<t.length-1;r+=2)n=n||ho(t[r]),e.push(t[r+1]);e.push(t[t.length-1])}else if("match"===t[0]){n=n||ho(t[1]);for(let n=2;n<t.length-1;n+=2)e.push(t[n+1]);e.push(t[t.length-1])}else if("step"===t[0]){n=n||ho(t[1]);for(let n=1;n<t.length-1;n+=2)e.push(t[n+1])}n&&(t.length=0,t.push("any",...e));for(let n=1;n<t.length;n++)lo(t[n])}function ho(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let n=1;n<t.length;n++){if(ho(t[n]))return!0}return!1}const co=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function fo(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let n=1;n<t.length;n++)if(fo(t[n]))return!0;return!1}const po={StyleExpression:Zs,isExpression:Qs,isExpressionFilter:function t(n){if(!0===n||!1===n)return!0;if(!Array.isArray(n)||0===n.length)return!1;switch(n[0]){case"has":return n.length>=2&&"$id"!==n[1]&&"$type"!==n[1];case"in":return n.length>=3&&("string"!=typeof n[1]||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==n.length||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!t(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}},createExpression:to,createPropertyExpression:ro,normalizePropertyExpression:function(t,n){if(qs(t))return new io(t,n);if(Qs(t)){const e=ro(t,n);if("error"===e.result)throw new Error(e.value.map((t=>\`${bk}t.key}: ${bk}t.message}\`)).join(", "));return e.value}{let e=t;return"string"==typeof t&&"color"===n.type&&(e=zr.parse(t)),{kind:"constant",evaluate:()=>e}}},ZoomConstantExpression:no,ZoomDependentExpression:eo,StylePropertyFunction:io},{isExpression:yo,createExpression:mo}=po;function go(t=[]){return bo(t=t.map((t=>{const n=$e({},t);return n.filter&&n.filter.value&&(n.filter=n.filter.value),n})))}const vo={};function bo(t){if(!Array.isArray(t))return bo([t]);const n=[];for(let e=0;e<t.length;e++){let r;r=!0===t[e].filter?function(){return!0}:wo(t[e].filter),n.push($e({},t[e],{filter:r}))}return n}function wo(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const n=t.condition,e=[];for(let t=0;t<n.length;t++)e.push(wo(n[t]));return(t,n)=>{for(let r=0;r<e.length;r++)if(e[r](t,n))return!0;return!1}}const n=wo(t.condition);if(Ie(t.layer))return n;const e=n=>n.layer===t.layer;return(t,r)=>e(t)&&n(t,r)}if(We(t))return Je(t);{let n=ao(t);n=n&&n.filter;const e=(t,e)=>(vo.zoom=e,n&&n(vo,t));return e}}const Mo={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function xo(t,n){Mo.type=n||"number";const e=mo(t,Mo);if("success"!==e.result)throw new Error(\`Invalid maplibre spec expression: ${bk}JSON.stringify(t)} (${bk}e.value})\`);return e.value}function Fo(t){return yo(t)}const ko={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function Ao(t){return ko[t]}const Po={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},So={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function _o(t){return Po[t]?"string":Ao(t)?"number":So[t]?"array":"color"}const Oo="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Co=function(t){return class extends t{pushIn(...t){const n=t.length;for(let e=0;e<n;e++)this[this.currentIndex++]=t[e]}fill(t,n,e){super.fill(t,n,e),e>this.currentIndex&&(this.currentIndex=e)}set(t,n){t>=this.currentIndex&&(this.currentIndex=t+1),this[t]=n}getLength(){return this.currentIndex}setLength(t){this.currentIndex=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.currentIndex&&this.setLength(t)}reset(){this.currentIndex=0}slice(t,n){const e=super.slice(t,n);return e.currentIndex=n-t,e}}},Eo=Co(Array),$o={get:function(t,n){return"length"===n?t.getLength():t[n]}};class Io extends Array{setLength(t){this.length=t,this.currentIndex=t}trySetLength(t){this.length=t,this.currentIndex=t}getLength(){return this.length}}let zo;class Do{static createTypedArray(t,n){return Hn(t,n)}static getInstance(){return zo}static ensureCapacity(t,n){if(!t.BYTES_PER_ELEMENT)return t;if(t.length>=n)return t;const e=new t.constructor(n+Math.ceil(.5*n)),r=t.getLength();for(let n=0;n<r;n++)e[n]=t[n];return e.currentIndex=t.currentIndex,e}static getArray(t){let n;if(t){const e=Co(t),r=1048576/e.BYTES_PER_ELEMENT;n=new e(r)}else n=new Eo;return n.push=(...t)=>{n.pushIn(...t)},n}static getProxyArray(){const t=new Eo,n=new Proxy(t,$o);return n.push=(...n)=>{t.pushIn(...n)},n.L=t,n}constructor(){this.Z=[],this.tt=0,this.nt=[],this.et=0,this.rt={}}getProxy(){if(!Oo){const t=new Io;return t.currentIndex=0,t}const t=this.nt[this.et]=this.nt[this.et]||Do.getProxyArray();return t.reset(),this.et++,t}get(t){if(!Oo){const t=new Io;return t.currentIndex=0,t}if(t){const n=t.name;let e=this.rt[n];e||(e=this.rt[n]={arrays:[],index:0});const r=e.index,i=e.arrays[r]=e.arrays[r]||Do.getArray(t);return i.reset(),e.index++,i}const n=this.Z[this.tt]=this.Z[this.tt]||Do.getArray();return n.reset(),this.tt++,n}reset(){this.tt=0,this.et=0;for(const t in this.rt)this.rt[t].index=0}}zo=new Do;const To="__fea_idx",Uo=[],jo={},No={},Lo={},Ho=[],Ro=Do.getInstance();let Vo=!1;const qo=Math.pow(2,17);class Go{static isAtlasLoaded(t,n={}){const{iconAtlas:e}=n;return!!(!t||e&&e.positions[t])}static genFnTypes(t){const n={};for(const e in t)if(Fo(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim(),s=_o(e);n[r]=xo(t[e],s),n[i]=(t,e)=>{let i;jo.zoom=t,No.properties=e;try{i=n[r].evaluateWithoutErrorHandling(jo,No,Lo,null,Ho)}catch(t){return null}return i}}else if(Ne(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim();Ao(e)?(n[r]=v(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return Ne(i)?v(i)(t,e):i}):(n[r]=b(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return Ne(i)?b(i)(t,e):i})}return n}constructor(t,n,e){this.options=e;const r=[];this.symbolDef=n,this.symbol=w(n,(()=>(r[0]=e.zoom,r))),this.styledVectors=[],this.properties={},this.it=e.fnTypes||Go.genFnTypes(this.symbolDef),Ne(this.symbolDef.visible)&&(this.st=v(this.symbolDef.visible)),e.atlas&&(this.iconAtlas=e.atlas.iconAtlas,this.glyphAtlas=e.atlas.glyphAtlas),this.features=this.ot(t)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=qo||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(t,n,e,r){if(n<this.ut&&(this.ut=n),n>this.lt&&(this.lt=n),e<this.ht&&(this.ht=e),e>this.ct&&(this.ct=e),this.needAltitudeAttribute()){let i=t.aPosition.currentIndex;t.aPosition[i++]=n,t.aPosition[i++]=e,t.aPosition.currentIndex=i,i=t.aAltitude.currentIndex,t.aAltitude[i++]=r,t.aAltitude.currentIndex=i}else{!function(t,n,e,r){const i=Math.abs(r)>>15,s=i>>1,o=i%2;let a=r%Math.pow(2,15);const u=n+(s<<14)*Math.sign(n),l=e+(o<<14)*Math.sign(e);t[0]=u,t[1]=l,a=Math.round(a),t[2]=0===a?r<0?-1:0:a}(Uo,n,e,r);let i=t.aPosition.currentIndex;t.aPosition[i++]=Uo[0],t.aPosition[i++]=Uo[1],t.aPosition[i++]=Uo[2],t.aPosition.currentIndex=i}}ot(t){if(!t.length)return t;const n=(To+"").trim();let e,r=0,i=t[r];for(;!i.geometry;)r++,i=t[r];if(Array.isArray(i.geometry)&&i.properties){let n=i.geometry[0];for(;Array.isArray(n);)n=n[0];n instanceof ln&&(e=t)}if(!e)if(e=[],Array.isArray(i.geometry))for(let n=0;n<t.length;n++){const r=$e({},t[n]);e.push(Rn(r))}else for(let r=0;r<t.length;r++){const i=t[r],s=cn(i);for(let t=0;t<s.length;t++){const r=s[t];r[n]=i[n],e.push(r)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let n=0,r=!1;const{textPitchAlignmentFn:i}=this.it;!i&&t&&"map"===this.symbolDef.textPitchAlignment&&(r=!0);for(let s=0;s<e.length;s++){const o=Wo(e[s]&&e[s].geometry);if(o>n&&(n=o),t&&!r&&i&&e[s].properties){const t=i(null,e[s].properties);"map"===t&&(r=t)}}this.hasMapPitchAlign=r,this.maxPosZ=n}const s=this.options.order;if(s){const t=[];for(let n=0;n<s.length;n++)s[n]&&t.push(wo(s[n]));e=e.sort(((n,e)=>{const r=t.length;let i=-1,s=-1;for(let o=0;o<r&&(t[o](n)&&(i=o),t[o](e)&&(s=o),!(i>=0&&i<r&&s>=0&&s<r));o++);return i-s}))}return e}load(t=1){const n=(To+"").trim(),e="_debug_info".trim(),r=this.it,i=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const o={},a={},u={zoom:this.options.zoom,isVector3D:!!this.options.center},l=[],h=w(this.symbolDef,(()=>(l[0]=u.zoom,l)));let c=0,f=s.length;const d=this.options.debugIndex;try{for(;c<f;c++){const t=s[c];if(!t||!t.geometry)continue;if(ze(d)&&t[e].index!==d)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const l=this.createStyledVector(t,h,r,u,o,a);l&&l.feature.geometry&&(l.featureIdx=void 0===t[n]?c:t[n],this.count++,i.push(l))}}catch(t){return Promise.reject(t)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(o,a).then((()=>this.pack(t)))}loadAtlas(t,n){return new Promise(((e,r)=>{this.fetchAtlas(t,n,((t,n)=>{if(t)r(t);else{if(n){const{icons:t,glyphs:e}=n;if(t&&Object.keys(t).length){for(const n in t){const e=t[n],{width:r,height:i,data:s}=e.data;e.data=new kn({width:r,height:i},s)}this.iconAtlas=new Dn(t)}if(e&&Object.keys(e).length){for(const t in e){const n=e[t];for(const t in n){const e=n[t],{width:r,height:i,data:s}=e.bitmap;e.bitmap=new Fn({width:r,height:i},s)}}this.glyphAtlas=new Un(e)}}e({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}}))}))}fetchAtlas(t,n,e){Object.keys(t).length>0||Object.keys(n).length>0?this.options.requestor(t,n,e):e()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const n=this.createDataPack(this.styledVectors,t);if(!n)return null;n.properties=this.properties,this.empty&&(n.empty=!0);const e=n.buffers;delete n.buffers;const r={data:n,buffers:e};if(this.iconAtlas){const t=r.data.iconAtlas=Jo(this.iconAtlas);if(t.glyphMap)for(const n in t.glyphMap){const r=t.glyphMap[n];e.push(r.data.data.buffer)}e.push(r.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(r.data.glyphAtlas=Jo(this.glyphAtlas),e.push(r.data.glyphAtlas.image.data.buffer)),r}createStyledVector(t,n,e,r){return new qe(t,n,e,r)}createDataPack(t,n){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this.ut=this.ht=1/0,this.lt=this.ct=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const e=this.data={};this.ft=Ro,Ro.reset();let r=this.elements=Ro.get();const i=this.dt=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let t=0;t<i.length;t++)e[i[t].name]=Ro.get(i[t].type);let o=Ro.get(),a=0;const u=Ro.get();let l=0,h=!1,c=!0;const f=new Set;for(let r=0,i=t.length;r<i;r++){if(!t[r].feature.geometry)continue;const i=Array.isArray(t[r])?t[r][0].feature.id:t[r].feature.id;c&&(void 0!==No.id?f&&(f.has(No.id)?c=!1:f.add(No.id)):c=!1),ze(i)&&(Math.abs(i)>l&&(l=Math.abs(i)),i<0&&(h=!0));const d=this.data.aPosition.getLength();if(Array.isArray(t[r]))for(let e=0;e<t[r].length;e++)this.yt(t[r][e],n);else this.yt(t[r],n);const p=(e.aPosition.getLength()-d)/s;for(let n=0;n<p;n++)o.push(t[r].featureIdx),ze(i)&&u.push(i);a=Math.max(a,t[r].featureIdx)}if(this.countOutOfAngle>0&&!Vo&&(Vo=!0,console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle.")),this.hasElements()&&!r.getLength())return null;const d=!!this.options.center?Float32Array:Ln(a);o=Do.createTypedArray(o,d),this.options.positionType?i[0].type=this.options.positionType:i[0].type=Nn(this.maxPos);const p=this.options.center;if(p&&(p[0]||p[1])){const t=e.aPosition,n=t.getLength();for(let e=0;e<n;e+=s)t[e]-=p[0],t[e+1]-=p[1]}const y=function(t,n){const e={};for(let r=0;r<t.length;r++){const i=t[r],s=i.type,o=i.name;e[o]=s===Array?n[o]:Hn(n[o],s)}return e}(i,e);y.aPickingId=o;const m=[];for(const t in y)m.push(y[t].buffer);const g=jn(this.maxIndex);r=Do.createTypedArray(r,g),m.push(r.buffer);const v={data:y,isIdUnique:c,is2D:0===this.maxPosZ,indices:this.hasElements()?r:null,positionSize:s,positionBounding:[this.ut,this.ht,this.lt,this.ct],buffers:m,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this.gt&&(v.markerPlacement=this.gt),this.vt&&(v.textPlacement=this.vt),u.getLength()){const t=h?Nn(l):Ln(l);v.featureIds=Do.createTypedArray(u,t),m.push(v.featureIds.buffer)}else v.featureIds=[];return v.pickingIdIndiceMap=$n(o,v.indices),v}yt(t,n){const e=t.feature.properties;this.st&&!this.st(this.options.zoom,e)||this.placeVector(t,n,this.formatWidth)}addElements(t,n,e){this.maxIndex=Math.max(this.maxIndex,t,n,e);let r=this.elements.currentIndex;this.elements[r++]=t,this.elements[r++]=n,this.elements[r++]=e,this.elements.currentIndex=r}hasElements(){return!0}getAltitude(t){const{altitudeProperty:n,defaultAltitude:e,altitudeScale:r}=this.options;let i=Sn(t,n,e);return r&&(i*=r),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(i)),i}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let n=0;for(const e in t)if(je(t,e)){const{tl:r,displaySize:i}=t[e],s=Math.max(r[0],r[1],i[0]-1,i[1]-1);s>n&&(n=s)}return n}ensureDataCapacity(t,n){const e=this.dt;for(let r=0;r<e.length;r++){const i=this.data[e[r].name];if(!i)continue;const s=e[r].width*t,o=i.getLength();this.data[e[r].name]=Do.ensureCapacity(i,o+s*n)}}}function Jo(t){let n=t.positions,e=t.image&&t.image.format||"alpha";if(t instanceof Dn){n={};for(const e in t.positions){const r=t.positions[e];n[e]={paddedRect:r.paddedRect,pixelRatio:r.pixelRatio,tl:r.tl,br:r.br,displaySize:r.displaySize}}e="rgba"}const r=t.image;return{image:{width:r.width,height:r.height,data:r.data,format:e},glyphMap:t.glyphMap,positions:n}}function Wo(t){if(!t)return 0;let n=0;if(Array.isArray(t))for(let e=0;e<t.length;e++)if(Array.isArray(t[e])){const r=Wo(t[e]);r>n&&(n=r)}else{const r=Math.abs(t[e].z||0);r>n&&(n=r)}else{const e=Math.abs(t.z||0);e>n&&(n=e)}return n}const Bo="___fn_in_stops";function Xo(t,n,e,r){const i="__fn_textSize".trim();let s=t.textSize;if(Ie(n.textSize))return[16,16];t[i]&&(s=t[i]);const o=[];var a;if(Ie(a=s)||"function"!=typeof a&&(null===a.constructor||a.constructor!==Function)?o[0]=s:o[0]=s(r,e),g(o[0])){const n=o[0].__fn_key=o[0].__fn_key||JSON.stringify(o[0]);t[Bo]||(t[Bo]={}),t[Bo][n]||(t[Bo][n]=v(o[0]));const i=t[Bo][n];o[0]=i(r,e)}return o[1]=o[0],o}function Yo(t){const n=t.stops;let e=-1/0;for(let t=0;t<n.length;t++){let r=n[t][1];De(n[t][1])&&(r=Yo(n[t][1])),r>e&&(e=r)}return e}const Ko=["{","}"],Zo="";const Qo=/\\{[\\w-]+(?:\\|[\\w-]+)*\\}/g;function ta(t,n){if(!Te(t))return t;function e(t){if(!n)return Zo;const e=n[t];return Ie(e)?Zo:Array.isArray(e)?e.join():e}const[r,i]=Ko,s=function(t){t+=Zo;const[n,e]=Ko,r=[];let i=!1,s=Zo;for(let o=0,a=t.length;o<a;o++){const a=t[o];i||a!==n||(i=!0),a===n&&i&&(s=Zo),i&&a!==n&&a!==e&&(s+=a),a===e&&s&&(i=!1,r.push(s),s=Zo)}return r}(t);for(let n=0,o=s.length;n<o;n++){const o=s[n],a=\`${bk}r}${bk}o}${bk}i}\`;if(o.indexOf("|")>0){const n=o.split("|");let r=!1;for(let i=0;i<n.length;i++){const s=e(n[i]);if(s!==Zo){t=ea(t,a,s),r=!0;break}}r||(t=ea(t,a,Zo))}else{t=ea(t,a,e(o))}}return t}function na(t,n){if(2!==n.length||"get"!==n[0])for(let e=0;e<n.length;e++)2===n[e].length&&"get"===n[e][0]?t.push(n[e][1]):Array.isArray(n[e])&&na(t,n[e]);else t.push(n[1])}function ea(t,n,e){if(!t)return t;if(t.replaceAll)return t.replaceAll(n,e);for(;t.indexOf(n)>-1;)t=t.replace(n,e);return t}const ra={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519};function ia(t){return!ra.Arabic(t)&&(!ra["Arabic Supplement"](t)&&(!ra["Arabic Extended-A"](t)&&(!ra["Arabic Presentation Forms-A"](t)&&!ra["Arabic Presentation Forms-B"](t))))}function sa(t){return!(t<11904)&&(!!ra["Bopomofo Extended"](t)||(!!ra.Bopomofo(t)||(!!ra["CJK Compatibility Forms"](t)||(!!ra["CJK Compatibility Ideographs"](t)||(!!ra["CJK Compatibility"](t)||(!!ra["CJK Radicals Supplement"](t)||(!!ra["CJK Strokes"](t)||(!!ra["CJK Symbols and Punctuation"](t)||(!!ra["CJK Unified Ideographs Extension A"](t)||(!!ra["CJK Unified Ideographs"](t)||(!!ra["Enclosed CJK Letters and Months"](t)||(!!ra["Halfwidth and Fullwidth Forms"](t)||(!!ra.Hiragana(t)||(!!ra["Ideographic Description Characters"](t)||(!!ra["Kangxi Radicals"](t)||(!!ra["Katakana Phonetic Extensions"](t)||(!!ra.Katakana(t)||(!!ra["Vertical Forms"](t)||(!!ra["Yi Radicals"](t)||!!ra["Yi Syllables"](t))))))))))))))))))))}function oa(t){return 746===t||747===t||!(t<4352)&&(!!ra["Bopomofo Extended"](t)||(!!ra.Bopomofo(t)||(!(!ra["CJK Compatibility Forms"](t)||t>=65097&&t<=65103)||(!!ra["CJK Compatibility Ideographs"](t)||(!!ra["CJK Compatibility"](t)||(!!ra["CJK Radicals Supplement"](t)||(!!ra["CJK Strokes"](t)||(!(!ra["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||(!!ra["CJK Unified Ideographs Extension A"](t)||(!!ra["CJK Unified Ideographs"](t)||(!!ra["Enclosed CJK Letters and Months"](t)||(!!ra["Hangul Compatibility Jamo"](t)||(!!ra["Hangul Jamo Extended-A"](t)||(!!ra["Hangul Jamo Extended-B"](t)||(!!ra["Hangul Jamo"](t)||(!!ra["Hangul Syllables"](t)||(!!ra.Hiragana(t)||(!!ra["Ideographic Description Characters"](t)||(!!ra.Kanbun(t)||(!!ra["Kangxi Radicals"](t)||(!!ra["Katakana Phonetic Extensions"](t)||(!(!ra.Katakana(t)||12540===t)||(!(!ra["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||(!(!ra["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||(!!ra["Unified Canadian Aboriginal Syllabics"](t)||(!!ra["Unified Canadian Aboriginal Syllabics Extended"](t)||(!!ra["Vertical Forms"](t)||(!!ra["Yijing Hexagram Symbols"](t)||(!!ra["Yi Syllables"](t)||!!ra["Yi Radicals"](t))))))))))))))))))))))))))))))}function aa(t){return!(oa(t)||function(t){return!!(ra["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||ra["General Punctuation"](t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||ra["Letterlike Symbols"](t)||ra["Number Forms"](t)||ra["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||ra["Control Pictures"](t)&&9251!==t||ra["Optical Character Recognition"](t)||ra["Enclosed Alphanumerics"](t)||ra["Geometric Shapes"](t)||ra["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||ra["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||ra["CJK Symbols and Punctuation"](t)||ra.Katakana(t)||ra["Private Use Area"](t)||ra["CJK Compatibility Forms"](t)||ra["Small Form Variants"](t)||ra["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function ua(t){return t>=1424&&t<=2303||ra["Arabic Presentation Forms-A"](t)||ra["Arabic Presentation Forms-B"](t)}const la=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function ha(t){for(const n of la)if(t>=n[0]&&t<=n[1])return!0;return!1}const ca={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\\\":"＼","]":"﹈","^":"＾",_:"︳","\`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};const fa={horizontal:1,vertical:2,horizontalOnly:3};function da(t,n,e,r,i,s,o,a,u,l){let h=t.trim();l===fa.vertical&&(h=function(t){let n="";const e=Array.from(t);for(let t=0;t<e.length;t++){const r=e[t+1].codePointAt(0)||null,i=e[t-1].codePointAt(0)||null;r&&aa(r)&&!ca[e[t+1]]||i&&aa(i)&&!ca[e[t-1]]||!ca[e[t]]?n+=e[t]:n+=ca[e[t]]}return n}(h));const c=[],f={positionedGlyphs:c,text:h,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:l};let d;return d=function(t,n){const e=[];let r=0;for(let i=0;i<n.length;i++){const s=n[i];e.push(t.substring(r,s)),r=s}return r<t.length&&e.push(t.substring(r,t.length)),e}(h,function(t,n,e,r){if(!e)return[];if(!t)return[];const i=[],s=function(t,n,e,r){let i=0;for(let e=0;e<t.length;e++){const s=r[t.codePointAt(e)];s&&(i+=s.metrics.advance+n)}const s=Math.max(1,Math.ceil(i/e));return i/s}(t,n,e,r);let o=0;for(let e=0;e<t.length;e++){const a=t.codePointAt(e),u=r[a];u&&(u&&!pa[a]&&(o+=u.metrics.advance+n),e<t.length-1&&(ya[a]||sa(a))&&i.push(va(e+1,o,s,i,ga(a,t.codePointAt(e+1)),!1)))}return ba(va(t.length,o,s,i,0,!0))}(h,o,e,n)),function(t,n,e,r,i,s,o,a,u,l){let h=0,c=0,f=0;const d=t.positionedGlyphs,p=.5;for(let t=0;t<e.length;t++){let i=e[t];if(i=i.trim(),!i.length){c-=r;continue}const s=d.length;for(let t=0;t<i.length;t++){const e=i.codePointAt(t),r=n[e];r&&(oa(e)&&o!==fa.horizontal?(32!==e&&d.push({glyph:e,x:h,y:0,vertical:!0}),h+=u+a):(32!==e&&d.push({glyph:e,x:h,y:c,vertical:!1}),h+=r.metrics.advance+a))}if(d.length!==s){const t=h-a;f=Math.max(t,f),Ma(d,n,s,d.length-1,p)}h=0,c-=r}const{horizontalAlign:y,verticalAlign:m}=wa(i,l);!function(t,n,e,r,i,s,o){const a=(n-e)*i,u=-(-r*o+.5)*s;if(!a&&!u)return;for(let n=0;n<t.length;n++)t[n].x+=a,t[n].y+=u}(d,p,y,m,f,r,e.length);const g=e.length*r;t.top+=-m*g,t.bottom=t.top+g,t.left+=-y*f,t.right=t.left+f}(f,n,d,r,i,0,l,o,u),!!c.length&&f}const pa={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ya={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ma(t,n,e,r){const i=Math.pow(t-n,2);return r?t<n?i/2:2*i:i+Math.abs(e)*e}function ga(t,n){let e=0;return 10===t&&(e-=1e4),40!==t&&65288!==t||(e+=50),41!==n&&65289!==n||(e+=50),e}function va(t,n,e,r,i,s){let o=null,a=ma(n,e,i,s);for(let t=0;t<r.length;t++){const u=r[t],l=ma(n-u.x,e,i,s)+u.badness;l<=a&&(o=u,a=l)}return{index:t,x:n,priorBreak:o,badness:a}}function ba(t){return t?ba(t.priorBreak).concat(t.index):[]}function wa(t,n){let e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=n?1:0;break;case"left":case"top-left":case"bottom-left":e=n?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=n?1:0;break;case"top":case"top-right":case"top-left":r=n?0:1}return{horizontalAlign:e,verticalAlign:r}}function Ma(t,n,e,r,i){const s=n[t[r].glyph];if(s){const n=s.metrics.advance,o=(t[r].x+n)*i;if(!o)return;for(let n=e;n<=r;n++)t[n].x-=o}}function xa(t){if(!function(t){for(const n of t)if(ua(n.charCodeAt(0)))return!0;return!1}(t))return t;const n=[],e=[],r=[];let i=0,s=0,o=1,a=1;for(const u of t){const t=u.codePointAt(0);ha(t)?(r.push(u),i++):(o=ua(t)?-1:1,a!==o?(s=i,e.length&&(a>0&&e.reverse(),n.push(...e)),r.length&&(n.splice(s,0,...r),r.length=0),a=o,e.length=0):r.length&&(e.push(...r),r.length=0),e.push(u),i++)}return r.length&&e.push(...r),e.length&&(a>0&&e.reverse(),n.push(...e)),n.reverse().join("")}const Fa=/\\{ *([\\w_]+) *\\}/g;class ka{constructor(t,n,e,r,i){this.feature=t,this.symbolDef=n,this.symbol=e,this.options=i,this.bt=this.wt.bind(this),this.it=r}wt(t,n){return this.feature.properties[n]||""}getShape(t,n){if(this.Mt)return this.Mt;const{textHorizontalAlignmentFn:e,textVerticalAlignmentFn:r,markerHorizontalAlignmentFn:i,markerVerticalAlignmentFn:s,textWrapWidthFn:o}=this.it;let a;const u=this.symbol,l=this.getIconAndGlyph(),h=this.feature.properties;if(l&&l.glyph){const{font:t,text:i}=l.glyph;if(""===i)return null;const s=24,c=this.size[0]/s,f=24,d=u.textKeepUpright,p="map"===u.textRotationAlignment&&"line"===u.textPlacement&&!u.isIconText,y=n.glyphMap[t],m=Aa(e?e(null,h):u.textHorizontalAlignment,r?r(null,h):u.textVerticalAlignment),g=1.2*f,v=function(t){for(let n=0;n<t.length;n++)if(!ia(t.charAt(n).charCodeAt(0)))return!1;return!0}(i),b=v&&u.textLetterSpacing/c||0,w=[u.textDx/c||0,u.textDy/c||0],M=((o?o(null,h):u.textWrapWidth)||10*f)/c;a={},a.horizontal=da(i,y,M,g,m,0,b,w,f,fa.horizontal,this.options.isVector3D),v&&p&&d&&(a.vertical=da(i,y,M,g,m,0,b,w,f,fa.vertical))}else if(l&&l.icon){if(!t||!t.positions[l.icon.url])return null;const n=Aa(i?i(null,h):u.markerHorizontalAlignment,s?s(null,h):u.markerVerticalAlignment);a=function(t,n,e){let{horizontalAlign:r,verticalAlign:i}=wa(n,e);e?r=1-r:i=1-i;const s=-2048*r,o=-2048*i;return{image:t,top:o,bottom:o+2048,left:s,right:s+2048}}(t.positions[l.icon.url],n,this.options.isVector3D),this.size||(this.size=a.image.displaySize)}return this.Mt=a,a}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:n,markerPathFn:e,markerWidthFn:r,markerHeightFn:i,markerFillFn:s,markerFillPatternFileFn:o,markerFillOpacityFn:a,markerTextFitFn:u,markerTextFitPaddingFn:l,markerLineColorFn:h,markerLineWidthFn:c,markerLineOpacityFn:f,markerLineDasharrayFn:d,markerLinePatternFileFn:p,markerPathWidthFn:y,markerPathHeightFn:m,textNameFn:b,textFaceNameFn:w}=this.it,{zoom:M}=this.options,x={},F=this.symbol,k=this.feature.properties,A=t?t(null,k):F.markerFile,P=n?n(null,k):F.markerType,S=A||P||F.markerPath,_=!Ie(this.symbolDef.textName);let O;if(S){O=function(t,n,e,r,i,s){if(Ie(n.markerWidth)&&Ie(n.markerHeight))return null;const o="__fn_markerWidth".trim(),a="__fn_markerHeight".trim();let u=n.markerWidth||0,l=n.markerHeight||0;return De(u)&&("identity"!==u.type?u=Yo(u):(u=t.markerWidth,t[o]&&(u=t[o](r,e)),De(u)&&(u="identity"===u.type?i(r,e):Yo(u)))),De(l)&&("identity"!==l.type?l=Yo(l):(l=t.markerHeight,t[a]&&(l=t[a](r,e)),De(l)&&(l="identity"===l.type?s(r,e):Yo(l)))),[u,l]}(F,this.symbolDef,k,M,r,i)||[0,0];let t=F.markerTextFit;if(u&&(t=u(M,k)),t&&F.text&&"none"!==t){const n=F.text.textSize;let e=F.text.textName;g(e)&&(e=v(e)(M,k));const r=ta(e,k);if(r){const e="__fn_textSize".trim(),i="__fn_textSize_0".trim();g(n)&&!F.text[e]&&(F.text[i]=v(n),F.text[e]=(t,n)=>{const e=F.text[i](t,n);return g(e)?v(e)(t,n):e});const s=Xo(F.text,F.text,k,M);if("width"!==t&&"both"!==t||(O[0]=s[0]*r.length),"height"!==t&&"both"!==t||(O[1]=s[1]),s[0]&&s[1]){let t=F.markerTextFitPadding||[0,0,0,0];l&&(t=l(M,k)),O[0]+=t[1]+t[3],O[1]+=t[0]+t[2]}}else O[0]=O[1]=-1}}if(_&&(O=Xo(F,this.symbolDef,k,M)),!O)return x;if(O[0]=Math.ceil(O[0]),O[1]=Math.ceil(O[1]),this.size=O,S&&O[0]>=0&&O[1]>=0){let t;if(P){const n={};if(n.markerType=P,"path"===P&&(n.markerPath=e?e(null,k):F.markerPath,n.markerPathWidth=y?y(null,k):F.markerPathWidth,n.markerPathHeight=m?m(null,k):F.markerPathHeight),r){const t=r(null,k);Ie(t)||(n.markerWidth=t)}else F.markerWidth>=0&&(n.markerWidth=F.markerWidth);if(i){const t=i(null,k);Ie(t)||(n.markerHeight=t)}else F.markerHeight>=0&&(n.markerHeight=F.markerHeight);if(s){const t=s(null,k);Ie(t)||(n.markerFill=t)}else F.markerFill&&(n.markerFill=F.markerFill);if(o){const t=o(null,k);Ie(t)||(n.markerFillPatternFile=t)}else F.markerFillPatternFile&&(n.markerFillPatternFile=F.markerFillPatternFile);if(a){const t=a(null,k);Ie(t)||(n.markerFillOpacity=t)}else F.markerFillOpacity>=0&&(n.markerFillOpacity=F.markerFillOpacity);if(h){const t=h(null,k);Ie(t)||(n.markerLineColor=t)}else F.markerLineColor&&(n.markerLineColor=F.markerLineColor);if(c){const t=c(null,k);Ie(t)||(n.markerLineWidth=t)}else F.markerLineWidth>=0&&(n.markerLineWidth=F.markerLineWidth);if(f){const t=f(null,k);Ie(t)||(n.markerLineOpacity=t)}else F.markerLineOpacity>=0&&(n.markerLineOpacity=F.markerLineOpacity);if(d){const t=d(null,k);Ie(t)||(n.markerLineDasharray=t)}else F.markerLineDasharray&&(n.markerLineDasharray=F.markerLineDasharray);if(p){const t=p(null,k);Ie(t)||(n.markerLinePatternFile=t)}else F.markerLinePatternFile&&(n.markerLinePatternFile=F.markerLinePatternFile);t="vector://"+JSON.stringify(n)}else t=A?A.replace(Fa,this.bt):F.markerPath?function(t,n,e){if(!t.markerPath)return null;let r=1;const i=function(t){const n={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===n.stroke["stroke-width"]&&(n.stroke["stroke-opacity"]=0),n}(t);ze(t.markerOpacity)&&(r=t.markerOpacity),ze(t.opacity)&&(r*=t.opacity);const s={};if(i){for(const t in i.stroke)je(i.stroke,t)&&(Ie(i.stroke[t])||(s[t]=i.stroke[t]));for(const t in i.fill)je(i.fill,t)&&(Ie(i.fill[t])||(s[t]=i.fill[t]))}const o=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let a;const u=[];for(let t=0;t<o.length;t++)a=Te(o[t])?{path:o[t]}:o[t],a=$e({},a,s),a.d=a.path,delete a.path,u.push(a);const l=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];r<1&&l.push('opacity="'+r+'"'),t.markerPathWidth&&t.markerPathHeight&&l.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),l.push('preserveAspectRatio="none"'),n&&l.push('width="'+n+'"'),e&&l.push('height="'+e+'"'),l.push("><defs></defs>");for(let t=0;t<u.length;t++){let n="<path ";for(const e in u[t])je(u[t],e)&&(n+=" "+e+'="'+u[t][e]+'"');n+="></path>",l.push(n)}return l.push("</svg>"),"data:image/svg+xml;base64,"+btoa(l.join(" "))}(F,O[0],O[1]):null;x.icon={url:t,size:O}}if(_){const t=b?b(this.options.zoom,k):F.textName;if(t||0===t){const n=function(t){return t||"Open Sans Regular"}(w?w(null,k):F.textFaceName);let e=ta(t,k);e&&e.length&&(e=xa(e),x.glyph={font:n,text:e})}}return this.iconGlyph=x,x}}function Aa(t,n){n&&"middle"!==n||(n="center"),t&&"middle"!==t||(t="center");let e="center"!==n?n:"";return e+="center"!==t?(e.length?"-":"")+t:"",e}\n/*!\n     * From mapbox-gl-js\n     * MIT License\n     * https://github.com/mapbox/mapbox-gl-js\n     */function Pa(t,n,e,r,i){const s=[];let o;for(let a=0;a<t.length;a++){const u=t[a];let l,h=!1;for(let t=0;t<u.length-1;t++){let a=u[t],c=u[t+1];a.x<n&&c.x<n||(a.x<n?(o=a,a=new ln(n,a.y+(c.y-a.y)*((n-a.x)/(c.x-a.x))).j(),a.z=o.z+(c.z-o.z)*((n-o.x)/(c.x-o.x)),h=!0):c.x<n&&(o=c,c=new ln(n,a.y+(c.y-a.y)*((n-a.x)/(c.x-a.x))).j(),c.z=a.z+(o.z-a.z)*((n-a.x)/(o.x-a.x)),h=!0),a.y<e&&c.y<e||(a.y<e?(o=a,a=new ln(a.x+(c.x-a.x)*((e-a.y)/(c.y-a.y)),e).j(),a.z=o.z+(c.z-o.z)*((e-o.y)/(c.y-o.y)),h=!0):c.y<e&&(o=c,c=new ln(a.x+(c.x-a.x)*((e-a.y)/(c.y-a.y)),e).j(),c.z=a.z+(o.z-a.z)*((e-a.y)/(o.y-a.y)),h=!0),a.x>=r&&c.x>=r||(a.x>=r?(o=a,a=new ln(r,a.y+(c.y-a.y)*((r-a.x)/(c.x-a.x))).j(),a.z=o.z+(c.z-o.z)*((r-o.x)/(c.x-o.x)),h=!0):c.x>=r&&(o=c,c=new ln(r,a.y+(c.y-a.y)*((r-a.x)/(c.x-a.x))).j(),c.z=a.z+(o.z-a.z)*((r-a.x)/(o.x-a.x)),h=!0),a.y>=i&&c.y>=i||(a.y>=i?(o=a,a=new ln(a.x+(c.x-a.x)*((i-a.y)/(c.y-a.y)),i).j(),a.z=o.z+(c.z-o.z)*((i-o.y)/(c.y-o.y)),h=!0):c.y>=i&&(o=c,c=new ln(a.x+(c.x-a.x)*((i-a.y)/(c.y-a.y)),i).j(),c.z=a.z+(o.z-a.z)*((i-a.y)/(o.y-a.y)),h=!0),l&&a.equals(l[l.length-1])||(l=[a],s.push(l)),h&&(l.clipped=!0),l.push(c)))))}}return s}class Sa extends ln{constructor(t,n,e,r){super(t,n),this.angle=e,void 0!==r&&(this.segment=r)}clone(){return new Sa(this.x,this.y,this.angle,this.segment)}}\n/*!\n     * From mapbox-gl-js\n     * MIT License\n     * https://github.com/mapbox/mapbox-gl-js\n     */function _a(t,n,e,r,i){if(void 0===n.segment)return!0;let s=n,o=n.segment+1,a=0;for(;a>-e/2;){if(o--,o<0)return!1;a-=t[o].dist(s),s=t[o]}a+=t[o].dist(t[o+1]),o++;const u=[];let l=0;for(;a<e/2;){const n=t[o-1],e=t[o],s=t[o+1];if(!s)return!1;let h=n.angleTo(e)-e.angleTo(s);for(h=Math.abs((h+3*Math.PI)%(2*Math.PI)-Math.PI),u.push({distance:a,angleDelta:h}),l+=h;a-u[0].distance>r;)l-=u.shift().angleDelta;if(l>i)return!1;o++,a+=e.dist(s)}return!0}function Oa(t,n,e,r,i,s,o,a,u,l,h){const c=function(t,n,e){return t?.6*n*e:0}(r,s,o),f=function(t,n){return Math.max(t?t.right-t.left:0,0)}(r),d=0===t[0].x||t[0].x===u||0===t[0].y||t[0].y===u;n-f*o<n/4&&(n=f*o+n/4);return Ca(t,d?n/2*a%n:(f/2+2*s)*o*a%n,n,c,e,f*o,d,!1,u,l,h)}function Ca(t,n,e,r,i,s,o,a,u,l,h){let c=0;const f=s/2,d=function(t){let n=0;for(let e=0;e<t.length-1;e++)n+=t[e].dist(t[e+1]);return n}(t);let p=0,y=n-e,m=[];for(let n=0;n<t.length-1;n++){const o=t[n],a=t[n+1],g=o.dist(a),v=a.angleTo(o);for(;y+e<p+g;){y+=e;const b=(y-p)/g,w=Ea(o.x,a.x,b),M=Ea(o.y,a.y,b),x=Ea(o.z||0,a.z||0,b);if(w>=0&&w<u&&M>=0&&M<u&&y-f>=0&&y+f<=d){const e=new Sa(w,M,v,n);e.z=x,l&&(e.axis=[o.y-M,w-o.x],e.angleR=x===(o.z||0)?0:Math.atan(.9*(x-(o.z||0))*h/o.dist(e))),e.line=t,e.j(),!r||_a(t,e,s,r,i)?m.push(e):r&&c++}}p+=g}return a||m.length||o||(m=Ca(t,p/2,e,r,i,s,o,!0,u,l,h)),m.countOutOfAngle=c,m}function Ea(t,n,e){return t*(1-e)+n*e}var $a={exports:{}};$a.exports=function(){function t(t,e,i,s,o){n(t,e,i||0,s||t.length-1,o||r)}function n(t,r,i,s,o){for(;s>i;){if(s-i>600){var a=s-i+1,u=r-i+1,l=Math.log(a),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(a-h)/a)*(u-a/2<0?-1:1);n(t,r,Math.max(i,Math.floor(r-u*h/a+c)),Math.min(s,Math.floor(r+(a-u)*h/a+c)),o)}var f=t[r],d=i,p=s;for(e(t,i,r),o(t[s],f)>0&&e(t,i,s);d<p;){for(e(t,d,p),d++,p--;o(t[d],f)<0;)d++;for(;o(t[p],f)>0;)p--}0===o(t[i],f)?e(t,i,p):e(t,++p,s),p<=r&&(i=p+1),r<=p&&(s=p-1)}}function e(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function r(t,n){return t<n?-1:t>n?1:0}return t}();var Ia=Et($a.exports);function za(t,n){const e=t.length;if(e<=1)return[t];const r=[];let i,s;for(let n=0;n<e;n++){const e=An(t[n]);0!==e&&(t[n].area=Math.abs(e),void 0===s&&(s=e<0),s===e<0?(i&&r.push(i),i=[t[n]]):i.push(t[n]))}if(i&&r.push(i),n>1)for(let t=0;t<r.length;t++)r[t].length<=n||(Ia(r[t],n,1,r[t].length-1,Da),r[t]=r[t].slice(0,n));return r}function Da(t,n){return n.area-t.area}class Ta{constructor(t=[],n=Ua){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this.xt(t)}push(t){this.data.push(t),this.length++,this.Ft(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this.xt(0)),t}peek(){return this.data[0]}Ft(t){const{data:n,compare:e}=this,r=n[t];for(;t>0;){const i=t-1>>1,s=n[i];if(e(r,s)>=0)break;n[t]=s,t=i}n[t]=r}xt(t){const{data:n,compare:e}=this,r=this.length>>1,i=n[t];for(;t<r;){let r=1+(t<<1),s=n[r];const o=r+1;if(o<this.length&&e(n[o],s)<0&&(r=o,s=n[o]),e(s,i)>=0)break;n[t]=s,t=r}n[t]=i}}function Ua(t,n){return t<n?-1:t>n?1:0}function ja(t,n,e){const r=n.distSqr(e);if(0===r)return t.distSqr(n);const i=((t.x-n.x)*(e.x-n.x)+(t.y-n.y)*(e.y-n.y))/r;return i<0?t.distSqr(n):i>1?t.distSqr(e):t.distSqr(e.sub(n).S(i).F(n))}function Na(t,n=1,e=!1){let r=1/0,i=1/0,s=-1/0,o=-1/0;const a=t[0];for(let t=0;t<a.length;t++){const n=a[t];(!t||n.x<r)&&(r=n.x),(!t||n.y<i)&&(i=n.y),(!t||n.x>s)&&(s=n.x),(!t||n.y>o)&&(o=n.y)}const u=s-r,l=o-i,h=Math.min(u,l);let c=h/2;const f=new Ta([],La);if(0===h)return new ln(r,i);for(let n=r;n<s;n+=h)for(let e=i;e<o;e+=h)f.push(new Ha(n+c,e+c,c,t));let d=function(t){let n=0,e=0,r=0;const i=t[0];for(let t=0,s=i.length,o=s-1;t<s;o=t++){const s=i[t],a=i[o],u=s.x*a.y-a.x*s.y;e+=(s.x+a.x)*u,r+=(s.y+a.y)*u,n+=3*u}return new Ha(e/n,r/n,0,t)}(t),p=f.length;for(;f.length;){const r=f.pop();(r.d>d.d||!d.d)&&(d=r,e&&console.log("found best %d after %d probes",Math.round(1e4*r.d)/1e4,p)),r.max-d.d<=n||(c=r.h/2,f.push(new Ha(r.p.x-c,r.p.y-c,c,t)),f.push(new Ha(r.p.x+c,r.p.y-c,c,t)),f.push(new Ha(r.p.x-c,r.p.y+c,c,t)),f.push(new Ha(r.p.x+c,r.p.y+c,c,t)),p+=4)}return e&&(console.log(\`num probes: ${bk}p}\`),console.log(\`best distance: ${bk}d.d}\`)),d.p}function La(t,n){return n.max-t.max}function Ha(t,n,e,r){this.p=new ln(t,n),this.h=e,this.d=function(t,n){let e=!1,r=1/0;for(let i=0;i<n.length;i++){const s=n[i];for(let n=0,i=s.length,o=i-1;n<i;o=n++){const i=s[n],a=s[o];i.y>t.y!=a.y>t.y&&t.x<(a.x-i.x)*(t.y-i.y)/(a.y-i.y)+i.x&&(e=!e),r=Math.min(r,ja(t,i,a))}}return(e?1:-1)*Math.sqrt(r)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}function Ra(t,n,e,r,i,s,o,a,u,l){const{feature:h,size:c,symbol:f}=t,d=c?24:0,p=i*(c?c[0]/d:1);if("line"===o){const t=[];t.countOutOfAngle=0;let i=h.geometry;s&&(i=Pa(h.geometry,0,0,s,s));for(let o=0;o<i.length;o++){const h=Oa(i[o],a,e,f.isIconText?null:r&&r.vertical||r&&r.horizontal||r,0,d,f.isIconText?1:p,1,s||1/0,u,l);if(f.textPlacement&&!f.isIconText)for(let t=0;t<h.length;t++)h[t].startIndex=n.length/3;if(t.push.apply(t,h),f.textPlacement&&!f.isIconText)for(let t=0;t<i[o].length;t++)n.push(i[o][t].x,i[o][t].y,i[o][t].z||0);t.countOutOfAngle+=h.countOutOfAngle||0}return t}return Va(h,o,s)}function Va(t,n,e,r,i){const s=[];if(3===t.type){const o=za(t.geometry,0);for(let t=0;t<o.length;t++){const a=o[t];if("vertex"===n)for(let t=0;t<a.length;t++){const n=a[t];for(let o=0;o<n.length;o++)On(n[o],e)||(s.push(n[o]),r&&(0===o?qa(n[o],n[o],n[t+1],i):qa(n[o],n[o-1],n[o],i)))}else if("vertex-first"===n){const t=a[0];t&&t[0]&&!On(t[0],e)&&(s.push(t[0]),r&&qa(t[0],t[0],t[1],i))}else if("vertex-last"===n||"vertex-firstlast"===n){const t=a[0];if("vertex-firstlast"===n&&t&&t[0]&&!On(t[0],e)&&(s.push(t[0]),r&&qa(t[0],t[0],t[1],i)),t&&t[t.length-1]&&!On(t[t.length-1],e)){const n=t.length-1;s.push(t[n]),r&&qa(t[n],t[n-1],t[n],i)}}else{const t=Na(a,16);On(t,e)||s.push(t)}}}else if(2===t.type)for(let o=0;o<t.geometry.length;o++){const a=t.geometry[o];if("vertex"===n)for(let t=0;t<a.length;t++)On(a[t],e)||(s.push(a[t]),r&&(0===t?qa(a[t],a[t],a[t+1],i):qa(a[t],a[t-1],a[t],i)));else if("vertex-last"===n||"vertex-firstlast"===n){if("vertex-firstlast"!==n||On(a[0],e)||(s.push(a[0]),r&&qa(a[0],a[0],a[1],i)),a&&a[a.length-1]&&!On(a[a.length-1],e)){const t=a.length-1;s.push(a[t]),r&&qa(a[t],a[t-1],a[t],i)}}else On(a[0],e)||(s.push(a[0]),r&&qa(a[0],a[0],a[1],i))}else if(1===t.type)for(let n=0;n<t.geometry.length;n++){const i=t.geometry[n];for(let t=0;t<i.length;t++){const n=i[t];On(n,e)||(r&&(n.xRotation=0,n.yRotation=0,n.zRotation=0),s.push(n))}}return s}function qa(t,n,e,r){if(t.xRotation||t.yRotation||t.zRotation)return t;const i=e.x-n.x,s=n.y-e.y,o=(e.z-n.z)*r,a=Math.atan2(s,i);t.zRotation=a;const u=Math.atan2(o,Math.sqrt(i*i+s*s));return t.xyRotation=u,t}function Ga(t,n){const e={},r={},i=[];let s=0;function o(n){i.push(t[n]),s++}function a(t,n,e){const s=r[t];return delete r[t],r[n]=s,i[s].geometry[0].pop(),i[s].geometry[0]=i[s].geometry[0].concat(e[0]),s}function u(t,n,r){const s=e[n];return delete e[n],e[t]=s,i[s].geometry[0].shift(),i[s].geometry[0]=r[0].concat(i[s].geometry[0]),s}function l(t,n,e){const r=e?n[0][n[0].length-1]:n[0][0];return\`${bk}t}:${bk}r.x}:${bk}r.y}\`}for(let h=0;h<t.length;h++){const c=t[h],f=c.geometry;if(!f)continue;const d=c.properties[n]?c.properties[n].toString():null;if(!d){o(h);continue}const p=l(d,f),y=l(d,f,!0);if(p in r&&y in e&&r[p]!==e[y]){const t=u(p,y,f),n=a(p,y,i[t].geometry);delete e[p],delete r[y],r[l(d,i[n].geometry,!0)]=n,i[t].geometry=null}else p in r?a(p,y,f):y in e?u(p,y,f):(o(h),e[p]=s-1,r[y]=s-1)}return i.filter((t=>t.geometry))}const Ja="__index";function Wa(t,n,e,r){const i=(Ja+"").trim(),s=function(t,n,e,r){const i=(Ja+"").trim(),{mergeOnPropertyFn:s}=e;if(!n.mergeOnProperty)return[];if(o=n.mergeOnProperty,!Cn(o)&&("string"==typeof o||null!==o.constructor&&o.constructor===String))return[{features:t,property:n.mergeOnProperty}];var o;const a=[],u={},l=[];for(let e=0;e<t.length;e++){t[e][i]=e;const o=t[e].properties=t[e].properties||{};o.$layer=t[e].layer,o.$type=t[e].type;const h=s?s(r,o):n.mergeOnProperty;Cn(h)?l.push(t[e]):(void 0===u[h]&&(u[h]=a.length,a.push({features:[],property:h})),a[u[h]].features.push(t[e]))}l.length&&a.push({features:l});return a}(t,n,e,r);if(s.length){const n=[];for(let e=0;e<s.length;e++)s[e].property?n.push(Ga(s[e].features,s[e].property)):n.push(t);if(1===n.length)return n[0];{let t=[];for(let e=0;e<n.length;e++)t=t.concat(n[e]);return t.sort(((t,n)=>t[i]-n[i])),t}}return[]}const Ba=14;class Xa extends Go{static needMerge(t,n,e){if(!t)return!1;let r="line"===t.textPlacement||"line"===t.markerPlacement;return r||(n.textPlacementFn&&(r="line"===n.textPlacementFn(e)),n.markerPlacementFn&&(r="line"===n.markerPlacementFn(e))),t.mergeOnProperty&&r}static mergeLineFeatures(t,n,e,r){let i=n.textPlacement,s=n.markerPlacement;return e.textPlacementFn&&(i=e.textPlacementFn(r)),e.markerPlacementFn&&(s=e.markerPlacementFn(r)),"line"!==i&&"line"!==s?t:Wa(t,n,e,r)}static splitPointSymbol(t,n=0){const e=[];if(Array.isArray(t)){const n=t;for(let t=0;t<n.length;t++)n[t]&&e.push(...Xa.splitPointSymbol(n[t],t));return e}let r=null,i=null;for(const n in t)0===n.indexOf("marker")?(r=r||{},r[n]=t[n]):0===n.indexOf("text")&&(i=i||{},i[n]=t[n]);return r&&(r.isIconText=!0,t.mergeOnProperty&&(r.mergeOnProperty=t.mergeOnProperty),e.push(r)),i&&(r&&(i.textPlacement=r.markerPlacement,i.textSpacing=r.markerSpacing,i.isIconText=!0),t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),e.push(i)),void 0!==t.visible&&(r&&(r.visible=t.visible),i&&(i.visible=t.visible)),r&&(r.markerTextFit&&i&&(r.text={},r.text.textName=i.textName,r.text.textSize=i.textSize),r.index={index:n,type:0}),i&&(i.index={index:n,type:1}),e}static isAtlasLoaded(t,n){const{icon:e,glyph:r}=t,{iconAtlas:i,glyphAtlas:s}=n;if(e&&(!i||!i.positions[e.url]))return!1;if(r){if(!s||!s.positions[r.font])return!1;const t=s.positions[r.font],{text:n}=r;for(const e of n)if(!t[e.codePointAt(0)])return!1}return!0}constructor(t,n,e){super(t,n,e),this.kt=n.textPlacement,this.it.textPlacementFn&&(this.kt=this.it.textPlacementFn(this.options.zoom))}createStyledVector(t,n,e,r,i,s){const o=new ka(t,this.symbolDef,n,e,r),a=o.getIconAndGlyph();if(a.icon&&!this.options.atlas){const{url:t,size:n}=a.icon;i[t]||(i[t]=a.icon.size),i[t][0]<n[0]&&(i[t][0]=n[0]),i[t][1]<n[1]&&(i[t][1]=n[1])}if(a.glyph&&!this.options.atlas){const{font:t,text:n}=a.glyph,e=s[t]=s[t]||{};for(const t of n)e[t.codePointAt(0)]=1;"line"===this.kt&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||a.icon||a.glyph?o:null}getFormat(t){const n=void 0!==t.textName,e=n?this.getPackSDFFormat(t):this.getPackMarkerFormat();n?e.push(...this.At()):e.push(...this.Pt());const{markerOpacityFn:r,textOpacityFn:i,markerPitchAlignmentFn:s,textPitchAlignmentFn:o,markerRotationAlignmentFn:a,textRotationAlignmentFn:u,markerRotationFn:l,textRotationFn:h,markerAllowOverlapFn:c,textAllowOverlapFn:f,markerIgnorePlacementFn:d,textIgnorePlacementFn:p}=this.it;return(r||i)&&e.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(s||o)&&e.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(a||u)&&e.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(l||h)&&e.push({type:Uint16Array,width:1,name:"aRotation"}),(c||f||d||p)&&e.push({type:Uint8Array,width:1,name:"aOverlap"}),e}St(){return this.hasMapPitchAlign}At(){const{textFillFn:t,textSizeFn:n,textHaloFillFn:e,textHaloRadiusFn:r,textHaloOpacityFn:i,textDxFn:s,textDyFn:o}=this.it,a=[];return t&&a.push({type:Uint8Array,width:4,name:"aTextFill"}),n&&a.push({type:Uint8Array,width:1,name:"aTextSize"}),e&&a.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),r&&a.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),i&&a.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),s&&a.push({type:Int8Array,width:1,name:"aTextDx"}),o&&a.push({type:Int8Array,width:1,name:"aTextDy"}),a}Pt(){const{markerWidthFn:t,markerHeightFn:n,markerDxFn:e,markerDyFn:r}=this.it,i=[];return t&&i.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),n&&i.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),e&&i.push({type:Int8Array,width:1,name:"aMarkerDx"}),r&&i.push({type:Int8Array,width:1,name:"aMarkerDy"}),i}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,n){const e=t.getShape(this.iconAtlas,this.glyphAtlas),r=!e||!e.image,i=!e||!e.horizontal&&!e.vertical;if(!this.options.allowEmptyPack&&r&&i)return;const s=this._t(t,e,n);this.countOutOfAngle+=s.countOutOfAngle||0;if(0===s.length)return;const o=this.data,a=this.needAltitudeAttribute()?2:3;let u=this.data.aPosition.getLength()/a;const l=t.symbol,h=t.feature.properties,c="line"===this.kt&&!l.isIconText,f=void 0!==l.textName,d=f&&c&&function(t){let n=0;for(let e=0;e<t.length;e++)if(oa(t.charAt(e).charCodeAt(0)))n=0;else if(n++,n>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:p,textSizeFn:y,textHaloFillFn:m,textHaloRadiusFn:v,textHaloOpacityFn:b,textDxFn:w,textDyFn:M,textPitchAlignmentFn:x,textRotationAlignmentFn:F,textRotationFn:k,textAllowOverlapFn:A,textIgnorePlacementFn:P,textOpacityFn:S,markerWidthFn:_,markerHeightFn:O,markerDxFn:C,markerDyFn:E,markerPitchAlignmentFn:$,markerRotationAlignmentFn:I,markerRotationFn:z,markerAllowOverlapFn:D,markerIgnorePlacementFn:T,markerOpacityFn:U}=this.it;let j,N,L,H,R,V,q,G,J,W,B,X,Y,K,Z,Q,tt;if(f){const n=t.getIconAndGlyph().glyph.font;j=function(t,n,e){const r=t.positionedGlyphs,i=[];for(let s=0;s<r.length;s++){const o=r[s],a=e[o.glyph];if(!a)continue;const u=a.rect;if(!u)continue;const l=4,h=a.metrics.advance/2,c=a.metrics.height/2,f=n?[o.x+h,0]:[0,0],d=n?[0,o.y-c]:[o.x+h,o.y-c],p=a.metrics.left-l-h+d[0],y=a.metrics.top-l+d[1],m=p+u.w,g=y+u.h,v=new ln(p,y),b=new ln(m,y),w=new ln(p,g),M=new ln(m,g);if(n&&o.vertical){const t=new ln(-h,h),n=-Math.PI/2,e=new ln(5,0);v.I(n,t).F(e),b.I(n,t).F(e),w.I(n,t).F(e),M.I(n,t).F(e)}i.push({tl:v,tr:b,bl:w,br:M,tex:u,writingMode:t.writingMode,glyphOffset:f})}return i}(e.horizontal,c,this.glyphAtlas.positions[n]),p&&(N=p(null,h),g(N)?(this.dynamicAttrs.aTextFill=1,N=[0,0,0,0]):N=He([],N)),y&&(L=y(this.options.zoom,h),Cn(L)&&(L=Ba)),m&&(H=m(null,h),g(H)?(this.dynamicAttrs.aTextHaloFill=1,H=[0,0,0,0]):H=He([],H)),v&&(R=v(null,h)),b&&(V=255*b(null,h)),w&&(q=w(null,h)||0),M&&(G=M(null,h)||0),x&&(Y=+("map"===x(null,h))),F&&(K=+("map"===F(null,h))),k&&(Z=En(k(null,h),0,360)*Math.PI/180)}else j=e?function(t){const n=t.image,e=t.top-1/n.pixelRatio,r=t.left-1/n.pixelRatio,i=t.bottom+1/n.pixelRatio,s=t.right+1/n.pixelRatio;let o,a,u,l;return o=new ln(r,e),a=new ln(s,e),u=new ln(s,i),l=new ln(r,i),[{tl:o,tr:a,bl:l,br:u,tex:{x:n.tl[0],y:n.tl[1],w:n.displaySize[0],h:n.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(e):function(){const t=new ln(0,0),n=new ln(0,0),e=new ln(0,0);return[{tl:t,tr:n,bl:new ln(0,0),br:e,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),_&&(J=_(null,h)),Cn(J)&&(J=j[0].tex.w),O&&(W=O(null,h)),Cn(W)&&(W=j[0].tex.h),C&&(B=C(null,h)),E&&(X=E(null,h)),$&&(Y=+("map"===$(null,h))),I&&(K=+("map"===I(null,h))),z&&(Z=En(z(null,h),0,360)*Math.PI/180);g(L)&&(this.dynamicAttrs.aTextSize=1),g(R)&&(this.dynamicAttrs.aTextHaloRadius=1),g(V)&&(this.dynamicAttrs.aTextHaloOpacity=1),g(q)&&(this.dynamicAttrs.aTextDx=1),g(G)&&(this.dynamicAttrs.aTextDy=1),g(J)&&(this.dynamicAttrs.aMarkerWidth=1),g(W)&&(this.dynamicAttrs.aMarkerHeight=1),g(B)&&(this.dynamicAttrs.aMarkerDx=1),g(X)&&(this.dynamicAttrs.aMarkerDy=1),g(Y)&&(this.dynamicAttrs.aPitchAlign=1),g(K)&&(this.dynamicAttrs.aRotationAlign=1),g(Z)&&(this.dynamicAttrs.aRotation=1);const nt=D||A;nt&&(Q=nt(null,h)||0);const et=T||P;let rt;et&&(tt=et(null,h)||0);const it=S||U;it&&(rt=255*it(this.options.zoom,h));const st=j.length;this.ensureDataCapacity(4*st,s.length);const ot=this.options.EXTENT,{altitudeScale:at,altitudeProperty:ut,defaultAltitude:lt}=this.options,{altitude:ht}=_n(t.feature,at,ut,lt);for(let t=0;t<s.length;t++){const n=s[t],e=n.z||ht||0;if(ot!==1/0&&On(n,ot))continue;const r=n.x,i=n.y,a=j.length;for(let t=0;t<a;t++){const s=j[t],{tl:a,tr:l,bl:h,br:p,tex:y}=s;this.Ot(o,r,i,e,10*a.x,10*a.y,y.x,y.y+y.h),f&&this.Ct(o,c,st,s.glyphOffset,n,d,n.axis,n.angleR),this.Et(o,N,L,H,R,V,q,G,J,W,B,X,rt,Y,K,Z,Q,tt),this.Ot(o,r,i,e,10*l.x,10*l.y,y.x+y.w,y.y+y.h),f&&this.Ct(o,c,st,s.glyphOffset,n,d,n.axis,n.angleR),this.Et(o,N,L,H,R,V,q,G,J,W,B,X,rt,Y,K,Z,Q,tt),this.Ot(o,r,i,e,10*h.x,10*h.y,y.x,y.y),f&&this.Ct(o,c,st,s.glyphOffset,n,d,n.axis,n.angleR),this.Et(o,N,L,H,R,V,q,G,J,W,B,X,rt,Y,K,Z,Q,tt),this.Ot(o,r,i,e,10*p.x,10*p.y,y.x+y.w,y.y),f&&this.Ct(o,c,st,s.glyphOffset,n,d,n.axis,n.angleR),this.Et(o,N,L,H,R,V,q,G,J,W,B,X,rt,Y,K,Z,Q,tt),this.addElements(u,u+1,u+2),this.addElements(u+1,u+2,u+3),u+=4;const m=Math.max(Math.abs(r),Math.abs(i),Math.abs(e));m>this.maxPos&&(this.maxPos=m)}}}Ot(t,n,e,r,i,s,o,a){this.fillPosition(t,n,e,r);let u=t.aShape.currentIndex;t.aShape[u++]=i,t.aShape[u++]=s,t.aShape.currentIndex=u,u=t.aTexCoord.currentIndex,t.aTexCoord[u++]=o,t.aTexCoord[u++]=a,t.aTexCoord.currentIndex=u}Ct(t,n,e,r,i,s,o,a){let u=t.aCount.currentIndex;if(t.aCount[u++]=e,t.aCount.currentIndex=u,n){u=t.aGlyphOffset.currentIndex,t.aGlyphOffset[u++]=r[0],t.aGlyphOffset[u++]=r[1],t.aGlyphOffset.currentIndex=u,this.St()&&(u=t.aPitchRotation.currentIndex,t.aPitchRotation[u++]=o[0],t.aPitchRotation[u++]=o[1],t.aPitchRotation[u++]=a,t.aPitchRotation.currentIndex=u);const n=i.startIndex;u=t.aSegment.currentIndex,t.aSegment[u++]=i.segment+n,t.aSegment[u++]=n,t.aSegment[u++]=i.line.length,t.aSegment.currentIndex=u,u=t.aVertical.currentIndex,t.aVertical[u++]=s,t.aVertical.currentIndex=u}}Et(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m,g){const{textFillFn:v,textSizeFn:b,textHaloFillFn:w,textHaloRadiusFn:M,textHaloOpacityFn:x,textDxFn:F,textDyFn:k,textPitchAlignmentFn:A,textRotationAlignmentFn:P,textRotationFn:S,textAllowOverlapFn:_,textIgnorePlacementFn:O,textOpacityFn:C,markerWidthFn:E,markerHeightFn:$,markerDxFn:I,markerDyFn:z,markerPitchAlignmentFn:D,markerRotationAlignmentFn:T,markerRotationFn:U,markerAllowOverlapFn:j,markerIgnorePlacementFn:N,markerOpacityFn:L}=this.it;if(v){let e=t.aTextFill.currentIndex;t.aTextFill[e++]=n[0],t.aTextFill[e++]=n[1],t.aTextFill[e++]=n[2],t.aTextFill[e++]=n[3],t.aTextFill.currentIndex=e}if(b){let n=t.aTextSize.currentIndex;t.aTextSize[n++]=e,t.aTextSize.currentIndex=n}if(w){let n=t.aTextHaloFill.currentIndex;t.aTextHaloFill[n++]=r[0],t.aTextHaloFill[n++]=r[1],t.aTextHaloFill[n++]=r[2],t.aTextHaloFill[n++]=r[3],t.aTextHaloFill.currentIndex=n}if(M){let n=t.aTextHaloRadius.currentIndex;t.aTextHaloRadius[n++]=i,t.aTextHaloRadius.currentIndex=n}if(x){let n=t.aTextHaloOpacity.currentIndex;t.aTextHaloOpacity[n++]=s,t.aTextHaloOpacity.currentIndex=n}if(F){let n=t.aTextDx.currentIndex;t.aTextDx[n++]=o,t.aTextDx.currentIndex=n}if(k){let n=t.aTextDy.currentIndex;t.aTextDy[n++]=a,t.aTextDy.currentIndex=n}if(E){let n=t.aMarkerWidth.currentIndex;t.aMarkerWidth[n++]=u,t.aMarkerWidth.currentIndex=n}if($){let n=t.aMarkerHeight.currentIndex;t.aMarkerHeight[n++]=l,t.aMarkerHeight.currentIndex=n}if(I){let n=t.aMarkerDx.currentIndex;t.aMarkerDx[n++]=h,t.aMarkerDx.currentIndex=n}if(z){let n=t.aMarkerDy.currentIndex;t.aMarkerDy[n++]=c,t.aMarkerDy.currentIndex=n}if(L||C){let n=t.aColorOpacity.currentIndex;t.aColorOpacity[n++]=f,t.aColorOpacity.currentIndex=n}if(A||D){let n=t.aPitchAlign.currentIndex;t.aPitchAlign[n++]=d,t.aPitchAlign.currentIndex=n}if(T||P){let n=t.aRotationAlign.currentIndex;t.aRotationAlign[n++]=p,t.aRotationAlign.currentIndex=n}if(U||S){let n=t.aRotation.currentIndex;t.aRotation[n++]=9362*y,t.aRotation.currentIndex=n}const H=j||_,R=N||O;if(H||R){const n=(H?8:0)+4*m,e=(R?2:0)+g;let r=t.aOverlap.currentIndex;t.aOverlap[r++]=n+e,t.aOverlap.currentIndex=r}i>0&&(this.properties.hasHalo=1)}_t(t,n,e){const{feature:r,symbol:i}=t,s=this.$t(t,i),o=r.properties,{markerSpacingFn:a,textSpacingFn:u,textMaxAngleFn:l}=this.it,h=((a?a(null,o):i.markerSpacing)||(u?u(null,o):i.textSpacing)||250)*e;let c=l?l(this.options.zoom,o):i.textMaxAngle;Cn(c)&&(c=80),c*=Math.PI/180;const f=this.options.EXTENT,d=this.options.altitudeToTileScale,p=this.St();return Ra(t,this.lineVertex,c,n,e,f,s,h,p,d)}$t(t,n){let e;return e=this.it.markerPlacementFn?this.it.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement||this.kt,this.gt||!n.markerPlacement&&!n.isIconText||(this.gt=e),!this.kt||n.isIconText||this.vt||(this.vt=e),e}getPackSDFFormat(t){if("line"!==this.kt||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this.St()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}}class Ya{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new Ya(this)}T(){return this.O(this.mag()),this}O(t){return this.x/=t,this.y/=t,this.z/=t,this}U(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone().F(t)}sub(t){return this.clone().k(t)}F(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}k(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone().S(t)}S(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var n=t.x-this.x,e=t.y-this.y,r=t.z-this.z;return n*n+e*e+r*r}j(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}}const Ka=63,Za=Math.cos(Math.PI/180*37.5),Qa=Math.pow(2,16)/1,tu=new ln,nu=new ln,eu=new ln;class ru extends Go{static mergeLineFeatures(t,n,e,r){return Wa(t,n,e,r)}constructor(t,n,e){super(t,n,e);let r=!1;const{lineDasharrayFn:i,lineDashColorFn:s}=this.it;this.hasGradient=this.symbol.lineGradientProperty,i&&(r=function(t,n,e){for(let r=0;r<t.length;r++){if(e(n,t[r].properties))return!0}return!1}(t,this.options.zoom,i),r&&(this.dasharrayFn=i)),this.hasDasharray=ou(this.symbol.lineDasharray)||r,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,n,e,r,i){const s=new qe(t,n,e,r),o=s.getLineResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:n,lineStrokeColorFn:e,lineColorFn:r,lineOpacityFn:i,lineDxFn:s,lineDyFn:o,linePatternAnimSpeedFn:a,linePatternGapFn:u}=this.it,l=[...this.getPositionFormat()];if(this.iconAtlas||this.hasDasharray?l.push({type:Int8Array,width:3,name:"aExtrude"}):l.push({type:Int8Array,width:2,name:"aExtrude"}),l.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&l.push({type:Uint8Array,width:1,name:"aLineWidth"}),n&&l.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),r&&l.push({type:Uint8Array,width:4,name:"aColor"}),e&&l.push({type:Uint8Array,width:4,name:"aStrokeColor"}),i&&l.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&l.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&l.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();l.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||o)&&l.push({type:Int8Array,width:2,name:"aLineDxDy"}),(a||u)&&l.push({type:Int8Array,width:2,name:"aLinePattern"}),l}placeVector(t){const{lineJoinFn:n,lineCapFn:e,lineWidthFn:r,lineHeightFn:i,lineStrokeWidthFn:s,lineStrokeColorFn:o,lineColorFn:a,lineOpacityFn:u,lineDxFn:l,lineDyFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.it,d=this.symbol,p=t.feature,y=p.properties;this.elements;let m=d.lineJoin||"miter",v=d.lineCap||"butt";if(n&&(m=n(this.options.zoom,y)||"miter"),e&&(v=e(this.options.zoom,y)||"butt"),r){let t=r(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),Ie(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+d.lineWidth;if(i){let t=i(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLineHeight=1),Ie(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+d.lineHeight||this.feaLineWidth;if(s){let t=s(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),Ie(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=d.lineStrokeWidth||0;if(a&&(this.feaColor=a(this.options.zoom,y)||[255,255,255,255],g(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=He([],this.feaColor)),o&&(this.feaStrokeColor=o(this.options.zoom,y)||[0,0,0,255],g(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=He([],this.feaStrokeColor)),u){let t=u(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aOpacity=1,t=1),Ie(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,y)||[0,0,0,0];if(g(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const n=t;1===t.length?t=[n[0],n[0],n[0],n[0]]:2===t.length?t=[n[0],n[1],n[0],n[1]]:3===t.length&&(t=[n[0],n[1],n[2],n[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,y):this.symbol.lineDashColor)||[0,0,0,0];g(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=He([],t),this.feaDashColor=t}if(this.iconAtlas){const n=t.getLineResource(),e=this.iconAtlas.glyphMap[n];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],e){const{tl:t,displaySize:e}=this.iconAtlas.positions[n];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=e[0]-3,this.feaTexInfo[3]=e[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(l){let t=l(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),Ie(t)&&(t=0),this.feaLineDx=t}if(h){let t=h(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),Ie(t)&&(t=0),this.feaLineDy=t}if(c){let t=c(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),Ie(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(f){let t=f(this.options.zoom,y);g(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),Ie(t)&&(t=0),this.feaLinePatternGap=t}const b=this.options.EXTENT;let w=p.geometry;if(b!==1/0){w=[];const t=[];for(let n=0;n<p.geometry.length;n++){t[0]=p.geometry[n];const e=Pa(t,-1,-1,b+1,b+1);if(3===p.type&&e.length>1){const t=e[0],n=e[e.length-1];hu(t[0],n[n.length-1])&&(e[0]=n.concat(t.slice(1)),e.length=e.length-1)}w.push(...e)}}const M=this.needAltitudeAttribute()?2:3;for(let t=0;t<w.length;t++){this.offset=this.data.aPosition.getLength()/M;const n=w[t];this.It(n,p,m,v,2,1.05)}}zt(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}It(t,n,e,r,i,s){const o=this.zt()||ou(this.feaDash)||ou(this.symbol.lineDasharray),a=this.options.isTube;a&&(t=t.map((t=>new Ya(t)))),this.overscaling=1;const u=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&n.properties&&ze(n.properties.mapbox_clip_start)&&ze(n.properties.mapbox_clip_end)){this.clipStart=+n.properties.mapbox_clip_start,this.clipEnd=+n.properties.mapbox_clip_end;for(let n=0;n<t.length-1;n++)this.totalDistance+=t[n].dist(t[n+1]);this.updateScaledDistance()}const l=3===n.type&&!t.clipped;let h=t.length;for(;h>=2&&hu(t[h-1],t[h-2]);)h--;let c=0;for(;c<h-1&&hu(t[c],t[c+1]);)c++;if(h<(l?3:2))return;"bevel"===e&&(i=1.05);const f=this.overscaling<=16?15*u/(512*this.overscaling):0,d={vertexLength:0,primitiveLength:0,currentNormal:null};let p,y,m,g,v;this.e1=this.e2=-1,l&&(p=t[h-2],v=t[c].sub(p).T().U()),this.ensureDataCapacity(e,h,360,2);for(let n=c;n<h;n++){if(m=n===h-1?l?t[c+1]:void 0:t[n+1],m&&hu(t[n],m))continue;v&&(g=v),p&&(y=p),p=t[n],m&&p.x===m.x&&p.y===m.y&&(p.x+=1e-4),v=m?m.sub(p).T().U():g,d.dir=y?p.sub(y).T():m.sub(p).T(),g=g||v,d.currentNormal=g;let u=g.add(v);0===u.x&&0===u.y||u.T();const b=g.x*v.x+g.y*v.y,w=u.x*v.x+u.y*v.y,M=0!==w?1/w:1/0,x=2*Math.sqrt(2-2*w),F=w<Za&&y&&m,k=g.x*v.y-g.y*v.x>0;if(!a&&F&&n>c){const t=p.dist(y);if(t>2*f){const n=p.sub(p.sub(y).S(f/t).j());n.z=p.z,this.updateDistance(y,n),this.addCurrentVertex(n,g,0,0,d),y=n}}const A=y&&m;d.middleVertex=A;let P=A?e:l?"butt":r;if(A&&"round"===P&&(M<s?P="miter":M<=2&&(P="fakeround")),"miter"===P&&M>i&&!a&&(P="bevel"),"bevel"===P&&(M>2&&(P="flipbevel"),M<i&&(P="miter")),y&&this.updateDistance(y,p),"miter"===P)a?(this.addCurrentVertex(p,g,0,0,d),d.dir=m.sub(p).T(),this.addCurrentVertex(p,v,0,0,d)):(u.S(M),this.addCurrentVertex(p,u,0,0,d),o&&(d.currentNormal=v,d.dir=m.sub(p).T(),this.addCurrentVertex(p,u,0,0,d)));else if("flipbevel"===P){if(M>100)u=v.mult(-1);else{const t=M*g.add(v).mag()/g.sub(v).mag();u.U().S(t*(k?-1:1))}this.addCurrentVertex(p,u,0,0,d),this.addCurrentVertex(p,u.mult(-1),0,0,d)}else if("bevel"===P||"fakeround"===P){const t=-Math.sqrt(M*M-1),n=k?t:0,e=k?0:t;if(y&&this.addCurrentVertex(p,g,n,e,d),"fakeround"===P){const t=Math.round(180*x/Math.PI/20);for(let n=1;n<t;n++){let e=n/t;if(.5!==e){const t=e-.5;e+=e*t*(e-1)*((1.0904+b*(b*(3.55645-1.43519*b)-3.2452))*t*t+(.848013+b*(.215638*b-1.06021)))}const r=v.sub(g).S(e).F(g).T().S(k?-1:1);this.addHalfVertex(p,r.x,r.y,!1,k,0,d)}}m&&(d.currentNormal=v,d.dir=m.sub(p).T(),this.addCurrentVertex(p,v,-n,-e,d))}else if("butt"===P)this.addCurrentVertex(p,u,0,0,d);else if("square"===P){const t=y?1:-1;this.addCurrentVertex(p,u,t,t,d)}else"round"===P&&(y&&(this.addCurrentVertex(p,g,0,0,d),this.addCurrentVertex(p,g,1,1,d,!0)),m&&(this.addCurrentVertex(p,v,-1,-1,d,!0),this.addCurrentVertex(p,v,0,0,d)));if(!a&&F&&n<h-1){const t=p.dist(m);if(t>2*f){const n=p.add(m.sub(p).S(f/t).j());n.z=p.z,this.updateDistance(p,n),this.addCurrentVertex(n,v,0,0,d),p=n}}}}ensureDataCapacity(t,n,e,r){const i="round"===t?Math.round(e/20)-1:0;super.ensureDataCapacity((6+i)*r,n)}addCurrentVertex(t,n,e,r,i,s=!1){const o=n.x+n.y*e,a=n.y-n.x*e,u=-n.x+n.y*r,l=-n.y-n.x*r;let h=0,c=0;if(i.middleVertex){tu.x=o,tu.y=a;const t=i.currentNormal;if(h=lu(t,tu,i.dir),0===e&&0===r)c=-h;else{const n=nu;n.x=t.x,n.y=t.y,n.S(-1),eu.x=u,eu.y=l,c=lu(n,eu,i.dir)}}this.addHalfVertex(t,o,a,s,!1,e,i,h),this.addHalfVertex(t,u,l,s,!0,-r,i,c),this.prevVertex&&hu(t,this.prevVertex)||(this.prevVertex=t),this.distance>Qa/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,n,e,r,i,s))}addHalfVertex({x:t,y:n,z:e},r,i,s,o,a,u,l){const h=1*this.scaledDistance;this.fillData(this.data,t,n,e||0,r,i,s,o,h,l);const c=u.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,c),u.primitiveLength++),o?this.e2=c:this.e1=c}fillData(t,n,e,r,i,s,o,a,u,l){const{lineWidthFn:h,lineStrokeWidthFn:c,lineStrokeColorFn:f,lineColorFn:d,lineOpacityFn:p,lineDxFn:y,lineDyFn:m,linePatternAnimSpeedFn:g,linePatternGapFn:v}=this.it;this.fillPosition(t,n,e,r);let b=Ka*i;b=(Math.sign(b)||1)*((Math.floor(Math.abs(b))>>1<<1)+ +o);let w=Ka*s;w=(Math.sign(w)||1)*((Math.floor(Math.abs(w))>>1<<1)+ +a);let M=t.aExtrude.currentIndex;t.aExtrude[M++]=b,t.aExtrude[M++]=w,(this.iconAtlas||this.hasDasharray)&&(t.aExtrude[M++]=Ka*l),t.aExtrude.currentIndex=M,M=t.aLinesofar.currentIndex,t.aLinesofar[M++]=u,t.aLinesofar.currentIndex=M,h&&(M=t.aLineWidth.currentIndex,t.aLineWidth[M++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=M),c&&(M=t.aLineStrokeWidth.currentIndex,t.aLineStrokeWidth[M++]=Math.round(2*this.feaLineStrokeWidth),t.aLineStrokeWidth.currentIndex=M),d&&(M=t.aColor.currentIndex,t.aColor[M++]=this.feaColor[0],t.aColor[M++]=this.feaColor[1],t.aColor[M++]=this.feaColor[2],t.aColor[M++]=this.feaColor[3],t.aColor.currentIndex=M),f&&(M=t.aStrokeColor.currentIndex,t.aStrokeColor[M++]=this.feaStrokeColor[0],t.aStrokeColor[M++]=this.feaStrokeColor[1],t.aStrokeColor[M++]=this.feaStrokeColor[2],t.aStrokeColor[M++]=this.feaStrokeColor[3],t.aStrokeColor.currentIndex=M),p&&(M=t.aOpacity.currentIndex,t.aOpacity[M++]=this.feaOpacity,t.aOpacity.currentIndex=M),this.dasharrayFn&&(M=t.aDasharray.currentIndex,t.aDasharray[M++]=this.feaDash[0],t.aDasharray[M++]=this.feaDash[1],t.aDasharray[M++]=this.feaDash[2],t.aDasharray[M++]=this.feaDash[3],t.aDasharray.currentIndex=M),this.dashColorFn&&(M=t.aDashColor.currentIndex,t.aDashColor[M++]=this.feaDashColor[0],t.aDashColor[M++]=this.feaDashColor[1],t.aDashColor[M++]=this.feaDashColor[2],t.aDashColor[M++]=this.feaDashColor[3],t.aDashColor.currentIndex=M),this.iconAtlas&&(M=t.aTexInfo.currentIndex,t.aTexInfo[M++]=this.feaTexInfo[0],t.aTexInfo[M++]=this.feaTexInfo[1],t.aTexInfo[M++]=this.feaTexInfo[2],t.aTexInfo[M++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=M),(y||m)&&(M=t.aLineDxDy.currentIndex,t.aLineDxDy[M++]=this.feaLineDx||0,t.aLineDxDy[M++]=this.feaLineDy||0,t.aLineDxDy.currentIndex=M),(g||v)&&(M=t.aLinePattern.currentIndex,t.aLinePattern[M++]=127*(this.feaPatternAnimSpeed||0),t.aLinePattern[M++]=10*(this.feaLinePatternGap||0),t.aLinePattern.currentIndex=M),this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}addElements(t,n,e){super.addElements(this.offset+t,this.offset+n,this.offset+e)}Dt(t){const n=this.options.EXTENT,e=this.elements;for(let r=0;r<e.length;r+=3)if(n===1/0||!su(this.data.aPosition,e[r],e[r+1],3,n)&&!su(this.data.aPosition,e[r+1],e[r+2],3,n)){let n=t.currentIndex;t[n++]=e[r],t[n++]=e[r+1],t[n++]=e[r+2],t.currentIndex=n}}Tt(t){if(t.length<=1)return t;const n=[],e=this.options.EXTENT;let r,i=!0;for(r=0;r<t.length-1;r++){const s=iu(t[r],t[r+1],e);s&&i||(n.push(t[r]),i=s)}return i||n.push(t[r]),n}updateDistance(t,n){if(this.options.isTube){const e=t.dist(n),r=function(t){const{verticalCentimeterToPoint:n,tileRatio:e}=t;return n*e}(this.options)*(n.z-t.z);this.distance+=Math.sqrt(e*e+r*r)}else this.distance+=t.dist(n);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(Qa-1):this.distance}}function iu(t,n,e){return e!==1/0&&(t.x<0&&n.x<0||t.x>e&&n.x>e||t.y<0&&n.y<0||t.y>e&&n.y>e)}function su(t,n,e,r,i){if(i===1/0)return!1;const s=Math.floor(.5*t[n*r]),o=Math.floor(.5*t[n*r+1]),a=Math.floor(.5*t[e*r]),u=Math.floor(.5*t[e*r+1]);return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function ou(t){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(t[n])return!0;return!1}const au=[],uu=[];function lu(t,n,e){const r=t.mag(),i=n.mag();wt(au,e.x,e.y),wt(uu,n.x,n.y);const s=(a=uu,(o=au)[0]*a[0]+o[1]*a[1]);var o,a;return-Math.sign(s)*Math.sqrt(i*i-r*r)}function hu(t,n){return t.equals(n)&&t.z===n.z}var cu="undefined"!=typeof Float32Array?Float32Array:Array;function fu(){var t=new cu(3);return cu!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function du(t,n,e){var r=new cu(3);return r[0]=t,r[1]=n,r[2]=e,r}function pu(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function yu(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t}function mu(t,n,e){return t[0]=n[0]+e[0],t[1]=n[1]+e[1],t[2]=n[2]+e[2],t}function gu(t,n){var e=n[0],r=n[1],i=n[2],s=e*e+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=n[0]*s,t[1]=n[1]*s,t[2]=n[2]*s),t}function vu(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function bu(t,n,e){var r=n[0],i=n[1],s=n[2],o=e[0],a=e[1],u=e[2];return t[0]=i*u-s*a,t[1]=s*o-r*u,t[2]=r*a-i*o,t}var wu=function(t,n,e){return t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t};function Mu(){var t=new cu(4);return cu!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function xu(t,n){var e=n[0]+n[4]+n[8],r=void 0;if(e>0)r=Math.sqrt(e+1),t[3]=.5*r,r=.5/r,t[0]=(n[5]-n[7])*r,t[1]=(n[6]-n[2])*r,t[2]=(n[1]-n[3])*r;else{var i=0;n[4]>n[0]&&(i=1),n[8]>n[3*i+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(n[3*i+i]-n[3*s+s]-n[3*o+o]+1),t[i]=.5*r,r=.5/r,t[3]=(n[3*s+o]-n[3*o+s])*r,t[s]=(n[3*s+i]+n[3*i+s])*r,t[o]=(n[3*o+i]+n[3*i+o])*r}return t}!function(){var t=fu()}(),function(){var t,n=(t=new cu(4),cu!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var Fu,ku=function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t},Au=function(t,n){var e=n[0],r=n[1],i=n[2],s=n[3],o=e*e+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),t[0]=e*o,t[1]=r*o,t[2]=i*o,t[3]=s*o),t};fu(),du(1,0,0),du(0,1,0),Mu(),Mu(),Fu=new cu(9),cu!=Float32Array&&(Fu[1]=0,Fu[2]=0,Fu[3]=0,Fu[5]=0,Fu[6]=0,Fu[7]=0),Fu[0]=1,Fu[4]=1,Fu[8]=1;\n/*!\n     * Contains code from google filament\n     * https://github.com/google/filament/\n     * License Apache-2.0\n     */\nconst Pu=8,Su=[],_u=[],Ou=[],Cu=[];function Eu(t,n,e){const r=bu(_u,n,e),i=function(t,n,e,r,i,s,o,a,u,l){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=u,t[8]=l,t}(Su,e[0],e[1],e[2],...r,...n);t=xu(t,i),t=function(t){return t[3]<0?ku(t,t,-1):t}(t=Au(t,t));const s=1/((1<<2*Pu-1)-1);if(t[3]<s){t[3]=s;const n=Math.sqrt(1-s*s);t[0]*=n,t[1]*=n,t[2]*=n}const o=e[3]>0?bu(Ou,e,n):bu(Ou,n,e);return vu(bu(Cu,e,n),o)<0&&ku(t,t,-1),t}const $u=[];function Iu(t,n,e){const r=e||[];r.setLength&&r.setLength(t.length);const i=$u;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const s=void 0===n.length?n:n.length;for(let e=0;e<s/3;e++)void 0===n.length?Hu(t,3*e,3*e+1,3*e+2,r,i):Hu(t,n[3*e],n[3*e+1],n[3*e+2],r,i);const o=r.getLength?r.getLength():r.length;for(let t=0;t<o;t+=3){const n=i[t/3];0!==n?(r[t]/=n,r[t+1]/=n,r[t+2]/=n):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}const zu=[],Du=[],Tu=[],Uu=[],ju=[],Nu=[],Lu=[];function Hu(t,n,e,r,i,s){yu(Uu,t[3*n],t[3*n+1],t[3*n+2]),yu(ju,t[3*e],t[3*e+1],t[3*e+2]),yu(Nu,t[3*r],t[3*r+1],t[3*r+2]);const o=wu(zu,Nu,ju),a=wu(Du,Uu,ju),u=bu(Tu,o,a);gu(Lu,u),i[3*n]=i[3*n]||0,i[3*e]=i[3*e]||0,i[3*r]=i[3*r]||0,i[3*n+1]=i[3*n+1]||0,i[3*e+1]=i[3*e+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*n+2]=i[3*n+2]||0,i[3*e+2]=i[3*e+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*n]+=Lu[0],i[3*e]+=Lu[0],i[3*r]+=Lu[0],i[3*n+1]+=Lu[1],i[3*e+1]+=Lu[1],i[3*r+1]+=Lu[1],i[3*n+2]+=Lu[2],i[3*e+2]+=Lu[2],i[3*r+2]+=Lu[2],s[n]+=1,s[e]+=1,s[r]+=1}\n/*!\n     * Contains code from THREE.JS\n     * https://github.com/mrdoob/three.js/\n     * License MIT\n     *\n     * Generate tangents per vertex.\n     */function Ru(t,n,e){return t[0]=n[e],t[1]=n[e+1],t[2]=n[e+2],t}function Vu(t,n,e){return t[0]=n[e],t[1]=n[e+1],t}class qu extends ru{constructor(t,n,e){super(t,n,e),this.Ut=e.altitudeProperty}getFormat(){const{lineColorFn:t,lineWidthFn:n}=this.it,e=[{type:this.maxPosZ>=Math.pow(2,15)?Float32Array:Int16Array,width:3,name:"aPosition"},{type:Uint16Array,width:1,name:"aLinesofar"},{type:Uint8Array,width:1,name:"aUp"},{type:Int16Array,width:3,name:"aExtrudedPosition"},{type:Int8Array,width:2,name:"aExtrude"}];return t&&e.push({type:Uint8Array,width:4,name:"aColor"}),n&&e.push({type:Uint8Array,width:1,name:"aLineWidth"}),this.Ut&&e.push({type:Float32Array,width:1,name:"aLineHeight"}),e}placeVector(t){const n=t.feature;if(this.Ut){const{altitudeScale:t,altitudeProperty:e,defaultAltitude:r,heightProperty:i,defaultHeight:s,minHeightProperty:o}=this.options,{altitude:a,height:u}=_n(n,t,e,r,i,s,o);this.feaAltitude=a,this.feaMinHeight=(a-u)/a*32767,a>this.maxAltitude&&(this.maxAltitude=a)}return super.placeVector(t)}needAltitudeAttribute(){return!1}It(t,n,e,r,i,s){const o=this.data.aPosition.getLength()/3;super.It(t,n,e,r,i,s);const a=this.data.aPosition.getLength()/3,u=this.data.aPosition.getLength()/3-this.offset,l=3===n.type,h=!1!==this.options.side;if(!l&&u>0&&h){const t=!1!==this.options.top?1:0,n=t+4;let e=this.data.aPosition.getLength()/3;for(const t in this.data){const n=this.data[t],r=n.getLength()/e;let i=n.currentIndex;for(let t=0;t<r;t++)n[i++]=n[o*r+3*r+t];n.currentIndex=i}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[o*i+i*n+t];r.currentIndex=s}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[o*i+i*(n+3)+t];r.currentIndex=s}super.addElements(t+1,u+1,u),super.addElements(u,u+1,u+2);const r=this.data.aPosition.getLength()/3-this.offset;e=this.data.aPosition.getLength()/3;for(const t in this.data){const n=this.data[t],r=n.getLength()/e;let i=n.currentIndex;for(let t=0;t<r;t++)n[i++]=n[a*r-r+t];n.currentIndex=i}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[a*i-n*i-i+t];r.currentIndex=s}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[a*i-n*i-3*i+t];r.currentIndex=s}super.addElements(r,u-3,r+1),super.addElements(u-3,r+2,r+1)}}fillData(t,n,e,r,i,s,o,a,u){const l=!1!==this.options.top,h=!1!==this.options.side,c=this.options.EXTENT/this.options.tileSize,f=this.feaLineWidth||this.symbol.lineWidth/2*c,d=Ka*i,p=Ka*s,y=f*i+n,m=f*s+e;this.jt(t,n,e,i,s,o,a,u,y,m,d,p),h&&(l&&this.jt(t,n,e,i,s,o,a,u,y,m,d,p),this.jt(t,n,e,i,s,o,a,u,y,m,d,p),this.Nt(t,n,e,i,s,o,a,u,y,m,d,p),this.Nt(t,n,e,i,s,o,a,u,y,m,d,p)),this.maxPos=Math.max(this.maxPos,Math.abs(n),Math.abs(e))}jt(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.it;let p=t.aPosition.currentIndex;t.aPosition[p++]=n,t.aPosition[p++]=e,t.aPosition[p++]=32767,t.aPosition.currentIndex=p,p=t.aLinesofar.currentIndex,t.aLinesofar[p++]=a,t.aLinesofar.currentIndex=p,p=t.aUp.currentIndex,t.aUp[p++]=+o,t.aUp.currentIndex=p,p=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[p++]=u,t.aExtrudedPosition[p++]=l,t.aExtrudedPosition[p++]=1,t.aExtrudedPosition.currentIndex=p,p=t.aExtrude.currentIndex,t.aExtrude[p++]=h,t.aExtrude[p++]=c,t.aExtrude.push(h,c),f&&(p=t.aColor.currentIndex,t.aColor[p++]=this.feaColor[0],t.aColor[p++]=this.feaColor[1],t.aColor[p++]=this.feaColor[2],t.aColor[p++]=this.feaColor[3],t.aColor.currentIndex=p),d&&(p=t.aLineWidth.currentIndex,t.aLineWidth[p++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=p),this.Ut&&(p=t.aLineHeight.currentIndex,t.aLineHeight[p++]=this.feaAltitude,t.aLineHeight.currentIndex=p)}Nt(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.it;let p=t.aPosition.currentIndex;t.aPosition[p++]=n,t.aPosition[p++]=e,t.aPosition[p++]=this.feaMinHeight||0,t.aPosition.currentIndex=p,p=t.aLinesofar.currentIndex,t.aLinesofar[p++]=a,t.aLinesofar.currentIndex=p,p=t.aUp.currentIndex,t.aUp[p++]=+o,t.aUp.currentIndex=p,p=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[p++]=u,t.aExtrudedPosition[p++]=l,t.aExtrudedPosition[p++]=1,t.aExtrudedPosition.currentIndex=p,p=t.aExtrude.currentIndex,t.aExtrude[p++]=h,t.aExtrude[p++]=c,t.aExtrude.push(h,c),f&&(p=t.aColor.currentIndex,t.aColor[p++]=this.feaColor[0],t.aColor[p++]=this.feaColor[1],t.aColor[p++]=this.feaColor[2],t.aColor[p++]=this.feaColor[3],t.aColor.currentIndex=p),d&&(p=t.aLineWidth.currentIndex,t.aLineWidth[p++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=p),this.Ut&&(p=t.aLineHeight.currentIndex,t.aLineHeight[p++]=this.feaAltitude,t.aLineHeight.currentIndex=p)}addElements(t,n,e){const r=!1!==this.options.top,i=!1!==this.options.side,s=(r?1:0)+(i?4:0),o=this.offset;t*=s,n*=s,e*=s;if(this.data.aUp[o+e+4]){if(r&&super.addElements(n,t,e),i){const t=r?1:0;super.addElements(n+t,e+t,e+t+2),super.addElements(n+t+1,e+t+1+2,n+t+1+2)}}else if(r&&super.addElements(t,e,n),i){const n=r?1:0;super.addElements(t+n,t+n+2,e+n),super.addElements(t+n+1+2,e+n+1+2,e+n+1)}}createDataPack(t,n){this.maxAltitude=0;const e=super.createDataPack(t,n);if(!e)return e;const{data:r,indices:i}=e;this.getFormat().reduce(((t,n)=>(t[n.name]={size:n.width},t)),{}).aPickingId={size:1};const{aExtrudedPosition:s,aPosition:o,aLinesofar:a,aUp:u,aExtrude:l,aColor:h,aLineHeight:c,aLineWidth:f}=r,d={},p=Iu(s,i);let y,m=!0;for(let t=0;t<p.length;t++)p[t]=-p[t],p[t]%1!=0&&(m=!1);if(!1!==this.options.top&&this.symbol.material&&function(t){for(const n in t)if(n.indexOf("Texture")>=0&&t[n])return!0;return!1}(this.symbol.material)&&(y=function(t,n,e){const r=256,i=[];for(let s=0;s<t.length;s+=3){const t=n[s/3];e[s/3]?i.push(t/r,1):i.push(t/r,0)}return i}(s,a,u)),d.aPosition=o,y&&(d.aTexCoord0=new Float32Array(y)),d.aNormal=m?new Int8Array(p):new Float32Array(p),d.aPickingId=r.aPickingId,d.aExtrude=l,h&&(d.aColor=h),f&&(d.aLineWidth=f),c){const t=Nn(this.maxAltitude);d.aLineHeight=new t(c)}const g=[];for(const t in d)g.push(d[t].buffer);return e.data=d,e.buffers=g,e}}const Gu=Math.pow(2,16)/1;class Ju extends Go{getFormat(){return[...this.getPositionFormat()]}placeVector(t){const n=t.feature,e=3===n.type,r=n.geometry,i=this.elements;e&&(this.elements=this.ft.get());const s=this.needAltitudeAttribute()?2:3;for(let t=0;t<r.length;t++)this.offset=this.data.aPosition.getLength()/s,this.It(r[t],n),e&&(this.Dt(i),this.elements=this.ft.get());e&&(this.elements=i)}It(t,n){const e=3===n.type;let r=t.length;for(;r>=2&&t[r-1].equals(t[r-2]);)r--;let i,s,o,a=0;for(;a<r-1&&t[a].equals(t[a+1]);)a++;if(!(r<(e?3:2))){this.distance=0,this.vertexLength=0,this.primitiveLength=0,this.e1=this.e2=this.e3=-1,e&&(i=t[r-2]);for(let n=a;n<r;n++)o=e&&n===r-1?t[a+1]:t[n+1],o&&t[n].equals(o)||(i&&(s=i),i=t[n],s&&(this.distance+=i.dist(s)),this.addCurrentVertex(i,this.distance))}}addCurrentVertex(t,n){const e=this.vertexLength++;this.addLineVertex(this.data,t,n),e>=1&&this.addElements(e-1,e),n>Gu&&(this.distance=0,this.addCurrentVertex(t,this.distance))}addLineVertex(t,n){this.fillPosition(t,n.x,n.y,n.z||0),this.maxPos=Math.max(this.maxPos,Math.abs(n.x),Math.abs(n.y))}addElements(t,n){this.maxIndex=Math.max(this.maxIndex,this.offset+t,this.offset+n);let e=this.elements.currentIndex;this.elements[e++]=this.offset+t,this.elements[e++]=this.offset+n,this.elements.currentIndex=e}Dt(t){const n=this.options.EXTENT,e=this.elements,r=e.getLength();for(let i=0;i<r;i+=2)if(!Pn(this.data.aPosition,e[i],e[i+1],3,n)){let n=t.currentIndex;t[n++]=e[i],t[n++]=e[i+1],t.currentIndex=n}}}const Wu=45*Math.PI/100;class Bu extends Go{getFormat(){const{markerFillFn:t}=this.it;let n;return n="line"===this.symbol.markerRotationAlignment?[...this.getPositionFormat(),{type:Float32Array,width:1,name:"aXYRotation"},{type:Float32Array,width:1,name:"aZRotation"}]:[...this.getPositionFormat()],t&&n.push({type:Uint8Array,width:4,name:"aColor"}),n}placeVector(t){const n=t.feature.properties,{markerFillFn:e}=this.it;let r;e&&(r=e(this.options.zoom,n)||[255,255,255,255],g(r)?(this.dynamicAttrs.aColor=1,r=[0,0,0,0]):r=He([],r));const i=this.data,s=this.symbol.markerSpacing||250,o=this.symbol.markerPlacement||"point",a="line"===this.symbol.markerRotationAlignment,u=this._t(t,s,o,a);for(let t=0;t<u.length;t++){const n=u[t];if(this.fillPosition(this.data,n.x,n.y,n.z),a){let t=i.aXYRotation.currentIndex;i.aXYRotation[t++]=n.xyRotation||0,i.aXYRotation.currentIndex=t,t=i.aZRotation.currentIndex,i.aZRotation[t++]=n.zRotation||0,i.aZRotation.currentIndex=t}if(r){let t=i.aColor.currentIndex;i.aColor[t++]=r[0],i.aColor[t++]=r[1],i.aColor[t++]=r[2],i.aColor[t++]=r[3],i.aColor.currentIndex=t}const e=Math.max(Math.abs(n.x),Math.abs(n.y));e>this.maxPos&&(this.maxPos=e)}}_t(t,n,e,r){const i=t.feature,s=this.options.EXTENT;if("line"===e){const t=[];let e=i.geometry;s&&(e=Pa(i.geometry,0,0,s,s));for(let r=0;r<e.length;r++){const i=Oa(e[r],n,Wu,null,0,24,1,1,s||1/0);t.push.apply(t,i)}return t}return Va(i,e,s,r,this.options.altitudeToTileScale)}hasElements(){return!1}}\n/*!\n     * from @turf/bboxClip\n     * https://github.com/Turfjs/turf\n     * MIT LICENSE\n     */const Xu=[],Yu=[];function Ku(t,n){var e,r,i,s,o,a,u;for(r=1;r<=8;r*=2){for(e=[],s=!(Qu(i=t[t.length-1],n)&r),o=0;o<t.length;o++){if((u=!(Qu(a=t[o],n)&r))!==s){const t=Zu(i,a,r,n);void 0!==a.x?e.push(new ln(t[0],t[1])):e.push(t)}u&&e.push(a),i=a,s=u}if(!(t=e).length)break}return e}function Zu(t,n,e,r){return Xu[0]=void 0===t.x?t[0]:t.x,Xu[1]=void 0===t.y?t[1]:t.y,t=Xu,Yu[0]=void 0===n.x?n[0]:n.x,Yu[1]=void 0===n.y?n[1]:n.y,n=Yu,8&e?[t[0]+(n[0]-t[0])*(r[3]-t[1])/(n[1]-t[1]),r[3]]:4&e?[t[0]+(n[0]-t[0])*(r[1]-t[1])/(n[1]-t[1]),r[1]]:2&e?[r[2],t[1]+(n[1]-t[1])*(r[2]-t[0])/(n[0]-t[0])]:1&e?[r[0],t[1]+(n[1]-t[1])*(r[0]-t[0])/(n[0]-t[0])]:null}function Qu(t,n){Xu[0]=void 0===t.x?t[0]:t.x,Xu[1]=void 0===t.y?t[1]:t.y;var e=0;return(t=Xu)[0]<n[0]?e|=1:t[0]>n[2]&&(e|=2),t[1]<n[1]?e|=4:t[1]>n[3]&&(e|=8),e}const tl=[0,0,0,0],nl=-9999999;class el extends Go{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,n,e,r,i){const s=new qe(t,n,e,r),o=s.getPolygonResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:n,polygonOpacityFn:e,uvScaleFn:r,uvOffsetFn:i,polygonPatternUVFn:s}=this.it;if(this.iconAtlas){const n=this.getIconAtlasMaxValue();t.push({type:n>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return n&&t.push({type:Uint8Array,width:4,name:"aColor"}),e&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),i&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,n){const e=t.feature,r=e.geometry;this.Lt(r,e,n)}Lt(t,n){let e,r,i,s;const{polygonFillFn:o,polygonOpacityFn:a,uvScaleFn:u,uvOffsetFn:l,uvOffsetInMeterFn:h,polygonPatternUVFn:c}=this.it,f=n.properties;o&&(e=o(this.options.zoom,f)||gt([],255,255,255,255),g(e)?(this.dynamicAttrs.aColor=1,e=tl):e=He([],e)),a&&(r=a(this.options.zoom,f),g(r)?(this.dynamicAttrs.aOpacity=1,r=255):(Ie(r)&&(r=1),r*=255)),u&&(i=u(this.options.zoom,f),g(i)?(i=[255,255],this.dynamicAttrs.aUVScale=1):(Ie(i)&&(i=[1,1]),i=[255*i[0],255*i[1]])),l&&(h&&h(null,f)?s=[0,0]:(s=l(this.options.zoom,f),g(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(Ie(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const d=!!this.iconAtlas,p=za(t,500),y=[0,0],m=[0,0];if(d){const{polygonPatternFileFn:t}=this.it,n=t?t(null,f):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[n]){const t=this.iconAtlas.positions[n],e=!In(t.displaySize[0])||!In(t.displaySize[1]);y[0]=t.tl[0]+(e?1:0),y[1]=t.tl[1]+(e?1:0),m[0]=t.displaySize[0]-1-(e?2:0),m[1]=t.displaySize[1]-1-(e?2:0)}}let v,b=0;c&&(v=c(this.options.zoom,f));const w=this.needAltitudeAttribute()?2:3,M=[-1,-1,n.extent+1,n.extent+1],x=this.Ht=this.Ht||this.ft.getProxy(),F=this.Rt=this.Rt||this.ft.getProxy();for(let t=0;t<p.length;t++){const n=p[t],o=this.data.aPosition.getLength()/w;x.setLength(0),F.setLength(0);for(let t=0;t<n.length;t++){let o=n[t];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&(o=Ku(o,M)),0===o.length)continue;0!==t&&F.push(x.length/3),this.ensureDataCapacity(o.length);const a=this.data;for(let t=0;t<o.length;t++){const n=o[t].x,u=o[t].y,l=o[t].z||0;if(this.fillPosition(this.data,n,u,l),d){let t=a.aTexInfo.currentIndex;a.aTexInfo[t++]=y[0],a.aTexInfo[t++]=y[1],a.aTexInfo[t++]=m[0],a.aTexInfo[t++]=m[1],a.aTexInfo.currentIndex=t}if(void 0!==e){let t=a.aColor.currentIndex;a.aColor[t++]=e[0],a.aColor[t++]=e[1],a.aColor[t++]=e[2],a.aColor[t++]=e[3],a.aColor.currentIndex=t}if(void 0!==r){let t=a.aOpacity.currentIndex;a.aOpacity[t++]=r,a.aOpacity.currentIndex=t}if(void 0!==i){let t=a.aUVScale.currentIndex;a.aUVScale[t++]=i[0],a.aUVScale[t++]=i[1],a.aUVScale.currentIndex=t}if(void 0!==s){let t=a.aUVOffset.currentIndex;a.aUVOffset[t++]=s[0],a.aUVOffset[t++]=s[1],a.aUVOffset.currentIndex=t}if(c){let t=a.aTexCoord.currentIndex;if(v){const n=Ie(v[2*b])?v[0]:v[2*b],e=Ie(v[2*b]+1)?v[1]:v[2*b+1];a.aTexCoord[t++]=n,a.aTexCoord[t++]=e}else a.aTexCoord[t++]=nl,a.aTexCoord[t++]=nl;a.aTexCoord.currentIndex=t,b++}const h=Math.abs(n),f=Math.abs(u);h>this.maxPos&&(this.maxPos=h),f>this.maxPos&&(this.maxPos=f),x.push(n,u,l)}}let a=on(x,F,3);if(x.length&&!a.length){const t=[];for(let n=0;n<x.length;n+=3)t[n]=x[n],t[n+1]=x[n+2],t[n+2]=x[n+1];if(a=on(t,F,3),!a.length){for(let n=0;n<x.length;n+=3)t[n]=x[n+1],t[n+1]=x[n+2],t[n+2]=x[n];a=on(t,F,3)}}for(let t=0;t<a.length;t+=3)this.addElements(o+a[t],o+a[t+1],o+a[t+2])}}ensureDataCapacity(t){super.ensureDataCapacity(1,t)}}const rl=[{type:Int16Array,width:3,name:"aPosition"}];class il extends Go{getFormat(){return rl}placeVector(t,n){const e=this._t(t,n);if(0===e.length)return;const r=this.data,i=this.getAltitude(t.feature.properties);let s=r.aPosition.getLength()/rl[0].width;for(let t=0;t<e.length;t++){const n=e[t];r.aPosition.push(2*n.x+0,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+1,i),r.aPosition.push(2*n.x+0,2*n.y+1,i),this.addElements(s,s+1,s+2),this.addElements(s,s+2,s+3),s+=4;const o=Math.max(Math.abs(2*n.x+1),Math.abs(2*n.y+1));o>this.maxPos&&(this.maxPos=o)}}_t(t,n){const{feature:e,symbol:r}=t,i=this.$t(t,r),s=e.properties,{markerSpacingFn:o}=this.it,a=((o?o(null,s):r.markerSpacing)||250)*n;return Ra(t,null,null,n,this.options.EXTENT,i,a)}$t(t,n){return this.it.markerPlacementFn?this.it.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement}}class sl extends ru{constructor(t,n,e){(n=$e({},n)).lineJoin="miter",n.lineCap="butt",super(t,n,e),this.options.radialSegments%2==1&&this.options.radialSegments--}getFormat(){const{lineWidthFn:t,lineColorFn:n,lineOpacityFn:e,linePatternAnimSpeedFn:r,linePatternGapFn:i}=this.it,s=[...this.getPositionFormat(),{type:Int8Array,width:4,name:"aTubeNormal"},{type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}];if(this.iconAtlas){s.push({type:Int8Array,width:1,name:"aNormalDistance"});const t=this.getIconAtlasMaxValue();s.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return t&&s.push({type:Uint16Array,width:1,name:"aLineWidth"}),n&&s.push({type:Uint8Array,width:4,name:"aColor"}),e&&s.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&s.push({type:Int8Array,width:1,name:"aLinePatternAnimSpeed"}),i&&s.push({type:Int8Array,width:1,name:"aLinePatternGap"}),s}ensureDataCapacity(t,n,e,r){const i=this.options.radialSegments/2;return super.ensureDataCapacity(t,n,e,r*i)}addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,f=this.options.radialSegments/2,{x:d,y:p,z:y}=o.dir,m=function(t,n,e,r,i,s,o,a){dt(ol,e,r,i),dt(al,s,o,0),yt(ul,ol,al),pt(al,al),pt(ul,ul),ll[n]||(ll[n]=[]);const u=ll[n];for(var l=0;l<n;l++){const e=Math.PI*l/n,r=0,i=1-Math.abs(e-r)/(Math.PI/2);u[l]=u[l]||[],hl(al,ul,u[l],t,e,i*(a?-1:1))}return u}(1,f,d,p,y,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,m,i,c,a)}fillTubeElements(t){const n=this.options.radialSegments/2,e=this.needAltitudeAttribute()?2:3,r=this.data.aPosition.getLength()/e;for(let e=0;e<n;e++){const i=e+r,s=e+r-2*n;let o,a;e===n-1&&t?(o=e+r-2*n+1,a=e+r-2*n-2*n+1):(o=e+r+1,a=e+r+1-2*n),super.addElements(i-this.offset,o-this.offset,s-this.offset),super.addElements(s-this.offset,o-this.offset,a-this.offset)}}fillData(t,n,e,r,i,s,o,a){const{lineWidthFn:u,lineColorFn:l,lineOpacityFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.it,d=i.length;for(let s=0;s<d;s++){this.fillPosition(t,n,e,r),bt(i[s],i[s],Ka);let d=t.aTubeNormal.currentIndex;for(let n=0;n<i[s].length;n++)t.aTubeNormal[d++]=i[s][n];if(t.aTubeNormal.currentIndex=d,d=t.aLinesofar.currentIndex,t.aLinesofar[d++]=o,t.aLinesofar.currentIndex=d,this.iconAtlas&&(d=t.aNormalDistance.currentIndex,t.aNormalDistance[d++]=Ka*a,t.aNormalDistance.currentIndex=d,d=t.aTexInfo.currentIndex,t.aTexInfo[d++]=this.feaTexInfo[0],t.aTexInfo[d++]=this.feaTexInfo[1],t.aTexInfo[d++]=this.feaTexInfo[2],t.aTexInfo[d++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=d),u){const n="centimeter"===(p=this.options.metric)||"cm"===p?1:"millimeter"===p||"mm"===p?.1:100;let e=this.feaLineWidth*n;isNaN(e)&&(e=0),d=t.aLineWidth.currentIndex,t.aLineWidth[d++]=Math.round(e),t.aLineWidth.currentIndex=d}l&&(d=t.aColor.currentIndex,t.aColor[d++]=this.feaColor[0],t.aColor[d++]=this.feaColor[1],t.aColor[d++]=this.feaColor[2],t.aColor[d++]=this.feaColor[3],t.aColor.currentIndex=d),h&&(d=t.aOpacity.currentIndex,t.aOpacity[d++]=this.feaOpacity,t.aOpacity.currentIndex=d),c&&(d=t.aLinePatternAnimSpeed.currentIndex,t.aLinePatternAnimSpeed[d++]=127*(this.feaPatternAnimSpeed||0),t.aLinePatternAnimSpeed.currentIndex=d),f&&(d=t.aLinePatternGap.currentIndex,t.aLinePatternGap[d++]=10*(this.feaLinePatternGap||0),t.aLinePatternGap.currentIndex=d)}var p;this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}createDataPack(t,n){const e=super.createDataPack(t,n);return e&&(e.is2D=!1),e}}const ol=[],al=[],ul=[],ll={};function hl(t,n,e,r,i,s){return gt(e,r*(Math.cos(i)*t[0]+Math.sin(i)*n[0]),r*(Math.cos(i)*t[1]+Math.sin(i)*n[1]),r*(Math.cos(i)*t[2]+Math.sin(i)*n[2]),s),e}class cl extends sl{addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,{x:f,y:d,z:p}=o.dir,y=gl(this.feaLineWidth,this.feaLineHeight,f,d,p,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,y,i,c,a)}ensureDataCapacity(t,n,e,r){return super.ensureDataCapacity(t,n,e,2*r)}}const fl=[],dl=[],pl=[],yl=[],ml=[];function gl(t,n,e,r,i,s,o,a){dt(dl,e,r,i),dt(pl,s,o,0),yt(yl,dl,pl),pt(pl,pl),pt(yl,yl),wt(fl,t,n);const u=xt(fl)/t,l=Math.atan(n/t);let h=Math.PI/2+(Math.PI/2-l);return ml[0]||(ml[0]=[]),hl(pl,yl,ml[0],u,h,a?1:-1),h+=2*l,ml[1]||(ml[1]=[]),hl(pl,yl,ml[1],u,h,a?1:-1),ml}class vl{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,n){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=n,this.order.push(t)):(this.data[t]=n,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const n=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),n}get(t){if(!this.has(t))return null;return this.data[t]}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}\n/*!\n     * based on @mapbox/tiny-sdf\n     * https://github.com/mapbox/tiny-sdf\n     * @License BSD 2-Clause\n     */var bl=1e20;function wl(t,n,e,r,i,s,o){this.fontSize=t||24,this.buffer=void 0===n?3:n,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=s||"normal",this.fontStyle=o||"normal",this.radius=e||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function Ml(t,n,e,r,i,s){for(var o=0;o<n;o++)xl(t,o,n,e,r,i,s);for(var a=0;a<e;a++)xl(t,a*n,1,n,r,i,s)}function xl(t,n,e,r,i,s,o){var a,u,l,h;for(s[0]=0,o[0]=-bl,o[1]=bl,a=0;a<r;a++)i[a]=t[n+a*e];for(a=1,u=0,l=0;a<r;a++){do{h=s[u],l=(i[a]-i[h]+a*a-h*h)/(a-h)/2}while(l<=o[u]&&--u>-1);s[++u]=a,o[u]=l,o[u+1]=bl}for(a=0,u=0;a<r;a++){for(;o[u+1]<a;)u++;h=s[u],t[n+a*e]=i[h]+(a-h)*(a-h)}}wl.prototype.draw=function(t,n,e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var r=this.ctx.getImageData(0,0,n,e),i=new Uint8ClampedArray(n*e),s=0;s<n*e;s++){var o=r.data[4*s+3]/255;this.gridOuter[s]=1===o?0:0===o?bl:Math.pow(Math.max(0,.5-o),2),this.gridInner[s]=1===o?bl:0===o?0:Math.pow(Math.max(0,o-.5),2)}for(Ml(this.gridOuter,n,e,this.f,this.v,this.z),Ml(this.gridInner,n,e,this.f,this.v,this.z),s=0;s<n*e;s++){var a=Math.sqrt(this.gridOuter[s])-Math.sqrt(this.gridInner[s]);i[s]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let Fl=0;class kl{constructor(t,n=15,e,r){this.entries={},this.Vt={},this.qt=new vl(2048,(function(){})),this.Gt=t,this.Jt=n,this.Wt=e,this.Bt=r}Xt(t){return t&&t.indexOf("{stack}")>=0&&t.indexOf("{range}")>0}getGlyphs(t,n){if(!t||!Object.keys(t).length)return void n(null,{glyphs:null});if(this.Xt(this.Bt))return void this.Yt(t,n);const e=this.entries,r=t.options;let i=!0;r&&(i=!1!==r.isCharsCompact),i=i||this.Wt;const s=(r,s,a)=>{let u=0,l=0;for(const n in t)if("options"!==n){e[n]=e[n]||{},s[n]=s[n]||{};for(const h in t[n]){if(l++,l<=r)continue;const t=i&&!oa(+h),c=n+":"+h+":"+t;let f;if(this.qt.has(c)?f=this.qt.get(c):(f=this.Kt(e[n],n,h,t),this.qt.add(c,f),u++),f=Al(f),s[n][h]=f,a.push(f.bitmap.data.buffer),this.Gt&&u>this.Jt)return void this.Gt(o(l,s,a))}}n(null,{glyphs:s,buffers:a})};function o(t,n,e){return()=>{s(t,n,e)}}s(0,{},[])}Yt(t,n){const e=[];for(const n in t)for(const r of t[n])e.push(this.Zt(n,r));Promise.all(e).then((t=>{n(null,t)}))}Zt(){return Promise.resolve(null)}Kt(t,n,e,r){const i=n;let s=t.tinySDF;const o=r?-1:2;if(!s){let n="400";/bolder/i.test(i)?n="1000":/bold/i.test(i)?n="900":/medium/i.test(i)?n="500":/light/i.test(i)&&(n="200"),s=t.tinySDF=new wl(24,2,8,.25,i,n)}const a=String.fromCodePoint(e),u=s.ctx.measureText(a),l=Math.round(u.width),h=s.draw(a,l+4,28);if(Fl<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+Fl++);if(t){t.width=l+4,t.height=s.canvas.height;t.getContext("2d").drawImage(s.canvas,0,0)}}return{charCode:e,bitmap:{width:l+4,height:28,data:h},metrics:{width:l,height:24,left:1,top:-2,advance:l+2+o}}}}function Al(t){const n={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:n,metrics:$e({},t.metrics)}}const Pl={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1};Object.assign({visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},Pl),Object.assign({lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1},Pl);const Sl="__fea_idx";new Float32Array([-1e12])[0];const _l="maptalks_ombb";function Ol(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m){const g=n.getLength(),v=i/3;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-o;i+=g;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-a;i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,(e=e||[]).push(g/3);const b=e.getLength();for(let n=0;n<b;n++){Cl(v+(e[n-1]||0),v+e[n],t,g/3,u,r,l,h,c,f,s,d,p,y,m)}return i}function Cl(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){const y=s.getLength();let m,g;for(let o=t,a=n;o<a-1;o++)if(m=o,g=o+1,i===1/0||!ct(e,m,g,i))if((o-t)%2==1&&(m+=2*r,g+=2*r),p){let t=s.currentIndex;s[t++]=m+r,s[t++]=g,s[t++]=m,s[t++]=g+r,s[t++]=g,s[t++]=m+r,s.currentIndex=t}else{let t=s.currentIndex;s[t++]=m+r,s[t++]=m,s[t++]=g,s[t++]=g,s[t++]=g+r,s[t++]=m+r,s.currentIndex=t}o&&function(t,n,e,r,i,s,o,a,u,l,h,c){let f,d=0,p=0,y=0,m=0;const g=c?[1,3,4]:[2,3,4];for(let c=s.getLength()-1;c>=o;c--){const o=s[c],v=3*o+1,b=3*o+2,w=i[3*o],M=i[v],x=i[b];d||p||(d=Math.max(i[b],i[3*s[c-3]+2]),p=Math.min(i[b],i[3*s[c-3]+2]),f=d-p);let F=y;const k=c%6;0===t?(5===k&&(m=Ct(i,s,c,w,M)),F=k===g[0]||k===g[1]||k===g[2]?y:y+m):1===t&&(k===g[0]||k===g[1]||k===g[2]?F=0:5===k?(m=Ct(i,s,c,w,M),F=m):F=m);const A=F/l*(1/(100*h))/a;let P;P=1===n?x===d?1:0:"bottom"===e?x===d?f/100/u:0:x===d?0:-f/100/u,r[2*o]=A,r[2*o+1]=P,0===k&&(y+=m)}}(a,u,l,h,e,s,y,c[0],c[1],f,d,p)}function El(t){const n=[t[0]];let e=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===e[0]&&t[r][1]===e[1]&&t[r][2]===e[2]||n.push(t[r]):t[r].x===e.x&&t[r].y===e.y&&t[r].z===e.z||n.push(t[r]),e=t[r];return n}const $l=Do.getInstance();function Il(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y){void 0===n.top&&(n.top=!0),void 0===n.side&&(n.side=!0),$l.reset();const{altitudeScale:m,altitudeProperty:w,defaultAltitude:M,heightProperty:x,minHeightProperty:F,defaultHeight:k,tangent:A,uv:S,topUVMode:_,sideUVMode:O,sideVerticalUVMode:E,top:$,side:I,textureYOrigin:z,topThickness:D}=n,T=function(t,n,{altitudeScale:e,altitudeProperty:r,defaultAltitude:i,heightProperty:s,minHeightProperty:o,defaultHeight:a},{center:u,side:l,top:h,topThickness:c,uvOrigin:f,uv:d,uvSize:p,topUVMode:y,sideUVMode:m,sideVerticalUVMode:g,textureYOrigin:v,tileRatio:b,centimeterToPoint:w,verticalCentimeterToPoint:M,positionType:x,res:F,glScale:k,projectionCode:A},S,_){let O=n/t[0].extent;n===1/0&&(O=1);const C=n===1/0,E=_.get(),$=_.get(),I=_.get(),z=_.getProxy(),D=_.get(),T=_.get(),U=_.get(),j=!!d,N=!!h,L=!!l,H=j?_.get():null;function R(t,e,r,i,s,o){let a=e;if(N){const l=on(z,r,3);if(0===l.length)return e;let h=z.getLength(),d=D.currentIndex;for(let t=0;t<h;t++)D[d++]=z[t];if(D.currentIndex=d,e+=z.getLength(),o)for(let n=2,e=l.length;n<e;n+=3)l[n]+=t/3,l[n-1]+=t/3,l[n-2]+=t/3;else{let n;for(let e=2,r=l.length;e<r;e+=3)n=l[e-1],l[e-1]=l[e]+t/3,l[e]=n+t/3,l[e-2]+=t/3}h=l.length,d=T.currentIndex;for(let t=0;t<h;t++)T[d++]=l[t];T.currentIndex=d,j&&_t(y||0,t,e,H,D,f,w,b,p[0],p[1],s,F,k,A,u),c>0&&!L&&(e=Ol(D,z,r,T,e,H,0,c,n,j,m||0,g||0,v,p,b,M,i<0?!o:o)),U.setLength(e/3),U.fill(1,a/3,e/3)}if(L){N&&(c=0),a=e,e=Ol(D,z,r,T,e,H,c,i,n,j,m||0,g||0,v,p,b,M,i<0?!o:o),U.setLength(e/3);const t=z.getLength()/3;U.fill(1,a/3,a/3+t),U.fill(0,a/3+t,a/3+2*t),U.fill(1,a/3+2*t,a/3+3*t),U.fill(0,a/3+3*t,e/3)}return e}let V=0,q=0;const G=[-1,-1,n+1,n+1];let J=0,W=t.length;P(S)&&(J=S,W=S+1);let B=0,X=!1;const Y=_.getProxy();let K=!1;for(;J<W;J++){const u=t[J],l=u.id;P(l)&&(Math.abs(l)>B&&(B=Math.abs(l)),l<0&&(X=!0));const h=u.geometry,c=u.properties[_l];let f=Array.isArray(c&&c[0]&&c[0][0])?c[0]:c;const{altitude:d,height:p}=_n(u,e,r,i,s,a,o);p<0&&(K=!0),V=Math.max(Math.abs(d),V);const y=D.getLength();let m=0,g=q;Y.setLength(0),z.setLength(0);const v=An(h[0])<0;for(let t=0,e=h.length;t<e;t++){let r=h[t];v&&(r=r.reverse()),r=El(r);const i=An(r)<0;if(!i&&t>0&&(m++,f=c&&c[m],q=R(g,q,Y,p*O,f,C),z.setLength(0),Y.setLength(0),g=q),n!==1/0&&(r=Ku(r,G)),!r.length){t===e-1&&(q=R(g,q,Y,p*O,f,C));continue}const s=r.length;if(Array.isArray(r[0])?r[0][0]===r[s-1][0]&&r[0][1]===r[s-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[s-1].x&&r[0].y===r[s-1].y||r.push(r[0]),i){let t=Y.currentIndex;Y[t++]=z.getLength()/3,Y.currentIndex=t}ht(z,z.getLength(),r,O,d,!1,x),t===e-1&&(q=R(g,q,Y,p*O,f,C))}const b=D.getLength()-y,w=(Sl+"").trim();for(let t=0;t<b/3;t++){let t=$.currentIndex;$[t++]=void 0===u[w]?J:u[w],$.currentIndex=t,t=E.currentIndex,E[t++]=J,E.currentIndex=t,P(l)&&(t=I.currentIndex,I[t++]=l,I.currentIndex=t)}}const Z=Ln($.getLength()?$[$.getLength()-1]:0),Q={hasNegativeHeight:K,maxAltitude:V,vertices:D,verticeTypes:U,indices:T,pickingIds:Do.createTypedArray($,Z),featureIndexes:E};if(I.getLength()){const t=X?Nn(B):Ln(B);Q.featureIds=Do.createTypedArray(I,t)}else Q.featureIds=[];return H&&(H.setLength(D.getLength()/3*2),Q.uvs=H),Q}(t,e,{altitudeScale:m,altitudeProperty:w,defaultAltitude:M||0,heightProperty:x,minHeightProperty:F,defaultHeight:k||0},{center:y,top:$,side:I,topThickness:10*D||0,uv:S||A,uvSize:[i,i],uvOrigin:r,topUVMode:_,sideUVMode:O,sideVerticalUVMode:E,textureYOrigin:z,tileRatio:a,centimeterToPoint:u,verticalCentimeterToPoint:l,positionType:p,res:s,glScale:o,projectionCode:f},d,$l),U=[],j=T.vertices.getLength()/3,N=jn(j),L=Do.createTypedArray(T.indices,N);delete T.indices,U.push(L.buffer,T.pickingIds.buffer);const H=Nn(Math.max(512,T.maxAltitude));T.vertices=Do.createTypedArray(T.vertices,H);const R=A?$l.getProxy():new Float32Array(3*j);R.setLength&&R.setLength(3*j);const V=Iu(T.vertices,L,R);let q=!0;const G=V.getLength?V.getLength():V.length;for(let t=0;t<G;t++){V[t]=-V[t];const n=V[t]%1;1-Math.abs(n)>1e-6?q=!1:0!==n&&(V[t]=Math.round(V[t]))}if(T.normals=V,A){let t=$l.get();t.setLength(4*j),t=function(t,n,e,r,i){const s=(t.getLength?t.getLength():t.length)/3,o=i||new Array(4*s),a=[],u=[];for(let t=0;t<s;t++)a[t]=[0,0,0],u[t]=[0,0,0];const l=[0,0,0],h=[0,0,0],c=[0,0,0],f=[0,0],d=[0,0],p=[0,0],y=[0,0,0],m=[0,0,0];function g(n,r,i){Ru(l,t,3*n),Ru(h,t,3*r),Ru(c,t,3*i),Vu(f,e,2*n),Vu(d,e,2*r),Vu(p,e,2*i);const s=h[0]-l[0],o=c[0]-l[0],g=h[1]-l[1],v=c[1]-l[1],b=h[2]-l[2],w=c[2]-l[2],M=d[0]-f[0],x=p[0]-f[0],F=d[1]-f[1],k=p[1]-f[1],A=1/(M*k-x*F);yu(y,(k*s-F*o)*A,(k*g-F*v)*A,(k*b-F*w)*A),yu(m,(M*o-x*s)*A,(M*v-x*g)*A,(M*w-x*b)*A),mu(a[n],a[n],y),mu(a[r],a[r],y),mu(a[i],a[i],y),mu(u[n],u[n],m),mu(u[r],u[r],m),mu(u[i],u[i],m)}for(let t=0,n=r.length;t<n;t+=3)g(r[t+0],r[t+1],r[t+2]);const v=[],b=[],w=[],M=[];let x,F,k;function A(t){Ru(w,n,3*t),pu(M,w),F=a[t],pu(v,F),wu(v,v,function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t}(w,w,vu(w,F))),gu(v,v),bu(b,M,F),k=vu(b,u[t]),x=k<0?-1:1,o[4*t]=v[0],o[4*t+1]=v[1],o[4*t+2]=v[2],o[4*t+3]=x}for(let t=0,n=r.length;t<n;t+=3)A(r[t+0]),A(r[t+1]),A(r[t+2]);return o}(T.vertices,T.normals,T.uvs,L,t),t=function(t,n){const e=n.getLength(),r=new Float32Array(e),i=[],s=[],o=[];for(let a=0;a<e;a+=4){const e=a/4*3;dt(s,t[e]||0,t[e+1]||0,t[e+2]||0),gt(i,n[a]||0,n[a+1]||0,n[a+2]||0,n[a+3]||0),Eu(o,s,i),mt(r.subarray(a,a+4),o)}return r}(T.normals,t),T.tangents=t,U.push(t.buffer),delete T.normals}if(T.normals&&(q&&(T.normals=Do.createTypedArray(T.normals,Int8Array)),U.push(T.normals.buffer)),T.uvs){const t=T.uvs;T.uvs=Do.createTypedArray(t,Float32Array),U.push(T.uvs.buffer)}const J=function(t,n,e,r){const i={},s={},o=r.getLength();if(C(n.polygonFill)){let a=b(n.polygonFill);const u=new Uint8Array(4*o);u.fill(255);for(let n=0;n<o;n++){const s=t[r[n]],o=s.properties||{};o.$layer=s.layer,o.$type=s.type;let l=a(e,o);g(l)&&(i.aColor=1,a=b(l),l=a(e,o)),delete o.$layer,delete o.$type,He(zl,l),u[4*n]=zl[0],u[4*n+1]=zl[1],u[4*n+2]=zl[2],u[4*n+3]=zl[3]}s.aColor=u}if(C(n.polygonOpacity)){let a=v(n.polygonOpacity);const u=new Uint8Array(o);u.fill(255);for(let n=0;n<o;n++){const s=t[r[n]],o=s.properties||{};o.$layer=s.layer,o.$type=s.type;let l=a(e,o);g(l)&&(i.aOpacity=1,a=b(l),l=a(e,o)),delete o.$layer,delete o.$type,u[n]=255*l}s.aOpacity=u}return s.dynamicAttributes=i,s}(t,h,c,T.featureIndexes),W=function(t,n,e,r,i){const s=[[],[]],o=C(r.topPolygonFill),a=C(r.bottomPolygonFill),u=[255,255,255,255],l=n.getLength();if(o||a){let h=o&&b(r.topPolygonFill),c=a&&b(r.bottomPolygonFill),f=null,d=null,p=null,y=null;for(let r=0;r<l;r++){if(1===t[r]&&!o||0===t[r]&&!a)continue;const l=1===t[r];if(l&&n[r]===f){t[r]=p;continue}if(!l&&n[r]===d){t[r]=y;continue}const m=e[n[r]],v=m.properties||{};v.$layer=m.layer,v.$type=m.type;let w=l?h:c,M=w(i,v);g(M)&&(w=b(M),M=w(i,v)),delete v.$layer,delete v.$type,He(zl,M),vt(zl,zl,u);let x=Dl(s,zl);x<0&&(x=s.length,s.push(mt([],zl))),t[r]=x,l?(f=n[r],p=x):(d=n[r],y=x)}}return s.slice(2)}(T.verticeTypes,T.featureIndexes,t,h,c),B={data:{data:{aVertexColorType:W.length<=252?Do.createTypedArray(T.verticeTypes,Uint8Array):Do.createTypedArray(T.verticeTypes,Uint16Array),aPosition:T.vertices,aNormal:T.normals,aTexCoord0:T.uvs,aTangent:T.tangents,aPickingId:T.pickingIds},indices:L,properties:{maxAltitude:T.maxAltitude,hasNegativeHeight:T.hasNegativeHeight},dynamicAttributes:J.dynamicAttributes,vertexColors:W},buffers:U};return T.featureIds.length?(B.data.featureIds=T.featureIds,U.push(B.data.featureIds.buffer)):B.data.featureIds=[],J.aColor&&(B.data.data.aColor=J.aColor,B.buffers.push(J.aColor.buffer)),J.aOpacity&&(B.data.data.aOpacity=J.aOpacity,B.buffers.push(J.aOpacity.buffer)),B.buffers.push(B.data.data.aPosition.buffer),B.data.pickingIdIndiceMap=$n(B.data.data.aPickingId,B.data.indices),B}const zl=[];function Dl(t,n){for(let i=0;i<t.length;i++)if(e=n,r=t[i],e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2]&&e[3]===r[3])return i;var e,r;return-1}function Tl(t,n,e,r,{altitudeScale:i,altitudeProperty:s,defaultAltitude:o,heightProperty:a,minHeightProperty:u,defaultHeight:l,bottom:h}){const c=h,f=n/t[0].extent,d=2*function(t,n){let e=0;for(let n=0,r=t.length;n<r;n++){const r=t[n];if(P(r.geometry[0][0]))e+=3*r.geometry.length;else for(let t=0,n=r.geometry.length;t<n;t++){let n=3*r.geometry[t].length;3===r.type&&(n-=3),e+=n}}return e}(t)+3*t.length*2,p=[],y=new Int16Array(d),m=new Uint8Array(y.length/3*4);g(e)&&(e=wo(e));const v=[];function b(t,e,r){const i=e-t,s=y.subarray(t,e),o=y.subarray(e,e+i);o.set(s);for(let t=2,n=o.length;t<n;t+=3)o[t]=s[t]-r;const a=t/3,u=i/3;let l,h;for(let t=a,e=u+a;t<e;t++)t<e-1?(l=t,h=t+1):(l=t,h=a),ct(y,l,h,n)||(v.push(l,h),c&&v.push(l+u,h+u),Ul(y,l,n)||v.push(l,l+u));return e+i}let w=0,M=0;const x=(Sl+"").trim(),F=[];for(let n=0,h=t.length;n<h;n++){const h=t[n],c=h.geometry;if(e){let t;t="function"==typeof e?e(h&&h.properties):e,He(F,t)}else dt(F,255,255,255);const d=w/3*4,{altitude:g,height:k}=_n(h,i,s,o,a,l,u);M=Math.max(Math.abs(g),M);let A=w;for(let t=0,n=c.length;t<n;t++){let n=c[t];const e=n.length;n[0][0]===n[e-1][0]&&n[0][1]===n[e-1][1]&&(n=n.slice(0,e-1)),w=ht(y,A,n,f,g),w=b(A,w,k*f),A=w}const P=A/3*4;for(let t=d;t<P;t+=4)m[t]=F[0],m[t+1]=F[1],m[t+2]=F[2],m[t+3]=255*(r||1);const S=v.length-p.length;for(let t=0;t<S;t++)p.push(h[x])}const k=new(jn(v.reduce(((t,n)=>Math.max(t,n)),0)))(v),A=Ln(t.length);return{aPosition:new(Nn(Math.max(512,M)))(y),indices:k,aPickingId:new A(p),aColor:m}}function Ul(t,n,e){const r=t[3*n],i=t[3*n+1];return r<0||r>e||i<0||i>e}function jl(t,n,e,r){const i=Tl(t,n,e.lineColor,e.lineOpacity,r),s=[i.aPosition.buffer,i.indices.buffer,i.aPickingId.buffer],o=i.indices;return delete i.indices,{data:{data:i,indices:o},buffers:s}}let Nl=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),Nl=!0}catch(t){Nl=!1}var Ll=Nl;const Hl="__original_properties",Rl="__fn-type_properties";class Vl{constructor(t,n,e,r,i){this.id=t,this.options=n,this.upload=e,this.Qt(n.style),this.requests={},this.qt=r,this.tn=1,this.loadings=i}updateStyle(t,n){this.options.style=t,this.tn=t.styleCounter,this.Qt(t),n()}updateOptions(t,n){this.options=k(this.options,t),n()}loadTile(t,n){const e=this.loadings,r=t.tileInfo.url,i=this.options.debugTile;if(i){const{x:e,y:r,z:s}=t.tileInfo;let o=!1;for(let t=0;t<i.length;t++)if(e===i[t].x&&r===i[t].y&&s===i[t].z){o=!0;break}if(!o)return void n()}if(e[r])return void e[r].push({context:t,callback:n,ref:this});e[r]=[{context:t,callback:n,ref:this}];const s=this.options.featureIdProperty;this.requests[r]=this.getTileFeatures(t,((n,i,o,a)=>{const u=e[r];if(delete e[r],this.checkIfCanceled(r))return delete this.requests[r],void this.nn(u,null,{canceled:!0});if(delete this.requests[r],(this.options.debug||s)&&i)for(let n=0;n<i.length;n++)if(this.options.debug&&(i[n]._debug_info={index:n,id:i[n].id,tileId:t.tileInfo.id}),s){const t=_(s)?s[i[n].layer]:s,e=i[n].properties;i[n].id=e&&e[t]||null}if(n)this.nn(u,n);else if(i&&i.length){if(u)for(let t=0;t<u.length;t++)this.en.call(u[t].ref,u[t].context,u[t].callback,r,o,i,a)}else this.nn(u)}))}en(t,n,e,r,i,s){this.rn(r,i,t).then((e=>{e.canceled?n(null,{canceled:!0}):(e.data.styleCounter=t.styleCounter,s&&k(e.data,s),n(null,e.data,e.buffers))})).catch((t=>{n(t)}))}abortTile(t,n){delete this.requests[t],this.sn(t),n()}sn(t){const n=this.loadings[t];if(n)for(let t=0;t<n.length;t++)n[t].callback(null,{canceled:!0});delete this.loadings[t]}nn(t,n,e){if(t)for(let r=0;r<t.length;r++)t[r].callback(n,e)}checkIfCanceled(t){return!this.requests[t]}onRemove(){this.loadings={},delete this.qt,this.requests={}}fetchIconGlyphs(t,n,e){if(this.options.workerGlyph&&Ll){const r=[];if(t&&Object.keys(t).length){const n=new Promise((n=>{this.upload("fetchIconGlyphs",{icons:t},null,((t,e)=>{n({err:t,iconData:e})}))}));r.push(n)}if(n&&Object.keys(n).length){const t=new Promise((t=>{this.an||(this.an=new kl),this.an.getGlyphs(n,((n,e)=>{t({err:n,glyphData:e})}))}));r.push(t)}Promise.all(r).then((t=>{const n={icons:null,glyphs:null};for(let r=0;r<t.length;r++){if(t[r].err)return void e(t[r].err);t[r].iconData?n.icons=t[r].iconData.icons:t[r].glyphData&&(n.glyphs=t[r].glyphData.glyphs)}return n})).then((t=>{e(null,t)}))}else this.upload("fetchIconGlyphs",{icons:t,glyphs:n},null,e)}rn(t,n,e){if(!n.length)return Promise.resolve({data:null,buffers:[]});const{glScale:r,tileInfo:i}=e,s=!this.options.style.style.length&&!this.options.style.featureStyle.length;let o=this.pluginConfig.slice(0);s&&(o=this.un(t)),this.featurePlugins&&function(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];if(e)for(let n=0,r=e.length;n<r;n++)t.push(e[n])}t.length}(o,this.featurePlugins);const a={};for(let t=0;t<o.length;t++)Yl(n,e.tileInfo.z,o[t],a);const u=[],l=[];for(let t=0;t<n.length;t++){const e=n[t],r=a[t];if(r){l.fill(null);let t=0;for(const n in r){let i=0;const s=r[n].values();for(const t of s){let r=l[i];r||(r=th(e),l[i]=r),r.properties[n]=t,i++}i>t&&(t=i)}for(let n=0;n<t;n++)u.push(l[n])}else u.push(e)}const h=(n=u)[0].extent,c=i.z,f={x:i.extent2d.xmin*r,y:i.extent2d.ymax*r},d=[],p=[],y=[],m=this.options,g=[],v={},b=[Promise.resolve(e.styleCounter)];let w=0,M=-1;const x=[];let F=!1;for(let t=0;t<o.length;t++){M++;const r=o[t];r.type!==w&&(M=0,w=r.type);const a=0===r.type?d:p;if(r.symbol&&!1===r.symbol.visible){a[M]=null;continue}rh(r.symbol,x,t),F=F||x[t]&&x[t].size>0;const{tileFeatures:u,tileFeaIndexes:l}=this.hn(c,r.type,r.filter,n,v,t);if(!u.length){a[M]=null;continue}const m=jn(l[l.length-1]);a[M]={styledFeatures:new m(l)},y.push({idx:t,typeIdx:M}),g.push(a[M].styledFeatures.buffer);const A=k({},e,{extent:h,zoom:c,tilePoint:f});if(this.options.debugTile){const t=this.options.debugTile;for(let n=0;n<t.length;n++){const{x:e,y:r,z:s}=t[n];if(i.x===e&&i.y===r&&i.z===s){A.debugIndex=t[n].index;break}}}let P=this.cn(u,r,A);s&&(P=P.then((t=>{if(!t)return null;if(t.data)t.data.layer=u[0].layer;else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&t[n].data&&(t[n].data.layer=u[0].layer);return t}))),b.push(P)}return Promise.all(b).then((([e,...r])=>{if(e!==this.tn)return{canceled:!0};function i(t,n){if(void 0===t.data.ref&&(t.data.type=o[y[n].idx].renderPlugin.dataConfig.type,t.data.filter=o[y[n].idx].filter.def,t.buffers&&t.buffers.length))for(let n=0;n<t.buffers.length;n++)g.push(t.buffers[n])}for(let t=0;t<r.length;t++){if(!r[t])continue;const n=r[t],e=0===o[y[t].idx].type?d:p;if(Array.isArray(n)){const r=[];for(let e=0;e<n.length;e++)n[e]&&(i(n[e],t),(void 0===n[e].data.ref||n[n[e].data.ref])&&r.push(n[e].data));r.length&&(e[y[t].typeIdx].data=r)}else i(n,t),e[y[t].typeIdx].data=n.data}const s={},a=t;if(m.features||m.schema||F){let t,e=!1;for(let r=0,i=n.length;r<i;r++)if(t=n[r],a[t.layer].properties||(a[t.layer].properties=Jl(t.properties)),t&&(m.features||F&&v[r]))if("id"===m.features)s[r]=t.id;else{m.pickingGeometry||delete t.geometry,delete t.extent,delete t.properties.$layer,delete t.properties.$type,delete t.__index;const n=t.originalFeature;if(n){const n=t.properties,e=k({},t.originalFeature);delete n[Hl],e.customProps=k({},n),t=e}const i=k({},t);if(F&&v[r]&&(!m.features||"transient"===m.features)){const i=v[r];for(let r=0;r<i.length;r++){const i=x[r];i&&i.forEach((r=>{const i=n?n.properties:t.properties;i[Rl]||(i[Rl]=new Set),i[Rl].add(r),e=!0}))}}s[r]=i}if(e)for(const t in s){const n=s[t],e=n.properties[Rl];if(e){delete n.properties[Rl],"transient"===m.features&&(n.fnTypeProps=k({},n.properties));for(const t in n.properties)e.has(t)||("transient"===m.features?delete n.fnTypeProps[t]:delete n.properties[t])}}}return{data:{styleCounter:e,schema:a,data:d,featureData:p,extent:h,features:s},buffers:g}})).catch((t=>{console.error(t)}))}cn(t,n,e){let r=t;const i=n.renderPlugin.dataConfig,s=n.symbol,o=this.options.tileSize,{extent:a,glScale:u,zScale:l,zoom:h,tilePoint:c,centimeterToPoint:f,verticalCentimeterToPoint:d}=e,p=a/o,y=i.type,m=e.debugIndex;let g=k({},i,{EXTENT:a,zoom:h,debugIndex:m,features:this.options.features});if("3d-extrusion"===y){Wl(s)&&(i.uv=1);const t=this.options.projectionCode,n=s.material&&s.material.textureWidth||23.25;return Promise.all([Promise.resolve(Il(r,i,a,c,n,e.tileInfo.res,u,a/this.options.tileSize,f,d,s,h,t,m))])}if("3d-wireframe"===y)return Promise.all([Promise.resolve(jl(r,a,s,i))]);if("point"===y){g=k(g,{requestor:this.fetchIconGlyphs.bind(this),altitudeToTileScale:l*a/this.options.tileSize/u});const t=Xa.splitPointSymbol(s),n=Go.genFnTypes(t[0]);return Xa.needMerge(t[0],n,h)&&(r=Xa.mergeLineFeatures(r,t[0],n,h)),Promise.all(t.map(((t,e)=>(0===e?g.fnTypes=n:delete g.fnTypes,new Xa(r,t,g).load(p)))))}if("native-point"===y){const t=l*a/this.options.tileSize/u;return g.altitudeToTileScale=t,Bl(r,s,g,Bu,a/o)}if("line"===y)return g=k(g,{requestor:this.fetchIconGlyphs.bind(this),tileRatio:p}),Bl(r,s,g,ru,1,!0);if("native-line"===y)return Bl(r,s,g,Ju,1,!0);if("fill"===y)return g=k(g,{requestor:this.fetchIconGlyphs.bind(this)}),Bl(r,s,g,el);if("line-extrusion"===y){delete s.lineGradientProperty,s.lineJoin="miter",s.lineCap="butt";const t=Wl(s);if(t&&(i.uv=1),g=k(g,{tileSize:o,zScale:l,glScale:u}),s.mergeOnProperty){const t=Go.genFnTypes(s);r=ru.mergeLineFeatures(r,s,t,g.zoom)}if(t){const t=[];if(!1!==i.top){const n=k({},g);n.side=!1,t.push(new qu(r,s,n))}return!1!==i.side&&(g.side=!0,g.top=!1,t.push(new qu(r,s,g))),Promise.all(t.map((t=>t.load())))}return Promise.all([new qu(r,s,g).load()])}if("circle"===y)return Bl(r,s,g,il);if("round-tube"===y||"square-tube"===y){const t="round-tube"===y?sl:cl;return g=k(g,{requestor:this.fetchIconGlyphs.bind(this),radialSegments:"round-tube"===y?i.radialSegments||8:4,centimeterToPoint:f,verticalCentimeterToPoint:d,tileRatio:p,isTube:!0}),Bl(r,s,g,t)}return Promise.resolve([])}hn(t,n,e,r,i,s){const o=(Sl+"").trim(),a=[],u=[],l=r.length;for(let h=0;h<l;h++)if((1===n||void 0===r[h].id||!this.styledFeatures[r[h].id])&&((!e.def||"default"===e.def)&&!i[h]||!0===e.def||e.def&&(void 0!==e.def.condition||Array.isArray(e.def))&&e(r[h],t))){const t=r[h];if(void 0===t[o]&&(t[o]=h),i[h]||(i[h]=[]),i[h].push(s),u.push(t),a.push(h),1===n)break}return{tileFeatures:u,tileFeaIndexes:a}}Qt(t){const{style:n,featureStyle:e}=t,r={};e.forEach((t=>{Array.isArray(t.id)?(t.id.forEach((t=>{r[t]=1})),t.filter=["in","$id",...t.id]):(r[t.id]=1,t.filter=["==","$id",t.id])}));const i=go(n);for(let t=0;t<n.length;t++)i[t].filter&&(i[t].filter.def=n[t].filter?n[t].filter.value||n[t].filter:void 0),i[t].type=0;const s=[],o=go(e);for(let t=0;t<e.length;t++)o[t].type=1,o[t].filter.def=e[t].filter?e[t].filter.value||e[t].filter:void 0,o[t].renderPlugin&&s.push(o[t]);this.pluginConfig=i,this.featurePlugins=s,this.styledFeatures=r}un(t){let n=this.dn;this.dn||(n=this.dn={});const e=["","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"],r=[];for(const i in t){const s=i;if(!n[i]){const r=[];for(let n=0;n<t[i].types.length;n++){const o=t[i].types[n],a=["all",["==","$layer",s],["==","$type",e[o]]],u={filter:Je(a),renderPlugin:ql(o),symbol:Gl(o)};u.filter.def=a,u.type=0,r.push(u)}n[s]=r}r.push(...n[s])}return r}}function ql(t){switch(t){case 1:return{type:"native-point",dataConfig:{type:"native-point",only2D:!0}};case 2:return{type:"native-line",dataConfig:{type:"native-line",only2D:!0}};case 3:return{type:"fill",dataConfig:{type:"fill",only2D:!0}}}return null}function Gl(t){switch(t){case 1:return{markerFill:"#f00",markerSize:10};case 2:return{lineColor:"#fff"};case 3:return{polygonFill:"#00f",polygonOpacity:.4}}return null}function Jl(t){if(Array.isArray(t)||!_(t))return{};const n={};for(const e in t){const r=t[e];A(r)?n[e]="string":P(r)?n[e]="number":!0===r||!1===r?n[e]="boolean":Array.isArray(r)?n[e]="array":n[e]="object"}return n}function Wl(t){if(!t)return 0;let n=0;for(const e in t){if(("normalTexture"===e||"bumpTexture"===e)&&t[e])return 2;if(e.indexOf("Texture")>0&&t[e])n=1;else if(_(t[e])){const r=Wl(t[e]);if(2===r)return r;1===r&&(n=1)}}return n}function Bl(t,n,e,r,i,s){const o={},a=Array.isArray(n)?n:[n];let u=-1;for(let t=0;t<a.length;t++)o[t]=Xl(a[t]),!o[t]&&a[t]&&-1===u&&(u=t);const l=[];for(let n=0;n<a.length;n++){if(!a[n])continue;a[n].index={index:n};let h=t;if(s&&a[n].mergeOnProperty){const r=Go.genFnTypes(a[n]);h=ru.mergeLineFeatures(t,a[0],r,e.zoom)}o[n]||n===u?l.push(new r(h,a[n],e).load(i)):l.push({data:{ref:u,symbolIndex:{index:n}}})}return Promise.all(l)}function Xl(t){if(!t)return 0;for(const n in t)if(C(t[n]))return 1;return 0}function Yl(t,n,e,r){const i=e.customProperties;if(!i)return t;if(i)for(let t=0;t<i.length;t++)i[t].fn=wo(i[t].filter);for(let e=0;e<i.length;e++)for(let s=0,o=t.length;s<o;s++)if(i[e].fn(t[s],n))for(const t in i[e].properties){const n=i[e].properties[t];O(n)||(r[s]||(r[s]={}),r[s][t]||(r[s][t]=new Set),r[s][t].add(n))}}const Kl={get:(t,n)=>n in t?t[n]:t.originalFeature[n],has:(t,n)=>n in t||n in t.originalFeature},Zl={get:function(t,n){return n in t?t[n]:t[Hl][n]},has:(t,n)=>n in t||n in t[Hl]},Ql={};function th(t){const n={};n.originalFeature=t;const e=new Proxy(n,Kl);return e.properties=new Proxy({},Zl),e.properties[Hl]=t.properties||Ql,e}function nh(t,n,e){t[n]||(t[n]=new Set),t[n].add(e)}const eh=[];function rh(t,n,e){if(!t)return eh;for(const i in t){if(!t[i]||!Re[r=i]&&!Ve[r])continue;if(C(t[i]))nh(n,e,t[i].property);else{if("lineGradientProperty"===i){nh(n,e,t[i]);continue}if("textName"===i)if(A(t[i])){const r=t[i].match(Qo);if(r)for(let t=0;t<r.length;t++)nh(n,e,r[t])}else if(Fo(t[i])){const r=[];na(r,t[i]);for(let t=0;t<r.length;t++)nh(n,e,r[t])}}const s=t[i].stops;if(s&&s.length)for(let t=0;t<s.length;t++)C(s[t][1])&&nh(n,t,s[t][1].property)}var r;return n[e]}function ih(t,n){sh(t.geometry,n)}function sh(t,n){if(t)switch(t.type){case"Point":oh(t.coordinates,n);break;case"MultiPoint":case"LineString":ah(t.coordinates,n);break;case"MultiLineString":!function(t,n){for(let e=0,r=t.length;e<r;e++)ah(t[e],n)}(t.coordinates,n);break;case"Polygon":uh(t.coordinates,n);break;case"MultiPolygon":!function(t,n){for(let e=0,r=t.length;e<r;e++)uh(t[e],n)}(t.coordinates,n);break;case"GeometryCollection":const e=t.geometries.length;for(let r=0;r<e;r++)sh(t.geometries[r],n)}}function oh(t,n){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function ah(t,n){for(let e=0,r=t.length;e<r;e++)oh(t[e],n)}function uh(t,n){t.length&&ah(t[0],n)}function lh(t,n,e,r,i){hh(t,n,e||0,r||t.length-1,i||fh)}function hh(t,n,e,r,i){for(;r>e;){if(r-e>600){var s=r-e+1,o=n-e+1,a=Math.log(s),u=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*u*(s-u)/s)*(o-s/2<0?-1:1);hh(t,n,Math.max(e,Math.floor(n-o*u/s+l)),Math.min(r,Math.floor(n+(s-o)*u/s+l)),i)}var h=t[n],c=e,f=r;for(ch(t,e,n),i(t[r],h)>0&&ch(t,e,r);c<f;){for(ch(t,c,f),c++,f--;i(t[c],h)<0;)c++;for(;i(t[f],h)>0;)f--}0===i(t[e],h)?ch(t,e,f):ch(t,++f,r),f<=n&&(e=f+1),n<=f&&(r=f-1)}}function ch(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function fh(t,n){return t<n?-1:t>n?1:0}class dh{constructor(t=9){this.pn=Math.max(4,t),this.yn=Math.max(2,Math.ceil(.4*this.pn)),this.clear()}all(){return this.mn(this.data,[])}search(t){let n=this.data;const e=[];if(!kh(t,n))return e;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const o=n.children[s],a=n.leaf?r(o):o;kh(t,a)&&(n.leaf?e.push(o):Fh(t,a)?this.mn(o,e):i.push(o))}n=i.pop()}return e}collides(t){let n=this.data;if(!kh(t,n))return!1;const e=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(kh(t,s)){if(n.leaf||Fh(t,s))return!0;e.push(i)}}n=e.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this.yn){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let n=this.gn(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this.vn(this.data,n);else{if(this.data.height<n.height){const t=this.data;this.data=n,n=t}this.bn(n,this.data.height-n.height-1,!0)}else this.data=n;return this}insert(t){return t&&this.bn(t,this.data.height-1),this}clear(){return this.data=Ah([]),this}remove(t,n){if(!t)return this;let e=this.data;const r=this.toBBox(t),i=[],s=[];let o,a,u;for(;e||i.length;){if(e||(e=i.pop(),a=i[i.length-1],o=s.pop(),u=!0),e.leaf){const r=ph(t,e.children,n);if(-1!==r)return e.children.splice(r,1),i.push(e),this.wn(i),this}u||e.leaf||!Fh(e,r)?a?(o++,e=a.children[o],u=!1):e=null:(i.push(e),s.push(o),o=0,a=e,e=e.children[0])}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}mn(t,n){const e=[];for(;t;)t.leaf?n.push(...t.children):e.push(...t.children),t=e.pop();return n}gn(t,n,e,r){const i=e-n+1;let s,o=this.pn;if(i<=o)return s=Ah(t.slice(n,e+1)),yh(s,this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/Math.pow(o,r-1))),s=Ah([]),s.leaf=!1,s.height=r;const a=Math.ceil(i/o),u=a*Math.ceil(Math.sqrt(o));Ph(t,n,e,u,this.compareMinX);for(let i=n;i<=e;i+=u){const n=Math.min(i+u-1,e);Ph(t,i,n,a,this.compareMinY);for(let e=i;e<=n;e+=a){const i=Math.min(e+a-1,n);s.children.push(this.gn(t,e,i,r-1))}}return yh(s,this.toBBox),s}Mn(t,n,e,r){for(;r.push(n),!n.leaf&&r.length-1!==e;){let e,r=1/0,o=1/0;for(let a=0;a<n.children.length;a++){const u=n.children[a],l=wh(u),h=(i=t,s=u,(Math.max(s.maxX,i.maxX)-Math.min(s.minX,i.minX))*(Math.max(s.maxY,i.maxY)-Math.min(s.minY,i.minY))-l);h<o?(o=h,r=l<r?l:r,e=u):h===o&&l<r&&(r=l,e=u)}n=e||n.children[0]}var i,s;return n}bn(t,n,e){const r=e?t:this.toBBox(t),i=[],s=this.Mn(r,this.data,n,i);for(s.children.push(t),gh(s,r);n>=0&&i[n].children.length>this.pn;)this.xn(i,n),n--;this.Fn(r,i,n)}xn(t,n){const e=t[n],r=e.children.length,i=this.yn;this.kn(e,i,r);const s=this.An(e,i,r),o=Ah(e.children.splice(s,e.children.length-s));o.height=e.height,o.leaf=e.leaf,yh(e,this.toBBox),yh(o,this.toBBox),n?t[n-1].children.push(o):this.vn(e,o)}vn(t,n){this.data=Ah([t,n]),this.data.height=t.height+1,this.data.leaf=!1,yh(this.data,this.toBBox)}An(t,n,e){let r,i=1/0,s=1/0;for(let o=n;o<=e-n;o++){const n=mh(t,0,o,this.toBBox),a=mh(t,o,e,this.toBBox),u=xh(n,a),l=wh(n)+wh(a);u<i?(i=u,r=o,s=l<s?l:s):u===i&&l<s&&(s=l,r=o)}return r||e-n}kn(t,n,e){const r=t.leaf?this.compareMinX:vh,i=t.leaf?this.compareMinY:bh;this.Pn(t,n,e,r)<this.Pn(t,n,e,i)&&t.children.sort(r)}Pn(t,n,e,r){t.children.sort(r);const i=this.toBBox,s=mh(t,0,n,i),o=mh(t,e-n,e,i);let a=Mh(s)+Mh(o);for(let r=n;r<e-n;r++){const n=t.children[r];gh(s,t.leaf?i(n):n),a+=Mh(s)}for(let r=e-n-1;r>=n;r--){const n=t.children[r];gh(o,t.leaf?i(n):n),a+=Mh(o)}return a}Fn(t,n,e){for(let r=e;r>=0;r--)gh(n[r],t)}wn(t){for(let n,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():yh(t[e],this.toBBox)}}function ph(t,n,e){if(!e)return n.indexOf(t);for(let r=0;r<n.length;r++)if(e(t,n[r]))return r;return-1}function yh(t,n){mh(t,0,t.children.length,n,t)}function mh(t,n,e,r,i){i||(i=Ah(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=n;s<e;s++){const n=t.children[s];gh(i,t.leaf?r(n):n)}return i}function gh(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function vh(t,n){return t.minX-n.minX}function bh(t,n){return t.minY-n.minY}function wh(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Mh(t){return t.maxX-t.minX+(t.maxY-t.minY)}function xh(t,n){const e=Math.max(t.minX,n.minX),r=Math.max(t.minY,n.minY),i=Math.min(t.maxX,n.maxX),s=Math.min(t.maxY,n.maxY);return Math.max(0,i-e)*Math.max(0,s-r)}function Fh(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function kh(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function Ah(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Ph(t,n,e,r,i){const s=[n,e];for(;s.length;){if((e=s.pop())-(n=s.pop())<=r)continue;const o=n+Math.ceil((e-n)/r/2)*r;lh(t,o,n,e,i),s.push(n,o,o,e)}}var Sh={exports:{}},_h=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=(r-e)/2,u=0,l=a-1;u<a;l=u++){var h=n[e+2*u+0],c=n[e+2*u+1],f=n[e+2*l+0],d=n[e+2*l+1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o},Oh=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=r-e,u=0,l=a-1;u<a;l=u++){var h=n[u+e][0],c=n[u+e][1],f=n[l+e][0],d=n[l+e][1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o};Sh.exports=function(t,n,e,r){return n.length>0&&Array.isArray(n[0])?Oh(t,n,e,r):_h(t,n,e,r)};var Ch=Sh.exports.nested=Oh;Sh.exports.flat=_h;const Eh=11102230246251565e-32,$h=134217729,Ih=(3+8*Eh)*Eh;function zh(t,n,e,r,i){let s,o,a,u,l=n[0],h=r[0],c=0,f=0;h>l==h>-l?(s=l,l=n[++c]):(s=h,h=r[++f]);let d=0;if(c<t&&f<e)for(h>l==h>-l?(o=l+s,a=s-(o-l),l=n[++c]):(o=h+s,a=s-(o-h),h=r[++f]),s=o,0!==a&&(i[d++]=a);c<t&&f<e;)h>l==h>-l?(o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c]):(o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f]),s=o,0!==a&&(i[d++]=a);for(;c<t;)o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c],s=o,0!==a&&(i[d++]=a);for(;f<e;)o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f],s=o,0!==a&&(i[d++]=a);return 0===s&&0!==d||(i[d++]=s),d}function Dh(t){return new Float64Array(t)}const Th=33306690738754716e-32,Uh=22204460492503146e-32,jh=11093356479670487e-47,Nh=Dh(4),Lh=Dh(8),Hh=Dh(12),Rh=Dh(16),Vh=Dh(4);function qh(t,n,e,r,i,s){const o=(n-s)*(e-i),a=(t-i)*(r-s),u=o-a;if(0===o||0===a||o>0!=a>0)return u;const l=Math.abs(o+a);return Math.abs(u)>=Th*l?u:-function(t,n,e,r,i,s,o){let a,u,l,h,c,f,d,p,y,m,g,v,b,w,M,x,F,k;const A=t-i,P=e-i,S=n-s,_=r-s;w=A*_,f=$h*A,d=f-(f-A),p=A-d,f=$h*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=S*P,f=$h*S,d=f-(f-S),p=S-d,f=$h*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,Nh[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,Nh[1]=b-(g+c)+(c-x),k=v+g,c=k-v,Nh[2]=v-(k-c)+(g-c),Nh[3]=k;let O=function(t,n){let e=n[0];for(let r=1;r<t;r++)e+=n[r];return e}(4,Nh),C=Uh*o;if(O>=C||-O>=C)return O;if(c=t-A,a=t-(A+c)+(c-i),c=e-P,l=e-(P+c)+(c-i),c=n-S,u=n-(S+c)+(c-s),c=r-_,h=r-(_+c)+(c-s),0===a&&0===u&&0===l&&0===h)return O;if(C=jh*o+Ih*Math.abs(O),O+=A*h+_*a-(S*l+P*u),O>=C||-O>=C)return O;w=a*_,f=$h*a,d=f-(f-a),p=a-d,f=$h*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=u*P,f=$h*u,d=f-(f-u),p=u-d,f=$h*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,Vh[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,Vh[1]=b-(g+c)+(c-x),k=v+g,c=k-v,Vh[2]=v-(k-c)+(g-c),Vh[3]=k;const E=zh(4,Nh,4,Vh,Lh);w=A*h,f=$h*A,d=f-(f-A),p=A-d,f=$h*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=S*l,f=$h*S,d=f-(f-S),p=S-d,f=$h*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,Vh[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,Vh[1]=b-(g+c)+(c-x),k=v+g,c=k-v,Vh[2]=v-(k-c)+(g-c),Vh[3]=k;const $=zh(E,Lh,4,Vh,Hh);w=a*h,f=$h*a,d=f-(f-a),p=a-d,f=$h*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=u*l,f=$h*u,d=f-(f-u),p=u-d,f=$h*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,Vh[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,Vh[1]=b-(g+c)+(c-x),k=v+g,c=k-v,Vh[2]=v-(k-c)+(g-c),Vh[3]=k;const I=zh($,Hh,4,Vh,Rh);return Rh[I-1]}(t,n,e,r,i,s,l)}function Gh(t,n,e){n=Math.max(0,void 0===n?2:n),e=e||0;var r=function(t){for(var n=t[0],e=t[0],r=t[0],i=t[0],s=0;s<t.length;s++){var o=t[s];o[0]<n[0]&&(n=o),o[0]>r[0]&&(r=o),o[1]<e[1]&&(e=o),o[1]>i[1]&&(i=o)}var a=[n,e,r,i],u=a.slice();for(s=0;s<t.length;s++)Ch(t[s],a)||u.push(t[s]);return function(t){t.sort(rc);for(var n=[],e=0;e<t.length;e++){for(;n.length>=2&&Kh(n[n.length-2],n[n.length-1],t[e])<=0;)n.pop();n.push(t[e])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&Kh(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),n.pop(),n.concat(r)}(u)}(t),i=new dh(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,n){return t[0]-n[0]},i.compareMinY=function(t,n){return t[1]-n[1]},i.load(t);for(var s,o=[],a=0;a<r.length;a++){var u=r[a];i.remove(u),s=Qh(u,s),o.push(s)}var l=new dh(16);for(a=0;a<o.length;a++)l.insert(Zh(o[a]));for(var h=n*n,c=e*e;o.length;){var f=o.shift(),d=f.p,p=f.next.p,y=tc(d,p);if(!(y<c)){var m=y/h;(u=Jh(i,f.prev.p,d,p,f.next.next.p,m,l))&&Math.min(tc(u,d),tc(u,p))<=m&&(o.push(f),o.push(Qh(u,f)),i.remove(u),l.remove(f),l.insert(Zh(f)),l.insert(Zh(f.next)))}}f=s;var g=[];do{g.push(f.p),f=f.next}while(f!==s);return g.push(f.p),g}function Jh(t,n,e,r,i,s,o){for(var a=new Ta([],Wh),u=t.data;u;){for(var l=0;l<u.children.length;l++){var h=u.children[l],c=u.leaf?nc(h,e,r):Bh(e,r,h);c>s||a.push({node:h,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=nc(d,n,e),y=nc(d,r,i);if(f.dist<p&&f.dist<y&&Yh(e,d,o)&&Yh(r,d,o))return d}(u=a.pop())&&(u=u.node)}return null}function Wh(t,n){return t.dist-n.dist}function Bh(t,n,e){if(Xh(t,e)||Xh(n,e))return 0;var r=ec(t[0],t[1],n[0],n[1],e.minX,e.minY,e.maxX,e.minY);if(0===r)return 0;var i=ec(t[0],t[1],n[0],n[1],e.minX,e.minY,e.minX,e.maxY);if(0===i)return 0;var s=ec(t[0],t[1],n[0],n[1],e.maxX,e.minY,e.maxX,e.maxY);if(0===s)return 0;var o=ec(t[0],t[1],n[0],n[1],e.minX,e.maxY,e.maxX,e.maxY);return 0===o?0:Math.min(r,i,s,o)}function Xh(t,n){return t[0]>=n.minX&&t[0]<=n.maxX&&t[1]>=n.minY&&t[1]<=n.maxY}function Yh(t,n,e){for(var r,i,s,o,a=Math.min(t[0],n[0]),u=Math.min(t[1],n[1]),l=Math.max(t[0],n[0]),h=Math.max(t[1],n[1]),c=e.search({minX:a,minY:u,maxX:l,maxY:h}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,s=t,r!==(o=n)&&i!==s&&Kh(r,i,s)>0!=Kh(r,i,o)>0&&Kh(s,o,r)>0!=Kh(s,o,i)>0)return!1;return!0}function Kh(t,n,e){return qh(t[0],t[1],n[0],n[1],e[0],e[1])}function Zh(t){var n=t.p,e=t.next.p;return t.minX=Math.min(n[0],e[0]),t.minY=Math.min(n[1],e[1]),t.maxX=Math.max(n[0],e[0]),t.maxY=Math.max(n[1],e[1]),t}function Qh(t,n){var e={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function tc(t,n){var e=t[0]-n[0],r=t[1]-n[1];return e*e+r*r}function nc(t,n,e){var r=n[0],i=n[1],s=e[0]-r,o=e[1]-i;if(0!==s||0!==o){var a=((t[0]-r)*s+(t[1]-i)*o)/(s*s+o*o);a>1?(r=e[0],i=e[1]):a>0&&(r+=s*a,i+=o*a)}return(s=t[0]-r)*s+(o=t[1]-i)*o}function ec(t,n,e,r,i,s,o,a){var u,l,h,c,f=e-t,d=r-n,p=o-i,y=a-s,m=t-i,g=n-s,v=f*f+d*d,b=f*p+d*y,w=p*p+y*y,M=f*m+d*g,x=p*m+y*g,F=v*w-b*b,k=F,A=F;0===F?(l=0,k=1,c=x,A=w):(c=v*x-b*M,(l=b*x-w*M)<0?(l=0,c=x,A=w):l>k&&(l=k,c=x+b,A=w)),c<0?(c=0,-M<0?l=0:-M>v?l=k:(l=-M,k=v)):c>A&&(c=A,-M+b<0?l=0:-M+b>v?l=k:(l=-M+b,k=v));var P=(1-(h=0===c?0:c/A))*i+h*o-((1-(u=0===l?0:l/k))*t+u*e),S=(1-h)*s+h*a-((1-u)*n+u*r);return P*P+S*S}function rc(t,n){return t[0]===n[0]?t[1]-n[1]:t[0]-n[0]}class ic{constructor(t,n){this.x=t,this.y=n}clone(){return new ic(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new ic(this.x-t.x,this.y-t.y)}distance(t){const n=this.x-t.x,e=this.y-t.y;return Math.sqrt(n*n+e*e)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new ic(this.y,-this.x)}}function sc(t,n,e,r){const i=n.x*r.y-n.y*r.x,s=e.x-t.x,o=e.y-t.y,a=(s*r.y-o*r.x)/i;return new ic(t.x+a*n.x,t.y+a*n.y)}const oc=[],ac=[];function uc(t){if(P(t[0]&&t[0].x)){const n=[];let e=0;for(let r=0;r<t.length;r++)ac[e]?(ac[e][0]=t[r].x,ac[e][1]=t[r].y):ac[e]=[t[r].x,t[r].y],n.push(ac[e]),e++;t=n}try{const n=Gh(t,1/0);let e=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<n.length;t++)n[t][0]<e[0]&&(e[0]=n[t][0]),n[t][0]>r[0]&&(r[0]=n[t][0]),n[t][1]<e[1]&&(e[1]=n[t][1]),n[t][1]>r[1]&&(r[1]=n[t][1]);const i=[];let s=[],o=0;for(let t=0;t<n.length;t++)t===n.length-1&&n[t][0]===n[0][0]&&n[t][1]===n[0][1]||(Pt(i,n[t],"EPSG:3857"),oc[o]?(oc[o].x=i[0],oc[o].y=i[1]):oc[o]=new ic(i[0],i[1]),s.push(oc[o]),o++);An(s)<0&&(s=s.reverse());const a=function(t){let n,e=Number.MAX_VALUE;const r=function(t,r,i,s,o,a,u,l){var h=sc(t,r,o,a),c=sc(i,s,o,a),f=sc(u,l,t,r),d=sc(u,l,i,s),p=h.distance(c)*h.distance(f);0!==p&&p<e&&(n=[h,f,d,c],e=p)};var i=[];for(let n=0;n<t.length;n++)i.push(t[(n+1)%t.length].diff(t[n])),i[n].normalize();var s,o,a,u,l=new ic(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new ic(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let n=0;n<t.length;n++){var c=t[n];c.x<l.x&&(l.x=c.x,s=n),c.x>h.x&&(h.x=c.x,o=n),c.y<l.y&&(l.y=c.y,u=n),c.y>h.y&&(h.y=c.y,a=n)}var f=new ic(0,-1),d=new ic(0,1),p=new ic(-1,0),y=new ic(1,0);for(let n=0;n<t.length;n++){var m=[Math.acos(f.dot(i[s])),Math.acos(d.dot(i[o])),Math.acos(p.dot(i[a])),Math.acos(y.dot(i[u]))];switch(m.indexOf(Math.min.apply(Math,m))){case 0:(d=(f=i[s].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 1:(f=(d=i[o].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 2:(y=(p=i[a].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(p=(y=i[u].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),u=(u+1)%t.length}r(t[s],f,t[o],d,t[a],p,t[u],y)}return n}(s);if(!a||4!==a.length)return null;const u=a[0].distance(a[1]),l=a[1].distance(a[2]),h=a.map((t=>[t.x,t.y]));return h.push(+(l>u)),h}catch(t){return null}}const lc=[];function hc(t,n){const e=Array.isArray(t&&t[0]&&t[0][0]);for(let r=0;r<t.length;r++)e?t[r]=hc(t[r]):(Pt(lc,t[r],n),t[r][0]=lc[0],t[r][1]=lc[1]);return t}class cc extends Vl{constructor(t,n,e,r,i,s){super(t,n,e,r,i),(n=n||{}).extent||(n.extent=8192),this.setData(n.data,s)}setData(t,n){if(delete this.index,function(t){if(!t)return!0;if(Array.isArray(t)&&!t.length)return!0;if(t.features&&!t.features.length)return!0;return!1}(t))return this.empty=!0,void n();const e={maxZoom:24,tolerance:this.options.simplifyTolerance,extent:this.options.extent,buffer:P(this.options.tileBuffer)?this.options.tileBuffer:64,hasAltitude:!!this.options.hasAltitude,debug:0,lineMetrics:!0,indexMaxZoom:5,indexMaxPoints:1e5,disableFilter:!0};if(this.options.projection&&(e.projection=this.options.projection,"EPSG:4490"===e.projection&&(e.projection="EPSG:4326")),A(t)&&"{"!=t.substring(0,1)||t.url){const r=t.url?t.url:t;$.getJSON(r,t.url?t:{},((t,i)=>{if(t&&(console.error("Failed to fetch geojson:"+r),n(t)),!i)return void n(null,{extent:null,idMap:{}});let s=i;if(this.options.convertFn){s=new Function("data",this.options.convertFn+"\\nreturn convert(data)")(s)}const o=Array.isArray(s)?s:s.features;this.Sn(o);const{sample1000:a,idMap:u}=this._n(o);this.On(a,u,s,e,n)}))}else{"string"==typeof t&&(t=JSON.parse(t));const r=Array.isArray(t)?t:t.features,i=r&&r.length;this.Sn(r);let s=r;if(r&&i>1e3){s=[];for(let t=0;t<i;t++)fc(r[t],s,t,i)}this.On(s,null,t,e,n)}}Sn(t){if(this.options.generateOMBB&&t)for(let n=0;n<t.length;n++){const e=t[n];if(e&&e.geometry&&e.geometry.coordinates)if("Polygon"===e.geometry.type){const t=e.geometry.coordinates[0];if(!t)continue;const n=uc(t,t.length);e.properties=e.properties||{},e.properties[_l]=n}else if("MultiPolygon"===e.geometry.type){const t=e.geometry.coordinates;for(let n=0;n<t.length;n++){if(!t[n])continue;const r=t[n][0];if(!r)continue;const i=uc(r,r.length);e.properties=e.properties||{},e.properties[_l]=e.properties[_l]||[],e.properties[_l][n]=i}}}}On(t,n,e,r,i){try{const s=t&&t.length?function(t){let n=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(t.type){case"FeatureCollection":const e=t.features.length;for(let r=0;r<e;r++)ih(t.features[r],n);break;case"Feature":ih(t,n);break;default:sh(t,n)}return n}({type:"FeatureCollection",features:t}):null;this.index=function(t,n){return new ut(t,n)}(e,this.options.geojsonvt||r),i(null,{extent:s,idMap:n})}catch(t){console.warn(t),i({error:t.message})}}_n(t){const n=[],e={};let r=0;const i=this.options.featureIdProperty;if(t){const s=t.length;t.forEach(((t,o)=>{!function(t,s,o){if(t&&("Feature"!==t.type||t.geometry)){if(P(t.id)||(t.id=r++),i){let n=i;_(i)&&(n=i[t.layer||"0"]),t.id=t.properties[n]}e[t.id]=k({},t),t.geometry?(e[t.id].geometry=k({},t.geometry),e[t.id].geometry.coordinates=null):t.coordinates&&(e[t.id].coordinates=null),fc(t,n,s,o)}}(t,o,s)}))}return{sample1000:n,idMap:e}}getTileFeatures(t,n){const e=t.tileInfo,r=[];if(!this.index)return this.empty?(setTimeout((function(){n(null,r,[])}),1),1):(setTimeout((function(){n({loading:!0})}),1),1);const i=this.index.getTile(e.z,e.x,e.y);if(!i||0===i.features.length)return setTimeout((function(){n(null,r,[])}),1),1;const s=[];for(let t=0,n=i.features.length;t<n;t++){const n=i.features[t];let e=n.layer;void 0===e&&(e="0"),s[e]={types:{}};s[e].types[n.type]=1,n.tags=n.tags||{},n.geometry.converted||(Rn(n),n.geometry.converted=1),r.push({type:n.type,layer:e,id:n.id,geometry:n.geometry,properties:n.tags,extent:this.options.extent})}for(const t in s)s[t].types=Object.keys(s[t].types).map((t=>+t));return setTimeout((function(){n(null,r,s)}),1),1}onRemove(){super.onRemove(),delete this.index}}function fc(t,n,e,r){const i=Math.floor(r/998);(0===e||e===r-1||(0===i||e%i==0)&&n.length<999)&&n.push(t)}var dc={\n/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\nread:function(t,n,e,r,i){var s,o,a=8*i-r-1,u=(1<<a)-1,l=u>>1,h=-7,c=e?i-1:0,f=e?-1:1,d=t[n+c];for(c+=f,s=d&(1<<-h)-1,d>>=-h,h+=a;h>0;s=256*s+t[n+c],c+=f,h-=8);for(o=s&(1<<-h)-1,s>>=-h,h+=r;h>0;o=256*o+t[n+c],c+=f,h-=8);if(0===s)s=1-l;else{if(s===u)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},write:function(t,n,e,r,i,s){var o,a,u,l=8*s-i-1,h=(1<<l)-1,c=h>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,p=r?1:-1,y=n<0||0===n&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(a=isNaN(n)?1:0,o=h):(o=Math.floor(Math.log(n)/Math.LN2),n*(u=Math.pow(2,-o))<1&&(o--,u*=2),(n+=o+c>=1?f/u:f*Math.pow(2,1-c))*u>=2&&(o++,u/=2),o+c>=h?(a=0,o=h):o+c>=1?(a=(n*u-1)*Math.pow(2,i),o+=c):(a=n*Math.pow(2,c-1)*Math.pow(2,i),o=0));i>=8;t[e+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;t[e+d]=255&o,d+=p,o/=256,l-=8);t[e+d-p]|=128*y}},pc=mc,yc=dc;function mc(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}mc.Varint=0,mc.Fixed64=1,mc.Bytes=2,mc.Fixed32=5;var gc=4294967296,vc=1/gc,bc="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function wc(t){return t.type===mc.Bytes?t.readVarint()+t.pos:t.pos+1}function Mc(t,n,e){return e?4294967296*n+(t>>>0):4294967296*(n>>>0)+(t>>>0)}function xc(t,n,e){var r=n<=16383?1:n<=2097151?2:n<=268435455?3:Math.floor(Math.log(n)/(7*Math.LN2));e.realloc(r);for(var i=e.pos-1;i>=t;i--)e.buf[i+r]=e.buf[i]}function Fc(t,n){for(var e=0;e<t.length;e++)n.writeVarint(t[e])}function kc(t,n){for(var e=0;e<t.length;e++)n.writeSVarint(t[e])}function Ac(t,n){for(var e=0;e<t.length;e++)n.writeFloat(t[e])}function Pc(t,n){for(var e=0;e<t.length;e++)n.writeDouble(t[e])}function Sc(t,n){for(var e=0;e<t.length;e++)n.writeBoolean(t[e])}function _c(t,n){for(var e=0;e<t.length;e++)n.writeFixed32(t[e])}function Oc(t,n){for(var e=0;e<t.length;e++)n.writeSFixed32(t[e])}function Cc(t,n){for(var e=0;e<t.length;e++)n.writeFixed64(t[e])}function Ec(t,n){for(var e=0;e<t.length;e++)n.writeSFixed64(t[e])}function $c(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+16777216*t[n+3]}function Ic(t,n,e){t[e]=n,t[e+1]=n>>>8,t[e+2]=n>>>16,t[e+3]=n>>>24}function zc(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+(t[n+3]<<24)}mc.prototype={destroy:function(){this.buf=null},readFields:function(t,n,e){for(e=e||this.length;this.pos<e;){var r=this.readVarint(),i=r>>3,s=this.pos;this.type=7&r,t(i,n,this),this.pos===s&&this.skip(r)}return n},readMessage:function(t,n){return this.readFields(t,n,this.readVarint()+this.pos)},readFixed32:function(){var t=$c(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=zc(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=$c(this.buf,this.pos)+$c(this.buf,this.pos+4)*gc;return this.pos+=8,t},readSFixed64:function(){var t=$c(this.buf,this.pos)+zc(this.buf,this.pos+4)*gc;return this.pos+=8,t},readFloat:function(){var t=yc.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=yc.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var n,e,r=this.buf;return n=127&(e=r[this.pos++]),e<128?n:(n|=(127&(e=r[this.pos++]))<<7,e<128?n:(n|=(127&(e=r[this.pos++]))<<14,e<128?n:(n|=(127&(e=r[this.pos++]))<<21,e<128?n:function(t,n,e){var r,i,s=e.buf;if(i=s[e.pos++],r=(112&i)>>4,i<128)return Mc(t,r,n);if(i=s[e.pos++],r|=(127&i)<<3,i<128)return Mc(t,r,n);if(i=s[e.pos++],r|=(127&i)<<10,i<128)return Mc(t,r,n);if(i=s[e.pos++],r|=(127&i)<<17,i<128)return Mc(t,r,n);if(i=s[e.pos++],r|=(127&i)<<24,i<128)return Mc(t,r,n);if(i=s[e.pos++],r|=(1&i)<<31,i<128)return Mc(t,r,n);throw new Error("Expected varint not more than 10 bytes")}(n|=(15&(e=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,n=this.pos;return this.pos=t,t-n>=12&&bc?function(t,n,e){return bc.decode(t.subarray(n,e))}(this.buf,n,t):function(t,n,e){var r="",i=n;for(;i<e;){var s,o,a,u=t[i],l=null,h=u>239?4:u>223?3:u>191?2:1;if(i+h>e)break;1===h?u<128&&(l=u):2===h?128==(192&(s=t[i+1]))&&(l=(31&u)<<6|63&s)<=127&&(l=null):3===h?(s=t[i+1],o=t[i+2],128==(192&s)&&128==(192&o)&&((l=(15&u)<<12|(63&s)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===h&&(s=t[i+1],o=t[i+2],a=t[i+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&((l=(15&u)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,h=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),i+=h}return r}(this.buf,n,t)},readBytes:function(){var t=this.readVarint()+this.pos,n=this.buf.subarray(this.pos,t);return this.pos=t,n},readPackedVarint:function(t,n){if(this.type!==mc.Bytes)return t.push(this.readVarint(n));var e=wc(this);for(t=t||[];this.pos<e;)t.push(this.readVarint(n));return t},readPackedSVarint:function(t){if(this.type!==mc.Bytes)return t.push(this.readSVarint());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==mc.Bytes)return t.push(this.readBoolean());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==mc.Bytes)return t.push(this.readFloat());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==mc.Bytes)return t.push(this.readDouble());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==mc.Bytes)return t.push(this.readFixed32());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==mc.Bytes)return t.push(this.readSFixed32());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==mc.Bytes)return t.push(this.readFixed64());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==mc.Bytes)return t.push(this.readSFixed64());var n=wc(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed64());return t},skip:function(t){var n=7&t;if(n===mc.Varint)for(;this.buf[this.pos++]>127;);else if(n===mc.Bytes)this.pos=this.readVarint()+this.pos;else if(n===mc.Fixed32)this.pos+=4;else{if(n!==mc.Fixed64)throw new Error("Unimplemented type: "+n);this.pos+=8}},writeTag:function(t,n){this.writeVarint(t<<3|n)},realloc:function(t){for(var n=this.length||16;n<this.pos+t;)n*=2;if(n!==this.length){var e=new Uint8Array(n);e.set(this.buf),this.buf=e,this.length=n}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Ic(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Ic(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Ic(this.buf,-1&t,this.pos),Ic(this.buf,Math.floor(t*vc),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Ic(this.buf,-1&t,this.pos),Ic(this.buf,Math.floor(t*vc),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,n){var e,r;t>=0?(e=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(e=~(-t%4294967296))?e=e+1|0:(e=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),function(t,n,e){e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos]=127&t}(e,0,n),function(t,n){var e=(7&t)<<4;if(n.buf[n.pos++]|=e|((t>>>=3)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;n.buf[n.pos++]=127&t}(r,n)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var n=this.pos;this.pos=function(t,n,e){for(var r,i,s=0;s<n.length;s++){if((r=n.charCodeAt(s))>55295&&r<57344){if(!i){r>56319||s+1===n.length?(t[e++]=239,t[e++]=191,t[e++]=189):i=r;continue}if(r<56320){t[e++]=239,t[e++]=191,t[e++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[e++]=239,t[e++]=191,t[e++]=189,i=null);r<128?t[e++]=r:(r<2048?t[e++]=r>>6|192:(r<65536?t[e++]=r>>12|224:(t[e++]=r>>18|240,t[e++]=r>>12&63|128),t[e++]=r>>6&63|128),t[e++]=63&r|128)}return e}(this.buf,t,this.pos);var e=this.pos-n;e>=128&&xc(n,e,this),this.pos=n-1,this.writeVarint(e),this.pos+=e},writeFloat:function(t){this.realloc(4),yc.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),yc.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var n=t.length;this.writeVarint(n),this.realloc(n);for(var e=0;e<n;e++)this.buf[this.pos++]=t[e]},writeRawMessage:function(t,n){this.pos++;var e=this.pos;t(n,this);var r=this.pos-e;r>=128&&xc(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,n,e){this.writeTag(t,mc.Bytes),this.writeRawMessage(n,e)},writePackedVarint:function(t,n){n.length&&this.writeMessage(t,Fc,n)},writePackedSVarint:function(t,n){n.length&&this.writeMessage(t,kc,n)},writePackedBoolean:function(t,n){n.length&&this.writeMessage(t,Sc,n)},writePackedFloat:function(t,n){n.length&&this.writeMessage(t,Ac,n)},writePackedDouble:function(t,n){n.length&&this.writeMessage(t,Pc,n)},writePackedFixed32:function(t,n){n.length&&this.writeMessage(t,_c,n)},writePackedSFixed32:function(t,n){n.length&&this.writeMessage(t,Oc,n)},writePackedFixed64:function(t,n){n.length&&this.writeMessage(t,Cc,n)},writePackedSFixed64:function(t,n){n.length&&this.writeMessage(t,Ec,n)},writeBytesField:function(t,n){this.writeTag(t,mc.Bytes),this.writeBytes(n)},writeFixed32Field:function(t,n){this.writeTag(t,mc.Fixed32),this.writeFixed32(n)},writeSFixed32Field:function(t,n){this.writeTag(t,mc.Fixed32),this.writeSFixed32(n)},writeFixed64Field:function(t,n){this.writeTag(t,mc.Fixed64),this.writeFixed64(n)},writeSFixed64Field:function(t,n){this.writeTag(t,mc.Fixed64),this.writeSFixed64(n)},writeVarintField:function(t,n){this.writeTag(t,mc.Varint),this.writeVarint(n)},writeSVarintField:function(t,n){this.writeTag(t,mc.Varint),this.writeSVarint(n)},writeStringField:function(t,n){this.writeTag(t,mc.Bytes),this.writeString(n)},writeFloatField:function(t,n){this.writeTag(t,mc.Fixed32),this.writeFloat(n)},writeDoubleField:function(t,n){this.writeTag(t,mc.Fixed64),this.writeDouble(n)},writeBooleanField:function(t,n){this.writeVarintField(t,Boolean(n))}};var Dc=Et(pc),Tc=an,Uc=jc;function jc(t,n,e,r,i){this.properties={},this.extent=e,this.type=0,this.Cn=t,this.En=-1,this.$n=r,this.In=i,t.readFields(Nc,this,n)}function Nc(t,n,e){1==t?n.id=e.readVarint():2==t?function(t,n){var e=t.readVarint()+t.pos;for(;t.pos<e;){var r=n.$n[t.readVarint()],i=n.In[t.readVarint()];n.properties[r]=i}}(e,n):3==t?n.type=e.readVarint():4==t&&(n.En=e.pos)}function Lc(t){for(var n,e,r=0,i=0,s=t.length,o=s-1;i<s;o=i++)n=t[i],r+=((e=t[o]).x-n.x)*(n.y+e.y);return r}jc.types=["Unknown","Point","LineString","Polygon"],jc.prototype.loadGeometry=function(){var t=this.Cn;t.pos=this.En;for(var n,e=t.readVarint()+t.pos,r=1,i=0,s=0,o=0,a=[];t.pos<e;){if(i<=0){var u=t.readVarint();r=7&u,i=u>>3}if(i--,1===r||2===r)s+=t.readSVarint(),o+=t.readSVarint(),1===r&&(n&&a.push(n),n=[]),n.push(new Tc(s,o));else{if(7!==r)throw new Error("unknown command "+r);n&&n.push(n[0].clone())}}return n&&a.push(n),a},jc.prototype.bbox=function(){var t=this.Cn;t.pos=this.En;for(var n=t.readVarint()+t.pos,e=1,r=0,i=0,s=0,o=1/0,a=-1/0,u=1/0,l=-1/0;t.pos<n;){if(r<=0){var h=t.readVarint();e=7&h,r=h>>3}if(r--,1===e||2===e)(i+=t.readSVarint())<o&&(o=i),i>a&&(a=i),(s+=t.readSVarint())<u&&(u=s),s>l&&(l=s);else if(7!==e)throw new Error("unknown command "+e)}return[o,u,a,l]},jc.prototype.toGeoJSON=function(t,n,e){var r,i,s=this.extent*Math.pow(2,e),o=this.extent*t,a=this.extent*n,u=this.loadGeometry(),l=jc.types[this.type];function h(t){for(var n=0;n<t.length;n++){var e=t[n],r=180-360*(e.y+a)/s;t[n]=[360*(e.x+o)/s-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var c=[];for(r=0;r<u.length;r++)c[r]=u[r][0];h(u=c);break;case 2:for(r=0;r<u.length;r++)h(u[r]);break;case 3:for(u=function(t){var n=t.length;if(n<=1)return[t];for(var e,r,i=[],s=0;s<n;s++){var o=Lc(t[s]);0!==o&&(void 0===r&&(r=o<0),r===o<0?(e&&i.push(e),e=[t[s]]):e.push(t[s]))}e&&i.push(e);return i}(u),r=0;r<u.length;r++)for(i=0;i<u[r].length;i++)h(u[r][i])}1===u.length?u=u[0]:l="Multi"+l;var f={type:"Feature",geometry:{type:l,coordinates:u},properties:this.properties};return"id"in this&&(f.id=this.id),f};var Hc=Uc,Rc=Vc;function Vc(t,n){this.version=1,this.name=null,this.extent=4096,this.length=0,this.Cn=t,this.$n=[],this.In=[],this.zn=[],t.readFields(qc,this,n),this.length=this.zn.length}function qc(t,n,e){15===t?n.version=e.readVarint():1===t?n.name=e.readString():5===t?n.extent=e.readVarint():2===t?n.zn.push(e.pos):3===t?n.$n.push(e.readString()):4===t&&n.In.push(function(t){var n=null,e=t.readVarint()+t.pos;for(;t.pos<e;){var r=t.readVarint()>>3;n=1===r?t.readString():2===r?t.readFloat():3===r?t.readDouble():4===r?t.readVarint64():5===r?t.readVarint():6===r?t.readSVarint():7===r?t.readBoolean():null}return n}(e))}Vc.prototype.feature=function(t){if(t<0||t>=this.zn.length)throw new Error("feature index out of bounds");this.Cn.pos=this.zn[t];var n=this.Cn.readVarint()+this.Cn.pos;return new Hc(this.Cn,n,this.extent,this.$n,this.In)};var Gc=Rc,Jc=function(t,n){this.layers=t.readFields(Wc,{},n)};function Wc(t,n,e){if(3===t){var r=new Gc(e,e.readVarint()+e.pos);r.length&&(n[r.name]=r)}}var Bc=Jc;class Xc extends Vl{constructor(t,n,e,r,i,s){super(t,n,e,r,i),n=n||{},s()}getTileFeatures(t,n){const e=t.tileInfo.url,r=t.fetchOptions||{},i=this.qt.get(e);if(i&&i.cacheIndex===t.workerCacheIndex){const{err:t,data:r}=i;return setTimeout((()=>{this.Dn(e,t,r,n)}),1)}return r.referrer=t.referrer,$.getArrayBuffer(e,r,((r,i)=>{this.qt&&(r?r.loading||this.qt.add(e,{err:r,data:i&&i.data,cacheIndex:t.workerCacheIndex}):i&&i.data&&this.qt.add(e,{err:null,data:i.data,cacheIndex:t.workerCacheIndex}),this.Dn(e,r,i&&i.data,n))}))}Dn(t,n,e,r){if(n)return void r(n);let i;try{i=new Bc(new Dc(e))}catch(n){return void r(n.message,[],[])}const s=[];if(!i.layers)return void r(null,s,[]);const o={};let a;for(const t in i.layers)if(u=i.layers,l=t,Object.prototype.hasOwnProperty.call(u,l)){o[t]={types:{}};const e=o[t].types;for(let r=0,o=i.layers[t].length;r<o;r++)try{a=i.layers[t].feature(r),e[a.type]=1;const n={type:a.type,layer:t,geometry:a.loadGeometry(),properties:a.properties,extent:a.extent};void 0!==a.id&&(n.id=a.id);let o=n.properties[_l];o&&(A(o)&&(o=JSON.parse(o)),n.properties[_l]=hc(o,"EPSG:3857")),s.push(n)}catch(n){console.warn("error when load vt geometry:",n)}}var u,l;for(const t in o)o[t].types=Object.keys(o[t].types).map((t=>+t));r(null,s,o,{byteLength:e.byteLength})}abortTile(t,n){const e=this.requests[t];delete this.requests[t],e&&e.abort&&e.abort(),this.sn(t),n()}onRemove(){super.onRemove();for(const t in this.requests){const n=this.requests[t];n&&n.abort&&n.abort()}this.requests={}}}let Yc=0;const Kc=new vl(128);class Zc{constructor(t){this.Tn={},this.Un={},this.workerId=t}addLayer({actorId:t,mapId:n,layerId:e,params:r},i){if(this.jn(n,e))return;const s=this.Nn(n,e),o=r.type,a=r.options,u=this.send.bind(this,t);this.Tn[s]="GeoJSONVectorTileLayer"===o?new cc(e,a,u,Kc,{},i):new Xc(e,a,u,Kc,{},i)}removeLayer({mapId:t,layerId:n},e){const r=this.jn(t,n),i=this.Nn(t,n);delete this.Tn[i],r&&r.onRemove(e)}loadTile({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.loadTile(e,r)}abortTile({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.abortTile&&i.abortTile(e.url,r)}removeTile({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.removeTile(e,r)}updateStyle({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.updateStyle(e,r)}updateOptions({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.updateOptions(e,r)}setData({mapId:t,layerId:n,params:e},r){const i=this.jn(t,n);i&&i.setData(e.data,r)}receive(t){const n=t.callback,e=this.Un[n];delete this.Un[n],e&&t.error?e(new Error(t.error)):e&&e(null,t.data)}send(t,n,e,r,i){const s=i?\`${bk}t}-${bk}Yc++}\`:null;i&&(this.Un[s]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:n,params:e,callback:String(s)},r||[])}Nn(t,n){return\`${bk}t}-${bk}n}\`}jn(t,n){const e=this.Nn(t,n);return this.Tn[e]}Ln(){Kc.reset()}}t.initialize=function(){},t.onmessage=function(t,n){const e=t.data;if(this.dispatcher||(this.dispatcher=new Zc(t.workerId)),"<response>"===t.type)this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t);else{const r=e.command;this.dispatcher[r]({actorId:t.actorId,mapId:e.mapId,layerId:e.layerId,params:e.params},((t,e,i)=>{t&&404!==t.status&&204!==t.status&&!t.loading&&console.error(r,t),n(t,e,i)}))}}}`;var Tk=Mk;function Mk(t,e){this.x=t,this.y=e}Mk.prototype={clone:function(){return new Mk(this.x,this.y)},add:function(t){return this.clone().i(t)},sub:function(t){return this.clone().o(t)},multByPoint:function(t){return this.clone().u(t)},divByPoint:function(t){return this.clone().m(t)},mult:function(t){return this.clone().A(t)},div:function(t){return this.clone().M(t)},rotate:function(t){return this.clone().S(t)},rotateAround:function(t,e){return this.clone().k(t,e)},matMult:function(t){return this.clone().P(t)},unit:function(){return this.clone().T()},perp:function(){return this.clone().I()},round:function(){return this.clone().F()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},P:function(t){var e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},i:function(t){return this.x+=t.x,this.y+=t.y,this},o:function(t){return this.x-=t.x,this.y-=t.y,this},A:function(t){return this.x*=t,this.y*=t,this},M:function(t){return this.x/=t,this.y/=t,this},u:function(t){return this.x*=t.x,this.y*=t.y,this},m:function(t){return this.x/=t.x,this.y/=t.y,this},T:function(){return this.M(this.mag()),this},I:function(){var t=this.y;return this.y=this.x,this.x=-t,this},S:function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},k:function(t,e){var n=Math.cos(t),r=Math.sin(t),i=e.x+n*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=i,this.y=o,this},F:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Mk.convert=function(t){return t instanceof Mk?t:Array.isArray(t)?new Mk(t[0],t[1]):t};var Ck=function(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}(Tk);const Sk={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function Ik(t,e={}){var n=[];if("FeatureCollection"===t.type)for(var r=0;r<t.features.length;r++)Pk(n,t.features[r],e,r);else"Feature"===t.type?Pk(n,t,e):Pk(n,{geometry:t},e);return n}function Pk(t,e,n,r){if(e.geometry&&e.geometry.geometry){var i=e.geometry.coordinates,o=e.geometry.type,s=[],a=e.id;if(n.promoteId?a=e.properties[n.promoteId]:n.generateId&&(a=r||0),"Point"===o)Ek(i,s);else if("MultiPoint"===o)for(var l=0;l<i.length;l++)Ek(i[l],s);else if("LineString"===o)Rk([i],s);else if("MultiLineString"===o){if(n.lineMetrics){for(l=0;l<i.length;l++)s=[],Ok(i[l],s),t.push(kk(a,"LineString",s,e.properties));return}Rk(i,s)}else if("Polygon"===o)Rk(i,s);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(l=0;l<e.geometry.geometries.length;l++)Pk(t,{id:a,geometry:e.geometry.geometries[l],properties:e.properties},n,r);return}return void console.warn(`Input data type(${o}) is not a valid GeoJSON geometry type.`)}for(l=0;l<i.length;l++){var h=[];Rk(i[l],h),s.push(h)}}t.push(kk(a,o,s,e.properties))}}function Ek(t,e){const n=new Ck(t[0],t[1]);n.z=100*(t[2]||0),e.push([n])}function Ok(t,e){for(let n=0;n<t.length;n++){const r=t[n][0],i=t[n][1],o=new Ck(r,i);o.z=100*(t[n][2]||0),e.push(o)}}function Rk(t,e,n,r){for(var i=0;i<t.length;i++){var o=[];Ok(t[i],o),e.push(o)}}function kk(t,e,n,r){return{id:void 0===t?null:t,type:Sk[e],geometry:n,properties:r}}function Lk(t,e,n){n=n||{},this.w=t||64,this.h=e||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function Dk(t,e,n){this.x=0,this.y=t,this.w=this.free=e,this.h=n}function Nk(t,e,n,r,i,o,s){this.id=t,this.x=e,this.y=n,this.w=r,this.h=i,this.maxw=o||r,this.maxh=s||i,this.refcount=0}function Fk(t,{width:e,height:n},r,i){if(i){if(i.length!==e*n*r)throw new RangeError("mismatched image size")}else i=new Uint8Array(e*n*r);return t.width=e,t.height=n,t.data=i,t}function zk(t,{width:e,height:n},r){if(e===t.width&&n===t.height)return;const i=Fk({},{width:e,height:n},r);Bk(t,i,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,n)},r),t.width=e,t.height=n,t.data=i.data}function Bk(t,e,n,r,i,o){if(0===i.width||0===i.height)return e;if(i.width>t.width||i.height>t.height||n.x>t.width-i.width||n.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>e.width||i.height>e.height||r.x>e.width-i.width||r.y>e.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const s=t.data,a=e.data;if(s===a)return e;for(let l=0;l<i.height;l++){const h=((n.y+l)*t.width+n.x)*o,u=((r.y+l)*e.width+r.x)*o;for(let t=0;t<i.width*o;t++)a[u+t]=s[h+t]}return e}Lk.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var n,r,i,o,s=[],a=0;a<t.length;a++)if(n=t[a].w||t[a].width,r=t[a].h||t[a].height,i=t[a].id,n&&r){if(!(o=this.packOne(n,r,i)))continue;e.inPlace&&(t[a].x=o.x,t[a].y=o.y,t[a].id=o.id),s.push(o)}return this.shrink(),s},Lk.prototype.packOne=function(t,e,n){var r,i,o,s,a,l,h,u,c={freebin:-1,shelf:-1,waste:1/0},f=0;if("string"==typeof n||"number"==typeof n){if(r=this.getBin(n))return this.ref(r),r;"number"==typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(s=0;s<this.freebins.length;s++){if(e===(r=this.freebins[s]).maxh&&t===r.maxw)return this.allocFreebin(s,t,e,n);e>r.maxh||t>r.maxw||e<=r.maxh&&t<=r.maxw&&(o=r.maxw*r.maxh-t*e)<c.waste&&(c.waste=o,c.freebin=s)}for(s=0;s<this.shelves.length;s++)if(f+=(i=this.shelves[s]).h,!(t>i.free)){if(e===i.h)return this.allocShelf(s,t,e,n);e>i.h||e<i.h&&(o=(i.h-e)*t)<c.waste&&(c.freebin=-1,c.waste=o,c.shelf=s)}return-1!==c.freebin?this.allocFreebin(c.freebin,t,e,n):-1!==c.shelf?this.allocShelf(c.shelf,t,e,n):e<=this.h-f&&t<=this.w?(i=new Dk(f,this.w,e),this.allocShelf(this.shelves.push(i)-1,t,e,n)):this.autoResize?(a=l=this.h,((h=u=this.w)<=a||t>h)&&(u=2*Math.max(t,h)),(a<h||e>a)&&(l=2*Math.max(e,a)),this.resize(u,l),this.packOne(t,e,n)):null},Lk.prototype.allocFreebin=function(t,e,n,r){var i=this.freebins.splice(t,1)[0];return i.id=r,i.w=e,i.h=n,i.refcount=0,this.bins[r]=i,this.ref(i),i},Lk.prototype.allocShelf=function(t,e,n,r){var i=this.shelves[t].alloc(e,n,r);return this.bins[r]=i,this.ref(i),i},Lk.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,n=0;n<this.shelves.length;n++){var r=this.shelves[n];e+=r.h,t=Math.max(r.w-r.free,t)}this.resize(t,e)}},Lk.prototype.getBin=function(t){return this.bins[t]},Lk.prototype.ref=function(t){if(1==++t.refcount){var e=t.h;this.stats[e]=1+(0|this.stats[e])}return t.refcount},Lk.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},Lk.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},Lk.prototype.resize=function(t,e){this.w=t,this.h=e;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(t);return!0},Dk.prototype.alloc=function(t,e,n){if(t>this.free||e>this.h)return null;var r=this.x;return this.x+=t,this.free-=t,new Nk(n,r,this.y,t,e,t,this.h)},Dk.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};let Hk=class t{constructor(t,e){Fk(this,t,1,e)}resize(t){zk(this,t,1)}clone(){return new t({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,r,i){Bk(t,e,n,r,i,1)}},jk=class t{constructor(t,e){Fk(this,t,4,e)}resize(t){zk(this,t,4)}clone(){return new t({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,r,i){Bk(t,e,n,r,i,4)}};function Uk(t){let e=0;for(let n,r,i=0,o=t.length,s=o-1;i<o;s=i++)if(n=t[i],r=t[s],void 0!==n.x){if(n.z||r.z)return 1;e+=(r.x-n.x)*(n.y+r.y)}else{if(n[2]||r[2])return 1;e+=(r[0]-n[0])*(n[1]+r[1])}return e}function Vk(t,e,n){let r=n;return e&&t&&(r=+t[e]),isNaN(r)&&(r=n||0),100*r}function Gk(t,e,n,r,i,o,s){e||0===e||(e=1);const a=Vk(t.properties,n,r),l=a*e;let h=(o?100*o:0)||a;return i?h=Vk(t.properties,i,o):s&&(h=a-Vk(t.properties,s,o)),h*=e,{altitude:l,height:h}}function Wk(t,e){return e<1/0&&(t.x<0||t.x>e||t.y<0||t.y>e)}function qk(t){return null==t}function Xk(t,e,n){if(t===n||t===e)return t;const r=n-e;return((t-e)%r+r)%r+e}function Zk(t,e){if(!e)return null;const n=new Map;for(let r=0;r<e.length;r++){const i=e[r],o=t[i];let s=n.get(o);s||(s=[],n.set(o,s)),s.push(i)}return n}function Yk(t){return!(t&t-1)&&0!==t}let Jk=class{constructor(t,e,{pixelRatio:n}){this.paddedRect=t,this.pixelRatio=n||1,this.padding=e}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}},Qk=class{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e=Object.keys(t).length,n={},r=new Lk(0,0,{autoResize:!0}),i=[],o=e>1?1:0;for(const a in t){const e=t[a],r={x:0,y:0,w:e.data.width+2*o,h:e.data.height+2*o};i.push(r),n[a]=new Jk(r,o,e)}if(r.pack(i,{inPlace:!0}),!Yk(r.w)||!Yk(r.h)){const t=Kk(r.w),e=Kk(r.h);r.resize(t,e)}const s=new jk({width:r.w,height:r.h});for(const a in t){const e=t[a],r=n[a].paddedRect;jk.copy(e.data,s,{x:0,y:0},{x:r.x+o,y:r.y+o},e.data)}this.image=s,this.positions=n}};function Kk(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}let $k=class{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e={},n=new Lk(0,0,{autoResize:!0}),r=[];for(const o in t){const n=t[o],i=e[o]={};for(const t in n){const e=n[+t];if(!e||0===e.bitmap.width||0===e.bitmap.height)continue;const o={x:0,y:0,w:e.bitmap.width+2,h:e.bitmap.height+2};r.push(o),i[t]={rect:o,metrics:e.metrics}}}n.pack(r,{inPlace:!0});const i=new Hk({width:n.w,height:n.h});for(const o in t){const n=t[o];for(const t in n){const r=n[+t];if(!r||0===r.bitmap.width||0===r.bitmap.height)continue;const s=e[o][t].rect;Hk.copy(r.bitmap,i,{x:0,y:0},{x:s.x+1,y:s.y+1},r.bitmap)}}this.image=i,this.positions=e}};function tL(t){return t<65536?Uint16Array:Uint32Array}function eL(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function nL(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function rL(t,e){const n=t.getLength?t.getLength():t.length;if(t instanceof e)return t.slice(0,n);const r=new e(n);t=t.C||t;for(let i=0;i<n;i++)r[i]=t[i]||0;return r}function iL(t){const e=t.type,n=[];if(1===e||4===e)for(let r=0;r<t.geometry.length;r++)Ek(t.geometry[r],n);else if(2===e)Rk(t.geometry,n);else if(3===e)Rk(t.geometry,n);else if(5===e)Rk(t.geometry,n);else if(6===e)for(let r=0;r<t.geometry.length;r++){const e=[];Rk(t.geometry[r],e),n.push(e)}return t.geometry=n,t}function oL(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function sL(t){return null==t}function aL(t){return"number"==typeof t&&!isNaN(t)}function lL(t){return"object"==typeof t&&!!t}function hL(t){return!sL(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}const uL=Object.prototype.hasOwnProperty;function cL(t,e){return uL.call(t,e)}function fL(t){return t&&nO(t)&&t.property}const dL={};function pL(t,e){if(!Array.isArray(e)){if(e&&void 0!==e.r&&void 0!==e.g&&void 0!==e.b)return t[0]=255*e.r,t[1]=255*e.g,t[2]=255*e.b,void 0!==e.a?t[3]=255*e.a:t[3]=255,t;const n=e;e=dL[n]=dL[n]||JO(e).unitArray()}for(let n=0;n<e.length;n++)t[n]=255*e[n];return 3===e.length&&(t[3]=255),t}const gL={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1};let mL=class{constructor(t,e,n,r){this.feature=t,this.symbol=e,this.fnTypes=n,this.options=r}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:e}=this.fnTypes,n=e;return this.O(t,n)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:e}=this.fnTypes,n=e;return this.O(t,n)}O(t,e){if(e){const n=this.feature.properties;t=e(this.options.zoom,n)}return t}};const AL=Math.pow(2,14),yL=Math.pow(2,15);function vL(t,e,n,r){const i=(Math.sign(e)||1)*(Math.abs(e)%AL),o=(Math.sign(n)||1)*(Math.abs(n)%AL),s=Math.floor(Math.abs(e)/AL),a=Math.floor(Math.abs(n)/AL);return t[0]=i,t[1]=o,t[2]=Math.sign(r+1e-5)*(2*s+a)*yL+r,t}var xL,_L,bL="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},wL={exports:{}};function TL(t,...e){for(const n of e)for(const e in n)t[e]=n[e];return t}xL=wL,_L=wL.exports,function(t){var e=_L&&!_L.nodeType&&_L,n=xL&&!xL.nodeType&&xL,r="object"==typeof bL&&bL;r.global!==r&&r.window!==r&&r.self!==r||(t=r);var i,o,s=2147483647,a=36,l=26,h=38,u=700,c=/^xn--/,f=/[^\x20-\x7E]/,d=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},g=a-1,m=Math.floor,A=String.fromCharCode;function y(t){throw RangeError(p[t])}function v(t,e){for(var n=t.length,r=[];n--;)r[n]=e(t[n]);return r}function x(t,e){var n=t.split("@"),r="";return n.length>1&&(r=n[0]+"@",t=n[1]),r+v((t=t.replace(d,".")).split("."),e).join(".")}function _(t){for(var e,n,r=[],i=0,o=t.length;i<o;)(e=t.charCodeAt(i++))>=55296&&e<=56319&&i<o?56320==(64512&(n=t.charCodeAt(i++)))?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),i--):r.push(e);return r}function b(t){return v(t,(function(t){var e="";return t>65535&&(e+=A((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+A(t)})).join("")}function w(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function T(t,e,n){var r=0;for(t=n?m(t/u):t>>1,t+=m(t/e);t>g*l>>1;r+=a)t=m(t/g);return m(r+(g+1)*t/(t+h))}function M(t){var e,n,r,i,o,h,u,c,f,d,p,g=[],A=t.length,v=0,x=128,_=72;for((n=t.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)t.charCodeAt(r)>=128&&y("not-basic"),g.push(t.charCodeAt(r));for(i=n>0?n+1:0;i<A;){for(o=v,h=1,u=a;i>=A&&y("invalid-input"),((c=(p=t.charCodeAt(i++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:a)>=a||c>m((s-v)/h))&&y("overflow"),v+=c*h,!(c<(f=u<=_?1:u>=_+l?l:u-_));u+=a)h>m(s/(d=a-f))&&y("overflow"),h*=d;_=T(v-o,e=g.length+1,0==o),m(v/e)>s-x&&y("overflow"),x+=m(v/e),v%=e,g.splice(v++,0,x)}return b(g)}function C(t){var e,n,r,i,o,h,u,c,f,d,p,g,v,x,b,M=[];for(g=(t=_(t)).length,e=128,n=0,o=72,h=0;h<g;++h)(p=t[h])<128&&M.push(A(p));for(r=i=M.length,i&&M.push("-");r<g;){for(u=s,h=0;h<g;++h)(p=t[h])>=e&&p<u&&(u=p);for(u-e>m((s-n)/(v=r+1))&&y("overflow"),n+=(u-e)*v,e=u,h=0;h<g;++h)if((p=t[h])<e&&++n>s&&y("overflow"),p==e){for(c=n,f=a;!(c<(d=f<=o?1:f>=o+l?l:f-o));f+=a)b=c-d,x=a-d,M.push(A(w(d+b%x,0))),c=m(b/x);M.push(A(w(c,0))),o=T(n,v,r==i),n=0,++r}++n,++e}return M.join("")}if(i={version:"1.3.2",ucs2:{decode:_,encode:b},decode:M,encode:C,toASCII:function(t){return x(t,(function(t){return f.test(t)?"xn--"+C(t):t}))},toUnicode:function(t){return x(t,(function(t){return c.test(t)?M(t.slice(4).toLowerCase()):t}))}},e&&n)if(xL.exports==e)n.exports=i;else for(o in i)i.hasOwnProperty(o)&&(e[o]=i[o]);else t.punycode=i}(bL);let ML=class extends Error{constructor(t,e){super(e),this.message=e,this.key=t}};var CL=ML;var SL=class t{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[n,r]of e)this.bindings[n]=r}concat(e){return new t(this,e)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}};const IL={kind:"null"},PL={kind:"number"},EL={kind:"string"},OL={kind:"boolean"},RL={kind:"color"},kL={kind:"object"},LL={kind:"value"},DL={kind:"collator"},NL={kind:"formatted"},FL={kind:"resolvedImage"};function zL(t,e){return{kind:"array",itemType:t,N:e}}function BL(t){if("array"===t.kind){const e=BL(t.itemType);return"number"==typeof t.N?`array<${e}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${e}>`}return t.kind}const HL=[IL,PL,EL,OL,RL,NL,kL,zL(LL),FL];function jL(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!jL(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if("value"===t.kind)for(const t of HL)if(!jL(t,e))return null}return`Expected ${BL(t)} but found ${BL(e)} instead.`}function UL(t,e){return e.some((e=>e.kind===t.kind))}function VL(t,e){return e.some((e=>"null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t))}var GL,WL={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function qL(t){return(t=Math.round(t))<0?0:t>255?255:t}function XL(t){return t<0?0:t>1?1:t}function ZL(t){return"%"===t[t.length-1]?qL(parseFloat(t)/100*255):qL(parseInt(t))}function YL(t){return"%"===t[t.length-1]?XL(parseFloat(t)/100):XL(parseFloat(t))}function JL(t,e,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?t+(e-t)*n*6:2*n<1?e:3*n<2?t+(e-t)*(2/3-n)*6:t}try{GL={}.parseCSSColor=function(t){var e,n=t.replace(/ /g,"").toLowerCase();if(n in WL)return WL[n].slice();if("#"===n[0])return 4===n.length?(e=parseInt(n.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===n.length&&(e=parseInt(n.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var r=n.indexOf("("),i=n.indexOf(")");if(-1!==r&&i+1===n.length){var o=n.substr(0,r),s=n.substr(r+1,i-(r+1)).split(","),a=1;switch(o){case"rgba":if(4!==s.length)return null;a=YL(s.pop());case"rgb":return 3!==s.length?null:[ZL(s[0]),ZL(s[1]),ZL(s[2]),a];case"hsla":if(4!==s.length)return null;a=YL(s.pop());case"hsl":if(3!==s.length)return null;var l=(parseFloat(s[0])%360+360)%360/360,h=YL(s[1]),u=YL(s[2]),c=u<=.5?u*(h+1):u+h-u*h,f=2*u-c;return[qL(255*JL(f,c,l+1/3)),qL(255*JL(f,c,l)),qL(255*JL(f,c,l-1/3)),a];default:return null}}return null}}catch(P6){}let QL=class t{constructor(t,e,n,r=1){this.r=t,this.g=e,this.b=n,this.a=r}static parse(e){if(!e)return;if(e instanceof t)return e;if("string"!=typeof e)return;const n=GL(e);return n?new t(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,e,n,r]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(n)},${r})`}toArray(){const{r:t,g:e,b:n,a:r}=this;return 0===r?[0,0,0,0]:[255*t/r,255*e/r,255*n/r,r]}toArray01(){const{r:t,g:e,b:n,a:r}=this;return 0===r?[0,0,0,0]:[t/r,e/r,n/r,r]}toArray01PremultipliedAlpha(){const{r:t,g:e,b:n,a:r}=this;return[t,e,n,r]}};QL.black=new QL(0,0,0,1),QL.white=new QL(1,1,1,1),QL.transparent=new QL(0,0,0,0),QL.red=new QL(1,0,0,1),QL.blue=new QL(0,0,1,1);var KL=QL;let $L=class{constructor(t,e,n){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}},tD=class{constructor(t,e,n,r,i){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=n,this.fontStack=r,this.textColor=i}},eD=class t{constructor(t){this.sections=t}static fromString(e){return new t([new tD(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((t=>0!==t.text.length||t.image&&0!==t.image.name.length))}static factory(e){return e instanceof t?e:t.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((t=>t.text)).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const n={};e.fontStack&&(n["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(n["font-scale"]=e.scale),e.textColor&&(n["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(n)}return t}},nD=class t{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(e){return e?new t({name:e,available:!1}):null}serialize(){return["image",this.name]}};function rD(t,e,n,r){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[t,e,n,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[t,e,n,r]:[t,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function iD(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof KL)return!0;if(t instanceof $L)return!0;if(t instanceof eD)return!0;if(t instanceof nD)return!0;if(Array.isArray(t)){for(const e of t)if(!iD(e))return!1;return!0}if("object"==typeof t){for(const e in t)if(!iD(t[e]))return!1;return!0}return!1}function oD(t){if(null===t)return IL;if("string"==typeof t)return EL;if("boolean"==typeof t)return OL;if("number"==typeof t)return PL;if(t instanceof KL)return RL;if(t instanceof $L)return DL;if(t instanceof eD)return NL;if(t instanceof nD)return FL;if(Array.isArray(t)){const e=t.length;let n;for(const r of t){const t=oD(r);if(n){if(n===t)continue;n=LL;break}n=t}return zL(n||LL,e)}return kL}function sD(t){const e=typeof t;return null===t?"":"string"===e||"number"===e||"boolean"===e?String(t):t instanceof KL||t instanceof eD||t instanceof nD?t.toString():JSON.stringify(t)}var aD=class t{constructor(t,e){this.type=t,this.value=e}static parse(e,n){if(2!==e.length)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!iD(e[1]))return n.error("invalid value");const r=e[1];let i=oD(r);const o=n.expectedType;return"array"!==i.kind||0!==i.N||!o||"array"!==o.kind||"number"==typeof o.N&&0!==o.N||(i=o),new t(i,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof KL?["rgba"].concat(this.value.toArray()):this.value instanceof eD?this.value.serialize():this.value}},lD=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const hD={string:EL,number:PL,boolean:OL,object:kL};var uD=class t{constructor(t,e){this.type=t,this.args=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let r,i=1;const o=e[0];if("array"===o){let t,o;if(e.length>2){const r=e[1];if("string"!=typeof r||!(r in hD)||"object"===r)return n.error('The item type argument of "array" must be one of string, number, boolean',1);t=hD[r],i++}else t=LL;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);o=e[2],i++}r=zL(t,o)}else r=hD[o];const s=[];for(;i<e.length;i++){const t=n.parse(e[i],i,LL);if(!t)return null;s.push(t)}return new t(r,s)}evaluate(t){for(let e=0;e<this.args.length;e++){const n=this.args[e].evaluate(t);if(!jL(this.type,oD(n)))return n;if(e===this.args.length-1)throw new lD(`Expected value to be of type ${BL(this.type)}, but found ${BL(oD(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=this.type,e=[t.kind];if("array"===t.kind){const n=t.itemType;if("string"===n.kind||"number"===n.kind||"boolean"===n.kind){e.push(n.kind);const r=t.N;("number"==typeof r||this.args.length>1)&&e.push(r)}}return e.concat(this.args.map((t=>t.serialize())))}};let cD=class t{constructor(t){this.type=NL,this.sections=t}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");const r=e[1];if(!Array.isArray(r)&&"object"==typeof r)return n.error("First argument must be an image or text section.");const i=[];let o=!1;for(let t=1;t<=e.length-1;++t){const r=e[t];if(o&&"object"==typeof r&&!Array.isArray(r)){o=!1;let t=null;if(r["font-scale"]&&(t=n.parse(r["font-scale"],1,PL),!t))return null;let e=null;if(r["text-font"]&&(e=n.parse(r["text-font"],1,zL(EL)),!e))return null;let s=null;if(r["text-color"]&&(s=n.parse(r["text-color"],1,RL),!s))return null;const a=i[i.length-1];a.scale=t,a.font=e,a.textColor=s}else{const r=n.parse(e[t],1,LL);if(!r)return null;const s=r.type.kind;if("string"!==s&&"value"!==s&&"null"!==s&&"resolvedImage"!==s)return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");o=!0,i.push({content:r,scale:null,font:null,textColor:null})}}return new t(i)}evaluate(t){return new eD(this.sections.map((e=>{const n=e.content.evaluate(t);return oD(n)===FL?new tD("",n,null,null,null):new tD(sD(n),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)})))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const n={};e.scale&&(n["font-scale"]=e.scale.serialize()),e.font&&(n["text-font"]=e.font.serialize()),e.textColor&&(n["text-color"]=e.textColor.serialize()),t.push(n)}return t}},fD=class t{constructor(t){this.type=FL,this.input=t}static parse(e,n){if(2!==e.length)return n.error("Expected two arguments.");const r=n.parse(e[1],1,EL);return r?new t(r):n.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),n=nD.fromString(e);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(e)>-1),n}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}};const dD={"to-boolean":OL,"to-color":RL,"to-number":PL,"to-string":EL};var pD=class t{constructor(t,e){this.type=t,this.args=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");const r=e[0];if(("to-boolean"===r||"to-string"===r)&&2!==e.length)return n.error("Expected one argument.");const i=dD[r],o=[];for(let t=1;t<e.length;t++){const r=n.parse(e[t],t,LL);if(!r)return null;o.push(r)}return new t(i,o)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let e,n;for(const r of this.args){if(e=r.evaluate(t),n=null,e instanceof KL)return e;if("string"==typeof e){const n=t.parseColor(e);if(n)return n}else if(Array.isArray(e)&&(n=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:rD(e[0],e[1],e[2],e[3]),!n))return new KL(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new lD(n||`Could not parse color from value '${"string"==typeof e?e:String(JSON.stringify(e))}'`)}if("number"===this.type.kind){let e=null;for(const n of this.args){if(e=n.evaluate(t),null===e)return 0;const r=Number(e);if(!isNaN(r))return r}throw new lD(`Could not convert ${JSON.stringify(e)} to number.`)}return"formatted"===this.type.kind?eD.fromString(sD(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?nD.fromString(sD(this.args[0].evaluate(t))):sD(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new cD([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new fD(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild((e=>{t.push(e.serialize())})),t}};const gD=["Unknown","Point","LineString","Polygon"];var mD=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this.D={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?gD[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:n,y:r}=this.featureTileCoord,i=n*e-t[0],o=r*e-t[1];return this.featureDistanceData.bearing[0]*i+this.featureDistanceData.bearing[1]*o}return 0}parseColor(t){let e=this.D[t];return e||(e=this.D[t]=KL.parse(t)),e}};var AD=class t{constructor(t,e,n,r){this.name=t,this.type=e,this.L=n,this.args=r}evaluate(t){return this.L(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((t=>t.serialize())))}static parse(e,n){const r=e[0],i=t.definitions[r];if(!i)return n.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const o=Array.isArray(i)?i[0]:i.type,s=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=s.filter((([t])=>!Array.isArray(t)||t.length===e.length-1));let l=null;for(const[h,u]of a){l=new jD(n.registry,n.path,null,n.scope);const i=[];let s=!1;for(let t=1;t<e.length;t++){const n=e[t],r=Array.isArray(h)?h[t-1]:h.type,o=l.parse(n,1+i.length,r);if(!o){s=!0;break}i.push(o)}if(!s)if(Array.isArray(h)&&h.length!==i.length)l.error(`Expected ${h.length} arguments, but found ${i.length} instead.`);else{for(let t=0;t<i.length;t++){const e=Array.isArray(h)?h[t]:h.type,n=i[t];l.concat(t+1).checkSubtype(e,n.type)}if(0===l.errors.length)return new t(r,o,u,i)}}if(1===a.length)n.errors.push(...l.errors);else{const t=(a.length?a:s).map((([t])=>{return e=t,Array.isArray(e)?`(${e.map(BL).join(", ")})`:`(${BL(e.type)}...)`;var e})).join(" | "),r=[];for(let i=1;i<e.length;i++){const t=n.parse(e[i],1+r.length);if(!t)return null;r.push(BL(t.type))}n.error(`Expected arguments of type ${t}, but found (${r.join(", ")}) instead.`)}return null}static register(e,n){t.definitions=n;for(const r in n)e[r]=t}};let yD=class t{constructor(t,e,n){this.type=DL,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=e}static parse(e,n){if(2!==e.length)return n.error("Expected one argument.");const r=e[1];if("object"!=typeof r||Array.isArray(r))return n.error("Collator options argument must be an object.");const i=n.parse(void 0!==r["case-sensitive"]&&r["case-sensitive"],1,OL);if(!i)return null;const o=n.parse(void 0!==r["diacritic-sensitive"]&&r["diacritic-sensitive"],1,OL);if(!o)return null;let s=null;return r.locale&&(s=n.parse(r.locale,1,EL),!s)?null:new t(i,o,s)}evaluate(t){return new $L(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}};const vD=8192;function xD(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function _D(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function bD(t,e){const n=(180+t[0])/360,r=(i=t[1],(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360);var i;const o=Math.pow(2,e.z);return[Math.round(n*o*vD),Math.round(r*o*vD)]}function wD(t,e,n){const r=t[0]-e[0],i=t[1]-e[1],o=t[0]-n[0],s=t[1]-n[1];return r*s-o*i==0&&r*o<=0&&i*s<=0}function TD(t,e){let n=!1;for(let s=0,a=e.length;s<a;s++){const a=e[s];for(let e=0,s=a.length;e<s-1;e++){if(wD(t,a[e],a[e+1]))return!1;r=t,i=a[e],o=a[e+1],i[1]>r[1]!=o[1]>r[1]&&r[0]<(o[0]-i[0])*(r[1]-i[1])/(o[1]-i[1])+i[0]&&(n=!n)}}var r,i,o;return n}function MD(t,e){for(let n=0;n<e.length;n++)if(TD(t,e[n]))return!0;return!1}function CD(t,e,n,r){const i=t[0]-n[0],o=t[1]-n[1],s=e[0]-n[0],a=e[1]-n[1],l=r[0]-n[0],h=r[1]-n[1],u=i*h-l*o,c=s*h-l*a;return u>0&&c<0||u<0&&c>0}function SD(t,e,n,r){const i=[e[0]-t[0],e[1]-t[1]];return 0!=(o=[r[0]-n[0],r[1]-n[1]])[0]*(s=i)[1]-o[1]*s[0]&&!(!CD(t,e,n,r)||!CD(n,r,t,e));var o,s}function ID(t,e,n){for(const r of n)for(let n=0;n<r.length-1;++n)if(SD(t,e,r[n],r[n+1]))return!0;return!1}function PD(t,e){for(let n=0;n<t.length;++n)if(!TD(t[n],e))return!1;for(let n=0;n<t.length-1;++n)if(ID(t[n],t[n+1],e))return!1;return!0}function ED(t,e){for(let n=0;n<e.length;n++)if(PD(t,e[n]))return!0;return!1}function OD(t,e,n){const r=[];for(let i=0;i<t.length;i++){const o=[];for(let r=0;r<t[i].length;r++){const s=bD(t[i][r],n);xD(e,s),o.push(s)}r.push(o)}return r}function RD(t,e,n){const r=[];for(let i=0;i<t.length;i++){const o=OD(t[i],e,n);r.push(o)}return r}function kD(t,e,n,r){if(t[0]<n[0]||t[0]>n[2]){const e=.5*r;let i=t[0]-n[0]>e?-r:n[0]-t[0]>e?r:0;0===i&&(i=t[0]-n[2]>e?-r:n[2]-t[0]>e?r:0),t[0]+=i}xD(e,t)}function LD(t,e,n,r){const i=Math.pow(2,r.z)*vD,o=[r.x*vD,r.y*vD],s=[];if(!t)return s;for(const a of t)for(const t of a){const r=[t.x+o[0],t.y+o[1]];kD(r,e,n,i),s.push(r)}return s}function DD(t,e,n,r){const i=Math.pow(2,r.z)*vD,o=[r.x*vD,r.y*vD],s=[];if(!t)return s;for(const l of t){const t=[];for(const n of l){const r=[n.x+o[0],n.y+o[1]];xD(e,r),t.push(r)}s.push(t)}if(e[2]-e[0]<=i/2){(a=e)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const t of s)for(const r of t)kD(r,e,n,i)}var a;return s}var ND=class t{constructor(t,e){this.type=OL,this.geojson=t,this.geometries=e}static parse(e,n){if(2!==e.length)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(iD(e[1])){const n=e[1];if("FeatureCollection"===n.type)for(let e=0;e<n.features.length;++e){const r=n.features[e].geometry.type;if("Polygon"===r||"MultiPolygon"===r)return new t(n,n.features[e].geometry)}else if("Feature"===n.type){const e=n.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new t(n,n.geometry)}else if("Polygon"===n.type||"MultiPolygon"===n.type)return new t(n,n)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===e.type){const o=OD(e.coordinates,r,i),s=LD(t.geometry(),n,r,i);if(!_D(n,r))return!1;for(const t of s)if(!TD(t,o))return!1}if("MultiPolygon"===e.type){const o=RD(e.coordinates,r,i),s=LD(t.geometry(),n,r,i);if(!_D(n,r))return!1;for(const t of s)if(!MD(t,o))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===e.type){const o=OD(e.coordinates,r,i),s=DD(t.geometry(),n,r,i);if(!_D(n,r))return!1;for(const t of s)if(!PD(t,o))return!1}if("MultiPolygon"===e.type){const o=RD(e.coordinates,r,i),s=DD(t.geometry(),n,r,i);if(!_D(n,r))return!1;for(const t of s)if(!ED(t,o))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}};function FD(t){if(t instanceof AD){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof ND)return!1;let e=!0;return t.eachChild((t=>{e&&!FD(t)&&(e=!1)})),e}function zD(t){if(t instanceof AD&&"feature-state"===t.name)return!1;let e=!0;return t.eachChild((t=>{e&&!zD(t)&&(e=!1)})),e}function BD(t,e){if(t instanceof AD&&e.indexOf(t.name)>=0)return!1;let n=!0;return t.eachChild((t=>{n&&!BD(t,e)&&(n=!1)})),n}var HD=class t{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(e,n){if(2!==e.length||"string"!=typeof e[1])return n.error("'var' expression requires exactly one string literal argument.");const r=e[1];return n.scope.has(r)?new t(r,n.scope.get(r)):n.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}};var jD=class t{constructor(t,e=[],n,r=new SL,i=[]){this.registry=t,this.path=e,this.key=e.map((t=>`[${t}]`)).join(""),this.scope=r,this.errors=i,this.expectedType=n}parse(t,e,n,r,i={}){return e?this.concat(e,n,r).R(t,i):this.R(t,i)}R(t,e){function n(t,e,n){return"assert"===n?new uD(e,[t]):"coerce"===n?new pD(e,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=t[0];if("string"!=typeof i)return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const o=this.registry[i];if(o){let i=o.parse(t,this);if(!i)return null;if(this.expectedType){const t=this.expectedType,r=i.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==r.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==r.kind&&"string"!==r.kind){if(this.checkSubtype(t,r))return null}else i=n(i,t,e.typeAnnotation||"coerce");else i=n(i,t,e.typeAnnotation||"assert")}if(!(i instanceof aD)&&"resolvedImage"!==i.type.kind&&UD(i)){const t=new mD;try{i=new aD(i.type,i.evaluate(t))}catch(r){return this.error(r.message),null}}return i}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return void 0===t?this.error("'undefined' value invalid. Use null instead."):"object"==typeof t?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(`Expected an array, but found ${typeof t} instead.`)}concat(e,n,r){const i="number"==typeof e?this.path.concat(e):this.path,o=r?this.scope.concat(r):this.scope;return new t(this.registry,i,n||null,o,this.errors)}error(t,...e){const n=`${this.key}${e.map((t=>`[${t}]`)).join("")}`;this.errors.push(new CL(n,t))}checkSubtype(t,e){const n=jL(t,e);return n&&this.error(n),n}};function UD(t){if(t instanceof HD)return UD(t.boundExpression);if(t instanceof AD&&"error"===t.name)return!1;if(t instanceof yD)return!1;if(t instanceof ND)return!1;const e=t instanceof pD||t instanceof uD;let n=!0;return t.eachChild((t=>{n=e?n&&UD(t):n&&t instanceof aD})),!!n&&FD(t)&&BD(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function VD(t,e){const n=t.length-1;let r,i,o=0,s=n,a=0;for(;o<=s;)if(a=Math.floor((o+s)/2),r=t[a],i=t[a+1],r<=e){if(a===n||e<i)return a;o=a+1}else{if(!(r>e))throw new lD("Input is not a number.");s=a-1}return 0}var GD=class t{constructor(t,e,n){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[r,i]of n)this.labels.push(r),this.outputs.push(i)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");const r=n.parse(e[1],1,PL);if(!r)return null;const i=[];let o=null;n.expectedType&&"value"!==n.expectedType.kind&&(o=n.expectedType);for(let t=1;t<e.length;t+=2){const r=1===t?-1/0:e[t],s=e[t+1],a=t,l=t+1;if("number"!=typeof r)return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(i.length&&i[i.length-1][0]>=r)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const h=n.parse(s,l,o);if(!h)return null;o=o||h.type,i.push([r,h])}return new t(o,r,i)}evaluate(t){const e=this.labels,n=this.outputs;if(1===e.length)return n[0].evaluate(t);const r=this.input.evaluate(t);if(r<=e[0])return n[0].evaluate(t);const i=e.length;return r>=e[i-1]?n[i-1].evaluate(t):n[VD(e,r)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}},WD=qD;function qD(t,e,n,r){this.cx=3*t,this.bx=3*(n-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(r-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=n,this.p2y=r}function XD(t,e,n){return t*(1-n)+e*n}qD.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(void 0===e&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var n=t,r=0;r<8;r++){var i=this.sampleCurveX(n)-t;if(Math.abs(i)<e)return n;var o=this.sampleCurveDerivativeX(n);if(Math.abs(o)<1e-6)break;n-=i/o}var s=0,a=1;for(n=t,r=0;r<20&&(i=this.sampleCurveX(n),!(Math.abs(i-t)<e));r++)t>i?s=n:a=n,n=.5*(a-s)+s;return n},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var ZD=Object.freeze({__proto__:null,number:XD,color:function(t,e,n){return new KL(XD(t.r,e.r,n),XD(t.g,e.g,n),XD(t.b,e.b,n),XD(t.a,e.a,n))},array:function(t,e,n){return t.map(((t,r)=>XD(t,e[r],n)))}});const YD=.95047,JD=1.08883,QD=4/29,KD=6/29,$D=3*KD*KD,tN=KD*KD*KD,eN=Math.PI/180,nN=180/Math.PI;function rN(t){return t>tN?Math.pow(t,1/3):t/$D+QD}function iN(t){return t>KD?t*t*t:$D*(t-QD)}function oN(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function sN(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function aN(t){const e=sN(t.r),n=sN(t.g),r=sN(t.b),i=rN((.4124564*e+.3575761*n+.1804375*r)/YD),o=rN((.2126729*e+.7151522*n+.072175*r)/1);return{l:116*o-16,a:500*(i-o),b:200*(o-rN((.0193339*e+.119192*n+.9503041*r)/JD)),alpha:t.a}}function lN(t){let e=(t.l+16)/116,n=isNaN(t.a)?e:e+t.a/500,r=isNaN(t.b)?e:e-t.b/200;return e=1*iN(e),n=YD*iN(n),r=JD*iN(r),new KL(oN(3.2404542*n-1.5371385*e-.4985314*r),oN(-.969266*n+1.8760108*e+.041556*r),oN(.0556434*n-.2040259*e+1.0572252*r),t.alpha)}function hN(t,e,n){const r=e-t;return t+n*(r>180||r<-180?r-360*Math.round(r/360):r)}const uN={forward:aN,reverse:lN,interpolate:function(t,e,n){return{l:XD(t.l,e.l,n),a:XD(t.a,e.a,n),b:XD(t.b,e.b,n),alpha:XD(t.alpha,e.alpha,n)}}},cN={forward:function(t){const{l:e,a:n,b:r}=aN(t),i=Math.atan2(r,n)*nN;return{h:i<0?i+360:i,c:Math.sqrt(n*n+r*r),l:e,alpha:t.a}},reverse:function(t){const e=t.h*eN,n=t.c;return lN({l:t.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:t.alpha})},interpolate:function(t,e,n){return{h:hN(t.h,e.h,n),c:XD(t.c,e.c,n),l:XD(t.l,e.l,n),alpha:XD(t.alpha,e.alpha,n)}}};var fN=Object.freeze({__proto__:null,lab:uN,hcl:cN});function dN(t,e,n,r){const i=r-n,o=t-n;return 0===i?0:1===e?o/i:(Math.pow(e,o)-1)/(Math.pow(e,i)-1)}var pN=class t{constructor(t,e,n,r,i){this.type=t,this.operator=e,this.interpolation=n,this.input=r,this.labels=[],this.outputs=[];for(const[o,s]of i)this.labels.push(o),this.outputs.push(s)}static interpolationFactor(t,e,n,r){let i=0;if("exponential"===t.name)i=dN(e,t.base,n,r);else if("linear"===t.name)i=dN(e,1,n,r);else if("cubic-bezier"===t.name){const o=t.controlPoints;i=new WD(o[0],o[1],o[2],o[3]).solve(dN(e,1,n,r))}return i}static parse(e,n){let[r,i,o,...s]=e;if(!Array.isArray(i)||0===i.length)return n.error("Expected an interpolation type expression.",1);if("linear"===i[0])i={name:"linear"};else if("exponential"===i[0]){const t=i[1];if("number"!=typeof t)return n.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:t}}else{if("cubic-bezier"!==i[0])return n.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const t=i.slice(1);if(4!==t.length||t.some((t=>"number"!=typeof t||t<0||t>1)))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:t}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(o=n.parse(o,2,PL),!o)return null;const a=[];let l=null;"interpolate-hcl"===r||"interpolate-lab"===r?l=RL:n.expectedType&&"value"!==n.expectedType.kind&&(l=n.expectedType);for(let t=0;t<s.length;t+=2){const e=s[t],r=s[t+1],i=t+3,o=t+4;if("number"!=typeof e)return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',i);if(a.length&&a[a.length-1][0]>=e)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',i);const h=n.parse(r,o,l);if(!h)return null;l=l||h.type,a.push([e,h])}return"number"===l.kind||"color"===l.kind||"array"===l.kind&&"number"===l.itemType.kind&&"number"==typeof l.N?new t(l,r,i,o,a):n.error(`Type ${BL(l)} is not interpolatable.`)}evaluate(e){const n=this.labels,r=this.outputs;if(1===n.length)return r[0].evaluate(e);const i=this.input.evaluate(e);if(i<=n[0])return r[0].evaluate(e);const o=n.length;if(i>=n[o-1])return r[o-1].evaluate(e);const s=VD(n,i),a=n[s],l=n[s+1],h=t.interpolationFactor(this.interpolation,i,a,l),u=r[s].evaluate(e),c=r[s+1].evaluate(e);return"interpolate"===this.operator?ZD[this.type.kind.toLowerCase()](u,c,h):"interpolate-hcl"===this.operator?cN.reverse(cN.interpolate(cN.forward(u),cN.forward(c),h)):uN.reverse(uN.interpolate(uN.forward(u),uN.forward(c),h))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let n=0;n<this.labels.length;n++)e.push(this.labels[n],this.outputs[n].serialize());return e}};var gN=class t{constructor(t,e){this.type=t,this.args=e}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let r=null;const i=n.expectedType;i&&"value"!==i.kind&&(r=i);const o=[];for(const t of e.slice(1)){const e=n.parse(t,1+o.length,r,void 0,{typeAnnotation:"omit"});if(!e)return null;r=r||e.type,o.push(e)}const s=i&&o.some((t=>jL(i,t.type)));return new t(s?LL:r,o)}evaluate(t){let e,n=null,r=0;for(const i of this.args){if(r++,n=i.evaluate(t),n&&n instanceof nD&&!n.available&&(e||(e=n),n=null,r===this.args.length))return e;if(null!==n)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=["coalesce"];return this.eachChild((e=>{t.push(e.serialize())})),t}};var mN=class t{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const r=[];for(let t=1;t<e.length-1;t+=2){const i=e[t];if("string"!=typeof i)return n.error(`Expected string, but found ${typeof i} instead.`,t);if(/[^a-zA-Z0-9_]/.test(i))return n.error("Variable names must contain only alphanumeric characters or '_'.",t);const o=n.parse(e[t+1],t+1);if(!o)return null;r.push([i,o])}const i=n.parse(e[e.length-1],e.length-1,n.expectedType,r);return i?new t(r,i):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,n]of this.bindings)t.push(e,n.serialize());return t.push(this.result.serialize()),t}};var AN=class t{constructor(t,e,n){this.type=t,this.index=e,this.input=n}static parse(e,n){if(3!==e.length)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=n.parse(e[1],1,PL),i=n.parse(e[2],2,zL(n.expectedType||LL));if(!r||!i)return null;const o=i.type;return new t(o.itemType,r,i)}evaluate(t){const e=this.index.evaluate(t),n=this.input.evaluate(t);if(e<0)throw new lD(`Array index out of bounds: ${e} < 0.`);if(e>=n.length)throw new lD(`Array index out of bounds: ${e} > ${n.length-1}.`);if(e!==Math.floor(e))throw new lD(`Array index must be an integer, but found ${e} instead.`);return n[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}};var yN=class t{constructor(t,e){this.type=OL,this.needle=t,this.haystack=e}static parse(e,n){if(3!==e.length)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=n.parse(e[1],1,LL),i=n.parse(e[2],2,LL);return r&&i?UL(r.type,[OL,EL,PL,IL,LL])?new t(r,i):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${BL(r.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(null==n)return!1;if(!VL(e,["boolean","string","number","null"]))throw new lD(`Expected first argument to be of type boolean, string, number or null, but found ${BL(oD(e))} instead.`);if(!VL(n,["string","array"]))throw new lD(`Expected second argument to be of type array or string, but found ${BL(oD(n))} instead.`);return n.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}};var vN=class t{constructor(t,e,n){this.type=PL,this.needle=t,this.haystack=e,this.fromIndex=n}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=n.parse(e[1],1,LL),i=n.parse(e[2],2,LL);if(!r||!i)return null;if(!UL(r.type,[OL,EL,PL,IL,LL]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${BL(r.type)} instead`);if(4===e.length){const o=n.parse(e[3],3,PL);return o?new t(r,i,o):null}return new t(r,i)}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!VL(e,["boolean","string","number","null"]))throw new lD(`Expected first argument to be of type boolean, string, number or null, but found ${BL(oD(e))} instead.`);if(!VL(n,["string","array"]))throw new lD(`Expected second argument to be of type array or string, but found ${BL(oD(n))} instead.`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return n.indexOf(e,r)}return n.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}};var xN=class t{constructor(t,e,n,r,i,o){this.inputType=t,this.type=e,this.input=n,this.cases=r,this.outputs=i,this.otherwise=o}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let r,i;n.expectedType&&"value"!==n.expectedType.kind&&(i=n.expectedType);const o={},s=[];for(let t=2;t<e.length-1;t+=2){let a=e[t];const l=e[t+1];Array.isArray(a)||(a=[a]);const h=n.concat(t);if(0===a.length)return h.error("Expected at least one branch label.");for(const t of a){if("number"!=typeof t&&"string"!=typeof t)return h.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return h.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return h.error("Numeric branch labels must be integer values.");if(r){if(h.checkSubtype(r,oD(t)))return null}else r=oD(t);if(void 0!==o[String(t)])return h.error("Branch labels must be unique.");o[String(t)]=s.length}const u=n.parse(l,t,i);if(!u)return null;i=i||u.type,s.push(u)}const a=n.parse(e[1],1,LL);if(!a)return null;const l=n.parse(e[e.length-1],e.length-1,i);return l?"value"!==a.type.kind&&n.concat(1).checkSubtype(r,a.type)?null:new t(r,i,a,o,s,l):null}evaluate(t){const e=this.input.evaluate(t);return(oD(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),n=[],r={};for(const o of e){const t=r[this.cases[o]];void 0===t?(r[this.cases[o]]=n.length,n.push([this.cases[o],[o]])):n[t][1].push(o)}const i=t=>"number"===this.inputType.kind?Number(t):t;for(const[o,s]of n)1===s.length?t.push(i(s[0])):t.push(s.map(i)),t.push(this.outputs[o].serialize());return t.push(this.otherwise.serialize()),t}};var _N=class t{constructor(t,e,n){this.type=t,this.branches=e,this.otherwise=n}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const i=[];for(let t=1;t<e.length-1;t+=2){const o=n.parse(e[t],t,OL);if(!o)return null;const s=n.parse(e[t+1],t+1,r);if(!s)return null;i.push([o,s]),r=r||s.type}const o=n.parse(e[e.length-1],e.length-1,r);return o?new t(r,i,o):null}evaluate(t){for(const[e,n]of this.branches)if(e.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,n]of this.branches)t(e),t(n);t(this.otherwise)}outputDefined(){return this.branches.every((([t,e])=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild((e=>{t.push(e.serialize())})),t}};var bN=class t{constructor(t,e,n,r){this.type=t,this.input=e,this.beginIndex=n,this.endIndex=r}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=n.parse(e[1],1,LL),i=n.parse(e[2],2,PL);if(!r||!i)return null;if(!UL(r.type,[zL(LL),EL,LL]))return n.error(`Expected first argument to be of type array or string, but found ${BL(r.type)} instead`);if(4===e.length){const o=n.parse(e[3],3,PL);return o?new t(r.type,r,i,o):null}return new t(r.type,r,i)}evaluate(t){const e=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!VL(e,["string","array"]))throw new lD(`Expected first argument to be of type array or string, but found ${BL(oD(e))} instead.`);if(this.endIndex){const r=this.endIndex.evaluate(t);return e.slice(n,r)}return e.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}};function wN(t,e){return"=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function TN(t,e,n,r){return 0===r.compare(e,n)}function MN(t,e,n){const r="=="!==t&&"!="!==t;return class i{constructor(t,e,n){this.type=OL,this.lhs=t,this.rhs=e,this.collator=n,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind}static parse(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");const n=t[0];let o=e.parse(t[1],1,LL);if(!o)return null;if(!wN(n,o.type))return e.concat(1).error(`"${n}" comparisons are not supported for type '${BL(o.type)}'.`);let s=e.parse(t[2],2,LL);if(!s)return null;if(!wN(n,s.type))return e.concat(2).error(`"${n}" comparisons are not supported for type '${BL(s.type)}'.`);if(o.type.kind!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return e.error(`Cannot compare types '${BL(o.type)}' and '${BL(s.type)}'.`);r&&("value"===o.type.kind&&"value"!==s.type.kind?o=new uD(s.type,[o]):"value"!==o.type.kind&&"value"===s.type.kind&&(s=new uD(o.type,[s])));let a=null;if(4===t.length){if("string"!==o.type.kind&&"string"!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return e.error("Cannot use collator to compare non-string types.");if(a=e.parse(t[3],3,DL),!a)return null}return new i(o,s,a)}evaluate(i){const o=this.lhs.evaluate(i),s=this.rhs.evaluate(i);if(r&&this.hasUntypedArgument){const e=oD(o),n=oD(s);if(e.kind!==n.kind||"string"!==e.kind&&"number"!==e.kind)throw new lD(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${e.kind}, ${n.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const t=oD(o),n=oD(s);if("string"!==t.kind||"string"!==n.kind)return e(i,o,s)}return this.collator?n(i,o,s,this.collator.evaluate(i)):e(i,o,s)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const e=[t];return this.eachChild((t=>{e.push(t.serialize())})),e}}}const CN=MN("==",(function(t,e,n){return e===n}),TN),SN=MN("!=",(function(t,e,n){return e!==n}),(function(t,e,n,r){return!TN(0,e,n,r)})),IN=MN("<",(function(t,e,n){return e<n}),(function(t,e,n,r){return r.compare(e,n)<0})),PN=MN(">",(function(t,e,n){return e>n}),(function(t,e,n,r){return r.compare(e,n)>0})),EN=MN("<=",(function(t,e,n){return e<=n}),(function(t,e,n,r){return r.compare(e,n)<=0})),ON=MN(">=",(function(t,e,n){return e>=n}),(function(t,e,n,r){return r.compare(e,n)>=0}));const RN={"==":CN,"!=":SN,">":PN,"<":IN,">=":ON,"<=":EN,array:uD,at:AN,boolean:uD,case:_N,coalesce:gN,collator:yD,format:cD,image:fD,in:yN,"index-of":vN,interpolate:pN,"interpolate-hcl":pN,"interpolate-lab":pN,length:class t{constructor(t){this.type=PL,this.input=t}static parse(e,n){if(2!==e.length)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);const r=n.parse(e[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?n.error(`Expected argument of type string or array, but found ${BL(r.type)} instead.`):new t(r):null}evaluate(t){const e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new lD(`Expected value to be of type string or array, but found ${BL(oD(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild((e=>{t.push(e.serialize())})),t}},let:mN,literal:aD,match:xN,number:uD,"number-format":class t{constructor(t,e,n,r,i,o){this.type=EL,this.number=t,this.locale=e,this.currency=n,this.unit=r,this.minFractionDigits=i,this.maxFractionDigits=o}static parse(e,n){if(3!==e.length)return n.error("Expected two arguments.");const r=n.parse(e[1],1,PL);if(!r)return null;const i=e[2];if("object"!=typeof i||Array.isArray(i))return n.error("NumberFormat options argument must be an object.");let o=null;if(i.locale&&(o=n.parse(i.locale,1,EL),!o))return null;let s=null;if(i.currency&&(s=n.parse(i.currency,1,EL),!s))return null;let a=null;if(i.unit&&(a=n.parse(i.unit,1,EL),!a))return null;let l=null;if(i["min-fraction-digits"]&&(l=n.parse(i["min-fraction-digits"],1,PL),!l))return null;let h=null;return i["max-fraction-digits"]&&(h=n.parse(i["max-fraction-digits"],1,PL),!h)?null:new t(r,o,s,a,l,h)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}},object:uD,slice:bN,step:GD,string:uD,"to-boolean":pD,"to-color":pD,"to-number":pD,"to-string":pD,var:HD,within:ND};function kN(t,[e,n,r,i]){e=e.evaluate(t),n=n.evaluate(t),r=r.evaluate(t);const o=i?i.evaluate(t):1,s=rD(e,n,r,o);if(s)throw new lD(s);return new KL(e/255*o,n/255*o,r/255*o,o)}function LN(t,e){return t in e}function DN(t,e){const n=e[t];return void 0===n?null:n}function NN(t){return{type:t}}AD.register(RN,{error:[{kind:"error"},[EL],(t,[e])=>{throw new lD(e.evaluate(t))}],typeof:[EL,[LL],(t,[e])=>BL(oD(e.evaluate(t)))],"to-rgba":[zL(PL,4),[RL],(t,[e])=>e.evaluate(t).toArray()],rgb:[RL,[PL,PL,PL],kN],rgba:[RL,[PL,PL,PL,PL],kN],has:{type:OL,overloads:[[[EL],(t,[e])=>LN(e.evaluate(t),t.properties())],[[EL,kL],(t,[e,n])=>LN(e.evaluate(t),n.evaluate(t))]]},get:{type:LL,overloads:[[[EL],(t,[e])=>DN(e.evaluate(t),t.properties())],[[EL,kL],(t,[e,n])=>DN(e.evaluate(t),n.evaluate(t))]]},"feature-state":[LL,[EL],(t,[e])=>DN(e.evaluate(t),t.featureState||{})],properties:[kL,[],t=>t.properties()],"geometry-type":[EL,[],t=>t.geometryType()],id:[LL,[],t=>t.id()],zoom:[PL,[],t=>t.globals.zoom],pitch:[PL,[],t=>t.globals.pitch||0],"distance-from-center":[PL,[],t=>t.distanceFromCenter()],"heatmap-density":[PL,[],t=>t.globals.heatmapDensity||0],"line-progress":[PL,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[PL,[],t=>t.globals.skyRadialProgress||0],accumulated:[LL,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[PL,NN(PL),(t,e)=>{let n=0;for(const r of e)n+=r.evaluate(t);return n}],"*":[PL,NN(PL),(t,e)=>{let n=1;for(const r of e)n*=r.evaluate(t);return n}],"-":{type:PL,overloads:[[[PL,PL],(t,[e,n])=>e.evaluate(t)-n.evaluate(t)],[[PL],(t,[e])=>-e.evaluate(t)]]},"/":[PL,[PL,PL],(t,[e,n])=>e.evaluate(t)/n.evaluate(t)],"%":[PL,[PL,PL],(t,[e,n])=>e.evaluate(t)%n.evaluate(t)],ln2:[PL,[],()=>Math.LN2],pi:[PL,[],()=>Math.PI],e:[PL,[],()=>Math.E],"^":[PL,[PL,PL],(t,[e,n])=>Math.pow(e.evaluate(t),n.evaluate(t))],sqrt:[PL,[PL],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[PL,[PL],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[PL,[PL],(t,[e])=>Math.log(e.evaluate(t))],log2:[PL,[PL],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[PL,[PL],(t,[e])=>Math.sin(e.evaluate(t))],cos:[PL,[PL],(t,[e])=>Math.cos(e.evaluate(t))],tan:[PL,[PL],(t,[e])=>Math.tan(e.evaluate(t))],asin:[PL,[PL],(t,[e])=>Math.asin(e.evaluate(t))],acos:[PL,[PL],(t,[e])=>Math.acos(e.evaluate(t))],atan:[PL,[PL],(t,[e])=>Math.atan(e.evaluate(t))],min:[PL,NN(PL),(t,e)=>Math.min(...e.map((e=>e.evaluate(t))))],max:[PL,NN(PL),(t,e)=>Math.max(...e.map((e=>e.evaluate(t))))],abs:[PL,[PL],(t,[e])=>Math.abs(e.evaluate(t))],round:[PL,[PL],(t,[e])=>{const n=e.evaluate(t);return n<0?-Math.round(-n):Math.round(n)}],floor:[PL,[PL],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[PL,[PL],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[OL,[EL,LL],(t,[e,n])=>t.properties()[e.value]===n.value],"filter-id-==":[OL,[LL],(t,[e])=>t.id()===e.value],"filter-type-==":[OL,[EL],(t,[e])=>t.geometryType()===e.value],"filter-<":[OL,[EL,LL],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r<i}],"filter-id-<":[OL,[LL],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n<r}],"filter->":[OL,[EL,LL],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r>i}],"filter-id->":[OL,[LL],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n>r}],"filter-<=":[OL,[EL,LL],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[OL,[LL],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n<=r}],"filter->=":[OL,[EL,LL],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[OL,[LL],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n>=r}],"filter-has":[OL,[LL],(t,[e])=>e.value in t.properties()],"filter-has-id":[OL,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[OL,[zL(EL)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[OL,[zL(LL)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[OL,[EL,zL(LL)],(t,[e,n])=>n.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[OL,[EL,zL(LL)],(t,[e,n])=>function(t,e,n,r){for(;n<=r;){const i=n+r>>1;if(e[i]===t)return!0;e[i]>t?r=i-1:n=i+1}return!1}(t.properties()[e.value],n.value,0,n.value.length-1)],all:{type:OL,overloads:[[[OL,OL],(t,[e,n])=>e.evaluate(t)&&n.evaluate(t)],[NN(OL),(t,e)=>{for(const n of e)if(!n.evaluate(t))return!1;return!0}]]},any:{type:OL,overloads:[[[OL,OL],(t,[e,n])=>e.evaluate(t)||n.evaluate(t)],[NN(OL),(t,e)=>{for(const n of e)if(n.evaluate(t))return!0;return!1}]]},"!":[OL,[OL],(t,[e])=>!e.evaluate(t)],"is-supported-script":[OL,[EL],(t,[e])=>{const n=t.globals&&t.globals.isSupportedScript;return!n||n(e.evaluate(t))}],upcase:[EL,[EL],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[EL,[EL],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[EL,NN(LL),(t,e)=>e.map((e=>sD(e.evaluate(t)))).join("")],"resolved-locale":[EL,[DL],(t,[e])=>e.evaluate(t).resolvedLocale()]});var FN=RN;function zN(t){return{result:"success",value:t}}function BN(t){return{result:"error",value:t}}function HN(t){return!!t.expression&&t.expression.interpolated}function jN(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function UN(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function VN(t){return t}function GN(t,e){const n="color"===e.type,r=t.stops&&"object"==typeof t.stops[0][0],i=r||void 0!==t.property,o=r||!i,s=t.type||(HN(e)?"exponential":"interval");if(n&&((t=TL({},t)).stops&&(t.stops=t.stops.map((t=>[t[0],KL.parse(t[1])]))),t.default?t.default=KL.parse(t.default):t.default=KL.parse(e.default)),t.colorSpace&&"rgb"!==t.colorSpace&&!fN[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let a,l,h;if("exponential"===s)a=ZN;else if("interval"===s)a=XN;else if("categorical"===s){a=qN,l=Object.create(null);for(const e of t.stops)l[e[0]]=e[1];h=typeof t.stops[0][0]}else{if("identity"!==s)throw new Error(`Unknown function type "${s}"`);a=YN}if(r){const n={},r=[];for(let e=0;e<t.stops.length;e++){const i=t.stops[e],o=i[0].zoom;void 0===n[o]&&(n[o]={zoom:o,type:t.type,property:t.property,default:t.default,stops:[]},r.push(o)),n[o].stops.push([i[0].value,i[1]])}const i=[];for(const t of r)i.push([n[t].zoom,GN(n[t],e)]);const o={name:"linear"};return{kind:"composite",interpolationType:o,interpolationFactor:pN.interpolationFactor.bind(void 0,o),zoomStops:i.map((t=>t[0])),evaluate:({zoom:n},r)=>ZN({stops:i,base:t.base},e,n).evaluate(n,r)}}if(o){const n="exponential"===s?{name:"exponential",base:void 0!==t.base?t.base:1}:null;return{kind:"camera",interpolationType:n,interpolationFactor:pN.interpolationFactor.bind(void 0,n),zoomStops:t.stops.map((t=>t[0])),evaluate:({zoom:n})=>a(t,e,n,l,h)}}return{kind:"source",evaluate(n,r){const i=r&&r.properties?r.properties[t.property]:void 0;return void 0===i?WN(t.default,e.default):a(t,e,i,l,h)}}}function WN(t,e,n){return void 0!==t?t:void 0!==e?e:void 0!==n?n:void 0}function qN(t,e,n,r,i){return WN(typeof n===i?r[n]:void 0,t.default,e.default)}function XN(t,e,n){if("number"!==jN(n))return WN(t.default,e.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[r-1][0])return t.stops[r-1][1];const i=VD(t.stops.map((t=>t[0])),n);return t.stops[i][1]}function ZN(t,e,n){const r=void 0!==t.base?t.base:1;if("number"!==jN(n))return WN(t.default,e.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[i-1][0])return t.stops[i-1][1];const o=VD(t.stops.map((t=>t[0])),n),s=function(t,e,n,r){const i=r-n,o=t-n;return 0===i?0:1===e?o/i:(Math.pow(e,o)-1)/(Math.pow(e,i)-1)}(n,r,t.stops[o][0],t.stops[o+1][0]),a=t.stops[o][1],l=t.stops[o+1][1];let h=ZD[e.type]||VN;if(t.colorSpace&&"rgb"!==t.colorSpace){const e=fN[t.colorSpace];h=(t,n)=>e.reverse(e.interpolate(e.forward(t),e.forward(n),s))}return"function"==typeof a.evaluate?{evaluate(...t){const e=a.evaluate.apply(void 0,t),n=l.evaluate.apply(void 0,t);if(void 0!==e&&void 0!==n)return h(e,n,s)}}:h(a,l,s)}function YN(t,e,n){return"color"===e.type?n=KL.parse(n):"formatted"===e.type?n=eD.fromString(n.toString()):"resolvedImage"===e.type?n=nD.fromString(n.toString()):jN(n)===e.type||"enum"===e.type&&e.values[n]||(n=void 0),WN(n,t.default,e.default)}let JN=class{constructor(t,e){var n;this.expression=t,this.H={},this.V=new mD,this.U=e?"color"===(n=e).type&&(UN(n.default)||Array.isArray(n.default))?new KL(0,0,0,0):"color"===n.type?KL.parse(n.default)||null:void 0===n.default?null:n.default:null,this.j=e&&"enum"===e.type?e.values:null}evaluateWithoutErrorHandling(t,e,n,r,i,o,s,a){return this.V.globals=t,this.V.feature=e,this.V.featureState=n,this.V.canonical=r||null,this.V.availableImages=i||null,this.V.formattedSection=o,this.V.featureTileCoord=s||null,this.V.featureDistanceData=a||null,this.expression.evaluate(this.V)}evaluate(t,e,n,r,i,o,s,a){this.V.globals=t,this.V.feature=e||null,this.V.featureState=n||null,this.V.canonical=r||null,this.V.availableImages=i||null,this.V.formattedSection=o||null,this.V.featureTileCoord=s||null,this.V.featureDistanceData=a||null;try{const t=this.expression.evaluate(this.V);if(null==t||"number"==typeof t&&t!=t)return this.U;if(this.j&&!(t in this.j))throw new lD(`Expected value to be one of ${Object.keys(this.j).map((t=>JSON.stringify(t))).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(l){return this.H[l.message]||(this.H[l.message]=!0,"undefined"!=typeof console&&console.warn(l.message)),this.U}}};function QN(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in FN}function KN(t,e){const n=new jD(FN,[],e?function(t){const e={color:RL,string:EL,number:PL,enum:EL,boolean:OL,formatted:NL,resolvedImage:FL};return"array"===t.type?zL(e[t.value]||LL,t.length):e[t.type]}(e):void 0),r=n.parse(t,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return r?zN(new JN(r,e)):BN(n.errors)}let $N=class{constructor(t,e){this.kind=t,this.G=e,this.isStateDependent="constant"!==t&&!zD(e.expression)}evaluateWithoutErrorHandling(t,e,n,r,i,o){return this.G.evaluateWithoutErrorHandling(t,e,n,r,i,o)}evaluate(t,e,n,r,i,o){return this.G.evaluate(t,e,n,r,i,o)}},tF=class{constructor(t,e,n,r){this.kind=t,this.zoomStops=n,this.G=e,this.isStateDependent="camera"!==t&&!zD(e.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,e,n,r,i,o){return this.G.evaluateWithoutErrorHandling(t,e,n,r,i,o)}evaluate(t,e,n,r,i,o){return this.G.evaluate(t,e,n,r,i,o)}interpolationFactor(t,e,n){return this.interpolationType?pN.interpolationFactor(this.interpolationType,t,e,n):0}};function eF(t,e){if("error"===(t=KN(t,e)).result)return t;const n=t.value.expression,r=FD(n);if(!r&&"data-driven"!==e["property-type"])return BN([new CL("","data expressions not supported")]);const i=BD(n,["zoom","pitch","distance-from-center"]);if(!i&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(e))return BN([new CL("","zoom expressions not supported")]);const o=rF(n);if(!o&&!i)return BN([new CL("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(o instanceof CL)return BN([o]);if(o instanceof pN&&!HN(e))return BN([new CL("",'"interpolate" expressions cannot be used with this property')]);if(!o)return zN(new $N(r?"constant":"source",t.value));const s=o instanceof pN?o.interpolation:void 0;return zN(new tF(r?"camera":"composite",t.value,o.labels,s))}let nF=class t{constructor(t,e){this.B=t,this.W=e,TL(this,GN(this.B,this.W))}static deserialize(e){return new t(e.B,e.W)}static serialize(t){return{B:t.B,W:t.W}}};function rF(t){let e=null;if(t instanceof mN)e=rF(t.result);else if(t instanceof gN){for(const n of t.args)if(e=rF(n),e)break}else(t instanceof GD||t instanceof pN)&&t.input instanceof AD&&"zoom"===t.input.name&&(e=t);return e instanceof CL||t.eachChild((t=>{const n=rF(t);n instanceof CL?e=n:!e&&n?e=new CL("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&n&&e!==n&&(e=new CL("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}function iF(t){if(Array.isArray(t))return t.map(iF);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const n in t)e[n]=iF(t[n]);return e}return(e=t)instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e;var e}function oF(t,e="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const n=t;let r=!0;try{r=function(t){if(!lF(t))return t;let e=iF(t);return aF(e),e=sF(e),e}(n)}catch(l){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const i=KN(r,null);let o=null;if("error"===i.result)throw new Error(i.value.map((t=>`${t.key}: ${t.message}`)).join(", "));o=(t,e,n)=>i.value.evaluate(t,e,{},n);let s=null,a=null;if(r!==n){const t=KN(n,null);if("error"===t.result)throw new Error(t.value.map((t=>`${t.key}: ${t.message}`)).join(", "));s=(e,n,r,i,o)=>t.value.evaluate(e,n,{},r,void 0,void 0,i,o),a=!FD(t.value.expression)}return{filter:o,dynamicFilter:s||void 0,needGeometry:uF(r),needFeature:!!a}}function sF(t){if(!Array.isArray(t))return t;const e=function(t){if(hF.has(t[0]))for(let e=1;e<t.length;e++)if(lF(t[e]))return!0;return t}(t);return!0===e?e:e.map((t=>sF(t)))}function aF(t){let e=!1;const n=[];if("case"===t[0]){for(let r=1;r<t.length-1;r+=2)e=e||lF(t[r]),n.push(t[r+1]);n.push(t[t.length-1])}else if("match"===t[0]){e=e||lF(t[1]);for(let e=2;e<t.length-1;e+=2)n.push(t[e+1]);n.push(t[t.length-1])}else if("step"===t[0]){e=e||lF(t[1]);for(let e=1;e<t.length-1;e+=2)n.push(t[e+1])}e&&(t.length=0,t.push("any",...n));for(let r=1;r<t.length;r++)aF(t[r])}function lF(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let e=1;e<t.length;e++)if(lF(t[e]))return!0;return!1}const hF=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function uF(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let e=1;e<t.length;e++)if(uF(t[e]))return!0;return!1}const cF={StyleExpression:JN,isExpression:QN,isExpressionFilter:function t(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const n of e.slice(1))if(!t(n)&&"boolean"!=typeof n)return!1;return!0;default:return!0}},createExpression:KN,createPropertyExpression:eF,normalizePropertyExpression:function(t,e){if(UN(t))return new nF(t,e);if(QN(t)){const n=eF(t,e);if("error"===n.result)throw new Error(n.value.map((t=>`${t.key}: ${t.message}`)).join(", "));return n.value}{let n=t;return"string"==typeof t&&"color"===e.type&&(n=KL.parse(t)),{kind:"constant",evaluate:()=>n}}},ZoomConstantExpression:$N,ZoomDependentExpression:tF,StylePropertyFunction:nF},{isExpression:fF,createExpression:dF}=cF,pF={};function gF(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const e=t.condition,n=[];for(let t=0;t<e.length;t++)n.push(gF(e[t]));return(t,e)=>{for(let r=0;r<n.length;r++)if(n[r](t,e))return!0;return!1}}const e=gF(t.condition);if(sL(t.layer))return e;const n=e=>e.layer===t.layer;return(t,r)=>n(t)&&e(t,r)}if($O(t))return KO(t);{let e=oF(t);e=e&&e.filter;return(t,n)=>(pF.zoom=n,e&&e(pF,t))}}const mF={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function AF(t,e){mF.type=e||"number";const n=dF(t,mF);if("success"!==n.result)throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(t)} (${n.value})`);return n.value}function yF(t){return fF(t)}const vF={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function xF(t){return vF[t]}const _F={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},bF={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function wF(t){return _F[t]?"string":xF(t)?"number":bF[t]?"array":"color"}const TF="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,MF=function(t){return class extends t{pushIn(...t){const e=t.length;for(let n=0;n<e;n++)this[this.currentIndex++]=t[n]}fill(t,e,n){super.fill(t,e,n),n>this.currentIndex&&(this.currentIndex=n)}set(t,e){t>=this.currentIndex&&(this.currentIndex=t+1),this[t]=e}getLength(){return this.currentIndex}setLength(t){this.currentIndex=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.currentIndex&&this.setLength(t)}reset(){this.currentIndex=0}slice(t,e){const n=super.slice(t,e);return n.currentIndex=e-t,n}}},CF=MF(Array),SF={get:function(t,e){return"length"===e?t.getLength():t[e]}};let IF,PF=class extends Array{setLength(t){this.length=t,this.currentIndex=t}trySetLength(t){this.length=t,this.currentIndex=t}getLength(){return this.length}},EF=class t{static createTypedArray(t,e){return rL(t,e)}static getInstance(){return IF}static ensureCapacity(t,e){if(!t.BYTES_PER_ELEMENT)return t;if(t.length>=e)return t;const n=new t.constructor(e+Math.ceil(.5*e)),r=t.getLength();for(let i=0;i<r;i++)n[i]=t[i];return n.currentIndex=t.currentIndex,n}static getArray(t){let e;if(t){const n=MF(t),r=1048576/n.BYTES_PER_ELEMENT;e=new n(r)}else e=new CF;return e.push=(...t)=>{e.pushIn(...t)},e}static getProxyArray(){const t=new CF,e=new Proxy(t,SF);return e.push=(...e)=>{t.pushIn(...e)},e.C=t,e}constructor(){this.X=[],this.Y=0,this.q=[],this.J=0,this.K={}}getProxy(){if(!TF){const t=new PF;return t.currentIndex=0,t}const e=this.q[this.J]=this.q[this.J]||t.getProxyArray();return e.reset(),this.J++,e}get(e){if(!TF){const t=new PF;return t.currentIndex=0,t}if(e){const n=e.name;let r=this.K[n];r||(r=this.K[n]={arrays:[],index:0});const i=r.index,o=r.arrays[i]=r.arrays[i]||t.getArray(e);return o.reset(),r.index++,o}const n=this.X[this.Y]=this.X[this.Y]||t.getArray();return n.reset(),this.Y++,n}reset(){this.Y=0,this.J=0;for(const t in this.K)this.K[t].index=0}};IF=new EF;const OF="__fea_idx",RF=[],kF={},LF={},DF={},NF=[],FF=EF.getInstance();let zF=!1;const BF=Math.pow(2,17);let HF=class t{static isAtlasLoaded(t,e={}){const{iconAtlas:n}=e;return!!(!t||n&&n.positions[t])}static genFnTypes(t){const e={};for(const n in t)if(yF(t[n])){const r=(n+"_Fn_0").trim(),i=(n+"Fn").trim(),o=wF(n);e[r]=AF(t[n],o),e[i]=(t,n)=>{let i;kF.zoom=t,LF.properties=n;try{i=e[r].evaluateWithoutErrorHandling(kF,LF,DF,null,NF)}catch(o){return null}return i}}else if(fL(t[n])){const r=(n+"_Fn_0").trim(),i=(n+"Fn").trim();xF(n)?(e[r]=iO(t[n]),e[i]=(t,n)=>{const i=e[r](t,n);return fL(i)?iO(i)(t,n):i}):(e[r]=oO(t[n]),e[i]=(t,n)=>{const i=e[r](t,n);return fL(i)?oO(i)(t,n):i})}return e}constructor(e,n,r){this.options=r;const i=[];this.symbolDef=n,this.symbol=sO(n,(()=>(i[0]=r.zoom,i))),this.styledVectors=[],this.properties={},this.Z=r.fnTypes||t.genFnTypes(this.symbolDef),fL(this.symbolDef.visible)&&(this.tt=iO(this.symbolDef.visible)),r.atlas&&(this.iconAtlas=r.atlas.iconAtlas,this.glyphAtlas=r.atlas.glyphAtlas),this.features=this.et(e)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=BF||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(t,e,n,r){if(e<this.nt&&(this.nt=e),e>this.it&&(this.it=e),n<this.rt&&(this.rt=n),n>this.st&&(this.st=n),this.needAltitudeAttribute()){let i=t.aPosition.currentIndex;t.aPosition[i++]=e,t.aPosition[i++]=n,t.aPosition.currentIndex=i,i=t.aAltitude.currentIndex,t.aAltitude[i++]=r,t.aAltitude.currentIndex=i}else{!function(t,e,n,r){const i=Math.abs(r)>>15,o=i>>1,s=i%2;let a=r%Math.pow(2,15);const l=e+(o<<14)*Math.sign(e),h=n+(s<<14)*Math.sign(n);t[0]=l,t[1]=h,a=Math.round(a),t[2]=0===a?r<0?-1:0:a}(RF,e,n,r);let i=t.aPosition.currentIndex;t.aPosition[i++]=RF[0],t.aPosition[i++]=RF[1],t.aPosition[i++]=RF[2],t.aPosition.currentIndex=i}}et(t){if(!t.length)return t;const e=(OF+"").trim();let n,r=0,i=t[r];for(;!i.geometry;)r++,i=t[r];if(Array.isArray(i.geometry)&&i.properties){let e=i.geometry[0];for(;Array.isArray(e);)e=e[0];e instanceof Ck&&(n=t)}if(!n)if(n=[],Array.isArray(i.geometry))for(let s=0;s<t.length;s++){const e=oL({},t[s]);n.push(iL(e))}else for(let s=0;s<t.length;s++){const r=t[s],i=Ik(r);for(let t=0;t<i.length;t++){const o=i[t];o[e]=r[e],n.push(o)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let e=0,r=!1;const{textPitchAlignmentFn:i}=this.Z;!i&&t&&"map"===this.symbolDef.textPitchAlignment&&(r=!0);for(let o=0;o<n.length;o++){const s=UF(n[o]&&n[o].geometry);if(s>e&&(e=s),t&&!r&&i&&n[o].properties){const t=i(null,n[o].properties);"map"===t&&(r=t)}}this.hasMapPitchAlign=r,this.maxPosZ=e}const o=this.options.order;if(o){const t=[];for(let e=0;e<o.length;e++)o[e]&&t.push(gF(o[e]));n=n.sort(((e,n)=>{const r=t.length;let i=-1,o=-1;for(let s=0;s<r&&(t[s](e)&&(i=s),t[s](n)&&(o=s),!(i>=0&&i<r&&o>=0&&o<r));s++);return i-o}))}return n}load(t=1){const e=(OF+"").trim(),n="_debug_info".trim(),r=this.Z,i=this.styledVectors;this.count=0;const o=this.features;if(!o||!o.length)return Promise.resolve(null);const s={},a={},l={zoom:this.options.zoom,isVector3D:!!this.options.center},h=[],u=sO(this.symbolDef,(()=>(h[0]=l.zoom,h)));let c=0,f=o.length;const d=this.options.debugIndex;try{for(;c<f;c++){const t=o[c];if(!t||!t.geometry)continue;if(aL(d)&&t[n].index!==d)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const h=this.createStyledVector(t,u,r,l,s,a);h&&h.feature.geometry&&(h.featureIdx=void 0===t[e]?c:t[e],this.count++,i.push(h))}}catch(p){return Promise.reject(p)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(s,a).then((()=>this.pack(t)))}loadAtlas(t,e){return new Promise(((n,r)=>{this.fetchAtlas(t,e,((t,e)=>{if(t)r(t);else{if(e){const{icons:t,glyphs:n}=e;if(t&&Object.keys(t).length){for(const e in t){const n=t[e],{width:r,height:i,data:o}=n.data;n.data=new jk({width:r,height:i},o)}this.iconAtlas=new Qk(t)}if(n&&Object.keys(n).length){for(const t in n){const e=n[t];for(const t in e){const n=e[t],{width:r,height:i,data:o}=n.bitmap;n.bitmap=new Hk({width:r,height:i},o)}}this.glyphAtlas=new $k(n)}}n({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}}))}))}fetchAtlas(t,e,n){Object.keys(t).length>0||Object.keys(e).length>0?this.options.requestor(t,e,n):n()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const e=this.createDataPack(this.styledVectors,t);if(!e)return null;e.properties=this.properties,this.empty&&(e.empty=!0);const n=e.buffers;delete e.buffers;const r={data:e,buffers:n};if(this.iconAtlas){const t=r.data.iconAtlas=jF(this.iconAtlas);if(t.glyphMap)for(const e in t.glyphMap){const r=t.glyphMap[e];n.push(r.data.data.buffer)}n.push(r.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(r.data.glyphAtlas=jF(this.glyphAtlas),n.push(r.data.glyphAtlas.image.data.buffer)),r}createStyledVector(t,e,n,r){return new mL(t,e,n,r)}createDataPack(t,e){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this.nt=this.rt=1/0,this.it=this.st=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const n=this.data={};this.ot=FF,FF.reset();let r=this.elements=FF.get();const i=this.lt=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),o=this.needAltitudeAttribute()?2:3;for(let v=0;v<i.length;v++)n[i[v].name]=FF.get(i[v].type);let s=FF.get(),a=0;const l=FF.get();let h=0,u=!1,c=!0;const f=new Set;for(let v=0,x=t.length;v<x;v++){if(!t[v].feature.geometry)continue;const r=Array.isArray(t[v])?t[v][0].feature.id:t[v].feature.id;c&&(void 0!==LF.id?f&&(f.has(LF.id)?c=!1:f.add(LF.id)):c=!1),aL(r)&&(Math.abs(r)>h&&(h=Math.abs(r)),r<0&&(u=!0));const i=this.data.aPosition.getLength();if(Array.isArray(t[v]))for(let n=0;n<t[v].length;n++)this.ht(t[v][n],e);else this.ht(t[v],e);const d=(n.aPosition.getLength()-i)/o;for(let e=0;e<d;e++)s.push(t[v].featureIdx),aL(r)&&l.push(r);a=Math.max(a,t[v].featureIdx)}if(this.countOutOfAngle>0&&!zF&&(zF=!0,console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle.")),this.hasElements()&&!r.getLength())return null;const d=this.options.center?Float32Array:nL(a);s=EF.createTypedArray(s,d),this.options.positionType?i[0].type=this.options.positionType:i[0].type=eL(this.maxPos);const p=this.options.center;if(p&&(p[0]||p[1])){const t=n.aPosition,e=t.getLength();for(let n=0;n<e;n+=o)t[n]-=p[0],t[n+1]-=p[1]}const g=function(t,e){const n={};for(let r=0;r<t.length;r++){const i=t[r],o=i.type,s=i.name;n[s]=o===Array?e[s]:rL(e[s],o)}return n}(i,n);g.aPickingId=s;const m=[];for(const v in g)m.push(g[v].buffer);const A=tL(this.maxIndex);r=EF.createTypedArray(r,A),m.push(r.buffer);const y={data:g,isIdUnique:c,is2D:0===this.maxPosZ,indices:this.hasElements()?r:null,positionSize:o,positionBounding:[this.nt,this.rt,this.it,this.st],buffers:m,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this.ut&&(y.markerPlacement=this.ut),this.ct&&(y.textPlacement=this.ct),l.getLength()){const t=u?eL(h):nL(h);y.featureIds=EF.createTypedArray(l,t),m.push(y.featureIds.buffer)}else y.featureIds=[];return y.pickingIdIndiceMap=Zk(s,y.indices),y}ht(t,e){const n=t.feature.properties;this.tt&&!this.tt(this.options.zoom,n)||this.placeVector(t,e,this.formatWidth)}addElements(t,e,n){this.maxIndex=Math.max(this.maxIndex,t,e,n);let r=this.elements.currentIndex;this.elements[r++]=t,this.elements[r++]=e,this.elements[r++]=n,this.elements.currentIndex=r}hasElements(){return!0}getAltitude(t){const{altitudeProperty:e,defaultAltitude:n,altitudeScale:r}=this.options;let i=Vk(t,e,n);return r&&(i*=r),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(i)),i}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let e=0;for(const n in t)if(cL(t,n)){const{tl:r,displaySize:i}=t[n],o=Math.max(r[0],r[1],i[0]-1,i[1]-1);o>e&&(e=o)}return e}ensureDataCapacity(t,e){const n=this.lt;for(let r=0;r<n.length;r++){const i=this.data[n[r].name];if(!i)continue;const o=n[r].width*t,s=i.getLength();this.data[n[r].name]=EF.ensureCapacity(i,s+o*e)}}};function jF(t){let e=t.positions,n=t.image&&t.image.format||"alpha";if(t instanceof Qk){e={};for(const n in t.positions){const r=t.positions[n];e[n]={paddedRect:r.paddedRect,pixelRatio:r.pixelRatio,tl:r.tl,br:r.br,displaySize:r.displaySize}}n="rgba"}const r=t.image;return{image:{width:r.width,height:r.height,data:r.data,format:n},glyphMap:t.glyphMap,positions:e}}function UF(t){if(!t)return 0;let e=0;if(Array.isArray(t))for(let n=0;n<t.length;n++)if(Array.isArray(t[n])){const r=UF(t[n]);r>e&&(e=r)}else{const r=Math.abs(t[n].z||0);r>e&&(e=r)}else{const n=Math.abs(t.z||0);n>e&&(e=n)}return e}const VF="___fn_in_stops";function GF(t,e,n,r){const i="__fn_textSize".trim();let o=t.textSize;if(sL(e.textSize))return[16,16];t[i]&&(o=t[i]);const s=[];var a;if(sL(a=o)||"function"!=typeof a&&(null===a.constructor||a.constructor!==Function)?s[0]=o:s[0]=o(r,n),nO(s[0])){const e=s[0].__fn_key=s[0].__fn_key||JSON.stringify(s[0]);t[VF]||(t[VF]={}),t[VF][e]||(t[VF][e]=iO(s[0]));const i=t[VF][e];s[0]=i(r,n)}return s[1]=s[0],s}function WF(t){const e=t.stops;let n=-1/0;for(let r=0;r<e.length;r++){let t=e[r][1];lL(e[r][1])&&(t=WF(e[r][1])),t>n&&(n=t)}return n}const qF=["{","}"],XF="";function ZF(t,e){if(!hL(t))return t;function n(t){if(!e)return XF;const n=e[t];return sL(n)?XF:Array.isArray(n)?n.join():n}const[r,i]=qF,o=function(t){t+=XF;const[e,n]=qF,r=[];let i=!1,o=XF;for(let s=0,a=t.length;s<a;s++){const a=t[s];i||a!==e||(i=!0),a===e&&i&&(o=XF),i&&a!==e&&a!==n&&(o+=a),a===n&&o&&(i=!1,r.push(o),o=XF)}return r}(t);for(let s=0,a=o.length;s<a;s++){const e=o[s],a=`${r}${e}${i}`;if(e.indexOf("|")>0){const r=e.split("|");let i=!1;for(let e=0;e<r.length;e++){const o=n(r[e]);if(o!==XF){t=YF(t,a,o),i=!0;break}}i||(t=YF(t,a,XF))}else t=YF(t,a,n(e))}return t}function YF(t,e,n){if(!t)return t;if(t.replaceAll)return t.replaceAll(e,n);for(;t.indexOf(e)>-1;)t=t.replace(e,n);return t}const JF={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519};function QF(t){return!(JF.Arabic(t)||JF["Arabic Supplement"](t)||JF["Arabic Extended-A"](t)||JF["Arabic Presentation Forms-A"](t)||JF["Arabic Presentation Forms-B"](t))}function KF(t){return!!(!(t<11904)&&(JF["Bopomofo Extended"](t)||JF.Bopomofo(t)||JF["CJK Compatibility Forms"](t)||JF["CJK Compatibility Ideographs"](t)||JF["CJK Compatibility"](t)||JF["CJK Radicals Supplement"](t)||JF["CJK Strokes"](t)||JF["CJK Symbols and Punctuation"](t)||JF["CJK Unified Ideographs Extension A"](t)||JF["CJK Unified Ideographs"](t)||JF["Enclosed CJK Letters and Months"](t)||JF["Halfwidth and Fullwidth Forms"](t)||JF.Hiragana(t)||JF["Ideographic Description Characters"](t)||JF["Kangxi Radicals"](t)||JF["Katakana Phonetic Extensions"](t)||JF.Katakana(t)||JF["Vertical Forms"](t)||JF["Yi Radicals"](t)||JF["Yi Syllables"](t)))}function $F(t){return!!(746===t||747===t||!(t<4352)&&(JF["Bopomofo Extended"](t)||JF.Bopomofo(t)||JF["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||JF["CJK Compatibility Ideographs"](t)||JF["CJK Compatibility"](t)||JF["CJK Radicals Supplement"](t)||JF["CJK Strokes"](t)||!(!JF["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||JF["CJK Unified Ideographs Extension A"](t)||JF["CJK Unified Ideographs"](t)||JF["Enclosed CJK Letters and Months"](t)||JF["Hangul Compatibility Jamo"](t)||JF["Hangul Jamo Extended-A"](t)||JF["Hangul Jamo Extended-B"](t)||JF["Hangul Jamo"](t)||JF["Hangul Syllables"](t)||JF.Hiragana(t)||JF["Ideographic Description Characters"](t)||JF.Kanbun(t)||JF["Kangxi Radicals"](t)||JF["Katakana Phonetic Extensions"](t)||JF.Katakana(t)&&12540!==t||!(!JF["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!JF["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||JF["Unified Canadian Aboriginal Syllabics"](t)||JF["Unified Canadian Aboriginal Syllabics Extended"](t)||JF["Vertical Forms"](t)||JF["Yijing Hexagram Symbols"](t)||JF["Yi Syllables"](t)||JF["Yi Radicals"](t)))}function tz(t){return!($F(t)||(e=t,JF["Latin-1 Supplement"](e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||JF["General Punctuation"](e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||JF["Letterlike Symbols"](e)||JF["Number Forms"](e)||JF["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||JF["Control Pictures"](e)&&9251!==e||JF["Optical Character Recognition"](e)||JF["Enclosed Alphanumerics"](e)||JF["Geometric Shapes"](e)||JF["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||JF["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||JF["CJK Symbols and Punctuation"](e)||JF.Katakana(e)||JF["Private Use Area"](e)||JF["CJK Compatibility Forms"](e)||JF["Small Form Variants"](e)||JF["Halfwidth and Fullwidth Forms"](e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e));var e}function ez(t){return t>=1424&&t<=2303||JF["Arabic Presentation Forms-A"](t)||JF["Arabic Presentation Forms-B"](t)}const nz=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function rz(t){for(const e of nz)if(t>=e[0]&&t<=e[1])return!0;return!1}const iz={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"},oz=1,sz=2;function az(t,e,n,r,i,o,s,a,l,h){let u=t.trim();h===sz&&(u=function(t){let e="";const n=Array.from(t);for(let r=0;r<n.length;r++){const t=n[r+1].codePointAt(0)||null,i=n[r-1].codePointAt(0)||null;t&&tz(t)&&!iz[n[r+1]]||i&&tz(i)&&!iz[n[r-1]]||!iz[n[r]]?e+=n[r]:e+=iz[n[r]]}return e}(u));const c=[],f={positionedGlyphs:c,text:u,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:h};let d;return d=function(t,e){const n=[];let r=0;for(let i=0;i<e.length;i++){const o=e[i];n.push(t.substring(r,o)),r=o}return r<t.length&&n.push(t.substring(r,t.length)),n}(u,function(t,e,n,r){if(!n)return[];if(!t)return[];const i=[],o=function(t,e,n,r){let i=0;for(let o=0;o<t.length;o++){const n=r[t.codePointAt(o)];n&&(i+=n.metrics.advance+e)}return i/Math.max(1,Math.ceil(i/n))}(t,e,n,r);let s=0;for(let a=0;a<t.length;a++){const n=t.codePointAt(a),l=r[n];l&&(l&&!lz[n]&&(s+=l.metrics.advance+e),a<t.length-1&&(hz[n]||KF(n))&&i.push(fz(a+1,s,o,i,cz(n,t.codePointAt(a+1)),!1)))}return dz(fz(t.length,s,o,i,0,!0))}(u,s,n,e)),function(t,e,n,r,i,o,s,a,l){let h=0,u=0,c=0;const f=t.positionedGlyphs;for(let m=0;m<n.length;m++){let t=n[m];if(t=t.trim(),!t.length){u-=r;continue}const i=f.length;for(let n=0;n<t.length;n++){const r=t.codePointAt(n),i=e[r];i&&($F(r)&&s!==oz?(32!==r&&f.push({glyph:r,x:h,y:0,vertical:!0}),h+=l+a):(32!==r&&f.push({glyph:r,x:h,y:u,vertical:!1}),h+=i.metrics.advance+a))}if(f.length!==i){const t=h-a;c=Math.max(t,c),gz(f,e,i,f.length-1,.5)}h=0,u-=r}const{horizontalAlign:d,verticalAlign:p}=pz(i,void 0);!function(t,e,n,r,i,o,s){const a=(.5-n)*i,l=-(-r*s+.5)*o;if(a||l)for(let h=0;h<t.length;h++)t[h].x+=a,t[h].y+=l}(f,0,d,p,c,r,n.length);const g=n.length*r;t.top+=-p*g,t.bottom=t.top+g,t.left+=-d*c,t.right=t.left+c}(f,e,d,r,i,0,h,s,l),!!c.length&&f}const lz={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},hz={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function uz(t,e,n,r){const i=Math.pow(t-e,2);return r?t<e?i/2:2*i:i+Math.abs(n)*n}function cz(t,e){let n=0;return 10===t&&(n-=1e4),40!==t&&65288!==t||(n+=50),41!==e&&65289!==e||(n+=50),n}function fz(t,e,n,r,i,o){let s=null,a=uz(e,n,i,o);for(let l=0;l<r.length;l++){const t=r[l],h=uz(e-t.x,n,i,o)+t.badness;h<=a&&(s=t,a=h)}return{index:t,x:e,priorBreak:s,badness:a}}function dz(t){return t?dz(t.priorBreak).concat(t.index):[]}function pz(t,e){let n=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":n=e?1:0;break;case"left":case"top-left":case"bottom-left":n=e?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=e?1:0;break;case"top":case"top-right":case"top-left":r=e?0:1}return{horizontalAlign:n,verticalAlign:r}}function gz(t,e,n,r,i){const o=e[t[r].glyph];if(o){const e=o.metrics.advance,s=(t[r].x+e)*i;if(!s)return;for(let i=n;i<=r;i++)t[i].x-=s}}const mz=/\{ *([\w_]+) *\}/g;let Az=class{constructor(t,e,n,r,i){this.feature=t,this.symbolDef=e,this.symbol=n,this.options=i,this.ft=this.dt.bind(this),this.Z=r}dt(t,e){return this.feature.properties[e]||""}getShape(t,e){if(this.yt)return this.yt;const{textHorizontalAlignmentFn:n,textVerticalAlignmentFn:r,markerHorizontalAlignmentFn:i,markerVerticalAlignmentFn:o,textWrapWidthFn:s}=this.Z;let a;const l=this.symbol,h=this.getIconAndGlyph(),u=this.feature.properties;if(h&&h.glyph){const{font:t,text:i}=h.glyph;if(""===i)return null;const o=24,c=this.size[0]/o,f=24,d=l.textKeepUpright,p="map"===l.textRotationAlignment&&"line"===l.textPlacement&&!l.isIconText,g=e.glyphMap[t],m=yz(n?n(null,u):l.textHorizontalAlignment,r?r(null,u):l.textVerticalAlignment),A=1.2*f,y=function(t){for(let e=0;e<t.length;e++)if(!QF(t.charAt(e).charCodeAt(0)))return!1;return!0}(i),v=y&&l.textLetterSpacing/c||0,x=[l.textDx/c||0,l.textDy/c||0],_=((s?s(null,u):l.textWrapWidth)||10*f)/c;a={},a.horizontal=az(i,g,_,A,m,0,v,x,f,oz,this.options.isVector3D),y&&p&&d&&(a.vertical=az(i,g,_,A,m,0,v,x,f,sz))}else if(h&&h.icon){if(!t||!t.positions[h.icon.url])return null;const e=yz(i?i(null,u):l.markerHorizontalAlignment,o?o(null,u):l.markerVerticalAlignment);a=function(t,e,n){let{horizontalAlign:r,verticalAlign:i}=pz(e,n);n?r=1-r:i=1-i;const o=-2048*r,s=-2048*i;return{image:t,top:s,bottom:s+2048,left:o,right:o+2048}}(t.positions[h.icon.url],e,this.options.isVector3D),this.size||(this.size=a.image.displaySize)}return this.yt=a,a}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:e,markerPathFn:n,markerWidthFn:r,markerHeightFn:i,markerFillFn:o,markerFillPatternFileFn:s,markerFillOpacityFn:a,markerTextFitFn:l,markerTextFitPaddingFn:h,markerLineColorFn:u,markerLineWidthFn:c,markerLineOpacityFn:f,markerLineDasharrayFn:d,markerLinePatternFileFn:p,markerPathWidthFn:g,markerPathHeightFn:m,textNameFn:A,textFaceNameFn:y}=this.Z,{zoom:v}=this.options,x={},_=this.symbol,b=this.feature.properties,w=t?t(null,b):_.markerFile,T=e?e(null,b):_.markerType,M=w||T||_.markerPath,C=!sL(this.symbolDef.textName);let S;if(M){S=function(t,e,n,r,i,o){if(sL(e.markerWidth)&&sL(e.markerHeight))return null;const s="__fn_markerWidth".trim(),a="__fn_markerHeight".trim();let l=e.markerWidth||0,h=e.markerHeight||0;return lL(l)&&("identity"!==l.type?l=WF(l):(l=t.markerWidth,t[s]&&(l=t[s](r,n)),lL(l)&&(l="identity"===l.type?i(r,n):WF(l)))),lL(h)&&("identity"!==h.type?h=WF(h):(h=t.markerHeight,t[a]&&(h=t[a](r,n)),lL(h)&&(h="identity"===h.type?o(r,n):WF(h)))),[l,h]}(_,this.symbolDef,b,v,r,i)||[0,0];let t=_.markerTextFit;if(l&&(t=l(v,b)),t&&_.text&&"none"!==t){const e=_.text.textSize;let n=_.text.textName;nO(n)&&(n=iO(n)(v,b));const r=ZF(n,b);if(r){const n="__fn_textSize".trim(),i="__fn_textSize_0".trim();nO(e)&&!_.text[n]&&(_.text[i]=iO(e),_.text[n]=(t,e)=>{const n=_.text[i](t,e);return nO(n)?iO(n)(t,e):n});const o=GF(_.text,_.text,b,v);if("width"!==t&&"both"!==t||(S[0]=o[0]*r.length),"height"!==t&&"both"!==t||(S[1]=o[1]),o[0]&&o[1]){let t=_.markerTextFitPadding||[0,0,0,0];h&&(t=h(v,b)),S[0]+=t[1]+t[3],S[1]+=t[0]+t[2]}}else S[0]=S[1]=-1}}if(C&&(S=GF(_,this.symbolDef,b,v)),!S)return x;if(S[0]=Math.ceil(S[0]),S[1]=Math.ceil(S[1]),this.size=S,M&&S[0]>=0&&S[1]>=0){let t;if(T){const e={};if(e.markerType=T,"path"===T&&(e.markerPath=n?n(null,b):_.markerPath,e.markerPathWidth=g?g(null,b):_.markerPathWidth,e.markerPathHeight=m?m(null,b):_.markerPathHeight),r){const t=r(null,b);sL(t)||(e.markerWidth=t)}else _.markerWidth>=0&&(e.markerWidth=_.markerWidth);if(i){const t=i(null,b);sL(t)||(e.markerHeight=t)}else _.markerHeight>=0&&(e.markerHeight=_.markerHeight);if(o){const t=o(null,b);sL(t)||(e.markerFill=t)}else _.markerFill&&(e.markerFill=_.markerFill);if(s){const t=s(null,b);sL(t)||(e.markerFillPatternFile=t)}else _.markerFillPatternFile&&(e.markerFillPatternFile=_.markerFillPatternFile);if(a){const t=a(null,b);sL(t)||(e.markerFillOpacity=t)}else _.markerFillOpacity>=0&&(e.markerFillOpacity=_.markerFillOpacity);if(u){const t=u(null,b);sL(t)||(e.markerLineColor=t)}else _.markerLineColor&&(e.markerLineColor=_.markerLineColor);if(c){const t=c(null,b);sL(t)||(e.markerLineWidth=t)}else _.markerLineWidth>=0&&(e.markerLineWidth=_.markerLineWidth);if(f){const t=f(null,b);sL(t)||(e.markerLineOpacity=t)}else _.markerLineOpacity>=0&&(e.markerLineOpacity=_.markerLineOpacity);if(d){const t=d(null,b);sL(t)||(e.markerLineDasharray=t)}else _.markerLineDasharray&&(e.markerLineDasharray=_.markerLineDasharray);if(p){const t=p(null,b);sL(t)||(e.markerLinePatternFile=t)}else _.markerLinePatternFile&&(e.markerLinePatternFile=_.markerLinePatternFile);t="vector://"+JSON.stringify(e)}else t=w?w.replace(mz,this.ft):_.markerPath?function(t,e,n){if(!t.markerPath)return null;let r=1;const i=function(t){const e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}(t);aL(t.markerOpacity)&&(r=t.markerOpacity),aL(t.opacity)&&(r*=t.opacity);const o={};if(i){for(const t in i.stroke)cL(i.stroke,t)&&(sL(i.stroke[t])||(o[t]=i.stroke[t]));for(const t in i.fill)cL(i.fill,t)&&(sL(i.fill[t])||(o[t]=i.fill[t]))}const s=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let a;const l=[];for(let u=0;u<s.length;u++)a=hL(s[u])?{path:s[u]}:s[u],a=oL({},a,o),a.d=a.path,delete a.path,l.push(a);const h=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];r<1&&h.push('opacity="'+r+'"'),t.markerPathWidth&&t.markerPathHeight&&h.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),h.push('preserveAspectRatio="none"'),e&&h.push('width="'+e+'"'),n&&h.push('height="'+n+'"'),h.push("><defs></defs>");for(let u=0;u<l.length;u++){let t="<path ";for(const e in l[u])cL(l[u],e)&&(t+=" "+e+'="'+l[u][e]+'"');t+="></path>",h.push(t)}return h.push("</svg>"),"data:image/svg+xml;base64,"+btoa(h.join(" "))}(_,S[0],S[1]):null;x.icon={url:t,size:S}}if(C){const t=A?A(this.options.zoom,b):_.textName;if(t||0===t){const e=function(t){return t||"Open Sans Regular"}(y?y(null,b):_.textFaceName);let n=ZF(t,b);n&&n.length&&(n=function(t){if(!function(t){for(const e of t)if(ez(e.charCodeAt(0)))return!0;return!1}(t))return t;const e=[],n=[],r=[];let i=0,o=0,s=1,a=1;for(const l of t){const t=l.codePointAt(0);rz(t)?(r.push(l),i++):(s=ez(t)?-1:1,a!==s?(o=i,n.length&&(a>0&&n.reverse(),e.push(...n)),r.length&&(e.splice(o,0,...r),r.length=0),a=s,n.length=0):r.length&&(n.push(...r),r.length=0),n.push(l),i++)}return r.length&&n.push(...r),n.length&&(a>0&&n.reverse(),e.push(...n)),e.reverse().join("")}(n),x.glyph={font:e,text:n})}}return this.iconGlyph=x,x}};function yz(t,e){e&&"middle"!==e||(e="center"),t&&"middle"!==t||(t="center");let n="center"!==e?e:"";return n+="center"!==t?(n.length?"-":"")+t:"",n}function vz(t,e,n,r,i){const o=[];let s;for(let a=0;a<t.length;a++){const l=t[a];let h,u=!1;for(let t=0;t<l.length-1;t++){let a=l[t],c=l[t+1];a.x<e&&c.x<e||(a.x<e?(s=a,a=new Ck(e,a.y+(c.y-a.y)*((e-a.x)/(c.x-a.x))).F(),a.z=s.z+(c.z-s.z)*((e-s.x)/(c.x-s.x)),u=!0):c.x<e&&(s=c,c=new Ck(e,a.y+(c.y-a.y)*((e-a.x)/(c.x-a.x))).F(),c.z=a.z+(s.z-a.z)*((e-a.x)/(s.x-a.x)),u=!0),a.y<n&&c.y<n||(a.y<n?(s=a,a=new Ck(a.x+(c.x-a.x)*((n-a.y)/(c.y-a.y)),n).F(),a.z=s.z+(c.z-s.z)*((n-s.y)/(c.y-s.y)),u=!0):c.y<n&&(s=c,c=new Ck(a.x+(c.x-a.x)*((n-a.y)/(c.y-a.y)),n).F(),c.z=a.z+(s.z-a.z)*((n-a.y)/(s.y-a.y)),u=!0),a.x>=r&&c.x>=r||(a.x>=r?(s=a,a=new Ck(r,a.y+(c.y-a.y)*((r-a.x)/(c.x-a.x))).F(),a.z=s.z+(c.z-s.z)*((r-s.x)/(c.x-s.x)),u=!0):c.x>=r&&(s=c,c=new Ck(r,a.y+(c.y-a.y)*((r-a.x)/(c.x-a.x))).F(),c.z=a.z+(s.z-a.z)*((r-a.x)/(s.x-a.x)),u=!0),a.y>=i&&c.y>=i||(a.y>=i?(s=a,a=new Ck(a.x+(c.x-a.x)*((i-a.y)/(c.y-a.y)),i).F(),a.z=s.z+(c.z-s.z)*((i-s.y)/(c.y-s.y)),u=!0):c.y>=i&&(s=c,c=new Ck(a.x+(c.x-a.x)*((i-a.y)/(c.y-a.y)),i).F(),c.z=a.z+(s.z-a.z)*((i-a.y)/(s.y-a.y)),u=!0),h&&a.equals(h[h.length-1])||(h=[a],o.push(h)),u&&(h.clipped=!0),h.push(c)))))}}return o}let xz=class t extends Ck{constructor(t,e,n,r){super(t,e),this.angle=n,void 0!==r&&(this.segment=r)}clone(){return new t(this.x,this.y,this.angle,this.segment)}};function _z(t,e,n,r,i){if(void 0===e.segment)return!0;let o=e,s=e.segment+1,a=0;for(;a>-n/2;){if(s--,s<0)return!1;a-=t[s].dist(o),o=t[s]}a+=t[s].dist(t[s+1]),s++;const l=[];let h=0;for(;a<n/2;){const e=t[s-1],n=t[s],o=t[s+1];if(!o)return!1;let u=e.angleTo(n)-n.angleTo(o);for(u=Math.abs((u+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:u}),h+=u;a-l[0].distance>r;)h-=l.shift().angleDelta;if(h>i)return!1;s++,a+=n.dist(o)}return!0}function bz(t,e,n,r,i,o,s,a,l,h,u){const c=(p=o,g=s,r?.6*p*g:0),f=function(t){return Math.max(t?t.right-t.left:0,0)}(r),d=0===t[0].x||t[0].x===l||0===t[0].y||t[0].y===l;var p,g;return e-f*s<e/4&&(e=f*s+e/4),wz(t,d?e/2*a%e:(f/2+2*o)*s*a%e,e,c,n,f*s,d,!1,l,h,u)}function wz(t,e,n,r,i,o,s,a,l,h,u){let c=0;const f=o/2,d=function(t){let e=0;for(let n=0;n<t.length-1;n++)e+=t[n].dist(t[n+1]);return e}(t);let p=0,g=e-n,m=[];for(let A=0;A<t.length-1;A++){const e=t[A],s=t[A+1],a=e.dist(s),y=s.angleTo(e);for(;g+n<p+a;){g+=n;const v=(g-p)/a,x=Tz(e.x,s.x,v),_=Tz(e.y,s.y,v),b=Tz(e.z||0,s.z||0,v);if(x>=0&&x<l&&_>=0&&_<l&&g-f>=0&&g+f<=d){const n=new xz(x,_,y,A);n.z=b,h&&(n.axis=[e.y-_,x-e.x],n.angleR=b===(e.z||0)?0:Math.atan(.9*(b-(e.z||0))*u/e.dist(n))),n.line=t,n.F(),!r||_z(t,n,o,r,i)?m.push(n):r&&c++}}p+=a}return a||m.length||s||(m=wz(t,p/2,n,r,i,o,s,!0,l,h,u)),m.countOutOfAngle=c,m}function Tz(t,e,n){return t*(1-n)+e*n}function Mz(t,e){const n=t.length;if(n<=1)return[t];const r=[];let i,o;for(let s=0;s<n;s++){const e=Uk(t[s]);0!==e&&(t[s].area=Math.abs(e),void 0===o&&(o=e<0),o===e<0?(i&&r.push(i),i=[t[s]]):i.push(t[s]))}if(i&&r.push(i),e>1)for(let s=0;s<r.length;s++)r[s].length<=e||(fR(r[s],e,1,r[s].length-1,Cz),r[s]=r[s].slice(0,e));return r}function Cz(t,e){return e.area-t.area}let Sz=class{constructor(t=[],e=Iz){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this.gt(n)}push(t){this.data.push(t),this.length++,this.vt(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this.gt(0)),t}peek(){return this.data[0]}vt(t){const{data:e,compare:n}=this,r=e[t];for(;t>0;){const i=t-1>>1,o=e[i];if(n(r,o)>=0)break;e[t]=o,t=i}e[t]=r}gt(t){const{data:e,compare:n}=this,r=this.length>>1,i=e[t];for(;t<r;){let r=1+(t<<1),o=e[r];const s=r+1;if(s<this.length&&n(e[s],o)<0&&(r=s,o=e[s]),n(o,i)>=0)break;e[t]=o,t=r}e[t]=i}};function Iz(t,e){return t<e?-1:t>e?1:0}function Pz(t,e,n){const r=e.distSqr(n);if(0===r)return t.distSqr(e);const i=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/r;return i<0?t.distSqr(e):i>1?t.distSqr(n):t.distSqr(n.sub(e).A(i).i(e))}function Ez(t,e=1,n=!1){let r=1/0,i=1/0,o=-1/0,s=-1/0;const a=t[0];for(let g=0;g<a.length;g++){const t=a[g];(!g||t.x<r)&&(r=t.x),(!g||t.y<i)&&(i=t.y),(!g||t.x>o)&&(o=t.x),(!g||t.y>s)&&(s=t.y)}const l=o-r,h=s-i,u=Math.min(l,h);let c=u/2;const f=new Sz([],Oz);if(0===u)return new Ck(r,i);for(let g=r;g<o;g+=u)for(let e=i;e<s;e+=u)f.push(new Rz(g+c,e+c,c,t));let d=function(t){let e=0,n=0,r=0;const i=t[0];for(let o=0,s=i.length,a=s-1;o<s;a=o++){const t=i[o],s=i[a],l=t.x*s.y-s.x*t.y;n+=(t.x+s.x)*l,r+=(t.y+s.y)*l,e+=3*l}return new Rz(n/e,r/e,0,t)}(t),p=f.length;for(;f.length;){const r=f.pop();(r.d>d.d||!d.d)&&(d=r,n&&Math.round(1e4*r.d)),r.max-d.d<=e||(c=r.h/2,f.push(new Rz(r.p.x-c,r.p.y-c,c,t)),f.push(new Rz(r.p.x+c,r.p.y-c,c,t)),f.push(new Rz(r.p.x-c,r.p.y+c,c,t)),f.push(new Rz(r.p.x+c,r.p.y+c,c,t)),p+=4)}return n&&d.d,d.p}function Oz(t,e){return e.max-t.max}function Rz(t,e,n,r){this.p=new Ck(t,e),this.h=n,this.d=function(t,e){let n=!1,r=1/0;for(let i=0;i<e.length;i++){const o=e[i];for(let e=0,i=o.length,s=i-1;e<i;s=e++){const i=o[e],a=o[s];i.y>t.y!=a.y>t.y&&t.x<(a.x-i.x)*(t.y-i.y)/(a.y-i.y)+i.x&&(n=!n),r=Math.min(r,Pz(t,i,a))}}return(n?1:-1)*Math.sqrt(r)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}function kz(t,e){const n={},r={},i=[];let o=0;function s(e){i.push(t[e]),o++}function a(t,e,n){const o=r[t];return delete r[t],r[e]=o,i[o].geometry[0].pop(),i[o].geometry[0]=i[o].geometry[0].concat(n[0]),o}function l(t,e,r){const o=n[e];return delete n[e],n[t]=o,i[o].geometry[0].shift(),i[o].geometry[0]=r[0].concat(i[o].geometry[0]),o}function h(t,e,n){const r=n?e[0][e[0].length-1]:e[0][0];return`${t}:${r.x}:${r.y}`}for(let u=0;u<t.length;u++){const c=t[u],f=c.geometry;if(!f)continue;const d=c.properties[e]?c.properties[e].toString():null;if(!d){s(u);continue}const p=h(d,f),g=h(d,f,!0);if(p in r&&g in n&&r[p]!==n[g]){const t=l(p,g,f),e=a(p,g,i[t].geometry);delete n[p],delete r[g],r[h(d,i[e].geometry,!0)]=e,i[t].geometry=null}else p in r?a(p,g,f):g in n?l(p,g,f):(s(u),n[p]=o-1,r[g]=o-1)}return i.filter((t=>t.geometry))}const Lz="__index";function Dz(t,e,n,r){const i=(Lz+"").trim(),o=function(t,e,n,r){const i=(Lz+"").trim(),{mergeOnPropertyFn:o}=n;if(!e.mergeOnProperty)return[];if(!qk(s=e.mergeOnProperty)&&("string"==typeof s||null!==s.constructor&&s.constructor===String))return[{features:t,property:e.mergeOnProperty}];var s;const a=[],l={},h=[];for(let u=0;u<t.length;u++){t[u][i]=u;const n=t[u].properties=t[u].properties||{};n.$layer=t[u].layer,n.$type=t[u].type;const s=o?o(r,n):e.mergeOnProperty;qk(s)?h.push(t[u]):(void 0===l[s]&&(l[s]=a.length,a.push({features:[],property:s})),a[l[s]].features.push(t[u]))}return h.length&&a.push({features:h}),a}(t,e,n,r);if(o.length){const e=[];for(let n=0;n<o.length;n++)o[n].property?e.push(kz(o[n].features,o[n].property)):e.push(t);if(1===e.length)return e[0];{let t=[];for(let n=0;n<e.length;n++)t=t.concat(e[n]);return t.sort(((t,e)=>t[i]-e[i])),t}}return[]}let Nz=class t extends HF{static needMerge(t,e,n){if(!t)return!1;let r="line"===t.textPlacement||"line"===t.markerPlacement;return r||(e.textPlacementFn&&(r="line"===e.textPlacementFn(n)),e.markerPlacementFn&&(r="line"===e.markerPlacementFn(n))),t.mergeOnProperty&&r}static mergeLineFeatures(t,e,n,r){let i=e.textPlacement,o=e.markerPlacement;return n.textPlacementFn&&(i=n.textPlacementFn(r)),n.markerPlacementFn&&(o=n.markerPlacementFn(r)),"line"!==i&&"line"!==o?t:Dz(t,e,n,r)}static splitPointSymbol(e,n=0){const r=[];if(Array.isArray(e)){const n=e;for(let e=0;e<n.length;e++)n[e]&&r.push(...t.splitPointSymbol(n[e],e));return r}let i=null,o=null;for(const t in e)0===t.indexOf("marker")?(i=i||{},i[t]=e[t]):0===t.indexOf("text")&&(o=o||{},o[t]=e[t]);return i&&(i.isIconText=!0,e.mergeOnProperty&&(i.mergeOnProperty=e.mergeOnProperty),r.push(i)),o&&(i&&(o.textPlacement=i.markerPlacement,o.textSpacing=i.markerSpacing,o.isIconText=!0),e.mergeOnProperty&&(o.mergeOnProperty=e.mergeOnProperty),r.push(o)),void 0!==e.visible&&(i&&(i.visible=e.visible),o&&(o.visible=e.visible)),i&&(i.markerTextFit&&o&&(i.text={},i.text.textName=o.textName,i.text.textSize=o.textSize),i.index={index:n,type:0}),o&&(o.index={index:n,type:1}),r}static isAtlasLoaded(t,e){const{icon:n,glyph:r}=t,{iconAtlas:i,glyphAtlas:o}=e;if(n&&(!i||!i.positions[n.url]))return!1;if(r){if(!o||!o.positions[r.font])return!1;const t=o.positions[r.font],{text:e}=r;for(const n of e)if(!t[n.codePointAt(0)])return!1}return!0}constructor(t,e,n){super(t,e,n),this.xt=e.textPlacement,this.Z.textPlacementFn&&(this.xt=this.Z.textPlacementFn(this.options.zoom))}createStyledVector(t,e,n,r,i,o){const s=new Az(t,this.symbolDef,e,n,r),a=s.getIconAndGlyph();if(a.icon&&!this.options.atlas){const{url:t,size:e}=a.icon;i[t]||(i[t]=a.icon.size),i[t][0]<e[0]&&(i[t][0]=e[0]),i[t][1]<e[1]&&(i[t][1]=e[1])}if(a.glyph&&!this.options.atlas){const{font:t,text:e}=a.glyph,n=o[t]=o[t]||{};for(const r of e)n[r.codePointAt(0)]=1;"line"===this.xt&&(o.options={isCharsCompact:!1})}return this.options.allowEmptyPack||a.icon||a.glyph?s:null}getFormat(t){const e=void 0!==t.textName,n=e?this.getPackSDFFormat(t):this.getPackMarkerFormat();e?n.push(...this.bt()):n.push(...this.wt());const{markerOpacityFn:r,textOpacityFn:i,markerPitchAlignmentFn:o,textPitchAlignmentFn:s,markerRotationAlignmentFn:a,textRotationAlignmentFn:l,markerRotationFn:h,textRotationFn:u,markerAllowOverlapFn:c,textAllowOverlapFn:f,markerIgnorePlacementFn:d,textIgnorePlacementFn:p}=this.Z;return(r||i)&&n.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(o||s)&&n.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(a||l)&&n.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(h||u)&&n.push({type:Uint16Array,width:1,name:"aRotation"}),(c||f||d||p)&&n.push({type:Uint8Array,width:1,name:"aOverlap"}),n}At(){return this.hasMapPitchAlign}bt(){const{textFillFn:t,textSizeFn:e,textHaloFillFn:n,textHaloRadiusFn:r,textHaloOpacityFn:i,textDxFn:o,textDyFn:s}=this.Z,a=[];return t&&a.push({type:Uint8Array,width:4,name:"aTextFill"}),e&&a.push({type:Uint8Array,width:1,name:"aTextSize"}),n&&a.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),r&&a.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),i&&a.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),o&&a.push({type:Int8Array,width:1,name:"aTextDx"}),s&&a.push({type:Int8Array,width:1,name:"aTextDy"}),a}wt(){const{markerWidthFn:t,markerHeightFn:e,markerDxFn:n,markerDyFn:r}=this.Z,i=[];return t&&i.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),e&&i.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),n&&i.push({type:Int8Array,width:1,name:"aMarkerDx"}),r&&i.push({type:Int8Array,width:1,name:"aMarkerDy"}),i}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,e){const n=t.getShape(this.iconAtlas,this.glyphAtlas),r=!n||!n.image,i=!n||!n.horizontal&&!n.vertical;if(!this.options.allowEmptyPack&&r&&i)return;const o=this.Mt(t,n,e);if(this.countOutOfAngle+=o.countOutOfAngle||0,0===o.length)return;const s=this.data,a=this.needAltitudeAttribute()?2:3;let l=this.data.aPosition.getLength()/a;const h=t.symbol,u=t.feature.properties,c="line"===this.xt&&!h.isIconText,f=void 0!==h.textName,d=f&&c&&function(t){let e=0;for(let n=0;n<t.length;n++)if($F(t.charAt(n).charCodeAt(0)))e=0;else if(e++,e>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:p,textSizeFn:g,textHaloFillFn:m,textHaloRadiusFn:A,textHaloOpacityFn:y,textDxFn:v,textDyFn:x,textPitchAlignmentFn:_,textRotationAlignmentFn:b,textRotationFn:w,textAllowOverlapFn:T,textIgnorePlacementFn:M,textOpacityFn:C,markerWidthFn:S,markerHeightFn:I,markerDxFn:P,markerDyFn:E,markerPitchAlignmentFn:O,markerRotationAlignmentFn:R,markerRotationFn:k,markerAllowOverlapFn:L,markerIgnorePlacementFn:D,markerOpacityFn:N}=this.Z;let F,z,B,H,j,U,V,G,W,q,X,Z,Y,J,Q,K,$;if(f){const e=t.getIconAndGlyph().glyph.font;F=function(t,e,n){const r=t.positionedGlyphs,i=[];for(let o=0;o<r.length;o++){const s=r[o],a=n[s.glyph];if(!a)continue;const l=a.rect;if(!l)continue;const h=4,u=a.metrics.advance/2,c=a.metrics.height/2,f=e?[s.x+u,0]:[0,0],d=e?[0,s.y-c]:[s.x+u,s.y-c],p=a.metrics.left-h-u+d[0],g=a.metrics.top-h+d[1],m=p+l.w,A=g+l.h,y=new Ck(p,g),v=new Ck(m,g),x=new Ck(p,A),_=new Ck(m,A);if(e&&s.vertical){const t=new Ck(-u,u),e=-Math.PI/2,n=new Ck(5,0);y.k(e,t).i(n),v.k(e,t).i(n),x.k(e,t).i(n),_.k(e,t).i(n)}i.push({tl:y,tr:v,bl:x,br:_,tex:l,writingMode:t.writingMode,glyphOffset:f})}return i}(n.horizontal,c,this.glyphAtlas.positions[e]),p&&(z=p(null,u),nO(z)?(this.dynamicAttrs.aTextFill=1,z=[0,0,0,0]):z=pL([],z)),g&&(B=g(this.options.zoom,u),qk(B)&&(B=14)),m&&(H=m(null,u),nO(H)?(this.dynamicAttrs.aTextHaloFill=1,H=[0,0,0,0]):H=pL([],H)),A&&(j=A(null,u)),y&&(U=255*y(null,u)),v&&(V=v(null,u)||0),x&&(G=x(null,u)||0),_&&(Y=+("map"===_(null,u))),b&&(J=+("map"===b(null,u))),w&&(Q=Xk(w(null,u),0,360)*Math.PI/180)}else F=n?function(t){const e=t.image,n=t.top-1/e.pixelRatio,r=t.left-1/e.pixelRatio,i=t.bottom+1/e.pixelRatio,o=t.right+1/e.pixelRatio;let s,a,l,h;return s=new Ck(r,n),a=new Ck(o,n),l=new Ck(o,i),h=new Ck(r,i),[{tl:s,tr:a,bl:h,br:l,tex:{x:e.tl[0],y:e.tl[1],w:e.displaySize[0],h:e.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(n):function(){const t=new Ck(0,0),e=new Ck(0,0),n=new Ck(0,0);return[{tl:t,tr:e,bl:new Ck(0,0),br:n,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),S&&(W=S(null,u)),qk(W)&&(W=F[0].tex.w),I&&(q=I(null,u)),qk(q)&&(q=F[0].tex.h),P&&(X=P(null,u)),E&&(Z=E(null,u)),O&&(Y=+("map"===O(null,u))),R&&(J=+("map"===R(null,u))),k&&(Q=Xk(k(null,u),0,360)*Math.PI/180);nO(B)&&(this.dynamicAttrs.aTextSize=1),nO(j)&&(this.dynamicAttrs.aTextHaloRadius=1),nO(U)&&(this.dynamicAttrs.aTextHaloOpacity=1),nO(V)&&(this.dynamicAttrs.aTextDx=1),nO(G)&&(this.dynamicAttrs.aTextDy=1),nO(W)&&(this.dynamicAttrs.aMarkerWidth=1),nO(q)&&(this.dynamicAttrs.aMarkerHeight=1),nO(X)&&(this.dynamicAttrs.aMarkerDx=1),nO(Z)&&(this.dynamicAttrs.aMarkerDy=1),nO(Y)&&(this.dynamicAttrs.aPitchAlign=1),nO(J)&&(this.dynamicAttrs.aRotationAlign=1),nO(Q)&&(this.dynamicAttrs.aRotation=1);const tt=L||T;tt&&(K=tt(null,u)||0);const et=D||M;let nt;et&&($=et(null,u)||0);const rt=C||N;rt&&(nt=255*rt(this.options.zoom,u));const it=F.length;this.ensureDataCapacity(4*it,o.length);const ot=this.options.EXTENT,{altitudeScale:st,altitudeProperty:at,defaultAltitude:lt}=this.options,{altitude:ht}=Gk(t.feature,st,at,lt);for(let ut=0;ut<o.length;ut++){const t=o[ut],e=t.z||ht||0;if(ot!==1/0&&Wk(t,ot))continue;const n=t.x,r=t.y,i=F.length;for(let o=0;o<i;o++){const i=F[o],{tl:a,tr:h,bl:u,br:p,tex:g}=i;this._t(s,n,r,e,10*a.x,10*a.y,g.x,g.y+g.h),f&&this.St(s,c,it,i.glyphOffset,t,d,t.axis,t.angleR),this.kt(s,z,B,H,j,U,V,G,W,q,X,Z,nt,Y,J,Q,K,$),this._t(s,n,r,e,10*h.x,10*h.y,g.x+g.w,g.y+g.h),f&&this.St(s,c,it,i.glyphOffset,t,d,t.axis,t.angleR),this.kt(s,z,B,H,j,U,V,G,W,q,X,Z,nt,Y,J,Q,K,$),this._t(s,n,r,e,10*u.x,10*u.y,g.x,g.y),f&&this.St(s,c,it,i.glyphOffset,t,d,t.axis,t.angleR),this.kt(s,z,B,H,j,U,V,G,W,q,X,Z,nt,Y,J,Q,K,$),this._t(s,n,r,e,10*p.x,10*p.y,g.x+g.w,g.y),f&&this.St(s,c,it,i.glyphOffset,t,d,t.axis,t.angleR),this.kt(s,z,B,H,j,U,V,G,W,q,X,Z,nt,Y,J,Q,K,$),this.addElements(l,l+1,l+2),this.addElements(l+1,l+2,l+3),l+=4;const m=Math.max(Math.abs(n),Math.abs(r),Math.abs(e));m>this.maxPos&&(this.maxPos=m)}}}_t(t,e,n,r,i,o,s,a){this.fillPosition(t,e,n,r);let l=t.aShape.currentIndex;t.aShape[l++]=i,t.aShape[l++]=o,t.aShape.currentIndex=l,l=t.aTexCoord.currentIndex,t.aTexCoord[l++]=s,t.aTexCoord[l++]=a,t.aTexCoord.currentIndex=l}St(t,e,n,r,i,o,s,a){let l=t.aCount.currentIndex;if(t.aCount[l++]=n,t.aCount.currentIndex=l,e){l=t.aGlyphOffset.currentIndex,t.aGlyphOffset[l++]=r[0],t.aGlyphOffset[l++]=r[1],t.aGlyphOffset.currentIndex=l,this.At()&&(l=t.aPitchRotation.currentIndex,t.aPitchRotation[l++]=s[0],t.aPitchRotation[l++]=s[1],t.aPitchRotation[l++]=a,t.aPitchRotation.currentIndex=l);const e=i.startIndex;l=t.aSegment.currentIndex,t.aSegment[l++]=i.segment+e,t.aSegment[l++]=e,t.aSegment[l++]=i.line.length,t.aSegment.currentIndex=l,l=t.aVertical.currentIndex,t.aVertical[l++]=o,t.aVertical.currentIndex=l}}kt(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g,m,A){const{textFillFn:y,textSizeFn:v,textHaloFillFn:x,textHaloRadiusFn:_,textHaloOpacityFn:b,textDxFn:w,textDyFn:T,textPitchAlignmentFn:M,textRotationAlignmentFn:C,textRotationFn:S,textAllowOverlapFn:I,textIgnorePlacementFn:P,textOpacityFn:E,markerWidthFn:O,markerHeightFn:R,markerDxFn:k,markerDyFn:L,markerPitchAlignmentFn:D,markerRotationAlignmentFn:N,markerRotationFn:F,markerAllowOverlapFn:z,markerIgnorePlacementFn:B,markerOpacityFn:H}=this.Z;if(y){let n=t.aTextFill.currentIndex;t.aTextFill[n++]=e[0],t.aTextFill[n++]=e[1],t.aTextFill[n++]=e[2],t.aTextFill[n++]=e[3],t.aTextFill.currentIndex=n}if(v){let e=t.aTextSize.currentIndex;t.aTextSize[e++]=n,t.aTextSize.currentIndex=e}if(x){let e=t.aTextHaloFill.currentIndex;t.aTextHaloFill[e++]=r[0],t.aTextHaloFill[e++]=r[1],t.aTextHaloFill[e++]=r[2],t.aTextHaloFill[e++]=r[3],t.aTextHaloFill.currentIndex=e}if(_){let e=t.aTextHaloRadius.currentIndex;t.aTextHaloRadius[e++]=i,t.aTextHaloRadius.currentIndex=e}if(b){let e=t.aTextHaloOpacity.currentIndex;t.aTextHaloOpacity[e++]=o,t.aTextHaloOpacity.currentIndex=e}if(w){let e=t.aTextDx.currentIndex;t.aTextDx[e++]=s,t.aTextDx.currentIndex=e}if(T){let e=t.aTextDy.currentIndex;t.aTextDy[e++]=a,t.aTextDy.currentIndex=e}if(O){let e=t.aMarkerWidth.currentIndex;t.aMarkerWidth[e++]=l,t.aMarkerWidth.currentIndex=e}if(R){let e=t.aMarkerHeight.currentIndex;t.aMarkerHeight[e++]=h,t.aMarkerHeight.currentIndex=e}if(k){let e=t.aMarkerDx.currentIndex;t.aMarkerDx[e++]=u,t.aMarkerDx.currentIndex=e}if(L){let e=t.aMarkerDy.currentIndex;t.aMarkerDy[e++]=c,t.aMarkerDy.currentIndex=e}if(H||E){let e=t.aColorOpacity.currentIndex;t.aColorOpacity[e++]=f,t.aColorOpacity.currentIndex=e}if(M||D){let e=t.aPitchAlign.currentIndex;t.aPitchAlign[e++]=d,t.aPitchAlign.currentIndex=e}if(N||C){let e=t.aRotationAlign.currentIndex;t.aRotationAlign[e++]=p,t.aRotationAlign.currentIndex=e}if(F||S){let e=t.aRotation.currentIndex;t.aRotation[e++]=9362*g,t.aRotation.currentIndex=e}const j=z||I,U=B||P;if(j||U){const e=(j?8:0)+4*m,n=(U?2:0)+A;let r=t.aOverlap.currentIndex;t.aOverlap[r++]=e+n,t.aOverlap.currentIndex=r}i>0&&(this.properties.hasHalo=1)}Mt(t,e,n){const{feature:r,symbol:i}=t,o=this.Pt(t,i),s=r.properties,{markerSpacingFn:a,textSpacingFn:l,textMaxAngleFn:h}=this.Z,u=((a?a(null,s):i.markerSpacing)||(l?l(null,s):i.textSpacing)||250)*n;let c=h?h(this.options.zoom,s):i.textMaxAngle;qk(c)&&(c=80),c*=Math.PI/180;const f=this.options.EXTENT,d=this.options.altitudeToTileScale,p=this.At();return function(t,e,n,r,i,o,s,a,l,h){const{feature:u,size:c,symbol:f}=t,d=c?24:0,p=i*(c?c[0]/d:1);if("line"===s){const t=[];t.countOutOfAngle=0;let i=u.geometry;o&&(i=vz(u.geometry,0,0,o,o));for(let s=0;s<i.length;s++){const u=bz(i[s],a,n,f.isIconText?null:r&&r.vertical||r&&r.horizontal||r,0,d,f.isIconText?1:p,1,o||1/0,l,h);if(f.textPlacement&&!f.isIconText)for(let t=0;t<u.length;t++)u[t].startIndex=e.length/3;if(t.push.apply(t,u),f.textPlacement&&!f.isIconText)for(let t=0;t<i[s].length;t++)e.push(i[s][t].x,i[s][t].y,i[s][t].z||0);t.countOutOfAngle+=u.countOutOfAngle||0}return t}return function(t,e,n){const r=[];if(3===t.type){const i=Mz(t.geometry,0);for(let t=0;t<i.length;t++){const o=i[t];if("vertex"===e)for(let t=0;t<o.length;t++){const e=o[t];for(let t=0;t<e.length;t++)Wk(e[t],n)||r.push(e[t])}else if("vertex-first"===e){const t=o[0];t&&t[0]&&!Wk(t[0],n)&&r.push(t[0])}else if("vertex-last"===e||"vertex-firstlast"===e){const t=o[0];if("vertex-firstlast"===e&&t&&t[0]&&!Wk(t[0],n)&&r.push(t[0]),t&&t[t.length-1]&&!Wk(t[t.length-1],n)){const e=t.length-1;r.push(t[e])}}else{const t=Ez(o,16);Wk(t,n)||r.push(t)}}}else if(2===t.type)for(let i=0;i<t.geometry.length;i++){const o=t.geometry[i];if("vertex"===e)for(let t=0;t<o.length;t++)Wk(o[t],n)||r.push(o[t]);else if("vertex-last"===e||"vertex-firstlast"===e){if("vertex-firstlast"!==e||Wk(o[0],n)||r.push(o[0]),o&&o[o.length-1]&&!Wk(o[o.length-1],n)){const t=o.length-1;r.push(o[t])}}else Wk(o[0],n)||r.push(o[0])}else if(1===t.type)for(let i=0;i<t.geometry.length;i++){const e=t.geometry[i];for(let t=0;t<e.length;t++){const i=e[t];Wk(i,n)||r.push(i)}}return r}(u,s,o)}(t,this.lineVertex,c,e,n,f,o,u,p,d)}Pt(t,e){let n;return n=this.Z.markerPlacementFn?this.Z.markerPlacementFn(this.options.zoom,t.feature.properties):e.markerPlacement||this.xt,this.ut||!e.markerPlacement&&!e.isIconText||(this.ut=n),!this.xt||e.isIconText||this.ct||(this.ct=n),n}getPackSDFFormat(t){if("line"!==this.xt||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this.At()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}},Fz=class t{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new t(this)}T(){return this.M(this.mag()),this}M(t){return this.x/=t,this.y/=t,this.z/=t,this}I(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone().i(t)}sub(t){return this.clone().o(t)}i(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}o(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone().A(t)}A(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var e=t.x-this.x,n=t.y-this.y,r=t.z-this.z;return e*e+n*n+r*r}F(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}};const zz=Math.cos(Math.PI/180*37.5),Bz=Math.pow(2,16)/1,Hz=new Ck,jz=new Ck,Uz=new Ck;let Vz=class extends HF{static mergeLineFeatures(t,e,n,r){return Dz(t,e,n,r)}constructor(t,e,n){super(t,e,n);let r=!1;const{lineDasharrayFn:i,lineDashColorFn:o}=this.Z;this.hasGradient=this.symbol.lineGradientProperty,i&&(r=function(t,e,n){for(let r=0;r<t.length;r++)if(n(e,t[r].properties))return!0;return!1}(t,this.options.zoom,i),r&&(this.dasharrayFn=i)),this.hasDasharray=qz(this.symbol.lineDasharray)||r,this.hasDasharray&&o&&(this.dashColorFn=o)}createStyledVector(t,e,n,r,i){const o=new mL(t,e,n,r),s=o.getLineResource();return!this.options.atlas&&s&&(i[s]=[0,0]),o}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:e,lineStrokeColorFn:n,lineColorFn:r,lineOpacityFn:i,lineDxFn:o,lineDyFn:s,linePatternAnimSpeedFn:a,linePatternGapFn:l}=this.Z,h=[...this.getPositionFormat()];if(this.iconAtlas||this.hasDasharray?h.push({type:Int8Array,width:3,name:"aExtrude"}):h.push({type:Int8Array,width:2,name:"aExtrude"}),h.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&h.push({type:Uint8Array,width:1,name:"aLineWidth"}),e&&h.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),r&&h.push({type:Uint8Array,width:4,name:"aColor"}),n&&h.push({type:Uint8Array,width:4,name:"aStrokeColor"}),i&&h.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&h.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&h.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();h.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(o||s)&&h.push({type:Int8Array,width:2,name:"aLineDxDy"}),(a||l)&&h.push({type:Int8Array,width:2,name:"aLinePattern"}),h}placeVector(t){const{lineJoinFn:e,lineCapFn:n,lineWidthFn:r,lineHeightFn:i,lineStrokeWidthFn:o,lineStrokeColorFn:s,lineColorFn:a,lineOpacityFn:l,lineDxFn:h,lineDyFn:u,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.Z,d=this.symbol,p=t.feature,g=p.properties;this.elements;let m=d.lineJoin||"miter",A=d.lineCap||"butt";if(e&&(m=e(this.options.zoom,g)||"miter"),n&&(A=n(this.options.zoom,g)||"butt"),r){let t=r(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),sL(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+d.lineWidth;if(i){let t=i(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLineHeight=1),sL(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+d.lineHeight||this.feaLineWidth;if(o){let t=o(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),sL(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=d.lineStrokeWidth||0;if(a&&(this.feaColor=a(this.options.zoom,g)||[255,255,255,255],nO(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=pL([],this.feaColor)),s&&(this.feaStrokeColor=s(this.options.zoom,g)||[0,0,0,255],nO(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=pL([],this.feaStrokeColor)),l){let t=l(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aOpacity=1,t=1),sL(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,g)||[0,0,0,0];if(nO(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const e=t;1===t.length?t=[e[0],e[0],e[0],e[0]]:2===t.length?t=[e[0],e[1],e[0],e[1]]:3===t.length&&(t=[e[0],e[1],e[2],e[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,g):this.symbol.lineDashColor)||[0,0,0,0];nO(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=pL([],t),this.feaDashColor=t}if(this.iconAtlas){const e=t.getLineResource(),n=this.iconAtlas.glyphMap[e];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],n){const{tl:t,displaySize:n}=this.iconAtlas.positions[e];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=n[0]-3,this.feaTexInfo[3]=n[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(h){let t=h(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),sL(t)&&(t=0),this.feaLineDx=t}if(u){let t=u(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),sL(t)&&(t=0),this.feaLineDy=t}if(c){let t=c(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),sL(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(f){let t=f(this.options.zoom,g);nO(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),sL(t)&&(t=0),this.feaLinePatternGap=t}const y=this.options.EXTENT;let v=p.geometry;if(y!==1/0){v=[];const t=[];for(let e=0;e<p.geometry.length;e++){t[0]=p.geometry[e];const n=vz(t,-1,-1,y+1,y+1);if(3===p.type&&n.length>1){const t=n[0],e=n[n.length-1];Jz(t[0],e[e.length-1])&&(n[0]=e.concat(t.slice(1)),n.length=n.length-1)}v.push(...n)}}const x=this.needAltitudeAttribute()?2:3;for(let _=0;_<v.length;_++){this.offset=this.data.aPosition.getLength()/x;const t=v[_];this.Tt(t,p,m,A,2,1.05)}}It(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}Tt(t,e,n,r,i,o){const s=this.It()||qz(this.feaDash)||qz(this.symbol.lineDasharray),a=this.options.isTube;a&&(t=t.map((t=>new Fz(t)))),this.overscaling=1;const l=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&e.properties&&aL(e.properties.mapbox_clip_start)&&aL(e.properties.mapbox_clip_end)){this.clipStart=+e.properties.mapbox_clip_start,this.clipEnd=+e.properties.mapbox_clip_end;for(let e=0;e<t.length-1;e++)this.totalDistance+=t[e].dist(t[e+1]);this.updateScaledDistance()}const h=3===e.type&&!t.clipped;let u=t.length;for(;u>=2&&Jz(t[u-1],t[u-2]);)u--;let c=0;for(;c<u-1&&Jz(t[c],t[c+1]);)c++;if(u<(h?3:2))return;"bevel"===n&&(i=1.05);const f=this.overscaling<=16?15*l/(512*this.overscaling):0,d={vertexLength:0,primitiveLength:0,currentNormal:null};let p,g,m,A,y;this.e1=this.e2=-1,h&&(p=t[u-2],y=t[c].sub(p).T().I()),this.ensureDataCapacity(n,u,360,2);for(let v=c;v<u;v++){if(m=v===u-1?h?t[c+1]:void 0:t[v+1],m&&Jz(t[v],m))continue;y&&(A=y),p&&(g=p),p=t[v],m&&p.x===m.x&&p.y===m.y&&(p.x+=1e-4),y=m?m.sub(p).T().I():A,d.dir=g?p.sub(g).T():m.sub(p).T(),A=A||y,d.currentNormal=A;let e=A.add(y);0===e.x&&0===e.y||e.T();const l=A.x*y.x+A.y*y.y,x=e.x*y.x+e.y*y.y,_=0!==x?1/x:1/0,b=2*Math.sqrt(2-2*x),w=x<zz&&g&&m,T=A.x*y.y-A.y*y.x>0;if(!a&&w&&v>c){const t=p.dist(g);if(t>2*f){const e=p.sub(p.sub(g).A(f/t).F());e.z=p.z,this.updateDistance(g,e),this.addCurrentVertex(e,A,0,0,d),g=e}}const M=g&&m;d.middleVertex=M;let C=M?n:h?"butt":r;if(M&&"round"===C&&(_<o?C="miter":_<=2&&(C="fakeround")),"miter"===C&&_>i&&!a&&(C="bevel"),"bevel"===C&&(_>2&&(C="flipbevel"),_<i&&(C="miter")),g&&this.updateDistance(g,p),"miter"===C)a?(this.addCurrentVertex(p,A,0,0,d),d.dir=m.sub(p).T(),this.addCurrentVertex(p,y,0,0,d)):(e.A(_),this.addCurrentVertex(p,e,0,0,d),s&&(d.currentNormal=y,d.dir=m.sub(p).T(),this.addCurrentVertex(p,e,0,0,d)));else if("flipbevel"===C){if(_>100)e=y.mult(-1);else{const t=_*A.add(y).mag()/A.sub(y).mag();e.I().A(t*(T?-1:1))}this.addCurrentVertex(p,e,0,0,d),this.addCurrentVertex(p,e.mult(-1),0,0,d)}else if("bevel"===C||"fakeround"===C){const t=-Math.sqrt(_*_-1),e=T?t:0,n=T?0:t;if(g&&this.addCurrentVertex(p,A,e,n,d),"fakeround"===C){const t=Math.round(180*b/Math.PI/20);for(let e=1;e<t;e++){let n=e/t;if(.5!==n){const t=n-.5;n+=n*t*(n-1)*((1.0904+l*(l*(3.55645-1.43519*l)-3.2452))*t*t+(.848013+l*(.215638*l-1.06021)))}const r=y.sub(A).A(n).i(A).T().A(T?-1:1);this.addHalfVertex(p,r.x,r.y,!1,T,0,d)}}m&&(d.currentNormal=y,d.dir=m.sub(p).T(),this.addCurrentVertex(p,y,-e,-n,d))}else if("butt"===C)this.addCurrentVertex(p,e,0,0,d);else if("square"===C){const t=g?1:-1;this.addCurrentVertex(p,e,t,t,d)}else"round"===C&&(g&&(this.addCurrentVertex(p,A,0,0,d),this.addCurrentVertex(p,A,1,1,d,!0)),m&&(this.addCurrentVertex(p,y,-1,-1,d,!0),this.addCurrentVertex(p,y,0,0,d)));if(!a&&w&&v<u-1){const t=p.dist(m);if(t>2*f){const e=p.add(m.sub(p).A(f/t).F());e.z=p.z,this.updateDistance(p,e),this.addCurrentVertex(e,y,0,0,d),p=e}}}}ensureDataCapacity(t,e,n,r){const i="round"===t?Math.round(n/20)-1:0;super.ensureDataCapacity((6+i)*r,e)}addCurrentVertex(t,e,n,r,i,o=!1){const s=e.x+e.y*n,a=e.y-e.x*n,l=-e.x+e.y*r,h=-e.y-e.x*r;let u=0,c=0;if(i.middleVertex){Hz.x=s,Hz.y=a;const t=i.currentNormal;if(u=Yz(t,Hz,i.dir),0===n&&0===r)c=-u;else{const e=jz;e.x=t.x,e.y=t.y,e.A(-1),Uz.x=l,Uz.y=h,c=Yz(e,Uz,i.dir)}}this.addHalfVertex(t,s,a,o,!1,n,i,u),this.addHalfVertex(t,l,h,o,!0,-r,i,c),this.prevVertex&&Jz(t,this.prevVertex)||(this.prevVertex=t),this.distance>Bz/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,e,n,r,i,o))}addHalfVertex({x:t,y:e,z:n},r,i,o,s,a,l,h){const u=1*this.scaledDistance;this.fillData(this.data,t,e,n||0,r,i,o,s,u,h);const c=l.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,c),l.primitiveLength++),s?this.e2=c:this.e1=c}fillData(t,e,n,r,i,o,s,a,l,h){const{lineWidthFn:u,lineStrokeWidthFn:c,lineStrokeColorFn:f,lineColorFn:d,lineOpacityFn:p,lineDxFn:g,lineDyFn:m,linePatternAnimSpeedFn:A,linePatternGapFn:y}=this.Z;this.fillPosition(t,e,n,r);let v=63*i;v=(Math.sign(v)||1)*((Math.floor(Math.abs(v))>>1<<1)+ +s);let x=63*o;x=(Math.sign(x)||1)*((Math.floor(Math.abs(x))>>1<<1)+ +a);let _=t.aExtrude.currentIndex;t.aExtrude[_++]=v,t.aExtrude[_++]=x,(this.iconAtlas||this.hasDasharray)&&(t.aExtrude[_++]=63*h),t.aExtrude.currentIndex=_,_=t.aLinesofar.currentIndex,t.aLinesofar[_++]=l,t.aLinesofar.currentIndex=_,u&&(_=t.aLineWidth.currentIndex,t.aLineWidth[_++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=_),c&&(_=t.aLineStrokeWidth.currentIndex,t.aLineStrokeWidth[_++]=Math.round(2*this.feaLineStrokeWidth),t.aLineStrokeWidth.currentIndex=_),d&&(_=t.aColor.currentIndex,t.aColor[_++]=this.feaColor[0],t.aColor[_++]=this.feaColor[1],t.aColor[_++]=this.feaColor[2],t.aColor[_++]=this.feaColor[3],t.aColor.currentIndex=_),f&&(_=t.aStrokeColor.currentIndex,t.aStrokeColor[_++]=this.feaStrokeColor[0],t.aStrokeColor[_++]=this.feaStrokeColor[1],t.aStrokeColor[_++]=this.feaStrokeColor[2],t.aStrokeColor[_++]=this.feaStrokeColor[3],t.aStrokeColor.currentIndex=_),p&&(_=t.aOpacity.currentIndex,t.aOpacity[_++]=this.feaOpacity,t.aOpacity.currentIndex=_),this.dasharrayFn&&(_=t.aDasharray.currentIndex,t.aDasharray[_++]=this.feaDash[0],t.aDasharray[_++]=this.feaDash[1],t.aDasharray[_++]=this.feaDash[2],t.aDasharray[_++]=this.feaDash[3],t.aDasharray.currentIndex=_),this.dashColorFn&&(_=t.aDashColor.currentIndex,t.aDashColor[_++]=this.feaDashColor[0],t.aDashColor[_++]=this.feaDashColor[1],t.aDashColor[_++]=this.feaDashColor[2],t.aDashColor[_++]=this.feaDashColor[3],t.aDashColor.currentIndex=_),this.iconAtlas&&(_=t.aTexInfo.currentIndex,t.aTexInfo[_++]=this.feaTexInfo[0],t.aTexInfo[_++]=this.feaTexInfo[1],t.aTexInfo[_++]=this.feaTexInfo[2],t.aTexInfo[_++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=_),(g||m)&&(_=t.aLineDxDy.currentIndex,t.aLineDxDy[_++]=this.feaLineDx||0,t.aLineDxDy[_++]=this.feaLineDy||0,t.aLineDxDy.currentIndex=_),(A||y)&&(_=t.aLinePattern.currentIndex,t.aLinePattern[_++]=127*(this.feaPatternAnimSpeed||0),t.aLinePattern[_++]=10*(this.feaLinePatternGap||0),t.aLinePattern.currentIndex=_),this.maxPos=Math.max(this.maxPos,Math.abs(e)+1,Math.abs(n)+1)}addElements(t,e,n){super.addElements(this.offset+t,this.offset+e,this.offset+n)}Ft(t){const e=this.options.EXTENT,n=this.elements;for(let r=0;r<n.length;r+=3)if(e===1/0||!Wz(this.data.aPosition,n[r],n[r+1],3,e)&&!Wz(this.data.aPosition,n[r+1],n[r+2],3,e)){let e=t.currentIndex;t[e++]=n[r],t[e++]=n[r+1],t[e++]=n[r+2],t.currentIndex=e}}Ct(t){if(t.length<=1)return t;const e=[],n=this.options.EXTENT;let r,i=!0;for(r=0;r<t.length-1;r++){const o=Gz(t[r],t[r+1],n);o&&i||(e.push(t[r]),i=o)}return i||e.push(t[r]),e}updateDistance(t,e){if(this.options.isTube){const n=t.dist(e),r=function(t){const{verticalCentimeterToPoint:e,tileRatio:n}=t;return e*n}(this.options)*(e.z-t.z);this.distance+=Math.sqrt(n*n+r*r)}else this.distance+=t.dist(e);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(Bz-1):this.distance}};function Gz(t,e,n){return n!==1/0&&(t.x<0&&e.x<0||t.x>n&&e.x>n||t.y<0&&e.y<0||t.y>n&&e.y>n)}function Wz(t,e,n,r,i){if(i===1/0)return!1;const o=Math.floor(.5*t[e*r]),s=Math.floor(.5*t[e*r+1]),a=Math.floor(.5*t[n*r]),l=Math.floor(.5*t[n*r+1]);return o===a&&(o<0||o>i)&&s!==l||s===l&&(s<0||s>i)&&o!==a}function qz(t){if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(t[e])return!0;return!1}const Xz=[],Zz=[];function Yz(t,e,n){const r=t.mag(),i=e.mag();Ly(Xz,n.x,n.y),Ly(Zz,e.x,e.y);const o=Gy(Xz,Zz);return-Math.sign(o)*Math.sqrt(i*i-r*r)}function Jz(t,e){return t.equals(e)&&t.z===e.z}const Qz=[],Kz=[];function $z(t,e){var n,r,i,o,s,a,l;for(r=1;r<=8;r*=2){for(n=[],o=!(eB(i=t[t.length-1],e)&r),s=0;s<t.length;s++){if((l=!(eB(a=t[s],e)&r))!==o){const t=tB(i,a,r,e);void 0!==a.x?n.push(new Ck(t[0],t[1])):n.push(t)}l&&n.push(a),i=a,o=l}if(!(t=n).length)break}return n}function tB(t,e,n,r){return Qz[0]=void 0===t.x?t[0]:t.x,Qz[1]=void 0===t.y?t[1]:t.y,t=Qz,Kz[0]=void 0===e.x?e[0]:e.x,Kz[1]=void 0===e.y?e[1]:e.y,e=Kz,8&n?[t[0]+(e[0]-t[0])*(r[3]-t[1])/(e[1]-t[1]),r[3]]:4&n?[t[0]+(e[0]-t[0])*(r[1]-t[1])/(e[1]-t[1]),r[1]]:2&n?[r[2],t[1]+(e[1]-t[1])*(r[2]-t[0])/(e[0]-t[0])]:1&n?[r[0],t[1]+(e[1]-t[1])*(r[0]-t[0])/(e[0]-t[0])]:null}function eB(t,e){Qz[0]=void 0===t.x?t[0]:t.x,Qz[1]=void 0===t.y?t[1]:t.y;var n=0;return(t=Qz)[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}const nB=[0,0,0,0],rB=-9999999;class iB extends HF{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,e,n,r,i){const o=new mL(t,e,n,r),s=o.getPolygonResource();return!this.options.atlas&&s&&(i[s]=[0,0]),o}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:e,polygonOpacityFn:n,uvScaleFn:r,uvOffsetFn:i,polygonPatternUVFn:o}=this.Z;if(this.iconAtlas){const e=this.getIconAtlasMaxValue();t.push({type:e>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return e&&t.push({type:Uint8Array,width:4,name:"aColor"}),n&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),i&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),o&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,e){const n=t.feature,r=n.geometry;this.Ot(r,n,e)}Ot(t,e){let n,r,i,o;const{polygonFillFn:s,polygonOpacityFn:a,uvScaleFn:l,uvOffsetFn:h,uvOffsetInMeterFn:u,polygonPatternUVFn:c}=this.Z,f=e.properties;s&&(n=s(this.options.zoom,f)||cA([],255,255,255,255),nO(n)?(this.dynamicAttrs.aColor=1,n=nB):n=pL([],n)),a&&(r=a(this.options.zoom,f),nO(r)?(this.dynamicAttrs.aOpacity=1,r=255):(sL(r)&&(r=1),r*=255)),l&&(i=l(this.options.zoom,f),nO(i)?(i=[255,255],this.dynamicAttrs.aUVScale=1):(sL(i)&&(i=[1,1]),i=[255*i[0],255*i[1]])),h&&(u&&u(null,f)?o=[0,0]:(o=h(this.options.zoom,f),nO(o)?(o=[0,0],this.dynamicAttrs.aUVOffset=1):(sL(o)&&(o=[0,0]),o=[255*o[0],255*o[1]])));const d=!!this.iconAtlas,p=Mz(t,500),g=[0,0],m=[0,0];if(d){const{polygonPatternFileFn:t}=this.Z,e=t?t(null,f):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[e]){const t=this.iconAtlas.positions[e],n=!Yk(t.displaySize[0])||!Yk(t.displaySize[1]);g[0]=t.tl[0]+(n?1:0),g[1]=t.tl[1]+(n?1:0),m[0]=t.displaySize[0]-1-(n?2:0),m[1]=t.displaySize[1]-1-(n?2:0)}}let A,y=0;c&&(A=c(this.options.zoom,f));const v=this.needAltitudeAttribute()?2:3,x=[-1,-1,e.extent+1,e.extent+1],_=this.Et=this.Et||this.ot.getProxy(),b=this.Dt=this.Dt||this.ot.getProxy();for(let w=0;w<p.length;w++){const t=p[w],e=this.data.aPosition.getLength()/v;_.setLength(0),b.setLength(0);for(let a=0;a<t.length;a++){let e=t[a];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&(e=$z(e,x)),0===e.length)continue;0!==a&&b.push(_.length/3),this.ensureDataCapacity(e.length);const s=this.data;for(let t=0;t<e.length;t++){const a=e[t].x,l=e[t].y,h=e[t].z||0;if(this.fillPosition(this.data,a,l,h),d){let t=s.aTexInfo.currentIndex;s.aTexInfo[t++]=g[0],s.aTexInfo[t++]=g[1],s.aTexInfo[t++]=m[0],s.aTexInfo[t++]=m[1],s.aTexInfo.currentIndex=t}if(void 0!==n){let t=s.aColor.currentIndex;s.aColor[t++]=n[0],s.aColor[t++]=n[1],s.aColor[t++]=n[2],s.aColor[t++]=n[3],s.aColor.currentIndex=t}if(void 0!==r){let t=s.aOpacity.currentIndex;s.aOpacity[t++]=r,s.aOpacity.currentIndex=t}if(void 0!==i){let t=s.aUVScale.currentIndex;s.aUVScale[t++]=i[0],s.aUVScale[t++]=i[1],s.aUVScale.currentIndex=t}if(void 0!==o){let t=s.aUVOffset.currentIndex;s.aUVOffset[t++]=o[0],s.aUVOffset[t++]=o[1],s.aUVOffset.currentIndex=t}if(c){let t=s.aTexCoord.currentIndex;if(A){const e=sL(A[2*y])?A[0]:A[2*y],n=sL(A[2*y]+1)?A[1]:A[2*y+1];s.aTexCoord[t++]=e,s.aTexCoord[t++]=n}else s.aTexCoord[t++]=rB,s.aTexCoord[t++]=rB;s.aTexCoord.currentIndex=t,y++}const u=Math.abs(a),f=Math.abs(l);u>this.maxPos&&(this.maxPos=u),f>this.maxPos&&(this.maxPos=f),_.push(a,l,h)}}let s=HR(_,b,3);if(_.length&&!s.length){const t=[];for(let e=0;e<_.length;e+=3)t[e]=_[e],t[e+1]=_[e+2],t[e+2]=_[e+1];if(s=HR(t,b,3),!s.length){for(let e=0;e<_.length;e+=3)t[e]=_[e+1],t[e+1]=_[e+2],t[e+2]=_[e];s=HR(t,b,3)}}for(let n=0;n<s.length;n+=3)this.addElements(e+s[n],e+s[n+1],e+s[n+2])}}ensureDataCapacity(t){super.ensureDataCapacity(1,t)}}class oB{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,e){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t)):(this.data[t]=e,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}var sB=1e20;function aB(t,e,n,r,i,o,s){this.fontSize=t||24,this.buffer=void 0===e?3:e,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.fontStyle=s||"normal",this.radius=n||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function lB(t,e,n,r,i,o){for(var s=0;s<e;s++)hB(t,s,e,n,r,i,o);for(var a=0;a<n;a++)hB(t,a*e,1,e,r,i,o)}function hB(t,e,n,r,i,o,s){var a,l,h,u;for(o[0]=0,s[0]=-sB,s[1]=sB,a=0;a<r;a++)i[a]=t[e+a*n];for(a=1,l=0,h=0;a<r;a++){do{u=o[l],h=(i[a]-i[u]+a*a-u*u)/(a-u)/2}while(h<=s[l]&&--l>-1);o[++l]=a,s[l]=h,s[l+1]=sB}for(a=0,l=0;a<r;a++){for(;s[l+1]<a;)l++;u=o[l],t[e+a*n]=i[u]+(a-u)*(a-u)}}aB.prototype.draw=function(t,e,n){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var r=this.ctx.getImageData(0,0,e,n),i=new Uint8ClampedArray(e*n),o=0;o<e*n;o++){var s=r.data[4*o+3]/255;this.gridOuter[o]=1===s?0:0===s?sB:Math.pow(Math.max(0,.5-s),2),this.gridInner[o]=1===s?sB:0===s?0:Math.pow(Math.max(0,s-.5),2)}for(lB(this.gridOuter,e,n,this.f,this.v,this.z),lB(this.gridInner,e,n,this.f,this.v,this.z),o=0;o<e*n;o++){var a=Math.sqrt(this.gridOuter[o])-Math.sqrt(this.gridInner[o]);i[o]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let uB=0;class cB{constructor(t,e=15,n,r){this.entries={},this.Lt={},this.Rt=new oB(2048,(function(){})),this.Ht=t,this.zt=e,this.Nt=n,this.Vt=r}Ut(t){return t&&t.indexOf("{stack}")>=0&&t.indexOf("{range}")>0}getGlyphs(t,e){if(!t||!Object.keys(t).length)return void e(null,{glyphs:null});if(this.Ut(this.Vt))return void this.jt(t,e);const n=this.entries,r=t.options;let i=!0;r&&(i=!1!==r.isCharsCompact),i=i||this.Nt;const o=(r,o,a)=>{let l=0,h=0;for(const e in t)if("options"!==e){n[e]=n[e]||{},o[e]=o[e]||{};for(const u in t[e]){if(h++,h<=r)continue;const t=i&&!$F(+u),c=e+":"+u+":"+t;let f;if(this.Rt.has(c)?f=this.Rt.get(c):(f=this.Gt(n[e],e,u,t),this.Rt.add(c,f),l++),f=fB(f),o[e][u]=f,a.push(f.bitmap.data.buffer),this.Ht&&l>this.zt)return void this.Ht(s(h,o,a))}}e(null,{glyphs:o,buffers:a})};function s(t,e,n){return()=>{o(t,e,n)}}o(0,{},[])}jt(t,e){const n=[];for(const r in t)for(const e of t[r])n.push(this.Bt(r,e));Promise.all(n).then((t=>{e(null,t)}))}Bt(){return Promise.resolve(null)}Gt(t,e,n,r){const i=e;let o=t.tinySDF;const s=r?-1:2;if(!o){let e="400";/bolder/i.test(i)?e="1000":/bold/i.test(i)?e="900":/medium/i.test(i)?e="500":/light/i.test(i)&&(e="200"),o=t.tinySDF=new aB(24,2,8,.25,i,e)}const a=String.fromCodePoint(n),l=o.ctx.measureText(a),h=Math.round(l.width),u=o.draw(a,h+4,28);if(uB<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+uB++);t&&(t.width=h+4,t.height=o.canvas.height,t.getContext("2d").drawImage(o.canvas,0,0))}return{charCode:n,bitmap:{width:h+4,height:28,data:u},metrics:{width:h,height:24,left:1,top:-2,advance:h+2+s}}}}function fB(t){const e={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:e,metrics:oL({},t.metrics)}}class dB{constructor(t){this.options=t||{},this.$t={},this.Rt=new oB(256,(function(){}));const e=document.createElement("canvas");this.ctx=e.getContext("2d",{willReadFrequently:!0})}getIcons(t,e){if(!t||!Object.keys(t).length)return void e(null,{icons:null});const n=Object.keys(t),r={},i=[];let o=0,a=0;const l=this;function h(t,n){r[t]=l.Wt(t,n),r[t]&&"error"!==r[t]?i.push(r[t].data.data.buffer):delete r[t],a++,a===o&&e(null,{icons:r,buffers:i})}function u(t){const e=l.$t[t.url];for(let n=0;n<e.length;n++)e[n].call(t,t.url,t.size);delete l.$t[t.url]}function c(){const t=l.ctx;let e,n;try{e=this.width,n=this.height,this.size[0]=e,this.size[1]=n,l.Xt(null,this.size),e=this.size[0],n=this.size[1];const r=t.canvas;r.width=e,r.height=n,t.imageSmoothingEnabled=!1,t.drawImage(this,0,0,e,n);const i=t.getImageData(0,0,r.width,r.height).data;l.Yt(this.url,i,r.width,r.height)}catch(r){console.warn(r)}u(this)}function f(t){console.warn(`failed loading icon(${this.index}) at "${this.url}"`),console.warn(t),l.options.iconErrorUrl?this.src=l.options.iconErrorUrl:(l.Yt(this.url),u(this))}const d=this.options.urlModifier;let p,m=!1;for(let A=0;A<n.length;A++){const e=n[A],a=t[e];this.Xt(e,a);const l=this.Wt(e,a);if(l&&"error"!==l){r[e]=this.Wt(e,a);continue}if("error"===l)continue;let u,y=e;if(0===e.indexOf("vector://")&&(u=JSON.parse(e.substring(9)),"path"===u.markerType&&(y=s.getMarkerPathBase64(u,u.markerWidth,u.markerHeight))),0===e.indexOf("vector://")&&"path"!==u.markerType){p=p||new g([0,0]);const{markerFill:t,markerLineColor:n}=u;t&&Array.isArray(t)&&(u.markerFill=pB(t)),n&&Array.isArray(n)&&(u.markerLineColor=pB(n)),delete u.markerHorizontalAlignment,delete u.markerVerticalAlignment,delete u.markerDx,delete u.markerDy,delete u.markerPlacement,delete u.markerFile,u.markerWidth=a[0],u.markerHeight=a[1],p.setSymbol(u);const o=p["_getSprite".trim()]();if(o){const t=o.canvas,n=t.width,s=t.height,a=t.getContext("2d").getImageData(0,0,n,s).data;r[e]={data:{data:new Uint8ClampedArray(a),width:n,height:s},url:e},i.push(r[e].data.data.buffer),this.Yt(e,a,n,s)}}else{if(this.$t[e]){m=!0,o++,this.$t[e].push(h);continue}this.$t[e]=[],this.$t[e].push(h);const t=new Image;t.index=A,t.size=a,t.onload=c,t.onerror=f,t.onabort=f,t.url=e,t.crossOrigin="Anonymous",m=!0,o++,t.src=d&&d(y)||y}}m||e(null,{icons:r,buffers:i})}qt(t,e,n){const r=this.Rt.get(t);return r&&"error"!==r&&r.data.width>=e&&r.data.height>=n}Yt(t,e,n,r){this.qt(t,n,r)||(e?this.Rt.add(t,{data:{data:e,width:n,height:r},url:t}):this.Rt.add(t,"error"))}Wt(t,e){if(!this.qt(t,e[0],e[1]))return null;const n=this.Rt.get(t);return n?"error"===n?n:{data:{data:new Uint8ClampedArray(n.data.data),width:n.data.width,height:n.data.height},url:n.url}:null}Xt(t,e){if(!e[0]||!e[1])return;const n=this.options.maxSize||2048;let[r,i]=e;const o=r/i;if(t){const e=this.Rt.get(t);if(e&&"error"!==e){const{width:t,height:n}=e.data;t>r&&(r=t),n>i&&(i=n)}}r>n&&(i=n/o,r=n),i>n&&(r=n*o,i=n),e[0]=Math.floor(r),e[1]=Math.floor(i)}}function pB(t){return 3===t.length&&t.push(1),t.reduce(((t,e,n)=>t+(n<3?255*e+",":e+")")),"rgba(")}const gB={},mB={},AB=[];function yB(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var r,i=[];for(let o=0;o<t.length;o++)(r=yB(t[o],e))?(i.push(r),n=!0):i.push(t[o]);return n?i:t}var o={__fn_types_loaded:!0};const s=[];for(const u in t)cL(t,u)&&s.push(u);const a=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=iO(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},l={},h=function(t,n){Object.defineProperty(o,t,{get:function(){this["__fn_"+t]||(this["__fn_"+t]=AF(this["_"+t],n));const r=e()[0];l.zoom=r;try{return this["__fn_"+t].evaluateWithoutErrorHandling(l,gB,mB,null,AB)}catch(i){return null}},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let u=0,c=s.length;u<c;u++){const e=s[u];if(nO(t[e]))n=!0,o["_"+e]=t[e],a(e);else if(yF(t[e])){n=!0;const r=wF(e);o["_"+e]=t[e],h(e,r)}else o[e]=t[e]}return n?o:t}const vB={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1},xB={visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},_B={lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1};Object.assign(xB,vB),Object.assign(_B,vB);let bB=0;function wB(){return bB++}const TB="function"==typeof Object.assign;function MB(t,...e){if(TB)return Object.assign(t,...e),t;for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)t[e]=r[e]}return t}function CB(t){return!EB(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function SB(t){return"number"==typeof t&&!isNaN(t)}function IB(t){return!EB(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function PB(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function EB(t){return null==t}function OB(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}function RB(t){return nO(t)&&t.property}function kB(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function LB(t,e){let n;if(e.altitudeToPoint){n=e.altitudeToPoint(100,t);const r=e.options.heightFactor;r&&1!==r&&(n/=r)}else n=e.distanceToPointAtRes(100,0,t).x;return n/100/100}function DB(t,e,n){for(let r=0;r<t.length;r++){const i=t[r],o=MB({},i),{renderPlugin:s}=i,a=MB({},s);a.sceneConfig&&!Object.keys(a.sceneConfig).length&&delete a.sceneConfig;let l=-1;for(let t=n.length-1;t>=0;t--)if(CT(a,n[t])){l=t;break}l<0&&(l=n.length,n.push(a)),o.renderPlugin=l,e.push(o)}}const NB="function"==typeof fetch&&"function"==typeof AbortController,FB={jsonp:function(t,e){const n="_maptalks_jsonp_"+wB();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,n){if(IB(e)){const t=n;n=e,e=t}(e=e||{}).method&&(e.method=e.method.toUpperCase());const r="POST"===e.method;if(NB){const r=new AbortController,i=e;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const o=new Request(t,i);return e.returnJSON&&o.headers.set("Accept","application/json"),fetch(o).then((r=>{const i=this.Jt(r,e.returnJSON,e.responseType);i.message?(i.url=t,n(i)):i.then((t=>{"arraybuffer"===e.responseType?n(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):n(null,t)})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))}))})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))})),r}{const i=FB.Kt(n);if(i.open(e.method||"GET",t,!0),e){for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(r?e.body:null),i}},Jt:(t,e,n)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===n?t.arrayBuffer():e?t.json():t.text(),Zt:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e({status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}))}},Kt:function(t){let e;try{e=new XMLHttpRequest}catch(n){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(r){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){}}}return e.onreadystatechange=FB.Zt(e,t),e},getArrayBuffer(t,e,n){if(IB(e)){const t=n;n=e,e=t}return e||(e={}),e.responseType="arraybuffer",FB.get(t,e,n)},getJSON:function(t,e,n){if(IB(e)){const t=n;n=e,e=t}const r=function(t,e){const r="string"==typeof e?JSON.parse(e):e||null;n(t,r)};return e&&e.jsonp?FB.jsonp(t,r):((e=e||{}).returnJSON=!0,FB.get(t,e,r))}},zB=["GeoJSONVectorTileLayer"];class BB extends h.Actor{constructor(t,e){super(t);const n=e.getMap().id;this.Qt=e,this.te=n,this.ee="vt_"+wB();const r=e.getJSONType();this.ne=zB.indexOf(r)>=0,this.ie={},this.re=new dB({iconErrorUrl:e.options.iconErrorUrl,maxSize:e.options.maxIconSize,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}});const i=!e.getRenderer().isEnableWorkAround("win-intel-gpu-crash");this.se=new cB((t=>{e.getMap().getRenderer().callInNextFrame(t)}),e.options.glyphSdfLimitPerFrame,i)}initialize(t){t(null)}addLayer(t){const e=this.Qt,n=e.getWorkerOptions()||{},r=this.ee,i=e.getJSONType(),o={mapId:this.te,layerId:r,command:"addLayer",params:{type:i,options:n}};this.ne?(void 0===this.ie[r]&&(this.ie[r]=this.getDedicatedWorker()),this.send(o,null,t,this.ie[r])):this.broadcast(o,null,t)}abortTile(t,e){const n=this.ee,r={mapId:this.te,layerId:n,command:"abortTile",params:{url:t}};this.ne?(void 0===this.ie[n]&&(this.ie[n]=this.getDedicatedWorker()),this.send(r,null,e,this.ie[n])):this.broadcast(r,null,e)}removeLayer(t){const e=this.ee,n={mapId:this.te,layerId:e,command:"removeLayer"};this.ne?(void 0!==this.ie[e]&&this.send(n,null,t,this.ie[e]),delete this.ie[e]):this.broadcast(n,null,t)}updateStyle(t,e){const n=this.ee,r={mapId:this.te,layerId:n,command:"updateStyle",params:t};this.ne?void 0!==this.ie[n]&&this.send(r,null,e,this.ie[n]):this.broadcast(r,null,e)}updateOptions(t,e){const n=this.ee,r={mapId:this.te,layerId:n,command:"updateOptions",params:t};this.ne?void 0!==this.ie[n]&&this.send(r,null,e,this.ie[n]):this.broadcast(r,null,e)}loadTile(t,e){const n=MB({},t);n.tileInfo=function(t){const e={};for(const n in t)void 0!==t[n]&&null!==t[n]&&(t[n].toJSON?e[n]=t[n].toJSON():e[n]=t[n]);return e}(t.tileInfo);const r=this.ee,i={mapId:this.te,layerId:r,command:"loadTile",params:n},{x:o,y:s}=t.tileInfo,a=(o+s)%this.workers.length;this.send(i,null,e,void 0===this.ie[r]?this.workers[a].id:this.ie[r])}remove(){super.remove(),this.ie={}}fetchIconGlyphs({icons:t,glyphs:e},n){this.se.getGlyphs(e,((e,r)=>{if(e)throw e;const i=r.buffers||[];this.re.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&i.push(...e.buffers),n(null,{icons:e.icons,glyphs:r.glyphs},i)}))}))}setData(t,e){const n=this.ee,r={mapId:this.te,layerId:n,command:"setData",params:{data:t}};this.send(r,null,e,this.ie[n])}oe(t){return t.id}}const HB={},jB={collision:!0,fading:!1,fadingDuration:224,fadeInDelay:600,fadeOutDelay:100,uniquePlacement:!1,depthFunc:"always"};class UB{constructor(t,e,n){this.ae=t,this.le=e,this.he=n||[0,1,0]}draw(t,e,n,r,i){if(this.ue||this.ce(),!this.fe){this.fe=this.ae.buffer(VB(r));const t=r/n;this.de=this.ae.buffer(GB(r,t))}if(r!==this.pe){const t=r/n;this.fe(VB(r)),this.de(GB(r,t))}this.pe=r;let o=this.me;if(!o){const t=this.le.getDevicePixelRatio()>1?2:1;o=this.me=document.createElement("canvas"),o.width=512*t,o.height=64*t;const e=o.getContext("2d");e.font="36px monospace",e.scale(t,t),this.ye=this.ae.texture({width:o.width,height:o.height,data:o})}const s=o.getContext("2d");s.clearRect(0,0,o.width,o.height),s.fillStyle=`rgba(${this.he.map((t=>255*t)).join()})`,s.fillText(t,20,36),this.ye({width:o.width,height:o.height,data:o}),this.ue({transform:e,data:this.fe,texData:this.ge,debugLine:1,primitive:"lines",framebuffer:i||null,image:this.ye,count:8}),this.ue({transform:e,data:this.de,texData:this.ge,debugLine:0,primitive:"triangle strip",framebuffer:i||null,image:this.ye,count:4})}delete(){this.ye&&(this.ye.destroy(),delete this.ye),this.ge&&(this.ge.destroy(),delete this.ge),this.fe&&(this.fe.destroy(),this.de.destroy(),delete this.fe,delete this.de),this.ue&&(this.ue.destroy(),delete this.ue)}ce(){this.ge=this.ae.buffer(new Uint8Array([0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1])),this.ue=this.ae({vert:"\n                attribute vec2 aPosition;\n                attribute vec2 aTexCoord;\n                uniform mat4 transform;\n\n                varying vec2 vTexCoord;\n                void main()\n                {\n                    gl_Position = transform * vec4(aPosition, 0.0, 1.0);\n                    vTexCoord = aTexCoord;\n                }\n            ",frag:"\n                precision mediump float;\n                uniform sampler2D uImage;\n                uniform vec3 uColor;\n                uniform float uOpacity;\n                uniform float uDebugLine;\n\n                varying vec2 vTexCoord;\n\n                void main()\n                {\n                    if (uDebugLine == 1.) {\n                        gl_FragColor = vec4(uColor, 1.0) * uOpacity;\n                    } else {\n                        gl_FragColor = texture2D(uImage, vTexCoord) * uOpacity;\n                    }\n                    gl_FragColor *= gl_FragColor.a;\n                }\n            ",attributes:{aPosition:this.ae.prop("data"),aTexCoord:this.ae.prop("texData")},uniforms:{transform:this.ae.prop("transform"),uColor:this.he,uOpacity:1,uDebugLine:this.ae.prop("debugLine"),uImage:this.ae.prop("image")},count:this.ae.prop("count"),primitive:this.ae.prop("primitive"),depth:{enable:!1,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},stencil:{enable:!1},viewport:{x:0,y:0,width:()=>this.le.getRenderer().canvas.width,height:()=>this.le.getRenderer().canvas.height},framebuffer:this.ae.prop("framebuffer")})}}function VB(t){return new Uint16Array([0,0,0,t,0,t,t,t,t,t,t,0,t,0,0,0])}function GB(t,e){return new Uint16Array([0,t-64*e,0,t,512*e,t-64*e,512*e,t])}const WB=new Uint8Array([0,0,0,1,1,0,1,0,0,1,1,1]),qB=[];class XB{constructor(t,e,n){this.ae=t,(this.ve=new bx({aPosition:WB},null,WB.length/2,{positionSize:2})).generateBuffers(t),this.xe=new __,this.be=[],this.we=0,this.Ae=e,this.le=n,this.ce(t)}start(){this.we=0,this.xe.clear()}add(t,e,n){const r=this.Me(n);r.setUniform("ref",t),Lm(qB,e,e,1);const i=r.localTransform;fm(i,qB),Sm(i,n,i),r.setLocalTransform(i),this.xe.addMesh(r)}render(t){this._e.render(this.Se,{projViewMatrix:this.le.projViewMatrix},this.xe,t)}Me(){const t=this.we++;return this.be[t]||(this.be[t]=new h_(this.ve)),this.be[t]}ce(t){const e=this.Ae,n={viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},stencil:{enable:!0,mask:255,func:{cmp:"always",ref:(t,e)=>e.ref,mask:255},op:{fail:"replace",zfail:"replace",zpass:"replace"}},depth:{enable:!0,func:"always",mask:!1},colorMask:[!1,!1,!1,!1]};this.Se=new U_({vert:"\n#define SHADER_NAME TILE_STENCIL_VERT\nattribute vec2 aPosition;\nuniform mat4 projViewModelMatrix;\n\nvoid main()\n{\n    gl_Position = projViewModelMatrix * vec4(aPosition, 0.0, 1.0);\n}\n",frag:"\n#define SHADER_NAME TILE_STENCIL_FRAG\nvoid main()\n{\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.1);\n}\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:n}),this._e=new f_(t)}remove(){this.ve.dispose();for(let t=0;t<this.be.length;t++)this.be[t].dispose();this.be.length=0,this.Se.dispose()}}const ZB="__fea_idx",YB=-999999,JB=new Float32Array([-1e12])[0],QB="maptalks_ombb",KB=(ZB+"").trim();function $B(t,e,n,r,i,o){const s={};if(function(t){if(!t)return!1;for(const e in t)if(void 0!==t[e]&&null!==t[e])return!0;return!1}(t))for(let a=0,l=(e||t).length;a<l;a++){let l=e?t[e[a]]:t[a];"id"===i.options.features&&i.getFeature&&(l=i.getFeature(l),l.layer=n),i instanceof d&&(l=iH(l,o)),s[e?e[a]:l[KB]]={feature:l,symbol:r}}return s}const tH="__original_properties",eH="__external_properties",nH={get:function(t,e){return e in t?t[e]:t[tH][e]||t[eH]&&t[eH][e]},has:function(t,e){return e in t||e in t[tH]||t[eH]&&e in t[eH]}},rH={};function iH(t,e){const n=t.properties;if(n&&n[tH])return t;e&&(t=MB({},t)),t.customProps=t.customProps||{};const r=t.customProps;return r.$layer=t.layer,r.$type=t.type,r[tH]=n||rH,t.properties=new Proxy(r,nH),t}function oH(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function sH(t,e,n){return Math.min(n,Math.max(e,t))}function aH(t,e,n){if(t===n||t===e)return t;const r=n-e;return((t-e)%r+r)%r+e}function lH(t){return null==t}function hH(t){return JSON.parse(JSON.stringify(t))}function uH(t,e,n,r,i,o){e in t||Object.defineProperty(t,e,{enumerable:!0,get:function(){const t=lH(n[r])||nO(n[r])?i:n[r];return o?o(t):t}})}const cH=[];function fH(t){for(let e=0;e<t.length;e++)cH[e]=t[e],cH[e]*=255;return 3===t.length&&(cH[3]=255),cH}function dH(t,e=4){return pH.bind(this,t,e)}function pH(t,e,n){if(Array.isArray(n))return 3===n.length&&4===e&&n.push(1),n;if(t&&t[n])return t[n];if(void 0!==n.r&&void 0!==n.g&&void 0!==n.b&&void 0!==n.a)return[n.r,n.g,n.b,n.a];const r=JO(n).unitArray();return 3===r.length&&4===e&&r.push(1),t&&(t[n]=r),r}function gH(t,e,n,r){if(t.fill)t.fill(e,n,r);else for(let i=n;i<r;i++)t[i]=e}function mH(t){return"number"==typeof t&&!isNaN(t)}function AH(t){return t&&(t.markerFile||t.markerType)&&void 0!==t.textName}function yH(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function vH(t,e){if(e){let e=t[t.length-1];const n=[e];for(let r=t.length-2;r>=0;r--)t[r]!==e&&(n.push(t[r]),e=t[r]);return n}{let e=t[t[0]];const n=[e];for(let r=1;r<t.length;r++)t[r]!==e&&(n.push(t[r]),e=t[r]);return n}}const xH=new n(0,0);function _H(t,e,n,r,i){const o=t.distanceToPointAtRes(e,e,r,n,xH);return i?o.y:o.x}const bH=[],wH=[0,0,0,0],TH=new i(0,0),MH={color:wH,depth:1,stencil:0},CH=t=>t.isTerrainSkin(),SH=t=>t.isTerrainVector();class IH extends r.TileLayerCanvasRenderer{supportRenderMode(){return!0}constructor(t){super(t),this.ke=0,this.ready=!1,this.Pe=1,this.Te={},this.Ie={},this.Fe={}}getTileLevelValue(t,e){if(this.isBackTile(t.id)){const n=t.z,r=5;return n-e>=0?e+r-n:r+(e-n)}return 0}getWorkerConnection(){return this.Ce}getStyleCounter(){return this.Pe}setStyle(){if(this.Oe&&this.Oe.update(),this.Ce){this.Pe++,this.Ee();const t=this.layer.De();t.styleCounter=this.Pe,this.Le=!0,this.Ce.updateStyle(t,(t=>{if(this.Le=!1,t)throw new Error(t);this.Re=!0,this.He(),this.setToRedraw(),this.layer.fire("refreshstyle")}))}else this.He()}Ee(){if(this.ze)for(const e in this.ze){const t=this.ze[e];t&&this.deleteTile(t)}this.ze=this.tilesInView;const t=this.tileCache;for(const e in this.ze){const n=this.ze[e];n&&n.info&&t.getAndRemove(n.info.id)}t.reset(),this.tilesInView={},this.tilesLoading={},this.Te={},this._parentTiles=[],this._childTiles=[],this._tileZoom=void 0}updateOptions(t){this.Ce&&this.Ce.updateOptions(this.layer.getWorkerOptions(),(e=>{if(e)throw new Error(e);t&&(t.features||t.pickingGeometry||t.altitudeProperty)&&(this.clear(),this.Ne(),this.He()),this.setToRedraw()}))}updateSceneConfig(t,e,n){const r=0===t?this.Ve():this.Ue();if(!r||!r[e])return;this.Re=!0;const i=this.layer.De(),o=this.layer.je(t,i);r[e].config=o[e].renderPlugin,r[e].updateSceneConfig({sceneConfig:n}),this.setToRedraw()}updateDataConfig(t,e,n,r){const i=0===t?this.Ve():this.Ue();i&&i[e]&&(this.Re=!0,i[e].updateDataConfig(n,r)?this.setStyle():this.setToRedraw())}updateSymbol(t,e,n){const r=0===t?this.Ve():this.Ue();if(!r||!r[e])return!1;const i=this.layer.De(),o=this.layer.je(t,i),s=r[e];s.style=o[e];const a=s.updateSymbol(n,o[e].symbol);return!a&&RH(n)&&this.setStyle(),this.setToRedraw(),a}needToRedraw(){const t=super.needToRedraw();if(!t){const t=this.Ge();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRedraw())return!0}return t}needRetireFrames(){if(this.Re)return!0;const t=this.Ge();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRetireFrames())return!0;return!1}isAnimating(){const t=this.getMap().getRenderer(),e=t.getFrameTimestamp&&t.getFrameTimestamp()||t._frameTimestamp;if(this.Be&&(this.$e=e,delete this.Be),this.$e===e)return!0;const n=this.Ge();for(let r=0;r<n.length;r++)if(n[r]&&n[r].isAnimating())return!0;return!1}needToRefreshTerrainTileOnZooming(){const t=this.Ge();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRefreshTerrainTileOnZooming())return!0;return!1}We(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const{gl:t,regl:e,attributes:n}=this.Xe(this.canvas);this.gl=t,this.regl=e,this.glOptions=n}if(t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.Ye=new UB(this.regl,this.getMap()),this.qe(),this.Oe=new AS(this.regl,this.layer),!this.consumeTile){const t=this.getMap().VERSION;throw new Error(`Incompatible version of maptalks: ${t}, upgrade maptalks >= v1.0.0-rc.14`)}}Xe(t){const e=this.layer,n=e.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};n.preserveDrawingBuffer=!0,n.stencil=!0;const r=this.Je(t,n);return{gl:r,attributes:n,regl:mp({gl:r,attributes:n,extensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],optionalExtensions:e.options.glExtensions||["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_draw_buffers","EXT_shader_texture_lod","EXT_frag_depth"]})}}qe(){this.Ce||(this.Ce=new BB("@maptalks/vt",this.layer)),this.Ce.addLayer(((t,e)=>{this.layer&&(this.ready=!0,this.layer.onWorkerReady(t,e),this.layer.fire("workerready"),this.setToRedraw())}))}Ke(){this.ke++}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:wH,depth:1,stencil:0})}isDrawable(){return!0}checkResources(){return bH}_drawTiles(t,e,n,r,i){if(super._drawTiles(t,e,n,r,i),this.ze)if(Object.keys(this.ze).length)for(const o in this.ze){const t=this.ze[o];t&&t.info&&t.info.id&&!this.tileCache.has(t.info.id)&&this._drawTile(t.info,t.image,i)}else this.Ze(),delete this.ze}Ze(){const t=this.Pe,e=[],n=[];for(const r in this.Ie)+r!==t&&(e.push(r),this.Ve(r).forEach((t=>{t.remove()})));for(const r in this.Fe)+r!==t&&(n.push(r),this.Ue(r).forEach((t=>{t.remove()})));for(let r=0;r<e.length;r++)delete this.Ie[e[r]];for(let r=0;r<n.length;r++)delete this.Fe[n[r]]}draw(t,e){this.Qe!==t&&(this.Re=!1,this.tn());const n=this.layer;if(this.prepareCanvas(),!this.ready||!n.ready)return;let r=this.Ie[this.Pe];r||(this.He(),this.tn(),r=this.Ve());const i=this.Ue();n.isDefaultRender()||r.length||i.length?(n.options.collision&&n.clearCollisionIndex(),this.en=t,this.nn=this.rn(this.getMap().getGLRes()),this.sn=e||{},this.an(t),super.draw(t),this.Qe!==t&&this.hn(t),this.un(t),this.Qe=t):this.completeRender()}tn(){this.Ge().forEach(((t,e)=>{t&&(t.renderIndex=e)}))}hn(){const t=this.Ge();this.cn=this.cn||[];let e=0;for(let n=t.length-1;n>=0;n--){const r=t[n];r.isVisible()&&r.hasMesh()&&(this.cn[n]=e,r.needPolygonOffset()&&e++)}this.Oe.isEnable()&&e++,this.dn=e}getFrameTimestamp(){return this.en}drawOnInteracting(t,e,n){this.draw(e,n)}drawOutline(t){(this.pn||this.mn)&&(this.mn?this.paintOutlineAll(t):this.pn.forEach((e=>{this[e[0]](t,...e[1])})))}getAnalysisMeshes(){return this.getShadowMeshes()}getShadowMeshes(){const t=[];return this.yn().forEach((e=>{if(!e)return;if(!this.gn(e))return;const n=e.getShadowMeshes();if(Array.isArray(n))for(let r=0;r<n.length;r++)t.push(n[r])})),t}isForeground(t){return!(!this.vn||!this.vn[t.properties.tile.id])}xn(t){const e=this.layer;let n=e._getTileZoom(this.getMap().getZoom());const r=e.getMinZoom(),i=e.getMaxZoom();return n=s.clamp(n,r,i),n-t.properties.tile.z}isTileNearCamera(t){return this.xn(t)<=1}isBackTile(t){return!(!this.bn||!this.bn[t])}loadTileQueue(t){this.Le||super.loadTileQueue(t)}loadTile(t){const{url:e}=t,n=this.Te[e];if(n)n.keys[t.id]||(n.tiles.push(t),n.keys[t.id]=1);else{const n=this.getMap(),r=TH.set(t.extent2d.xmin,t.extent2d.ymax),o=n.pointAtResToCoord(new i(r),t.res),s=[_H(n,1,o,t.res)/100,_H(n,1,o,t.res,1)/100],a=this.getCentimeterToPoint(t.z),l=this.getTileGLScale(t.z);this.Te[e]={keys:{},tiles:[t]},this.Te[e].keys[t.id]=1;const h=this.layer.options.fetchOptions,u=window&&window.location.href;this.Ce.loadTile({tileInfo:{res:t.res,x:t.x,y:t.y,z:t.z,url:t.url,id:t.id,extent2d:t.extent2d},glScale:l,zScale:this.nn,centimeterToPoint:s,verticalCentimeterToPoint:a,fetchOptions:h,styleCounter:this.Pe,referrer:u,workerCacheIndex:this.ke},this.wn.bind(this,e))}return{}}getTileGLScale(t){const e=this.getMap();return this.layer.getSpatialReference().getResolution(t)/e.getGLRes()}getCentimeterToPoint(t){const e=this.getMap();return LB(this.layer.getSpatialReference().getResolution(t),e)}getRenderedFeatures(){const t=[],e=this.tileCache.keys();for(let n=0;n<e.length;n++){const r=this.tileCache.get(e[n]);if(!r||!r.info||!r.image)continue;const{info:i,image:o}=r,s=LH(o);t.push({tile:{id:i.id,x:i.x,y:i.y,z:i.z,url:i.url},current:!!this.tilesInView[i.id],features:s})}return t}wn(t,e,n){if(this.setToRedraw(),!this.Te[t])return;if(n&&n.canceled)return;const r=this.layer,i=r.isDefaultRender(),{tiles:o}=this.Te[t];if(delete this.Te[t],e){if(e.status&&(404===e.status||204===e.status))for(let t=0;t<o.length;t++){const e=o[t];this.onTileError(HB,e)}return}if(!n){for(let t=0;t<o.length;t++){const e=o[t];this.consumeTile({An:!0},e)}return}if(n.styleCounter!==this.Pe)return;let s=!1;const a=n.features,l=[];for(let c=0;c<n.data.length;c++){const t=n.data[c];if(!t||!t.data||!t.styledFeatures.length)continue;const{isUpdated:e,layer:r}=this.Mn(0,c,t,a,l);l.push(r),e&&(s=e)}for(let c=0;c<n.featureData.length;c++){const t=n.featureData[c];t&&t.data&&t.styledFeatures.length&&this.Mn(1,c,t,a)}s&&r._n();const h=o[0].z,u=this.layer.getDataSchema(h);if(this.Sn(u,n.schema),delete n.features,i&&n.data.length!==l.length){const t=n.data;n.data=[];for(let e=0;e<t.length;e++)t[e]&&t[e].features&&n.data.push(t[e])}n.layers=l;for(let c=0;c<o.length;c++){const t=o[c];if(0===c&&r.options.debugTileData){const{x:e,y:n,z:i}=t;r.getId(),OH(Object.values(a))}const e=0===c?n:PH(n);for(let n=0;n<e.data.length;n++){if(!e.data[n])continue;const r=e.data[n].features;for(const e in r)r[e].tile=t}t.extent=e.extent,this.kn||(this.kn=t.extent),e.features=Object.values(a),e.styleCounter=n.styleCounter,this.onTileLoad(e,t)}this.layer.fire("datareceived",{url:t})}Mn(t,e,n,r){const{style:i,isUpdated:o}=this.Pn(t,e,n.data),s=this.layer,a=s.isDefaultRender(),l=i.symbol,h=$B(r,n.styledFeatures,e,l,s,!(!s.getData||!s.getData()));delete n.styledFeatures,n.features=h;let u=n.data;return Array.isArray(u)&&(u=u[0]),{isUpdated:o,layer:a?{layer:u.layer,type:u.type}:null}}Sn(t,e){for(const n in e){t[n]||(t[n]={types:e[n].types,properties:{}});const r=e[n].properties,i=t[n].properties;for(const t in r)(!i[t]||i[t]&&"object"!==r[t]&&"object"===i[t])&&(i[t]=r[t])}}Pn(t,e,n){Array.isArray(n)&&(n=n[0]);const r=this.layer;let i,o=!1;if(r.isDefaultRender()&&0===t){let t=this.Tn;t||(t=this.Tn={});const e=n.layer,r=n.type;t[e]||(t[e]=[]);const s=("plugin_"+r).trim();t[e][s]?i=t[e][s]:(i=this.In(r),i.filter=n.filter,t[e].push(i),t[e][s]=i,o=!0)}else{const s=r.De(),a=r.je(t,s),l=this.Ve();if(i=a[e],!i.renderPlugin){o=!0;const{plugin:t,symbol:r,renderPlugin:s}=this.In(n.type);l[e]=t,i.symbol=r,i.renderPlugin=s}}return{style:i,isUpdated:o}}Ge(t){const e=t&&t.style;let n=this.Ve(e)||[];this.layer.isDefaultRender()&&this.Tn&&(n=[],t?t.layers&&t.layers.forEach((t=>{if(!t)return;const e=("plugin_"+t.type).trim();n.push(this.Tn[t.layer][e].plugin)})):Object.keys(this.Tn).forEach((t=>{for(let e=0;e<this.Tn[t].length;e++)n.push(this.Tn[t][e].plugin)})));const r=this.Ue(e);return r&&r.length&&(n=n.slice(),OB(n,r)),n}yn(){if(this.layer.isDefaultRender()&&this.Tn){const t=[];return Object.keys(this.Tn).forEach((e=>{for(let n=0;n<this.Tn[e].length;n++)t.push(this.Tn[e][n].plugin)})),t}const t=[];for(const e in this.Ie)t.push(...this.Ie[e]);for(const e in this.Fe)t.push(...this.Fe[e]);return t}Ve(t){return EB(t)&&(t=this.Pe),this.Ie[t]||bH}Ue(t){return EB(t)&&(t=this.Pe),this.Fe[t]||bH}an(t,e){const n=!!this.Fn,r=this.layer.isDefaultRender()&&this.Tn,i=this.sn;this.yn().forEach(((o,s)=>{if(!o||e&&!e(o))return;if(!this.gn(s))return;const a=this.regl,l=this.gl,h=r?o.defaultSymbol:o.style&&o.style.symbol,u={regl:a,layer:this.layer,symbol:h,gl:l,isRenderingTerrain:n,sceneConfig:o.config?o.config.sceneConfig:null,dataConfig:o.config?o.config.dataConfig:null,pluginIndex:s,timestamp:t};i&&MB(u,i),o.startFrame(u)}))}un(t){const e=this.sn,n=e.renderMode,r=e&&e.renderTarget&&e.renderTarget.fbo,i=this.getMap().cameraPosition,o=this.yn(),s=!!this.Fn,a=!e.timestamp||e.isFinalRender;this.layer.options.collision&&!e.isPostProcess?o.forEach((e=>{if(!this.gn(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(s&&!SH(e))return;const r=this.Cn(e,0,i,t);e.prepareRender(r),e.updateCollision(r)})):o.forEach((e=>{if(!this.gn(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(s&&!SH(e))return;const r=this.Cn(e,0,i,t);e.prepareRender(r)}));const l=this.Qe!==e.timestamp;let h=!1;if(l&&!s){const e=this.layer.getPolygonOffset()+this.layer.getPolygonOffsetCount(),n=this.Cn(null,e,i,t);n.offsetFactor=e,n.offsetUnits=e,this.Oe.paint(n)}o.forEach(((e,o)=>{if(!this.On(e))return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(s&&!SH(e))return;this.regl.clear({stencil:255,framebuffer:r});const a=this.cn[o]||0,l=this.Cn(e,a,i,t);e.painter&&e.painter.isEnableTileStencil(l)&&this.En(r,e.painter);const u=e.endFrame(l);u&&u.redraw&&this.setToRedraw(),h=!0})),h&&this.layer.fire("canvasisdirty"),a&&this.Dn()}getPolygonOffsetCount(){return this.dn||0}Dn(){if(this.layer.options.debug){const t=this.sn,e=[],n=this.getMap().projViewMatrix;for(const r in this.tilesInView){const i=this.tilesInView[r].info,o=this.tilesInView[r].image;if(o.An)continue;const s=i.transform,a=o.extent,l=t&&t.renderTarget;if(s&&a){const t=this.getDebugInfo(i.id),r=am(e,n,s),o=this.layer.getTileSize().width;this.Ye.draw(t,r,o,a,l&&l.fbo)}}}}On(t){if(!t)return!0;const e=this.sn,n=this.gn(t),r=e&&e.states&&e.states.includesChanged,i=this.Ln(t.painter.scene.getMeshes());return n&&(r||i)?i?2:1:0}Cn(t,e,n,r){const i=!!this.Fn,o=i&&t&&CH(t),s=this.regl,a=this.gl,l={regl:s,layer:this.layer,gl:a,isRenderingTerrain:i,isRenderingTerrainSkin:o,sceneConfig:t&&t.config.sceneConfig,pluginIndex:t&&t.renderIndex,polygonOffsetIndex:e,cameraPosition:n,timestamp:r},h=this.sn;return h&&MB(l,h),l}Ln(t){if(!t)return!1;const e=this.sn&&this.sn.sceneFilter;return e?t.filter((t=>e(t)||t.properties.hlBloomMesh&&e(t.properties.hlBloomMesh))).length>0:t.length>0}En(t,e){const n=e.isUniqueStencilRefPerTile(),r=this.getCurrentTileZoom();let i=this.Rn;i||(i=this.Rn=new XB(this.regl,this.canvas,this.getMap())),i.start();const{tiles:o}=this.Hn;let{parentTiles:s,childTiles:a}=this.Hn,l=1;a=a.sort(EH);for(let u=0;u<a.length;u++){const t=n?l:this.getTileLevelValue(a[u].info,r);this.zn(a[u].info,t),l++}s=s.sort(EH);for(let u=0;u<s.length;u++){const t=n?l:this.getTileLevelValue(s[u].info,r);this.zn(s[u].info,t),l++}const h=o.sort(EH);for(let u=h.length-1;u>=0;u--){const t=n?l:this.getTileLevelValue(h[u].info,r);this.zn(h[u].info,t),l++}i.render(t)}zn(t,e){const n=TH.set(t.extent2d.xmin,t.extent2d.ymax),r=t.extent||this.kn||8192,i=t.transform=t.transform||this.calculateTileMatrix(n,t.z,r);t.stencilRef=e,this.Rn.add(e,r,i)}onDrawTileStart(t){super.onDrawTileStart(t);const{tiles:e,childTiles:n,parentTiles:r}=t;this.vn={},this.bn={};for(let i=0;i<e.length;i++)this.vn[e[i].info.id]=1;for(let i=0;i<n.length;i++)this.bn[n[i].info.id]=1;for(let i=0;i<r.length;i++)this.bn[r[i].info.id]=1;this.Hn=t}isEnableTileStencil(){if(this.layer.options.altitude)return!1;const t=this.Ge();for(let e=0;e<t.length;e++)if(t[e]&&t[e].painter&&!t[e].painter.isOnly2D())return!1;return!0}setTerrainHelper(t){this.Fn=t}getTerrainHelper(){return this.Fn}drawTileOnTerrain(...t){IH.prototype.drawTile.call(this,...t)}createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,r=2*e,i=t.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:r});this.Nn||(this.Nn=t.renderbuffer({width:n,height:r,format:"depth24 stencil8"}));const o={width:n,height:r,colors:[i],colorFormat:"rgba",ignoreStatusCheck:!0};o.depthStencil=this.Nn;const s=t.framebuffer(o);return s.colorTex=i,s}deleteTerrainTexture(t){t.destroy(),t.colorTex&&(t.colorTex.destroy(),delete t.colorTex)}renderTerrainSkin(t,e,n){const r=this.Qe,i=this.sn,o=this.layer.getTileSize().width;this.an(r);for(let s=0;s<n.length;s++){const e=n[s].texture;this.sn={renderTarget:{fbo:e}},MH.framebuffer=e,t.clear(MH),this.sn.viewport=kH(o),this.Vn(n[s].tile,e)}this.Un(n),this.sn=i}Vn(t){const{info:e,image:n}=t;this.drawTile(e,n,CH)}Un(t){const e=this.yn(),n=this.getMap().cameraPosition,r=this.Qe||0;this.layer.options.collision?e.forEach((t=>{if(!this.gn(t)||!t.hasMesh())return;if(!CH(t)||!this.layer.options.awareOfTerrain)return;const e=this.Cn(t,0,n,r);e.isRenderingTerrainSkin=!0,t.prepareRender(e),t.updateCollision(e)})):e.forEach((t=>{if(!this.gn(t)||!t.hasMesh())return;if(!CH(t)||!this.layer.options.awareOfTerrain)return;const e=this.Cn(t,0,n,r);e.isRenderingTerrainSkin=!0,t.prepareRender(e)})),e.forEach(((e,n)=>{if(!this.On(e)||!CH(e))return;for(let o=0;o<t.length;o++){const e=t[o].texture;this.regl.clear({stencil:255,framebuffer:e})}const r=this.cn[n]||0,i=this.Cn(e,r,[0,0,0],this.Qe);i.isRenderingTerrainSkin=!0,e.endFrame(i)}))}drawTile(t,e,n){if(!e.cache)return;const r=!!this.Fn,i=e.cache,o=TH.set(t.extent2d.xmin,t.extent2d.ymax),s=t.extent||this.kn||8192,a=t.transform=t.transform||this.calculateTileMatrix(o,t.z,s),l=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(o,t.z),h=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(o,t.z,s),u=this.sn,c=[];OB(c,e.data),OB(c,e.featureData),this.Ge(e).forEach(((o,s)=>{if(!o||n&&!n(o))return;if(!c[s])return;if(!i[s])return;const f=r&&CH(o),d=this.regl,p=this.gl,g={regl:d,layer:this.layer,gl:p,sceneConfig:o.config.sceneConfig,pluginIndex:s,tileCache:i[s],tileData:c[s],tileTransform:f?h:a,tileVectorTransform:a,tileTranslationMatrix:l,tileExtent:e.extent,timestamp:this.en,tileInfo:t,tileZoom:this._tileZoom,bloom:this.sn&&this.sn.bloom,isRenderingTerrain:r,isRenderingTerrainSkin:f};f&&u&&u.renderTarget&&(g.renderTarget=u.renderTarget);const m=o.paintTile(g);!this.Re&&(m.retire||m.redraw)&&o.supportRenderMode("taa")&&(this.Re=!0),m.redraw&&this.setToRedraw()})),e&&e.style===this.Pe&&this.jn(t),this.setCanvasUpdated()}Gn(t,e){if(!e.loadTime||e.An)return;let n=e.cache;n||(n=e.cache={});const r=!!this.Fn,i=TH.set(t.extent2d.xmin,t.extent2d.ymax),o=t.transform=t.transform||this.calculateTileMatrix(i,t.z,e.extent),s=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(i,t.z),a=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(i,t.z,t.extent),l=[];OB(l,e.data),OB(l,e.featureData),this.Ge(e).forEach(((i,h)=>{if(!i)return;if(!l[h])return;const u=r&&CH(i),c=this.regl,f=this.gl;n[h]||(n[h]={});const d={regl:c,layer:this.layer,gl:f,sceneConfig:i.config.sceneConfig,pluginIndex:h,tileCache:n[h],tileData:l[h],tileTransform:u?a:o,tileVectorTransform:o,isRenderingTerrain:r,isRenderingTerrainSkin:u,tileTranslationMatrix:s,tileExtent:e.extent,timestamp:this.en,tileInfo:t,tileZoom:this._tileZoom},p=i.createTile(d);n[h].geometry&&(e.data[h]=1),!this.Re&&p.retire&&i.supportRenderMode("taa")&&(this.Re=!0)}))}checkTileInQueue(t){return t.styleCounter===this.Pe}pick(t,e,n){const r=[];return this.layer.isVisible()?(this.Ge().forEach((i=>{if(!i)return;if(!this.gn(i))return;const o=i.pick(t,e,n.tolerance);o&&(o.type=i.getType(),r.push(o))})),r):r}deleteTile(t){if(t){if(t.image&&!t.image.An){const e=t.image&&t.image.style,n=this.Ve(e);n&&n.forEach(((e,n)=>{e&&e.deleteTile({pluginIndex:n,regl:this.regl,layer:this.layer,gl:this.gl,tileCache:t.image.cache?t.image.cache[n]:{},tileInfo:t.info,tileData:t.image})})),t.image.cache={}}t.info&&(delete t.info.completeTerrainQuery,delete t.info.terrainQueryStatus),super.deleteTile(t)}}abortTileLoading(t,e){e&&e.url&&(this.Ce&&this.Ce.abortTile(e.url),delete this.Te[e.url]),super.abortTileLoading(t,e)}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||(this.pickingFBO.resize(e.width,e.height),this.Ge().forEach((t=>{t&&t.resize(e.width,e.height)}))))}onRemove(){this.Rn&&this.Rn.remove(),this.Ce&&(this.Ce.removeLayer((t=>{if(t)throw t})),this.Ce.remove(),delete this.Ce),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.Ye&&(this.Ye.delete(),delete this.Ye),this.Nn&&(this.Nn.destroy(),delete this.Nn),this.Oe&&(this.Oe.dispose(),delete this.Oe),super.onRemove&&super.onRemove(),this.Ne()}Ne(){this.yn().forEach((t=>{t.remove()})),this.plugins={}}hitDetect(t){if(!this.gl||!this.layer.options.hitDetect)return!1;const e=this.gl,n=new Uint8Array(4),r=this.canvas.height;return e.readPixels(t.x,r-t.y,1,1,e.RGBA,e.UNSIGNED_BYTE,n),n[3]>0}He(){const{style:t,featureStyle:e}=this.layer.De(),n=t.map(((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for style at "+e);const r=this.Bn(n);return r.styleCounter=this.Pe,r.style=t,r})),r=[];e.forEach(((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for features at "+e);const i=this.Bn(n);return i.style=t,i.styleCounter=this.Pe,r.push(i),i}));const i=this.Pe;return this.Ie[i]=n,this.Fe[i]=r,this.layer.fire("pluginsinited"),(this.$n&&this.$n.size||this.layer.$n)&&(this.layer.$n&&this.layer.Wn(),this.getMap().getRenderer().callInNextFrame((()=>{this.Ge().forEach((t=>{t.highlight(this.$n)}))}))),n}Bn(t){const e=this.layer.constructor.getPlugins()[t.type];if(!e)throw new Error(`Plugin for (${t.type}) is not loaded.`);const n=new e;return n.config=t,n.config.sceneConfig||(n.config.sceneConfig={}),n}Je(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let o=0;o<n.length;++o){try{r=t.getContext(n[o],e)}catch(i){}if(r)break}return r}rn(t){return LB(t,this.getMap())}debugFBO(t,e){const n=document.getElementById(t),r=e.width,i=e.height;n.width=r,n.height=i;const o=n.getContext("2d"),s=this.regl.read({framebuffer:e}),a=i/2|0,l=4*r;for(let c=0;c<s.length;c++)s[c]*=255;const h=new Uint8Array(4*r);for(let c=0;c<a;++c){const t=c*l,e=(i-c-1)*l;h.set(s.subarray(t,t+l)),s.copyWithin(t,e,e+l),s.set(h,e)}const u=new ImageData(r,i);u.data.set(s),o.putImageData(u,0,0)}In(t){let e;switch(t){case"native-line":e={type:"native-line",dataConfig:{type:"native-line",only2D:!0}};break;case"native-point":e={type:"native-point",dataConfig:{type:"native-point",only2D:!0}};break;case"fill":e={type:"fill",dataConfig:{type:"fill",only2D:!0},sceneConfig:{antialias:!0}};break;default:e=null}const n=function(t){switch(t){case"native-point":return{markerFill:"#f00",markerSize:6,markerOpacity:.5};case"native-line":return{lineColor:"#bbb",lineOpacity:.5};case"fill":return{polygonFill:"#76a6f0",polygonOpacity:.8}}return null}(t),r=this.Bn(e);return r.defaultSymbol=n,{plugin:r,symbol:n,renderPlugin:e}}gn(){return!0}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&function(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),r="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&r)return!0}return!1}(this.gl)}getZScale(){return this.nn}outline(t,e){e&&(Array.isArray(e)||(e=[e]),this.pn||(this.pn=[]),this.pn.push(["paintOutline",[t,e]]),this.setToRedraw())}outlineFeatures(t){t&&(Array.isArray(t)||(t=[t]),this.pn||(this.pn=[]),this.pn.push(["paintOutline",[null,t]]),this.setToRedraw())}outlineBatch(t){this.pn||(this.pn=[]),this.pn.push(["paintBatchOutline",[t]]),this.setToRedraw()}outlineAll(){this.mn=!0,this.setToRedraw()}paintOutlineAll(t){const e=this.Ge();for(let n=0;n<e.length;n++)e[n].outlineAll(t)}paintOutline(t,e,n){if(!EB(e)){const r=e,i=this.Ge();if(!i[r]||i[r].painter&&!i[r].painter.isVisible())return;return void i[r].outline(t,n)}const r=this.Ge();for(let i=0;i<n.length;i++){const e=n[i];for(let n=0;n<r.length;n++)r[n].style&&r[n].style.id===e&&r[n].outline(t,[e])}}paintBatchOutline(t,e){const n=this.Ge();!n[e]||n[e].painter&&!n[e].painter.isVisible()||n[e].outlineAll(t)}cancelOutline(){delete this.pn,delete this.mn,this.setToRedraw()}setZIndex(){return this.setToRedraw(),this.Re=!0,super.setZIndex.apply(this,arguments)}consumeTile(t,e){if(this.jn(e),super.consumeTile(t,e),"transient"===this.layer.options.features&&t.data){for(let e=0;e<t.data.length;e++){if(!t.data[e])continue;const n=t.data[e].features;if(n)for(const t in n){const e=n[t]&&n[t].feature;e&&(e.fnTypeProps?e.customProps[tH]=e.fnTypeProps:n[t]=null)}}this.layer.fire("_transientfeature",{tileImage:t})}t&&t.features&&(t.features=[]),this.Gn(e,t)}onTileError(t,e){this.jn(e),super.onTileError(t,e)}jn(t){const{id:e}=t;if(this.ze&&this.ze[e]){const t=this.ze[e];this.deleteTile(t),delete this.ze[e]}}highlight(t){if(this.$n||(this.$n=new Map),Array.isArray(t))for(let e=0;e<t.length;e++)EB(t[e].name)&&!EB(t[e].id)&&(t[e]=MB({},t[e]),t[e].name=t[e].id),this.$n.set(t[e].name,t[e]);else EB(t.name)&&!EB(t.id)&&((t=MB({},t)).name=t.id),this.$n.set(t.name,t);this.Ge().forEach((t=>{t.highlight(this.$n)})),this.Be=!0}cancelHighlight(t){if(this.$n){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.$n.delete(t[e]);else this.$n.delete(t);this.Ge().forEach((t=>{t.highlight(this.$n)})),this.Be=!0}}cancelAllHighlight(){this.$n&&(delete this.$n,this.Ge().forEach((t=>{t.cancelAllHighlight()})),this.Be=!0)}Xn(){const t=this.layer.options.opacity;return this.We()?EB(t)?1:t:1}}function PH(t){let e;Array.isArray(t.data)?(e=[],OB(e,t.data)):(e={},MB(e,t.data));const n=MB({},t);return n.data=e,n}function EH(t,e){return e.info.z-t.info.z}function OH(t){const e={};for(let n=0;n<t.length;n++){const r=t[n].layer||"default";e[r]||(e[r]=[]),e[r].push(t[n])}return e}function RH(t){if(Array.isArray(t)){const e=t;for(let t=0;t<e.length;t++)if(RH(e[t]))return!0}for(const e in t)if(nO(t[e])||yF(t[e]))return!0;return!1}function kH(t){return{x:0,y:0,width:2*t,height:2*t}}function LH(t){if(!t.cache)return[];for(const e in t.cache){const n=t.cache[e];if(n.geometry)for(let t=0;t<n.geometry.length;t++){const e=n.geometry[t]&&n.geometry[t].geometry;if(e&&e.properties&&e.properties.features){const t=e.properties.features.empty;delete e.properties.features.empty;const n=Object.values(e.properties.features);return void 0!==t&&(e.properties.features.empty=t),n}}}return[]}IH.include({calculateTileMatrix:function(){const t=new Array(3),e=new Array(3),n=new Array(3);return function(r,i,o){const s=this.getTileGLScale(i),a=r,l=this.layer.getTileSize().width,h=im([]);return hm(h,h,Lm(t,s,s,this.nn)),lm(h,h,Lm(e,a.x,a.y,0)),hm(h,h,Lm(n,l/o,-l/o,1)),h}}(),calculateTerrainTileMatrix:function(){const t=new Array(3);return function(e,n,r){const i=im([]),o=r/2;return hm(i,i,Lm(t,1/o,-1/o,0)),lm(i,i,Lm(t,-o,-o,0)),i}}(),calculateTileTranslationMatrix:function(){const t=new Array(3);return function(e,n){const r=this.getTileGLScale(n),i=e,o=im([]);return lm(o,o,Lm(t,i.x*r,i.y*r,0)),o}}()});const DH=new i(0,0),NH=new n(0,0),FH=[null,0],zH=[];class BH extends d{static loadFrom(t,e){return fetch(t,e||{}).then((t=>t.json())).then((t=>BH.fromJSON(t)))}constructor(t,e){super(t,e),this.Yn={},this.VERSION=BH.VERSION;const n=e&&e.style;this.setStyle(n)}setURLModifier(t){this.qn=t;const e=this.getRenderer();return e&&e.updateOptions(),this}getURLModifier(){return this.qn}onAdd(){const t=this.getMap();this.Jn();const e=this.getSpatialReference().toJSON().projection,n=t.getSpatialReference().toJSON().projection;if((e&&e.toLowerCase())!==(n&&n.toLowerCase()))throw new Error(`VectorTileLayer's projection(${e}) must be the same with map(${n}).`)}setFeatureState(t,e){if(EB(t.id))throw new Error("missing id in first parameter of setFeatureState.");this.Kn||(this.Kn={});const n=t.layer||"0";let r=this.Kn[n];return this.Kn[n]||(r=this.Kn[n]=new Map),r.set(t.id,e),this.Zn(),this}removeFeatureState(t,e){if(EB(t.id))throw new Error("missing id in first parameter of removeFeatureState.");if(!this.Kn)return this;const n=t.layer||"0",r=this.Kn[n];if(!r)return this;if(e){const n=r.get(t.id);if(PB(e))for(const t in e)delete n[t];else delete n[e];r.set(t.id,n)}else r.delete(t.id);return this.Zn(),this}getFeatureState(t){if(EB(t.id))throw new Error("missing id in first parameter of getFeatureState.");if(!this.Kn)return null;const e=t.layer||"0";return this.Kn[e].get(t.id)}Zn(){const t=this.getRenderer();if(!t)return;const e=t.getFrameTimestamp();this.Qn=e}ti(){return this.Qn}ei(t){return this.Qn&&this.Qn!==t}Jn(){const t=this.options,e=this.getMap().getProjection(),n="EPSG:4326"===e.code||"EPSG:4490"===e.code,r="EPSG:3857"===e.code;t.spatialReference||512===this.getTileSize().width&&(r?t.spatialReference="preset-vt-3857":n&&(t.spatialReference="preset-vt-4326")),t.tileSystem||(t.tms?r?t.tileSystem=[1,1,-6378137*Math.PI,-6378137*Math.PI]:n&&(t.tileSystem=[1,1,-180,-90]):n&&(t.tileSystem=[1,-1,-180,90]))}forceReload(){const t=this.getRenderer();return t&&t.Ke(),super.forceReload()}onWorkerReady(){}onConfig(t){const e=this.getRenderer();e&&e.updateOptions(t)}getWorkerOptions(){return{debug:this.options.debug,debugTile:this.options.debugTile,altitudeProperty:this.options.altitudeProperty,tileSize:this.getTileSize().width,style:this.isDefaultRender()?{style:[],featureStyle:[]}:this.De(),features:this.options.debugTileData||this.options.features,schema:this.options.schema,pickingGeometry:this.options.pickingGeometry,projectionCode:this.getSpatialReference().getProjection().code,workerGlyph:this.options.workerGlyph&&!this.getURLModifier(),featureIdProperty:this.options.featureIdProperty}}setStyle(t){if(t&&(CB(t)||t.url)){const e=t,n=e.lastIndexOf("/"),r=n<0?".":e.substring(0,n);return this.ready=!1,FB.getJSON(t.url?t.url:t,t.url?t:{},((t,n)=>{if(t)throw this.setStyle([]),t;let i;n.style?(i=n,i.$root||(i.$root=r)):i={$root:r,style:n},this.options.style=e,this.ni(i)})),this}return this.options.style=t,this.ni(t),this}ii(t,e,n,r){const i=r/this.getTileSize().width;return t.set(n.x+e.x/i,n.y-e.y/i)}queryTilePointTerrain(t,e,n,r,i){const o=this.getRenderer(),s=o&&o.getTerrainHelper();if(!o||!s)return FH[0]=null,FH[1]=0,FH;const a=this.ii(DH,t,n,r);return e&&s.queryTileTerrainByPointAtRes?s.queryTileTerrainByPointAtRes(a,i,e.id,e,zH):(FH[0]=null,FH[1]=0,FH)}queryTerrainTiles(t){const e=this.getRenderer(),n=e&&e.getTerrainHelper();return e&&n?n.getTerrainTiles(t):null}ni(t){if(t&&t.$root){let e=t.$root;e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),this.dt=function(t){return"{$root}"===t?e:null}}this.ready=!0,t=t||[],Array.isArray(t)?t={style:t}:t.renderPlugin&&(t={style:[t]}),t=function(t){if(!t.plugins)return t;const{plugins:e,styles:n}=t;let{style:r,featureStyle:i}=n;r=r||[],i=i||[];const o=new Array(r.length);for(let l=0;l<r.length;l++)o[l]=MB({},r[l]),o[l].renderPlugin=e[r[l].renderPlugin];const s=new Array(i.length);for(let l=0;l<i.length;l++)s[l]=MB({},i[l]),s[l].renderPlugin=e[i[l].renderPlugin];const a={style:o,featureStyle:s};return t.$root&&(a.$root=t.$root),a}(t=JSON.parse(JSON.stringify(t))),this.ri=t.featureStyle||[],this.si=function(t){if(!t||!Array.isArray(t))return[];const e=[];for(let n=0;n<t.length;n++){const r=t[n].style;if(r&&Array.isArray(r)&&r.length)for(let i=0;i<r.length;i++){const o=MB({},t[n],r[i]);r[i].oi=e.length,delete o.style,e.push(o)}else e.push(MB({},t[n]))}return e}(t.featureStyle),this.ai=t.style||[];const e=t.background||{};this.li={enable:e.enable||!1,color:jH(e.color)||[0,0,0,0],opacity:UH(e.opacity,1),patternFile:e.patternFile,depthRange:e.depthRange},this.validateStyle(),this.dt&&this.hi(),this._n();const n=this.getRenderer();n&&n.setStyle(),this.fire("setstyle",{style:this.getStyle(),computedStyle:this.getComputedStyle()})}getPolygonOffsetCount(){const t=this.getRenderer();return t?t.getPolygonOffsetCount():0}getPolygonOffset(){return this.ui||0}setPolygonOffset(t,e){return this.ui=t,this.ci=e,this}getTotalPolygonOffset(){return this.ci}fi(t){if(!t||!t.length)return;const e=this._getTileConfig();let n;for(let r=0,i=t.length;r<i;r++){const{feature:i,tile:o}=t[r],s=i.geometry;if(!i||!o||!s)continue;if(s.type)continue;const{x:a,y:l,res:h,extent:u}=o;void 0===a&&void 0===l&&void 0===h||(n=e.getTilePointNW(a,l,h));const c=i.type,f=this.di(c,s,n,u,h);i.geometry=f}}getRenderedFeatures(){const t=this.getRenderer();if(!t)return[];const e=t.getRenderedFeatures()||[];for(let n=0,r=e.length;n<r;n++){const t=e[n];if(!t)continue;const r=t.features||[];this.fi(r)}return e}getRenderedFeaturesAsync(t={}){return new Promise(((e,n)=>{const r=this.getRenderer();if(r)if(x){const n=r.getRenderedFeatures()||[],i=[];n.forEach((t=>{const e=t.features||[];e.length&&OB(i,e)}));const o=(t=Object.assign({},{countPerTime:1e4},t)).countPerTime,s=Math.ceil(i.length/o);let a=1;const l=()=>{const t=(a-1)*o,e=a*o,n=i.slice(t,e);this.fi(n),a++};x.runTaskAsync({count:s,run:l}).then((()=>{e(n)}))}else e(this.getRenderedFeatures());else e([])}))}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t,e){const n=this.getRenderer();return n?(n.outline(t,e),this):this}outlineBatch(t){const e=this.getRenderer();return e?(e.outlineBatch(t),this):this}outlineFeatures(t){const e=this.getRenderer();return e?(e.outlineFeatures(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}highlight(t){this.mi(t);const e=this.getRenderer();return e?(e.highlight(t),this):(this.$n||(this.$n=[]),this.$n.push(t),this)}mi(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.mi(t[e]);else{if(t.filter){if(!this.options.features)throw new Error("options.features must be turned on to support filter in highlight");if(!t.name)throw new Error("A name is required for highlight with filter")}if(EB(t.filter)&&EB(t.id))throw new Error("id or filter must be provided for highlight")}}Wn(){if(this.$n){for(let t=0;t<this.$n.length;t++)this.highlight(this.$n[t]);delete this.$n}}cancelHighlight(t){const e=this.getRenderer();return e?(e.cancelHighlight(t),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}hi(){s.convertStylePath(this.ai,this.dt),s.convertStylePath(this.si,this.dt)}updateSceneConfig(t,e){return CB(t)&&(t=this.yi(t)),this.gi(0,t,e)}updateFeatureSceneConfig(t,e,n){return this.gi(1,t,n,e)}gi(t,e,n,r){const i=this.je(t);if(!i)return this;let o,s=e;if(i[e].renderPlugin.sceneConfig||(i[e].renderPlugin.sceneConfig={}),MB(i[e].renderPlugin.sceneConfig,n),void 0!==r){VH(this.ri,e,r),s=this.ri[e].style[r].oi;const t=i[s].renderPlugin;t.sceneConfig||(t.sceneConfig={}),o=t.sceneConfig}else GH(i,e),o=i[e].renderPlugin.sceneConfig;if(MB(o,n),Array.isArray(this.options.style)){const t=this.options.style[e].renderPlugin;t.sceneConfig||(t.sceneConfig={}),MB(t.sceneConfig,n)}else{const i=this.je(t,this.options.style);let o;void 0!==r?(VH(i,e,r),o=i[e].style[r].renderPlugin):(GH(i,e),o=i[e].renderPlugin),o.sceneConfig||(o.sceneConfig={}),MB(o.sceneConfig,n)}const a=this.getRenderer();return a&&a.updateSceneConfig(t,s,n),0===t?this.fire("updatesceneconfig",{index:e,sceneConfig:n}):1===t&&this.fire("updatefeaturesceneconfig",{index:e,styleIdx:r,sceneConfig:n}),this}updateDataConfig(t,e){return CB(t)&&(t=this.yi(t)),this.vi(0,t,e)}updateFeatureDataConfig(t,e,n){return this.vi(1,t,n,e)}vi(t,e,n,r){const i=this.je(t);if(!i)return this;let o,s=e;void 0!==r?(VH(this.ri,e,r),s=this.ri[e].style[r].oi,o=i[s].renderPlugin.dataConfig):(GH(i,e),o=i[e].renderPlugin.dataConfig);const a=MB({},o);if(MB(o,n),Array.isArray(this.options.style))MB(this.options.style[e].renderPlugin.dataConfig,n);else{const i=this.je(t,this.options.style);let o;void 0!==r?(VH(i,e,r),o=i[e].style[r].renderPlugin):(GH(i,e),o=i[e].renderPlugin),o.dataConfig||(o.dataConfig={}),MB(o.dataConfig,n)}const l=this.getRenderer();return l&&l.updateDataConfig(t,s,n,a),0===t?this.fire("updatedataconfig",{index:e,dataConfig:n}):1===t&&this.fire("updatefeaturedataconfig",{index:e,styleIdx:r,dataConfig:n}),this}updateSymbol(t,e){return CB(t)&&(t=this.yi(t)),this.xi(0,t,e)}updateFeatureSymbol(t,e,n){return this.xi(1,t,n,e)}xi(t,e,n,r){const i=this.je(t);if(!i)return this;let o=e;void 0!==r&&(VH(this.ri,e,r),o=this.ri[e].style[r].oi);const a=i[o];if(!a)throw new Error(`No style defined at ${e}`);const l=this,h=this.dt;function u(n,i,o){if(!n)return!1;h&&(n=JSON.parse(JSON.stringify(n)),s.parseSymbolPath(n,h));const a=Object.keys(n);let u=!1;for(let t=0;t<a.length;t++){const e=a[t];if(HH(i[e])||HH(n[e])){u=!0;break}}for(const t in n)kB(n,t)&&(!s.isObject(n[t])||Array.isArray(n[t])||nO(n[t])?i[t]=n[t]:(i[t]||(i[t]={}),MB(i[t],n[t])));let c=l.options.style;if(CB(c))return u;Array.isArray(c)||(c=l.je(t,l.options.style));const f=JSON.parse(JSON.stringify(i));return void 0!==r?(VH(c,e,r),void 0===o?c[e].style[r].symbol=f:c[e].style[r].symbol[o]=f):(GH(c,e),void 0===o?c[e].symbol=f:c[e].symbol[o]=f),u}const c=this.getRenderer();if(!c)return u(),this._n(),this;let f=!1;const d=a.symbol;if(Array.isArray(n))for(let s=0;s<n.length;s++){const t=u(n[s],d[s],s);t&&(f=t)}else u(n,d);return this._n(),f?c.setStyle():(f=c.updateSymbol(t,o,n),f&&c.setStyle()),0===t?this.fire("updatesymbol",{index:e,symbol:n}):1===t&&this.fire("updatefeaturesymbol",{index:e,featureStyleIndex:r,symbol:n}),this}je(t,e){return e?0===t?e.style:e.featureStyle:0===t?this.ai:this.si}isDefaultRender(){return!!this.bi&&this.options.defaultRendering}validateStyle(){this.bi=!1;let t=this.ai;this.options.style||(this.bi=!0,t=this.ai=[]),Array.isArray(t)||(t=this.ai=[t]);for(let e=0;e<t.length;e++){let n=t[e].filter;if(n&&n.value&&(n=n.value),n||console.warn(`render plugin at ${e} doesn't define filter, its filter will be set to 'default' by default.`),void 0!==n&&"default"!==n&&!0!==n&&!Array.isArray(n)&&void 0===n.condition)throw new Error(`Invalid filter at ${e} : ${JSON.stringify(n)}`)}}getStyle(){return this.options.style?JSON.parse(JSON.stringify(this.options.style)):null}yi(t){const e=this.ai;if(!e)return-1;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;throw new Error(`No style defined with name: ${t}`)}getGroundConfig(){this.wi||(this.wi={enable:!0,renderPlugin:{type:"fill",sceneConfig:{}},symbol:{polygonFill:[0,0,0,0],polygonOpacity:1}});const t=this.De().background||{};return this.wi.enable=t.enable,this.wi.symbol.polygonFill=t.color,this.wi.symbol.polygonOpacity=t.opacity,this.wi.symbol.polygonPatternFile=t.patternFile,this.wi.renderPlugin.sceneConfig.depthRange=t.depthRange,this.wi}getComputedStyle(){return JSON.parse(JSON.stringify(this.De()))}De(){return{background:this.li,style:this.ai||[],featureStyle:this.si||[]}}identify(t,e={}){const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const o=r.coordToContainerPoint(new n(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const i=n.getDevicePixelRatio();let o=r.pick(t.x*i,t.y*i,e);return this.options.features&&"id"!==this.options.features&&(o=this.Ai(o)),e&&e.filter?o.filter((t=>e.filter(t))):o}Ai(t){if(!this.getRenderer())return t;const e=this._getTileConfig(),n=this.getSpatialReference();for(let r=0;r<t.length;r++){let i=t[r];if(!i||!i.data)continue;const{tile:o}=i.data,{x:s,y:a,z:l,extent:h}=o,u=n.getResolution(l),c=e.getTilePointNW(s,a,u),f=i.data.feature&&i.data.feature.geometry;if(f){i.data=MB({},i.data),i.data.feature=MB({},i.data.feature);const t=i.data.feature.type;i.data.feature.type="Feature",i.data.feature.geometry=this.di(t,f,c,h,u)}}return t}di(t,e,n,r,i){if(e.type&&e.coordinates)return e;let o,s;if(1===t)e.length<=1?(o="Point",s=this.Mi(e,n,r,i)||[]):(o="MultiPoint",s=this.Mi(e,n,r,i));else if(2===t)e.length<=1?(o="LineString",s=this.Mi(e,n,r,i)||[]):(o="MultiLineString",s=this.Mi(e,n,r,i));else if(3===t){s=[];let t=[],a=0;for(let o=0;o<e.length;o++)Uk(e[o])>0&&(a++,t&&t.length&&s.push(t),t=[]),t.push(this.Mi(e[o],n,r,i));t.length&&s.push(t),a<=1?(o="Polygon",s=s[0]):o="MultiPolygon"}return{type:o,coordinates:s}}Mi(t,e,n,r){const i=n/this.getTileSize().width,o=this.getMap(),s=t=>{const n=[];PB(t)&&(t=[t]);for(let s=0,a=t.length;s<a;s++){const a=t[s];DH.x=e.x+a.x/i,DH.y=e.y-a.y/i,o.pointAtResToCoord(DH,r,NH),n.push(NH.toArray())}return 1===t.length?n[0]:n};if(PB(t))return s(t);const a=t.length;if(1===a)return s(t[0]);{let e=[];for(let n=0;n<a;n++)e.push(s(t[n]));return e}}getDataSchema(t){return this.Yn||(this.Yn={}),EB(t)||this.Yn[t]||(this.Yn[t]={}),EB(t)?this.Yn:this.Yn[t]}onRemove(){super.onRemove()}static fromJSON(t){return t&&"VectorTileLayer"===t.type?new BH(t.id,t.options):null}_n(){}static registerPlugin(t){BH.plugins||(BH.plugins={}),BH.plugins[t.type]=t}static getPlugins(){return BH.plugins||{}}static compressStyleJSON(t){return Array.isArray(t)&&t.length?function(t){Array.isArray(t)&&(t={style:t,featureStyle:[]});const e=[],n=[],r=[];DB(t.style,e,r),DB(t.featureStyle,n,r);const i={plugins:r,styles:{style:e,featureStyle:n}};return t.$root&&(i.$root=t.$root),i}(t):t}}function HH(t){return!(!t||!t.properties)}function jH(t){return t?(Array.isArray(t)||(t=JO(t).unitArray()),3===t.length&&t.push(1),t):null}function UH(t,e){return null==t?e:t}function VH(t,e,n){if(!t[e]||!t[e].style||!t[e].style[n])throw new Error(`No plugin defined at feature style of ${e} - ${n}`)}function GH(t,e){if(!t[e])throw new Error(`No plugin defined at style of ${e}`)}BH.prototype._getTileZoom=function(t){return t=Math.floor(t),d.prototype._getTileZoom.call(this,t)},BH.registerJSONType("VectorTileLayer"),BH.mergeOptions({urlTemplate:null,renderer:"gl",altitudeProperty:"altitude",forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,tileSize:[512,512],features:!1,schema:!1,cascadeTiles:!0,collision:!0,collisionBuffserSize:0,picking:!0,pickingPoint:!0,pickingGeometry:!1,glyphSdfLimitPerFrame:15,tileLimitPerFrame:1,loadingLimitOnInteracting:5,loadingLimit:0,antialias:!1,iconErrorUrl:null,collisionFrameLimit:1.5,defaultRendering:!0,textGamma:1,maxIconSize:254,workarounds:{"win-intel-gpu-crash":!1},pyramidMode:1,styleScale:1,enableAltitude:!0,fadeAnimation:!1,debugTileData:!1,fetchOptions:null,awareOfTerrain:!0,altitudeQueryTimeLimitPerFrame:3,workerGlyph:!0,featureIdProperty:null,currentTilesFirst:!0}),BH.registerRenderer("gl",IH),BH.registerRenderer("canvas",null);const WH=new p(1,1);class qH extends _{static registerPainter(t,e){qH.painters||(qH.painters={}),qH.painters[t]=e}static get3DPainterClass(t){return qH.painters[t]}setURLModifier(t){return this.qn=t,this}getURLModifier(){return this.qn}getEvents(){let t;return t=super.getEvents?super.getEvents():{},t.spatialreferencechange=this._i,t}onConfig(t){if(super.onConfig(t),void 0!==t.enableBloom){const e=this.getRenderer();e&&e.updateBloom(t.enableBloom)}}updateSymbol(t,e){if(!this.options.style)throw new Error("can't call update symbol when style is not set");const n=Array.isArray(this.options.style)?this.options.style:this.options.style.style;if(!n[t])throw new Error(`invalid style at ${t}`);return MB(n[t].symbol,e),this.setStyle(this.options.style),this}getPolygonOffsetCount(){return this.isEmpty()||this.options.altitude?0:1}getPolygonOffset(){return this.options.altitude?0:this.ui||0}setPolygonOffset(t,e){return this.ui=t,this.ci=e,this}getTotalPolygonOffset(){return this.ci}identify(t,e={}){const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const o=r.coordToContainerPoint(new n(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const i=this.getMap().getDevicePixelRatio(),o=r.pick(t.x*i,t.y*i,e);return e&&e.filter?o.filter((t=>e.filter(t))):o}getComputedStyle(){return{style:this.getStyle()||[]}}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t){if(!Array.isArray(t)||!t.length)return this;const e=this.getRenderer();return e?(e.outline(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}toJSON(){const t={type:this.getJSONType(),id:this.getId(),options:this.config(),geometries:[]},e=this.getGeometries();for(let n=0,r=e.length;n<r;n++){const r=e[n].toJSON();t.geometries.push(r)}return t}getTileSize(){return WH}_i(){const t=this.getRenderer();t&&t._i()}}qH.mergeOptions({picking:!0,pickingPoint:!0,renderer:"gl",collision:!1,collisionBufferSize:0,textGamma:1,geometryEvents:!0,styleScale:1,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,meshRenderOrder:0,enableBloom:!1,enableAltitude:!0,workarounds:{"win-intel-gpu-crash":!0}});const XH={redraw:!1,retire:!1},ZH=[];let YH=1;function JH(t,e){const n=tk.extend(t,{init:function(){this.Si={}},isVisible(){return this.painter&&this.painter.isVisible()},supportRenderMode:function(t){return this.painter.supportRenderMode(t)},hasMesh(){return this.painter&&this.painter.hasMesh()},startFrame:function(t){const n=t.layer,r=t.regl,i=t.sceneConfig,o=t.dataConfig,s=t.symbol;let a=this.painter;if(!a){const l=t.pluginIndex;a=this.painter=new e(r,n,s,i,l,o)}this.Si||(this.Si={});const l=i.excludes;this.ki?l!==this.ki&&(this.Pi=l?KO(l):null,this.ki=l):l&&(this.ki=l),a.startFrame(t),this.Ti={}},updateCollision:function(t){const e=this.painter;return e&&e.isVisible()?e.updateCollision(t):null},prepareRender:function(t){const e=this.painter;return e&&e.isVisible()?e.prepareRender(t):null},endFrame:function(t){const e=this.painter;return e&&e.isVisible()?e.render(t):null},getShadowMeshes(){const t=this.painter;return t&&t.getShadowMeshes&&t.getShadowMeshes()||ZH},createTile:function(t){const{tileCache:e,tileData:n}=t;let r=!1;const i=this.painter;if(!i)return{retire:r};const o=this.Ii(t);let s=e.geometry;if(!s){const o=n.features,a=n.data;if(!a||!a.length)return{retire:r};const l=a;if(this.painter.colorSymbol&&!function(t){if(!t)return!0;for(const e in t)return!1;return!0}(o))for(let t=0;t<a.length;t++){const e=this.Fi(o,a[t].data.aPickingId,a[t].indices,a[t].data.aPosition,a[t].positionSize);a[t].data.aColor=e}s=e.geometry=i.createGeometries(l,o);for(let e=0;e<s.length;e++)s[e]&&s[e].geometry&&(r=!0,s[e].geometry.properties.features=o,this.Ci(s[e].geometry,t))}let a=this.Me(o);if(!a){const{meshes:e,retire:n}=this.Oi(s,t);r||(r=n),a=e}return{retire:r}},Oi(t,e){const{tileInfo:n,tileExtent:r,tileTransform:i,tileTranslationMatrix:o,tileVectorTransform:s,tileZoom:a,sceneConfig:l}=e;let h=!1;const u=this.painter,c=[n.extent2d.xmin,n.extent2d.ymax],f=u.createMeshes(t,i,{tileExtent:r,tilePoint:c,tileZoom:a,tileTranslationMatrix:o,tileVectorTransform:s},e);if(f.length){for(let n=0;n<f.length;n++)f[n]&&(h=!0,this.Ei(f[n],i,e.timestamp,YH++,u.isEnableTileStencil()));l.animation&&(f.Di=e.timestamp);const t=this.Ii(e);this.Si[t]=f}return{meshes:f,retire:h}},paintTile:function(t){const{tileCache:e,tileInfo:n,tileZoom:r,sceneConfig:i}=t,o=this.painter;if(!o)return XH;let s=e.geometry;if(!s)return XH;let a=!1;const l=this.Ii(t);let h=this.Me(l);if(!h){const{meshes:e,retire:n}=this.Oi(s,t);a||(a=n),h=e}if(!h.length)return XH;const u=o.getTileLevelValue(n,r);h.forEach((t=>{t.properties.tile=n,t.properties.level=u}));let c=!1;if(!this.Ti[l]){let e=null,n=i.animation;if(n){const r=t.sceneConfig.animationDuration||800,i=(t.timestamp-h.Di)/r,o=h[0].properties.createTime;h.Di-o<r&&i<1&&(!0!==n&&1!==n||(n="linear"),e="linear"===n?i:KR(n,i),c=!0)}o.addMesh(h,e,t),this.Ti[l]=1}return{redraw:c,retire:a}},Ei:function(t,e,n,r,i){if(t.properties.tileTransform=e,t.properties.createTime=n,t.properties.meshKey=r,t.needUpdateShadow=!0,i){const e=t.defines||{};e.ENABLE_TILE_STENCIL=1,t.setDefines(e)}"stencilRef"in t.uniforms||Object.defineProperty(t.uniforms,"stencilRef",{enumerable:!0,get:function(){return t.properties.tile&&void 0!==t.properties.tile.stencilRef?t.properties.tile.stencilRef:t.properties.level}})},Ci:function(t,e){const{layer:n,tileInfo:r}=e,i=n.getMap(),o=(n.getSpatialReference?n.getSpatialReference():i.getSpatialReference()).getResolution(r.z),s=e.tileExtent/n.getTileSize().width;t.properties.tileResolution=o,t.properties.tileRatio=s,t.properties.z=r.z,t.properties.tileExtent=e.tileExtent},updateSceneConfig:function(t){const e=this.painter;e&&e.updateSceneConfig(t.sceneConfig)},updateDataConfig:function(t,e){const n=this.painter;return!n||n.updateDataConfig(t,e)},updateSymbol:function(t,e){const n=this.painter;if(!n)return!1;if(n.shouldDeleteMeshOnUpdateSymbol(t)){if(this.Si)for(const t in this.Si)n.deleteMesh(this.Si[t],!0);delete this.Si,delete this.Ti}return n.updateSymbol(t,e)},pick:function(t,e,n){return this.painter&&this.painter.pick?this.painter.pick(t,e,n):null},deleteTile:function(t){if(!this.Si)return;const e=this.Ii(t),n=this.Si[e];n&&this.painter&&this.painter.deleteMesh(n),delete this.Si[e],this.Ti&&delete this.Ti[e]},remove:function(){const t=this.painter;if(t&&this.Si){for(const e in this.Si)t.deleteMesh(this.Si[e]);t.delete(),delete this.painter}delete this.Si,delete this.Ti},resize:function(t,e){const n=this.painter;n&&n.resize(t,e)},needToRedraw:function(){return!!this.painter&&this.painter.needToRedraw()},needToRetireFrames:function(){return!!this.painter&&this.painter.needToRetireFrames()},isAnimating(){return!!this.painter&&this.painter.isAnimating()},needToRefreshTerrainTileOnZooming:function(){return!!this.painter&&this.painter.needToRefreshTerrainTileOnZooming()},isTerrainSkin:function(){return!!this.painter&&this.painter.isTerrainSkin()},isTerrainVector:function(){return!!this.painter&&this.painter.isTerrainVector()},Fi:function(t,e,n,r,i=3){if(!r||!t||!e.length)return null;const o=new Uint8Array(r.length/i*4);let s,a;const l=this.painter.colorSymbol,h={};let u;for(let c=0,f=e.length;c<f;c++){const n=e[c];if(s=t[n].symbol,a=h[n],!a)if(l){let e;e="function"==typeof l?l(t[n].feature&&t[n].feature.properties):l,e=JO(e),a=h[n]=e.array()}else a=h[n]=[255,255,255];u=4*c,o[u]=a[0],o[u+1]=a[1],o[u+2]=a[2],o[u+3]=255*(s[this.painter.opacitySymbol]||1)}return o},Ii:function(t){const e=t.tileInfo;return e.meshKey||(e.meshKey=YH++),e.meshKey},Me:function(t){return this.Si[t]},Li(t,e){if(Array.isArray(t))t.forEach(((t,n)=>{const{features:r}=t.properties;this.Ri(t,e[n],r)}));else{const{features:n}=t.properties;this.Ri(t,Array.isArray(e)?e[0]:e,n)}},Ri(t,e,n){const r=e.featureIndexes||e.data.featureIndexes;if(r)if(this.Pi){const i=e.indices;let o=null,s=!1;const a=[];for(let t=0;t<i.length;t++){const e=n[r[i[t]]];null!==o&&o===i[t]||(s=this.Pi(e.feature),o=i[t]),s||a.push(i[t])}t.setElements(new e.indices.constructor(a))}else t.setElements(e.indices)},outline(t,e){const n=this.painter;n&&n.outline(t,e)},outlineAll(t){const e=this.painter;e&&e.outlineAll(t)},needPolygonOffset(){const t=this.painter;return t&&t.needPolygonOffset()},highlight(t){const e=this.painter,n=this.style.name,r=this.renderIndex;if(t){const e=[];if(t.forEach(((t,i)=>{void 0!==t.plugin&&null!==t.plugin&&(Array.isArray(t.plugin)?t.plugin.length&&t.plugin.indexOf(n)<0&&t.plugin.indexOf(r)<0&&e.push(i):t.plugin!==n&&t.plugin!==r&&e.push(i))})),e.length){const n=new Map(t);for(let t=0;t<e.length;t++)n.delete(e[t]);t=n}}return e&&e.highlight(t)},cancelAllHighlight(){const t=this.painter;return t&&t.cancelAllHighlight()}});return n}function QH(t){return!t||(void 0!==t.empty||(t.empty=function(t){for(const e in t)return!1;return!0}(t)),t.empty)}const KH="_fn_type_",$H="__current_fn_types";function tj(t,e,n,r){if(!QH(t.properties.features))for(let i=0;i<n.length;i++){const{symbolName:o}=n[i];(t[$H]=t[$H]||{})[o]=e[o],ej(t,e,n[i],r)}}function ej(t,e,n,r){const i=function(t){const e=t.properties;let n=e.aPickingId;return n||(n=e.aPickingId=new t.data.aPickingId.constructor(t.data.aPickingId)),n}(t),{attrName:o,symbolName:s,related:a}=n;let l=t.data[o];return l?cj(e[s])||function(t,e){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(cj(e[t[n]]))return!0;return!1}(a,e)?(cj(e[s])&&nj(t,e,n),l):(t.deleteData(o),rj(t,o),null):cj(e[s])?(l=t.data[o]=new n.type(n.width*i.length),function(t,e,n,r,i){const{attrName:o}=r,s=(KH+o+"Index").trim();nj(e,n,r);lj(e,e.properties[s],r,i)}(0,t,e,n,r),l):null}function nj(t,e,n){const{attrName:r,symbolName:i}=n,o=t.properties,s=(KH+r+"Index").trim(),a=(KH+r).trim();if(o[s]&&o[a])return;const l=function(t){if(!t)return aj;const e=[];for(let n=0;n<t.length;n++)nO(t[n][1])&&!iO(t[n][1]).isZoomConstant&&e.push(t[n][0]);return e}(e[i].stops),h="identity"===e[i].type&&function(t,e,n){if(Array.isArray(n)||(n=Object.values(n)),!n||!n.length)return!1;if(!gL[t])return!1;for(let r=0;r<n.length;r++){const t=n[r]&&(n[r].feature||n[r]);if(!t)continue;const i=t.properties&&t.properties[e];if(i&&nO(i)&&!iO(i).isZoomConstant)return!0}return!1}(i,e[i].property,o.features);if(!h&&!l.length)return void rj(t,r);const{features:u,aPickingId:c}=o,f=function(t,e,n,r,i){const o=[];let s=0,a=e[0];for(let l=1,h=e.length;l<h;l++)!t[a]||e[l]===a&&l!==h-1||((i||sj(t[a].feature,n,r))&&o.push(s,l===h-1?h:l),a=e[l],s=l);return o}(u,c,e[i].property,l,h);if(!f.length)return void rj(t,r);const d=t.data[r];o[s]=f,o[a]=d.BYTES_PER_ELEMENT?new d.constructor(d):new n.type(d.length)}function rj(t,e){const n=t.properties,r=(KH+e+"Index").trim(),i=(KH+e).trim();delete n[r],delete n[i]}function ij(t,e,n,r,i,o){if(!i)return;const s=i.geometry;if(s&&!QH(s.properties.features)){for(let a=0;a<r.length;a++){const l=r[a],h=l.attrName;if(!(oj(s,n,l)||e.ei&&e.ei(i.geometry.Hi))){const{aPickingId:t}=s.properties;if(!t||s.zi===o)continue;const n=(KH+h+"Index").trim(),r=s.properties[n];if(!r)continue;lj(s,r,l,e);continue}const u=ej(s,n,l),c=l.define;if(u){const n=(KH+h+"Index").trim();if(lj(s,s.properties[n],l,e),e.ti&&(s.Hi=e.ti()),c){const t=i.defines;t[c]=1,i.setDefines(t)}s.generateBuffers(t)}else if(c){const t=i.defines;t[c]&&(delete t[c],i.setDefines(t))}}s.zi=o}}function oj(t,e,n){const r=e[n.symbolName],i=t[$H];return!CT(r,i[n.symbolName])&&(i[n.symbolName]=r,!0)}function sj(t,e,n){for(let r=0;r<n.length;r++)if("$"===e[0]&&t[e.substring(1)]===n[r]||t.properties[e]===n[r])return!0;return!1}const aj=[];function lj(t,e,n,r){const{attrName:i,evaluate:o}=n,{aPickingId:s,features:a}=t.properties;let l;if(e){const n=(KH+i).trim();l=t.properties[n];const h=l.length/s.length,u=e.length;for(let i=0;i<u;i+=2){const n=e[i],u=e[i+1];let c=a[s[n]];c&&c.feature&&uj(l,c,o,n,u,h,t,r)}}else{if(l=t.data[i],h=l,Array.isArray(h)||h.constructor===Float32Array||h.constructor===Float64Array||h.constructor===Uint8Array||h.constructor===Int8Array||h.constructor===Uint16Array||h.constructor===Int16Array||h.constructor===Uint32Array||h.constructor===Int32Array||h.constructor===Uint8ClampedArray)l.dirty=!0;else{const e=(KH+i).trim();l=t.properties[e],l||(l=t.properties[e]=new n.type(n.width*s.length),l.dirty=!0)}const e=l.length/s.length,u=s.length;let c=0;for(let n=0;n<u;n++){if(s[n]===s[c]&&n<u-1)continue;let i=a[s[c]];i&&i.feature&&(uj(l,i,o,c,n===u-1?u:n,e,t,r),c=n)}}var h;l.dirty&&(t.updateData(i,l),l.dirty=!1)}const hj={};function uj(t,e,n,r,i,o,s,a){const l=(e=e.feature).properties||{};if(void 0===l.$layer&&(e.properties||(e.properties=l),l.$layer=e.layer,l.$type=e.type),a.getFeatureState&&(hj.layer=e.layer,hj.id=e.id,e[eH]&&(e[eH]=null),!lH(e.id))){const t=a.getFeatureState(hj);e.properties[eH]=t}const h=n(l,s,t,r*o);if(Array.isArray(h)){let e=!1;for(let n=0;n<o;n++)if(t[r*o+n]!==h[n]){e=!0;break}if(e){for(let e=r*o;e<i*o;e+=o)t.set(h,e);t.dirty=!0}}else t[r]!==h&&(gH(t,h,r,i),t.dirty=!0)}function cj(t){return fL(t)}const fj=[];function dj(t,e,n,r,i){return cA(fj,e[0],e[1],e[2],1),TA(fj,fj,n),t[2]=fj[3],mA(fj,fj,1/fj[3]),t[0]=(fj[0]+1)*r/2,t[1]=(1-fj[1])*i/2,t}const pj=[],gj=[],mj=[],Aj=[-99999,-99999],yj=new i(0,0),vj=[];function xj(t,e,n,r,i,o,s,a){const{res:l,extent:h,extent2d:u}=n.properties.tile,{xmin:c,ymax:f}=u,d=c+r.x*i,p=f-r.y*i;let g=null;if(a)for(let v=0;v<a.length;v++)if(_j(a[v],d,p,l)){g=a[v];break}if(!g)return Aj;const m=yj.set(c,f),A=o.queryTilePointTerrain(r,g,m,h,l),y=null===A[0]?JB:A[0];if(y){let n=Lm(vj,r.x,r.y,0);return n[2]+=100*y,n=dj(t,n,s,e.width,e.height),n}return t[0]=r.x,t[1]=r.y,t}function _j(t,e,n,r){const i=yj.set(e,n)._multi(r/t.res);return t.extent2d.contains(i)}const{loginIBLResOnCanvas:bj,logoutIBLResOnCanvas:wj,getIBLResOnCanvas:Tj}=xT.PBRUtils,Mj="__gl_textures",Cj=[],Sj=new i(0,0),Ij=new i(0,0),Pj=new Float32Array(1),Ej=[],Oj=t=>0===t.properties.level,Rj=t=>t.properties.level>0;class kj{static getBloomSymbol(){return["bloom"]}constructor(t,e,n,r,i,o){this.Ni=!0,this.regl=t,this.layer=e,this.canvas=t._gl.canvas,this.sceneConfig=r||{},this.dataConfig=o||{},this.pluginIndex=i,this.scene=new __,this.pickingFBO=e.getRenderer().pickingFBO,this.level0Filter=Oj,this.levelNFilter=Rj,this.loginTextureCache(),this.symbolDef=Array.isArray(n)?n.map((t=>hH(t))):[hH(n)],this.Vi(),this.pickingViewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.sortByCommandKey=Lj.bind(this),this.colorCache={},this.Ui=this.symbolDef.map((t=>!(!t||!1!==t.visible)))}hasMesh(){const t=this.scene&&this.scene.getMeshes();return this.isVisible()&&t&&!!t.length}getMap(){return this.layer?this.layer.getMap():null}getTileLevelValue(t,e){const n=this.layer.getRenderer();return n.getTileLevelValue&&n.getTileLevelValue(t,e)||0}getAnalysisMeshes(){return this.getShadowMeshes?this.getShadowMeshes():Ej}isVisible(){const{minZoom:t,maxZoom:e}=this.sceneConfig,n=this.getMap().getZoom();if(!lH(t)&&n<t)return!1;if(!lH(e)&&n>e)return!1;const r=this.tt;if(r.length)for(let o=0;o<r.length;o++)if(r[o]&&!r[o].isFeatureConstant)return!0;const i=this.getSymbols();for(let o=0;o<i.length;o++){const t=i[o].visible;if(!1!==t&&0!==t)return!0}return!1}isMeshVisible(t){const e=t&&t.properties&&t.properties.symbolIndex;if(!e)return!1;const n=this.tt,r=e.index;let i;if(n[r]){if(!n[r].isFeatureConstant)return!0;i=n[r](this.getMap().getZoom())}else i=this.getSymbol(e).visible;return!1!==i&&0!==i}isAnimating(){return!1}needToRedraw(){return this.isAnimating()||this.ji}needToRetireFrames(){return this.Re}needToRefreshTerrainTileOnZooming(){return!0}isTerrainSkin(){return this.layer.options.awareOfTerrain}isTerrainVector(){return!1}isShadowIncludeChanged(t){const e=t&&t.isRenderingTerrain&&this.isTerrainSkin();return t&&t.states&&t.states.includesChanged.shadow||e&&this.Gi}fillIncludes(t,e,n){if(delete this.Gi,n&&n.isRenderingTerrain&&this.isTerrainSkin())return;const r=n&&n.includes;if(r){let i="";for(const o in r)r[o]&&(i+=o,n[o].uniformDeclares&&e.push(...n[o].uniformDeclares),n[o].defines&&oH(t,n[o].defines));this.Gi=i}}setIncludeUniformValues(t,e){if(e&&e.isRenderingTerrain&&this.isTerrainSkin())return;const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&oH(t,e[r].renderUniforms)}createGeometries(t,e){if(!t.length)return Ej;const n=[];for(let r=0;r<t.length;r++)if(t[r])if(void 0!==t[r].ref)n[t[r].ref]?n.push({geometry:n[t[r].ref].geometry,symbolIndex:t[r].symbolIndex,ref:t[r].ref}):n.push(null);else{t[r]&&!t[r].is2D&&(this.Ni=!1);const i=this.createGeometry(t[r],e,r);if(i&&i.geometry){const o=i.geometry.properties,{pickingIdMap:s,idPickingMap:a,hasFeaIds:l}=this.Bi(t[r]);l&&(o.feaIdPickingMap=s,o.feaPickingIdMap=a),o.symbolIndex=i.symbolIndex,o.features=e,o.is2D=t[r].is2D,o.layer=this.layer,o.positionBounding=t[r].positionBounding,this.postCreateGeometry(i,n)}n.push(i)}return n}isOnly2D(){return this.Ni}postCreateGeometry(){}Bi(t){if(!t)return{};if(Array.isArray(t)&&!(t=t[0]))return{};const e=t.featureIds,n={},r={},i=e&&e.length;if(i)for(let o=0;o<e.length;o++){const i=t.data.aPickingId[o];void 0===n[i]&&(n[i]=e[o],r[e[o]]||(r[e[o]]=[]),r[e[o]].push(t.data.aPickingId[o]))}return{hasFeaIds:i,idPickingMap:n,pickingIdMap:r}}createGeometry(){throw new Error("not implemented")}createMeshes(t,e,n,r){const i=this.layer.options.awareOfTerrain,o=[];for(let s=0;s<t.length;s++){if(!t[s])continue;if(i&&r&&r.isRenderingTerrain&&this.isTerrainVector()){const e=t[s],n=e&&e.geometry;this.$i(n,n.data,n.properties,n.positionSize||n.desc.positionSize,r)}let a=this.createMesh(t[s],e,n,r||{});Array.isArray(a)?(a=a.filter((t=>!!t)),o.push(...a)):a&&o.push(a)}return o}createMesh(){throw new Error("not implemented")}getAltitudeOffsetMatrix(){const t=100*(this.dataConfig.altitudeOffset||0),e=im([]);return Lm(Cj,0,0,t),lm(e,e,Cj),e}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).bloom}forbiddenTerrainUpscale(){return!0}addMesh(t,e,n){if(n.isRenderingTerrain&&this.isTerrainSkin()&&this.forbiddenTerrainUpscale()){const t=this.getMap().getResolution();if(n.tileInfo.res/t>3)return}const r=n.isRenderingTerrain&&this.isTerrainVector(),i=this.getRenderFBO(n);t=t.filter((t=>this.isMeshVisible(t))),r&&(t=t.filter((t=>t.geometry&&t.geometry.data.aTerrainAltitude)));const o=void 0===this.sceneConfig.castShadow||!!this.sceneConfig.castShadow,s=!(!n||!n.bloom);t.forEach((t=>{const e=this.isBloom(t)&&s;t.bloom=e,t.castShadow=o;let a=!1;const l=t.defines||{};if(!!l.HAS_BLOOM!==e&&(a=!0,e?l.HAS_BLOOM=1:delete l.HAS_BLOOM),r){if(t.geometry.data.aTerrainAltitude){const e=t.geometry;this.$i(e,e.data,e.properties,e.desc.positionSize,n)}t.geometry.data.aTerrainAltitude&&!l.HAS_TERRAIN_ALTITUDE&&(l.HAS_TERRAIN_ALTITUDE=1,a=!0)}else l.HAS_TERRAIN_ALTITUDE&&(delete l.HAS_TERRAIN_ALTITUDE,a=!0);a&&t.setDefines(l),i?t.setUniform("targetFramebuffer",i):t.uniforms.targetFramebuffer&&(t.uniforms.targetFramebuffer=null),this.Wi(t)})),this.scene.addMesh(t)}updateCollision(){}render(t){return this.pluginIndex=t.pluginIndex,this.polygonOffsetIndex=t.polygonOffsetIndex,this.paint(t),{redraw:this.ji,drawCount:this.Xi}}prepareRender(t){if(this.Qe===t.timestamp)return;if(!this.createFnTypeConfig)return;const e=this.scene.getMeshes();if(!e||!e.length)return;const n=t&&t.sceneFilter,r=this.getMap().getZoom();for(let i=0;i<e.length;i++){if(!e[i]||!e[i].geometry)continue;if(n&&!n(e[i]))continue;const{symbolIndex:o}=e[i].properties,s=this.getSymbolDef(o);if(!s)continue;this.Qe=t.timestamp;const a=this.getFnTypeConfig(o);ij(this.regl,this.layer,s,a,e[i],r)}}paint(t){const e=this.layer.getMap();if(!e)return{redraw:!1};this.Yi=t;const n=this.getUniformValues(e,t);return this.callShader(n,t),{redraw:this.ji}}setToRedraw(t){t&&(this.Re=t),this.ji=!0}callShader(t,e){this.callCurrentTileShader(t,e),this.callBackgroundTileShader(t,e)}callCurrentTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.level0Filter,e.sceneFilter]:this.level0Filter),this.callRenderer(this.shader,t,e)}callBackgroundTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.levelNFilter,e.sceneFilter]:this.levelNFilter),this.scene.getMeshes().sort(Dj),this.callRenderer(this.shader,t,e)}callRenderer(t,e,n){const r=this.scene.getMeshes(),i=[];r.forEach((t=>{t.properties.hlBloomMesh&&n&&n.bloom&&i.push(t.properties.hlBloomMesh),i.push(t)})),this.qi(e),this.scene.setMeshes(i),this.Xi+=this.renderer.render(t,e,this.scene,this.getRenderFBO(n)),this.scene.setMeshes(r)}qi(t){const e=this.layer.options.altitude||0,n=this.layer.getRenderer();t.layerOpacity=n.Xn(),t.minAltitude=e}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}needPolygonOffset(){return!1}getPolygonOffset(){const t=this.layer;return{factor:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0),units:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0)}}getBlendFunc(){return{src:()=>this.sceneConfig.blendSrc||"one",dst:()=>this.sceneConfig.blendDst||"one minus src alpha"}}pick(t,e,n=3){if(!this.layer.options.picking||!1===this.sceneConfig.picking)return null;if(!this.pickingFBO||!this.picking)return null;const r=this.getMap(),i=this.getUniformValues(r);this.qi(i);for(let o=0;o<this.picking.length;o++){const s=this.picking[o];s.render(this.scene.getMeshes(),i,!0);let a={};s.getRenderedMeshes().length&&(a=s.pick(t,e,n,i,{viewMatrix:r.viewMatrix,projMatrix:r.projMatrix,returnPoint:this.layer.options.pickingPoint&&!1!==this.sceneConfig.pickingPoint,logDepthBufFC:2/(Math.log(r.cameraFar+1)/Math.LN2)}));const{meshId:l,pickingId:h,point:u}=a,c=(0===l||l)&&s.getMeshAt(l);if(!c||!c.geometry)continue;let f=c.geometry.properties;return f.features||(f=c.properties),u&&u.length&&(u[0]=Math.round(1e5*u[0])/1e5,u[1]=Math.round(1e5*u[1])/1e5,u[2]=Math.round(1e5*u[2])/1e5),{data:this.Ji(f&&f.features&&f.features[h]),point:u,coordinate:a.coordinate,plugin:this.pluginIndex}}return null}Ji(t){const e=t&&t.feature;if(!e||!e.customProps)return t;const n=oH({},t);return n.feature=oH({},t.feature),delete n.feature.customProps,n.feature.properties=oH({},e.properties,e.properties[tH],e.properties[eH]),delete n.feature.properties[eH],delete n.feature.properties[tH],delete n.feature.properties.$layer,delete n.feature.properties.$type,n}updateSceneConfig(){}updateDataConfig(t){return oH(this.dataConfig,t),!0}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++){if(!t[n].isValid())continue;const r=t[n].geometry;!e&&r&&r.dispose(),t[n].material&&t[n].material.dispose(),t[n].dispose(),yE.deleteHighlightBloomMesh(t[n])}else{if(!t.isValid())return;!e&&t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose(),yE.deleteHighlightBloomMesh(t)}}startFrame(t){this.Ki||(this.init(t),this.Ki=!0),this.Qe!==t.timestamp&&(this.ji=!1,this.Re=!1,this.Xi=0),this.scene.clear()}resize(){}delete(){if(this.scene.clear(),this.shader&&this.shader.dispose(),this.picking){for(let t=0;t<this.picking.length;t++)this.picking[t].dispose();delete this.picking}if(this.Zi){for(let t=0;t<this.Zi.length;t++)this.Zi[t].dispose();delete this.Zi}delete this.Qi,this.logoutTextureCache()}updateSymbol(t,e){Array.isArray(t)||(t=[t],e=[e]);let n=!1;for(let r=0;r<t.length;r++)if(t[r]){const i=this.er(r,t[r],e[r]);i&&(n=i)}return delete this.nr,this.setToRedraw(!1),n}ir(t,e){for(const n in e)if(yH(e,n)){if(fL(e[n])&&!this.layer.options.features&&(!t[n]||t[n].property!==e[n].property))return!0;if(xB[n]&&!CT(e[n],t[n]))return!0}return!1}er(t,e,n){if(!this.rr)return!1;const r=this.ir(this.symbolDef[t]||{},n);if(this.Ui[t]&&!1!==n.visible)return this.Ui[t]=!1,!0;this.symbolDef[t]=hH(n);const i=this.rr[t];for(const l in i)delete i[l];const o=this.getMap(),s=[],a=yB(this.symbolDef[t],(()=>(s[0]=o.getZoom(),s)));for(const l in a){const t=Object.getOwnPropertyDescriptor(a,l);t.get?Object.defineProperty(i,l,{get:t.get,set:t.set,configurable:!0,enumerable:!0}):i[l]=a[l]}return nO(n.visible)&&(this.tt[t]=iO(n.visible)),r}getSymbolDef(t){return this.symbolDef[t.index]}getSymbols(){return this.rr}getSymbol(t){const e=t.index;return this.rr[e]}Vi(){const t=this.getMap(),e=[],n=()=>(e[0]=t.getZoom(),e);this.rr=[],this.tt=[];for(let r=0;r<this.symbolDef.length;r++)this.rr[r]=yB(oH({},this.symbolDef[r]),n),this.symbolDef[r]&&nO(this.symbolDef[r].visible)&&(this.tt[r]=iO(this.symbolDef[r].visible))}getFnTypeConfig(t){this.nr||(this.nr=[]);const e=t.index;if(!this.nr[e]){const n=this.getSymbolDef(t),r=this.getMap();this.nr[e]=this.createFnTypeConfig(r,n)}return this.nr[e]}sr(){delete this.nr}loginTextureCache(){const t=(Mj+"").trim(),e=this.getMap();e[t]||(e[t]={count:0}),e[t].count++}logoutTextureCache(){const t=(Mj+"").trim(),e=this.getMap(),n=this.ar;if(n)for(const r in n)yH(n,r)&&e[t][r]&&(e[t][r].count--,e[t][r].count<=0&&delete e[t][r]);e[t].count--,e[t].count<=0&&(e[t]={})}getCachedTexture(t){const e=(Mj+"").trim(),n=this.getMap()[e][t];return n?n.data:null}addCachedTexture(t,e){const n=(Mj+"").trim(),r=this.getMap();let i=r[n][t];i?i.data=e:i=r[n][t]={data:e,count:0},this.ar||(this.ar={}),i.data.then||this.ar[t]||(i.count++,this.ar[t]=1)}disposeCachedTexture(t){let e;if(e="string"==typeof t?t:t.url,!this.ar||!this.ar[e])return;const n=(Mj+"").trim();delete this.ar[e];const r=this.getMap();r[n][e]&&(r[n][e].count--,r[n][e].count<=0&&delete r[n][e])}shouldDeleteMeshOnUpdateSymbol(){return!1}isEnableTileStencil(){return!0}isUniqueStencilRefPerTile(){return this.isOnly2D()}supportRenderMode(t){return"taa"===t||"fxaa"===t}outline(t,e){const n={};for(let r=0;r<e.length;r++)lH(e[r])||n[e[r]]||(this.lr(t,e[r]),n[e[r]]=1)}lr(t,e){if(!this.picking)return;if(this.hr||(this.hr=new __),!this.Zi&&(this.ur(),!this.Zi))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const n=this.getUniformValues(this.getMap(),this.Yi);this.qi(n);const r=this.cr(e);if(r.length)for(let i=0;i<r.length;i++){const o=r[i].geometry.properties.feaIdPickingMap;if(o){const s=o[e];if(s){const e={};this.hr.setMeshes(r[i]);for(let r=0;r<s.length;r++){const i=s[r];if(!e[i]){e[i]=1,n.highlightPickingId=i;for(let e=0;e<this.Zi.length;e++)this.renderer.render(this.Zi[e],n,this.hr,t)}}}}}}cr(t){const e=[],n=this.scene.getMeshes();for(let r=0;r<n.length;r++){const i=n[r],o=i.geometry.properties.feaIdPickingMap;o&&void 0!==o[t]&&e.push(i)}return e}outlineAll(t){if(!this.picking)return;if(!this.Zi&&(this.ur(),!this.Zi))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const e=this.getUniformValues(this.getMap(),this.Yi);this.qi(e),e.highlightPickingId=-1;for(let n=0;n<this.Zi.length;n++)this.renderer.render(this.Zi[n],e,this.scene,t)}ur(){if(!this.picking)return;const t=this.layer.getRenderer().canvas;this.Zi=[];for(let e=0;e<this.picking.length;e++){const n=this.picking[e].getPickingVert(),r={ENABLE_PICKING:1,HAS_PICKING_ID:1},i=this.picking[e].getUniformDeclares().slice(0);void 0!==i.uPickingId&&(r.HAS_PICKING_ID=2),this.Zi[e]=new U_({vert:n,frag:"precision highp float;\nuniform float highlightPickingId;\nvarying float vPickingId;\nvoid main() {\n  if(highlightPickingId < .0 || floor(highlightPickingId + .5) == floor(vPickingId + .5)) {\n    gl_FragColor = vec4(1.);\n  } else {\n    discard;\n  }\n}",uniforms:i,defines:r,extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},depth:{enable:!0,mask:!1,func:"always"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.Zi[e].filter=this.picking[e].filter}}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}getIBLRes(){const t=this.layer.getRenderer().canvas;return Tj(t)}createIBLTextures(){const t=this.layer.getRenderer().canvas;bj(t,this.regl,this.getMap()),this.setToRedraw(!0),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.layer.getRenderer().canvas;wj(t,this.getMap())}evaluateInFnTypeConfig(t,e,n,r,i){let o=this.dr;o||(o=this.dr={});const s=function(t){let e=0;const n=t&&t.length||0;if(!n)return e;let r;for(let i=0;i<n;i++)r=t.codePointAt(i),e=(e<<5)-e+r,e|=0;return e}(JSON.stringify(t));let a=o[s];return a||(a=o[s]=i?oO(t):iO(t)),a(n.getZoom(),r)}highlight(t){this.$n=t,this.pr=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}cancelAllHighlight(){this.$n=null,this.pr=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}mr(t,e){const{featureIds:n,pickingIdIndiceMap:r}=e;t.properties.aFeaIds=n,t.properties.pickingIdIndiceMap=r}Wi(t){if(t&&t.properties.isHalo)return;const{pickingIdIndiceMap:e}=t.geometry.properties,n=this.$n?function(t,e,n){const{aPickingId:r,feaIdPickingMap:i,features:o}=t.geometry.properties,s=new Map,a=n.keys();for(const l of a){const t=n.get(l);if(t)if(lH(t.id)){if(t.filter&&r){let n=null;for(let i=0;i<r.length;i++){r[i]!==n&&(n=r[i]);const a=o[n];t.filter(a&&a.feature,e)&&s.set(n,t)}}}else{const e=i[t.id];if(!e||!e.length)continue;for(let n=0;n<e.length;n++)s.set(e[n],t)}}return s}(t,this.layer,this.$n):null;yE.highlightMesh(this.regl,t,n,this.pr,e)}$i(t,e,n,r,i){let o=n.aAnchor;if(!o){const{aPosition:t}=e;o=n.aAnchor=t.slice(0)}let s=n.aTerrainAltitude;s||(s=n.aTerrainAltitude=new Float32Array(o.length/r),s.fill(JB)),this.yr(s,o,i.tileInfo,0,s.length-1),e.aTerrainAltitude?s.dirty&&this.gr(t,s):e.aTerrainAltitude=s,s.dirty=!1}gr(t,e){t&&t.updateData&&t.updateData("aTerrainAltitude",e)}yr(t,e,n,r,i){const{res:o,extent:s,extent2d:a,id:l}=n,h=this.pluginIndex,u=l+"-"+h;if(n.completeTerrainQuery||(n.completeTerrainQuery=[]),n.completeTerrainQuery[h])return;if(!n.completeTerrainQuery[h]&&this.Qi&&this.Qi.has(u)){const e=this.Qi.getAndRemove(u);return this.Qi.add(u,e),t.set(e.altitudeData),n.terrainTileInfos=e.terrainTileInfos,t.dirty=!0,void(n.completeTerrainQuery[h]=!0)}const c=this.layer,f=c.getMap(),d=c.getRenderer(),p=d&&d.getTerrainHelper();let g=n.terrainTileInfos;g||(g=n.terrainTileInfos=this.layer.queryTerrainTiles(n)),n.terrainQueryStatus||(n.terrainQueryStatus=[]);let m=!1,A=[];for(let S=0;S<n.terrainTileInfos.length;S++)if(A[S]=+p.isTerrainTileLoaded(n.terrainTileInfos[S].id),A[S]&&n.terrainQueryStatus[h]&&!n.terrainQueryStatus[h][S]){m=!0;break}if(!m&&n.terrainQueryStatus[h])return;const y=c.constructor;if(f.isInteracting()){const t=d.getFrameTimestamp();y.altitudeQueryFrameTimestamp!==t&&(y.altitudeQueryFrameTimestamp=t,y.altitudeQueryFrameTime=0);const e=c.options.altitudeQueryTimeLimitPerFrame;if(y.altitudeQueryFrameTime>e)return}const v=performance.now();n.terrainQueryStatus[h]=A;const{xmin:x,ymax:_}=a,b=Sj.set(x,_),w=this.layer.getTileSize().width/n.extent,T=e.length/t.length;let M=t.queryResult;M||(M=t.queryResult=new Map);let C=!0;for(let S=r;S<=i;S++){let n=e[S*T];n<0?n=0:n>s&&(n=s);let r=e[S*T+1];r<0?r=0:r>s&&(r=s);const i=n+r*s;let a,l,h=M.get(i);if(h||0===h)t[S]!==h&&(t[S]=h,t.dirty=!0);else{for(let t=0;t<g.length;t++)if(_j(g[t],x+w*n,_-w*r,o)){a=g[t];break}a&&(p.getRenderer().isTileCached(a.id)||t[S]===JB)&&(Ij.set(n,r),l=this.layer.queryTilePointTerrain(Ij,a,b,s,o)),h=t[S],l&&(h=null===l[0]?JB:l[0],Pj[0]=h,h=Pj[0]),t[S]!==h&&(t[S]=h,t.dirty=!0),l&&l[1]?M.set(i,h):C=!1}}y.altitudeQueryFrameTime=(y.altitudeQueryFrameTime||0)+(performance.now()-v),n.completeTerrainQuery[h]=C,C&&(this.Qi||(this.Qi=new S(4*this.layer.options.maxCacheSize)),this.Qi.add(u,{altitudeData:t,terrainTileInfos:g}))}}function Lj(t,e){const n=t&&t.getCommandKey(this.regl)||"",r=e&&e.getCommandKey(this.regl)||"";return n.localeCompare(r)}function Dj(t,e){return t.properties.level-e.properties.level}class Nj extends kj{createGeometry(t,e){if(!t.data)return{geometry:null,symbolIndex:t.symbolIndex};t.iconAtlas&&t.iconAtlas.image&&(t.iconAtlas.image.dataType=t.type,t.iconAtlas.image.type="icon"),t.glyphAtlas&&t.glyphAtlas.image&&(t.glyphAtlas.image.type="glyph");const n=oH({},t.data),r={primitive:this.getPrimitive(),positionSize:t.positionSize};n.aAltitude&&(r.altitudeAttribute="aAltitude");const i=new bx(n,t.indices,0,r);return i.properties={features:e},t.iconAtlas&&(i.properties.iconAtlas=t.iconAtlas.image,i.properties.iconPositions=t.iconAtlas.positions),t.glyphAtlas&&(i.properties.glyphAtlas=t.glyphAtlas.image),QH(e)||(i.properties.aFeaIds=t.featureIds,this.mr(i,t)),t.markerPlacement&&(i.properties.markerPlacement=t.markerPlacement),t.textPlacement&&(i.properties.textPlacement=t.textPlacement),oH(i.properties,t.properties),{geometry:i,symbolIndex:t.symbolIndex}}getRayCastData(t,e){const{features:n,aFeaIds:r}=t.geometry.properties;return n&&r?n[r[e]]:null}getPrimitive(){return"triangles"}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}supportRenderMode(t){return"noAa"===t}drawDebugAtlas(t){if(document.getElementById("MAPTALKS_ICON_DEBUG")){const e=document.getElementById("MAPTALKS_ICON_DEBUG");let n;if(e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px","alpha"===t.format){n=new Uint8ClampedArray(4*t.data.length);for(let e=0;e<t.data.length;e++)n[4*e+3]=t.data[e]}else n=new Uint8ClampedArray(t.data);const r=e.getContext("2d");r.imageSmoothingEnabled=!1,r.putImageData(new ImageData(n,t.width,t.height),0,0)}}}var Fj="#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\n#include <fbo_picking_vert>\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * vec4(c, 1.);\n  fbo_picking_setData(gl_Position.w, true);\n}";function zj(t,e,n,r){if(r){const t=sx.resizeToPowerOfTwo(e.data,e.width,e.height);e.data=t}const i=e,o={width:i.width,height:i.height,data:i.data,format:i.format,mag:"linear",min:r?"linear mipmap linear":"linear",flipY:n,premultiplyAlpha:!0};if("icon"===e.type){const t="point"!==e.dataType?"repeat":"clamp";o.wrapS=t,o.wrapT=t}return t.texture(o)}const Bj=[0,0],Hj=[];function jj(t){if(!t.properties.iconPositions)return Bj;let e,n=0;for(const s in t.properties.iconPositions)if(e=s,n++,n>1)return Bj;if(!e)return Bj;const r=t.properties.iconPositions[e],i=r.displaySize[0],o=r.displaySize[1];return Hj[0]=i,Hj[1]=o,Hj}const Uj=im([]),Vj={polygonFill:[1,1,1,1],polygonOpacity:1,uvScale:[1,1],uvOffset:[0,0],patternWidth:[0,0],patternOffset:[0,0]},Gj=[],Wj=new n(0,0),qj=new n(0,0),Xj=new n(0,0),Zj=[];class Yj extends Nj{static getBloomSymbol(){return["polygonBloom"]}prepareSymbol(t){const e=t.polygonFill;Array.isArray(e)&&(3===e.length&&e.push(1),t.polygonFill=e.map((t=>255*t)))}supportRenderMode(t){return this.sceneConfig.antialias||void 0===this.sceneConfig.antialias?"fxaa"===t||"fxaaBeforeTaa"===t:super.supportRenderMode(t)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Yj.getBloomSymbol()[0]]}forbiddenTerrainUpscale(){return!0}needPolygonOffset(){return!0}getAnalysisMeshes(){return this.isVisible()?this.scene.getMeshes().filter((t=>0===t.properties.level)):Gj}createMesh(t,e,n){const r=this.getMap(),{tilePoint:i}=n,{geometry:o,symbolIndex:s,ref:a}=t,l=this.layer instanceof d,h=this.layer.getTileSize().width,u=o.properties.tileExtent/h,c=o.properties.tileResolution,f=r.pointAtResToCoord(Wj.set(i[0],i[1]),c),p={tileExtent:o.properties.tileExtent,tileRatio:u},g=this.getSymbol(s),m=this.getSymbolDef(s);if(nO(m.polygonPatternFileOrigin)&&this.vr(m,t,l?[0,0]:i,c),(nO(m.polygonPatternFileWidth)||nO(m.polygonPatternFileWidth))&&this.wr(m,t,l?u:1,f,c),m.uvOffsetInMeter&&nO(m.uvOffset)&&this.Ar(m,t,f,c),uH(p,"polygonFill",g,"polygonFill",Vj.polygonFill,dH(this.colorCache)),uH(p,"polygonOpacity",g,"polygonOpacity",Vj.polygonOpacity),uH(p,"uvScale",g,"uvScale",Vj.uvScale),void 0===a){const t=this.getFnTypeConfig(s);tj(o,m,t,this.layer),o.generateBuffers(this.regl)}const A=o.properties.iconAtlas,y=2048;if(A&&o.data.aTexInfo){const t=[];Object.defineProperty(p,"uvOrigin",{enumerable:!0,get:()=>{const e=p.tileScale;if(o.data.aPatternOrigin)return t[0]=i[0]*e%y,t[1]=i[1]*e%y,t;const n=g.polygonPatternFileOrigin;return n?(Wj.set(n[0],n[1]),r.coordToPointAtRes(Wj,c,qj),Ly(t,i[0]-qj.x,i[1]-qj.y)):(t[0]=i[0]*e%y,t[1]=i[1]*e%y,t)}});const e=[];Object.defineProperty(p,"patternWidth",{enumerable:!0,get:()=>{if(o.data.aPatternWidth)return Vj.patternWidth;const t=m.polygonPatternFileWidth,n=m.polygonPatternFileHeight;if(!t&&!n)return Vj.patternWidth;const[r,i]=this.Mr(Zj,t,n,l?u:1,f,c);return Ly(e,r,i)}}),Object.defineProperty(p,"uvOffset",{enumerable:!0,get:()=>o.data.aPatternOffset||m.uvOffsetInMeter?Vj.uvOffset:g.uvOffset||Vj.uvOffset});const n=[];Object.defineProperty(p,"patternOffset",{enumerable:!0,get:()=>{if(o.data.aPatternOffset)return Vj.uvOffset;if(!m.uvOffsetInMeter)return Vj.uvOffset;const t=m.uvOffset;if(!t)return Vj.uvOffset;const e=_H(r,t[0],f,c),i=_H(r,t[1],f,c);return Ly(n,e,i)}}),Object.defineProperty(p,"tileScale",{enumerable:!0,get:function(){const t=m.polygonPatternFileWidth,e=m.polygonPatternFileHeight;return t||e?1:o.properties.tileResolution/r.getResolution()}}),p.polygonPatternFile=zj(this.regl,A,!1,!1),p.atlasSize=[A.width,A.height],this.drawDebugAtlas(A)}const v=new Kx(p,Vj),x=new h_(o,v,{castShadow:!1,picking:!0}),_={};return A&&o.data.aTexInfo&&(_.HAS_PATTERN=1),A&&o.data.aTexCoord&&(_.HAS_TEX_COORD=1,_.INVALID_TEX_COORD=rB+".0"),o.data.aAltitude&&(_.HAS_ALTITUDE=1),o.data.aColor&&(_.HAS_COLOR=1),o.data.aOpacity&&(_.HAS_OPACITY=1),o.data.aUVScale&&(_.HAS_UV_SCALE=1),o.data.aUVOffset&&(_.HAS_UV_OFFSET=1),o.data.aPatternOrigin&&(_.HAS_PATTERN_ORIGIN=1),o.data.aPatternWidth&&(_.HAS_PATTERN_WIDTH=1),o.data.aPatternOffset&&(_.HAS_PATTERN_OFFSET=1),l&&(_.IS_VT=1),x.setDefines(_),x.setLocalTransform(e),x.properties.symbolIndex=s,x}wr(t,e,n,r,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(QH(o))return;const s=t.polygonPatternFileWidth,a=t.polygonPatternFileHeight,l=iO(t.polygonPatternFileOrigin);let h,u;nO(s)&&(h=iO(s)),nO(a)&&(u=iO(a));const{aPickingId:c,aPatternOrigin:f}=e.data,d=c.length,p=new Float32Array(2*d);let g,m,A;for(let y=0,v=c.length;y<v;y++){let t,e;if(c[y]===g){p[2*y]=m,p[2*y+1]=A;continue}const d=o[c[y]];if(t=h?h(null,d.feature.properties):s,e=u?u(null,d.feature.properties):a,g=c[y],t||e){let o=r;if(f){const t=l(null,d.feature.properties);t&&(o=Xj.set(t[0],t[1]))}const[s,a]=this.Mr(Zj,t,e,n,o,i);m=p[2*y]=s,A=p[2*y+1]=a}else m=p[2*y]=0,A=p[2*y+1]=0}e.data.aPatternWidth=p}Ar(t,e,n,r){if(!(e=e&&e.geometry))return;const i=e.properties.features;if(QH(i))return;const o=this.getMap();let s=nO(t.uvOffsetInMeter)&&oO(t.uvOffsetInMeter);const a=iO(t.uvOffset),l=iO(t.polygonPatternFileOrigin),{aPickingId:h,aPatternOrigin:u}=e.data,c=h.length,f=new Float32Array(2*c);let d,p,g;for(let m=0,A=h.length;m<A;m++){if(h[m]===d){f[2*m]=p,f[2*m+1]=g;continue}const t=i[h[m]],e=a(null,t.feature.properties);let c=!0;if(s&&(c=s(null,t.feature.properties)),d=h[m],e&&c){let i=n;if(u){const e=l(null,t.feature.properties);e&&(i=Xj.set(e[0],e[1]))}const s=_H(o,e[0],i,r),a=_H(o,e[0],i,r);p=f[2*m]=s,g=f[2*m+1]=a}else p=f[2*m]=0,g=f[2*m+1]=0}e.data.aPatternOffset=f}vr(t,e,n,r){if(!(e=e&&e.geometry))return;const i=e.properties.features;if(QH(i))return;const o=this.getMap(),s=iO(t.polygonPatternFileOrigin),a=e.data.aPickingId,l=a.length,h=new Float32Array(2*l);let u,c,f;for(let d=0,p=a.length;d<p;d++){if(a[d]===u){h[2*d]=c,h[2*d+1]=f;continue}u=a[d];const t=s(null,i[u].feature.properties);t?(Wj.set(t[0],t[1]),o.coordToPointAtRes(Wj,r,qj),c=h[2*d]=qj.x,f=h[2*d+1]=qj.y):(c=h[2*d]=n[0],f=h[2*d+1]=n[1])}e.data.aPatternOrigin=h}createFnTypeConfig(t,e){const n=oO(e.polygonFill),r=iO(e.polygonOpacity),i=iO(e.uvScale),o=iO(e.uvOffset),s=new Uint8Array(1),a=new Uint16Array(2),l=new Uint8Array(2);return[{attrName:"aColor",symbolName:"polygonFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||JO(i).unitArray()),i=fH(i),i}},{attrName:"aOpacity",symbolName:"polygonOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=r(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),s[0]=255*i,s[0]}},{attrName:"aUVScale",symbolName:"uvScale",type:Uint16Array,width:2,define:"HAS_UV_SCALE",evaluate:e=>{const n=i(t.getZoom(),e);return a[0]=255*n[0],a[1]=255*n[1],a}},{attrName:"aUVOffset",symbolName:"uvOffset",type:Uint8Array,width:2,define:"HAS_UV_OFFSET",evaluate:e=>{const n=o(t.getZoom(),e);return l[0]=255*n[0],l[1]=255*n[1],l}}]}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this._r(t)),super.paint(t)}isEnableTileStencil(t){const e="VectorTileLayer"===this.layer.getJSONType(),n=this.layer instanceof d;return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())&&(e||n&&this.isOnly2D())}init(t){const e=this.regl,n=this.canvas,r={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:n?n.width:1,height:(t,e)=>e.viewport?e.viewport.height:n?n.height:1};this.renderer=new f_(e);const i={viewport:r,stencil:{enable:()=>this.isEnableTileStencil(t),func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:()=>{const t="VectorTileLayer"===this.layer.getJSONType(),e=this.isOnly2D();return t&&e?"zero":"replace"}}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:(t,e)=>{if(!lH(this.sceneConfig.depthMask))return!!this.sceneConfig.depthMask;if(e.hasSSRGround)return!0;if(e.meshConfig.transparent)return!1;const n=e.polygonOpacity;return!(mH(n)&&n<1)},func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this._r(t,i),this.pickingFBO){const t=[];this.picking=[new Nw(this.renderer,{vert:Fj,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return am(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:i},this.pickingFBO,this.getMap())]}}_r(t,e){const n=[],r=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(n,e.projViewMatrix,e.modelMatrix),n}}],i={};this.fillIncludes(i,r,t),this.shader=new U_({vert:"#define SHADER_NAME FILL\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\nuniform mat4 projViewModelMatrix;\n#ifndef IS_VT\nuniform mat4 modelMatrix;\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_TEX_COORD\nattribute vec2 aTexCoord;\n#endif\nattribute vec4 aTexInfo;\nuniform vec2 patternWidth;\nuniform vec2 patternOffset;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\n#ifdef IS_VT\nuniform float tileRatio;\nuniform float tileScale;\n#else\nuniform float glScale;\n#endif\n#ifdef HAS_UV_SCALE\nattribute vec2 aUVScale;\nvarying vec2 vUVScale;\n#endif\n#ifdef HAS_UV_OFFSET\nattribute vec2 aUVOffset;\nvarying vec2 vUVOffset;\n#endif\n#ifdef HAS_PATTERN_WIDTH\nattribute vec2 aPatternWidth;\n#endif\n#ifdef HAS_PATTERN_ORIGIN\nattribute vec2 aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nattribute vec2 aPatternOffset;\n#endif\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d, vec2 e) {\n  \n#ifdef IS_VT\nfloat f = d.x / e.x;\n  float h = d.y / e.y;\n  return vec2(f, h);\n#else\nfloat i = glScale;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  i = mix(glScale, 1., j);\n#endif\nvec2 k = uvOrigin;\n#ifdef HAS_PATTERN_ORIGIN\nk = aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nk += l;\n  float f = (d.x - k.x) * i / e.x;\n  float h = (d.y - k.y) * i / e.y;\n  return vec2(f, -h);\n#endif\n}\nvec2 m(vec4 n, vec2 o) {\n  \n#ifdef IS_VT\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nvec2 k = uvOrigin + l;\n#ifdef HAS_PATTERN_ORIGIN\nk = k - aPatternOrigin * tileScale;\n#endif\nfloat j = sign(length(patternWidth));\n  vec2 A = mix(o, patternWidth, j);\n#ifdef HAS_PATTERN_WIDTH\nA = aPatternWidth;\n#endif\nvec2 B = k * vec2(1., -1.) / A;\n  return mod(B, 1.) + c(n.xy * tileScale / tileRatio, A);\n#else\nvec2 A = o;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  A = mix(o, aPatternWidth, j);\n#endif\nvec4 C = modelMatrix * n;\n  return c(C.xy, A);\n#endif\n}\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <vt_position_vert>\n#include <highlight_vert>\nvoid main() {\n  vec3 D = unpackVTPosition();\n  vec4 n = vec4(D, 1.);\n  gl_Position = projViewModelMatrix * n;\n#ifdef HAS_PATTERN\nvec2 o = aTexInfo.zw + 1.;\n  vTexInfo = vec4(aTexInfo.xy, o);\n#ifdef HAS_TEX_COORD\nif(aTexCoord.x == INVALID_TEX_COORD) {\n    vTexCoord = m(n, o);\n  } else {\n    vTexCoord = aTexCoord;\n  }\n#else\nvTexCoord = m(n, o);\n#endif\n#ifdef HAS_UV_SCALE\nvUVScale = aUVScale / 255.;\n#endif\n#ifdef HAS_UV_OFFSET\nvUVOffset = aUVOffset / 255.;\n#endif\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(n);\n#endif\n}",frag:"#define SHADER_NAME FILL\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_UV_SCALE\nvarying vec2 vUVScale;\n#else\nuniform highp vec2 uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvarying vec2 vUVOffset;\n#else\nuniform vec2 uvOffset;\n#endif\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D polygonPatternFile;\nuniform vec2 atlasSize;\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c() {\n  \n#ifdef HAS_UV_SCALE\nvec2 d = vUVScale;\n#else\nvec2 d = uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvec2 e = vUVOffset;\n#else\nvec2 e = uvOffset;\n#endif\nvec2 f = mod(vTexCoord * d + e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#include <highlight_frag>\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float polygonOpacity;\n#endif\nuniform float layerOpacity;\nuniform float tileExtent;\nvoid main() {\n  \n#ifdef HAS_COLOR\nvec4 j = vColor;\n#else\nvec4 j = polygonFill;\n#endif\n#ifdef HAS_PATTERN\nif(vTexInfo.z * vTexInfo.w > 1.) {\n    vec2 f = c();\n    j = texture2D(polygonPatternFile, f);\n  }\n#endif\n#ifdef HAS_OPACITY\ngl_FragColor = j * vOpacity;\n#else\ngl_FragColor = j * polygonOpacity;\n#endif\ngl_FragColor *= layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat k = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, k);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:r,defines:i,extraCommandProps:e})}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,r={projViewMatrix:n?Uj:t.projViewMatrix,glScale:e&&e.isRenderingTerrainSkin?1:1/t.getGLScale(),viewport:n&&e&&e.viewport,hasSSRGround:e&&e.hasSSRGround};return this.setIncludeUniformValues(r,e),r}Mr(t,e,n,r,i,o){let s,a;const l=this.getMap();return e&&(s=_H(l,e,i,o)),n&&(a=_H(l,n,i,o,1)),s=s||a,a=a||s,t[0]=s,t[1]=a,t}}var Jj="#define SHADER_NAME LINE\n#define AA_CLIP_LIMIT 2.0\n#define AA_LINE_WIDTH 16.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\n#ifdef PICKING_MODE\n#include <gl2_vert>\n#endif\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY)\nattribute vec3 aExtrude;\n#else\nattribute vec2 aExtrude;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nattribute float aLinesofar;\nvarying highp float vLinesofar;\n#endif\nuniform float cameraToCenterDistance;\n#if defined(HAS_STROKE_WIDTH)\nattribute float aLineStrokeWidth;\n#else\nuniform float lineStrokeWidth;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\nuniform float tileResolution;\nuniform float resolution;\nuniform float tileRatio;\nuniform float isRenderingTerrain;\n#if defined(HAS_LINE_DX) || defined(HAS_LINE_DY)\nattribute vec2 aLineDxDy;\n#endif\n#ifndef HAS_LINE_DX\nuniform float lineDx;\n#endif\n#ifndef HAS_LINE_DY\nuniform float lineDy;\n#endif\nuniform vec2 canvasSize;\nuniform float layerScale;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef USE_LINE_OFFSET\nattribute vec2 aExtrudeOffset;\n#endif\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#ifndef PICKING_MODE\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_PATTERN\n#if defined(HAS_PATTERN_ANIM) || defined(HAS_PATTERN_GAP)\nattribute vec2 aLinePattern;\n#endif\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#endif\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nattribute vec4 aDasharray;\nvarying vec4 vDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nattribute vec4 aDashColor;\nvarying vec4 vDashColor;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nattribute vec4 aStrokeColor;\nvarying vec4 vStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\n#ifdef HAS_GRADIENT\nattribute float aGradIndex;\nvarying float vGradIndex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvarying vec3 vVertex;\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  float d = mod(abs(aExtrude.x), 2.);\n  float e = mod(abs(aExtrude.y), 2.);\n  vNormal = vec2(d, e * 2. - 1.);\n  vec4 f = vec4(c, 1.);\n  vec4 h = projViewModelMatrix * positionMatrix * f;\n  if(isRenderingTerrain == 1.) {\n    vVertex = (positionMatrix * f).xyz;\n  } else {\n    vVertex = (modelMatrix * positionMatrix * f).xyz;\n  }\n#ifdef HAS_STROKE_WIDTH\nfloat i = aLineStrokeWidth / 2. * layerScale;\n#else\nfloat i = lineStrokeWidth;\n#endif\n#ifdef HAS_LINE_WIDTH\nfloat j = aLineWidth / 2. * layerScale;\n#else\nfloat j = lineWidth * layerScale;\n#endif\nfloat k = j / 2. + i;\n  float l = sign(i) * j / 2.;\n  float m = l + sign(l) * ANTIALIASING;\n  float n = k + sign(k) * ANTIALIASING;\n#ifdef USE_LINE_OFFSET\nvec2 o = lineOffset * (vNormal.y * (aExtrude.xy - aExtrudeOffset) + aExtrudeOffset);\n  vec2 u = (n * aExtrude.xy + o) / EXTRUDE_SCALE;\n#else\nvec2 v = aExtrude.xy / EXTRUDE_SCALE;\n  vec2 u = n * v;\n#endif\nfloat A = tileResolution / resolution;\n  vec4 B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * B;\n  if(isRenderingTerrain == .0) {\n    float C = min(AA_CLIP_LIMIT / canvasSize.x, AA_CLIP_LIMIT / canvasSize.y);\n    float D = distance(gl_Position.xy / gl_Position.w, h.xy / h.w) - C;\n    if(D * j < .0) {\n      float E = -D / C;\n      float F = E * E * E * E * AA_LINE_WIDTH;\n      u += F * v;\n      n += F / 6.;\n      B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n      gl_Position = projViewModelMatrix * positionMatrix * B;\n    }\n  }\n#ifdef HAS_LINE_DX\nfloat G = aLineDxDy[0];\n#else\nfloat G = lineDx;\n#endif\n#ifdef HAS_LINE_DY\nfloat H = aLineDxDy[1];\n#else\nfloat H = lineDy;\n#endif\nfloat I = gl_Position.w;\n  gl_Position.xy += vec2(G, H) * 2. / canvasSize * I;\n#ifndef PICKING_MODE\nvWidth = vec2(n, m);\n  if(isRenderingTerrain == 1.) {\n    vGammaScale = 1.;\n  } else {\n    vGammaScale = I / cameraToCenterDistance;\n  }\n#ifndef ENABLE_TILE_STENCIL\nvPosition = c.xy;\n#ifdef USE_LINE_OFFSET\nvPosition += tileRatio * o / EXTRUDE_SCALE;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT)\n#ifdef HAS_GRADIENT\nvLinesofar = aLinesofar / MAX_LINE_DISTANCE;\n  vGradIndex = aGradIndex;\n#else\nfloat J = aLinesofar - k * aExtrude.z / EXTRUDE_SCALE / A * tileRatio;\n  vLinesofar = J / tileRatio * A;\n#endif\n#endif\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nvColor = aColor;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvDasharray = aDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvDashColor = aDashColor / 255.;\n#endif\n#endif\n#ifdef HAS_PATTERN\nvTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n#ifdef HAS_PATTERN_ANIM\nvLinePatternAnimSpeed = aLinePattern[0] / 127.;\n#endif\n#ifdef HAS_PATTERN_GAP\nvLinePatternGap = aLinePattern[1] / 10.0;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nvStrokeColor = aStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(B);\n#endif\nhighlight_setVarying();\n#else\nfbo_picking_setData(I, true);\n#endif\n}";const Qj=im([]),Kj=[];class $j extends Nj{static getBloomSymbol(){return["lineBloom"]}isUniqueStencilRefPerTile(){return!1}prepareSymbol(t){const e=t.lineColor;Array.isArray(e)&&(3===e.length&&e.push(1),t.lineColor=e.map((t=>255*t)));const n=t.lineStrokeColor;Array.isArray(n)&&(3===n.length&&n.push(1),t.lineStrokeColor=n.map((t=>255*t)));const r=t.lineDashColor;Array.isArray(r)&&(3===r.length&&r.push(1),t.lineDashColor=r.map((t=>255*t)))}isAnimating(){if(this.Sr)return!0;const t=this.getSymbols(),e=this.sceneConfig.trailAnimation;if(e&&e.enable)return!0;for(let n=0;n<t.length;n++)if(t[n].linePatternFile&&t[n].linePatternAnimSpeed)return!0;return!1}needToRedraw(){return!!super.needToRedraw()||!!this.isAnimating()}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[$j.getBloomSymbol()[0]]}needPolygonOffset(){return!0}createMesh(t,e){if(!t.geometry)return null;const{geometry:n,symbolIndex:r,ref:i}=t,o=this.getSymbolDef(r);void 0===i&&tj(n,o,this.getFnTypeConfig(r),this.layer);const s=this.getSymbol(r),a={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent};this.setLineUniforms(s,a),uH(a,"lineColor",s,"lineColor","#fff",dH(this.colorCache)),uH(a,"linePatterGapColor",s,"linePatterGapColor",[0,0,0,0],dH(this.colorCache)),uH(a,"lineStrokeColor",s,"lineStrokeColor",[0,0,0,0],dH(this.colorCache)),uH(a,"lineDasharray",s,"lineDasharray",[0,0,0,0],(t=>{let e;if(t&&t.length){const n=t;1===t.length?e=[n[0],n[0],n[0],n[0]]:2===t.length?e=[n[0],n[1],n[0],n[1]]:3===t.length?e=[n[0],n[1],n[2],n[2]]:4===t.length?e=t:t.length>4&&(e=t.slice(0,4))}return e||[0,0,0,0]})),uH(a,"lineDashColor",s,"lineDashColor",[0,0,0,0],dH(this.colorCache));const l=n.properties.iconAtlas,h=this.layer instanceof d;l&&(a.linePatternFile=zj(this.regl,l,!1,!1),a.atlasSize=l?[l.width,l.height]:[0,0],a.flipY=h?-1:1,this.drawDebugAtlas(l)),void 0===i&&n.generateBuffers(this.regl);const u=new Kx(a),c=new h_(n,u,{castShadow:!1,picking:!0});c.setLocalTransform(e),c.positionMatrix=this.getAltitudeOffsetMatrix();const f={};return l&&(f.HAS_PATTERN=1),c.properties.symbolIndex=r,this.kr(c,f),n.data.aColor&&(f.HAS_COLOR=1),n.data.aStrokeColor&&(f.HAS_STROKE_COLOR=1),this.setMeshDefines(f,n,o),n.data.aAltitude&&(f.HAS_ALTITUDE=1),c.setDefines(f),c}addMesh(...t){delete this.Sr;const e=t[0];Array.isArray(e)?e.forEach((t=>{this.Pr(t)})):this.Pr(e),super.addMesh(...t)}Pr(t){if(!t.geometry.aLineWidth&&t.material.get("lineWidth")<=0||!t.geometry.aOpacity&&t.material.get("lineOpacity")<=0)return;const e=t.defines;this.kr(t,e),t.setDefines(e),t.geometry.properties.hasPatternAnim&&(this.Sr=1)}kr(t,e){const n=t.geometry,r=this.getSymbol(t.properties.symbolIndex);n.data.aDasharray||Array.isArray(r.lineDasharray)&&r.lineDasharray.reduce(((t,e)=>t+e),0)>0?(e.HAS_DASHARRAY=1,n.data.aDasharray&&(e.HAS_DASHARRAY_ATTR=1),n.data.aDashColor&&(e.HAS_DASHARRAY_COLOR=1)):e.HAS_DASHARRAY&&delete e.HAS_DASHARRAY}setLineUniforms(t,e){uH(e,"lineWidth",t,"lineWidth",2),uH(e,"lineOpacity",t,"lineOpacity",1),uH(e,"lineStrokeWidth",t,"lineStrokeWidth",0),uH(e,"lineBlur",t,"lineBlur",.7),uH(e,"lineOffset",t,"lineOffset",0),uH(e,"lineDx",t,"lineDx",0),uH(e,"lineDy",t,"lineDy",0),uH(e,"linePatternAnimSpeed",t,"linePatternAnimSpeed",0),uH(e,"linePatternGap",t,"linePatternGap",0)}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),e.data.aLineStrokeWidth&&(t.HAS_STROKE_WIDTH=1),cj(n.lineDx)&&(t.HAS_LINE_DX=1),cj(n.lineDy)&&(t.HAS_LINE_DY=1),cj(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),cj(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}createFnTypeConfig(t,e){const n=oO(e.lineColor),r=oO(e.aLinePatternAnimSpeed),i=oO(e.aLinePatternGap),o=this.createShapeFnTypeConfigs(t,e),s=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||JO(i).unitArray()),i=fH(i),i}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,o)=>{let a=r(t.getZoom(),e);return lH(a)&&(a=0),0!==a&&(n.properties.hasPatternAnim=1),s[0]=a/127,s[1]=i[o+1],s}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,r,o)=>{let a=i(t.getZoom(),e);return lH(a)&&(a=0),s[1]=10*a,s[0]=r[o],s}}].concat(o)}createShapeFnTypeConfigs(t,e){const n=iO(e.lineWidth),r=iO(e.lineOpacity),i=iO(e.lineStrokeWidth),o=iO(e.lineDx),s=iO(e.lineDy),a=new Uint16Array(1),l=new Int8Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e)),a[0]=Math.round(2*i),a[0]}},{attrName:"aLineStrokeWidth",symbolName:"lineStrokeWidth",type:Uint8Array,width:1,define:"HAS_STROKE_WIDTH",evaluate:e=>{const n=i(t.getZoom(),e);return a[0]=Math.round(2*n),a[0]}},{attrName:"aLineDxDy",symbolName:"lineDx",type:Int8Array,width:2,define:"HAS_LINE_DX",evaluate:e=>{const n=o(t.getZoom(),e);return l[0]=n,l[0]}},{attrName:"aLineDxDy",symbolName:"lineDy",type:Int8Array,width:2,define:"HAS_LINE_DY",evaluate:e=>{const n=s(t.getZoom(),e);return l[0]=n,l[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=r(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),a[0]=255*i,a[0]}}]}updateSceneConfig(t){t.trailAnimation&&this.createShader(this.Tr)}init(t){const e=this.regl;this.renderer=new f_(e),this.createShader(t),this.pickingFBO&&(this.picking=[new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+Jj,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())])}createShader(t){this.Tr=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const r=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(r,e.projViewMatrix,e.modelMatrix),r}}),this.shader=new U_({vert:Jj,frag:"#define SHADER_NAME LINE\n#define DEVICE_PIXEL_RATIO 1.0\nprecision highp float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform lowp float blendSrcIsOne;\nuniform lowp float lineBlur;\nuniform float isRenderingTerrain;\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform lowp vec4 lineColor;\n#endif\n#include <highlight_frag>\n#ifdef HAS_STROKE_COLOR\nvarying vec4 vStrokeColor;\n#else\nuniform lowp vec4 lineStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatterGapColor;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d) {\n  vec2 e = mod(d, 1.);\n  vec2 f = vTexInfo.xy;\n  vec2 h = vTexInfo.zw;\n  return (f + e * h) / atlasSize;\n}\n#endif\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\nuniform float tileExtent;\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvarying vec4 vDasharray;\n#else\nuniform vec4 lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvarying vec4 vDashColor;\n#else\nuniform vec4 lineDashColor;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nvarying highp float vLinesofar;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\n#endif\n#if defined(HAS_TRAIL) || defined(HAS_PATTERN)\nuniform float currentTime;\n#endif\nfloat i(float j, float k) {\n  float l = k / 2.;\n  float m = abs(j - l);\n  float n = (.1 + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  return clamp(min(m + n, l - m) / n, .0, 1.);\n}\nvarying vec3 vVertex;\nuniform vec3 cameraPosition;\nuniform float cameraToCenterDistance;\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat o = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(o == .0) {\n    discard;\n  }\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nfloat u = vLinesofar;\n#endif\nfloat v = length(vNormal) * vWidth.s;\n#ifdef HAS_PATTERN\nvec2 h = vTexInfo.zw;\n  float A = sign(h.x * h.y);\n  float B = mix(lineBlur, .0, A);\n#else\nfloat B = lineBlur;\n#endif\nfloat n = (B + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float C = clamp(min(v - (vWidth.t - n), vWidth.s - v) / n, .0, 1.);\n#ifdef HAS_COLOR\nvec4 D = vColor / 255.;\n#else\nvec4 D = lineColor;\n#endif\n#ifdef HAS_PATTERN\nif(A == 1.) {\n    \n#ifdef HAS_PATTERN_GAP\nfloat E = vLinePatternGap;\n#else\nfloat E = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat F = vLinePatternAnimSpeed;\n#else\nfloat F = linePatternAnimSpeed;\n#endif\nfloat G = h.x * vWidth.s * 2. / h.y;\n    float H = G * (1. + E);\n    u += mod(currentTime * -F * .2, H);\n    float I = mod(u / H, 1.);\n    float J = mod((flipY * vNormal.y + 1.) / 2., 1.);\n    vec4 K = texture2D(linePatternFile, c(vec2(I * (1. + E), J)));\n    float L = clamp(sign(1. / (1. + E) - I) + .000001, .0, 1.);\n    K = mix(linePatterGapColor, K, L);\n    D *= K;\n  }\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvec4 M = vDasharray;\n#else\nvec4 M = lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvec4 N = vDashColor;\n#else\nvec4 N = lineDashColor;\n#endif\nfloat k = M[0] + M[1] + M[2] + M[3];\n  float j = mod(u, k);\n  float O = max(sign(M[0] - j), .0);\n  float P = j - M[0] - M[1];\n  float Q = max(sign(P), .0) * max(sign(M[2] - P), .0);\n  float R = O + Q;\n  float S = i(j, M[0]);\n  float T = i(P, M[2]);\n  float U = S * O + T * Q;\n  D = D * (1. - U) + N * U;\n#endif\n#ifdef HAS_STROKE_COLOR\nvec4 V = vStrokeColor / 255.;\n#else\nvec4 V = lineStrokeColor;\n#endif\nV = mix(D, V, sign(vWidth.t));\n  D = V * C + max(sign(vWidth.t - v), .0) * D * (1. - C);\n#ifdef HAS_TRAIL\nfloat W = mod(u - currentTime * trailSpeed * .1, trailCircle);\n  float X = W < trailLength ? mix(.0, 1., W / trailLength) : .0;\n  D *= X;\n#endif\n#ifdef HAS_OPACITY\nfloat Y = vOpacity;\n#else\nfloat Y = lineOpacity;\n#endif\ngl_FragColor = D * Y * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat Z = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, Z);\n#endif\nfloat ba;\n  if(isRenderingTerrain == 1.) {\n    ba = 1.;\n  } else {\n    ba = clamp(cameraToCenterDistance * 1.5 / distance(vVertex, cameraPosition), .0, 1.);\n  }\n  gl_FragColor *= ba;\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps(t)})}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}getExtraCommandProps(t){const e=this.canvas;return{viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:()=>this.isEnableTileStencil(t),mask:255,func:{cmp:()=>"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!1,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,r=this.layer.getTileSize().width,i=n?Qj:t.projViewMatrix,o=t.viewMatrix,s=t.cameraToCenterDistance,a=t.getResolution(),l=Ly(Kj,t.width,t.height);n&&Ly(l,r,r);const h=this.getBlendFunc().src(),u=this.sceneConfig.trailAnimation||{},c={layerScale:this.layer.options.styleScale||1,projViewMatrix:i,viewMatrix:o,cameraToCenterDistance:s,resolution:a,canvasSize:l,trailSpeed:u.speed||1,trailLength:u.trailLength||500,trailCircle:u.trailCircle||1e3,currentTime:this.layer.getRenderer().getFrameTimestamp()||0,blendSrcIsOne:+!(1!==h&&"one"!==h),cameraPosition:t.cameraPosition,viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n};return this.setIncludeUniformValues(c,e),c}}class tU extends $j{postCreateGeometry(t){const{symbolIndex:e,geometry:n}=t,{features:r}=n.properties,i=this.getSymbol(e).lineGradientProperty,o=n.data.aPickingId,s=new Uint8Array(o.length),a=[],l=new Map;function h(t){let e=t&&t[i];Array.isArray(e)||(e=[0,"black",1,"black"]);let n,r=e.join();return l.has(r)?n=l.get(r):(n=a.length,l.set(r,n),a.push(e)),n}let u=o[0],c=r[u].feature.properties,f=h(c);for(let d=1;d<o.length;d++)o[d]!==u&&(u=o[d],c=r[u].feature.properties,f=h(c)),s[d]=f;n.data.aGradIndex=s,n.properties.gradients=a}createMesh(t,e){const{geometry:n,symbolIndex:r,ref:i}=t,o=this.getSymbolDef(r);void 0===i&&tj(n,o,this.getFnTypeConfig(r),this.layer);const s={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent},a=this.getSymbol(r);this.setLineUniforms(a,s);const l=n.properties.gradients,h=2*l.length,u=this.regl.texture({width:256,height:h,data:eU(l),format:"rgba",mag:"linear",min:"linear",flipY:!1});s.lineGradientTexture=u,s.lineGradientTextureHeight=u.height,void 0===i&&n.generateBuffers(this.regl);const c=new Kx(s),f=new h_(n,c,{castShadow:!1,picking:!0});f.setLocalTransform(e);const d={HAS_GRADIENT:1};return n.data.aAltitude&&(d.HAS_ALTITUDE=1),this.setMeshDefines(d,n,o),f.setDefines(d),f.properties.symbolIndex=r,f}createFnTypeConfig(t,e){return this.createShapeFnTypeConfigs(t,e)}createShader(t){this.Tr=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const r=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(r,e.projViewMatrix,e.modelMatrix),r}}),this.shader=new U_({vert:Jj,frag:"#define SHADER_NAME LINE_GRADIENT\n#define DEVICE_PIXEL_RATIO 1.0\n#define MAX_LINE_COUNT 128.0\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\nuniform lowp float lineBlur;\nuniform float lineGradientTextureHeight;\nuniform float tileExtent;\nuniform sampler2D lineGradientTexture;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\nvarying highp float vLinesofar;\nvarying float vGradIndex;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\nuniform float currentTime;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat c = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(c == .0) {\n    discard;\n  }\n#endif\nfloat d = length(vNormal) * vWidth.s;\n  float e = (lineBlur + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float f = clamp(min(d - (vWidth.t - e), vWidth.s - d) / e, .0, 1.);\n  float h = vLinesofar;\n  vec4 i = texture2D(lineGradientTexture, vec2(h, (vGradIndex * 2. + .5) / lineGradientTextureHeight)) * f;\n  i *= max(sign(MAX_LINE_COUNT - vGradIndex), .0);\n#ifdef HAS_TRAIL\nfloat j = mod(h - currentTime * trailSpeed * .1, trailCircle);\n  float k = j < trailLength ? mix(.0, 1., j / trailLength) : .0;\n  i *= k;\n#endif\n#ifdef HAS_OPACITY\nfloat l = vOpacity;\n#else\nfloat l = lineOpacity;\n#endif\ngl_FragColor = i * l * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat m = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, m);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps()})}}function eU(t){t.length>2048&&console.warn(`Gradients count is (${t.length}), it may be slow to render.`);const e=document.createElement("canvas"),n=e.getContext("2d");e.width=256,e.height=2*t.length;for(let r=0;r<t.length;r++){const e=t[r],i=n.createLinearGradient(0,0,256,0);for(let t=0;t<e.length;t+=2)i.addColorStop(+e[t],e[t+1]);n.fillStyle=i;const o=r%256;n.fillRect(0,2*o,256,2*o+2)}return n.canvas}class nU{constructor(t){this.be=t||[],this.properties={}}set meshes(t){this.be=t}get meshes(){return this.be}}const rU=224,iU=100,oU=new Uint8Array(1),sU=[],aU={collides:0,boxes:[]},lU=[],hU=[];class uU extends Nj{createGeometry(...t){const e=super.createGeometry(...t);if(!e||!e.geometry)return e;const{geometry:n}=e,r=t[0];n.properties.collideIds=r.featureIds&&r.featureIds.length&&r.isIdUnique?r.featureIds:r.data.aPickingId;const i=this.layer instanceof d;return n.properties.uniqueCollideIds=vH(n.properties.collideIds,!i),e}supportRenderMode(t){const e=this.sceneConfig.renderToPointRenderTarget;return e||void 0===e?"point"===t:"fxaa"===t||"fxaaAfterTaa"===t}addMesh(t,e,n){if(t&&!this.isEnableCollision()){let e=t;Array.isArray(e)||(lU[0]=t,e=lU);for(let t=0;t<e.length;t++){const n=e[t].defines;delete n.ENABLE_COLLISION,e[t].setDefines(n);const{elements:r,visElemts:i}=e[t].geometry.properties;i&&void 0!==i.count&&i.count!==r.length&&(e[t].geometry.setElements(r),i.count=r.length)}}return super.addMesh(t,e,n)}startMeshCollision(t){const{meshKey:e}=t.properties,{renderer:n}=this.Ir,r=n.isForeground(t instanceof nU?t.meshes[0]:t);if(t.properties.isForeground=r,t instanceof nU&&t.meshes.length)for(let i=0;i<t.meshes.length;i++)t.meshes[i].properties.isForeground=r;this.Fr=performance.now(),this.Cr=this.Or(),this.Er=this.Dr(e)}endMeshCollision(t){const e=this.Lr.tags[t];if(this.Cr&&e&&this.Er){const t=this.getMap();this.Rr||(this.Rr=new n(0,0),this.Hr=new n(0,0)),e.anchor0=t.containerPointToCoord(this.zr,this.Rr),e.anchor1=t.containerPointToCoord(this.Nr,this.Hr),e.anchor0.z=t.getZoom(),e.anchor0.width=t.width,e.anchor0.height=t.height,e.anchor0.pitch=t.getPitch()}this.getMap().collisionFrameTime+=performance.now()-this.Fr}Dr(t){const e=this.getMap(),n=e.getZoom(),r=e.getPitch(),[i,o]=this.Vr(t);return!i||!o||i.z!==n||i.width!==e.width||i.height!==e.height||i.pitch!==r||i.distanceTo(this.zr)>3||o.distanceTo(this.Nr)>3}Ur(){const t=this.getMap();this.jr={},this.zr=new i(t.width/3,t.height/2),this.Nr=new i(2*t.width/3,t.height/2),delete this.Cr,this.Lr||(this.Lr={tags:{}}),this.Ir={layer:this.layer,renderer:this.layer.getRenderer(),frameTimestamp:this.layer.getRenderer().getFrameTimestamp(),map:this.getMap(),zoom:t.getZoom(),collisionTags:this.Lr.tags,isEnableUniquePlacement:this.isEnableUniquePlacement()}}Gr(){}Br(t,e){const n=this.Lr;return n.tags[t]&&n.tags[t][e]}$r(t,e,n){const r=this.Lr;r.tags[t]=r.tags[t]||[],r.tags[t][e]=n}Or(){const t=this.getMap();if(!t.isInteracting())return!0;const e=this.layer.options.collisionFrameLimit;return t.collisionFrameTime<=e}Vr(t){const e="__meshAnchorKey".trim(),n=this.Lr.tags[t];if(n&&n.anchor0){const{anchor0:t,anchor1:r}=n,i=t[e]=t[e]||t.x+","+t.y,o=r[e]=r[e]||r.x+","+r.y;let s=this.jr[i],a=this.jr[o];if(!s||!a){const e=this.getMap();s=this.jr[i]=e.coordToContainerPoint(t),a=this.jr[o]=e.coordToContainerPoint(r)}return s.z=t.z,sU[0]=s,sU[1]=a,s.width=t.width,s.height=t.height,sU}return sU[0]=sU[1]=null,sU}updateBoxCollisionFading(t,e,n,r,i){const{layer:o,renderer:s,zoom:a,collisionTags:l,isEnableUniquePlacement:h}=this.Ir,{meshKey:u,isForeground:c}=e.properties;if(h&&this.Wr(u,i))return!1;const f=n.length;let d=l[u]&&l[u][i];const p=d,g=this.Xr&&d;if((!g||0===d.collides)&&t){const t=g&&0===d.collides;if(this.Cr||t)if((this.Er||d&&d.z!==a)&&(d=null),d){if(d.boxes&&d.boxes.length){const{boxes:t,isAllowOverlap:e}=d;let n=0;if(!e){let e=0;for(let r=0;r<t.length;r++)if(!n){const i=this.isCollides(t[r]);if(-1===i)e++;else if(1===i){n=1;break}}e===t.length&&(n=-1)}d.collides=n}}else{d=p||{collides:0,boxes:[]},d.boxes.length=0,d.z=a;let t=0;for(let e=0;e<f;e++){const{mesh:o,allElements:s,boxCount:a,start:l,end:h}=n[e],u=this.Yr(o,s,a,l,h,r,i);u.isAllowOverlap&&(d.isAllowOverlap=1),0===t&&(t=u.collides),u.boxes&&d.boxes.push(...u.boxes)}d.collides=t,this.$r(u,i,d)}}let m=t&&d&&0===d.collides,A=1,y=!1;if(this.sceneConfig.fading){const t=this.qr(e);if(this.Jr)t[i]=m?1:-1;else if(c&&delete e.Kr,A=this.Zr(c,m,t,i),c?(A>0&&(m=!0),y=this.isBoxFading(e,i),y&&this.setToRedraw()):m||(this.Qr(t,i),A=0),m){const n=e.Kr;if(n&&1===A&&t[i]>0){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;lH(e)&&(e=rU),lH(t)&&(t=iU);const r=sH(1-(s.getFrameTimestamp()-n-t)/e,0,1);A*=r,r>0&&this.setToRedraw()}}}if(d&&o.options.debugCollision&&this.addCollisionDebugBox(d.boxes,d.collides?0:1),m||y){const{mesh:t,start:e}=n[0],r=this.getSymbol(t.properties.symbolIndex);!this.ts(r,t,e)&&d&&d.boxes&&this.es(d.boxes,t)}if(m){const t=oU[0]=255*A;for(let e=0;e<f;e++){const{mesh:r,allElements:i,start:o,end:s,boxIndex:a}=n[e];this.setCollisionOpacity(r,i,t,o,s,a)}}return m&&A>0}isMeshIterable(){return!0}setCollisionOpacity(t,e,n,r,i){const o=e[r],s=e[i-1];this.ns(t,n,o,s)}ns(t,e,n,r){const{aOpacity:i}=t.geometry.properties;if(!i)return;const o=n;if(i[o]!==e){const t=r;for(let n=o;n<=t;n++)i[n]=e;i.dirty=!0}}isBoxFading(t,e){const{frameTimestamp:n}=this.Ir;let r=this.sceneConfig.fadingDuration;return lH(r)&&(r=rU),n-Math.abs(this.qr(t)[e])<r}Yr(t,e,n,r,i,o,s){const a=this.getSymbol(t.properties.symbolIndex),l=this.ts(a,t,e[r]),h=this.rs(a,t,e[r]);if(!this.isEnableCollision()||l&&h)return aU;const u=this.isBoxCollides(t,e,n,r,i,o,s);return h&&(u.collides=0,u.isAllowOverlap=1),u}ts(t,e,n){if(!this.isEnableCollision())return!0;const r=e.geometry.properties.aOverlap;if(!r)return 1==+t[this.propIgnorePlacement];const i=r[n],o=i%8;return i<2?1==+t[this.propIgnorePlacement]:o%2}rs(t,e,n){if(!this.isEnableCollision())return!0;const r=e.geometry.properties.aOverlap;if(!r)return 1==+t[this.propAllowOverlap];const i=r[n],o=i>>2;return i<2?1==+t[this.propAllowOverlap]:o%2}es(t){if(Array.isArray(t[0]))for(let e=0;e<t.length;e++)this.insertCollisionBox(t[e]);else this.insertCollisionBox(t)}Zr(t,e,n,r){let{fadingDuration:i,fadeInDelay:o,fadeOutDelay:s}=this.sceneConfig;lH(i)&&(i=rU),lH(o)&&(o=600),lH(s)&&(s=iU);const{frameTimestamp:a}=this.Ir;let l=n[r],h=e?1:0;if(!l)return e&&t&&(n[r]=a+o),0;if(a<Math.abs(l)&&(!e&&l>0||e&&l<0)){const t=a-i;n[r]=l=e?t:-t}return a-Math.abs(l)<i?h=l>0?(a-l)/i:1-(a+l)/i:e?(l<0&&(n[r]=l=a+o),h=(a-l)/i):(l>0&&(n[r]=l=-(a+s)),h=1-(a+l)/i),(h<0||h>1)&&(h=sH(h,0,1)),h}qr(t){this.ss||(this.ss={});const{meshKey:e}=t.properties;if(!this.ss[e]){const{frameTimestamp:t}=this.Ir;this.ss[e]={timestamp:t}}return this.ss[e]}os(t){if(!this.ls)return void(this.ls=t);const e=this.scene.getMeshes();if(e&&e.length){for(let n=0;n<e.length;n++){const r=this.qr(e[n]);r.timestamp<this.ls?delete e[n]._fading_timestamps:r.timestamp=t}this.ls=t}}Qr(t,e){if(!t)return;const{frameTimestamp:n}=this.Ir;let{fadingDuration:r}=this.sceneConfig;lH(r)&&(r=rU),t[e]=-(n-r-1)}deleteMesh(t,e){if(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].properties.meshKey;this.Lr&&delete this.Lr.tags[n],this.ss&&delete this.ss[n]}else{const e=t.properties.meshKey;this.Lr&&delete this.Lr.tags[e],this.ss&&delete this.ss[e]}super.deleteMesh(t,e)}}delete(t){this.hs&&(this.hs.geometry.dispose(),this.us.dispose(),this.hs.dispose(),delete this.hs,delete this.us,delete this.cs),delete this.Lr,super.delete(t)}isCollides(t){const e=this.layer,n=e.getMap(),r=n.getDevicePixelRatio();if(mA(hU,t,1/r),n.isOffscreen(hU))return-1;const i=e.getCollisionIndex(),o=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;return o&&(t=pU(hU,t,o)),+i.collides(t)}insertCollisionBox(t){const e=this.layer,n=e.getCollisionIndex(),r=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;let i=t;r&&(i=t.fs=t.fs||[],t=pU(i,t,r)),n.insertBox(i)}addCollisionDebugBox(t,e){if(t&&t.length)if(Array.isArray(t[0]))for(let n=0;n<t.length;n++){const r=t[n];this.ds(r,e)}else this.ds(t,e)}ds(t,e){if(!t)return;const n=this.ps=this.ps||{aPosition:[],aVisible:[],indices:[]},r=this.sceneConfig.collisionBufferSize||this.layer.options.collisionBufferSize||0;r&&(t=pU(hU,t,r));const i=this.getMap(),o=i.getDevicePixelRatio();if(mA(hU,t,1/o),i.isOffscreen(hU))return;const s=n.aPosition.length/2;n.aPosition.push(t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]),n.aVisible.push(e,e,e,e),n.indices.push(s,s+1,s+1,s+2,s+2,s+3,s+3,s)}updateCollision(t){super.updateCollision(t),this.Ur(),this.ys(),this.gs&&this.gs.length&&(this.vs(),this.gs&&(this.setToRedraw(),this.scene.addMesh(this.gs))),(this.getMap().isZooming()||this.gs&&this.gs.length)&&(this.xs(),this.bs(this.scene.getMeshes()))}paint(t){const e=super.paint(t);return this.ws(t),!1===this.Cr&&this.setToRedraw(),e}shouldIgnoreBackground(){return!this.getMap().isZooming()&&!this.gs}ys(){const t=this.getMap(),e=t.isZooming();if(!e&&this.Xr){const t=this.layer.getRenderer();this.gs=this.scene.getMeshes().filter((e=>!t.isForeground(e)&&!e.properties.isLinePlacement))}else e&&!this.Xr&&(this.As=t.getResolution());if(e)this.Ms&&(clearTimeout(this.Ms),delete this.Jr,delete this.Ms),this.Jr=this.As&&t.getResolution()>this.As;else if(this.Xr&&!this.Ms){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;lH(t)&&(t=iU),lH(e)&&(e=rU),this.Ms=setTimeout((()=>{delete this.Jr,delete this.Ms}),t+e+1)}this.Xr=e}ws(t){if(!this.ps||!this.layer.options.debugCollision)return;this.cs||this._s();const{aPosition:e,aVisible:n,indices:r}=this.ps;if(!this.hs){const t=new bx({aPosition:[],aVisible:[]},[],0,{positionSize:2,primitive:"lines"});this.hs=new h_(t),this.Ss=new __,this.Ss.addMesh(this.hs)}const i=this.hs.geometry;i.updateData("aPosition",new Float32Array(e)),i.updateData("aVisible",new Uint8Array(n)),i.setElements(r),this.cs.render(this.us,{size:[this.canvas.width,this.canvas.height]},this.Ss,this.getRenderFBO(t)),delete this.ps}_s(){const t=this.regl;this.cs=new f_(t);const e=this.canvas,n={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1};this.us=new U_({vert:"attribute vec2 aPosition;\nattribute float aVisible;\nuniform vec2 size;\nvarying vec4 vColor;\nvoid main() {\n  vec2 c = (aPosition / size - .5) * 2. * vec2(1., -1.);\n  gl_Position = vec4(c, .0, 1.);\n  vColor = mix(vec4(1., .0, .0, 1.5) * .5, vec4(.0, 1., .0, 1.) * .4, aVisible);\n}",frag:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor.rgb, .5);\n}",uniforms:["size"],extraCommandProps:{viewport:n,depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}})}vs(){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;lH(t)&&(t=iU),lH(e)&&(e=rU);const n=this.layer.getRenderer(),r=n.getCurrentTileZoom(),i=n.getFrameTimestamp(),o=[];for(let s=0;s<this.gs.length;s++){const a=this.gs[s],l=a.properties.tile;!a.Kr&&n.isBackTile(l.id)&&(a.Kr=i);const h=l.z-r>0?2*(l.z-r)-1:2*(r-l.z);a.properties.level=h,n.isForeground(a)||a.Kr&&i-a.Kr>t+e?delete a.Kr:o.push(a)}delete this.gs,o.length&&(this.gs=o)}isEnableCollision(){return this.layer.options.collision&&!!this.sceneConfig.collision}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement}isMeshUniquePlaced(t){return this.isMeshIterable(t)}xs(){if(!this.isEnableUniquePlacement())return;const t=this.scene.getMeshes(),e=(t,e,n,r)=>{const{start:i,end:o}=e[0],s=t.geometry.properties,a=s.elements;let l=s.uniquePlacements;if(l||(l=s.uniquePlacements=[]),void 0===l[r]){const e=this.getUniqueEntryKey(t,a[i],r);l[r]=e?{key:e,index:r,start:a[i],end:a[o-1]}:null}};for(let n=0;n<t.length;n++){const r=t[n];this.isMeshUniquePlaced(r)&&this.forEachBox(r,e)}}bs(t){if(!this.isEnableUniquePlacement())return;const e=this.getMap().getZoom();let n=!this.ks||this.Ps!==e;if(!n)for(let o=0;o<t.length;o++)if(!this.ks[t[o].properties.meshKey]){n=!0;break}if(!n)return;this.Ps=e,this.Ts={},this.ks={},t=t.sort(dU);const r=this.getMap().getGLScale(),i={};for(let o=0;o<t.length;o++){const e=t[o];if(!e.geometry)continue;const{meshKey:n}=e.properties;this.ks[n]=1;const{uniquePlacements:s}=e.geometry.properties;if(s)for(let t=0;t<s.length;t++){if(!s[t])continue;const{key:n,index:o}=s[t],a=this.qr(e),l=fU(n,r),h=i[l];if(h){const t=h.length,n=h[t-3].properties.meshKey,r=h[t-2],i=h[t-1];this.Ts[n]=this.Ts[n]||{},this.Ts[n][i]=1,this.Is(a,o,r,i),h.push(e,a,o)}else i[l]=[e,a,o]}}for(const o in i){const t=i[o];if(t.length<=6)continue;const e=t.length,n=t[e-2][t[e-1]];if(t[1][t[2]]!==n)for(let r=0;r<e-6;r+=3)t[r+1][t[r+2]]=n}}Is(t,e,n,r){if(void 0!==n[r])if(void 0===t[e])t[e]=n[r];else{let i=t[e];Math.abs(n[r])>Math.abs(i)?t[e]=n[r]:n[r]=t[e]}else void 0!==t[e]&&(n[r]=t[e])}Wr(t,e){return this.Ts&&this.Ts[t]&&this.Ts[t][e]}Fs(t,e){const{symbolIndex:n}=t.properties,r=n.type||0;let i=t.properties._collidesBoxes;i||(i=t.properties._collidesBoxes=[]);let o=i[n.index];o||(o=t.properties._collidesBoxes=[]),o[r]||(o[r]=[]),o=o[r];const s=e/6;if(!o[s]){const t=[];o[s]={boxes:t,collision:{boxes:t}}}return o[s]}Cs(t){let e=this.Os;if(e||(e=this.Os=[]),!e[t]){e[t]=[];for(let n=0;n<t;n++)e[t][n]={}}return e[t]}Es(t){return!t||!t.geometry||!(!t.geometry.properties.glyphAtlas||!t.material.get("isHalo")||t.geometry.data.aTextHaloRadius&&t.geometry.properties.hasHalo)&&(!(!t.geometry.data.aTextHaloRadius||t.geometry.properties.hasHalo)||!this.getSymbol(t.geometry.properties.symbolIndex).textHaloRadius)}}const cU=10;function fU(t,e){return Math.round(t[0]/e/cU)*Math.round(t[1]/e/cU)*(t[2]?Math.round(t[2]/cU):1)+"-"+t[3]}function dU(t,e){const n=e.properties.level-t.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}function pU(t,e,n){return t[0]=e[0]-n,t[1]=e[1]-n,t[2]=e[2]+n,t[3]=e[3]+n,t}var gU="#include <gl2_vert>\n#define SHADER_NAME MARKER\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aShape;\nattribute vec2 aTexCoord;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_MARKER_WIDTH\nattribute float aMarkerWidth;\n#else\nuniform float markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nattribute float aMarkerHeight;\n#else\nuniform float markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nattribute float aMarkerDx;\n#else\nuniform float markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nattribute float aMarkerDy;\n#else\nuniform float markerDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float rotateWithMap;\n#endif\nuniform float flipY;\n#ifdef HAS_ROTATION\nattribute float aRotation;\n#else\nuniform float markerRotation;\n#endif\n#ifdef HAS_PAD_OFFSET\nattribute float aPadOffsetX;\nattribute float aPadOffsetY;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerPerspectiveRatio;\nuniform vec2 iconSize;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#include <vt_position_vert>\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vOpacity;\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_MARKER_WIDTH\nfloat d = aMarkerWidth;\n#else\nfloat d = markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nfloat e = aMarkerHeight;\n#else\nfloat e = markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nfloat f = aMarkerDx;\n#else\nfloat f = markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nfloat h = aMarkerDy;\n#else\nfloat h = markerDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat i = aPitchAlign;\n#else\nfloat i = pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat j = aRotationAlign;\n#else\nfloat j = rotateWithMap;\n#endif\ngl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float k = gl_Position.w;\n  float l;\n  if(isRenderingTerrain == 1. && i == 1.) {\n    l = 1.;\n  } else {\n    float m = (1. - cameraToCenterDistance / k) * markerPerspectiveRatio;\n    l = clamp(.5 + .5 * (1. - m), .0, 4.);\n  }\n#ifdef HAS_ROTATION\nfloat n = -aRotation / 9362. - mapRotation * j;\n#else\nfloat n = -markerRotation - mapRotation * j;\n#endif\nif(i == 1.) {\n    n += mapRotation;\n  }\n  float o = sin(n);\n  float u = cos(n);\n  mat2 v = mat2(u, -1. * o, o, u);\n  vec2 A = (aShape / 10.0);\n  if(i == 1. && flipY == .0) {\n    A *= vec2(1., -1.);\n  }\n#ifdef HAS_PAD_OFFSET\nA = (A / iconSize * vec2(d, e) + vec2(aPadOffsetX - 1., aPadOffsetY)) * layerScale;\n#else\nA = A / iconSize * vec2(d, e) * layerScale;\n#endif\nA = v * A;\n  if(i == .0) {\n    vec2 B = A * 2. / canvasSize;\n    gl_Position.xy += B * l * k;\n  } else {\n    float C;\n    if(isRenderingTerrain == 1.) {\n      C = 1.;\n    } else {\n      C = k / cameraToCenterDistance;\n    }\n    vec2 B = A;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(B, .0) * tileRatio / zoomScale * C * l, 1.);\n  }\n  gl_Position.xy += vec2(f, -h) * 2. / canvasSize * k;\n#ifndef PICKING_MODE\nvTexCoord = aTexCoord / texSize;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool D = aOpacity == 255.;\n#else\nbool D = true;\n#endif\nfbo_picking_setData(gl_Position.w, D);\n#endif\n}";const mU=[],AU=[],yU=[],vU=[],xU=[],_U=[];function bU(t,e,n,r,i,o,s,a,l,h,u,c,f,d){const{tileRatio:p,tileResolution:g}=l,m=p/(g/h.getResolution())*(u/h.cameraToCenterDistance)*c;By(n,n,m),By(r,r,m),By(i,i,m),By(o,o,m),Lm(mU,n[0],n[1],f?n[2]/d:0),Lm(AU,r[0],r[1],f?r[2]/d:0),Lm(yU,i[0],i[1],f?i[2]/d:0),Lm(vU,o[0],o[1],f?o[2]/d:0),Dm(mU,mU,e),Dm(AU,AU,e),Dm(yU,yU,e),Dm(vU,vU,e),dj(n,mU,s,h.width,h.height),dj(r,AU,s,h.width,h.height),dj(i,yU,s,h.width,h.height),dj(o,vU,s,h.width,h.height),Ly(xU,Math.min(n[0],r[0],i[0],o[0]),Math.min(n[1],r[1],i[1],o[1])),Ly(_U,Math.max(n[0],r[0],i[0],o[0]),Math.max(n[1],r[1],i[1],o[1])),cA(t,xU[0]+a[0],xU[1]+a[1],_U[0]+a[0],_U[1]+a[1])}function wU(t,e,n,r,i,o,s,a){1!==a&&(By(n,n,a),By(r,r,a),By(i,i,a),By(o,o,a)),Ly(xU,Math.min(n[0],r[0],i[0],o[0]),Math.min(n[1],r[1],i[1],o[1])),Ly(_U,Math.max(n[0],r[0],i[0],o[0]),Math.max(n[1],r[1],i[1],o[1])),cA(t,e[0]+xU[0]+s[0],e[1]+xU[1]-s[1],e[0]+_U[0]+s[0],e[1]+_U[1]-s[1])}function TU(t,e,n,r,i){e-=n*r,1===i&&(e+=n);const o=Math.sin(e),s=Math.cos(e);return Rg(t,s,-o,o,s)}const MU=2048,CU=24,SU=.01,IU=[],PU=[],EU=[],OU=[],RU=[],kU=[],LU=[],DU=[],NU=[1,-1],FU=[1,1];function zU(t,e,n,r,i){const o=e.material.uniforms,s=i.cameraToCenterDistance,a=e.geometry.properties,l=this.getSymbol(a.symbolIndex),h=e.geometry.desc.positionSize,u=a.aAnchor,c=Lm(IU,u[n*h],u[n*h+1],2===h?0:u[n*h+2]),{aTerrainAltitude:f}=a;if(f){const t=100*f[2*n];t&&(c[2]+=t)}let d=dj(PU,c,r,i.width,i.height);const p=d[2];let g=1;o.markerPerspectiveRatio&&(g=sH(.5+.5*(1-(1-s/p)*o.markerPerspectiveRatio),0,4));const{aShape:m,aMarkerDx:A,aMarkerDy:y,aMarkerWidth:v,aMarkerHeight:x,aPitchAlign:_,aRotationAlign:b,aRotation:w}=a,T=A?A[n]:l.markerDx,M=y?y[n]:l.markerDy,C=_?_[n]:o.pitchWithMap,S=b?b[n]:o.rotateWithMap,I=Ly(DU,T||0,-(M||0));let P=Ly(OU,m[2*n]/10,m[2*n+1]/10),E=Ly(RU,m[2*n+2]/10,m[2*n+3]/10),O=Ly(kU,m[2*n+4]/10,m[2*n+5]/10),R=Ly(LU,m[2*n+6]/10,m[2*n+7]/10);0===o.flipY&&1===C&&(Fy(P,P,NU),Fy(E,E,NU),Fy(O,O,NU),Fy(R,R,NU));const[k,L]=jj(e.geometry);let D=v?v[n]:l.markerWidth;lH(D)&&(D=k||15);let N=x?x[n]:l.markerHeight;lH(N)&&(N=L||15);const F=Ly(FU,D/MU,N/MU);Jy(P,P,F),Jy(E,E,F),Jy(O,O,F),Jy(R,R,F);const z=-(w?w[n]/9362:-(l.markerRotation||0)*Math.PI/180),B=i.getBearing()*Math.PI/180;if(B*S||z){const t=TU(EU,z,B,S,C);P=Wy(P,P,t),E=Wy(E,E,t),O=Wy(O,O,t),R=Wy(R,R,t)}1===C?bU(t,c,P,E,O,R,r,I,o,i,p,g):(Fy(P,P,NU),Fy(E,E,NU),Fy(O,O,NU),Fy(R,R,NU),wU(t,d,P,E,O,R,I,g));const H=this.getMap().getDevicePixelRatio();return 1!==H&&(t[0]*=H,t[1]*=H,t[2]*=H,t[3]*=H),t}const BU=1,HU=[],jU=[],UU=[],VU=[],GU=[],WU=[],qU=[1,-1];function XU(t,e,n,r,i,o,s,a,l){const h=r.material.uniforms,u=l.cameraToCenterDistance,c=r.geometry.properties,f=this.getSymbol(c.symbolIndex),d="line"===f.textPlacement&&!AH(f),p=CU,g=n[2];let m=1;h.textPerspectiveRatio&&(m=sH(.5+.5*(1-(1-u/g)*h.textPerspectiveRatio),0,4));const{aTextDx:A,aTextDy:y,aPitchAlign:v,aRotationAlign:x,aRotation:_}=r.geometry.properties,b=A?A[s]:f.textDx,w=y?y[s]:f.textDy,T=v?v[s]:h.pitchWithMap,M=x?x[s]:h.rotateWithMap,C=Ly(WU,b||0,-(w||0));if(d){const{aOffset:r,aShape:i}=c,o=r.length!==i.length;let u,f,d,p;if(o?(u=Lm(jU,r[3*s]/10,r[3*s+1]/10,r[3*s+2]/10),f=Lm(UU,r[3*s+3]/10,r[3*s+4]/10,r[3*s+5]/10),d=Lm(VU,r[3*s+6]/10,r[3*s+7]/10,r[3*s+8]/10),p=Lm(GU,r[3*s+9]/10,r[3*s+10]/10,r[3*s+11]/10)):(u=Ly(jU,r[2*s]/10,r[2*s+1]/10),f=Ly(UU,r[2*s+2]/10,r[2*s+3]/10),d=Ly(VU,r[2*s+4]/10,r[2*s+5]/10),p=Ly(GU,r[2*s+6]/10,r[2*s+7]/10)),1===T){const n=LB(l.getResolution(),l);bU(t,e,u,f,d,p,a,C,h,l,g,m,o,n)}else Fy(u,u,qU),Fy(f,f,qU),Fy(d,d,qU),Fy(p,p,qU),wU(t,n,u,f,d,p,C,m)}else{const{aShape:r}=c;let o=Ly(jU,r[2*s]/10,-r[2*s+1]/10),u=Ly(UU,r[2*s+2]/10,-r[2*s+3]/10),A=Ly(VU,r[2*s+4]/10,-r[2*s+5]/10),y=Ly(GU,r[2*s+6]/10,-r[2*s+7]/10);0===h.flipY&&1===T&&(Fy(o,o,qU),Fy(u,u,qU),Fy(A,A,qU),Fy(y,y,qU));const v=_?_[s]/9362:(f.textRotation||0)*Math.PI/180,x=d?0:l.getBearing()*Math.PI/180;if(v||x){const t=TU(HU,v,x,M,T);o=Wy(o,o,t),u=Wy(u,u,t),A=Wy(A,A,t),y=Wy(y,y,t)}const b=i/p;By(o,o,b),By(u,u,b),By(A,A,b),By(y,y,b),1===T?bU(t,e,o,u,A,y,a,C,h,l,g,m):wU(t,n,o,u,A,y,C,m)}o=o||0,t[0]-=o+BU,t[1]-=o+BU,t[2]+=o+BU,t[3]+=o+BU;const S=this.getMap().getDevicePixelRatio();return 1!==S&&(t[0]*=S,t[1]*=S,t[2]*=S,t[3]*=S),t}function ZU(t,e,n){const r=e.geometry.desc.positionSize,{aAnchor:i,aAltitude:o,aTerrainAltitude:s}=e.geometry.properties,a=n*r;if(o?Lm(t,i[a],i[a+1],o[n]):3===r?vL(t,i[a],i[a+1],i[a+2]):Lm(t,i[a],i[a+1],0),s){const e=100*s[2*n];e&&(t[2]+=e)}return t}const YU={textFill:[0,0,0,1],textOpacity:1,textPitchAlignment:0,textRotationAlignment:0,textHaloRadius:0,textHaloFill:[1,1,1,1],textHaloBlur:0,textHaloOpacity:1,textPerspectiveRatio:0,textSize:14,textDx:0,textDy:0,textRotation:0};function JU(t,e,n,r,i,o,s,a,l){const h=[];if(e.isDisposed()||0===e.data.aPosition.length)return h;const u=e.properties.glyphAtlas;if(!u)return h;if(0===r.textSize||0===r.textOpacity)return h;if(tj(e,r,o,this.layer),!e.properties.aCount){QU.call(this,e,s||l,a);const{aTextSize:t,aTextDx:n,aTextDy:r,aPitchAlign:i,aRotationAlign:o,aRotation:h,aOverlap:u,aAltitude:c}=e.data;if(t){const n=(KH+"aTextSize").trim();e.properties.aTextSize=e.properties[n]||new t.constructor(t)}if(n){const t=(KH+"aTextDx").trim();e.properties.aTextDx=e.properties[t]||new n.constructor(n)}if(r){const t=(KH+"aTextDy").trim();e.properties.aTextDy=e.properties[t]||new r.constructor(r)}if(i){const t=(KH+"aPitchAlign").trim();e.properties.aPitchAlign=e.properties[t]||new i.constructor(i)}if(o){const t=(KH+"aRotationAlign").trim();e.properties.aRotationAlign=e.properties[t]||new o.constructor(o)}if(h){const t=(KH+"aRotation").trim();e.properties.aRotation=e.properties[t]||new h.constructor(h)}if(u){const t=(KH+"aOverlap").trim();e.properties.aOverlap=e.properties[t]||new u.constructor(u)}if(c){const t=(KH+"aAltitude").trim();e.properties.aAltitude=e.properties[t]||new c.constructor(c)}}const c=zj(t,u,!1),f={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio,texture:c,texSize:[u.width,u.height]};KU(e,f,i);let d=!1;i.textOpacity<1&&(d=!0),e.properties.memorySize=e.getMemorySize(),e.generateBuffers(t,{excludeElementsInVAO:!0});const p=new Kx(f,YU),g=new h_(e,p,{disableVAO:!0,transparent:d,castShadow:!1,picking:!0});if(g.setLocalTransform(n),g.setUniform("alphaTest",SU),f.isHalo&&(g.properties.isHalo=!0),s&&g.setDefines({ENABLE_COLLISION:1}),h.push(g),f.isHalo){const t={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio,texture:c,texSize:[u.width,u.height],isHalo:0};KU(e,t,i);const r=new Kx(t,YU),o=new h_(e,r,{disableVAO:!0,transparent:d,castShadow:!1,picking:!0});o.setUniform("alphaTest",SU),o.properties.haloMesh=g,Object.defineProperty(o.properties,"textSize",{enumerable:!0,get:function(){return t.textSize}}),s&&o.setDefines({ENABLE_COLLISION:1}),o.setLocalTransform(n),h.push(o)}return h.forEach((t=>{const n=t.defines||{};e.data.aTextFill&&(n.HAS_TEXT_FILL=1),e.data.aTextSize&&(n.HAS_TEXT_SIZE=1),e.data.aColorOpacity&&(n.HAS_OPACITY=1),e.data.aTextHaloFill&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_FILL=1),e.data.aTextHaloRadius&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_RADIUS=1),e.data.aTextHaloOpacity&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_OPACITY=1),e.data.aTextDx&&(n.HAS_TEXT_DX=1),e.data.aTextDy&&(n.HAS_TEXT_DY=1),e.data.aPitchAlign&&(n.HAS_PITCH_ALIGN=1),e.data.aRotationAlign&&(n.HAS_ROTATION_ALIGN=1),e.data.aRotation&&(n.HAS_ROTATION=1),e.data.aAltitude&&(n.HAS_ALTITUDE=1),e.properties.aOffset&&e.properties.aShape&&e.properties.aOffset.length!==e.properties.aShape.length&&(n.HAS_OFFSET_Z=1),t.setDefines(n),t.properties.symbolIndex=e.properties.symbolIndex})),h}function QU(t,e,n){const r=this.getSymbol(t.properties.symbolIndex),i="line"===t.properties.textPlacement&&!AH(r),{aPosition:o,aShape:s}=t.data,a=o.length/t.desc.positionSize;if(t.properties.aPickingId=t.data.aPickingId,t.properties.aCount=t.data.aCount,delete t.data.aCount,(e||i)&&(t.properties.aAnchor=o,t.properties.aShape=s),t.properties.visElemts||(t.properties.elements=t.elements,t.properties.visElemts=new t.elements.constructor(t.elements.length)),i){const{aVertical:e,aSegment:n,aGlyphOffset:r,aPitchRotation:i}=t.data,o=!!i;t.properties.aGlyphOffset=r,t.properties.aPitchRotation=i,t.properties.aSegment=n,t.properties.aVertical=e,delete t.data.aSegment,delete t.data.aVertical,delete t.data.aGlyphOffset,delete t.data.aPitchRotation;const a=s.length/2*(o?3:2);t.data.aOffset={usage:"dynamic",data:new Int16Array(a)},t.properties.aOffset=new Int16Array(a)}if(e){t.data.aOpacity={usage:"dynamic",data:new Uint8Array(a)},t.properties.aOpacity=new Uint8Array(a),n&&(t.properties.aOpacity.fill(255,0),t.data.aOpacity.data.fill(255,0));const{aTextHaloRadius:e}=t.data;if(e&&!t.properties.aTextHaloRadius){const n=(KH+"aTextHaloRadius").trim();t.properties.aTextHaloRadius=t.properties[n]||new e.constructor(e)}}}function KU(t,e,n){void 0===e.isHalo&&(e.isHalo=1),uH(e,"textOpacity",n,"textOpacity",YU.textOpacity),uH(e,"textFill",n,"textFill",YU.textFill,dH()),uH(e,"textHaloFill",n,"textHaloFill",YU.textHaloFill,dH()),uH(e,"textHaloBlur",n,"textHaloBlur",YU.textHaloBlur),uH(e,"textHaloRadius",n,"textHaloRadius",YU.textHaloRadius),uH(e,"textHaloOpacity",n,"textHaloOpacity",YU.textHaloOpacity),uH(e,"textPerspectiveRatio",n,"textPerspectiveRatio",YU.textPerspectiveRatio,(e=>"line"===t.properties.textPlacement?1:e)),uH(e,"rotateWithMap",n,"textRotationAlignment",YU.textRotationAlignment,(t=>+("map"===t))),uH(e,"pitchWithMap",n,"textPitchAlignment",YU.textPitchAlignment,(t=>+("map"===t))),uH(e,"textSize",n,"textSize",YU.textSize),uH(e,"textDx",n,"textDx",YU.textDx),uH(e,"textDy",n,"textDy",YU.textDy),uH(e,"textRotation",n,"textRotation",YU.textRotation,(t=>t*Math.PI/180))}function $U(t,e){const n=[];return{uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am(n,e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:(t,e)=>e.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,range:e.depthRange||[0,1],func:e.depthFunc||"always",mask:!1},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}function tV(t,e){const n=iO(e.textFill),r=iO(e.textSize),i=iO(e.textHaloFill),o=iO(e.textHaloRadius),s=iO(e.textHaloOpacity),a=iO(e.textDx),l=iO(e.textDy),h=iO(e.textOpacity),u=oO(e.textPitchAlignment),c=oO(e.textRotationAlignment),f=iO(e.textRotation),d=oO(e.textAllowOverlapFn),p=oO(e.textIgnorePlacement),g={},m=new Int16Array(1),A=new Uint16Array(1);return[{attrName:"aTextFill",symbolName:"textFill",define:"HAS_TEXT_FILL",type:Uint8Array,width:4,evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=g[i]=g[i]||JO(i).unitArray()),i=fH(i),i}},{attrName:"aTextSize",symbolName:"textSize",define:"HAS_TEXT_SIZE",type:Uint8Array,width:1,evaluate:(e,n)=>{let i=r(t.getZoom(),e)||YU.textSize;return nO(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),m[0]=i,m[0]}},{attrName:"aTextHaloFill",symbolName:"textHaloFill",define:"HAS_TEXT_HALO_FILL",type:Uint8Array,width:4,evaluate:e=>{let n=i(t.getZoom(),e);return Array.isArray(n)||(n=g[n]=g[n]||JO(n).unitArray()),n=fH(n),n}},{attrName:"aTextHaloRadius",symbolName:"textHaloRadius",define:"HAS_TEXT_HALO_RADIUS",type:Uint8Array,width:1,evaluate:e=>{const n=o(t.getZoom(),e);return m[0]=n,m[0]}},{attrName:"aTextHaloOpacity",symbolName:"textHaloOpacity",define:"HAS_TEXT_HALO_OPACITY",type:Uint8Array,width:1,evaluate:e=>{const n=s(t.getZoom(),e);return m[0]=n,m[0]}},{attrName:"aTextDx",symbolName:"textDx",define:"HAS_TEXT_DX",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=a(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),m[0]=r,m[0]}},{attrName:"aTextDy",symbolName:"textDy",define:"HAS_TEXT_DY",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=l(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),m[0]=r,m[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",define:"HAS_OPACITY",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=h(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),m[0]=255*r,m[0]}},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===u(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:e=>+("map"===c(t.getZoom(),e))},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:e=>{const n=aH(f(t.getZoom(),e),0,360)*Math.PI/180;return A[0]=9362*n,A[0]}},{attrName:"aOverlap",symbolName:"textAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let r=d(t.getZoom(),n)||0,i=(p?p(t.getZoom(),n):e.textIgnorePlacement)||0;return r=1<<3+4*r,i=(p?2:0)+i,r+i}},{attrName:"aOverlap",symbolName:"textIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let r=(d?d(t.getZoom(),n):e.textAllowOverlap)||0,i=p(t.getZoom(),n)||0;return r=(d?8:0)+4*r,i=1<<1+i,r+i}}]}const eV=[],nV=[],rV=[],iV=[];function oV(t,e,n,r,i,o,s){t=1===t?1:0;const a=this.getMap(),l=e.geometry.properties,h=this.getSymbol(l.symbolIndex),u="line"===l.textPlacement&&!AH(h),{aTextSize:c,aTextHaloRadius:f,aShape:d}=l;let p=c?c[n[i]]:e.properties.textSize;null==p&&(p=YU.textSize);const g=f?f[n[i]]:e.properties.textHaloRadius,m=ZU(rV,e,n[i]),{aProjectedAnchor:A}=e.geometry.properties;let y=iV;const v=3*n[i];A&&A[v]!==YB?(iV[0]=A[v],iV[1]=A[v+1],iV[2]=A[v+2]):y=dj(iV,m,s,a.width,a.height);const x=r,{boxes:_,collision:b}=this.Fs(e,i);let w=0;if(u||1===e.material.uniforms.rotateWithMap||h.textRotation){let r=0;for(let o=i;o<i+6*x;o+=6){const i=_[w]=_[w]||[];w++;const l=XU.call(this,i,m,y,e,p,g,n[o],s,a);if(!t){const e=this.isCollides(l);1===e?t=1:-1===e&&r++}}r===x&&(t=-1)}else{let r=n[i],l=d[2*r+1];for(let h=i;h<o;h+=6){const i=d[2*n[h]+1];if(l!==i||h===o-6){const u=n[h===o-6?h:h-6],c=XU.call(this,eV,m,y,e,p,g,r,s,a),f=XU.call(this,nV,m,y,e,p,g,u,s,a),d=_[w]=_[w]||[];w++,d[0]=Math.min(c[0],f[0]),d[1]=Math.min(c[1],f[1]),d[2]=Math.max(c[2],f[2]),d[3]=Math.max(c[3],f[3]),r=n[h],l=i,!t&&this.isCollides(d)&&(t=1)}}}return b.collides=t,b}function sV(t,e){const n=function(t,e){const{aPickingId:n,features:r}=t.geometry.properties,i=n[e],o=r&&r[i]&&r[i].feature;return o&&o.label}(t,e);return n?function(t,e,n){if(!n)return null;const r=t.localTransform,i=ZU(aV,t,e);cA(lV,i[0],i[1],i[2],1);const o=TA(lV,lV,r);let s=0;for(const a of n)s+=a.codePointAt(0);return[Math.floor(o[0]),Math.floor(o[1]),Math.floor(o[2]),s]}(t,e,n):null}const aV=[],lV=[];var hV="#define SHADER_NAME TEXT_VERT\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aShape;\nattribute vec2 aTexCoord;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float rotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_ROTATION)\nattribute float aRotation;\n#else\nuniform float textRotation;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float glyphSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nattribute float aTextHaloRadius;\nvarying float vTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nattribute float aTextHaloOpacity;\nvarying float vTextHaloOpacity;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aTextDx;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aTextDy;\n#else\nfloat f = textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat h = aPitchAlign;\n#else\nfloat h = pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat i = aRotationAlign;\n#else\nfloat i = rotateWithMap;\n#endif\nvec2 j = aShape / 10.0;\n  if(h == 1. && flipY == .0) {\n    j = j * vec2(1., -1.);\n  }\n  vec2 k = aTexCoord;\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float l = gl_Position.w;\n  float m;\n  if(isRenderingTerrain == 1. && h == 1.) {\n    m = 1.;\n  } else {\n    float n = (1. - cameraToCenterDistance / l) * textPerspectiveRatio;\n    m = clamp(.5 + .5 * (1. - n), .0, 4.);\n  }\n#ifdef HAS_ROTATION\nfloat o = -aRotation / 9362. - mapRotation * i;\n#else\nfloat o = -textRotation - mapRotation * i;\n#endif\nif(h == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\no += mapRotation;\n#else\no -= mapRotation;\n#endif\n  }\n  float u = sin(o);\n  float v = cos(o);\n  mat2 A = mat2(v, -1. * u, u, v);\n  j = A * (j / glyphSize * d);\n  float B;\n  if(isRenderingTerrain == 1.) {\n    B = 1.;\n  } else {\n    B = l / cameraToCenterDistance;\n  }\n  if(h == .0) {\n    vec2 C = j * 2. / canvasSize;\n    gl_Position.xy += C * m * l;\n  } else {\n    float D;\n    if(isRenderingTerrain == 1.) {\n      D = tileRatio / zoomScale;\n    } else {\n      D = tileRatio / zoomScale * B * m;\n    }\n    vec2 C = j;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(C, .0) * D, 1.);\n  }\n  gl_Position.xy += vec2(e, -f) * 2. / canvasSize * l;\n#ifndef PICKING_MODE\nif(h == .0) {\n    vGammaScale = mix(1., B, textPerspectiveRatio);\n  } else {\n    vGammaScale = B + mapPitch / 4.;\n  }\n  vTexCoord = k / texSize;\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvTextHaloRadius = aTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nvTextHaloOpacity = aTextHaloOpacity;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool E = aOpacity == 255.;\n#else\nbool E = true;\n#endif\nfbo_picking_setData(gl_Position.w, E);\n#endif\n}",uV="#define SHADER_NAME TEXT_FRAG\n#define HAS_HIGHLIGHT_COLOR_POINT 1\n#define SDF_PX 8.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define EDGE_GAMMA 0.105 / DEVICE_PIXEL_RATIO\nprecision mediump float;\nuniform sampler2D texture;\nuniform float textOpacity;\nuniform highp float gammaScale;\nuniform int isHalo;\nuniform highp float textHaloBlur;\nuniform float alphaTest;\n#ifdef HAS_TEXT_HALO_OPACITY\nvarying float vTextHaloOpacity;\n#else\nuniform float textHaloOpacity;\n#endif\nuniform float layerOpacity;\nvarying vec2 vTexCoord;\nvarying float vSize;\nvarying float vGammaScale;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nvarying vec4 vTextFill;\n#else\nuniform vec4 textFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvarying vec4 vTextHaloFill;\n#else\nuniform vec4 textHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvarying float vTextHaloRadius;\n#else\nuniform highp float textHaloRadius;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifdef HAS_TEXT_FILL\nvec4 c = vTextFill;\n#else\nvec4 c = textFill;\n#endif\nfloat d = vSize / 24.;\n  lowp vec4 e = c;\n  highp float f = EDGE_GAMMA / (d * gammaScale);\n  lowp float h = 185. / 256.;\n  if(isHalo == 1) {\n    \n#ifdef HAS_TEXT_HALO_FILL\nvec4 i = vTextHaloFill;\n#else\nvec4 i = textHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nfloat j = vTextHaloRadius;\n#else\nfloat j = textHaloRadius;\n#endif\ne = i;\n    f = (textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (d * gammaScale);\n    h = (6. - j / d) / SDF_PX;\n#ifdef HAS_TEXT_HALO_OPACITY\nfloat k = vTextHaloOpacity / 255.;\n#else\nfloat k = textHaloOpacity;\n#endif\ne *= k * 1.25;\n  }\n  float l = texture2D(texture, vTexCoord).a;\n  highp float m = f * vGammaScale * .7;\n  float n = clamp(smoothstep(h - m, h + m, l), .0, 1.);\n  gl_FragColor = e * (n * textOpacity * vOpacity * layerOpacity);\n  if(gl_FragColor.a < alphaTest) {\n    discard;\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}";const cV=6,fV=4,dV=new Uint16Array(1),pV=new Int8Array(1);function gV(t,e){const n=iO(e.markerWidth),r=iO(e.markerHeight),i=iO(e.markerDx),o=iO(e.markerDy),s=iO(e.markerOpacity),a=iO(e.markerTextFit),l=oO(e.markerPitchAlignment),h=oO(e.markerRotationAlignment),u=iO(e.markerRotation),c=oO(e.markerAllowOverlapFn),f=oO(e.markerIgnorePlacement),d=new Int16Array(1),p=new Uint16Array(1);return[{attrName:"aMarkerWidth",symbolName:"markerWidth",type:Uint16Array,width:1,define:"HAS_MARKER_WIDTH",evaluate:(r,i,o,s)=>{const l=o[s],h=e.markerTextFit,u=a?a(t.getZoom(),r):h;if("both"===u||"width"===u)return l;let c=n(t.getZoom(),r);return nO(c)&&(c=this.evaluateInFnTypeConfig(c,i,t,r)),d[0]=c,d[0]}},{attrName:"aMarkerHeight",symbolName:"markerHeight",type:Uint16Array,width:1,define:"HAS_MARKER_HEIGHT",evaluate:(n,i,o,s)=>{const l=o[s],h=e.markerTextFit,u=a?a(t.getZoom(),n):h;if("both"===u||"height"===u)return l;let c=r(t.getZoom(),n);return nO(c)&&(c=this.evaluateInFnTypeConfig(c,i,t,n)),d[0]=c,d[0]}},{attrName:"aMarkerDx",symbolName:"markerDx",type:Uint8Array,width:1,define:"HAS_MARKER_DX",evaluate:(e,n)=>{let r=i(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),d[0]=r,d[0]}},{attrName:"aMarkerDy",symbolName:"markerDy",type:Uint8Array,width:1,define:"HAS_MARKER_DY",evaluate:(e,n)=>{let r=o(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),d[0]=r,d[0]}},{attrName:"aColorOpacity",symbolName:"markerOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let r=s(t.getZoom(),e);return nO(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),d[0]=255*r,d[0]}},{attrName:"aPitchAlign",symbolName:"markerPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===l(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"markerRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:e=>+("map"===h(t.getZoom(),e))},{attrName:"aRotation",symbolName:"markerRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:e=>{const n=aH(u(t.getZoom(),e),0,360)*Math.PI/180;return p[0]=9362*n,p[0]}},{attrName:"aOverlap",symbolName:"markerAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let r=c(t.getZoom(),n)||0,i=(f?f(t.getZoom(),n):e.markerIgnorePlacement)||0;return r=1<<3+4*r,i=(f?2:0)+i,r+i}},{attrName:"aOverlap",symbolName:"markerIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let r=(c?c(t.getZoom(),n):e.markerAllowOverlap)||0,i=f(t.getZoom(),n)||0;return r=(c?8:0)+4*r,i=2+i,r+i}}]}function mV(t,e,n,r){if(!n||!r||"none"===r)return;const i=function(t,e,n){let r=t.properties.textFitFn;nO(n)&&(r=t.properties.textFitFn=oO(n));const i="none"!==n,o=[],s=t.getElements(),a=t.data.aPickingId;let l,h,u;e&&(l=e.getElements(),h=e.data.aPickingId,u=e.data.aCount);const c=t.properties.features;let f;if(e){let t=l[0];f={pickingId:h[t],start:0,end:u[t]*cV}}let d=!1,p=!1,g=0;const m=new Set;for(let A=0;A<s.length;A+=cV){const t=a[s[A]];if(!d&&f)for(;f.pickingId<t&&f.end<l.length;){const t=f.end,e=l[t];f.start=t,f.end=t+u[e]*cV,f.pickingId=h[e]}if(!d&&f&&f.pickingId<t&&(d=!0,!i)){if(!p)return[];for(let t=A;t<s.length;t+=cV)o[g++]=[-1,-1];return o}const e=c[t]&&c[t].feature,y=e&&e.properties||{},v=r?r(null,y):n;if(f&&t===f.pickingId){o[g++]=[f.start,f.end];const t=f.end,e=l[t];f.start=t,f.end=t+u[e]*cV,f.pickingId=h[e],p=!0}else if(v&&"none"!==v)for(let n=A;n<A+cV;n++)m.add(n);else o[g++]=[-1,-1]}if(m.size)if(m.size===s.length)t.setElements([]);else{const e=[];for(let t=0;t<s.length;t++)m.has(t)||e.push(s[t]);t.setElements(new s.constructor(e))}return p?o:[]}(e,n,r);if(e.getElements().length&&i.length&&(e.properties.labelIndex=i,i.length&&r&&"none"!==r&&n)){const r=function(t,e){const n=[],r=t.properties.labelIndex,{aShape:i}=e.data;let o=!1;for(let s=0;s<r.length;s++){const[t,a]=r[s];if(-1===t)n.push(0,0,0,0);else{o=!0;let r=1/0,s=1/0,l=-1/0,h=-1/0;const u=e.elements;for(let e=t;e<a;e++){const t=u[e],n=i[2*t],o=i[2*t+1];n<r&&(r=n),n>l&&(l=n),o<s&&(s=o),o>h&&(h=o)}n.push(r,s,l,h)}}return o?n:[]}(e,n);r.length&&(e.properties.labelShape=r,AV.call(this,t,e,n))}}function AV(t,e){const n=this.getSymbolDef(e.properties.symbolIndex),r=n.markerTextFit,i=e.properties;let o="both"===r||"width"===r,s="both"===r||"height"===r;if(nO(n.markerTextFit)){let t=e.properties.textFitFn;t||(t=e.properties.textFitFn=iO(n.markerTextFit));const{features:r}=e.properties,a=e.properties.elements||e.elements,{aPickingId:l}=e.data,h=[],u=[];let c=!0;for(let e=0;e<a.length;e+=cV){const n=r[l[a[e]]],i=(n&&n.feature||{}).properties||{};let o=t(null,i);nO(o)&&(o=(i.textFitFn=i.textFitFn||iO(o))(null,i)),"both"===o?(h.push(e/cV),u.push(e/cV)):"width"===o?(c=!1,h.push(e/cV)):"height"===o&&(c=!1,u.push(e/cV))}c?(i.fitIcons=h,o=!0,s=!0):(h.length&&(i.fitWidthIcons=h,o=!0),u.length&&(i.fitHeightIcons=u,s=!0))}i.aPickingId||(i.aPickingId=new e.data.aPickingId.constructor(e.data.aPickingId));const{aMarkerWidth:a,aMarkerHeight:l,aPickingId:h}=i,u=h.length;if(o)if(a){const t=e.data.aMarkerWidth;e.data.aMarkerWidth=new Uint16Array(t),i.aMarkerWidth=new Uint16Array(t);const n=(KH+"aMarkerWidth").trim();i[n]&&(i[n]=i.aMarkerWidth)}else{const t=this.getSymbol(e.properties.symbolIndex).markerWidth||0;i.aMarkerWidth=new Uint16Array(u),i.aMarkerWidth.fill(t),t&&(i.aMarkerWidth.dirty=!0),e.data.aMarkerWidth=new Uint16Array(u)}if(s)if(l){const t=e.data.aMarkerHeight;e.data.aMarkerHeight=new Uint16Array(t),i.aMarkerHeight=new Uint16Array(t);const n=(KH+"aMarkerHeight").trim();i[n]&&(i[n]=i.aMarkerHeight)}else{const t=this.getSymbol(e.properties.symbolIndex).markerHeight||0;i.aMarkerHeight=new Uint16Array(u),i.aMarkerHeight.fill(t),t&&(i.aMarkerHeight.dirty=!0),e.data.aMarkerHeight=new Uint16Array(u)}const c=this.getSymbolDef(e.properties.textGeo.properties.symbolIndex),f=iO(c.textSize);vV.call(this,t,e),(!nO(c.textSize)||f.isZoomConstant&&f.isFeatureConstant)&&(i.isFitConstant=!0)}const yV=[0,0,0,0];function vV(t,e){const n=e.properties.textGeo;if(!n)return;const r=n.properties,i=e.properties;if(i.isFitConstant||!i.labelShape||!i.labelShape.length)return;const o=this.getSymbolDef(e.properties.symbolIndex),s=this.getSymbolDef(n.properties.symbolIndex).textSize;let a;nO(s)&&(a=r.Ds?r.Ds:r.Ds=iO(s));const l=o.markerTextFitPadding||yV;let h;nO(l)&&(h=i.Ls?i.Ls:i.Ls=oO(l));const u=t.getZoom(),{fitIcons:c,fitWidthIcons:f,fitHeightIcons:d}=i,{aMarkerWidth:p,aMarkerHeight:g,labelShape:m}=i,A=i.elements||e.elements,{features:y,aPickingId:v}=i,x=(t,e,n,r)=>{const o=m[4*e],c=m[4*e+1],f=m[4*e+2],d=m[4*e+3];if(!(o||c||f||d))return;const A=v[t],x=y[A]&&y[A].feature,_=x&&x.properties||{};let b=a?a(u,_):s;nO(b)&&(b=(_.textSizeFn=_.textSizeFn||iO(b))(u,_)),b/=CU;let w,T,M=h&&h(u,_)||l;if(nO(M)&&(M=(_.fitPaddingFn=_.fitPaddingFn||oO(M))(u,_)),M=M||yV,M[0]===M[2]&&M[1]===M[3]||(w=i.aPadOffsetX,T=i.aPadOffsetY,w||(w=i.aPadOffsetX=new Int8Array(p.length),T=i.aPadOffsetY=new Int8Array(p.length))),p&&n){const e=Math.abs((f-o)/10*b)+(M[1]+M[3]||0);if(dV[0]=e,p[t]!==dV[0]&&(gH(p,dV[0],t,t+fV),p.dirty=!0),w){const e=(M[1]+M[3])/2-M[3];pV[0]=e,w[t]!==pV[0]&&(gH(w,e,t,t+fV),w.dirty=!0)}}if(g&&r){const e=Math.abs((d-c)/10*b)+(M[0]+M[2]||0);if(dV[0]=e,g[t]!==dV[0]&&(gH(g,dV[0],t,t+fV),g.dirty=!0),T){const e=M[0]-(M[0]+M[2])/2;pV[0]=e,T[t]!==pV[0]&&(gH(T,e,t,t+fV),T.dirty=!0)}}};if(c||f||d){if(c)for(let w=0;w<c.length;w++){const t=c[w];x(A[t*cV],t,!0,!0)}else if(f||d){if(f)for(let t=0;t<f.length;t++){const e=f[t];x(A[e*cV],e,!0,!1)}if(d)for(let t=0;t<d.length;t++){const e=d[t];x(A[e*cV],e,!1,!0)}}}else for(let w=0;w<A.length;w+=cV){const t=w/cV;x(A[w],t,!0,!0)}const{aPadOffsetX:_,aPadOffsetY:b}=i;_&&(e.data.aPadOffsetX=_,e.data.aPadOffsetY=b)}const xV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&e.isForeground(t)&&!!t.geometry.properties.iconAtlas&&!t.geometry.properties.isEmpty},_V=function(t){const e=this.layer.getRenderer();return!(this.Es(t)||e.isForeground(t)||!t.geometry.properties.iconAtlas||t.geometry.properties.isEmpty)},bV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&e.isForeground(t)&&!!t.geometry.properties.glyphAtlas},wV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&!e.isForeground(t)&&!!t.geometry.properties.glyphAtlas},TV=[],MV={collides:-1},CV=[MU,MU],SV=im([]),IV=[];class PV extends uU{static getBloomSymbol(){return["markerBloom","textBloom"]}constructor(t,e,n,r,i,o){super(t,e,n,r,i,o),this.propAllowOverlap="markerAllowOverlap",this.propIgnorePlacement="markerIgnorePlacement",this.nr={},this.isLabelCollides=oV.bind(this),this.Rs=xV.bind(this),this.Hs=_V.bind(this),this.zs=bV.bind(this),this.Ns=wV.bind(this),this.Vs=[]}needToRefreshTerrainTileOnZooming(){for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].markerPitchAlignment;if("map"===e||nO(e)||yF(e))return!0}return!1}isTerrainVector(){return this.layer.options.awareOfTerrain&&!this.needToRefreshTerrainTileOnZooming()}isTerrainSkin(){return super.isTerrainSkin()&&this.needToRefreshTerrainTileOnZooming()}setTextShaderDefines(t){this.Us=t}createFnTypeConfig(t,e){return{icon:gV.call(this,t,e),text:tV.call(this,t,e)}}startFrame(...t){return this.Vs.length=0,super.startFrame(...t)}createGeometry(t,e){return t&&t.empty&&(t.data={aPosition:new Uint8Array(t.data.aPosition),aPickingId:t.data.aPickingId}),super.createGeometry(t,e)}postCreateGeometry(t,e){const{geometry:n,symbolIndex:r}=t,i=this.getSymbolDef(r),o=this.getFnTypeConfig(r);if(this.js(n))n.properties.iconAtlas?this.drawDebugAtlas(n.properties.iconAtlas):n.properties.isEmpty=!0,function(t,e,n,r){tj(t,e,n,r),function(t){const{aMarkerWidth:e,aMarkerHeight:n,aMarkerDx:r,aMarkerDy:i,aPitchAlign:o,aRotationAlign:s,aRotation:a,aOverlap:l}=t.data;if(e){const n=(KH+"aMarkerWidth").trim();t.properties.aMarkerWidth=t.properties[n]||new e.constructor(e)}if(n){const e=(KH+"aMarkerHeight").trim();t.properties.aMarkerHeight=t.properties[e]||new n.constructor(n)}if(r){const e=(KH+"aMarkerDx").trim();t.properties.aMarkerDx=t.properties[e]||new r.constructor(r)}if(i){const e=(KH+"aMarkerDy").trim();t.properties.aMarkerDy=t.properties[e]||new i.constructor(i)}if(o){const e=(KH+"aPitchAlign").trim();t.properties.aPitchAlign=t.properties[e]||new o.constructor(o)}if(s){const e=(KH+"aRotationAlign").trim();t.properties.aRotationAlign=t.properties[e]||new s.constructor(s)}if(a){const e=(KH+"aRotation").trim();t.properties.aRotation=t.properties[e]||new a.constructor(a)}if(l){const e=(KH+"aOverlap").trim();t.properties.aOverlap=t.properties[e]||new l.constructor(l)}}(t)}(n,i,o.icon,this.layer);else if(this.Gs(n)&&AH(i)){const t=e[e.length-1];if(t){const{geometry:e,symbolIndex:o}=t;if(e&&o.index===r.index){const t=this.getMap(),r=i.markerTextFit;e.properties.textGeo=n,mV.call(this,t,e,n,r)}}}}prepareCollideIndex(t){const{collideIds:e,elements:n,aCount:r}=t.properties;if(!e)return;const i=e,o={};if(!n)return void(t.properties.collideBoxIndex=o);let s=0,a=n[0],l=0,h=i[a],u=1;r&&(u=r[n[l]]);for(let c=0;c<=n.length;c+=cV)a=n[c],i[a]===h&&c!==n.length||(o[h]=[l,c,(c-l)/(u*cV),s++],h=i[a],l=c,r&&(u=r[n[l]]));t.properties.collideBoxIndex=o}createMesh(t,e,n,r){const i=this.isEnableCollision(),o=this.layer,{geometry:s,symbolIndex:a}=t;s.properties.symbolIndex=a;const l=this.getSymbolDef(a),h=this.getSymbol(a),u=this.getFnTypeConfig(a),c=[];if(this.js(s)){const t=function(t,e,n,r,i,o,s,a){if(e.isDisposed()||0===e.data.aPosition.length)return null;const l=e.properties.iconAtlas;if(!l&&!e.properties.isEmpty)return null;const h={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio};if(!e.properties.aShape){const{aPosition:t,aShape:n}=e.data,r=e.data.aPosition.length/e.desc.positionSize,i=new Uint8Array(r);a&&i.fill(255,0),e.data.aOpacity={usage:"dynamic",data:i},e.properties.aOpacity=new Uint8Array(r),a&&e.properties.aOpacity.fill(255,0),e.properties.aAnchor=t,e.properties.aShape=n}e.properties.visElemts||(e.properties.elements=e.elements,e.properties.visElemts=new e.elements.constructor(e.elements.length));const[u,c]=jj(e);uH(h,"markerOpacity",i,"markerOpacity",1),uH(h,"markerPerspectiveRatio",i,"markerPerspectiveRatio",i.markerTextFit?0:1),uH(h,"markerWidth",i,"markerWidth",u||15),uH(h,"markerHeight",i,"markerHeight",c||15),uH(h,"markerDx",i,"markerDx",0),uH(h,"markerDy",i,"markerDy",0),uH(h,"markerRotation",i,"markerRotation",0,(t=>t*Math.PI/180)),uH(h,"pitchWithMap",i,"markerPitchAlignment",0,(t=>"map"===t?1:0)),uH(h,"rotateWithMap",i,"markerRotationAlignment",0,(t=>"map"===t?1:0)),h.iconTex=l?zj(t,l,!1):null,h.texSize=l?[l.width,l.height]:[0,0],e.generateBuffers(t,{excludeElementsInVAO:!0});const f=new Kx(h),d=new h_(e,f,{disableVAO:!0,transparent:!0,castShadow:!1,picking:!0}),p={};return s&&(p.ENABLE_COLLISION=1),e.data.aMarkerWidth&&(p.HAS_MARKER_WIDTH=1),e.data.aMarkerHeight&&(p.HAS_MARKER_HEIGHT=1),e.data.aColorOpacity&&(p.HAS_OPACITY=1),e.data.aMarkerDx&&(p.HAS_MARKER_DX=1),e.data.aMarkerDy&&(p.HAS_MARKER_DY=1),e.data.aPitchAlign&&(p.HAS_PITCH_ALIGN=1),e.data.aRotationAlign&&(p.HAS_ROTATION_ALIGN=1),e.data.aRotation&&(p.HAS_ROTATION=1),e.data.aPadOffsetX&&(p.HAS_PAD_OFFSET=1),e.data.aAltitude&&(p.HAS_ALTITUDE=1),d.setDefines(p),d.setUniform("alphaTest",SU),d.setLocalTransform(n),d.properties.symbolIndex=e.properties.symbolIndex,d}(this.regl,s,e,0,h,u.icon,o.options.collision,!i,this.isEnableUniquePlacement());t&&(t.positionMatrix=this.getAltitudeOffsetMatrix(),delete t.geometry.properties.glyphAtlas,c.push(t))}else if(this.Gs(s)){const t=JU.call(this,this.regl,s,e,l,h,u.text,o.options.collision,!i,this.isEnableUniquePlacement());t.length&&(t.forEach((t=>{t.positionMatrix=this.getAltitudeOffsetMatrix(),delete t.geometry.properties.iconAtlas})),c.push(...t))}return"line"===s.properties.markerPlacement&&this.Bs(s,r),"line"===s.properties.markerPlacement&&c.forEach((t=>t.properties.isLinePlacement=!0)),this.prepareCollideIndex(s),c}Bs(t,e){const n=this.layer instanceof d,{collideIds:r}=t.properties,i=new Uint16Array(r.length);if(this.js(t)){let o=0;for(let t=0;t<r.length;t+=fV)i.fill(o++,t,t+fV);t.properties.collideIds=i,t.properties.uniqueCollideIds=vH(i,!n),e.markerCollideMap={old:r,new:i}}else if(this.Gs(t)){const{collideIds:r,aCount:i}=t.properties;if(!i)return;if(e.markerCollideMap){const{markerCollideMap:o}=e;let s=o.new[o.new.length-1],a=0,l=r[0],h=e.markerCollideMap.old.indexOf(l),u=i[0];for(let t=0;t<r.length;){const n=r[t];l!==n&&(l=n,h=e.markerCollideMap.old.indexOf(l),a=0);const o=-1===h?++s:e.markerCollideMap.new[h+a*fV],c=t+u*fV;r.fill(o,t,c),t+=u*fV,a++,c<r.length&&(u=i[c])}t.properties.uniqueCollideIds=vH(r,!n)}else{let e=0,o=i[0];for(let t=0;t<r.length;){const n=t+o*fV;r.fill(e++,t,n),t+=o*fV,n<r.length&&(o=i[n])}t.properties.uniqueCollideIds=vH(r,!n)}}}addMesh(t){if(this.isEnableCollision()&&t.length>0){const e=new nU(t);e.properties.uniqueCollideIds=t[0].geometry.properties.uniqueCollideIds,e.properties.meshKey=t[0].properties.meshKey,e.properties.level=t[0].properties.level,this.Vs.push(e)}for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const e=t[n].geometry,{symbolIndex:r}=e.properties;AH(this.getSymbolDef(r))&&vV.call(this,this.getMap(),e)}const e=this.getMap().getZoom();for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const r=t[n].geometry,{symbolIndex:i}=r.properties,o=this.getSymbolDef(i),s=this.getFnTypeConfig(i);ij(this.regl,this.layer,o,0===i.type?s.icon:s.text,t[n],e);const{aMarkerWidth:a,aMarkerHeight:l,aPadOffsetX:h,aPadOffsetY:u}=r.properties;a&&a.dirty&&(r.updateData("aMarkerWidth",a),a.dirty=!1),l&&l.dirty&&(r.updateData("aMarkerHeight",l),l.dirty=!1),h&&h.dirty&&(r.updateData("aPadOffsetX",h),h.dirty=!1),u&&u.dirty&&(r.updateData("aPadOffsetY",u),u.dirty=!1)}super.addMesh(...arguments)}updateCollision(t){if(!this.isEnableCollision())return;super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.$s(t.timestamp),this.Vs=[],this.Gr()):this.Gr()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Rs,e.sceneFilter]:this.Rs,this.callRenderer(this.shader,t,e),this.Ws.filter=e.sceneFilter?[this.zs,e.sceneFilter]:this.zs,this.callRenderer(this.Ws,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Hs,e.sceneFilter]:this.Hs,this.callRenderer(this.shader,t,e),this.Ws.filter=e.sceneFilter?[this.Ns,e.sceneFilter]:this.Ns,this.callRenderer(this.Ws,t,e)}isMeshIterable(t){return t&&t.geometry&&!t.geometry.properties.isEmpty&&t.material&&!t.material.get("isHalo")&&this.isMeshVisible(t)&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}$s(){if(!this.isEnableCollision())return;let t=this.Vs;t&&t.length&&this.Xs(t)}Ys(t,e,n,r){return this.updateBoxCollisionFading(!0,t,e,n,r)}isEnableUniquePlacement(){return this.isEnableCollision()&&!0===this.sceneConfig.uniquePlacement}Xs(t){const e=this.layer.getRenderer();t=t.sort(EV);for(let n=0;n<t.length;n++){const r=t[n];if(!r||!r.meshes.length)continue;let i=!1;if(1===r.meshes.length)i=this.isMeshIterable(r.meshes[0]);else for(let t=0;t<r.meshes.length;t++)if(this.isMeshIterable(r.meshes[t])){i=!0;break}if(!i)continue;const o=e.isForeground(r.meshes[0]);if(this.shouldIgnoreBackground()&&!o)continue;const s=r.properties.meshKey;this.startMeshCollision(r),this.qs(r),this.forEachBox(r,this.Ys),this.Js(r),this.endMeshCollision(s);for(let t=0;t<r.meshes.length;t++)this.Ks(r.meshes[t])}}Ks(t){const e=t&&t.geometry&&t.geometry.properties.aOpacity;e&&e.dirty&&(t.geometry.updateData("aOpacity",e),e.dirty=!1)}forEachBox(t,e){const n=t.properties.uniqueCollideIds;if(!n)return;const r={boxIndex:0},i=n.length;for(let o=0;o<i;o++)this.Zs(t,n[o],e,r)}Zs(t,e,n,r){const i=this.getMap(),{collideBoxIndex:o}=t.meshes[0].geometry.properties;if(!o||!o[e])return!1;const s=am(TV,i.projViewMatrix,t.meshes[0].localTransform);let a,l=!1;const h=t.meshes;let u=0;for(let f=0;f<h.length;f++){if(!this.isMeshIterable(h[f]))continue;const{collideBoxIndex:t}=h[f].geometry.properties;t[e]&&u++}if(!u)return!1;a=this.Cs(u);let c=0;for(let f=0;f<h.length;f++){const t=h[f];if(!this.isMeshIterable(t))continue;l=!0;const n=h[f].geometry.properties,{elements:r,aCount:i,collideBoxIndex:o}=n,s=o[e];if(!s)continue;const[u,d,p]=s;let g=1;i&&(g=i[r[u]]);const m=u+0*g*cV;a[c].mesh=h[f],a[c].start=m,a[c].end=d,a[c].boxCount=n.glyphAtlas?g:p,a[c].allElements=r,c++}return!!l&&(n.call(this,t,a,s,r.boxIndex++)&&this.Qs(t,e),!0)}qs(t){const e=t.meshes;for(let n=0;n<e.length;n++){const t=e[n],r=t&&t.geometry;r&&(r.properties.visElemts.count=0)}}Qs(t,e){const n=t.meshes;for(let r=0;r<n.length;r++){const t=n[r];if(t.properties.isHalo)continue;const i=t&&t.geometry;if(!i||i.properties.isEmpty)continue;const{collideBoxIndex:o,elements:s,visElemts:a}=i.properties,l=o[e];if(!l)continue;const[h,u]=l;let c=a.count;for(let e=h;e<u;e++)a[c++]=s[e];a.count=c}}Js(t){const e=t.meshes;for(let n=0;n<e.length;n++){const t=e[n],r=t&&t.geometry;if(!r)continue;const{visElemts:i}=r.properties;r.setElements(i,i.count)}}isBoxCollides(t,e,n,r,i,o){if(this.Gs(t.geometry))return oV.call(this,0,t,e,n,r,i,o);if(t.geometry.properties.isEmpty)return MV;const{aTerrainAltitude:s}=t.geometry.properties;if(s&&s[2*e[r]]===JB)return MV;const a=this.getMap(),{boxes:l,collision:h}=this.Fs(t,r);let u=0,c=0,f=0;for(let d=r;d<i;d+=cV){const n=l[f]=l[f]||[];f++;const r=zU.call(this,n,t,e[d],o,a);if(!u){const t=this.isCollides(r);1===t?u=1:-1===t&&c++}}return c===n&&(u=-1),h.collides=u,h}deleteMesh(t,e){t&&(t instanceof nU&&(t=t.meshes),e&&(Array.isArray(t)?t.forEach((t=>{t&&t.material&&delete t.material.uniforms.iconTex})):t.material&&delete t.material.uniforms.iconTex),super.deleteMesh(t,e))}isBloom(t){const e=t&&t.material&&!lH(t.material.get("markerOpacity")),n=this.getSymbol(t.properties.symbolIndex);return!!(e?n.markerBloom:n.textBloom)}isUniqueStencilRefPerTile(){return!1}init(){const t=this.regl,e=this.canvas;this.renderer=new f_(t);const n={viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!!lH(this.sceneConfig.depthMask)||this.sceneConfig.depthMask},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};this.shader=new U_({vert:gU,frag:"#define SHADER_NAME MARKER\n#define HAS_HIGHLIGHT_COLOR_POINT 1\nprecision mediump float;\n#include <gl2_frag>\nuniform float alphaTest;\nuniform sampler2D iconTex;\nuniform lowp float markerOpacity;\nuniform lowp float blendSrcIsOne;\nuniform float layerOpacity;\n#include <highlight_frag>\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvoid main() {\n  vec4 c = texture2D(iconTex, vTexCoord) * markerOpacity * vOpacity * layerOpacity;\n  if(c.a < .05) {\n    discard;\n  }\n  glFragColor = c;\n  glFragColor = highlight_blendColor(glFragColor);\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n  glFragColor = highlight_blendColor(glFragColor);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:n}),this.shader.version=300;const{uniforms:r,extraCommandProps:i}=$U.call(this,e,this.sceneConfig),o=this.Us||{};if(this.Ws=new U_({vert:hV,frag:uV,uniforms:r,extraCommandProps:i,defines:o}),this.pickingFBO){const t=new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+gU,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:n},this.pickingFBO,this.getMap());t.filter=t=>!!t.geometry.properties.iconAtlas;const e=new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+hV,uniforms:r,extraCommandProps:i},this.pickingFBO,this.getMap());e.filter=t=>!!t.geometry.properties.glyphAtlas,this.picking=[t,e]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,r=this.layer.getTileSize().width,i=n?SV:t.projViewMatrix,o=t.cameraToCenterDistance,a=Ly(IV,t.width,t.height);n&&Ly(a,r,r);const l=this.getBlendFunc(),h=s.isFunction(l.src)?l.src():l.src;return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:i,cameraToCenterDistance:o,canvasSize:a,iconSize:CV,resolution:t.getResolution(),glyphSize:CU,gammaScale:1,blendSrcIsOne:+!("one"!==h&&1!==h),viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n}}getUniqueEntryKey(t,e){if(!this.Gs(t.geometry))return null;const{elements:n}=t.geometry.properties;return sV(t,n[e])}js(t){const{symbolIndex:e}=t.properties;return 0===e.type}Gs(t){const{symbolIndex:e}=t.properties;return 1===e.type}}function EV(t,e){return t.properties.level-e.properties.level||t.properties.meshKey-e.properties.meshKey}const OV=[],RV=[],kV=[];function LV(t,e,n,r,i,o,s,a,l,h,u,c,f){const{aGlyphOffset:d,aSegment:p,aTextDx:g,aTextDy:m,symbolIndex:A}=e.geometry.properties,y=this.getSymbol(A),v=g?g[i]:y.textDx,x=m?m[i]:y.textDy,_=Ly(kV,v||0,x||0),b=Ly(OV,d[2*i],d[2*i+1]),w=Lm(RV,p[3*i],p[3*i+1],p[3*i+2]),T=function(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g,m,A){p||(p=r);const y=e.geometry.properties.line,v=o[0]*c,x=f?v-s:v+s;let _=x>0?1:-1,b=0;f&&(_*=-1,b=Math.PI),_<0&&(b+=Math.PI);const w=h+u,T=Math.abs(x);let M=_>0?l:l+1,C=Ck.convert(r),S=Ck.convert(r),I=Ck.convert(i),P=Ck.convert(i),E=0,O=0;for(;E+O<=T;){if(M+=_,M<h||M>=w)return null;S.x=C.x,S.y=C.y,P.x=I.x,P.y=I.y,C.x=n[3*M],C.y=n[3*M+1],I.x=y[3*M],I.y=y[3*M+1],E+=O,O=S.dist(C)/d}const R=(T-E)/O,k=g&&g.getRenderer(),L=k&&k.getTerrainHelper(),D=e.properties.tile.terrainTileInfos;if(!A&&L){const{extent:n}=e.properties.tile,r=g.getTileSize().width/n,i=g.getMap();let o=I.sub(P).mult(R).i(P);C=xj(pj,i,e,I,r,g,m,D),S=xj(gj,i,e,P,r,g,m,D),o=xj(mj,i,e,o,r,g,m,D);const s=b+Math.atan2(C[1]-S[1],C[0]-S[0]);return t[0]=(o[0]-p[0])/d,t[1]=(o[1]-p[1])/d,t[2]=s,t}const N=C.sub(S),F=N.mult(R).i(S);F.i(N.T().I().A(a*_));const z=b+Math.atan2(C.y-S.y,C.x-S.x);return t[0]=(F.x-r[0])/d,t[1]=(F.y-r[1])/d,t[2]=z,t}(t,e,r,o,s,b,_[0],_[1],w[0],w[1],w[2],n/24,l,a,h,u,c,f);return T}const DV=[],NV=[];function FV(t,e,n,r,i,o,s,a,l,h,u,c){const{aVertical:f}=n.geometry.properties,d=f[o];let p,g,m=LV.call(this,DV,n,r,i,o,a,l,h,!1);if(!m)return null;if(km(t,m),m=LV.call(this,NV,n,r,i,s,a,l,h,!1),!m)return null;if(km(e,m),c&&(Wy(DV,DV,c),Wy(NV,NV,c)),d){const t=Math.abs(NV[1]-DV[1]),e=Math.abs(NV[0]-DV[0])*u;g=DV[0]>NV[0]?1:0,t>e?(p=1,g=DV[1]<NV[1]?0:1):p=0}else p=0,g=DV[0]>NV[0]?1:0;return 2*g+p}var zV="#define SHADER_NAME TEXT_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aTexCoord;\n#ifdef HAS_OFFSET_Z\nattribute vec3 aOffset;\nuniform float altitudeScale;\n#else\nattribute vec2 aOffset;\n#endif\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\nuniform float zoomScale;\nuniform float cameraToCenterDistance;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float mapPitch;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\nuniform float textPitchFilter;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nattribute float aTextHaloRadius;\nvarying float vTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nattribute float aTextHaloOpacity;\nvarying float vTextHaloOpacity;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_DX\nfloat d = aTextDx;\n#else\nfloat d = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat e = aTextDy;\n#else\nfloat e = textDy;\n#endif\n#ifdef HAS_TEXT_SIZE\nfloat f = aTextSize * layerScale;\n#else\nfloat f = textSize * layerScale;\n#endif\n#ifdef HAS_PITCH_ALIGN\nfloat h = aPitchAlign;\n#else\nfloat h = pitchWithMap;\n#endif\ngl_Position = projViewModelMatrix * vec4(c, 1.);\n  float i = gl_Position.w;\n  float j = i / cameraToCenterDistance;\n  float k;\n  if(isRenderingTerrain == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / i) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_OFFSET_Z\nvec3 m = aOffset / 10.0;\n  m[2] /= altitudeScale;\n#else\nvec3 m = vec3(aOffset / 10.0, .0);\n#endif\nvec2 n = aTexCoord;\n  if(h == 1.) {\n    float o;\n    if(isRenderingTerrain == 1.) {\n      o = tileRatio;\n    } else {\n      o = tileRatio / zoomScale * j * k;\n    }\n    m.xy *= o;\n    gl_Position = projViewModelMatrix * vec4(c + m, 1.);\n  } else {\n    gl_Position.xy += m.xy * 2. / canvasSize * k * i;\n  }\n  gl_Position.xy += vec2(d, -e) * 2. / canvasSize * i;\n  if(textPitchFilter > .0) {\n    if(textPitchFilter == 1. && h == .0 || textPitchFilter == 2. && h == 1.) {\n      gl_Position = vec4(-9999., -9999., .0, 1.);\n    }\n  }\n#ifndef PICKING_MODE\nif(h == 1.) {\n    vGammaScale = j + mapPitch / 4.;\n  } else {\n    vGammaScale = mix(1., j, textPerspectiveRatio);\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTexCoord = n / texSize;\n  vSize = f;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvTextHaloRadius = aTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nvTextHaloOpacity = aTextHaloOpacity;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool u = aOpacity == 255.;\n#else\nbool u = true;\n#endif\nfbo_picking_setData(gl_Position.w, u);\n#endif\n}";const BV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&e.isTileNearCamera(t)&&"line"!==t.geometry.properties.textPlacement},HV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&!e.isForeground(t)&&"line"!==t.geometry.properties.textPlacement},jV=function(t){const e=this.layer.getRenderer();return!this.Es(t)&&e.isTileNearCamera(t)&&"line"===t.geometry.properties.textPlacement},UV=function(t){const e=this.layer.getRenderer(),n=t.properties.tile.z,r=e.getCurrentTileZoom();return!this.Es(t)&&!e.isForeground(t)&&"line"===t.geometry.properties.textPlacement&&n<r},VV=[0,0,3],GV=[],WV=[],qV=[],XV=[],ZV=[],YV=[],JV=[],QV=[],KV=[1,-1],$V=new Int16Array(3),tG=[],eG=[],nG=[],rG=[],iG=[],oG=[],sG=[],aG={},lG={},hG={},uG=[],cG=[],fG=im([]),dG=[];class pG extends uU{static getBloomSymbol(){return["textBloom"]}constructor(t,e,n,r,i,o){super(t,e,n,r,i,o),this.propAllowOverlap="textAllowOverlap",this.propIgnorePlacement="textIgnorePlacement",this.colorCache={},this.eo=BV.bind(this),this.no=HV.bind(this),this.io=jV.bind(this),this.ro=UV.bind(this),this.isLabelCollides=oV.bind(this),this.so()}prepareRender(...t){super.prepareRender(...t);const e=this.scene.getMeshes();if(e&&e.length)for(let n=0;n<e.length;n++){if(e[n].properties.isHalo)continue;const{haloMesh:t}=e[n].properties;t.dirtyDefines&&e[n].setDefines(t.defines)}}updateSymbol(...t){this.oo=void 0,this.ao=void 0;const e=super.updateSymbol(...t);return this.so(),e}isTerrainVector(){if(!super.isTerrainSkin())return!1;if(void 0!==this.oo)return this.oo;for(let t=0;t<this.symbolDef.length;t++)if("map"!==this.symbolDef[t].textPitchAlignment)return this.oo=!0,!0;return this.oo=!1,!1}isTerrainSkin(){if(!super.isTerrainSkin())return!1;if(void 0!==this.ao)return this.ao;for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].textPitchAlignment;if("map"===e||nO(e)||yF(e))return this.ao=!0,!0}return this.ao=!1,!1}so(){this.lo=[];for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t];if(yF(e.textName)){const n=AF(e.textName,"string");this.lo[t]=(t,e)=>{let r;aG.zoom=t,lG.properties=e;try{r=n.evaluateWithoutErrorHandling(aG,lG,hG,null,uG)}catch(i){r=null}return r}}else nO(e.textName)&&(this.lo[t]=iO(e.textName))}}shouldDeleteMeshOnUpdateSymbol(t){if(!Array.isArray(t))return(0===t.textHaloRadius||0===this.symbolDef[0].textHaloRadius)&&t.textHaloRadius!==this.symbolDef[0].textHaloRadius;for(let e=0;e<t.length;e++)if(t[e]&&(0===t[e].textHaloRadius||0===this.symbolDef[e].textHaloRadius)&&t[e].textHaloRadius!==this.symbolDef[e].textHaloRadius)return!0;return!1}createFnTypeConfig(t,e){return tV(t,e)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[pG.getBloomSymbol()[0]]}createGeometry(t,e,n){const r=t;if(!r.glyphAtlas)return null;const i=super.createGeometry(r,e);if(!i||!i.geometry)return null;const{geometry:o}=i;return o.properties.glyphAtlas&&this.drawDebugAtlas(o.properties.glyphAtlas),o&&r.lineVertex&&(o.properties.line=r.lineVertex,o.properties.line.id=n),i}createMesh(t,e,{tileVectorTransform:n}){const r=this.isEnableCollision(),i=this.isEnableUniquePlacement(),{geometry:o,symbolIndex:s}=t;o.properties.symbolIndex=s;const a=this.getSymbol(s),l=this.getSymbolDef(s),h=this.getFnTypeConfig(s),u=JU.call(this,this.regl,o,e,l,a,h,this.layer.options.collision,!r,i);return u.length&&("line"===o.properties.textPlacement?this.ho=!0:this.uo=!0),u.forEach((t=>{t.positionMatrix=this.getAltitudeOffsetMatrix(),t.properties.tileVectorTransform=n})),u}updateCollision(t){super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.co={},this.fo(t.timestamp),this.Gr()):this.Gr()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.eo,e.sceneFilter]:this.eo,this.callRenderer(this.shader,t,e),this.do.filter=e.sceneFilter?[this.io,e.sceneFilter]:this.io,this.callRenderer(this.do,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.no,e.sceneFilter]:this.no,this.callRenderer(this.shader,t,e),this.do.filter=e.sceneFilter?[this.ro,e.sceneFilter]:this.ro,this.callRenderer(this.do,t,e)}callRenderer(t,e,n){n&&n.isRenderingTerrain&&nO(this.symbolDef.textPitchAlignment)&&(n.isRenderingTerrainSkin?e.textPitchFilter=1:e.textPitchFilter=2),super.callRenderer(t,e,n)}fo(){let t=this.scene.getMeshes();if(!t||!t.length)return;const e=-this.getMap().getBearing()*Math.PI/180,n=Lg(qV,e),r=(t,e,n,r)=>{const{start:i,end:o,mesh:s,allElements:a}=e[0];if(this.updateBoxCollisionFading(!0,s,e,n,r)){let e=t.count;for(let n=i;n<o;n++)t[e++]=a[n];t.count=e}},i=this.isEnableCollision(),o=this.layer.getRenderer();t=t.sort(mG);for(let s=0;s<t.length;s++){const e=t[s];if(!this.isMeshIterable(e))continue;if(!o.isTileNearCamera(e)){const{visElemts:t}=e.geometry.properties;t&&(t.count=0),e.geometry.setElements(t,0);continue}const a=e.geometry,l=this.getSymbol(e.properties.symbolIndex);e.properties.textHaloRadius=lH(l.textHaloRadius)?YU.textHaloRadius:l.textHaloRadius;const h=e.properties.meshKey;if("line"===a.properties.textPlacement){if(!a.properties.line)continue;i&&this.startMeshCollision(e),this.po(e,n);const{aOffset:t,aOpacity:r}=a.properties;t.dirty&&(a.updateData("aOffset",t),t.dirty=!1),r&&r.dirty&&(a.updateData("aOpacity",r),r.dirty=!1),i&&this.endMeshCollision(h)}else if(i){this.startMeshCollision(e);const{elements:t,aOpacity:n,visElemts:i}=a.properties;i.count=0,this.forEachBox(e,((t,e,n,o,s)=>{r(i,e,n,o)})),n&&n.dirty&&a.updateData("aOpacity",n);const o=i.count===t.length&&a.count===t.length,s=!i.count&&!a.count;o||s||a.setElements(i,i.count),this.endMeshCollision(h)}}}isMeshIterable(t){return t.isValid()&&t.material&&!t.material.get("isHalo")&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}isMeshUniquePlaced(t){return!!this.isMeshIterable(t)&&"line"!==this.getSymbol(t.properties.symbolIndex).textPlacement}getUniqueEntryKey(t,e){return sV(t,e)}po(t,e){const n=this.getMap(),r=t.geometry,i=r.properties;let o=i.line;if(!o)return;const s=n.getPitch(),a=n.getBearing(),{lineTextPitch:l,lineTextBearing:h}=t.properties,u=1===t.material.uniforms.pitchWithMap,c=i.elements;if(!u){const e=am(GV,n.projViewMatrix,t.localTransform),r=o.id+"-"+e.join();let s;this.co[r]?o=this.co[r]:(s=i.projectedLine=i.projectedLine||new Array(o.length),o=this.mo(s,o,e,n.width,n.height),this.co[r]=s)}const f=this.isEnableCollision(),d=r.properties.visElemts=r.properties.visElemts||new c.constructor(c.length),p=r.properties.visCache=r.properties.visCache||[];f&&(d.count=0);const g=void 0===l||!n.isInteracting()||Math.abs(s-l)>2||Math.abs(a-h)>2;g&&(this.Er=!0),this.forEachBox(t,((t,n,r,i)=>{const{start:s,end:a}=n[0];let l=p[i];if((void 0===l||g)&&(l=this.yo(t,c,s,a,o,r,u?e:null,i)),p[i]=l,f&&(l=this.updateBoxCollisionFading(l,t,n,r,i),l)){let t=d.count;for(let e=s;e<a;e++)d[t++]=c[e];d.count=t}})),g&&(t.properties.lineTextPitch=s,t.properties.lineTextBearing=a);const m=t.geometry.properties.aAltitude;m&&m.dirty&&(r.updateData("aAltitude",m),m.dirty=!1),!f||d.count===c.length&&r.count===d.count||r.setElements(d,d.count)}mo(t,e,n,r,i){return function(t,e,n,r,i){for(let o=0;o<e.length;o+=3)cA(fj,e[o],e[o+1],e[o+2],1),dj(fj,fj,n,r,i),t[o]=fj[0],t[o+1]=fj[1],t[o+2]=e[o+2];return t}(t,e,n,r,i)}forEachBox(t,e){const n=this.getMap(),r=am(GV,n.projViewMatrix,t.properties.tileVectorTransform),{collideIds:i,aCount:o,features:s,elements:a}=t.geometry.properties,l=i;if(!l)return;const h=this.isEnableUniquePlacement(),u=this.Cs(1);u[0].allElements=a,u[0].mesh=t;let c=0,f=a[0],d=0,p=l[f];for(let g=0;g<=a.length;g+=6)if(f=a[g],l[f]!==p||g===a.length){const n=s[p]&&s[p].feature;if(h&&this.isMeshUniquePlaced(t)&&n&&!n.label){const e=n.properties||{},{symbolIndex:r}=t.properties,i=ZF(r&&this.lo[r.index]?this.lo[r.index](t.properties.z,e):this.getSymbol(t.properties.symbolIndex).textName,e);n.label=i}const i=g,m=o[a[d]];for(let o=d;o<i;o+=6*m)u[0].start=o,u[0].end=o+6*m,u[0].boxCount=m,e.call(this,t,u,r,c++);p=l[f],d=g}}yo(t,e,n,r,i,o,s){const a=this.layer.getRenderer(),l=t.material.uniforms,h=1===l.pitchWithMap,u=!h&&a.getTerrainHelper&&a.getTerrainHelper(),c=this.isEnableCollision(),f=this.getMap(),d=t.geometry,p=d.desc.positionSize,{aShape:g,aOffset:m,aAnchor:A,aAltitude:y,aPitchRotation:v}=d.properties;let{aProjectedAnchor:x}=d.properties;x||(x=d.properties.aProjectedAnchor=new Array(A.length/p*3));const _=d.properties.aTextSize,b=!s,w=e[n],T=w*p;let M;M=d.data.aAltitude?Lm(XV,A[T],A[T+1],y[w]):vL(XV,A[T],A[T+1],A[T+2]);const C=dj(ZV,M,o,f.width,f.height),S=d.properties.aTerrainAltitude;let I;if(S){const t=S[w];if(t===JB)return x[3*w]=YB,x[3*w+1]=YB,x[3*w+2]=YB,!1;t?(I=Lm(cG,...M),I[2]=100*t,I=dj(I,I,o,f.width,f.height)):I=C}else I=C;const P=f.getDevicePixelRatio();if(mA(dG,I,1/P),f.isOffscreen(dG))return c||gG(m,e,n,r),x[3*w]=YB,x[3*w+1]=YB,x[3*w+2]=YB,!1;b&&(M=C),x[3*w]=I[0],x[3*w+1]=I[1],x[3*w+2]=I[2];const E=b?1:d.properties.tileExtent/this.layer.getTileSize().width;let O=!0;const R=e[n],k=e[r-1],L=_?_[R]:t.properties.textSize,D=this.vo(t,L,i,R,k,M,XV,E,s);if(null===D)return gG(m,e,n,r),!1;const N=k-R<=3,F=Math.floor(D/2),z=D%2;for(let B=n;B<r;B+=6){const s=e[B];let a;if(a=F||B!==n||N||u?F||B!==r-6||N||u?LV.call(this,WV,t,L,i,s,M,XV,E,F,I,this.layer,o,h):sG:oG,!a){O=!1,c||gG(m,e,n,r);break}let f=a[2];z&&(f-=Math.PI/2);const d=TU(YV,f,0,l.rotateWithMap,l.pitchWithMap),p=m.length>g.length;let A;if(p){Lm(rG,v[3*s],v[3*s+1],0);const t=Gm(rG,rG),e=-v[3*s+2];if(e){const n=zA(tG,t,e);cm(eG,VV),vm(nG,n),A=am(nG,nG,eG)}}for(let t=0;t<4;t++){const e=2*(s+t);Ly(JV,g[e]/10,g[e+1]/10),By(JV,JV,L/24),Wy(JV,JV,d),h?(Fy(JV,JV,KV),Dy(QV,JV,a),p&&(QV[2]=0,A&&Xm(QV,QV,A))):(Fy(QV,a,KV),Dy(QV,JV,QV)),$V[0]=10*QV[0],$V[1]=10*QV[1],p&&($V[2]=10*QV[2]);const n=(p?3:2)*(s+t);(m[n]!==$V[0]||m[n+1]!==$V[1]||p&&m[n+2]!==$V[2])&&(m.dirty=!0,m[n]=$V[0],m[n+1]=$V[1],p&&(m[n+2]=$V[2]))}}return O}vo(t,e,n,r,i,o,s,a,l){const h=i-r<=3,u=this.getMap();return h?0:FV.call(this,oG,sG,t,e,n,r,i,o,s,a,u.width/u.height,l)}isBoxCollides(t,e,n,r,i,o){return this.isLabelCollides(0,t,e,n,r,i,o)}deleteMesh(t,e){t&&(e&&(Array.isArray(t)?t.forEach((t=>{t&&t.material&&delete t.material.uniforms.texture})):t.material&&delete t.material.uniforms.texture),super.deleteMesh(t,e))}delete(){super.delete(),this.do.dispose(),delete this.co,this.xo&&this.xo.dispose()}isUniqueStencilRefPerTile(){return!1}isEnableTileStencil(){return!this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")}init(){const t=this.regl;this.renderer=new f_(t);const{uniforms:e,extraCommandProps:n}=$U.call(this,this.canvas,this.sceneConfig),r=this.canvas,i={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:r?r.width:1,height:(t,e)=>e.viewport?e.viewport.height:r?r.height:1};n.viewport=i,this.shader=new U_({vert:hV,frag:uV,uniforms:e,extraCommandProps:n});let o=n;if(this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")&&(o=oH({},n),o.stencil=oH({},n.stencil),o.stencil.enable=!0,o.stencil.func.cmp="<",o.stencil.func.ref=(t,e)=>2*e.level+(e.isHalo||0)+1),this.do=new U_({vert:zV,frag:uV,uniforms:e,extraCommandProps:o}),this.pickingFBO){const t=new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+hV,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());t.filter=t=>{const e=t.properties.symbolIndex;return"line"!==this.getSymbol(e).textPlacement};const n=new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+zV,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());n.filter=t=>"line"===t.geometry.properties.textPlacement,this.picking=[t,n]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,r=this.layer.getTileSize().width,i=n?fG:t.projViewMatrix,o=t.cameraToCenterDistance,s=Ly(iG,t.width,t.height);n&&Ly(s,r,r);const a=LB(t.getResolution(),t);return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:i,viewMatrix:t.viewMatrix,cameraToCenterDistance:o,canvasSize:s,glyphSize:CU,gammaScale:1*(this.layer.options.textGamma||1),resolution:t.getResolution(),altitudeScale:a,viewport:n&&e&&e.viewport,textPitchFilter:0,isRenderingTerrain:+!!n}}}function gG(t,e,n,r){for(let i=n;i<r;i+=6){const n=e[i];for(let e=0;e<4;e++){const r=3*(n+e);(t[r]||t[r+1]||t[r+2])&&(t.dirty=!0,t[r]=0,t[r+1]=0,t[r+2]=0)}}}function mG(t,e){const n=t.properties.level-e.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}var AG="#define SHADER_NAME NATIVE_POINT\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerSize;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  gl_PointSize = markerSize;\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const yG={markerFill:[0,0,0],markerOpacity:1,markerSize:10};var vG="#define SHADER_NAME NATIVE_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * vec4(c, 1.);\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#else\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const xG=im([]);const _G=[1,1,1],bG=[1,1,1,1],wG=[0,0],TG=[1,1],MG=[],CG=new n(0,0),SG=new n(0,0),IG=[],PG=[];class EG extends kj{isEnableTileStencil(){return!1}supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isAnimating(){return!1}createMesh(t,e,{tilePoint:n}){if(!this.material)return this.setToRedraw(),null;const{geometry:r,symbolIndex:o}=t,s=this.layer instanceof d,a=new h_(r,this.material);if(this.sceneConfig.animation){_G[2]=.01;const t=[];fm(t,_G),am(t,e,t),e=t}const l=this.getSymbolDef(o),h=this.getFnTypeConfig(o);tj(r,l,h,this.layer);const u=this.getShader(),c=u.getGeometryDefines?u.getGeometryDefines(r):{},f=this.getSymbol(o),p=dH(this.colorCache);if(r.data.aExtrude){c.IS_LINE_EXTRUSION=1;const{tileResolution:t,tileRatio:e}=r.properties,n=this.getMap();Object.defineProperty(a.uniforms,"linePixelScale",{enumerable:!0,get:function(){return e*n.getResolution()/t}}),uH(a.uniforms,"lineWidth",f,"lineWidth",4),uH(a.uniforms,"lineOpacity",f,"lineOpacity",1),uH(a.uniforms,"lineColor",f,"lineColor","#fff",p),Object.defineProperty(a.uniforms,"lineHeight",{enumerable:!0,get:()=>{const t=this.dataConfig.defaultAltitude*(this.dataConfig.altitudeScale||1);return mH(t)?t:0}})}else{uH(a.uniforms,"polygonFill",f,"polygonFill",bG,p),uH(a.uniforms,"polygonOpacity",f,"polygonOpacity",1);const t=[];Object.defineProperty(a.uniforms,"vertexColorsOfType",{enumerable:!0,get:()=>{const e=p(f.bottomPolygonFill||bG),n=p(f.topPolygonFill||bG);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3];const r=a.geometry.properties.vertexColors;if(r){let e=8;t.length=8+r.length;for(let n=0;n<r.length;n++)t[e++]=r[n][0],t[e++]=r[n][1],t[e++]=r[n][2],t[e++]=r[n][3]}return t}})}if(r.data.aColor&&(c.HAS_COLOR=1),r.data.aOpacity&&(c.HAS_OPACITY=1),r.data.aLineWidth&&(c.HAS_LINE_WIDTH=1),r.data.aLineHeight&&(c.HAS_LINE_HEIGHT=1),r.data.aTerrainAltitude&&(c.HAS_TERRAIN_ALTITUDE=1),r.data.aVertexColorType){const t=a.geometry.properties.vertexColors;let e=2;t&&(e+=t.length),c.VERTEX_TYPES_COUNT=e}if(r.data.aOpacity){const t=r.data.aOpacity;for(let e=0;e<t.length;e++)if(t[e]<255){r.properties.hasAlpha=!0;break}}c.HAS_MIN_ALTITUDE=1,c.HAS_LAYER_OPACITY=1,r.generateBuffers(this.regl),a.setDefines(c),a.setPositionMatrix(this.getAltitudeOffsetMatrix()),a.setLocalTransform(e),(r.properties.maxAltitude<=0||a.properties.level>=3)&&(a.castShadow=!1),a.setUniform("maxAltitude",a.geometry.properties.maxAltitude),Object.defineProperty(a.uniforms,"minAltitude",{enumerable:!0,get:()=>this.layer.options.altitude||0});const{tileResolution:g}=r.properties,m=this.getMap(),A=this.layer.getRenderer(),y=m.pointAtResToCoord(new i(n),g),v=function(t,e,n,r){return t.pointAtResToDistance(1,0,r,n)}(m,0,y,g),x=[];Object.defineProperty(a.uniforms,"uvOrigin",{enumerable:!0,get:()=>this.bo(x,o,n,g,v,s)}),a.setUniform("uvOffset",[0,0]),Object.defineProperty(a.uniforms,"hasAlpha",{enumerable:!0,get:()=>{const t=this.getSymbol(o);return r.properties.hasAlpha||t.polygonOpacity<1||t.lineOpacity<1||a.material&&(a.material.uniforms.baseColorTexture||a.material.uniforms.emissiveTexture)}});const _=this.layer.getMap().getMaxNativeZoom();return Object.defineProperty(a.uniforms,"stencilRef",{enumerable:!0,get:()=>A.isForeground(a)?0:_-a.properties.tile.z}),a.properties.symbolIndex=o,a}bo(t,e,n,r,i,o){if(1===this.dataConfig.topUVMode)return t[0]=0,t[1]=0,t;const s=this.getMap(),a=this.getSymbol(e).material;let l=n;!this.dataConfig.side&&a&&a.textureOrigin&&(CG.set(a.textureOrigin[0],a.textureOrigin[1]),s.coordToPointAtRes(CG,r,SG),l=Ly(IG,n[0]-SG.x,n[1]-SG.y));const h=!!a&&a.uvOffsetInMeter;let u=a&&a.uvOffset||wG;const c=this.getUVOffsetAnim();c&&(u=this.getUVOffset(c));const f=a&&a.uvScale||TG;let d=this.dataConfig.side?0:l[0],p=this.dataConfig.side?0:l[1];const g=a&&a.textureWidth||23.25,m=g*f[1]/f[0];h&&(d+=u[0]/i,p+=u[1]/i);const A=h?0:u[0],y=h?0:u[1],v=Ly(t,d*i*f[0]/g+A,p*i*f[1]/m+y);return o||(v[1]*=-1),v}callShader(t,e){const n=this.sceneConfig.cullFace;this.sceneConfig.cullFace="front",this.callBackgroundTileShader(t,e),void 0===n?delete this.sceneConfig.cullFace:this.sceneConfig.cullFace=n,super.callShader(t,e)}getShadowMeshes(){if(!this.isVisible())return MG;this.shadowCount=this.scene.getMeshes().length;const t=this.scene.getMeshes().filter((t=>0===t.properties.level));for(let e=0;e<t.length;e++){const n=t[e];n.material!==this.material&&n.setMaterial(this.material)}return t}getUVOffsetAnim(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}getUVOffset(t){const e=this.getSymbols()[0],n=e.material&&e.material.uvOffset||wG,r=!!e.material&&e.material.uvOffsetInMeter,i=performance.now()/1e3,o=Ly(PG,n[0],n[1]);return o[0]=i*t[0],o[1]=i*t[0],r||(o[0]%=1,o[1]%=1),o}needPolygonOffset(){return this.wo}startFrame(...t){return delete this.wo,super.startFrame(...t)}addMesh(t,e){t.forEach((t=>{this.Pr(t,e)})),super.addMesh(...arguments)}Pr(t,e){if(null!==e){const n=t.localTransform;0===e&&(e=.01),_G[2]=e,fm(n,_G),am(n,t.properties.tileTransform,n),t.setLocalTransform(n)}else t.setLocalTransform(t.properties.tileTransform);t.material!==this.material&&t.setMaterial(this.material),t.geometry.properties.maxAltitude<=0&&(this.wo=!0),this.getSymbol(t.properties.symbolIndex).ssr?t.ssr=1:t.ssr=0}deleteMaterial(){this.material&&(this.material.dispose(),delete this.material)}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++)e||(t[n].geometry.dispose(),delete t[n].geometry.properties.layer),t[n].dispose();else e||(t.geometry.dispose(),delete t.geometry.properties.layer),t.dispose()}updateDataConfig(t,e){return!("line-extrusion"===this.dataConfig.type&&!t.altitudeProperty&&!e.altitudeProperty)}createFnTypeConfig(t,e){const n=oO(e.polygonFill||e.lineColor),r=iO(e.polygonOpacity||e.lineOpacity),i=iO(e.lineWidth),o=new Uint8Array(1),s=new Uint16Array(1),a=e.polygonFill?"polygonFill":e.lineColor?"lineColor":"polygonFill",l=e.polygonOpacity?"polygonOpacity":e.lineOpacity?"lineOpacity":"polygonOpacity";return[{attrName:"aColor",type:Uint8Array,width:4,symbolName:a,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||JO(i).unitArray()),i=fH(i),i}},{attrName:"aOpacity",type:Uint8Array,width:1,symbolName:l,evaluate:(e,n)=>{let i=r(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e,!1)),o[0]=255*i,o[0]<255&&(n.properties.hasAlpha=!0),o[0]}},{attrName:"aLineWidth",type:Uint8Array,width:1,symbolName:"lineWidth",define:"HAS_LINE_WIDTH",evaluate:e=>{const n=i(t.getZoom(),e);return s[0]=Math.round(2*n),s[0]}}]}updateSymbol(t,e){let n=!1;t&&t.material&&(n=function(t,e){for(const n in e)if(RG[n]&&e[n]!==t[n]&&(!t[n]||!e[n]))return!0;return!1}(this.symbolDef[0].material||{},t.material));const r=super.updateSymbol(t,e);return t&&t.material&&this.Ao(t.material),n||r}ir(t,e){return OG(t)!==OG(e)}}function OG(t){if(!t||!t.material)return!1;for(const e in t.material)if(e.indexOf("Texture")>0&&t.material[e])return!0;return!1}const RG={normalTexture:1,bumpTexture:1};class kG extends EG{createGeometry(t){const e=t.data,n=this.getSymbols()[0];if(n.material&&n.material.extrusionOpacity){const t=new Uint8Array(e.aPosition.length/3);for(let n=0;n<e.aPosition.length;n+=3)e.aPosition[n+2]>0?t[n/3]=0:t[n/3]=1;e.aExtrusionOpacity=t}const r=new bx(e,t.indices);return oH(r.properties,t.properties),this.mr(r,t),{geometry:r,symbolIndex:{index:0}}}updateSceneConfig(t){let e;if(this.sceneConfig.cullFace!==t.cullFace&&(e=!0),oH(this.sceneConfig,t),e){const t=this.getShaderConfig();this.shader.dispose(),this.shader=new V_(t)}this.setToRedraw()}getShader(){return this.shader}delete(t){this.getMap().off("updatelights",this.Mo,this),super.delete(t),this.material.dispose()}init(){this.getMap().on("updatelights",this.Mo,this);const t=this.regl;this.renderer=new f_(t);const e=this.getShaderConfig();this.shader=new V_(e),this.Ao();const n={vert:this.getPickingVert(),uniforms:["projViewMatrix","modelMatrix","positionMatrix",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this.pickingViewport}};this.picking=[new Nw(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}Mo(){this.setToRedraw()}getShaderConfig(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1};return{extraCommandProps:{cull:{enable:()=>void 0===this.sceneConfig.cullFace||!!this.sceneConfig.cullFace,face:()=>{let t=this.sceneConfig.cullFace;return!0===t&&(t="back"),t||"back"}},stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e,polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}Ao(){this.material&&this.material.dispose();const t=this.layer instanceof d,e=this.getSymbols()[0].material,n={};for(const r in e)yH(e,r)&&(n[r]=e[r],"uvRotation"===r&&(n[r]=n[r]*Math.PI/180,t||(n[r]*=-1)));this.material=new e_(n)}getUniformValues(t,e){const n=t.viewMatrix,r=t.projMatrix,i=t.cameraPosition,o=this._o(),s=oH({viewMatrix:n,projMatrix:r,cameraPosition:i,projViewMatrix:t.projViewMatrix},o);e&&e.jitter?s.halton=e.jitter:s.halton=[0,0];const a=this.layer.getRenderer().canvas;return s.outSize=[a.width,a.height],s}getPickingVert(){return"\n            attribute vec3 aPosition;\n            uniform mat4 projViewModelMatrix;\n            uniform mat4 modelMatrix;\n            uniform mat4 positionMatrix;\n            //引入fbo picking的vert相关函数\n            #include <fbo_picking_vert>\n            #include <get_output>\n            void main()\n            {\n                mat4 localPositionMatrix = getPositionMatrix();\n                vec4 localPosition = getPosition(aPosition);\n\n                gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n                //传入gl_Position的depth值\n                fbo_picking_setData(gl_Position.w, true);\n            }\n        "}_o(){const t=this.getMap().getLightManager(),e=t&&t.getAmbientLight()||{},n=t&&t.getDirectionalLight()||{};return{ambientColor:e.color||[.2,.2,.2],light0_diffuse:[...n.color||[.1,.1,.1],1],lightSpecular:n.specular||[.8,.8,.8],light0_viewDirection:n.direction||[1,1,-1]}}}const LG=[1,1,1];const{getPBRUniforms:DG}=xT.PBRUtils;class NG extends EG{constructor(...t){super(...t),this.So=new g_(null,this.layer.getURLModifier()),this.scene.sortFunction=this.sortByCommandKey}supportRenderMode(t){return this.getSymbols()[0].ssr?"fxaa"===t||"fxaaAfterTaa"===t:super.supportRenderMode(t)}isAnimating(){const t=this.ko();if(t&&(t[0]||t[1]))return!0}needToRedraw(){const t=this.ko();return!(!t||!t[0]&&!t[1])||super.needToRedraw()}ko(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}createGeometry(t){if(!t.data||!t.data.aPosition||!t.data.aPosition.length)return null;const e={uv0Attribute:"aTexCoord0"};t.data.aAltitude&&(e.altitudeAttribute="aAltitude");const n=new bx(t.data,t.indices,0,e);return oH(n.properties,t.properties),t.vertexColors&&(n.properties.vertexColors=t.vertexColors),this.material.uniforms.normalTexture&&!n.data[n.desc.tangentAttribute]&&n.data[n.desc.uv0Attribute]&&(n.data[n.desc.normalAttribute]||n.createNormal(),n.createTangent()),this.mr(n,t),{geometry:n,symbolIndex:{index:0}}}paint(t){const e=!!t.shadow;t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader,this.Po.dispose(),delete this.Po,this._r(t));let n=!!t.ssr&&this.getSymbols()[0].ssr;const r=this.shader,i=r.shaderDefines;if(n){const e=oH({},i,t.ssr.defines);r.shaderDefines=e}if(t.onlyUpdateDepthInTaa&&(this.shader=this.Po,!n&&this.To&&(this.shader=r,this.setToRedraw(!0))),this.updateIBLDefines(r),super.paint(t),void 0!==this.shadowCount&&e){const t=this.scene.getMeshes().length;this.shadowCount!==t&&this.setToRedraw()}this.shader=r,n&&(r.shaderDefines=i),delete this.shadowCount,this.To=n}updateSceneConfig(t){oH(this.sceneConfig,t),this.setToRedraw()}delete(){super.delete(),this.disposeIBLTextures(),this.material.dispose(),this.Po&&(this.Po.dispose(),delete this.Po)}init(t){this.getMap().on("updatelights",this.Io,this),this.createIBLTextures(),this.Tr=this.Tr||t;const e=this.regl;this.renderer=new f_(e),this.Fo=this.Co.bind(this),this.Oo=this.disposeCachedTexture.bind(this),this.Eo=this.Do.bind(this),this.Ao(),this._r(t);const n={vert:"\n                #include <gl2_vert>\n                attribute vec3 aPosition;\n                uniform mat4 projViewModelMatrix;\n                uniform mat4 positionMatrix;\n                //引入fbo picking的vert相关函数\n                #include <line_extrusion_vert>\n                #include <get_output>\n                #include <fbo_picking_vert>\n                void main() {\n                    mat4 localPositionMatrix = getPositionMatrix();\n                    #ifdef IS_LINE_EXTRUSION\n                        vec3 linePosition = getLineExtrudePosition(aPosition);\n                        vec4 localVertex = getPosition(linePosition);\n                    #else\n                        vec4 localVertex = getPosition(aPosition);\n                    #endif\n\n                    gl_Position = projViewModelMatrix * localPositionMatrix * localVertex;\n                    fbo_picking_setData(gl_Position.w, true);\n                }\n            ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am([],e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<=",mask:!!lH(this.sceneConfig.depthMask)||this.sceneConfig.depthMask}}};this.picking=[new Nw(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}_r(t){const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={},r=[];r.push(...rb.getUniformDeclares()),this.fillIncludes(n,r,t);const i={cull:{enable:(t,e)=>!(e.geometryProperties.hasNegativeHeight||void 0!==this.sceneConfig.cullFace&&!this.sceneConfig.cullFace),face:()=>this.sceneConfig.cullFace||"back"},stencil:{enable:!1},viewport:e,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:(t,e)=>void 0===e.hasAlpha||!!e.hasAlpha,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}},o={uniforms:r,defines:this.Lo(n),extraCommandProps:i};this.shader=new xT.StandardShader(o),o.frag="\n            precision mediump float;\n            #include <gl2_frag>\n            void main() {\n                glFragColor = vec4(0.0);\n                #if __VERSION__ == 100\n                    gl_FragColor = glFragColor;\n                #endif\n            }\n        ",this.Po=new xT.StandardShader(o)}Co({resources:t}){for(let e=0;e<t.length;e++)this.addCachedTexture(t[e].url,t[e].data);this.setToRedraw(!0)}Do(){this.setToRedraw(!0)}Ao(t){if(t){const e=this.getSymbols()[0].material;e&&oH(e,t)}const e=this.layer instanceof d,n=this.dataConfig,r=t||this.getSymbols()[0].material,i={};let o=!1;for(const s in r)if(yH(r,s))if(s.indexOf("Texture")>0){let t=r[s];if(!t){i[s]=void 0;continue}const e="string"==typeof t?t:t.url,a=this.getCachedTexture(e);a?a.then?e===t?t={promise:a,wrap:"repeat"}:t.promise=a:e===t?t={data:a,wrap:"repeat"}:t.data=a:e===t&&(t={url:e,wrap:"repeat"}),t.flipY=!n.upsideUpTexture,t.min="linear mipmap linear",t.mag="linear",i[s]=new O_(t,this.So),i[s].once("complete",this.Fo),i[s].once("disposed",this.Oo),i[s].promise&&this.addCachedTexture(e,i[s].promise),o=!0}else i[s]=r[s],"uvRotation"===s&&(i[s]=Math.PI*i[s]/180,e||(i[s]*=-1));if(void 0===i.alphaTest&&this.getMaterialClazz&&(i.alphaTest=.05),this.material){for(let t in i)this.material.set(t,i[t]);this.setToRedraw(!0)}else this.material=new xT.StandardMaterial(i),this.material.once("complete",this.Eo);o||this.Do()}getShader(){return this.shader}getUniformValues(t,e){const{iblTexes:n,dfgLUT:r}=this.getIBLRes(),i=DG(t,n,r,e&&e.ssr,e&&e.jitter);return this.setIncludeUniformValues(i,e),i}Lo(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}Io(){if(!this.shader)return;const t=this.shader.shaderDefines;this.Lo(t),this.shader.shaderDefines=t}}var FG="#include <gl2_vert>\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\nuniform mat4 projViewModelMatrix;\nuniform vec2 centiMeterToLocal;\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aTubeNormal;\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#include <vt_position_vert>\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#else\nuniform mat4 modelViewMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelMatrix;\n#if defined(HAS_PATTERN)\nuniform float resolution;\nuniform float tileResolution;\nuniform float tileRatio;\nattribute float aLinesofar;\nvarying highp float vLinesofar;\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvarying float vPatternHeight;\nattribute float aNormalDistance;\n#if defined(HAS_PATTERN_ANIM)\nattribute float aLinePatternAnimSpeed;\nvarying float vLinePatternAnimSpeed;\n#endif\n#if defined(HAS_PATTERN_GAP)\nattribute float aLinePatternGap;\nvarying float vLinePatternGap;\n#endif\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\nvarying vec3 vModelVertex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\nvoid main() {\n  \n#ifdef HAS_LINE_WIDTH\nfloat c = aLineWidth;\n#else\nfloat c = lineWidth;\n#endif\nfloat d = c / 2.;\n  vec3 e = aTubeNormal.xyz / EXTRUDE_SCALE;\n  vec3 f = unpackVTPosition();\n  vec4 h = vec4(f, 1.);\n  h.xy += e.xy * d * centiMeterToLocal;\n  h.z += e.z * d;\n  gl_Position = projViewModelMatrix * h;\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#else\nvViewVertex = modelViewMatrix * h;\n  vec3 i = normalize(e);\n  vModelNormal = modelNormalMatrix * i;\n  vModelVertex = (modelMatrix * h).xyz;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(h);\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_PATTERN\nfloat j = tileResolution / resolution;\n  float k = aLinesofar - d * centiMeterToLocal.y * aNormalDistance / EXTRUDE_SCALE;\n  vLinesofar = k / tileRatio * j;\n  vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n  vPatternHeight = c * centiMeterToLocal.x / tileRatio * j;\n  vNormalY = aTubeNormal.w / EXTRUDE_SCALE;\n#if defined(HAS_PATTERN_ANIM)\nvLinePatternAnimSpeed = aLinePatternAnimSpeed / 127.;\n#endif\n#if defined(HAS_PATTERN_GAP)\nvLinePatternGap = aLinePatternGap / 10.0;\n#endif\n#endif\nhighlight_setVarying();\n#endif\n}";const{getPBRUniforms:zG}=xT.PBRUtils;class BG extends Nj{needToRedraw(){return super.needToRedraw()||this.isAnimating()}isTerrainSkin(){return!1}isTerrainVector(){return!0}isUniqueStencilRefPerTile(){return!1}supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isAnimating(){if(this.Sr)return!0;const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e].linePatternFile&&t[e].linePatternAnimSpeed)return!0;return!1}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).lineBloom}createMesh(t,e){if(!t.geometry)return null;const n=this.getMap(),{geometry:r,symbolIndex:i,ref:o}=t,s=this.getSymbolDef(i);void 0===o&&tj(r,s,this.getFnTypeConfig(i),this.layer);const a=this.getSymbol(i),{tileResolution:l,tileRatio:h}=r.properties,u={tileResolution:l,tileRatio:h};uH(u,"lineColor",a,"lineColor","#fff",dH(this.colorCache)),uH(u,"linePatternGapColor",a,"linePatternGapColor",[1,1,1,1],dH(this.colorCache)),uH(u,"lineWidth",a,"lineWidth",2,(t=>{var e;return("centimeter"===(e=this.dataConfig.metric)||"cm"===e?1:"millimeter"===e||"mm"===e?.1:100)*t})),uH(u,"lineOpacity",a,"lineOpacity",1),uH(u,"linePatternAnimSpeed",a,"linePatternAnimSpeed",0),uH(u,"linePatternGap",a,"linePatternGap",0),uH(u,"metallicFactor",a,"metallicFactor",0),uH(u,"roughnessFactor",a,"roughnessFactor",.4),uH(u,"emissiveFactor",a,"emissiveFactor",[0,0,0]),uH(u,"uvScale",a,"uvScale",[1,1]);const c=r.properties.iconAtlas,f=this.layer instanceof d;c&&(u.linePatternFile=zj(this.regl,c,!1),u.atlasSize=c?[c.width,c.height]:[0,0],u.flipY=f?-1:1,this.drawDebugAtlas(c)),void 0===o&&r.generateBuffers(this.regl),u.alphaTest=-1;const p=new xT.StandardMaterial(u),g=new h_(r,p,{castShadow:!1,picking:!0}),m=n.distanceToPointAtRes(100,100,r.properties.tileResolution)._multi(h/1e4).toArray();g.setUniform("centiMeterToLocal",m);const A=n.getResolution(n.getMaxNativeZoom());g.setUniform("animSpeedScale",l/A),g.setLocalTransform(e);const y={IS_LINE_EXTRUSION:1,HAS_LAYER_OPACITY:1};return"square-tube"===this.dataConfig.type&&(y.IS_SQUARE_TUBE=1),c&&(y.HAS_PATTERN=1),g.properties.symbolIndex=i,r.data.aColor&&(y.HAS_COLOR=1),this.setMeshDefines(y,r,s),r.data.aAltitude&&(y.HAS_ALTITUDE=1),g.setDefines(y),g}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),cj(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),cj(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){t.states&&t.states.includesChanged.shadow&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}init(t){this.getMap().on("updatelights",this.Io,this),this.createIBLTextures();const e=this.regl;if(this.renderer=new f_(e),this.createShader(t),this.pickingFBO){const t=[];this.picking=[new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+FG,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelNormalMatrix",type:"function",fn:(e,n)=>Wg(t,n.modelMatrix)}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(t){this.Tr=t;const e=[],n={};this.fillIncludes(n,e,t),e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}),this.shader=new xT.StandardShader({vert:FG,uniforms:e,defines:this.Lo(n),extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},n=this.sceneConfig.depthRange;return{viewport:e,stencil:{enable:!0,func:{cmp:()=>"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:()=>!!this.sceneConfig.cullFace,face:this.sceneConfig.cullFace||"back"},depth:{enable:!0,range:n||[0,1],mask:this.sceneConfig.depthMask||!0,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const{iblTexes:n,dfgLUT:r}=this.getIBLRes(),i=zG(t,n,r,null,e&&e.jitter),o=t.projViewMatrix,s=t.viewMatrix;return i.projViewMatrix=o,i.viewMatrix=s,i.resolution=t.getResolution(),i.currentTime=this.layer.getRenderer().getFrameTimestamp()||0,this.setIncludeUniformValues(i,e),i}createFnTypeConfig(t,e){const n=oO(e.lineColor),r=oO(e.aLinePatternAnimSpeed),i=oO(e.aLinePatternGap),o=this.createShapeFnTypeConfigs(t,e),s=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||JO(i).unitArray()),i=fH(i),i}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,o)=>{let a=r(t.getZoom(),e);return lH(a)&&(a=0),0!==a&&(n.properties.hasPatternAnim=1),s[0]=a/127,s[1]=i[o+1],s}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,r,o)=>{let a=i(t.getZoom(),e);return lH(a)&&(a=0),s[1]=10*a,s[0]=r[o],s}}].concat(o)}createShapeFnTypeConfigs(t,e){const n=iO(e.lineWidth),r=iO(e.lineOpacity),i=new Uint16Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,r)=>{let o=n(t.getZoom(),e);return nO(o)&&(o=this.evaluateInFnTypeConfig(o,r,t,e)),i[0]=Math.round(2*o),i[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let o=r(t.getZoom(),e);return nO(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e)),i[0]=255*o,i[0]}}]}Lo(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}Io(){if(!this.shader)return;const t=this.shader.shaderDefines;this.Lo(t),this.shader.shaderDefines=t}delete(){super.delete(),this.disposeIBLTextures(),this.shader&&(this.shader.dispose(),delete this.shader)}}const HG=[],jG=[],UG=[],VG=[],GG=[],WG=[0,0,0],qG=[0,0,0],XG=[1,1,1],ZG=[],YG=[1,1,1,1],JG=[],QG=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],KG=t=>class extends t{constructor(t,e,n,r,i,o){super(t,e,n,r,i,o),this.Ro=!1,this.scene.sortFunction=this.sortByCommandKey;const s=r.fetchOptions||{};s.referrer=window&&window.location.href,this.Ho=new Jb(t,{fetchOptions:s,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}}),this.zo(),this.No()}isUniqueStencilRefPerTile(){return!1}isAnimating(){const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e]&&this.Vo[e]&&this.Uo(e))return!0;return!1}createGeometry(t,e){const{data:n,positionSize:r}=t;return{geometry:{properties:oH({},t.properties),data:n,positionSize:r,features:e},symbolIndex:t.symbolIndex}}getFnTypeConfig(){return ZG}createMesh(t,e,{tileTranslationMatrix:n,tileExtent:r},{timestamp:i}){if(!this.Ro)return null;const o=this.getMap(),{geometry:s}=t,{positionSize:a,features:l}=s,{aPosition:h,aPickingId:u,aXYRotation:c,aZRotation:f,aAltitude:d}=s.data,p=h.length/a;if(0===p)return null;const g={instance_vectorA:new Float32Array(4*p),instance_vectorB:new Float32Array(4*p),instance_vectorC:new Float32Array(4*p),aPickingId:[]},m=this.jo(g,n,r,s.properties.z,h,d,c,f,a,u,l);s.data.aTerrainAltitude&&(g.aTerrainAltitude=s.data.aTerrainAltitude);const A={};for(const w in g)A[w]={buffer:this.regl.buffer({dimension:g[w].length/p,data:g[w]}),divisor:1};const y=this.Go(),v=this.Bo(),x=im([]);hm(x,x,[v,v,v]);const _=[],b=this.getSymbols();for(let w=0;w<b.length;w++){const t=b[w],e=this.$o[w];if(!e)continue;const r=this.Vo[w][0],{fixSizeOnZoom:a}=t;let l=im([]);y||(l=this.Wo(l));let h=0;e.forEach((e=>{const{geometry:n,nodeMatrix:r}=e;am(JG,QG,r),am(JG,l,JG);const i=am(JG,x,JG),o=n.boundingBox.copy();o.transform(i);const s=this.Xo(o,t);Math.abs(s)>Math.abs(h)&&(h=s)}));const u=[0,0,h],c=e.map(((e,c)=>{const{geometry:f,materialInfo:d,morphWeights:y,extraInfo:v,nodeIndex:_}=e;t.alphaTest&&(d.alphaTest=t.alphaTest);const b=new(this.getMaterialClazz(d))(d),T={},M=new u_(A,p,f,b,{transparent:!1,picking:!0});if(r.hasSkinAnimation()){const t=this.Yo(M,w,0)[_];M.setUniform("jointTexture",t.jointTexture),M.setUniform("jointTextureSize",t.jointTextureSize),M.setUniform("numJoints",t.numJoints),M.setUniform("skinAnimation",+this.Uo(w)),M.properties.startTime=i,T.HAS_SKIN=1}y&&(M.setUniform("morphWeights",y),T.HAS_MORPH=1),M.setUniform("hasAlpha",v.alphaMode&&"BLEND"===v.alphaMode.toUpperCase()),uH(M.uniforms,"polygonFill",t,"markerFill",YG,dH(this.colorCache)),uH(M.uniforms,"polygonOpacity",t,"markerOpacity",1);const C=[];M.setPositionMatrix((()=>{const t=this.qo(w,c,_);am(C,QG,t),am(C,l,C),am(C,x,C);const e=im(JG);if(0!==h&&(cm(e,u),am(C,e,C)),mH(a)){const t=o.getGLScale()/o.getGLScale(a);return Lm(HG,t,t,t),fm(e,HG),am(e,e,C)}return C}));const S=this.layer.getRenderer().getZScale(),I=[],P=[];return M.setLocalTransform((()=>{const t=this.layer.options.altitude||0;return km(P,m),P[2]+=100*t*S,lm(I,n,P),I})),f.generateBuffers(this.regl,{excludeElementsInVAO:!0}),g.instance_color&&(T.HAS_INSTANCE_COLOR=1),g.aTerrainAltitude&&(T.HAS_INSTANCE_TERRAIN_ALTITUDE=1,M.setUniform("terrainAltitudeScale",100*this.layer.getRenderer().getZScale())),T.HAS_LAYER_OPACITY=1,oH(M.properties,s.properties),M.setDefines(T),M.properties.symbolIndex={index:w},M}));_.push(...c)}return _.insContext={instanceData:g,tileTranslationMatrix:n,tileExtent:r,aPosition:h,positionSize:a},_}qo(t,e,n){const r=t,i=this.$o[r][e];return this.Uo(t)&&this.Jo&&this.Jo[n]||i.nodeMatrix}Yo(t,e,n){if(!this.Vo)return;const r=this.Vo[e][0];this.Ko||(this.Ko={}),this.Jo={},this.Ko[t.uuid]||(this.Ko[t.uuid]={});const i=this.getSymbols()[e],o=this.Zo[e],{loop:s,speed:a,animationName:l}=i,h=l||o.animations[0].name;return r.updateAnimation(n,s||!1,a||1,h,t.properties.startTime||0,this.Jo,this.Ko[t.uuid]),this.Ko[t.uuid]}Xo(t,e){const n=e.anchorZ||"center";let r=0;const i=t.max[2]-t.min[2];return"bottom"===n?r=i/2:"top"===n&&(r=-i/2),r}addMesh(t,e,n){if(!t)return null;if(t[0].properties.level>2)return null;const r=n.timestamp;for(let i=0;i<t.length;i++){if(!t[i]||!t[i].geometry)continue;t[i].instancedData.aTerrainAltitude&&this.$i(t[i],t[i].instancedData,t[i].properties,3,n);const e=t[i].properties.symbolIndex.index,o=this.Uo(e);o&&this.Yo(t[i],e,r),t[i].setUniform("skinAnimation",+o)}return this.scene.addMesh(t),this}gr(t,e){t&&t.updateInstancedData&&t.updateInstancedData("aTerrainAltitude",e)}prepareRender(t){const e=this.getSymbols();let n=!1;for(let r=0;r<e.length;r++)if(e[r]&&this.Vo[r]&&this.Uo(r)&&this.Vo[r]&&!n){n=!0;break}n&&this.setToRedraw(!0),super.prepareRender(t)}getShadowMeshes(){return this.isVisible()?(this.shadowCount=this.scene.getMeshes().length,this.scene.getMeshes().filter((t=>0===t.properties.level))):ZG}Uo(t){const e=this.getSymbols()[t];return!!(e&&e.animation&&this.Vo[t]&&this.Vo[t][0]&&this.Vo[t][0].hasSkinAnimation())}jo(t,e,n,r,i,o,s,a,l,h,u){function c(e,n,r,i){t[e][4*n]=r[i],t[e][4*n+1]=r[i+4],t[e][4*n+2]=r[i+8],t[e][4*n+3]=r[i+12]}const f=i.length/l,d=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(r),p=this.layer.getRenderer().getZScale(),g=100*(this.dataConfig.altitudeOffset||0);let m=1/0,A=1/0,y=1/0,v=-1/0,x=-1/0,_=-1/0;const b=[],w=[];for(let E=0;E<f;E++){o?Lm(w,i[E*l],i[E*l+1],o[E]):vL(w,i[E*l],i[E*l+1],i[E*l+2]);const t=Lm(b,w[0]*d,-w[1]*d,(w[2]+g)*p);t[0]<m&&(m=t[0]),t[0]>v&&(v=t[0]),t[1]<A&&(A=t[1]),t[1]>x&&(x=t[1]),t[2]<y&&(y=t[2]),t[2]>_&&(_=t[2])}const T=(m+v)/2,M=(A+x)/2,C=(y+_)/2,S=[],I=this.Go(),P=[0,0,1];for(let E=0;E<f;E++){o?Lm(w,i[E*l],i[E*l+1],o[E]):vL(w,i[E*l],i[E*l+1],i[E*l+2]);const e=w[0],n=w[1],r=Lm(b,e*d-T,-n*d-M,(w[2]+g)*p-C),f=s&&s[E]||0,m=a&&a[E]||0;if(f||m){dm(S,m,P);const t=Lm(HG,e,n,0);um(S,S,f,Gm(t,qm(t,t,P)));am(S,cm(JG,r),S)}else cm(S,r);if(I){am(S,S,this.Wo(JG,u,h,E))}c("instance_vectorA",E,S,0),c("instance_vectorB",E,S,1),c("instance_vectorC",E,S,2),t.aPickingId[E]=E}return Lm(b,T,M,C),b}Bo(){if(!this.Qo){const t=this.getMap();this.Qo=100*LB(t.getGLRes(),t)}return this.Qo}Wo(t,e,n,r){const i=this.getMap(),o=this.symbolDef[0],s=this.Bo();let a=o.translationX||0,l=o.translationY||0,h=o.translationZ||0,u=o.rotationX||0,c=o.rotationY||0,f=o.rotationZ||0,d=o.scaleX||1,p=o.scaleY||1,g=o.scaleZ||1;const m=n&&n[r],A=e&&e[m],y=i.getZoom(),v=A&&A.feature&&A.feature.properties,x=this.ta(y,v);this.ea&&(a=this.ea(y,v)),this.na&&(l=this.na(y,v)),this.ia&&(h=this.ia(y,v));const _=Lm(jG,a*s,l*s,h*s);this.ra&&(u=this.ra(y,v)),this.sa&&(c=this.sa(y,v)),this.oa&&(f=this.oa(y,v));const b=Lm(UG,u,c,f);this.aa&&(d=this.aa(y,v)),this.la&&(p=this.la(y,v)),this.ha&&(g=this.ha(y,v));const w=Lm(VG,d*x,p*x,g*x);return this.ua(t,_,b,w)}ta(t,e){const n=this.symbolDef[0];let r=this.ca?this.ca(t,e):n.modelHeight;if(EB(r))return 1;const i=this.fa[0];return r/Math.abs(i.max[1]-i.min[1])}getShaderConfig(){const t=super.getShaderConfig();return t.positionAttribute="POSITION",t.normalAttribute="NORMAL",t}init(t){super.init(t),this.No()}zo(){const t=this.symbolDef[0];nO(t.modelHeight)&&(this.ca=iO(t.modelHeight)),nO(t.translationX)&&(this.ea=iO(t.translationX)),nO(t.translationY)&&(this.na=iO(t.translationY)),nO(t.translationZ)&&(this.ia=iO(t.translationZ)),nO(t.rotationX)&&(this.ra=iO(t.rotationX)),nO(t.rotationY)&&(this.sa=iO(t.rotationY)),nO(t.rotationZ)&&(this.oa=iO(t.rotationZ)),nO(t.scaleX)&&(this.aa=iO(t.scaleX)),nO(t.scaleY)&&(this.la=iO(t.scaleY)),nO(t.scaleZ)&&(this.ha=iO(t.scaleZ))}Go(){return!!(this.ca&&!this.ca.isFeatureConstant||this.ea&&!this.ea.isFeatureConstant||this.na&&!this.na.isFeatureConstant||this.ia&&!this.ia.isFeatureConstant||this.ra&&!this.ra.isFeatureConstant||this.sa&&!this.sa.isFeatureConstant||this.oa&&!this.oa.isFeatureConstant||this.aa&&!this.aa.isFeatureConstant||this.la&&!this.la.isFeatureConstant||this.ha&&!this.ha.isFeatureConstant)}No(){if(this.Vo)return;this.Vo=[],this.Zo=[],this.fa=[],this.$o=[];const t=this.getSymbols();this.da=0;for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.Ho.loginGLTF(n);const r=this.Ho.getGLTF(n);if(r.then)r.then((n=>{if(!n.gltfPack)return this.da++,void(this.da>=t.length&&(this.Ro=!0,this.setToRedraw(!0)));const{gltfPack:r,json:i,bbox:o}=n;this.Vo[e]=[r],this.$o[e]=r.getMeshesInfo(),this.Zo[e]=i,this.fa[e]=o,this.da++,this.da>=t.length&&(this.Ro=!0),this.setToRedraw(!0)}));else{const{gltfPack:t,json:n,bbox:i}=r;t&&(this.Vo[e]=[t],this.$o[e]=t.getMeshesInfo(),this.Zo[e]=n,this.fa[e]=i,this.da++)}}this.da>=t.length&&(this.Ro=!0)}getPickingVert(){return"\n    attribute vec3 aPosition;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 modelMatrix;\n    uniform mat4 positionMatrix;\n    //引入fbo picking的vert相关函数\n    #include <fbo_picking_vert>\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        //传入gl_Position的depth值\n        fbo_picking_setData(gl_Position.w, true);\n    }"}deleteMesh(t){if(t){this.scene.removeMesh(t);for(let e=0;e<t.length;e++){const n=this.Ko&&this.Ko[t[e].uuid];if(n){for(const t in n)n[t].jointTexture&&n[t].jointTexture.destroy();delete this.Ko[t[e].uuid]}t[e].disposeInstancedData(),t[e].dispose()}}}delete(){super.delete();const t=this.getSymbols();for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.Ho.logoutGLTF(n)}if(this.Ko){for(const t in this.Ko){const e=this.Ko[t];for(const t in e)e[t].jointTexture&&e[t].jointTexture.destroy()}delete this.Ko}delete this.Jo}ua(t,e,n,r){const i=Lm(HG,...e||WG),o=n||qG,s=r||XG;return ym(t,XA(GG,o[0],o[1],o[2]),i,s)}};class $G extends(KG(kG)){getMaterialClazz(t){return t.diffuseFactor?s_:e_}}class tW extends(KG(NG)){getMaterialClazz(t){return t.specularGlossinessTexture||t.diffuseTexture?xT.StandardSpecularGlossinessMaterial:xT.StandardMaterial}}const{getPBRUniforms:eW}=xT.PBRUtils,nW={color:[2.0303,2.028,2.028],direction:[0,-.2717,-1]},rW=.3737,iW={index:0},oW=[0,0,0],sW=[2,2];class aW extends Nj{supportRenderMode(t){return"fxaa"===t||"fxaaBeforeTaa"===t}needPolygonOffset(){return!0}isTerrainSkin(){return!1}isTerrainVector(){return!0}needToRedraw(){return!!super.needToRedraw()||this.getSymbol(iW).animation}createMesh(t,e){const{geometry:n}=t;n.generateBuffers(this.regl);const r=new h_(n,null,{castShadow:!1,picking:!0});return r.properties.symbolIndex=iW,r.setLocalTransform(e),r}callShader(t,e){super.callShader(t,e),this.transformWater();const n=this.pa(this.getMap(),e);this.Xi+=this.renderer.render(this.ma,n,this.ya,this.getRenderFBO(e))}addMesh(t,e){this.Pr(t,e),super.addMesh(...arguments)}Pr(t){const e=this.getSymbol(iW).ssr;for(let n=0;n<t.length;n++)t[n].ssr=e?1:0}paint(t){t.states&&t.states.includesChanged&&(this.shader.dispose(),this.ma.dispose(),this._r(t));const e=!!t.ssr&&this.getSymbol(iW).ssr,n=this.ma,r=n.shaderDefines;if(e){const e=oH({},r,t.ssr.defines);n.shaderDefines=e}this.updateIBLDefines(n),this.ga.ssr=e?1:0,super.paint(t),e&&(n.shaderDefines=r)}isEnableTileStencil(){return!1}init(t){this.createIBLTextures();const e=this.regl;this.renderer=new f_(e),this.createGround(),this._r(t),this.pickingFBO&&(this.picking=[new Nw(this.renderer,{vert:Fj,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]),this.va()}va(){const t=this.regl;this.xa||(this.xa=t.texture(2));const e=this.layer.getURLModifier(),n=this.getSymbol({index:0}),r=n.texWaveNormal,i=this.getCachedTexture(r),o=this;if(i)this.ba||(i.isLoading?setTimeout((()=>{this.shader&&this.va()}),20):this.ba=this.wa(t,i));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,o.ba=o.wa(t,this),o.setToRedraw()},n.onerror=()=>{console.error("invalid water wave normal texture:"+r)},this.addCachedTexture(r,n),n.src=e&&e(r)||r}const s=n.texWavePerturbation,a=this.getCachedTexture(s);if(a)this.Aa||(a.isLoading?setTimeout((()=>{this.va(),this.shader}),20):this.Aa=this.wa(t,a));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,o.Aa=o.wa(t,this),o.setToRedraw()},n.onerror=()=>{console.error("invalid water wave perturbation texture:"+s)},this.addCachedTexture(s,n),n.src=e&&e(s)||s}}wa(t,e){return this.xa?t.texture({width:e.width,height:e.height,mag:"linear",min:"linear mipmap linear",wrapS:"repeat",wrapT:"repeat",flipY:!0,data:e}):null}_r(t){const e=this.canvas,n=[],r=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=am([],e.viewMatrix,e.modelMatrix),r=sm(n,n);return Wg([],om(r,r))}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>am([],e.viewMatrix,e.modelMatrix)},{name:"environmentTransform",type:"function",fn:(t,e)=>{const r=e.environmentOrientation||0;return Jg(n,Math.PI*r/180)}}],i={TIME_NOISE_TEXTURE_REPEAT:rW};this.fillIncludes(i,r,t);const o={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},s=this.sceneConfig.depthRange;this.shader=new U_({vert:"\n                attribute vec3 aPosition;\n\n                uniform mat4 projViewModelMatrix;\n                uniform float minAltitude;\n\n                void main() {\n                    vec3 position = aPosition;\n                    position.z += minAltitude * 100.0;\n                    gl_Position = projViewModelMatrix * vec4(position, 1.);\n                }\n            ",frag:"\n    #define SHADER_NAME WATER_STENCIL\n    precision mediump float;\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:o,colorMask:[!1,!1,!1,!1],stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:s||[0,1],func:this.sceneConfig.depthFunc||"<="},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}});const a={viewport:o,stencil:{enable:!0,mask:255,func:{cmp:"==",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!1}};r.push(...rb.getUniformDeclares()),this.ma=new U_({vert:"#define SHADER_NAME WATER\nuniform mat4 modelMatrix;\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform vec2 uvOffset;\nuniform vec2 noiseUvOffset;\nuniform vec2 uvScale;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\n#ifdef HAS_SSR\nuniform mat4 modelViewMatrix;\nvarying vec4 vViewVertex;\n#endif\n#include <highlight_vert>\nmat3 c(in vec3 d) {\n  vec3 t = normalize(cross(d, vec3(.0, 1., .0)));\n  vec3 e = normalize(cross(d, t));\n  return mat3(t, e, d);\n}\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_vert>\n#endif\nconst vec3 f = vec3(0., 0., 1.);\nvoid main(void) {\n  vec4 h = vec4(aPosition, 1.);\n  vec4 i = modelMatrix * h;\n  vPos = i.xyz;\n  vTbnMatrix = c(f);\n  gl_Position = projViewModelMatrix * h;\n  vUv = aTexCoord * uvScale + uvOffset;\n  vNoiseUv = aTexCoord * uvScale * TIME_NOISE_TEXTURE_REPEAT + noiseUvOffset;\n#ifdef HAS_SSR\nvec4 j = modelViewMatrix * h;\n  vViewVertex = j;\n#endif\n#if defined(HAS_SHADOWING)\nshadow_computeShadowPars(h);\n#endif\nhighlight_setVarying();\n}",frag:"#define SHADER_NAME WATER\nprecision highp float;\nprecision highp sampler2D;\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nuniform float layerOpacity;\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform sampler2D brdfLUT;\nuniform mat3 environmentTransform;\nuniform vec3 diffuseSPH[9];\nvec3 c(const in vec3 d) {\n  vec3 e = environmentTransform * d;\n  float x = e.x;\n  float y = e.y;\n  float z = e.z;\n  vec3 f = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    f = hsv_apply(f, hdrHSV);\n  }\n  return max(f, vec3(.0));\n}\nvec3 h(const in vec3 i, const in float j, const in float k, const in float l) {\n  vec4 rgba = texture2D(brdfLUT, vec2(k, j));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float m = 1. / 65535.;\n  return (i * a + b * l) * m;\n}\n#else\nuniform vec3 ambientColor;\n#endif\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nvec3 o(const in vec4 u, const in float v) {\n  if(v <= .0)\n    return u.rgb;\n  return v * u.rgb * u.a;\n}\n#ifdef HAS_SSR\nvarying vec4 vViewVertex;\nuniform mat3 modelViewNormalMatrix;\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nuniform vec2 cameraNearFar;\nfloat A(const in vec4 B) {\n  return B.r + B.g / 255.;\n}\nfloat C(const in vec2 D, const in float E) {\n  vec3 F = vec3(.06711056, .00583715, 52.9829189);\n  return fract(F.z * fract(dot(D.xy + E * vec2(47., 17.) * .695, F.xy))) * .5;\n}\nvec3 G(const in float H, const in float I, const in vec2 J) {\n  float K = min(I - .01, H);\n  float L = floor(K);\n  float M = min(I, L + 1.);\n  float N = pow(2., M);\n  vec2 O = 2. * N / J;\n  if(K - L > .5)\n    N *= 2.;\n  return vec3(O, N);\n}\nvec2 P(const in vec2 Q, const in vec3 R) {\n  vec2 S = max(R.xy, min(1. - R.xy, Q));\n  return vec2(2. * S.x, R.z - 1. - S.y) / R.z;\n}\nvec3 T(const in mat4 U, const in vec3 V) {\n  vec4 W = U * vec4(V, 1.);\n  return vec3(.5 + .5 * W.xy / W.w, W.w);\n}\nvec3 X(const in float Y, const in vec2 S) {\n  return texture2D(TextureReflected, S).rgb;\n}\nfloat Z(float ba) {\n  highp mat4 U = projMatrix;\n  highp float z = ba * 2. - 1.;\n  return -U[3].z / (z + U[2].z);\n}\nfloat bb(const vec2 S) {\n  float ba = A(texture2D(TextureDepth, S));\n  return ba;\n}\nvec3 bc(const in float E, const in vec3 bd, const in vec3 be, const in vec3 bf, const in vec3 bg, const in float bh) {\n  vec2 bi;\n  bi.x = C(gl_FragCoord.yx, E);\n  bi.y = fract(bi.x * 52.9829189);\n  bi.y = mix(bi.y, 1., .7);\n  float bj = 2. * 3.14159 * bi.x;\n  float bk = pow(max(bi.y, .000001), bh / (2. - bh));\n  float bl = sqrt(1. - bk * bk);\n  vec3 bm = vec3(bl * cos(bj), bl * sin(bj), bk);\n  bm = bm.x * bd + bm.y * be + bm.z * bf;\n  return normalize((2. * dot(bg, bm)) * bm - bg);\n}\nfloat bn(const in float E) {\n  return (C(gl_FragCoord.xy, E) - .5);\n}\nvec3 bo(const in vec3 bp, const in float bq, const in vec3 br) {\n  vec3 bs = T(projMatrix, vViewVertex.xyz + br * bq);\n  bs.z = 1. / bs.z;\n  bs -= bp;\n  float bt = min(1., .99 * (1. - bp.x) / max(1e-5, bs.x));\n  float bu = min(1., .99 * (1. - bp.y) / max(1e-5, bs.y));\n  float bv = min(1., .99 * bp.x / max(1e-5, -bs.x));\n  float bw = min(1., .99 * bp.y / max(1e-5, -bs.y));\n  return bs * min(bt, bu) * min(bv, bw);\n}\nfloat bx(const in vec3 bp, const in vec3 bs, inout float by, inout float bz) {\n  float bA = (bz + by) * .5;\n  vec3 bB = bp + bs * bA;\n  float z = bb(bB.xy);\n  float ba = Z(z);\n  float bC = -1. / bB.z;\n  by = ba > bC ? by : bA;\n  bz = ba > bC ? bA : bz;\n  return bA;\n}\nvec4 bD(const in vec3 bp, const in float bq, in float bE, const in vec3 br, const in float j, const in float E) {\n  const int bF = 20;\n  float bG = 1. / float(bF);\n  bE *= bG;\n  vec3 bs = bo(bp, bq, br);\n  float bH = bG;\n  vec3 bI = vec3(.0, bH, 1.);\n  vec3 bB;\n  float z, ba, bC, bJ, bK, bL;\n  bool bM;\n  float bN = 1.;\n  float bA;\n  for(int bO = 0; bO < bF; bO++) {\n    bB = bp + bs * bI.y;\n    z = bb(bB.xy);\n    ba = Z(z);\n    bC = -1. / bB.z;\n    bJ = bC - ba;\n    bJ *= clamp(sign(abs(bJ) - bq * bG * bG), .0, 1.);\n    bM = abs(bJ + bE) < bE;\n    bK = clamp(bI.x / (bI.x - bJ), .0, 1.);\n    bL = bM ? bI.y + bK * bG - bG : 1.;\n    bI.z = min(bI.z, bL);\n    bI.x = bJ;\n    if(bM) {\n      float by = bI.y - bG;\n      float bz = bI.y;\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bN = bA;\n      break;\n    }\n    bI.y += bG;\n  }\n  return vec4(bp + bs * bN, 1. - bN);\n}\nvec3 bP(in vec4 bQ, const in float bR, const in vec3 bS, const in vec3 bT, const in float j) {\n  vec4 bU = mix(outputFovInfo[0], outputFovInfo[1], bQ.x);\n  bQ.xyz = vec3(mix(bU.xy, bU.zw, bQ.y), 1.) * -1. / bQ.z;\n  bQ.xyz = (reprojViewProjMatrix * vec4(bQ.xyz, 1.)).xyw;\n  bQ.xy /= bQ.z;\n  float bV = clamp(6. - 6. * max(abs(bQ.x), abs(bQ.y)), .0, 1.);\n  bQ.xy = .5 + .5 * bQ.xy;\n  return vec3(bQ.xy, 1.);\n}\nvec3 ssr(const in vec3 bS, const in vec3 bT, const in float j, const in vec3 d, const in vec3 bg) {\n  float bW = .0;\n  vec4 f = vec4(.0);\n  float bh = j * j;\n  bh = bh * bh;\n  vec3 bX = abs(d.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 bd = normalize(cross(bX, d));\n  vec3 be = cross(d, bd);\n  float bR = ssrFactor * clamp(-4. * dot(bg, d) + 3.8, .0, 1.);\n  bR *= clamp(4.7 - j * 5., .0, 1.);\n  vec3 bp = T(projMatrix, vViewVertex.xyz);\n  bp.z = 1. / bp.z;\n  vec3 br = bc(bW, bd, be, d, bg, bh);\n  float bq = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, br.z * .5 + .5);\n  float bE = .5 * bq;\n  vec4 bQ;\n  if(dot(br, d) > .001 && bR > .0) {\n    bQ = bD(bp, bq, bE, br, j, bW);\n    if(bQ.w > .0)\n      return bP(bQ, bR, bS, bT, j);\n    \n  }\n  return vec3(.0);\n}\n#endif\nconst vec3 bY = vec3(0., 0., 1.);\nuniform mat4 viewMatrix;\nuniform sampler2D normalTexture;\nuniform sampler2D heightTexture;\nuniform vec4 waveParams;\nuniform vec2 waterDir;\nuniform vec4 waterBaseColor;\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\nfloat bZ(vec3 e, float ca) {\n  float cb = max(.015, ca);\n  return max((e.x + e.y) * .3303545 / cb + .3303545, .0);\n}\nconst vec2 cc = vec2(6. / 25., 5. / 24.);\nvec2 cd(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rg - 1.;\n}\nfloat cf(vec2 S) {\n  return texture2D(heightTexture, S).b;\n}\nvec3 cg(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rgb - 1.;\n}\nfloat ch(vec2 S, float ci) {\n  return fract(ci);\n}\nfloat cj(vec2 S, float ci) {\n  float ck = ch(S, ci);\n  return 1. - abs(1. - 2. * ck);\n}\nvec3 cl(sampler2D cm, vec2 S, float ci, float cn) {\n  float co = waveParams[2];\n  float cp = waveParams[3];\n  vec2 cq = cd(cm, S) * co;\n  float ck = ch(S, ci + cn);\n  float cr = cj(S, ci + cn);\n  vec2 f = S;\n  f -= cq * (ck + cp);\n  f += cn;\n  f += (ci - ck) * cc;\n  return vec3(f, cr);\n}\nconst float cs = 7.77;\nvec3 ct(sampler2D cu, sampler2D cv, vec2 cw, vec2 cx, float ci) {\n  float ca = waveParams[0];\n  vec2 cy = ci * -cx;\n  float cz = cf(vNoiseUv) * cs;\n  vec3 cA = cl(cv, cw + cy, ci + cz, .0);\n  vec3 cB = cl(cv, cw + cy, ci + cz, .5);\n  vec3 cC = cg(cu, cA.xy) * cA.z;\n  vec3 cD = cg(cu, cB.xy) * cB.z;\n  vec3 cE = normalize(cC + cD);\n  cE.xy *= ca;\n  cE.z = sqrt(1. - dot(cE.xy, cE.xy));\n  return cE;\n}\nvec4 cF(vec2 cw, float cG) {\n  float cH = waveParams[1];\n  vec3 d = ct(normalTexture, heightTexture, cw * cH, waterDir, cG);\n  float cI = bZ(d, waveParams[0]);\n  return vec4(d, cI);\n}\nconst float cJ = 3.141592653589793;\nconst float cK = 1. / cJ;\nconst float cL = .3183098861837907;\nconst float cM = 1.570796326794897;\nconst float cN = .4;\nfloat cO = 2.2;\nvec3 cP(float cQ, vec3 cR, float l) {\n  return cR + (l - cR) * pow(1. - cQ, 5.);\n}\nfloat cS(float cT, float j) {\n  float cU = j * j;\n  float cV = cT * cT;\n  float cW = pow((cV * (cU - 1.) + 1.), cO) * cJ;\n  return cU / cW;\n}\nfloat cX(float cY) {\n  return .25 / (cY * cY);\n}\nvec3 cZ(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float da = 2.2;\nconst float db = .4545454545;\nvec4 dc(vec4 u) {\n  return vec4(pow(u.rgb, vec3(db)), u.w);\n}\nvec3 dd(vec3 u) {\n  return pow(u, vec3(da));\n}\nconst vec3 de = vec3(.02, 1., 5.);\nconst vec2 df = vec2(.02, .1);\nconst float j = .06;\nconst float dg = 1.7;\nconst vec3 dh = vec3(0, .6, .9);\nconst vec3 di = vec3(.72, .92, 1.);\nconst float dj = .65;\nconst float dk = 300000.0;\nconst float dl = 500000.0;\nconst float dm = .775;\nconst float dn = .8;\nPBRShadingWater dp;\nvec3 dq(in PBRShadingWater dr, float j, vec3 ds, float dt) {\n  vec3 du = cP(dr.VdotH, ds, dt);\n  float dv = cS(dr.NdotH, j);\n  float dw = cX(dr.LdotH);\n  float dx = mix(j + .045, j + .385, 1. - dr.VdotH);\n  float dy = 1.2;\n  float dz = cS(dr.NdotH, dx) * dy;\n  return ((dv + dz) * dw) * du;\n}\nvec3 dA(float dg, float dB, vec3 dh, float dC) {\n  return dg * (.075 * dh * pow(dB, 4.) + 50. * pow(dB, 23.)) * dC;\n}\nvec3 dD(in float bk, in vec3 dE, in vec3 dF) {\n  float dG = pow((1. - bk), de[2]);\n  return mix(dF, dE, dG);\n}\nvec3 dH(in vec3 e, in vec3 dI, in float dJ, in float j) {\n  \n#ifdef HAS_IBL_LIGHTING\nvec3 dK = reflect(-dI, e);\n  vec3 dL = textureCube(prefilterMap, environmentTransform * dK).rgb;\n  float dM = clamp(1. + dot(dK, e), .0, 1.);\n  dL *= dM * dM;\n  vec3 i = dL;\n  vec3 dN = c(e);\n  float l = clamp(50.0 * waterBaseColor.g, .0, 1.);\n  vec3 dO = h(waterBaseColor.rgb, j, dot(e, dI), l);\n  return i * dO + dN;\n#else\nvec3 dP = dd(di);\n  vec3 dQ = dd(dh);\n  vec3 di = dD(dJ, dP, dQ);\n  return di;\n#endif\n}\nvec3 dR(in vec3 e, in vec3 dI, in vec3 dS, vec3 u, in vec3 dT, in vec3 dU, in float dV, float dW, vec3 dX) {\n  float dY = 0.;\n  vec3 dZ = dd(u);\n  vec3 bm = normalize(dS + dI);\n  dp.NdotL = clamp(dot(e, dS), .0, 1.);\n  dp.NdotV = clamp(dot(e, dI), .001, 1.);\n  dp.VdotN = clamp(dot(dI, e), .001, 1.);\n  dp.NdotH = clamp(dot(e, bm), .0, 1.);\n  dp.VdotH = clamp(dot(dI, bm), .0, 1.);\n  dp.LdotH = clamp(dot(dS, bm), .0, 1.);\n  float dJ = max(dot(dU, dI), .0);\n  vec3 di = dH(e, dI, dJ, j);\n  float ea = max(dot(dU, dS), .0);\n  float eb = .1 + ea * .9;\n  di *= eb;\n  float ec = clamp(dV, .8, 1.);\n  vec3 ed = cP(dp.VdotN, vec3(de[0]), de[1]);\n  vec3 ee = ed * di * ec;\n  vec3 ef = dZ * mix(di, ea * dT * cK, 2. / 3.) * ec;\n  vec3 i = vec3(.0);\n  if(dJ > .0 && ea > .0) {\n    vec3 eg = dq(dp, j, vec3(df[0]), df[1]);\n    vec3 eh = dT * cK * dV;\n    i = dp.NdotL * eh * eg;\n  }\n  vec3 cI = vec3(.0);\n  if(dJ > .0) {\n    cI = dA(dg, dW, dh, eb);\n  }\n  vec3 ei = vec3(.0);\n#ifdef HAS_SSR\nfloat ej = smoothstep(dl, dk, -dX.z);\n  mat4 ek = viewMatrix;\n  vec4 el = vec4(dX.xyz, 1.);\n  vec3 em = normalize(el.xyz);\n  vec4 en = ek * vec4(e, .0);\n  vec3 eo = normalize(en.xyz);\n  vec4 ep = ek * vec4(dU, .0);\n  float eq = pow(max(dot(-em, ep.xyz), .0), cN);\n  vec3 er = mix(ep.xyz, eo, eq);\n  vec3 es = ssr(vec3(.0), vec3(1.), j, normalize(er), -normalize(vViewVertex.xyz));\n  if(es.z > .0) {\n    vec2 et = smoothstep(.3, .6, abs(vec2(.5) - es.xy));\n    dY = dm * clamp(1. - 1.3 * et.y, .0, 1.) * ej;\n    vec3 eu = X(.0, es.xy);\n    ei = dd(eu) * dY * ed.y * dj;\n  }\n#endif\nfloat ev = mix(dn, dn * .5, dY);\n  return cZ((1. - dY) * ee + ei + ef * ev + i + cI);\n}\nvoid main() {\n  vec3 dU = bY;\n  vec4 ew = cF(vUv, timeElapsed);\n  vec3 e = normalize(vTbnMatrix * ew.xyz);\n  vec3 dI = -normalize(vPos - camPos);\n  vec3 dS = normalize(-lightDirection);\n#if defined(HAS_SHADOWING)\nfloat dV = shadow_computeShadow();\n#else\nfloat dV = 1.;\n#endif\nvec4 ex = viewMatrix * vec4(vPos, 1.);\n  vec4 ey = vec4(dR(e, dI, dS, waterBaseColor.rgb, lightColor, dU, dV, ew.w, ex.xyz), waterBaseColor.a);\n  gl_FragColor = dc(ey);\n  if(contrast != 1.) {\n    gl_FragColor = contrastMatrix(contrast) * gl_FragColor;\n  }\n  if(length(hsv) > .0) {\n    gl_FragColor = hsv_apply(gl_FragColor, hsv);\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor) * layerOpacity;\n}",defines:i,uniforms:r,extraCommandProps:a})}getUniformValues(t){return{projViewMatrix:t.projViewMatrix,minAltitude:this.layer.options.altitude||0}}pa(t,e){const{iblTexes:n,dfgLUT:r}=this.getIBLRes(),i=eW(t,n,r,e&&e.ssr,e&&e.jitter),o=t.getLightManager();let s=o&&o.getDirectionalLight()||{};const a=o&&o.getAmbientLight()||{},l=this.getSymbol(iW),h=this.Ma=this.Ma||[],u=this._a=this._a||[];cA(u,.09,l.uvScale||3,.03,-.5),oH(i,{ambientColor:a.color||[.2,.2,.2],viewMatrix:t.viewMatrix,lightDirection:s.direction||nW.direction,lightColor:s.color||nW.color,camPos:t.cameraPosition,timeElapsed:l.animation?(this.layer.getRenderer().getFrameTimestamp()||0)/(1/(l.waterSpeed||1)*1e4):0,normalTexture:this.ba||this.xa,heightTexture:this.Aa||this.xa,waveParams:u,waterDir:lW(h,l.waterDirection||0),waterBaseColor:l.waterBaseColor||[.1451,.2588,.4863,1],contrast:l.contrast||1,hsv:l.hsv||oW});const c=this.layer.getRenderer();return i.layerOpacity=c.Xn(),this.setIncludeUniformValues(i,e),e&&e.ssr&&e.ssr.renderUniforms&&oH(i,e.ssr.renderUniforms),i}delete(){super.delete(),this.xa&&(this.xa.destroy(),delete this.xa),this.ba&&this.ba.destroy(),this.Aa&&this.Aa.destroy(),this.shader&&(this.shader.dispose(),delete this.shader),this.ma&&this.ma.dispose(),this.ga&&(this.ga.geometry.dispose(),this.ga.material&&this.ga.material.dispose(),this.ga.dispose(),delete this.ga),this.disposeIBLTextures()}createGround(){const t=new R_;t.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),t.generateBuffers(this.renderer.regl),this.ga=new h_(t,null,{castShadow:!1}),this.ya=new __([this.ga])}transformWater(){const t=this.getMap(),e=AS.getGroundTransform(this.ga.localTransform,t);this.ga.setLocalTransform(e);const n=t._get2DExtentAtRes(t.getGLRes()),r=n.getWidth(),i=n.getHeight(),o=t.cameraLookAt,s=o[0]-r,a=o[1]+i,l=s/sW[0],h=a/sW[1],u=l%1,c=h%1,f=l*rW%1,d=h*rW%1,p=r/sW[0]*2,g=i/sW[1]*2;this.ga.setUniform("uvOffset",[u,c]),this.ga.setUniform("noiseUvOffset",[f,d]),this.ga.setUniform("uvScale",[p,-g])}}function lW(t,e){var n;return n=e,e=Math.PI*n/180,t[0]=Math.sin(e),t[1]=Math.cos(e),t}JH("fill",Yj).registerAt(BH);JH("line",$j).registerAt(BH);JH("line-gradient",tU).registerAt(BH);JH("icon",PV).registerAt(BH);JH("text",pG).registerAt(BH);const hW=JH("native-line",class extends Nj{constructor(t,e,n,r,i,o){if(super(t,e,n,r,i,o),this.primitive="lines",nO(this.symbolDef.lineColor)){const t=e.getMap(),n=oO(this.symbolDef.lineColor);this.colorSymbol=e=>n(t.getZoom(),e)}}needPolygonOffset(){return!0}createMesh(t,e){const{geometry:n,symbolIndex:r,ref:i}=t,o=this.getSymbol(r),s=this.getMeshUniforms(n,o);void 0===i&&n.generateBuffers(this.regl);const a=new Kx(s),l=new h_(n,a,{castShadow:!1,picking:!0});l.setLocalTransform(e),l.properties.symbolIndex=r;const h={};return l.geometry.data.aAltitude&&(h.HAS_ALTITUDE=1),l.setDefines(h),l}getMeshUniforms(t,e){const n={};return uH(n,"lineColor",e,"lineColor","#000",dH(this.colorCache)),uH(n,"lineOpacity",e,"lineOpacity",1),n}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}init(t){const e=this.regl;this.renderer=new f_(e);const n=this.canvas,r={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:n?n.width:1,height:(t,e)=>e.viewport?e.viewport.height:n?n.height:1},i=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],o=this.sceneConfig.depthRange,s={vert:vG,frag:"#define SHADER_NAME NATIVE_LINE\nprecision mediump float;\nuniform float lineOpacity;\nuniform vec4 lineColor;\nuniform float layerOpacity;\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#endif\nvoid main() {\n  gl_FragColor = lineColor * lineOpacity;\n#if defined(HAS_COLOR)\ngl_FragColor *= vColor;\n#endif\ngl_FragColor *= layerOpacity;\n}",uniforms:i,defines:null,extraCommandProps:{viewport:r,stencil:{enable:()=>this.isEnableTileStencil(t),mask:255,func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(t,e)=>e.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:o||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}};this.shader=new U_(s),this.pickingFBO&&(this.picking=[new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+vG,uniforms:i,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())])}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin;return{projViewMatrix:n?xG:t.projViewMatrix,viewport:n&&e&&e.viewport}}getPrimitive(){return"lines"}});hW.registerAt(BH),JH("native-point",class extends Nj{getPrimitive(){return"points"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(t,e){const{geometry:n,symbolIndex:r,ref:i}=t,o=this.getSymbol(r);void 0===i&&(tj(n,this.getSymbolDef(r),this.getFnTypeConfig(r),this.layer),n.generateBuffers(this.regl));const s={};uH(s,"markerOpacity",o,"markerOpacity",1),uH(s,"markerSize",o,"markerSize",10),uH(s,"markerFill",o,"markerFill","#000",dH(this.colorCache,3));const a=new Kx(s,yG);a.createDefines=()=>"square"!==o.markerType?{USE_CIRCLE:1}:null,a.appendDefines=t=>("square"!==o.markerType&&(t.USE_CIRCLE=1),t);const l=new h_(n,a,{castShadow:!1,picking:!0}),h={};return l.geometry.data.aAltitude&&(h.HAS_ALTITUDE=1),n.data.aColor&&(h.HAS_COLOR=1),l.setDefines(h),l.positionMatrix=this.getAltitudeOffsetMatrix(),l.setLocalTransform(e),l.properties.symbolIndex=r,l}createFnTypeConfig(t,e){const n=oO(e.markerFill);return[{attrName:"aColor",symbolName:"markerFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return nO(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||JO(i).unitArray()),i=fH(i),i}}]}init(){const t=this.regl;this.renderer=new f_(t);const e=[],n={vert:AG,frag:"#define SHADER_NAME NATIVE_POINT\nprecision mediump float;\n#include <gl2_frag>\n#ifdef USE_CIRCLE\n#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#define STANDARD_DERIVATIVES_ENABLED 1\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define STANDARD_DERIVATIVES_ENABLED 1\n#endif\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec3 markerFill;\n#endif\nuniform float markerOpacity;\nuniform float layerOpacity;\nvoid main() {\n  float c = 1.;\n#ifdef USE_CIRCLE\nfloat r = .0, d = .0;\n  vec2 e = 2. * gl_PointCoord - 1.;\n  r = dot(e, e);\n  if(r > 1.) {\n    discard;\n  }\n#ifdef STANDARD_DERIVATIVES_ENABLED\nd = fwidth(r);\n  c = 1. - smoothstep(1. - d, 1. + d, r);\n#endif\n#endif\n#ifdef HAS_COLOR\nvec4 f = vColor;\n#else\nvec4 f = vec4(markerFill, 1.);\n#endif\nglFragColor = f * markerOpacity * c * layerOpacity;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return am(e,n.projViewMatrix,n.modelMatrix),e}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,mask:!1,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"always"},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"}}};if(this.shader=new U_(n),this.shader.version=300,this.pickingFBO){const t=[];this.picking=[new Nw(this.renderer,{vert:"#define PICKING_MODE 1\n"+AG,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return am(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]}}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}}).registerAt(BH);JH("phong",kG).registerAt(BH);const uW=JH("wireframe",class extends kj{createGeometry(t){const{data:e,indices:n}=t,r=new bx(e,n,0,{primitive:"lines"});return r.generateBuffers(this.regl),{geometry:r,symbolIndex:{index:0}}}createMesh(t,e){const{geometry:n}=t,r=new h_(n);if(r.castShadow=!1,this.sceneConfig.animation){LG[2]=.01;const t=[];fm(t,LG),am(t,e,t),e=t}return r.setLocalTransform(e),r.properties.symbolIndex={index:0},r}addMesh(t,e){if(!t.length)return this;let n;null!==e?(0===e&&(e=.01),n=t[0].localTransform,LG[2]=e,fm(n,LG),am(n,t[0].properties.tileTransform,n)):n=t[0].properties.tileTransform;for(let r=0;r<t.length;r++)t[r].setLocalTransform(n);return this.scene.addMesh(t),this}init(){const t=this.regl;this.scene=new __,this.renderer=new f_(t);const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={vert:"\n    attribute vec3 aPosition;\n    attribute vec4 aColor;\n\n    uniform mat4 projViewModelMatrix;\n    uniform vec2 outSize;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n        vColor = aColor / 255.0;\n    }\n",frag:"\n    #ifdef GL_ES\n        precision lowp float;\n    #endif\n\n    uniform float opacity;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_FragColor = vColor * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return am(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e}};this.shader=new U_(n)}getUniformValues(t){const e=this.sceneConfig.opacity||.3,n=this.layer.getRenderer().canvas;return{projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],opacity:e}}});uW.registerAt(BH);JH("lit",NG).registerAt(BH);JH("tube",BG).registerAt(BH);JH("gltf-phong",$G).registerAt(BH);JH("gltf-lit",tW).registerAt(BH);const cW=JH("heatmap",class extends Nj{createFnTypeConfig(t,e){const n=iO(e.heatmapWeight),r=new Int16Array(1);return[{attrName:"aWeight",symbolName:"heatmapWeight",type:Int16Array,width:1,define:"HAS_HEAT_WEIGHT",evaluate:e=>{const i=n(t.getZoom(),e);return r[0]=255*i,r[0]}}]}createMesh(t,e){const{geometry:n,symbolIndex:r,ref:i}=t;void 0===i&&tj(n,this.getSymbolDef(r),this.getFnTypeConfig(r),this.layer);const o=this.getSymbol(r),s={tileRatio:n.properties.tileRatio,dataResolution:n.properties.tileResolution};uH(s,"heatmapIntensity",o,"heatmapIntensity",1),uH(s,"heatmapRadius",o,"heatmapRadius",6),uH(s,"heatmapWeight",o,"heatmapWeight",1),uH(s,"heatmapOpacity",o,"heatmapOpacity",1),n.generateBuffers(this.regl);const a=new Kx(s),l=new h_(n,a,{transparent:!0,castShadow:!1,picking:!0}),h={};return n.data.aWeight&&(h.HAS_HEAT_WEIGHT=1),l.setDefines(h),l.setLocalTransform(e),l.properties.symbolIndex=r,l}callRenderer(t,e,n){const r=this.getRenderFBO(n);this.Xi+=this.Sa.render(this.scene,e,r)}getUniformValues(t){const e=this.getSymbol({index:0}),{projViewMatrix:n}=t;return{glScale:1/t.getGLScale(),resolution:t.getResolution(),projViewMatrix:n,heatmapOpacity:e.heatmapOpacity}}getHeatmapMeshes(){return this.scene.getMeshes()}delete(){super.delete(...arguments),this.Sa.dispose(),delete this.Sa}init(){const t=this.regl;this.renderer=new f_(t);const e=this.getPolygonOffset(),n=this.getSymbols()[0];this.Sa=new xE(this.regl,this.sceneConfig,this.layer,n.heatmapColor,null,e)}});cW.registerAt(BH);JH("water",aW).registerAt(BH),qH.registerPainter("lit",NG),qH.registerPainter("icon",PV),qH.registerPainter("fill",Yj),qH.registerPainter("line",$j),qH.registerPainter("line-gradient",tU),qH.registerPainter("water",aW),qH.registerPainter("tube",BG);class fW extends BH{getTileUrl(t,e,n){const r=this.getMap().getResolution(n);return super.getTileUrl(t,e,(i=r,19-Math.log(i/dW)/Math.LN2));var i}static fromJSON(t){return t&&"MapboxVectorTileLayer"===t.type?new fW(t.id,t.options):null}}fW.registerJSONType("MapboxVectorTileLayer");const dW=12756274*Math.PI/(256*Math.pow(2,20));class pW extends BH{constructor(t,e){(e=e||{}).spatialReference=null,super(t,e),this.setData(e.data)}onAdd(){this.Jn()}Jn(){const t=this.getMap(),e=t.getMaxNativeZoom(),n=t.getProjection(),r="EPSG:4326"===n.code||"EPSG:4490"===n.code;var i,o;r&&(this.options.tileSystem=[1,-1,-180,90]),this.options.spatialReference=r?(o=e,{projection:n.code,fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const t=[];for(let e=0;e<=o+1;e++)t[e]=90/(128*Math.pow(2,e));return t}()}):(i=e,{projection:"EPSG:3857",resolutions:function(){const t=[],e=6378137*Math.PI;for(let n=0;n<=i+1;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}})}getWorkerOptions(){const t=super.getWorkerOptions();let e=this.options.data;return CB(e)||e&&e.url?(e.url&&(e=JSON.parse(JSON.stringify(e))),e=mW(e,this.getURLModifier())):e=this.features,t.data=e,t.tileBuffer=this.options.tileBuffer,t.extent=this.options.extent,t.hasAltitude=this.options.enableAltitude,t.simplifyTolerance=this.options.simplifyTolerance,t.projection=this.getSpatialReference().getProjection().code,t.generateOMBB=this.options.generateOMBB,t.convertFn=this.options.convertFn?this.options.convertFn+"":null,t}setData(t){return this.options.data=t,t&&(CB(t)||t.url)?(!!this.getRenderer()&&this.ka(),this):(this.Pa(t),this.ka(),this)}Pa(t){return this.options.convertFn&&(t=new Function("data",this.options.convertFn+"\nreturn convert(data)")(t)),this.features=t,this.Ta(),this}ka(){const t=this.getRenderer();if(t){const e=t.getWorkerConnection();if(e){let n=this.options.data;CB(n)||n&&n.url?(n.url&&(n=JSON.parse(JSON.stringify(n))),n=mW(n,this.getURLModifier())):n=this.features,e.setData(n,((e,n)=>{t.clear(),this.onWorkerReady(null,n),t.setToRedraw(),setTimeout((()=>{t.setToRedraw()}),500)}))}}}getExtent(){return this.Ia}onWorkerReady(t,e){t?this.fire("dataerror",{error:t}):(e&&(e.extent&&this.Fa(e.extent),e.idMap&&(this.Ca=e.idMap)),this.fire("dataload",{extent:e&&e.extent}))}Fa(t){this.Ia=new f(...t)}Oa(t,e){CB(t)?FB.getJSON(t,e):FB.getJSON(t.url,t,e)}getData(){return this.features||null}getTileUrl(t,e,n){return this.getId()+","+t+","+e+","+n}getFeature(t){return this.Ca[t]}static fromJSON(t){return t&&"GeoJSONVectorTileLayer"===t.type?new pW(t.id,t.options):null}getGeometryById(t){return this.Ca?this.Ca[t]:null}Ta(){if(!this.features)return;if(this.features=JSON.parse(JSON.stringify(this.features)),!this.features)return;let t=0;this.Ca={};const e=this.options.featureIdProperty,n=this.features;Array.isArray(n)?n.forEach((n=>{if(n){if(SB(n.id)||(n.id=t++),e){let t=e;PB(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this.Ca[n.id]=n}})):n.features&&n.features.forEach((n=>{if(n){if(SB(n.id)||(n.id=t++),e){let t=e;PB(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this.Ca[n.id]=n}}))}}function gW(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}function mW(t,e){return t.url?t.url=e?e(t.url):gW(t.url):t=e?e(t):gW(t),t}pW.registerJSONType("GeoJSONVectorTileLayer"),pW.mergeOptions({features:"id",tileBuffer:64,extent:8192,pyramidMode:1,simplifyTolerance:3,tileStackDepth:0,generateOMBB:!0});const AW={markerFile:{type:"identity",default:null,property:"_symbol_markerFile"},markerWidth:{type:"identity",default:null,property:"_symbol_markerWidth"},markerHeight:{type:"identity",default:null,property:"_symbol_markerHeight"},markerPathWidth:{type:"identity",default:20,property:"_symbol_markerPathWidth"},markerPathHeight:{type:"identity",default:20,property:"_symbol_markerPathHeight"},markerDx:{type:"identity",default:null,property:"_symbol_markerDx"},markerDy:{type:"identity",default:null,property:"_symbol_markerDy"},markerType:{type:"identity",default:null,property:"_symbol_markerType"},markerPath:{type:"identity",default:null,property:"_symbol_markerPath"},markerFill:{type:"identity",default:null,property:"_symbol_markerFill"},markerFillPatternFile:{type:"identity",default:null,property:"_symbol_markerFillPatternFile"},markerFillOpacity:{type:"identity",default:null,property:"_symbol_markerFillOpacity"},markerLineColor:{type:"identity",default:null,property:"_symbol_markerLineColor"},markerLineWidth:{type:"identity",default:null,property:"_symbol_markerLineWidth"},markerLineOpacity:{type:"identity",default:null,property:"_symbol_markerLineOpacity"},markerLineDasharray:{type:"identity",default:null,property:"_symbol_markerLineDasharray"},markerLinePatternFile:{type:"identity",default:null,property:"_symbol_markerLinePatternFile"},markerVerticalAlignment:{type:"identity",default:"top",property:"_symbol_markerVerticalAlignment"},markerHorizontalAlignment:{type:"identity",default:"middle",property:"_symbol_markerHorizontalAlignment"},markerOpacity:{type:"identity",default:1,property:"_symbol_markerOpacity"},markerPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_markerPitchAlignment"},markerRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_markerRotationAlignment"},markerRotation:{type:"identity",default:0,property:"_symbol_markerRotation"},markerAllowOverlap:{type:"identity",default:0,property:"_symbol_markerAllowOverlap"},markerIgnorePlacement:{type:"identity",default:0,property:"_symbol_markerIgnorePlacement"},markerTextFit:{type:"identity",default:null,property:"_symbol_markerTextFit"},markerSpacing:{type:"identity",default:250,property:"_symbol_markerSpacing"},markerTextFitPadding:{type:"identity",default:null,property:"_symbol_markerTextFitPadding"},markerPlacement:{type:"identity",default:"point",property:"_symbol_markerPlacement"}},yW={textName:{type:"identity",default:null,property:"_symbol_textName"},textFaceName:{type:"identity",default:null,property:"_symbol_textFaceName"},textWrapWidth:{type:"identity",default:null,property:"_symbol_textWrapWidth"},textHorizontalAlignment:{type:"identity",default:null,property:"_symbol_textHorizontalAlignment"},textVerticalAlignment:{type:"identity",default:null,property:"_symbol_textVerticalAlignment"},textFill:{type:"identity",default:null,property:"_symbol_textFill"},textSize:{type:"identity",default:null,property:"_symbol_textSize"},textHaloRadius:{type:"identity",default:null,property:"_symbol_textHaloRadius"},textHaloFill:{type:"identity",default:null,property:"_symbol_textHaloFill"},textHaloOpacity:{type:"identity",default:1,property:"_symbol_textHaloOpacity"},textDx:{type:"identity",default:0,property:"_symbol_textDx"},textDy:{type:"identity",default:0,property:"_symbol_textDy"},textOpacity:{type:"identity",default:1,property:"_symbol_textOpacity"},textPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_textPitchAlignment"},textRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_textRotationAlignment"},textRotation:{type:"identity",default:0,property:"_symbol_textRotation"},textAllowOverlap:{type:"identity",default:0,property:"_symbol_textAllowOverlap"},textIgnorePlacement:{type:"identity",default:0,property:"_symbol_textIgnorePlacement"},textSpacing:{type:"identity",default:250,property:"_symbol_textSpacing"},textPlacement:{type:"identity",default:"point",property:"_symbol_textPlacement"}},vW={lineWidth:{type:"identity",default:2,property:"_symbol_lineWidth"},lineStrokeWidth:{type:"identity",default:0,property:"_symbol_lineStrokeWidth"},lineColor:{type:"identity",default:[1,1,1,1],property:"_symbol_lineColor"},lineStrokeColor:{type:"identity",default:[0,0,0,0],property:"_symbol_lineStrokeColor"},lineDx:{type:"identity",default:0,property:"_symbol_lineDx"},lineDy:{type:"identity",default:0,property:"_symbol_lineDy"},linePatternFile:{type:"identity",default:null,property:"_symbol_linePatternFile"},linePatternAnimSpeed:{type:"identity",default:0,property:"_symbol_linePatternAnimSpeed"},linePatternGap:{type:"identity",default:0,property:"_symbol_linePatternGap"},lineOpacity:{type:"identity",default:1,property:"_symbol_lineOpacity"},lineJoin:{type:"identity",default:null,property:"_symbol_lineJoin"},lineCap:{type:"identity",default:null,property:"_symbol_lineCap"},lineDasharray:{type:"identity",default:null,property:"_symbol_lineDasharray"},lineDashColor:{type:"identity",default:null,property:"_symbol_lineDashColor"}},xW="_line_gradient_property",_W=new i(0,0),bW="_vector3dlayer_id",wW=(xW+"").trim();function TW(t,e,n){const r=(ZB+"").trim(),i=t.getMap(),o=i.getGLRes();let s=t.getCoordinates();const a=[],l=[];let h=1;if(t instanceof g||t instanceof m){t instanceof g&&(s=[s]);for(let t=0;t<s.length;t++)i.coordToPointAtRes(s[t],o,_W),a.push([_W.x,_W.y,s[t].z||0]),l.push([s[t].x,s[t].y])}else if(t instanceof A||t instanceof y){h=2,t instanceof A&&(s=[s]);for(let t=0;t<s.length;t++){a[t]=[],l[t]=[];for(let e=0;e<s[t].length;e++)i.coordToPointAtRes(s[t][e],o,_W),a[t].push([_W.x,_W.y,s[t][e].z||0]),l[t].push([s[t][e].x,s[t][e].y])}}else if(t instanceof c||t instanceof v){h=3,t instanceof b||t instanceof w||t instanceof T||t instanceof M?s=[[t.getShell()]]:t instanceof c&&(s=[s]);let e=0;for(let t=0;t<s.length;t++){let n=!1;for(let r=0;r<s[t].length;r++){if(a[e]=[],l[e]=[],n)for(let n=s[t][r].length-1;n>=0;n--)i.coordToPointAtRes(s[t][r][n],o,_W),a[e].push([_W.x,_W.y,s[t][r][n].z||0]),l[e].push([s[t][r][n].x,s[t][r][n].y]);else for(let n=0;n<s[t][r].length;n++)i.coordToPointAtRes(s[t][r][n],o,_W),a[e].push([_W.x,_W.y,s[t][r][n].z||0]),l[e].push([s[t][r][n].x,s[t][r][n].y]);0===r&&(n=Uk(a[e])<0,n&&(a[e]=a[e].reverse(),l[e]=l[e].reverse())),e++}}}const u=t.getProperties()?Object.assign({},t.getProperties()):{},f=t._getInternalSymbol()||((p=t)instanceof g||p instanceof m?{markerType:"ellipse",markerWidth:8,markerHeight:0,markerFill:"#000"}:p instanceof A||p instanceof y?{lineColor:"#000",lineWidth:1}:p instanceof c||p instanceof v?{polygonFill:"#fff",lineColor:"#000",lineWidth:1}:void 0),d=n?Array.isArray(n)?n[0].id:n.id:e.id++;var p;if(Array.isArray(f)&&f.length){const i=[],o=f.length;for(let s=0;s<o;s++){const c=s===o-1?u:MB({},u),p=MW(f[s],c);for(const t in f[s])kB(f[s],t)&&(c[("_symbol_"+t).trim()]=f[s][t]);p&&(f[s].lineGradientProperty=p);const g=n&&n[s]?n[s][r]:e.pickingId++,m={type:h,id:d,properties:c,visible:t.isVisible(),geometry:a,coordinates:l,extent:1/0};m[r]=g,i.push(m)}return i}if(f){const t=MW(f,u);for(const e in f)kB(f,e)&&(u[("_symbol_"+e).trim()]=f[e]);t&&(f.lineGradientProperty=t)}const x=n?n.id:e.pickingId++,_={type:h,id:d,properties:u,visible:t.isVisible(),geometry:a,coordinates:l,extent:1/0};return _[r]=x,_}function MW(t,e){const n=t.lineGradientProperty;return n&&(e[wW]=e[n],e.mapbox_clip_start=0,e.mapbox_clip_end=1,delete e[n]),n}let CW=!1,SW=1;const IW="_symbol_".trim(),PW=(ZB+"").trim();let EW=new Float32Array(1);const OW=[];class RW extends r.CanvasRenderer{constructor(...t){super(...t),this.features={},this.Ea={},this.we=0,this.Da={},this.La={},this.Ra={},this.Ha={},this.za={},this.Na=!0,this.Va={id:0,pickingId:0},this.Ua={}}setURLModifier(t){this.qn=t}getURLModifier(){return this.qn}needToRedraw(){return super.needToRedraw()||this.painter&&this.painter.needToRedraw()||this.ja&&this.ja.needToRedraw()||this.Ga&&this.Ga.needToRedraw()}getAnalysisMeshes(){return this.painter&&this.painter.getAnalysisMeshes()||OW}getRayCastData(){return null}draw(t,e){this.en=t;const n=this.layer;this.prepareCanvas(),this.nn=this.rn(this.getMap().getGLRes()),this.sn=e||{};const r=this.sn.renderMode,i=this.Ba();if(this.an(i,r),this.Na)this.buildMesh(),this.$a(),this.Wa(),this.Ua={},this.Xa=!1,this.Na=!1,this.Ya=!1;else if(this.Xa){const t=this.atlas,e=this.qa,n=this.Ja;delete this.atlas,delete this.qa,delete this.Ja,this.buildMesh(t),this.$a(e),this.Wa(n),this.Xa=!1,this.Ya=!1}else if(this.Ya){const t=this.Ja;delete this.Ja,this.Wa(t),this.Ya=!1}if(!this.meshes&&!this.Ka&&!this.Za)return void this.completeRender();this.Qa&&(this.el(),this.Qa=!1),this.nl();const o=!r||"default"===r;let s=0;0===this.layer.options.meshRenderOrder&&this.il(i,s,r);let a=0;if(this.Za&&(o||this.Ga.supportRenderMode(r))){this.Ga.startFrame(i),this.Ga.addMesh(this.Za,null,{bloom:this.sn.bloom}),this.Ga.prepareRender(i);const t=i.polygonOffsetIndex||0;s=this.meshes&&this.meshes.length?s-1:s,i.polygonOffsetIndex=(i.polygonOffsetIndex||0)+s,a=this.Ga.render(i).drawCount,i.polygonOffsetIndex=t}if(1===this.layer.options.meshRenderOrder&&this.il(i,a?s-1:s,r),this.Ka&&(o||this.ja.supportRenderMode(r))){const e=!this.sn.timestamp||this.sn.isFinalRender,r=!this.rl||this.rl!==t;n.options.collision&&r&&n.clearCollisionIndex();const o=this.layer.options.sceneConfig;this.ja.sceneConfig.collision=!o||!!EB(o.collision)||o.collision,this.ja.startFrame(i),this.ja.addMesh(this.Ka,null,{bloom:this.sn.bloom}),this.ja.prepareRender(i),n.options.collision&&r&&(this.ja.updateCollision(i),e&&(this.rl=t)),this.ja.render(i)}(o||e&&e.isFinalRender)&&(this.completeRender(),this.layer.fire("canvasisdirty"))}an(t,e){const n=!e||"default"===e;this.painter&&(n||this.painter.supportRenderMode(e))&&this.painter.startFrame(t)}il(t,e,n){const r=!n||"default"===n;return this.painter&&this.meshes&&(r||this.painter.supportRenderMode(n))?(this.painter.addMesh(this.meshes,null,{bloom:t&&t.bloom}),this.painter.prepareRender(t),t.polygonOffsetIndex=(t.polygonOffsetIndex||0)+e,this.painter.render(t)):{redraw:!1,drawCount:0}}supportRenderMode(){return!0}isForeground(){return!0}Ba(){const t={regl:this.regl,layer:this.layer,symbol:this.sl,gl:this.gl,sceneConfig:this.layer.options.sceneConfig,pluginIndex:0,cameraPosition:this.getMap().cameraPosition,timestamp:this.getFrameTimestamp()};return this.sn&&MB(t,this.sn),t}drawOnInteracting(t,e,n){this.draw(e,n)}getFrameTimestamp(){return this.en}ol(t,e){(t=t||e)===e&&(e=null);const n=[],r=[0,0,0,0];this.layer._sortGeometries();const i=this.layer.getGeometries();for(let o=0;o<i.length;o++){const s=i[o][bW];if(!this.features[s])continue;const a=this.features[s];if(Array.isArray(a))for(let i=0;i<a.length;i++){const o=a[i],s=o[PW];(!t||t[s]||e&&(!e||e[s]))&&(o.visible||(this.Qa=!0),this.al(o.geometry,r,o.coordinates),n.push(o))}else{a.visible||(this.Qa=!0);const i=a[PW];if(t&&!t[i]&&(!e||e&&!e[i]))continue;this.al(a.geometry,r,a.coordinates),n.push(a)}}if(n.length||(this.meshes&&this.painter&&(this.painter.deleteMesh(this.meshes),delete this.meshes),this.Ka&&(this.ja.deleteMesh(this.Ka),delete this.Ka),this.Za&&(this.Ga.deleteMesh(this.Za),delete this.Za)),r[3]&&(r[0]/=r[3],r[1]/=r[3]),isNaN(r[0])||isNaN(r[1]))throw new Error(`invalid geometry coordinates for ${this.layer.getJSONType()}`);return{features:n,center:r}}buildMesh(){}createVectorPacks(t,e,n,r,i,o){return t&&r&&r.length?new e(r,n,{zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.requestor,atlas:i,center:o,positionType:Float32Array}).load():Promise.resolve(null)}createMesh(t,e,n,r,i,o){return this.createVectorPacks(t,e,n,r,i,o).then((s=>this.ll(s,t,e,n,r,i,o)))}ll(t,e,n,r,i,o,s){if(!t)return null;const a=e.createGeometries([t.data],$B(i,null,0,r,this.layer));for(let u=0;u<a.length;u++)a[u]&&this.Ci(a[u].geometry);const l=im([]);lm(l,l,Lm([],s[0],s[1],0)),hm(l,l,Lm([],1,1,this.nn));const h=e.createMeshes(a,l,{tilePoint:[s[0],s[1]]});for(let u=0;u<h.length;u++){const t=h[u];t.properties.level=0,t.properties.tileTransform=l;const e=t.defines;e.ENABLE_TILE_STENCIL=1,t.setDefines(e),t.properties.meshKey=this.layer.getId()}return{meshes:h,atlas:{iconAtlas:t.data.iconAtlas}}}al(t,e,n){for(let r=0;r<t.length;r++)if(Array.isArray(t[r][0]))for(let i=0;i<t[r].length;i++)if(Array.isArray(t[r][i][0]))for(let o=0;o<t[r][i].length;o++)isNaN(+t[r][i][o][0])||isNaN(+t[r][i][o][1])||this.hl(e,t[r][i][o][0],t[r][i][o][1],t[r][i][o][2],1,n[r][i][o]);else isNaN(+t[r][i][0])||isNaN(+t[r][i][1])||this.hl(e,t[r][i][0],t[r][i][1],t[r][i][2],1,n[r][i]);else isNaN(+t[r][0])||isNaN(+t[r][1])||this.hl(e,t[r][0],t[r][1],t[r][2],1,n[r])}hl(t,e,n,r,i,o){const s=this.getMap().getProjection().isSphere();let a=!1;(o[0]>180||o[0]<-180)&&(a=!0,s&&!CW&&(CW=!0,console.warn(`Layer(${this.layer.getId()}) has invalid longitude value: ${o[0]}`))),(o[1]>90||o[1]<-90)&&(a=!0,s&&!CW&&(CW=!0,console.warn(`Layer(${this.layer.getId()}) has invalid latitude value: ${o[1]}`))),a||(t[0]+=e,t[1]+=n,t[2]+=r||0,t[3]+=i)}Ci(t){const e=this.getMap().getGLRes(),n=t.properties;n.tileResolution=e,n.tileRatio=1,n.z=1,n.tileExtent=1,n.elements=t.elements,n.aPickingId=t.data.aPickingId}ul(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&LW(this.gl)}prepareRequestors(){if(this.re)return;const t=this.layer;this.re=new dB({iconErrorUrl:t.options.iconErrorUrl,urlModifier:e=>{const n=t.getURLModifier();return n&&n(e)||e}});const e=!this.ul("win-intel-gpu-crash");this.se=new cB((e=>{t.getMap().getRenderer().callInNextFrame(e)}),t.options.glyphSdfLimitPerFrame,e),this.requestor=this.cl.bind(this),this.fl=this.dl.bind(this)}cl(t,e,n){const r=[];this.re.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&r.push(...e.buffers),n(null,{icons:e.icons},r)}))}dl(t,e,n){this.se.getGlyphs(e,((e,r)=>{if(e)throw e;const i=r.buffers||[];this.re.getIcons(t,((t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&i.push(...e.buffers),n(null,{icons:e.icons,glyphs:r.glyphs},i)}))}))}$a(t){const e=Object.keys(this.Ra),n=Object.keys(this.Ha);if(!e.length&&!n.length)return void(this.Ka&&(this.ja.deleteMesh(this.Ka),delete this.Ka));const{features:r,center:i}=this.ol(this.Ra,this.Ha),o=[],s=[];for(let c=0;c<r.length;c++){const t=r[c][PW];this.Ra[t]&&o.push(r[c]),this.Ha[t]&&s.push(r[c])}if(!o.length&&!s.length)return void(this.Ka&&(this.ja.deleteMesh(this.Ka),delete this.Ka));const a=this.Qa;this.pl=i;const l=this.ml(o,s,t,i);this.qa={};const h=[],u=[];this.yl=!0,Promise.all(l).then((t=>{if(this.Ka&&(this.ja.deleteMesh(this.Ka),delete this.Ka),!t||!t.length)return void this.setToRedraw();const e=this.ja.createGeometries(t.map((t=>(t&&t.data&&(t.data.isIdUnique=!0),t&&t.data))),this.Da);for(let i=0;i<e.length;i++)this.Ci(e[i].geometry,t[i]&&t[i].data);const n=t[0]&&t[0].data.iconAtlas,r=t[0]&&t[0].data.glyphAtlas||t[1]&&t[1].data.glyphAtlas;n&&(this.qa.iconAtlas=n),r&&(this.qa.glyphAtlas=r);const o=im([]);lm(o,o,Lm(u,i[0],i[1],0)),hm(o,o,Lm(h,1,1,this.nn));const s=this.ja.createMeshes(e,o);for(let i=0;i<s.length;i++)s[i].geometry.properties.originElements=s[i].geometry.properties.elements.slice(),s[i].properties.level=0,s[i].material.set("flipY",1),s[i].properties.meshKey=SW++;this.Ka=s,a&&(this.Qa=!0),this.yl=!1,this.setToRedraw(),this.layer.fire("buildmarkermesh")}))}el(){if(this.Ka&&(this.vl(this.Ka[0],this.Ra),this.vl(this.Ka[1],this.Ha),this.Ka[0]&&this.ja.prepareCollideIndex(this.Ka[0].geometry),this.Ka[1]&&this.ja.prepareCollideIndex(this.Ka[1].geometry)),this.Za)for(let t=0;t<this.Za.length;t++)this.vl(this.Za[t],this.za);if(this.meshes)for(let t=0;t<this.meshes.length;t++)this.vl(this.meshes[t],this.Da)}vl(t,e){if(!t)return;const{aPickingId:n,originElements:r}=t.geometry.properties,i=[];for(let s=0;s<r.length;s++){const t=n[r[s]];e[t]&&e[t].feature.visible&&i.push(r[s])}const o=t.geometry.properties.elements=new r.constructor(i);t.geometry.setElements(o)}ml(t,e,n,r){const i={zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.fl,atlas:n,center:r,positionType:Float32Array,defaultAltitude:0,forceAltitudeAttribute:!0,markerWidthType:Uint16Array,markerHeightType:Uint16Array},o=MB({},i);return i.allowEmptyPack=1,Nz.splitPointSymbol(this.xl).map(((n,r)=>new Nz(0===r?t:e,n,0===r?i:o).load()))}updateMesh(){}wl(t){const e=t._getInternalSymbol(),n={zoom:this.getMap().getZoom(),isVector3D:!0},r=this.Al(t);if(!this.Ka)return!1;let i=this.features[r];Array.isArray(i)||(i=[i]);const o=[],s=[],a=[],l=this.getMap().getZoom();let h,u;h=Array.isArray(e)?e.map((t=>t?sO(t,(()=>(o[0]=l,o))):t)):sO(e,(()=>(o[0]=l,o))),u=Array.isArray(e)?e.map((t=>t?HF.genFnTypes(t):t)):HF.genFnTypes(e);for(let p=0;p<i.length;p++){if(!i[p])continue;const t=Array.isArray(e)?e[p]:e,r=Array.isArray(h)?h[p]:h,o=Array.isArray(u)?u[p]:u,s=new Az(i,t,r,o,n).getIconAndGlyph();if(!this.qa||!Nz.isAtlasLoaded(s,this.qa))return this.Ml(),this.setToRedraw(),!1}for(let p=0;p<i.length;p++){const t=i[p][PW];this.Ra[t]&&s.push(i[p]),this.Ha[t]&&a.push(i[p])}const c=i[0].id,f=this.ml(s,a,this.qa,this.pl),d=this.Ka;return Promise.all(f).then((t=>{for(let e=0;e<t.length;e++){if(!t[e])continue;t[e].data&&(t[e].data.isIdUnique=!0);const n=d[e],r=n.geometry.properties.aFeaIds.indexOf(c);if(r<0)continue;const i=t[e].data.featureIds.length,o=t[e].data.dynamicAttributes;for(const s in t[e].data.data){if("aPickingId"===s)continue;if(o[s])continue;const a=t[e].data.data[s];a&&n.geometry.updateSubData(s,a,r*a.length/i)}}this.setToRedraw()})),!0}_l(t){return this.Sl(t,this.Za,this.Ja,this.kl,this.Ga,Vz,vW,this.Pl)}Sl(t,e,n,r,i,o,s,a){if(!e)return!1;if(!n)return this.Ml(),this.setToRedraw(),!1;const l=t._getInternalSymbol(),h={zoom:this.getMap().getZoom()},u=t[bW];let c=this.features[u];Array.isArray(c)||(c=[c]);const f=[];for(let A=0;A<c.length;A++){const t=c[A];if(!t)continue;const e=Array.isArray(l)?l[A]:l,r=HF.genFnTypes(e),i=new mL(c,e,r,h),s=o===Vz?i.getLineResource():i.getPolygonResource();if(!HF.isAtlasLoaded(s,n[A]))return this.Ml(),this.setToRedraw(),!1;f.push(t)}const d=c[0].id,p=a.call(this,f);for(let A=0;A<p.length;A++)if(p[A].length){const t=e.filter((t=>t.feaGroupIndex===A));if(!t.length)return this.Ml(),this.setToRedraw(),!1;if(t[0].geometry.properties.aFeaIds.indexOf(d)<0)return this.Ml(),this.setToRedraw(),!1}const g=MB({},s),m=p.map((t=>this.createVectorPacks(i,o,g,t,n[0],r)));return Promise.all(m).then((t=>{for(let n=0;n<t.length;n++){let r;if(Array.isArray(e)){for(let t=0;t<e.length;t++)if(e[t].feaGroupIndex===n){r=e[t];break}}else r=e;r&&this.Tl(r,d,t[n])}})),!0}Tl(t,e,n){const r=t.geometry.properties.aFeaIds,i=r.indexOf(e);if(!(i<0)){if(n){const e=n.data.dynamicAttributes,r=n.data.featureIds.length,o=n.data.data;for(const n in o)if(!e[n]&&kB(o,n)&&o[n]){const e=o[n];t.geometry.updateSubData(n,e,i*e.length/r)}}else{let n=i+1;for(;r[n]===e;)n++;const o=n-i,s=t.geometry.desc.positionSize;EW.length!==3*o&&(EW=new Float32Array(o*s),EW.fill(-1/0,0)),t.geometry.updateSubData(t.geometry.desc.positionAttribute,EW,i*s)}this.layer.fire("updatemesh"),this.setToRedraw()}}Wa(t){if(!Object.keys(this.za).length)return void(this.Za&&(this.Ga.deleteMesh(this.Za),delete this.Za));const{features:e,center:n}=this.ol(this.za);if(!e.length)return;const r=this.Qa;this.kl=n;const i=this.Pl(e),o=MB({},vW),s=i.map(((e,r)=>this.createMesh(this.Ga,Vz,o,e,t&&t[r],n)));this.Il=!0,Promise.all(s).then((t=>{this.Za&&this.Ga.deleteMesh(this.Za);const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r]&&t[r].meshes;if(i){for(let t=0;t<i.length;t++){const n=i[t];n.feaGroupIndex=r,e.push(n),n.geometry.properties.originElements=n.geometry.properties.elements.slice()}n[r]=t[r].atlas}}this.Za=e,this.Ja=n,r&&(this.Qa=r),this.Il=!1,this.setToRedraw(),this.layer.fire("buildlinemesh")}))}Pl(t){const e=(IW+"lineDasharray").trim(),n=(IW+"linePatternFile").trim(),r=[],i=[],o=[];for(let s=0;s<t.length;s++){const a=t[s],l=a.properties&&a.properties[e];l&&HW(l)?o.push(a):a.properties&&a.properties[n]?i.push(a):r.push(a)}return[r,i,o]}Fl(){this.Xa=!0,this.setToRedraw()}Ml(){this.Na=!0,this.setToRedraw()}Cl(t){const e=this.layer.getId();for(let n=0;n<t.length;n++){const r=t[n];let i=!1;for(let t=0;t<this.GeometryTypes.length;t++)if(r instanceof this.GeometryTypes[t]){i=!0;break}if(!i)throw new Error(`${r.getJSONType()} can't be added to ${this.layer.getJSONType()}(id:${e}).`);this.Al(r)}}Al(t){void 0===t[bW]&&(t[bW]=this.we++);const e=t[bW];this.features[e]&&this.Ol(e),this.features[e]=TW(t,this.Va,this.features[e]);const n=this.features[e];return this.El(n,e),this.Ea[e]=t,e}El(t,e){if(!t)return;const n=Array.isArray(t)?t[0].id:t.id;if(this.La[n]=t,Array.isArray(t))for(let r=0;r<t.length;r++){const n=t[r][PW];if(t[r][bW]=e,this.Da[n]={feature:t[r]},this.Da[n][bW]=e,!this.needCheckPointLineSymbols())continue;const i={feature:t[r]};(DW(t[r])||NW(t[r]))&&(this.Ra[n]=i),NW(t[r])&&(this.Ha[n]=i),BW(t[r])&&(this.za[n]=i)}else{t[bW]=e;const n={feature:t},r=t[PW];if(this.Da[r]=n,!this.needCheckPointLineSymbols())return;(DW(t)||NW(t))&&(this.Ra[r]=n),NW(t)&&(this.Ha[r]=n),BW(t)&&(this.za[r]=n)}}needCheckPointLineSymbols(){return!0}Ol(t){const e=this.features[t];if(e)if(Array.isArray(e))for(let n=0;n<e.length;n++){const t=e[n][PW],r=e[n].id;delete this.La[r],delete this.Da[t],delete this.Ra[t],delete this.Ha[t],delete this.za[t]}else{const t=e[PW],n=e.id;delete this.La[n],delete this.Da[t],delete this.Ra[t],delete this.Ha[t],delete this.za[t]}}pick(t,e,n){const r=[];return this.layer.isVisible()?([this.painter,this.ja,this.Ga].forEach((i=>{if(!i)return;const o=i.pick(t,e,n.tolerance);if(o&&o.data&&o.data.feature){const t=o.data.feature,e=this.Ea[t[bW]];n&&n.includeInternals?r.push(e):(o.geometry=e,delete o.plugin,delete o.data,delete o.point,r.push(o))}})),r):r}Dl(t){const e=t[bW],n=this.features[e];return Array.isArray(n)?n[0][PW]:n[PW]}nl(){let t=!1;for(const e in this.Ua){const n=this.Ua[e],r=this.Dl(n);if(!this.yl&&(this.Ra[r]||this.Ha[r])){const e=this.wl(n);t=t||e}if(!this.Il&&this.za[r]){const e=this._l(n);t=t||e}if(!this.Ll){const e=this.updateMesh(n);t=t||e}}this.Ua={},t&&(kW(this),this.layer.fire("partialupdate"))}Rl(t){this.Al(t),this.Ml(),kW(this)}onGeometryAdd(t){this.setToRedraw(),this.canvas&&t&&t.length&&(this.Cl(t),this.Ml(),kW(this))}onGeometryRemove(t){if(t&&t.length){for(let e=0;e<t.length;e++){const n=t[e][bW];void 0!==n&&(delete this.Ea[n],this.Ol(n),delete this.features[n])}this.Ml(),kW(this)}}onGeometrySymbolChange(t){const e=t.target._getParent()||t.target,n=e[bW];if(void 0===n)return;let r=t.properties;if(Array.isArray(r)){const t={};for(let e=0;e<r.length;e++)r[e]&&MB(t,r[e]);r=t}else if(r&&void 0!==r[0]){const t={};for(const e in r)r[e]&&MB(t,r[e]);r=t}for(const l in r)if(kB(r,l)&&_B[l])return void this.Rl(e);const i=e._getInternalSymbol(),o=this.features[n];if(this.Al(e),o)if(s=i,a=o,Array.isArray(s)?Array.isArray(a)&&s.length===a.length:!Array.isArray(a)){if(Array.isArray(i)){for(let t=0;t<i.length;t++)if(!jW(i[t],o[t]))return void this.Rl(e)}else if(!jW(i,o))return void this.Rl(e);this.onGeometryPositionChange(t)}else this.Rl(e);else this.Rl(e);var s,a}onGeometryShapeChange(t){const e=t.target._getParent()||t.target;void 0!==e[bW]&&(this.Cl([e]),this.Fl(),kW(this))}onGeometryPositionChange(t){const e=t.target._getParent()||t.target,n=e[bW];void 0!==n&&(this.Cl([e]),this.Ua[n]=e,kW(this))}onGeometryZIndexChange(t){void 0!==(t.target._getParent()||t.target)[bW]&&this.Ml()}onGeometryShow(t){void 0!==(t.target._getParent()||t.target)[bW]&&this.Hl(t)}onGeometryHide(t){void 0!==(t.target._getParent()||t.target)[bW]&&this.Hl(t)}Hl(t){const e=t.target._getParent()||t.target,n=e[bW],r=this.features[n];if(r){const t=e.isVisible();if(Array.isArray(r)){if(t===r[0].visible)return;for(let e=0;e<r.length;e++)r[e].visible=t}else{if(t===r.visible)return;r.visible=t}this.zl(),kW(this)}}zl(){this.Qa=!0}onGeometryPropertiesChange(t){const e=t.target._getParent()||t.target,n=e[bW];void 0!==n&&(this.features[n]=TW(e,this.Va),this.El(this.features[n],n),this.Ml(),kW(this))}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;t?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.Xe(),t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.prepareRequestors(),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=this.createPainter();const e=qH.get3DPainterClass("icon");let n=e.getBloomSymbol();const r=MB({},AW,yW);r.markerPerspectiveRatio=this.layer.options.markerPerspectiveRatio||0,this.Nl(r,n),this.xl=r;const i=MB({},jB,this.layer.options.sceneConfig||{});this.ja=new e(this.regl,this.layer,r,i,0),this.ja.setTextShaderDefines({REVERSE_MAP_ROTATION_ON_PITCH:1});const o=qH.get3DPainterClass("line"),s=MB({},vW);n=o.getBloomSymbol(),this.Nl(s,n),this.Vl=s;const a=MB({},this.layer.options.sceneConfig||{});void 0===a.depthMask&&(a.depthMask=!0),this.Ga=new o(this.regl,this.layer,s,a,0),this.layer.getGeometries()&&this.onGeometryAdd(this.layer.getGeometries())}We(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}Nl(t,e){for(let n=0;n<e.length;n++)t[e[n]]=this.layer.options.enableBloom}updateBloom(t){this.ja&&this.Ul(this.ja,this.xl,t),this.Ga&&this.Ul(this.Ga,this.Vl,t),this.painter&&this.Ul(this.painter,this.painterSymbol,t)}Ul(t,e,n){const r=t.constructor.getBloomSymbol().reduce(((t,r)=>(t[r]=n,e[r]=n,t)),{});t.updateSymbol(r,e)}createPainter(){}Xe(){const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0,antialias:!1};t.preserveDrawingBuffer=!0,t.stencil=!0,this.glOptions=t,this.gl=this.gl||this.Je(this.canvas,t),this.regl=mp({gl:this.gl,attributes:t,extensions:hx.WEBGL_EXTENSIONS,optionalExtensions:hx.WEBGL_OPTIONAL_EXTENSIONS})}Je(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let o=0;o<n.length;++o){try{r=t.getContext(n[o],e)}catch(i){}if(r)break}return r}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:255})}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||this.pickingFBO.resize(e.width,e.height),this.painter&&this.painter.resize(e.width,e.height))}onRemove(){super.onRemove(),this.painter&&(this.painter.delete(),delete this.painter),this.ja&&(this.ja.delete(),delete this.ja),this.Ga&&(this.Ga.delete(),delete this.Ga)}drawOutline(t){if(this.mn&&(this.painter&&this.painter.outlineAll(t),this.ja.outlineAll(t),this.Ga.outlineAll(t)),this.jl)for(let e=0;e<this.jl.length;e++)this.painter&&this.painter.outline(t,this.jl[e]),this.ja.outline(t,this.jl[e]),this.Ga.outline(t,this.jl[e])}outlineAll(){this.mn=!0,this.setToRedraw()}outline(t){this.jl||(this.jl=[]);const e=[];for(let n=0;n<t.length;n++){const r=this.layer.getGeometryById(t[n]);if(r){const t=this.features[r[bW]];if(Array.isArray(t))for(let n=0;n<t.length;n++)e.push(t[n].id);else e.push(t.id)}}this.jl.push(e),this.setToRedraw()}cancelOutline(){delete this.mn,delete this.jl,this.setToRedraw()}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&LW(this.gl)}rn(t){return LB(t,this.getMap())}_i(){const t=this.layer.getGeometries();t&&this.Cl(t),this.Ml()}Xn(){const t=this.layer.options.opacity;return this.We()?EB(t)?1:t:1}}function kW(t){t.setToRedraw()}function LW(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),r="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&r)return!0}return!1}function DW({properties:t}){const e=(IW+"markerFile").trim(),n=(IW+"markerType").trim();return t[e]||t[n]}function NW({properties:t}){return t[(IW+"textName").trim()]}const FW=(IW+"lineWidth").trim(),zW=(xW+"").trim();function BW(t){return 2===t.type&&!t.properties[zW]||3===t.type&&void 0!==t.properties[FW]}function HW(t){if(!Array.isArray(t))return 0;let e=0;for(let n=0;n<t.length;n++)e+=t[n];return e}function jW(t,e){if(Object.keys(t).sort().join()!==Object.keys(e.properties||{}).filter((t=>0===t.indexOf(IW))).map((t=>t.substring(IW.length))).sort().join())return!1;for(const n in t)if(kB(t,n)){const r=(IW+n).trim();if(nO(t[n])!==nO(e.properties[r]))return!1}return!0}function UW(t,e,n){if(!t||t.type!==e)return null;const r=new n(t.id,t.options),i=t.geometries,o=[];for(let s=0;s<i.length;s++){const t=C.fromJSON(i[s]);t&&o.push(t)}return r.addGeometry(o),r}class VW extends qH{static fromJSON(t){return UW(t,"PointLayer",VW)}constructor(...t){super(...t),this.options.sceneConfig||(this.options.sceneConfig=MB({},jB))}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}}VW.mergeOptions({glyphSdfLimitPerFrame:15,iconErrorUrl:null,workarounds:{"win-intel-gpu-crash":!0},collision:!1,collisionFrameLimit:1}),VW.registerJSONType("PointLayer"),VW.registerRenderer("canvas",null),VW.registerRenderer("gl",class extends RW{constructor(...t){super(...t),this.GeometryTypes=[g,m]}onGeometryAdd(t){t&&(Array.isArray(t)?t.forEach((t=>{t.options.maxMarkerWidth=t.options.maxMarkerHeight=255})):t.options.maxMarkerWidth=t.options.maxMarkerHeight=255,super.onGeometryAdd(t))}});class GW extends qH{static fromJSON(t){return UW(t,"LineStringLayer",GW)}}GW.mergeOptions({meshRenderOrder:1}),GW.registerJSONType("LineStringLayer");const WW=(xW+"").trim();GW.registerRenderer("gl",class extends RW{constructor(...t){super(...t),this.GeometryTypes=[A,y]}createPainter(){const t=qH.get3DPainterClass("line-gradient");this.painterSymbol=MB({},{lineGradientProperty:WW},vW),this.Nl(this.painterSymbol,t.getBloomSymbol());const e=MB({},this.layer.options.sceneConfig||{});return void 0===e.depthMask&&(e.depthMask=!0),new t(this.regl,this.layer,this.painterSymbol,e,0)}buildMesh(){let{features:t,center:e}=this.ol();if(t=t.filter((t=>!!t.properties[WW])),!t.length)return;const n=this.Qa;this.Gl=e;const r=MB({},this.painterSymbol),i=this.createMesh(this.painter,Vz,r,t,null,e);this.Ll=!0,i.then((t=>{this.meshes&&this.painter.deleteMesh(this.meshes);const e=[],r=t&&t.meshes;if(r){e.push(...r);for(let t=0;t<r.length;t++)r[t].feaGroupIndex=0,r[t].geometry.properties.originElements=r[t].geometry.properties.elements.slice()}this.meshes=e,n&&(this.Qa=n),this.Ll=!1,this.setToRedraw()}))}}),GW.registerRenderer("canvas",null);class qW extends qH{static fromJSON(t){return UW(t,"PolygonLayer",qW)}}qW.registerJSONType("PolygonLayer");const XW={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonPatternFile:{type:"identity",default:void 0,property:"_symbol_polygonPatternFile"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},uvScale:{type:"identity",default:[1,1],property:"_symbol_uvScale"},uvOffset:{type:"identity",default:[0,0],property:"_symbol_uvOffset"},uvOffsetInMeter:{type:"identity",default:!1,property:"_symbol_uvOffsetInMeter"},polygonPatternFileWidth:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileWidth"},polygonPatternFileHeight:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileHeight"},polygonPatternFileOrigin:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileOrigin"},polygonPatternUV:{type:"identity",default:void 0,property:"_symbol_polygonPatternUV"}};class ZW extends RW{constructor(){super(...arguments),this.GeometryTypes=[c,v]}getPolygonOffsetCount(){return this.options.altitude>0?0:2}buildMesh(t){const{features:e,center:n}=this.ol();if(!e.length)return;const r=this.Qa;this.Gl=n;const i=this.Bl(e),o=MB({},XW),s=i.map(((e,r)=>this.createMesh(this.painter,iB,o,e,t&&t[r],n)));this.Ll=!0,Promise.all(s).then((t=>{this.meshes&&this.painter.deleteMesh(this.meshes),t=function(t){const e=[];for(let n=0;n<t.length;n++)Array.isArray(t[n])?e.push(...t[n]):e.push(t[n]);return e}(t);const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r]&&t[r].meshes;if(i){e.push(...i);for(let t=0;t<i.length;t++)i[t].feaGroupIndex=r,i[t].geometry.properties.originElements=i[t].geometry.properties.elements.slice(),1===r&&(i[t].transparent=!0);n[r]=t[r].atlas}}this.meshes=e,this.atlas=n,r&&(this.Qa=r),this.Ll=!1,this.setToRedraw(),this.layer.fire("buildmesh")}))}getRayCastData(t,e){const n=this.painter.getRayCastData(t,e);if(!n||!n.feature)return null;const r=n.feature[bW];return this.Ea[r]}Bl(t){const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r];i.properties&&i.properties._symbol_polygonOpacity<1?n.push(i):e.push(i)}return[e,n]}createPainter(){const t=qH.get3DPainterClass("fill"),e=this.painterSymbol=MB({},XW);return this.Nl(e,t.getBloomSymbol()),new t(this.regl,this.layer,e,this.layer.options.sceneConfig,0)}updateMesh(t){return this.Sl(t,this.meshes,this.atlas,this.Gl,this.painter,iB,XW,this.Bl)}}function YW(t,e,n,r,i,o,s){const a=n&&Array.isArray(n[0]);for(let l=0,h=n.length;l<h;l++){t[e]=(a?n[l][0]:n[l].x)*r,t[e+1]=(a?n[l][1]:n[l].y)*r,s!==Float32Array&&(t[e]=Math.round(t[e]),t[e+1]=Math.round(t[e+1]));let o=i||0;Array.isArray(i)&&(o=i[l]),o=o?Math.round(r*o):0,t[e+2]=o,e+=3}return t.trySetLength&&t.trySetLength(e),e}qW.registerRenderer("gl",ZW),qW.registerRenderer("canvas",null);const JW=Math.PI/180,QW=6378137*Math.PI/180,KW=85.0511287798;function $W(t,e,n){return function(t,e){const n=KW,r=e[0],i=Math.max(Math.min(n,e[1]),-n);let o;return o=0===i?0:Math.log(Math.tan((90+i)*JW/2))/JW,t[0]=r*QW,t[1]=o*QW,t}(t,e)}function tq(t,e,n,r){const i=n[0]-r[0],o=n[1]-r[1];let s=(e[0]-n[0])*(n[0]-r[0])+(e[1]-n[1])*(n[1]-r[1]);return s/=i*i+o*o,t[0]=n[0]+s*i,t[1]=n[1]+s*o,t}function eq(t,e,n,r,i){const o=3*e[n-1],s=3*e[n-1]+1;return a=r,l=i,h=t[o],u=t[s],Math.sqrt((h-a)*(h-a)+(u-l)*(u-l));var a,l,h,u}function nq(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g,m){const A=e.getLength(),y=i/3;for(let x=2,_=A;x<_;x+=3)t[i+x-2]=e[x-2],t[i+x-1]=e[x-1],t[i+x-0]=e[x]-s;i+=A;for(let x=2,_=A;x<_;x+=3)t[i+x-2]=e[x-2],t[i+x-1]=e[x-1],t[i+x-0]=e[x]-a;i+=A,t.trySetLength(i+A),t.copyWithin(i,i-2*A,i-A),i+=A,t.trySetLength(i+A),t.copyWithin(i,i-2*A,i-A),i+=A,(n=n||[]).push(A/3);const v=n.getLength();for(let x=0;x<v;x++)rq(y+(n[x-1]||0),y+n[x],t,A/3,l,r,h,u,c,f,o,d,p,g,m);return i}function rq(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p){const g=o.getLength();let m,A;for(let y=t,v=e;y<v-1;y++)if(m=y,A=y+1,i===1/0)if((y-t)%2==1&&(m+=2*r,A+=2*r),p){let t=o.currentIndex;o[t++]=m+r,o[t++]=A,o[t++]=m,o[t++]=A+r,o[t++]=A,o[t++]=m+r,o.currentIndex=t}else{let t=o.currentIndex;o[t++]=m+r,o[t++]=m,o[t++]=A,o[t++]=A,o[t++]=A+r,o[t++]=m+r,o.currentIndex=t}s&&function(t,e,n,r,i,o,s,a,l,h,u,c){let f,d=0,p=0,g=0,m=0;const A=c?[1,3,4]:[2,3,4];for(let y=o.getLength()-1;y>=s;y--){const s=o[y],c=3*s+1,v=3*s+2,x=i[3*s],_=i[c],b=i[v];d||p||(d=Math.max(i[v],i[3*o[y-3]+2]),p=Math.min(i[v],i[3*o[y-3]+2]),f=d-p);let w=g;const T=y%6;0===t?(5===T&&(m=eq(i,o,y,x,_)),w=T===A[0]||T===A[1]||T===A[2]?g:g+m):1===t&&(T===A[0]||T===A[1]||T===A[2]?w=0:5===T?(m=eq(i,o,y,x,_),w=m):w=m);const M=w/h*(1/(100*u))/a;let C;C=1===e?b===d?1:0:"bottom"===n?b===d?f/100/l:0:b===d?0:-f/100/l,r[2*s]=M,r[2*s+1]=C,0===T&&(g+=m)}}(a,l,h,u,n,o,g,c[0],c[1],f,d,p)}function iq(t){const e=[t[0]];let n=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===n[0]&&t[r][1]===n[1]&&t[r][2]===n[2]||e.push(t[r]):t[r].x===n.x&&t[r].y===n.y&&t[r].z===n.z||e.push(t[r]),n=t[r];return e}const oq=EF.getInstance();function sq(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p,g){void 0===e.top&&(e.top=!0),void 0===e.side&&(e.side=!0),oq.reset();const{altitudeScale:m,altitudeProperty:A,defaultAltitude:y,heightProperty:v,minHeightProperty:x,defaultHeight:_,tangent:b,uv:w,topUVMode:T,sideUVMode:M,sideVerticalUVMode:C,top:S,side:I,textureYOrigin:P,topThickness:E}=e,O=!!g,R=function(t,e,{altitudeScale:n,altitudeProperty:r,defaultAltitude:i,heightProperty:o,minHeightProperty:s,defaultHeight:a},{center:l,side:h,top:u,topThickness:c,uvOrigin:f,uv:d,uvSize:p,topUVMode:g,sideUVMode:m,sideVerticalUVMode:A,textureYOrigin:y,tileRatio:v,centimeterToPoint:x,verticalCentimeterToPoint:_,positionType:b,res:w,glScale:T,projectionCode:M},C,S){let I=e/t[0].extent;I=1;const P=e===1/0,E=S.get(),O=S.get(),R=S.get(),k=S.getProxy(),L=S.get(),D=S.get(),N=S.get(),F=!!d,z=!!u,B=!!h,H=F?S.get():null;function j(t,n,r,i,o,s){let a=n;if(z){const h=HR(k,r,3);if(0===h.length)return n;let u=k.getLength(),d=L.currentIndex;for(let t=0;t<u;t++)L[d++]=k[t];if(L.currentIndex=d,n+=k.getLength(),s)for(let e=2,n=h.length;e<n;e+=3)h[e]+=t/3,h[e-1]+=t/3,h[e-2]+=t/3;u=h.length,d=D.currentIndex;for(let t=0;t<u;t++)D[d++]=h[t];D.currentIndex=d,F&&function(t,e,n,r,i,o,s,a,l,h,u,c,f,d,p){0===t?function(t,e,n,r,i,o,s,a,l,h){const u=1/(100*o[0]),c=1/(100*o[1]),f=h&&h[0]||0,d=h&&h[1]||0,p=[0,0];for(let g=t;g<e;g+=3){const t=g/3*2,e=r[g]-f,i=r[g+1]-d;n[t]=p[0]+e/s*u/a,n[t+1]=p[1]-i/s*c/l}}(e,n,r,i,0,s,a,l,h,p):1===t&&function(t,e,n,r,i,o,s,a,l,h,u){if(!t)return;let c,f,d,p;0===t[4]?(c=t[0],f=t[1],d=t[2],p=t[3]):(c=t[1],f=t[2],d=t[3],p=t[0]);const g=Hy(c,f),m=Hy(f,d),A=[],y=[],v=[];for(let x=e;x<n;x+=3){const t=x/3*2;Ly(A,(o.x/l+i[x]/s)*a,o.y/l*a+(u?i[x+1]:-i[x+1])/s*a),"EPSG:4326"!==h&&"EPSG:4490"!==h||$W(A,A),tq(y,A,c,f),tq(v,A,p,c),r[t]=Hy(c,y)/g,r[t+1]=Hy(c,v)/m}}(u,e,n,r,i,o,a,c,f,d,!!p)}(g||0,t,n,H,L,f,x,v,p[0],p[1],o,w,T,M,l),c>0&&!B&&(n=nq(L,k,r,D,n,H,0,c,e,F,m||0,A||0,y,p,v,_,i<0?!s:s)),N.setLength(n/3),N.fill(1,a/3,n/3)}if(B){z&&(c=0),a=n,n=nq(L,k,r,D,n,H,c,i,e,F,m||0,A||0,y,p,v,_,i<0?!s:s),N.setLength(n/3);const t=k.getLength()/3;N.fill(1,a/3,a/3+t),N.fill(0,a/3+t,a/3+2*t),N.fill(1,a/3+2*t,a/3+3*t),N.fill(0,a/3+3*t,n/3)}return n}let U=0,V=0,G=0,W=t.length;SB(C)&&(G=C,W=C+1);let q=0,X=!1;const Z=S.getProxy();let Y=!1;for(;G<W;G++){const e=t[G],l=e.id;SB(l)&&(Math.abs(l)>q&&(q=Math.abs(l)),l<0&&(X=!0));const h=e.geometry,u=e.properties[QB];let c=Array.isArray(u&&u[0]&&u[0][0])?u[0]:u;const{altitude:f,height:d}=Gk(e,n,r,i,o,a,s);d<0&&(Y=!0),U=Math.max(Math.abs(f),U);const p=L.getLength();let g=0,m=V;Z.setLength(0),k.setLength(0);const A=Uk(h[0])<0;for(let t=0,n=h.length;t<n;t++){let e=h[t];A&&(e=e.reverse()),e=iq(e);const r=Uk(e)<0;if(!r&&t>0&&(g++,c=u&&u[g],V=j(m,V,Z,1*d,c,P),k.setLength(0),Z.setLength(0),m=V),!e.length){t===n-1&&(V=j(m,V,Z,1*d,c,P));continue}const i=e.length;if(Array.isArray(e[0])?e[0][0]===e[i-1][0]&&e[0][1]===e[i-1][1]||e.push([e[0][0],e[0][1]]):e[0].x===e[i-1].x&&e[0].y===e[i-1].y||e.push(e[0]),r){let t=Z.currentIndex;Z[t++]=k.getLength()/3,Z.currentIndex=t}YW(k,k.getLength(),e,1,f,0,b),t===n-1&&(V=j(m,V,Z,1*d,c,P))}const y=L.getLength()-p,v=(ZB+"").trim();for(let t=0;t<y/3;t++){let t=O.currentIndex;O[t++]=void 0===e[v]?G:e[v],O.currentIndex=t,t=E.currentIndex,E[t++]=G,E.currentIndex=t,SB(l)&&(t=R.currentIndex,R[t++]=l,R.currentIndex=t)}}const J=nL(O.getLength()?O[O.getLength()-1]:0),Q={hasNegativeHeight:Y,maxAltitude:U,vertices:L,verticeTypes:N,indices:D,pickingIds:EF.createTypedArray(O,J),featureIndexes:E};if(R.getLength()){const t=X?eL(q):nL(q);Q.featureIds=EF.createTypedArray(R,t)}else Q.featureIds=[];return H&&(H.setLength(L.getLength()/3*2),Q.uvs=H),Q}(t,n,{altitudeScale:m,altitudeProperty:A,defaultAltitude:y||0,heightProperty:v,minHeightProperty:x,defaultHeight:_||0},{center:g,top:S,side:I,topThickness:10*E||0,uv:w||b,uvSize:[i,i],uvOrigin:r,topUVMode:T,sideUVMode:M,sideVerticalUVMode:C,textureYOrigin:P,tileRatio:a,centimeterToPoint:l,verticalCentimeterToPoint:h,positionType:p,res:o,glScale:s,projectionCode:f},d,oq),k=[],L=R.vertices.getLength()/3,D=tL(L),N=EF.createTypedArray(R.indices,D);delete R.indices,k.push(N.buffer,R.pickingIds.buffer);const F=p||eL(Math.max(512,R.maxAltitude));R.vertices=EF.createTypedArray(R.vertices,F);const z=b?oq.getProxy():new Float32Array(3*L);z.setLength&&z.setLength(3*L);const B=Tv(R.vertices,N,z);let H=!0;const j=B.getLength?B.getLength():B.length;for(let W=0;W<j;W++){O||(B[W]=-B[W]);const t=B[W]%1;1-Math.abs(t)>1e-6?H=!1:0!==t&&(B[W]=Math.round(B[W]))}if(R.normals=B,b){let t=oq.get();t.setLength(4*L),t=kv(R.vertices,R.normals,R.uvs,N,t),t=function(t,e){const n=e.getLength(),r=new Float32Array(n),i=[],o=[],s=[];for(let a=0;a<n;a+=4){const n=a/4*3;Lm(o,t[n]||0,t[n+1]||0,t[n+2]||0),cA(i,e[a]||0,e[a+1]||0,e[a+2]||0,e[a+3]||0),bv(s,o,i),uA(r.subarray(a,a+4),s)}return r}(R.normals,t),R.tangents=t,k.push(t.buffer),delete R.normals}if(R.normals&&(H&&(R.normals=EF.createTypedArray(R.normals,Int8Array)),k.push(R.normals.buffer)),R.uvs){const t=R.uvs;R.uvs=EF.createTypedArray(t,Float32Array),k.push(R.uvs.buffer)}if(g){const t=R.vertices,e=t.length;for(let n=0;n<e;n+=3)t[n]-=g[0],t[n+1]-=g[1]}const U=function(t,e,n,r){const i={},o={},s=r.getLength();if(RB(e.polygonFill)){let a=oO(e.polygonFill);const l=new Uint8Array(4*s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let h=a(n,s);nO(h)&&(i.aColor=1,a=oO(h),h=a(n,s)),delete s.$layer,delete s.$type,pL(aq,h),l[4*e]=aq[0],l[4*e+1]=aq[1],l[4*e+2]=aq[2],l[4*e+3]=aq[3]}o.aColor=l}if(RB(e.polygonOpacity)){let a=iO(e.polygonOpacity);const l=new Uint8Array(s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let h=a(n,s);nO(h)&&(i.aOpacity=1,a=oO(h),h=a(n,s)),delete s.$layer,delete s.$type,l[e]=255*h}o.aOpacity=l}return o.dynamicAttributes=i,o}(t,u,c,R.featureIndexes),V=function(t,e,n,r,i){const o=[[],[]],s=RB(r.topPolygonFill),a=RB(r.bottomPolygonFill),l=[255,255,255,255],h=e.getLength();if(s||a){let u=s&&oO(r.topPolygonFill),c=a&&oO(r.bottomPolygonFill),f=null,d=null,p=null,g=null;for(let r=0;r<h;r++){if(1===t[r]&&!s||0===t[r]&&!a)continue;const h=1===t[r];if(h&&e[r]===f){t[r]=p;continue}if(!h&&e[r]===d){t[r]=g;continue}const m=n[e[r]],A=m.properties||{};A.$layer=m.layer,A.$type=m.type;let y=h?u:c,v=y(i,A);nO(v)&&(y=oO(v),v=y(i,A)),delete A.$layer,delete A.$type,pL(aq,v),gA(aq,aq,l);let x=lq(o,aq);x<0&&(x=o.length,o.push(uA([],aq))),t[r]=x,h?(f=e[r],p=x):(d=e[r],g=x)}}return o.slice(2)}(R.verticeTypes,R.featureIndexes,t,u,c),G={data:{data:{aVertexColorType:V.length<=252?EF.createTypedArray(R.verticeTypes,Uint8Array):EF.createTypedArray(R.verticeTypes,Uint16Array),aPosition:R.vertices,aNormal:R.normals,aTexCoord0:R.uvs,aTangent:R.tangents,aPickingId:R.pickingIds},indices:N,properties:{maxAltitude:R.maxAltitude,hasNegativeHeight:R.hasNegativeHeight},dynamicAttributes:U.dynamicAttributes,vertexColors:V},buffers:k};return R.featureIds.length?(G.data.featureIds=R.featureIds,k.push(G.data.featureIds.buffer)):G.data.featureIds=[],U.aColor&&(G.data.data.aColor=U.aColor,G.buffers.push(U.aColor.buffer)),U.aOpacity&&(G.data.data.aOpacity=U.aOpacity,G.buffers.push(U.aOpacity.buffer)),G.buffers.push(G.data.data.aPosition.buffer),G.data.pickingIdIndiceMap=Zk(G.data.data.aPickingId,G.data.indices),G}const aq=[];function lq(t,e){for(let n=0;n<t.length;n++)if(MA(e,t[n]))return n;return-1}var hq={exports:{}},uq=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=(r-n)/2,l=0,h=a-1;l<a;h=l++){var u=e[n+2*l+0],c=e[n+2*l+1],f=e[n+2*h+0],d=e[n+2*h+1];c>o!=d>o&&i<(f-u)*(o-c)/(d-c)+u&&(s=!s)}return s},cq=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=r-n,l=0,h=a-1;l<a;h=l++){var u=e[l+n][0],c=e[l+n][1],f=e[h+n][0],d=e[h+n][1];c>o!=d>o&&i<(f-u)*(o-c)/(d-c)+u&&(s=!s)}return s};hq.exports=function(t,e,n,r){return e.length>0&&Array.isArray(e[0])?cq(t,e,n,r):uq(t,e,n,r)};var fq=hq.exports.nested=cq;hq.exports.flat=uq;const dq=11102230246251565e-32,pq=134217729,gq=(3+8*dq)*dq;function mq(t,e,n,r,i){let o,s,a,l,h=e[0],u=r[0],c=0,f=0;u>h==u>-h?(o=h,h=e[++c]):(o=u,u=r[++f]);let d=0;if(c<t&&f<n)for(u>h==u>-h?(s=h+o,a=o-(s-h),h=e[++c]):(s=u+o,a=o-(s-u),u=r[++f]),o=s,0!==a&&(i[d++]=a);c<t&&f<n;)u>h==u>-h?(s=o+h,l=s-o,a=o-(s-l)+(h-l),h=e[++c]):(s=o+u,l=s-o,a=o-(s-l)+(u-l),u=r[++f]),o=s,0!==a&&(i[d++]=a);for(;c<t;)s=o+h,l=s-o,a=o-(s-l)+(h-l),h=e[++c],o=s,0!==a&&(i[d++]=a);for(;f<n;)s=o+u,l=s-o,a=o-(s-l)+(u-l),u=r[++f],o=s,0!==a&&(i[d++]=a);return 0===o&&0!==d||(i[d++]=o),d}function Aq(t){return new Float64Array(t)}const yq=33306690738754716e-32,vq=22204460492503146e-32,xq=11093356479670487e-47,_q=Aq(4),bq=Aq(8),wq=Aq(12),Tq=Aq(16),Mq=Aq(4);function Cq(t,e,n,r,i,o,s){for(var a=new Sz([],Sq),l=t.data;l;){for(var h=0;h<l.children.length;h++){var u=l.children[h],c=l.leaf?Dq(u,n,r):Iq(n,r,u);c>o||a.push({node:u,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=Dq(d,e,n),g=Dq(d,r,i);if(f.dist<p&&f.dist<g&&Eq(n,d,s)&&Eq(r,d,s))return d}(l=a.pop())&&(l=l.node)}return null}function Sq(t,e){return t.dist-e.dist}function Iq(t,e,n){if(Pq(t,n)||Pq(e,n))return 0;var r=Nq(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===r)return 0;var i=Nq(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===i)return 0;var o=Nq(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===o)return 0;var s=Nq(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===s?0:Math.min(r,i,o,s)}function Pq(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function Eq(t,e,n){for(var r,i,o,s,a=Math.min(t[0],e[0]),l=Math.min(t[1],e[1]),h=Math.max(t[0],e[0]),u=Math.max(t[1],e[1]),c=n.search({minX:a,minY:l,maxX:h,maxY:u}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,o=t,r!==(s=e)&&i!==o&&Oq(r,i,o)>0!=Oq(r,i,s)>0&&Oq(o,s,r)>0!=Oq(o,s,i)>0)return!1;return!0}function Oq(t,e,n){return function(t,e,n,r,i,o){const s=(e-o)*(n-i),a=(t-i)*(r-o),l=s-a;if(0===s||0===a||s>0!=a>0)return l;const h=Math.abs(s+a);return Math.abs(l)>=yq*h?l:-function(t,e,n,r,i,o,s){let a,l,h,u,c,f,d,p,g,m,A,y,v,x,_,b,w,T;const M=t-i,C=n-i,S=e-o,I=r-o;x=M*I,f=pq*M,d=f-(f-M),p=M-d,f=pq*I,g=f-(f-I),m=I-g,_=p*m-(x-d*g-p*g-d*m),b=S*C,f=pq*S,d=f-(f-S),p=S-d,f=pq*C,g=f-(f-C),m=C-g,w=p*m-(b-d*g-p*g-d*m),A=_-w,c=_-A,_q[0]=_-(A+c)+(c-w),y=x+A,c=y-x,v=x-(y-c)+(A-c),A=v-b,c=v-A,_q[1]=v-(A+c)+(c-b),T=y+A,c=T-y,_q[2]=y-(T-c)+(A-c),_q[3]=T;let P=function(t,e){let n=e[0];for(let r=1;r<4;r++)n+=e[r];return n}(0,_q),E=vq*s;if(P>=E||-P>=E)return P;if(c=t-M,a=t-(M+c)+(c-i),c=n-C,h=n-(C+c)+(c-i),c=e-S,l=e-(S+c)+(c-o),c=r-I,u=r-(I+c)+(c-o),0===a&&0===l&&0===h&&0===u)return P;if(E=xq*s+gq*Math.abs(P),P+=M*u+I*a-(S*h+C*l),P>=E||-P>=E)return P;x=a*I,f=pq*a,d=f-(f-a),p=a-d,f=pq*I,g=f-(f-I),m=I-g,_=p*m-(x-d*g-p*g-d*m),b=l*C,f=pq*l,d=f-(f-l),p=l-d,f=pq*C,g=f-(f-C),m=C-g,w=p*m-(b-d*g-p*g-d*m),A=_-w,c=_-A,Mq[0]=_-(A+c)+(c-w),y=x+A,c=y-x,v=x-(y-c)+(A-c),A=v-b,c=v-A,Mq[1]=v-(A+c)+(c-b),T=y+A,c=T-y,Mq[2]=y-(T-c)+(A-c),Mq[3]=T;const O=mq(4,_q,4,Mq,bq);x=M*u,f=pq*M,d=f-(f-M),p=M-d,f=pq*u,g=f-(f-u),m=u-g,_=p*m-(x-d*g-p*g-d*m),b=S*h,f=pq*S,d=f-(f-S),p=S-d,f=pq*h,g=f-(f-h),m=h-g,w=p*m-(b-d*g-p*g-d*m),A=_-w,c=_-A,Mq[0]=_-(A+c)+(c-w),y=x+A,c=y-x,v=x-(y-c)+(A-c),A=v-b,c=v-A,Mq[1]=v-(A+c)+(c-b),T=y+A,c=T-y,Mq[2]=y-(T-c)+(A-c),Mq[3]=T;const R=mq(O,bq,4,Mq,wq);x=a*u,f=pq*a,d=f-(f-a),p=a-d,f=pq*u,g=f-(f-u),m=u-g,_=p*m-(x-d*g-p*g-d*m),b=l*h,f=pq*l,d=f-(f-l),p=l-d,f=pq*h,g=f-(f-h),m=h-g,w=p*m-(b-d*g-p*g-d*m),A=_-w,c=_-A,Mq[0]=_-(A+c)+(c-w),y=x+A,c=y-x,v=x-(y-c)+(A-c),A=v-b,c=v-A,Mq[1]=v-(A+c)+(c-b),T=y+A,c=T-y,Mq[2]=y-(T-c)+(A-c),Mq[3]=T;const k=mq(R,wq,4,Mq,Tq);return Tq[k-1]}(t,e,n,r,i,o,h)}(t[0],t[1],e[0],e[1],n[0],n[1])}function Rq(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function kq(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function Lq(t,e){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function Dq(t,e,n){var r=e[0],i=e[1],o=n[0]-r,s=n[1]-i;if(0!==o||0!==s){var a=((t[0]-r)*o+(t[1]-i)*s)/(o*o+s*s);a>1?(r=n[0],i=n[1]):a>0&&(r+=o*a,i+=s*a)}return(o=t[0]-r)*o+(s=t[1]-i)*s}function Nq(t,e,n,r,i,o,s,a){var l,h,u,c,f=n-t,d=r-e,p=s-i,g=a-o,m=t-i,A=e-o,y=f*f+d*d,v=f*p+d*g,x=p*p+g*g,_=f*m+d*A,b=p*m+g*A,w=y*x-v*v,T=w,M=w;0===w?(h=0,T=1,c=b,M=x):(c=y*b-v*_,(h=v*b-x*_)<0?(h=0,c=b,M=x):h>T&&(h=T,c=b+v,M=x)),c<0?(c=0,-_<0?h=0:-_>y?h=T:(h=-_,T=y)):c>M&&(c=M,-_+v<0?h=0:-_+v>y?h=T:(h=-_+v,T=y));var C=(1-(u=0===c?0:c/M))*i+u*s-((1-(l=0===h?0:h/T))*t+l*n),S=(1-u)*o+u*a-((1-l)*e+l*r);return C*C+S*S}function Fq(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}class zq{constructor(t,e){this.x=t,this.y=e}clone(){return new zq(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new zq(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new zq(this.y,-this.x)}}function Bq(t,e,n,r){const i=e.x*r.y-e.y*r.x,o=n.x-t.x,s=n.y-t.y,a=(o*r.y-s*r.x)/i;return new zq(t.x+a*e.x,t.y+a*e.y)}const Hq=[],jq=[];function Uq(t){if(SB(t[0]&&t[0].x)){const e=[];let n=0;for(let r=0;r<t.length;r++)jq[n]?(jq[n][0]=t[r].x,jq[n][1]=t[r].y):jq[n]=[t[r].x,t[r].y],e.push(jq[n]),n++;t=e}try{const e=function(t,e,n){e=Math.max(0,void 0===e?2:e),n=n||0;var r=function(t){for(var e=t[0],n=t[0],r=t[0],i=t[0],o=0;o<t.length;o++){var s=t[o];s[0]<e[0]&&(e=s),s[0]>r[0]&&(r=s),s[1]<n[1]&&(n=s),s[1]>i[1]&&(i=s)}var a=[e,n,r,i],l=a.slice();for(o=0;o<t.length;o++)fq(t[o],a)||l.push(t[o]);return function(t){t.sort(Fq);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&Oq(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&Oq(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),e.pop(),e.concat(r)}(l)}(t),i=new lk(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,e){return t[0]-e[0]},i.compareMinY=function(t,e){return t[1]-e[1]},i.load(t);for(var o,s=[],a=0;a<r.length;a++){var l=r[a];i.remove(l),o=kq(l,o),s.push(o)}var h=new lk(16);for(a=0;a<s.length;a++)h.insert(Rq(s[a]));for(var u=e*e,c=n*n;s.length;){var f=s.shift(),d=f.p,p=f.next.p,g=Lq(d,p);if(!(g<c)){var m=g/u;(l=Cq(i,f.prev.p,d,p,f.next.next.p,m,h))&&Math.min(Lq(l,d),Lq(l,p))<=m&&(s.push(f),s.push(kq(l,f)),i.remove(l),h.remove(f),h.insert(Rq(f)),h.insert(Rq(f.next)))}}f=o;var A=[];do{A.push(f.p),f=f.next}while(f!==o);return A.push(f.p),A}(t,1/0);let n=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<e.length;t++)e[t][0]<n[0]&&(n[0]=e[t][0]),e[t][0]>r[0]&&(r[0]=e[t][0]),e[t][1]<n[1]&&(n[1]=e[t][1]),e[t][1]>r[1]&&(r[1]=e[t][1]);const i=[];let o=[],s=0;for(let t=0;t<e.length;t++)t===e.length-1&&e[t][0]===e[0][0]&&e[t][1]===e[0][1]||($W(i,e[t]),Hq[s]?(Hq[s].x=i[0],Hq[s].y=i[1]):Hq[s]=new zq(i[0],i[1]),o.push(Hq[s]),s++);Uk(o)<0&&(o=o.reverse());const a=function(t){let e,n=Number.MAX_VALUE;var r=[];for(let P=0;P<t.length;P++)r.push(t[(P+1)%t.length].diff(t[P])),r[P].normalize();var i,o,s,a,l=new zq(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new zq(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let P=0;P<t.length;P++){var u=t[P];u.x<l.x&&(l.x=u.x,i=P),u.x>h.x&&(h.x=u.x,o=P),u.y<l.y&&(l.y=u.y,a=P),u.y>h.y&&(h.y=u.y,s=P)}var c,f,d,p,g,m,A,y,v,x,_,b,w,T=new zq(0,-1),M=new zq(0,1),C=new zq(-1,0),S=new zq(1,0);for(let P=0;P<t.length;P++){var I=[Math.acos(T.dot(r[i])),Math.acos(M.dot(r[o])),Math.acos(C.dot(r[s])),Math.acos(S.dot(r[a]))];switch(I.indexOf(Math.min.apply(Math,I))){case 0:(M=(T=r[i].clone()).clone()).negate(),(S=(C=T.orthogonal()).clone()).negate(),i=(i+1)%t.length;break;case 1:(T=(M=r[o].clone()).clone()).negate(),(S=(C=T.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 2:(S=(C=r[s].clone()).clone()).negate(),(M=(T=S.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 3:(C=(S=r[a].clone()).clone()).negate(),(M=(T=S.orthogonal()).clone()).negate(),a=(a+1)%t.length}c=t[i],f=T,d=t[o],p=M,g=t[s],m=C,A=t[a],y=S,v=void 0,x=void 0,_=void 0,b=void 0,w=void 0,v=Bq(c,f,g,m),x=Bq(d,p,g,m),_=Bq(A,y,c,f),b=Bq(A,y,d,p),0!==(w=v.distance(x)*v.distance(_))&&w<n&&(e=[v,_,b,x],n=w)}return e}(o);if(!a||4!==a.length)return null;const l=a[0].distance(a[1]),h=a[1].distance(a[2]),u=a.map((t=>[t.x,t.y]));return u.push(+(h>l)),u}catch(e){return null}}class Vq extends qH{static fromJSON(t){return UW(t,"ExtrudePolygonLayer",Vq)}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}onConfig(t){const e=this.getRenderer();return e&&e.onConfig(t),super.onConfig(t)}updateMaterial(t){this.options.material||(this.options.material={}),t?MB(this.options.material,t):this.options.material=null;const e=this.getRenderer();return e&&e.updateMaterial(t),this}updateSideMaterial(t){let e=!1;this.options.sideMaterial||(this.options.sideMaterial={},e=!0),t?MB(this.options.sideMaterial,t):this.options.sideMaterial=null;const n=this.getRenderer();return n&&(e&&n.$l(),n.updateSideMaterial(t)),this}updateDataConfig(t){if(!t)return this;this.options.dataConfig||(this.options.dataConfig={});const e=JSON.parse(JSON.stringify(this.options.dataConfig));MB(this.options.dataConfig,t);const n=this.getRenderer();return n&&n.updateDataConfig(t,e),this}}Vq.registerJSONType("ExtrudePolygonLayer"),Vq.mergeOptions({cullFace:!1,castShadow:!0});const Gq={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},topPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_topPolygonFill"},bottomPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_bottomPolygonFill"}},Wq={defaultAltitude:20},qq=t=>1===t.properties.top;if(Vq.registerRenderer("gl",class extends ZW{constructor(...t){super(...t),this.GeometryTypes=[c,v]}Bl(t){return[t]}onConfig(t){this.painter&&(EB(t.cullFace)||this.painter.updateSceneConfig({cullFace:t.cullFace}))}updateMaterial(t){this.painter&&(this.painter.Ao(t),this.layer.options.sideMaterial||this.sidePainter.Ao(t),this.setToRedraw())}$l(){this.sidePainter&&this.sidePainter.deleteMaterial()}updateSideMaterial(t){this.sidePainter&&(t?this.sidePainter.Ao(t):(this.sidePainter.deleteMaterial(),this.sidePainter.Ao(this.layer.options.material)),this.setToRedraw())}updateDataConfig(t,e){this.painter&&(this.painter.updateDataConfig(t,e),this.Ml())}updateBloom(t){super.updateBloom(t),this.sidePainter&&this.Ul(this.sidePainter,this.sidePainterSymbol,t)}needCheckPointLineSymbols(){return!1}draw(t,e){return super.draw(t,e)}createPainter(){const t=qH.get3DPainterClass("lit");this.painterSymbol=MB({},Gq),this.sidePainterSymbol=MB({},Gq),this.Nl(this.painterSymbol,t.getBloomSymbol());const e=this.layer,n=MB({},Wq,e.options.dataConfig||{});e.options.material&&(this.painterSymbol.material=e.options.material),e.options.sideMaterial?this.sidePainterSymbol.material=e.options.sideMaterial:this.sidePainterSymbol.material=e.options.material;const r={cullFace:e.options.cullFace};Object.defineProperty(r,"castShadow",{enumerable:!0,get:()=>e.options.castShadow}),Object.defineProperty(r,"depthMask",{enumerable:!0,get:()=>e.options.depthMask});const i=MB({},n);i.upsideUpTexture=!0;const o=new t(this.regl,e,this.painterSymbol,r,0,i);return this.sidePainter=new t(this.regl,e,this.sidePainterSymbol,r,0,n),o}an(...t){super.an(...t);const e=this.painter;this.painter=this.sidePainter,super.an(...t),this.painter=e}il(...t){const e=t[0],n=e.sceneFilter;e.sceneFilter=t=>(!n||n(t))&&qq(t);const r=super.il(...t);e.sceneFilter=t=>(!n||n(t))&&qq(t);const i=this.painter;this.painter=this.sidePainter;const o=e.sceneFilter=t=>(!n||n(t))&&1===t.properties.side;return super.il(...t),this.painter=i,e.sceneFilter=n,{redraw:r.redraw||o.redraw,drawCount:(r.drawCount||0)+(o.drawCount||0)}}createMesh(t,e,n,r,i,o){const s=[];this.Wl=o;const a=this.Xl(r,n,!0,!1),l=this.Xl(r,n,!1,!0);if(a){const i=this.ll(a,t,e,n,r,null,o);i.meshes[0].properties.top=1,s.push(i)}if(l){const i=this.ll(l,t,e,n,r,null,o);i.meshes[0].properties.side=1,s.push(i)}return s}Xl(t,e,r,o){const s=this.getMap();e=Gq;const a=this.Wl,l=s.getZoom(),h=new i(0,0),u=new n(0,0),c=MB({},Wq,this.layer.options.dataConfig);if(c.uv=!0,c.top&&(c.top=r),c.side&&(c.side=o),!1===c.top&&!1===c.side)return null;if(!t.length)return null;const f=s.getGLRes(),d=s.getProjection().code,p=r?this.painterSymbol&&this.painterSymbol.material:this.sidePainterSymbol&&this.sidePainterSymbol.material,g=p&&p.textureWidth||23.25,m=[_H(s,1,u,f)/100,_H(s,1,u,f,1)/100];return sq(t,c,1/0,h,g,s.getGLRes(),1,1,m,this.nn,e,l,d,void 0,Float32Array,a)}updateMesh(t){const e=t[bW];let n=this.features[e];if(!n||!this.meshes)return;const r=this.Xl([n],this.painterSymbol,!0,!1);let i=0;r&&r.data&&this.Tl(this.meshes[i++],n.id,r);const o=this.Xl([n],this.painterSymbol,!1,!0);o&&o.data&&this.Tl(this.meshes[i++],n.id,o)}Al(t){if(t.getProperties()||t.setProperties({}),!t.getProperties()[QB]){const e=t.getCoordinates();if(t instanceof v){const n=[];for(let t=0;t<e.length;t++){const r=e[t]&&e[t][0];n[t]=Uq(r)}t.getProperties()[QB]=n}else{const n=Uq(e[0]);t.getProperties()[QB]=n}}return super.Al(t)}resizeCanvas(t){super.resizeCanvas(t),this.sidePainter&&this.sidePainter.resize(this.canvas.width,this.canvas.height)}onRemove(){super.onRemove(),this.sidePainter&&(this.sidePainter.delete(),delete this.sidePainter)}drawOutline(t){if(super.drawOutline(t),this.mn&&this.sidePainter&&this.sidePainter.outlineAll(t),this.jl)for(let e=0;e<this.jl.length;e++)this.sidePainter&&this.sidePainter.outline(t,this.jl[e])}getShadowMeshes(){return this.painter?this.painter.getShadowMeshes():[]}}),Vq.registerRenderer("canvas",null),L_.register("vt_position_vert","#ifdef HAS_TERRAIN_ALTITUDE\n    attribute float aTerrainAltitude;\n#endif\nuniform float minAltitude;\n#ifdef HAS_ALTITUDE\n    vec3 unpackVTPosition() {\n        float altitude = aAltitude;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            altitude += aTerrainAltitude * 100.0;\n        #endif\n        altitude += minAltitude * 100.0;\n        return vec3(aPosition, altitude);\n    }\n#else\n    float position_modValue = 16384.0;\n    float position_delta = 0.00001;\n    vec3 unpackVTPosition() {\n        float z = aPosition.z;\n        vec2 pos = sign(aPosition.xy + position_delta) * mod(abs(aPosition.xy), position_modValue);\n        vec2 highs = floor(abs(aPosition.xy) / position_modValue);\n        float altitude = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            altitude += aTerrainAltitude * 100.0;\n        #endif\n        altitude += minAltitude * 100.0;\n        return vec3(pos, altitude);\n    }\n#endif"),nm(),BE){const t=a.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){l("@maptalks/vt",BE.inject(wk))}else l("@maptalks/vt",(function(){return BE.inject(wk)}))}else l("@maptalks/vt",wk);for(var Xq=[],Zq=0;Zq<6;Zq++)Xq[Zq]=[];var Yq=[];function Jq(t,e,n){aX(t);for(var r=0;r<6;r++){var i=Xq[r];if(Yq[0]=i[0]>0?e[1][0]:e[0][0],Yq[1]=i[1]>0?e[1][1]:e[0][1],Yq[2]=i[2]>0?e[1][2]:e[0][2],hX(i,Yq)<0)return!1}return!0}var Qq=3,Kq=4,$q=5,tX=6,eX=7,nX=8,rX=9,iX=10,oX=11;function sX(t,e){var n=e,r=t,i=e,o=r[0],s=r[1],a=r[2],l=Math.abs(o*i[Qq]+s*i[Kq]+a*i[$q])+Math.abs(o*i[tX]+s*i[eX]+a*i[nX])+Math.abs(o*i[rX]+s*i[iX]+a*i[oX]),h=hX(t,n);return!(h<=-l)}function aX(t){var e=t,n=e[0],r=e[1],i=e[2],o=e[3],s=e[4],a=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],d=e[11],p=e[12],g=e[13],m=e[14],A=e[15];lX(Xq[0],o-n,h-s,d-u,A-p),lX(Xq[1],o+n,h+s,d+u,A+p),lX(Xq[2],o+r,h+a,d+c,A+g),lX(Xq[3],o-r,h-a,d-c,A-g),lX(Xq[4],o-i,h-l,d-f,A-m),lX(Xq[5],o+i,h+l,d+f,A+m)}function lX(t,e,n,r,i){var o=1/Math.sqrt(e*e+n*n+r*r);return t[0]=e*o,t[1]=n*o,t[2]=r*o,t[3]=i*o,t}function hX(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const uX="${",cX=`function(t){\n/*!\n   * @maptalks/gltf-loader v0.98.4\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.org\n   */\nvar e="undefined"!=typeof Float32Array?Float32Array:Array;function n(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],c=e[5],u=e[6],f=e[7],l=e[8],h=e[9],d=e[10],y=e[11],m=e[12],b=e[13],p=e[14],g=e[15],w=n[0],v=n[1],M=n[2],A=n[3];return t[0]=w*r+v*a+M*l+A*m,t[1]=w*i+v*c+M*h+A*b,t[2]=w*s+v*u+M*d+A*p,t[3]=w*o+v*f+M*y+A*g,w=n[4],v=n[5],M=n[6],A=n[7],t[4]=w*r+v*a+M*l+A*m,t[5]=w*i+v*c+M*h+A*b,t[6]=w*s+v*u+M*d+A*p,t[7]=w*o+v*f+M*y+A*g,w=n[8],v=n[9],M=n[10],A=n[11],t[8]=w*r+v*a+M*l+A*m,t[9]=w*i+v*c+M*h+A*b,t[10]=w*s+v*u+M*d+A*p,t[11]=w*o+v*f+M*y+A*g,w=n[12],v=n[13],M=n[14],A=n[15],t[12]=w*r+v*a+M*l+A*m,t[13]=w*i+v*c+M*h+A*b,t[14]=w*s+v*u+M*d+A*p,t[15]=w*o+v*f+M*y+A*g,t}function r(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function i(t,n,r){var i=new e(3);return i[0]=t,i[1]=n,i[2]=r,i}function s(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function a(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function c(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function f(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*s+n[12]*o,t[1]=n[1]*r+n[5]*i+n[9]*s+n[13]*o,t[2]=n[2]*r+n[6]*i+n[10]*s+n[14]*o,t[3]=n[3]*r+n[7]*i+n[11]*s+n[15]*o,t}function l(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),r(),function(){var t;t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var h,d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};r(),i(1,0,0),i(0,1,0),l(),l(),h=new e(9),e!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1;let y=0;function m(t){return null==t}function b(t){return!m(t)}function p(t){return!m(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function g(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function w(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function v(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function M(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=e.charCodeAt(t);return r.buffer}const A=[],T=[],_=[],k=[0,0,0],O=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),x=[1,1,1];function S(t,e,n,r,i,s,o){const a=w(o),c=a.BYTES_PER_ELEMENT;if((0===i||i===r*c)&&s%c==0){const i=new a(e,s,n*r);return t.set(i),t}0===i&&(i=r*c);const u=new Uint8Array(r*c);for(let o=0;o<n;o++){let n=null;const f=new Uint8Array(e,i*o+s,r*c);u.set(f),n=new a(u.buffer,0,r);for(let e=0;e<r;e++)t[o*r+e]=n[e]}return t}const I="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function E(t,e,n){const r=new Uint8Array(t,e,n);return I.decode(r)}const C={get:function(t,e={},n){e||(e={});const r=new AbortController,i=r.signal,s=g({},e);s.signal=i,s.method||(s.method="GET"),s.referrerPolicy=s.referrerPolicy||"origin","undefined"==typeof window||s.referrer||(s.referrer=window.location.href),n&&(t=n(t));const o=fetch(t,s).then((t=>{const n=this.t(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return o.xhr=r,o},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${uX}t.status}): ${uX}t.statusText}\`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",C.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?C.jsonp(t):((e=e||{}).responseType="json",C.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+y++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class U{constructor(t,e,n,r,i){this.i=t,this.decoders=e,this.o=n,this.images={},this.u={},this.h=r||{},this.m=i}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],i=this.p(e,r);return this.getImageByBuffer(i,n)}if(this.u[t.id])return this.u[t.id].then((()=>{const r=this.buffers[t.id],i=this.p(e,r);return this.getImageByBuffer(i,n)}));if(v(t.uri)){const r=this.buffers[t.id]=M(t.uri),i=this.p(e,r);return this.getImageByBuffer(i,n)}let r;const i=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||i?t.uri:this.rootPath+"/"+t.uri,this.u[t.id]=C.getArrayBuffer(r,this.h,this.m).then((r=>{const i=this.buffers[t.id]=r.data,s=this.p(e,i);return this.getImageByBuffer(s,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this.o}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this.v(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.u[t.id]?this.u[t.id].then((()=>this.images[t.id])):this.u[t.id]=this.v(t.id,e)}v(t,e){return new Promise(((n,r)=>{let i=e;this.m&&(i=this.m(e)),this.i(i,this.h,((i,s)=>{i?r(i):(URL.revokeObjectURL(e),this.images[t]=s,n(this.images[t]))}))}))}}const F=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],N=[];class P{constructor(t,e,n,r,i){this.rootPath=t,this.gltf=e,this.M=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.A(),this.h=r,this.m=i}T(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this._(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const i=n.bufferViews[r.bufferView];return this.k(i).then((n=>{const{buffer:i,byteOffset:s}=n;return this.accessors[r.id]=this._(t,e,i,s)}))}k(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(v(e.uri)){const t=this.buffers[e.id]=M(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=C.getArrayBuffer(t,this.h,!n&&this.m).then((r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_(t,e,n,r=0){const i=this.gltf,s=i.accessors[e],o=void 0!==s.bufferView?i.bufferViews[s.bufferView]:{},a=(o.byteOffset||0)+r,c=this.O(s.type),u=w(s.componentType),l=o.byteStride||0,h={array:void 0,name:t,accessorName:e,byteLength:s.count*c*u.BYTES_PER_ELEMENT,componentType:s.componentType,count:s.count,type:s.type,itemSize:c,max:s.max,min:s.min,extensions:s.extensions};if(s.min&&(h.min=s.min),s.max&&(h.max=s.max),n)if(this.M)h.byteStride=l,h.byteOffset=a+(s.byteOffset||0),!l||l===c*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(h.array=this.S(n,s.count,c,a+(s.byteOffset||0),u),h.array.buffer.byteLength===h.byteLength&&(h.byteOffset=0)):h.array=new Uint8Array(n,a,o.byteLength);else if(s.interleaved){h.byteStride=0,h.byteOffset=0;const t=new u(s.count*c);if(h.array=S(t,n,s.count,c,l,a+(s.byteOffset||0),s.componentType),h.extensions&&h.extensions.WEB3D_quantized_attributes&&c>2){const t=new Float32Array(h.array.length),{decodeMatrix:e}=h.extensions.WEB3D_quantized_attributes;for(let n=0;n<h.array.length;n+=c){N[0]=h.array[n],N[1]=h.array[n+1],N[2]=h.array[n+2],N[3]=1;const r=f(N,N,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}h.componentType=5126,h.array=t}}else h.byteStride=0,h.array=this.S(n,s.count,c,a+(s.byteOffset||0),u),h.byteOffset=h.array.byteOffset;else{h.array=new u(s.count);const t=h.min||h.max;t&&(h.array[0]=t[0],h.array[1]=t[1],h.array[2]=t[2])}return h}A(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}S(t,e,n,r,i){return r%i.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*i.BYTES_PER_ELEMENT),r=0),new i(t,r,n*e)}O(t){const e=F.indexOf(t);return F[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this.k(e).then((r=>{const{buffer:i,byteOffset:s}=r,o=E(i,s+(e.byteOffset||0),n);return t.content=o,t}))}if(t.uri){if(v(t.uri)){const e=M(t.uri),n=E(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return C.get(e,this.h,this.m).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}}class B extends U{constructor(t,e,n,r,i,s,o,a){super(r,i,s,o,a),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new P(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const e in n)t(e,n[e],r++)}createNode(t){const e={};if(b(t.name)&&(e.name=t.name),b(t.children)&&(e.children=t.children),b(t.jointName)&&(e.jointName=t.jointName),b(t.matrix)&&(e.matrix=t.matrix),b(t.rotation)&&(e.rotation=t.rotation),b(t.scale)&&(e.scale=t.scale),b(t.translation)&&(e.translation=t.translation),b(t.extras)&&(e.extras=t.extras),b(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const r=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(A,e.translation||k),i=function(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,a=r+r,c=i+i,u=n*o,f=r*o,l=r*a,h=i*o,d=i*a,y=i*c,m=s*o,b=s*a,p=s*c;return t[0]=1-l-y,t[1]=f+p,t[2]=h-b,t[3]=0,t[4]=f-p,t[5]=1-u-y,t[6]=d+m,t[7]=0,t[8]=h+b,t[9]=d-m,t[10]=1-u-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(T,e.rotation||O),s=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(_,e.scale||x);return n(s,i,s),n(t,r,s)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}I(t){const e={};for(const n in t){const r=t[n];let i,s;r.instanceTechnique&&r.instanceTechnique.values?(i=r.instanceTechnique,s=i.values.diffuse):(i=r,s=i.values.tex||i.values.diffuseTex||i.values.diffuse);const o={baseColorTexture:{index:s}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}C(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,i=n.byteLength,s=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,i);return this.getImageByBuffer(s,t)}return this.requestExternalImage(t)}U(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.C(n).then((t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const i=this.gltf.textures[r];if(!i)return null;const s=this.gltf.samplers[i.sampler];return{format:i.format||6408,internalFormat:i.internalFormat||6408,type:i.type||5121,sampler:s,source:this.gltf.images[i.source]}}getMaterial(){return null}getAnimations(){return null}}const D=9729;class R extends U{constructor(t,e,n,r,i,s,o,a){super(r,i,s,o,a),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new P(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return g(e,t),!b(t.weights)&&this.gltf.meshes&&b(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}U(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!b(n))return null;const r=this.gltf.images[n];return this.C(r).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};g(n,e);const i=b(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(i&&(n.sampler=i,n.sampler.magFilter=i.magFilter||D,n.sampler.minFilter=i.minFilter||9987,n.sampler.wrapS=i.wrapS||10497,n.sampler.wrapT=i.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==D&&9728!==n.sampler.minFilter){const t=n.sampler.minFilter;n.sampler.minFilter=9984===t||9986===t?9728:D}return t.format&&(n.format=t.format),n}))}C(t){if(!b(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.F(e,t)}return null}F(t,e){const n=this.p(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}p(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,i=t.byteLength;return new Uint8Array(e,r,i)}N(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);n.join("");const r="data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)));return r}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(b(t[n].input)||b(t[n].output))&&(e.push(this.accessor.T("input",t[n].input)),e.push(this.accessor.T("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}}const L="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class j{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),i=r.getUint32(4,!0);if(1===i)return j.readV1(r,e);if(2===i)return j.readV2(t,e);throw new Error("Unsupported glb version : "+i)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const i=z(t.buffer,20+e,r);return{json:JSON.parse(i),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,i;const s=new DataView(t,e+12);let o=0;for(;o+8<s.byteLength;){const a=s.getUint32(o,!0);o+=4;const c=s.getUint32(o,!0);if(o+=4,1313821514===c)n=z(t,e+12+o,a);else if(5130562===c){i=e+12+o,r=a;break}o+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:i,buffer:t,byteLength:r}}}}function z(t,e,n){if(L){const r=new Uint8Array(t,e,n);return L.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=q[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}(new Uint8Array(t,e,n))}const q=[1,1,1,1,2,2,3,0],V=[0,0,0],G=[0,0,0,1],$=[1,1,1],X={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},H={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},J={P(t,e,n,r,i,o,a,c){const u=b(t)?e.animations:[e.animations[0]],f={};for(let e=0;e<u.length;e++){const l=u[e],h=l.name||e;if(b(t)&&h!==t)continue;const y=l.channelsMap[n];if(y)for(let t=0;t<y.length;t++){const e=y[t];"translation"===e.target.path?(this.B(i,l.samplers[e.sampler],r,1),f.translation=s(V,i)):"rotation"===e.target.path?(this.D(o,l.samplers[e.sampler],r,1),f.rotation=d(G,o)):"scale"===e.target.path?(this.B(a,l.samplers[e.sampler],r,1),f.scale=s($,a)):"weights"===e.target.path&&c&&(this.B(c,l.samplers[e.sampler],r,c.length),f.weights=c)}}return f},B(t,e,n,r){switch(e.interpolation){case"LINEAR":{const i=this.R(H,e,n,1*r);i&&(t=function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t}(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION));break}case"STEP":{const i=this.R(H,e,n,1*r);i&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this.R(H,e,n,3*r);i&&(t=this.L(t,i,e.input.array,3*r));break}}return t},D(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this.R(H,e,n,1);r&&function(t,e,n,r){var i,s,o,a,c,u=e[0],f=e[1],l=e[2],h=e[3],d=n[0],y=n[1],m=n[2],b=n[3];(s=u*d+f*y+l*m+h*b)<0&&(s=-s,d=-d,y=-y,m=-m,b=-b),1-s>1e-6?(i=Math.acos(s),o=Math.sin(i),a=Math.sin((1-r)*i)/o,c=Math.sin(r*i)/o):(a=1-r,c=r),t[0]=a*u+c*d,t[1]=a*f+c*y,t[2]=a*l+c*m,t[3]=a*h+c*b}(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this.R(H,e,n,1);r&&(t=u(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this.R(H,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this.L(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},j(t,e){const n=t.length;let r,i,s,o=0,a=n-1,c=Math.floor((o+a)/2);for(;o<=n-1&&a>=0;){if(o===a)return null;if(t[c]<=e&&e<=t[c+1]){const n=t[c];return r=c,i=c+1,s=(e-n)/(t[c+1]-n),{preIndx:r,nextIndex:i,interpolation:s}}e<t[c]?(a=c,c=Math.floor((o+a)/2)):t[c+1]<e&&(o=c,c=Math.floor((o+a)/2))}return null},R(t,e,n,r){const i=e.input.array,s=e.output.array,o=e.output.itemSize;(n<i[0]||n>i[i.length-1])&&(n=Math.max(i[0],Math.min(i[i.length-1],n))),n===i[i.length-1]&&(n=i[0]);const a=this.j(i,n);if(!a||!a.nextIndex)return null;const{preIndx:c,nextIndex:u,interpolation:f}=a;t.PREINDEX=c,t.NEXTINDEX=u,t.INTERPOLATION=f;const l=o*r;return t.PREVIOUS=s.subarray(t.PREINDEX*l,(t.PREINDEX+1)*l),t.NEXT=s.subarray(t.NEXTINDEX*l,(t.NEXTINDEX+1)*l),t},L(t,e,n,r){const i=e.INTERPOLATION,s=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let n=0;n<3;n++){const a=e.PREVIOUS[r+n],c=(o-s)*e.PREVIOUS[2*r+n],u=e.NEXT[3+n],f=(o-s)*e.NEXT[n],l=(2*Math.pow(i,3)-3*Math.pow(i,2)+1)*a+(Math.pow(i,3)-2*Math.pow(i,2)+i)*c+(2*-Math.pow(i,3)+3*Math.pow(i,2))*u+(Math.pow(i,3)-Math.pow(i,2))*f;t[n]=l}return t},getAnimationClip(t,e,n,r){const i=t.nodes[e]&&t.nodes[e].weights;return o(V,...X.TRANSLATION),u(G,...X.ROTATION),o($,...X.SCALE),this.P(r,t,e,n,V,G,$,i)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let r=-1/0,i=1/0;const s=e.channels;for(let t=0;t<s.length;t++){const n=s[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<i&&(i=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:i}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?b(e)?n[e]:n[Object.keys(n)[0]]:null}};let K=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(Je){}t&&"undefined"!=typeof createImageBitmap&&(K=!0)}const Y="undefined"==typeof document?null:document.createElement("canvas");class Q{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.h=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=j.read(e.buffer,e.byteOffset,e.byteLength);this.q(t,n,r)}else this.q(t,e);this.V=new P(this.rootPath,this.gltf,this.glbBuffer,this.h,this.options.urlModifier),this.G()}G(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}$(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.V.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this.X(t),n=this.H(),r=this.J(),i=this.$();return Promise.all([e,n,r,i]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,r){return J.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return J.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return w(t)}static readInterleavedArray(t,e,n,r,i,s,o){return S(t,e,n,r,i,s,o)}q(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=K?it.bind(this):this.options.requestImage||W,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new R(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.h,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new B(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.h,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}K(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||p(t.children[0])))return t;const r=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this.K(n,e)}));t.children=r}var n;return t}X(t){return this.Y(t).then((t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.K(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((r,i,s)=>{const o={};i.name&&(o.name=i.name),i.nodes&&(o.nodes=i.nodes.map((e=>t[e]))),this.gltf.scene===r&&(n=s),e.push(o)}),"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.I(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r}))}Y(t){return this.W(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r}),"nodes"),t}))}Z(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,r)=>{t.push(this.tt(n).then((t=>{t.index=r,this.skins.push(t)})))}),"skins"),t}tt(t){const e=t.inverseBindMatrices;return this.adapter.accessor.T("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}H(){const t=this.gltf.animations;return b(t)?this.adapter.getAnimations(t):null}W(t){this.meshes={};let e=[];return this.adapter.iterate(((n,r,i)=>{e.push(this.et(r,t).then((t=>{t.index=i,this.meshes[n]=t})))}),"meshes"),e=e.concat(this.Z()),Promise.all(e)}et(t,e){const n=t.primitives.map((t=>this.nt(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return g(n,t),n.primitives=e,n}))}J(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.U(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image.array;if(n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e}))}nt(t,e){let n;const r=[],i=t.extensions;if(b(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const i=this.adapter.accessor.T(\`morphTargets_${uX}t}_${uX}e}\`,n[t]);i&&r.push(i)}}if(i&&i.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:s,attributes:o}=i.KHR_draco_mesh_compression,a=this.gltf.bufferViews[s],c=this.V.k(a).then((n=>{const{buffer:r,byteOffset:i}=n;let{byteOffset:s}=a;const c=a.byteLength;s||(s=0);const u=new DataView(r,i+s,c),f={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,f).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));r.push(c),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor.T(t,e[t]);n&&r.push(n)}if(b(t.indices)){const e=this.adapter.accessor.T("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then((e=>{if(i&&i.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const s={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:i}=e,s=i.length/r;for(let e=0;e<s;e++)for(let s=0;s<r;s++){const o=e*r+s;i[o]<t[s]&&(t[s]=i[o]),i[o]>n[s]&&(n[s]=i[o])}if(e.quantization){const r=e.quantization,i=r.range/(1<<r.quantizationBits),s=r.minValues;c(t,t,i),a(t,t,s),c(n,n,i),a(n,n,s)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(s.indices=n),r&&(s.morphTargets=r),s.mode=b(t.mode)?t.mode:4,b(t.extras)&&(s.extras=t.extras),s}))}}function W(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!Y)return void n(new Error("There is no canvas to draw image!"));Y.width=r.width,Y.height=r.height;const t=Y.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),i={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,i)},r.onerror=function(t){n(t)},r.src=t}const Z=[],tt=[],et=30;let nt,rt;function it(t,e,n){nt||(nt=new OffscreenCanvas(2,2),rt=nt.getContext("2d",{willReadFrequently:!0}));let r=null;if(p(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),Z.push([t,e,n,this]),st();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(ot.bind(this)).then((t=>{n(null,t)})).catch((t=>{console.warn(t),n(t)}))}}function st(){if(!Z.length||tt.length>et)return;const t=Z.shift(),[e,n,r,i]=t;tt.push(t),fetch(e,n).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then(ot.bind(i)).then((e=>{r.call(i,null,e);const n=tt.indexOf(t);tt.splice(n,1),st()})).catch((e=>{console.warn(e),r.call(i,e);const n=tt.indexOf(t);tt.splice(n,1),st()}))}function ot(t){let{width:e,height:n}=t;at(e)||(e=ct(e)),at(n)||(n=ct(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),nt.width=e,nt.height=n,rt.drawImage(t,0,0,e,n),t.close();const i=rt.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(i.data)}}function at(t){return!(t&t-1)&&0!==t}function ct(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}var ut="undefined"!=typeof Float32Array?Float32Array:Array;function ft(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function lt(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],c=e[5],u=e[6],f=e[7],l=e[8],h=e[9],d=e[10],y=e[11],m=e[12],b=e[13],p=e[14],g=e[15],w=n[0],v=n[1],M=n[2],A=n[3];return t[0]=w*r+v*a+M*l+A*m,t[1]=w*i+v*c+M*h+A*b,t[2]=w*s+v*u+M*d+A*p,t[3]=w*o+v*f+M*y+A*g,w=n[4],v=n[5],M=n[6],A=n[7],t[4]=w*r+v*a+M*l+A*m,t[5]=w*i+v*c+M*h+A*b,t[6]=w*s+v*u+M*d+A*p,t[7]=w*o+v*f+M*y+A*g,w=n[8],v=n[9],M=n[10],A=n[11],t[8]=w*r+v*a+M*l+A*m,t[9]=w*i+v*c+M*h+A*b,t[10]=w*s+v*u+M*d+A*p,t[11]=w*o+v*f+M*y+A*g,w=n[12],v=n[13],M=n[14],A=n[15],t[12]=w*r+v*a+M*l+A*m,t[13]=w*i+v*c+M*h+A*b,t[14]=w*s+v*u+M*d+A*p,t[15]=w*o+v*f+M*y+A*g,t}function ht(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function dt(){var t=new ut(3);return ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function yt(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function mt(t,e,n){var r=new ut(3);return r[0]=t,r[1]=e,r[2]=n,r}function bt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function pt(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function gt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function wt(t,e){var n=e[0],r=e[1],i=e[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function vt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Mt(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[3]*r+n[7]*i+n[11]*s+n[15];return o=o||1,t[0]=(n[0]*r+n[4]*i+n[8]*s+n[12])/o,t[1]=(n[1]*r+n[5]*i+n[9]*s+n[13])/o,t[2]=(n[2]*r+n[6]*i+n[10]*s+n[14])/o,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var At=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},Tt=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},_t=yt;function kt(){var t=new ut(4);return ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}dt(),function(){var t,e=(t=new ut(4),ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var Ot;function xt(t){return t&&t.rt&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}dt(),mt(1,0,0),mt(0,1,0),kt(),kt(),Ot=new ut(9),ut!=Float32Array&&(Ot[1]=0,Ot[2]=0,Ot[3]=0,Ot[5]=0,Ot[6]=0,Ot[7]=0),Ot[0]=1,Ot[4]=1,Ot[8]=1;var St={exports:{}},It={exports:{}},Et=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},Ct=Array.prototype.concat,Ut=Array.prototype.slice,Ft=It.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];Et(i)?e=Ct.call(e,Ut.call(i)):e.push(i)}return e};Ft.wrap=function(t){return function(){return t(Ft(arguments))}};var Nt=It.exports,Pt={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},Bt=Nt,Dt=Object.hasOwnProperty,Rt=Object.create(null);for(var Lt in Pt)Dt.call(Pt,Lt)&&(Rt[Pt[Lt]]=Lt);var jt=St.exports={to:{},get:{}};function zt(t,e,n){return Math.min(Math.max(e,t),n)}function qt(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}jt.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=jt.get.hsl(t),n="hsl";break;case"hwb":e=jt.get.hwb(t),n="hwb";break;default:e=jt.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},jt.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var s=2*n;i[n]=parseInt(e.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(e=t.match(/^(\\w+)$/))?"transparent"===e[1]?[0,0,0,0]:Dt.call(Pt,e[1])?((i=Pt[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=zt(i[n],0,255);return i[3]=zt(i[3],0,1),i},jt.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,zt(parseFloat(e[2]),0,100),zt(parseFloat(e[3]),0,100),zt(isNaN(n)?1:n,0,1)]}return null},jt.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,zt(parseFloat(e[2]),0,100),zt(parseFloat(e[3]),0,100),zt(isNaN(n)?1:n,0,1)]}return null},jt.to.hex=function(){var t=Bt(arguments);return"#"+qt(t[0])+qt(t[1])+qt(t[2])+(t[3]<1?qt(Math.round(255*t[3])):"")},jt.to.rgb=function(){var t=Bt(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},jt.to.rgb.percent=function(){var t=Bt(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},jt.to.hsl=function(){var t=Bt(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},jt.to.hwb=function(){var t=Bt(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},jt.to.keyword=function(t){return Rt[t.slice(0,3)]};var Vt=St.exports,Gt={exports:{}},$t={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},Xt={};for(var Ht in $t)$t.hasOwnProperty(Ht)&&(Xt[$t[Ht]]=Ht);var Jt=Gt.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Kt in Jt)if(Jt.hasOwnProperty(Kt)){if(!("channels"in Jt[Kt]))throw new Error("missing channels property: "+Kt);if(!("labels"in Jt[Kt]))throw new Error("missing channel labels property: "+Kt);if(Jt[Kt].labels.length!==Jt[Kt].channels)throw new Error("channel and label counts mismatch: "+Kt);var Yt=Jt[Kt].channels,Qt=Jt[Kt].labels;delete Jt[Kt].channels,delete Jt[Kt].labels,Object.defineProperty(Jt[Kt],"channels",{value:Yt}),Object.defineProperty(Jt[Kt],"labels",{value:Qt})}function Wt(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}Jt.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),c=a-o;return a===o?e=0:r===a?e=(i-s)/c:i===a?e=2+(s-r)/c:s===a&&(e=4+(r-i)/c),(e=Math.min(60*e,360))<0&&(e+=360),n=(o+a)/2,[e,100*(a===o?0:n<=.5?c/(a+o):c/(2-a-o)),100*n]},Jt.rgb.hsv=function(t){var e,n,r,i,s,o=t[0]/255,a=t[1]/255,c=t[2]/255,u=Math.max(o,a,c),f=u-Math.min(o,a,c),l=function(t){return(u-t)/6/f+.5};return 0===f?i=s=0:(s=f/u,e=l(o),n=l(a),r=l(c),o===u?i=r-n:a===u?i=1/3+e-r:c===u&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*u]},Jt.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[Jt.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},Jt.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},Jt.rgb.keyword=function(t){var e=Xt[t];if(e)return e;var n,r=1/0;for(var i in $t)if($t.hasOwnProperty(i)){var s=Wt(t,$t[i]);s<r&&(r=s,n=i)}return n},Jt.keyword.rgb=function(t){return $t[t]},Jt.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},Jt.rgb.lab=function(t){var e=Jt.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},Jt.hsl.rgb=function(t){var e,n,r,i,s,o=t[0]/360,a=t[1]/100,c=t[2]/100;if(0===a)return[s=255*c,s,s];e=2*c-(n=c<.5?c*(1+a):c+a-c*a),i=[0,0,0];for(var u=0;u<3;u++)(r=o+1/3*-(u-1))<0&&r++,r>1&&r--,s=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[u]=255*s;return i},Jt.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,s=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[e,100*(0===r?2*i/(s+i):2*n/(r+n)),100*((r+n)/2)]},Jt.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,s=e-Math.floor(e),o=255*r*(1-n),a=255*r*(1-n*s),c=255*r*(1-n*(1-s));switch(r*=255,i){case 0:return[r,c,o];case 1:return[a,r,o];case 2:return[o,r,c];case 3:return[o,a,r];case 4:return[c,o,r];case 5:return[r,o,a]}},Jt.hsv.hsl=function(t){var e,n,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,n=s*a,[i,100*(n=(n/=(e=(2-s)*a)<=1?e:2-e)||0),100*(r/=2)]},Jt.hwb.rgb=function(t){var e,n,r,i,s,o,a,c=t[0]/360,u=t[1]/100,f=t[2]/100,l=u+f;switch(l>1&&(u/=l,f/=l),r=6*c-(e=Math.floor(6*c)),1&e&&(r=1-r),i=u+r*((n=1-f)-u),e){default:case 6:case 0:s=n,o=i,a=u;break;case 1:s=i,o=n,a=u;break;case 2:s=u,o=n,a=i;break;case 3:s=u,o=i,a=n;break;case 4:s=i,o=u,a=n;break;case 5:s=n,o=u,a=i}return[255*s,255*o,255*a]},Jt.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},Jt.xyz.rgb=function(t){var e,n,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return n=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,e=(e=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},Jt.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},Jt.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var s=Math.pow(n,3),o=Math.pow(e,3),a=Math.pow(r,3);return n=s>.008856?s:(n-16/116)/7.787,e=o>.008856?o:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},Jt.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},Jt.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},Jt.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:Jt.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(s+=60),s},Jt.hsv.ansi16=function(t){return Jt.rgb.ansi16(Jt.hsv.rgb(t),t[2])},Jt.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},Jt.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},Jt.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},Jt.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},Jt.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},Jt.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),a=s-o;return e=a<=0?0:s===n?(r-i)/a%6:s===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?o/(1-a):0)]},Jt.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},Jt.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},Jt.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,s=[0,0,0],o=e%1*6,a=o%1,c=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=c,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=c,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=c}return i=(1-n)*r,[255*(n*s[0]+i),255*(n*s[1]+i),255*(n*s[2]+i)]},Jt.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},Jt.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},Jt.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},Jt.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},Jt.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},Jt.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},Jt.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},Jt.gray.hsl=Jt.gray.hsv=function(t){return[0,0,t[0]]},Jt.gray.hwb=function(t){return[0,100,t[0]]},Jt.gray.cmyk=function(t){return[0,0,0,t[0]]},Jt.gray.lab=function(t){return[t[0],0,0]},Jt.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},Jt.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var Zt=Gt.exports,te=Zt;function ee(t){var e=function(){for(var t={},e=Object.keys(te),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(te[r]),s=i.length,o=0;o<s;o++){var a=i[o],c=e[a];-1===c.distance&&(c.distance=e[r].distance+1,c.parent=r,n.unshift(a))}return e}function ne(t,e){return function(n){return e(t(n))}}function re(t,e){for(var n=[e[t].parent,t],r=te[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=ne(te[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var ie=Zt,se=function(t){for(var e=ee(t),n={},r=Object.keys(e),i=r.length,s=0;s<i;s++){var o=r[s];null!==e[o].parent&&(n[o]=re(o,e))}return n},oe={};Object.keys(ie).forEach((function(t){oe[t]={},Object.defineProperty(oe[t],"channels",{value:ie[t].channels}),Object.defineProperty(oe[t],"labels",{value:ie[t].labels});var e=se(t);Object.keys(e).forEach((function(n){var r=e[n];oe[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),oe[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var ae=Vt,ce=oe,ue=[].slice,fe=["keyword","gray","hex"],le={};Object.keys(ce).forEach((function(t){le[ue.call(ce[t].labels).sort().join("")]=t}));var he={};function de(t,e){if(!(this instanceof de))return new de(t,e);if(e&&e in fe&&(e=null),e&&!(e in ce))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof de)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=ae.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=ce[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=ce[this.model].channels;var s=ue.call(t,0,r);this.color=be(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in le))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=le[a];var c=ce[this.model].labels,u=[];for(n=0;n<c.length;n++)u.push(t[c[n]]);this.color=be(u)}if(he[this.model])for(r=ce[this.model].channels,n=0;n<r;n++){var f=he[this.model][n];f&&(this.color[n]=f(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ye(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(he[t]||(he[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function me(t){return function(e){return Math.max(0,Math.min(t,e))}}function be(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}function pe(t){return null==t}function ge(t){return"object"==typeof t&&!!t}function we(t){return t/Math.PI*180}de.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in ae.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return ae.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return ae.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=ce[this.model].channels,n=ce[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new de(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new de(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:ye("rgb",0,me(255)),green:ye("rgb",1,me(255)),blue:ye("rgb",2,me(255)),hue:ye(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:ye("hsl",1,me(100)),lightness:ye("hsl",2,me(100)),saturationv:ye("hsv",1,me(100)),value:ye("hsv",2,me(100)),chroma:ye("hcg",1,me(100)),gray:ye("hcg",2,me(100)),white:ye("hwb",1,me(100)),wblack:ye("hwb",2,me(100)),cyan:ye("cmyk",0,me(100)),magenta:ye("cmyk",1,me(100)),yellow:ye("cmyk",2,me(100)),black:ye("cmyk",3,me(100)),x:ye("xyz",0,me(100)),y:ye("xyz",1,me(100)),z:ye("xyz",2,me(100)),l:ye("lab",0,me(100)),a:ye("lab",1),b:ye("lab",2),keyword:function(t){return arguments.length?new de(t):ce[this.model].keyword(this.color)},hex:function(t){return arguments.length?new de(t):ae.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return de.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,s=2*i-1,o=n.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,c=1-a;return de.rgb(a*n.red()+c*r.red(),a*n.green()+c*r.green(),a*n.blue()+c*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(ce).forEach((function(t){if(-1===fe.indexOf(t)){var e=ce[t].channels;de.prototype[t]=function(){if(this.model===t)return new de(this);if(arguments.length)return new de(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new de((n=ce[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},de[t]=function(n){return"number"==typeof n&&(n=be(ue.call(arguments),e)),new de(n,t)}}}));const ve=[1,1,1,1,2,2,3,0];function Me(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=ve[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}new Array(3),new Array(3);const Ae=[1/6378137,1/6378137,1/6356752.314245179],Te=[1/40680631590769,1/40680631590769,1/40408299984661.445],_e=new Array(3),ke=new Array(3),Oe=new Array(3);function xe(t,e){const n=Te,r=function(t,e,n,r,i){const s=e[0],o=e[1],a=e[2],c=n[0],u=n[1],f=n[2],l=s*s*c*c,h=o*o*u*u,d=a*a*f*f,y=l+h+d,m=Math.sqrt(1/y),b=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(Se,e,m);if(y<i)return isFinite(m)?b:void 0;const p=r[0],g=r[1],w=r[2],v=Ie;v[0]=b[0]*p*2,v[1]=b[1]*g*2,v[2]=b[2]*w*2;let M,A,T,_,k,O,x,S,I,E,C,U=(1-m)*Ce(e)/(.5*Ce(v)),F=0;do{U-=F,T=1/(1+U*p),_=1/(1+U*g),k=1/(1+U*w),O=T*T,x=_*_,S=k*k,I=O*T,E=x*_,C=S*k,M=l*O+h*x+d*S-1,A=l*I*p+h*E*g+d*C*w;F=M/(-2*A)}while(Math.abs(M)>Ee);return t[0]=s*T,t[1]=o*_,t[2]=a*k,t}(_e,e,Ae,n,.1);let i=Tt(ke,r,n);i=function(t,e){const n=e[0],r=e[1],i=e[2];let s=n*n+r*r+i*i;s>0&&(s=Math.sqrt(s),t[0]=e[0]/s,t[1]=e[1]/s,t[2]=e[2]/s);return t}(i,i);const s=At(Oe,e,r),o=Math.atan2(i[1],i[0]),a=Math.asin(i[2]),c=function(t){return Math.sign?Math.sign(t):0==(t=+t)||isNaN(t)?Number(t):t>0?1:-1}(vt(s,e))*Ce(s);return t[0]=we(o),t[1]=we(a),t[2]=c,t}const Se=new Array(3),Ie=new Array(3),Ee=1e-12;function Ce(t){return yt(t)}function Ue(t,e){let n="";for(let r=0;r<4;r++){const i=t.getUint8(e+r);n+=String.fromCharCode(i)}return n}const Fe="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Ne(t,e,n){const r=new Uint8Array(t,e,n);return Fe?JSON.parse(Fe.decode(r)):JSON.parse(Me(r))}function Pe(t,e,n){const r=new Uint8Array(t,e,n);return Fe?JSON.parse(Fe.decode(r)):JSON.parse(Me(r))}function Be(t,e,n){return{offset:e,byteLength:n}}function De(t,e,n,r){const{byteOffset:i,componentType:s,type:o}=t,{ctor:a,type:c}=function(t){return je[t]}(s||"UNSIGNED_SHORT"),u=function(t){if(!t)return 1;return Le[t]}(o);return{byteStride:0,byteOffset:i+n,itemSize:u,count:r*u,componentType:c,array:new a(e,n+i,r*u)}}function Re(t,e,n,r){const i=De(t,e,n,r);return i.array.buffer.byteLength!==e.byteLength&&(i.array=i.array.slice()),i}const Le={"SCALAR":1,"VEC2":2,"VEC3":3,"VEC4":4};const je={"BYTE":{ctor:Int8Array,type:5120,name:"Int8Array"},"UNSIGNED_BYTE":{ctor:Uint8Array,type:5121,name:"Uint8Array"},"SHORT":{ctor:Int16Array,type:5122,name:"Int16Array"},"UNSIGNED_SHORT":{ctor:Uint16Array,type:5123,name:"Uint16Array"},"INT":{ctor:Int32Array,type:5124,name:"Int32Array"},"UNSIGNED_INT":{ctor:Uint32Array,type:5125,name:"Uint32Array"},"FLOAT":{ctor:Float32Array,type:5126,name:"Float32Array"},"DOUBLE":{ctor:Float64Array,type:5126,name:"Float64Array"}};function ze(t){for(const e in je)if(t===je[e].ctor)return je[e].type;throw new Error("unrecognized ctor:"+t)}function qe(t,e,n,r){const i=t,s=e.length/3;for(let t=0;t<s;t++)i[3*t]=e[3*t]/65535*r[0]+n[0],i[3*t+1]=e[3*t+1]/65535*r[1]+n[1],i[3*t+2]=e[3*t+2]/65535*r[2]+n[2];return i}function Ve(t,e,n){const r=t.getUint32(12,!0),i=t.getUint32(16,!0),s=t.getUint32(20,!0),o=t.getUint32(24,!0),a=t.buffer;let c,u={},f={},l=null;r>0&&(u=Ne(a,e,r),e+=r),i>0&&(c=function(t,e,n){return{offset:e,byteLength:n}}(0,e,i),e+=i),s>0&&(f=Pe(a,e,s),e+=s);const h=Be(0,e,o);return l=a.slice(h.offset,h.offset+h.byteLength),n.push(l),{featureTable:u,featureTableBin:c,batchTable:f,batchTableBin:l}}const Ge={5120:Int8Array,5122:Int16Array,5124:Int32Array,5121:Uint8Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function $e(t){for(const e in Ge)if(t===Ge[e])return+e;throw new Error("unrecognized ctor:"+t)}\n/*!\n   * @maptalks/gl v0.102.1\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.com\n   */const Xe=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},He=Xe(),Je=He.gl_trans__coders=He.gl_trans__coders||{};Je.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=He.gl_trans__coders=He.gl_trans__coders||{};let s=\`${uX}r}\\n    const _____getGlobal = ${uX}Xe.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};\`;for(const t in i)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+i[t].toString()+"\\n;");return s+="\\n"+e.substring(r.length),s},Je.registerTranscoder=function(t,e){Je[t]=e},Je.getTranscoder=function(t){return Je[t]};let Ke=null;function Ye(){return Ke||(Ke={"image/crn":Je.crn&&Je.crn(),"image/ktx2":Je.ktx2&&Je.ktx2(),"image/cttf":Je.ktx2&&Je.ktx2(),"draco":Je.draco&&Je.draco()}),Ke}class Qe{constructor(t,e,n){this.i=t,this.it=e||Q,this.o=n,this.st=Ye()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(t,e,n=0,r=0,i){return e?(r||(r=e.byteLength),this.ot(t,e,n,r,i)):C.getArrayBuffer(t,{}).then((e=>{const i=e.data;return r||(r=i.byteLength),this.ot(t,i,n,r)}))}ot(t,e,n,r,i){const s=i&&i.maxTextureSize,o=this.ct(e,n,r,t);if(o.error)return Promise.resolve(o);const a=t.substring(0,t.lastIndexOf("/"));let c;try{c=new this.it(a,o.glb,{transferable:!0,requestImage:this.i,decoders:this.st,supportedFormats:this.o,maxTextureSize:s})}catch(t){return Promise.resolve({error:t})}return c.load({skipAttributeTransform:!1}).then((e=>{e.url=\`${uX}t}-${uX}n}-${uX}r}\`;const i=c.transferables;for(let t=0;t<o.transferables.length;t++)i.indexOf(o.transferables[t])<0&&i.push(o.transferables[t]);return{magic:"b3dm",count:o.count,transferables:i,featureTable:o.featureTable,batchTable:o.batchTable,batchTableBin:o.batchTableBin,gltf:e}}))}ct(t,e,n,r){const i=new DataView(t,e,n),s=i.getUint32(4,!0);if(1!==s){const t="Unsupported b3dm version: "+s+", url:"+r;return console.warn(t),{error:t}}if(i.getUint32(8,!0)!==i.byteLength){const t="Length in b3dm header is inconsistent with b3dm's byte length, url: "+r;return console.warn(t),{error:t}}let o,a=i.getUint32(12,!0),c=i.getUint32(16,!0),u=i.getUint32(20,!0),f=i.getUint32(24,!0),l=28+e;u>=570425344?(l-=8,o=a,u=c,f=0,a=0,c=0):f>=570425344&&(l-=4,o=u,u=a,f=c,a=0,c=0);const h=[t];let d,y,m;if(a>0?(d=Ne(t,l,a),l+=a,o=d.BATCH_LENGTH):d={"BATCH_LENGTH":o},c>0&&(l+=c),u>0&&(y=Pe(t,l,u),l+=u,f>0)){const e=Be(0,l,f);m=t.slice(e.offset,e.offset+e.byteLength),l+=f,h.push(m)}const b=d.BATCH_LENGTH,p={};if(d&&d.BATCH_ID){p.BATCH_ID=Re(d.BATCH_ID,t,undefined.offset,b);const e=p.BATCH_ID.array&&p.BATCH_ID.array.buffer;e&&h.indexOf(e)<0&&h.push(e)}return{count:o,transferables:h,featureTable:d,batchTable:y,batchTableBin:m,b3dm:p,glb:{buffer:t,byteOffset:l,byteLength:i.byteLength+i.byteOffset-l}}}ut(){return null}}class We{constructor(t,e,n,r){this.i=t,this.it=e||Q,this.o=n,this.st=Ye(),this.ft=r}load(t,e,n=0,r=0,i){return e?(r||(r=e.byteLength),this.ot(t,e,n,r,i)):C.getArrayBuffer(t,{}).then((e=>{const i=e.data;return r||(r=i.byteLength),this.ot(t,i,n,r)}))}ot(t,e,n,r,i){return this.lt(t,e,n,r,i).then((({gltf:i,transferables:s})=>{const o=this.ht(e,n,r,t);if(o.error)return Promise.resolve(o);for(let t=0;t<s.length;t++)-1===o.transferables.indexOf(s[t])&&o.transferables.push(s[t]);return delete i.transferables,Promise.resolve({magic:"i3dm",count:o.count,transferables:o.transferables,featureTable:o.featureTable,batchTable:o.batchTable,batchTableBin:o.batchTableBin,i3dm:o.i3dm,gltf:i})}))}lt(t,e,n,r,i){const s=i&&i.maxTextureSize,o={transferable:!0,requestImage:this.i,decoders:this.st,supportedFormats:this.o,maxTextureSize:s},a=new DataView(e,n,r),c=32+a.getUint32(12,!0)+a.getUint32(16,!0)+a.getUint32(20,!0)+a.getUint32(24,!0);if(0===a.getUint32(28,!0)){let r=Me(new Uint8Array(e,c+n,a.byteLength-c));-1==r.indexOf("://")&&(r=t.substring(0,t.lastIndexOf("/"))+"/"+r);return r.indexOf(".glb")>0?C.getArrayBuffer(r,{}).then((t=>this.dt(r,{buffer:t.data,byteOffset:0},o))):C.getJSON(r,{}).then((t=>this.dt(r,t,o)))}{const r={buffer:e,byteOffset:c+n,byteLength:a.byteLength-c};return this.dt(t,r,o)}}dt(t,e,n){const r=t.substring(0,t.lastIndexOf("/")),i=new this.it(r,e,n);return i.load({skipAttributeTransform:!0}).then((n=>{let r=0,s=0;return e.buffer&&(r=e.byteOffset||0,s=e.byteLength||0),n.url=\`${uX}t}-${uX}r}-${uX}s}\`,{transferables:i.transferables,gltf:n}}))}ht(t,e,n,r){const i=new DataView(t,e,n),s=i.getUint32(4,!0);if(1!==s){const t="Unsupported pnts version: "+s+", url:"+r;return console.warn(t),{error:t}}if(i.getUint32(8,!0)!==i.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const o=[t],{featureTable:a,featureTableBin:c,batchTable:u,batchTableBin:f}=Ve(i,32+e,o),l={},h=a.INSTANCES_LENGTH;if(a.POSITION){const{byteOffset:e}=a.POSITION;l.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},o.push(l.POSITION.array.buffer)}else if(a.POSITION_QUANTIZED){const e=a.QUANTIZED_VOLUME_OFFSET,n=a.QUANTIZED_VOLUME_SCALE,{byteOffset:r}=a.POSITION_QUANTIZED;l.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.yt(new Uint16Array(t,r+c.offset,3*h),e,n)},o.push(l.POSITION.array.buffer)}if(a.BATCH_ID){l.BATCH_ID=Re(a.BATCH_ID,t,c.offset,h);const e=l.BATCH_ID.array&&l.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}if(a.NORMAL_UP){let{byteOffset:e}=a.NORMAL_UP;l.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},o.push(l.NORMAL_UP.array.buffer),e=a.NORMAL_RIGHT.byteOffset,l.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},o.push(l.NORMAL_RIGHT.array.buffer)}else if(a.NORMAL_UP_OCT32P){let{byteOffset:e}=a.NORMAL_UP_OCT32P;l.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.bt(new Uint16Array(t,e+c.offset,2*h))},o.push(l.NORMAL_UP.array.buffer),e=a.NORMAL_RIGHT_OCT32P.byteOffset,l.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.bt(new Uint16Array(t,e+c.offset,2*h))},o.push(l.NORMAL_RIGHT.array.buffer)}if(a.SCALE){const{byteOffset:e}=a.SCALE;l.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,h).slice()},o.push(l.SCALE.array.buffer)}else if(a.SCALE_NON_UNIFORM){const{byteOffset:e}=a.SCALE_NON_UNIFORM;l.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},o.push(l.SCALE_NON_UNIFORM.array.buffer)}return{count:h,batchTable:u,batchTableBin:f,featureTable:a,i3dm:l,transferables:o}}bt(t){const e=t.length/2,n=new Float32Array(3*e),r=[];for(let i=0;i<e;i++)Ze(r,t[2*i],t[2*i+1],65535),n[3*i]=r[0],n[3*i+1]=r[1],n[3*i+2]=r[2];return n}yt(t,e,n){return qe(new Float32Array(t.length),t,e,n)}ut(){return null}}function Ze(t,e,n,r){if(t[0]=tn(e,r),t[1]=tn(n,r),t[2]=1-(Math.abs(t[0])+Math.abs(t[1])),t[2]<0){const e=t[0];t[0]=(1-Math.abs(t[1]))*en(e),t[1]=(1-Math.abs(e))*en(t[1])}return wt(t,t)}function tn(t,e){return e=function(t,e){if(null!=t)return t;return e}(e,255),function(t,e,n){return t<e?e:t>n?n:t}(t,0,e)/e*2-1}function en(t){return t<0?-1:1}class nn{constructor(){}load(t,e,n=0,r=0){return e?(r||(r=e.byteLength),this.ot(t,e,n,r)):C.getArrayBuffer(t,{}).then((e=>{const i=e.data;return r||(r=i.byteLength),this.ot(t,i,n,r)}))}ot(t,e,n,r){return this.gt(e,n,r,t).then((t=>t.error?t:{magic:"pnts",count:t.count,transferables:t.transferables,featureTable:t.featureTable,batchTable:t.batchTable,batchTableBin:t.batchTableBin,pnts:t.pnts}))}gt(t,e,n,r){const i=new DataView(t,e,n),s=i.getUint32(4,!0);if(1!==s){const t="Unsupported pnts version: "+s+", url:"+r;return console.warn(t),{error:t}}if(i.getUint32(8,!0)!==i.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const o=[t],{featureTable:a,featureTableBin:c,batchTable:u,batchTableBin:f}=Ve(i,e+28,o),l=a.QUANTIZED_VOLUME_OFFSET,h=a.QUANTIZED_VOLUME_SCALE,d=a.POINTS_LENGTH;let y,m={};if(a.extensions&&a.extensions["3DTILES_draco_point_compression"]){m=a.extensions["3DTILES_draco_point_compression"],y=new DataView(t,m.byteOffset+c.offset,m.byteLength);const e={attributes:m.properties,useUniqueIDs:!1};return this.wt||(this.wt=Ye().draco),this.wt(y,e).then((e=>{const n=e.attributes;!a.POSITION&&!a.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=a.POSITION,n.POSITION_QUANTIZED=a.POSITION_QUANTIZED),!(a.RGB||a.RGBA||a.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=a.RGB,n.RGBA=a.RGBA,n.RGB565=a.RGB565),!a.NORMAL&&!a.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=a.NORMAL,n.NORMAL_OCT16P=a.NORMAL_OCT16P);const r=this.vt(t,e.attributes,c.offset,d,o,l,h);if(e.attributes.BATCH_ID){const t=e.attributes.BATCH_ID.array;r.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:t.length,componentType:ze(t.constructor),array:t},o.push(t.buffer)}else if(a.BATCH_ID||Object.keys(u).length){a.BATCH_ID?r.BATCH_ID=Re(a.BATCH_ID,t,c.offset,d):r.BATCH_ID=rn(d);const e=r.BATCH_ID.array&&r.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}return{count:d,batchTable:u,batchTableBin:f,featureTable:a,pnts:r,transferables:o}}))}const b=this.vt(t,a,c.offset,d,o,l,h);if(a.BATCH_ID||Object.keys(u).length){a.BATCH_ID?b.BATCH_ID=Re(a.BATCH_ID,t,c.offset,d):b.BATCH_ID=rn(d);const e=b.BATCH_ID.array&&b.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}return Promise.resolve({count:d,batchTable:u,batchTableBin:f,featureTable:a,pnts:b,transferables:o})}vt(t,e,n,r,i,s,o){const a={};if(e.POSITION){let{byteOffset:s,array:o}=e.POSITION;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+3*r*4);o=new Float32Array(e)}a.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:o},i.push(o.buffer)}else if(e.POSITION_QUANTIZED){let{byteOffset:c}=e.POSITION_QUANTIZED;const{array:u}=e.POSITION_QUANTIZED;c=c||0;const f=u?0:n;a.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:this.yt(u||new Uint16Array(t,c+f,3*r),s,o)},i.push(a.POSITION.array.buffer)}if(e.RGBA){let{byteOffset:s,array:o}=e.RGBA;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+4*r);o=new Uint8Array(e)}a.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:r,componentType:5121,array:o},i.push(o.buffer)}else if(e.RGB){let{byteOffset:s,array:o}=e.RGB;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+3*r);o=new Uint8Array(e)}a.RGB={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5121,array:o},i.push(o.buffer)}else if(e.RGB565){let{byteOffset:s,array:o}=e.RGB565;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+2*r);o=new Uint16Array(e)}a.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:r,componentType:5123,array:o},i.push(o.buffer)}if(e.NORMAL){let{byteOffset:s,array:o}=e.NORMAL;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+3*r*4);o=new Float32Array(e)}a.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:o},i.push(o.buffer)}else if(e.NORMAL_OCT16P){let{byteOffset:s,array:o}=e.NORMAL_OCT16P;s=s||0;const c=o?0:n;if(!o){const e=t.slice(s+c,s+c+2*r);o=new Uint8Array(e)}a.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:r,componentType:5121,array:o},i.push(o.buffer)}return a}yt(t,e,n){return qe(new Float32Array(t.length),t,e,n)}ut(){return null}}function rn(t){const e=(n=t)<256?Uint8Array:n<65536?Uint16Array:Uint32Array;var n;const r=new e(t);for(let e=0;e<t;e++)r[e]=e;return{byteStride:0,byteOffset:0,itemSize:1,count:t,componentType:ze(e),array:r}}class sn{constructor(t,e,n,r){this.o=n,this.i=t,this.it=e||Q,this.ft=r}load(t,e,n=0,r=0,i){return e?this.ot(t,e,n,r,i):C.getArrayBuffer(t,{}).then((e=>{const i=e.data;return this.ot(t,i,n,r)}))}ot(t,e,n,r,i){r||(r=e.byteLength);const s=this.Mt(e,t,n,r),o=[];for(let n=0;n<s.length;n++){let r;if("b3dm"===s[n].magic)r=new Qe(this.i,this.it,this.o);else if("i3dm"===s[n].magic)r=new We(this.i,this.it,this.o,this.ft);else if("pnts"===s[n].magic)r=new nn;else{if("cmpt"!==s[n].magic){console.warn("Unsupported magic in CMPT tile:",s[n].magic);continue}r=new sn(this.i,this.it,this.o,this.ft)}o.push(r.load(t,e,s[n].offset,s[n].byteLength,i).then((t=>t)))}return Promise.all(o).then((t=>({magic:"cmpt",tiles:t})))}Mt(t,e,n,r){const i=new DataView(t,n,r),s=i.getUint32(4,!0);if(1!==s){const t="Unsupported cmpt version: "+s+", url:"+e;return console.warn(t),{error:t}}if(16===i.byteLength)return[];const o=[],a=i.getUint32(12,!0);let c=16;for(let e=0;e<a;e++){const e=Ue(i,c),r=i.getUint32(c+8,!0);o.push({magic:e,buffer:t,offset:c+n,byteLength:r}),c+=r}return o}}function on(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,i=r.length;n<i;n++){const i=[];dn(r[n],i,t,e)}}}const an=[],cn=[],un=[],fn=[0,0,0],ln=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),hn=[1,1,1];function dn(t,e,n,r){const i=e.slice(0);if(t.matrix)i.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(an,t.translation||fn),n=function(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,a=r+r,c=i+i,u=n*o,f=r*o,l=r*a,h=i*o,d=i*a,y=i*c,m=s*o,b=s*a,p=s*c;return t[0]=1-l-y,t[1]=f+p,t[2]=h-b,t[3]=0,t[4]=f-p,t[5]=1-u-y,t[6]=d+m,t[7]=0,t[8]=h+b,t[9]=d-m,t[10]=1-u-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(cn,t.rotation||ln),r=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(un,t.scale||hn);lt(r,n,r);const s=lt([],e,r);i.push(s)}if(t.children&&t.children.length)for(let e=0,s=t.children.length;e<s;e++)dn(t.children[e],i,n,r);if(void 0!==t.mesh){const e=t.mesh,s=n.meshes[e];if(s){const t=i.slice(0),o=s.primitives;for(let i=0,s=o.length;i<s;i++){const s=o[i];s&&(s.matrices=t,r(s,e,i,n))}}}}function yn(t,e){let{byteOffset:n,byteStride:r,count:i}=t;const{componentType:s,itemSize:o}=t,a=t.array.buffer,c=s?Q.getTypedArrayCtor(s):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,i=i||t.array.length/o,(!r||r===o*c.BYTES_PER_ELEMENT)&&n%c.BYTES_PER_ELEMENT==0){const t=new c(a,n,i*o);for(let r=0;r<i*o;r+=o){e(new c(t.buffer,n+r*c.BYTES_PER_ELEMENT,o),r/o)}return}const u=new Uint8Array(o*c.BYTES_PER_ELEMENT);r||(r=o*c.BYTES_PER_ELEMENT);for(let t=0;t<i;t++){const i=new Uint8Array(a,r*t+n,o*c.BYTES_PER_ELEMENT);u.set(i);e(new c(u.buffer),t),i.set(u)}}var mn=vn("DXT1"),bn=vn("DXT3"),pn=vn("DXT5"),gn=vn("DX10"),wn=function(t){var e,n,r=new Int32Array(t,0,31);if(542327876!==r[0])throw new Error("Invalid magic number in DDS header");if(4&!r[20])throw new Error("Unsupported format, must contain a FourCC code");var i=r[21];switch(i){case mn:e=8,n="dxt1";break;case bn:e=16,n="dxt3";break;case pn:e=16,n="dxt5";break;case 116:n="rgba32f";break;case gn:var s=new Uint32Array(t.slice(128,148));n=s[0];var o=s[1];if(s[2],s[3],s[4],3!==o||2!==n)throw new Error("Unsupported DX10 texture format "+n);n="rgba32f";break;default:throw new Error("Unsupported FourCC code: "+(a=i,String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)))}var a;var c=r[2],u=1;131072&c&&(u=Math.max(1,r[7]));var f=!1;512&r[28]&&(f=!0);var l,h=r[4],d=r[3],y=r[1]+4,m=h,b=d,p=[];i===gn&&(y+=20);if(f)for(var g=0;g<6;g++){if("rgba32f"!==n)throw new Error("Only RGBA32f cubemaps are supported");h=m,d=b;for(var w=Math.log(h)/Math.log(2)+1,v=0;v<w;v++)l=h*d*16,p.push({offset:y,length:l,shape:[h,d]}),v<u&&(y+=l),h=Math.floor(h/2),d=Math.floor(d/2)}else for(v=0;v<u;v++)l=Math.max(4,h)/4*Math.max(4,d)/4*e,p.push({offset:y,length:l,shape:[h,d]}),y+=l,h=Math.floor(h/2),d=Math.floor(d/2);return{shape:[m,b],images:p,format:n,flags:c,cubemap:f}};function vn(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var Mn=xt(wn),An=Math.abs,Tn=Math.sin,_n=Math.cos,kn=Math.tan,On=Math.atan,xn=Math.atan2,Sn=Math.sqrt,In=Math.log,En=Math.hypot,Cn=Math.sinh,Un=Math.cosh,Fn=1/0;function Nn(t){var e,n,r,i,s,o,a=[],c=[],u=[],f=[];function l(t,e){for(var n,r=2*_n(2*e),i=t.length-1,s=t[i],o=0;--i>=0;)n=r*s-o+t[i],o=s,s=n;return e+n*Tn(2*e)}function h(t,e,n){for(var r,i,s=Tn(e),o=_n(e),a=Cn(n),c=Un(n),u=2*o*c,f=-2*s*a,l=t.length-1,h=t[l],d=0,y=0,m=0;--l>=0;)r=y,i=d,h=u*(y=h)-r-f*(d=m)+t[l],m=f*y-i+u*d;return[(u=s*c)*h-(f=o*a)*m,u*m+f*h]}t.es,s=i=(r=t.es/(1+Sn(1-t.es)))/(2-r),a[0]=i*(2+i*(-2/3+i*(i*(116/45+i*(26/45+i*(-2854/675)))-2))),c[0]=i*(i*(2/3+i*(4/3+i*(-82/45+i*(32/45+i*(4642/4725)))))-2),s*=i,a[1]=s*(7/3+i*(i*(-227/45+i*(2704/315+i*(2323/945)))-1.6)),c[1]=s*(5/3+i*(-16/15+i*(-13/9+i*(904/315+i*(-1522/945))))),s*=i,a[2]=s*(56/15+i*(-136/35+i*(-1262/105+i*(73814/2835)))),c[2]=s*(-26/15+i*(34/21+i*(1.6+i*(-12686/2835)))),s*=i,a[3]=s*(4279/630+i*(-332/35+i*(-399572/14175))),c[3]=s*(1237/630+i*(i*(-24832/14175)-2.4)),s*=i,a[4]=s*(4174/315+i*(-144838/6237)),c[4]=s*(-734/315+i*(109598/31185)),s*=i,a[5]=s*(601676/22275),c[5]=s*(444337/155925),s=i*i,e=t.k0/(1+i)*(1+s*(1/4+s*(1/64+s/256))),u[0]=i*(i*(2/3+i*(-37/96+i*(1/360+i*(81/512+i*(-96199/604800)))))-.5),f[0]=i*(.5+i*(-2/3+i*(5/16+i*(41/180+i*(-127/288+i*(7891/37800)))))),u[1]=s*(-1/48+i*(-1/15+i*(437/1440+i*(-46/105+i*(1118711/3870720))))),f[1]=s*(13/48+i*(i*(557/1440+i*(281/630+i*(-1983433/1935360)))-.6)),s*=i,u[2]=s*(-17/480+i*(37/840+i*(209/4480+i*(-5569/90720)))),f[2]=s*(61/240+i*(-103/140+i*(15061/26880+i*(167603/181440)))),s*=i,u[3]=s*(-4397/161280+i*(11/504+i*(830251/7257600))),f[3]=s*(49561/161280+i*(-179/168+i*(6601661/7257600))),s*=i,u[4]=s*(-4583/161280+i*(108847/3991680)),f[4]=s*(34729/80640+i*(-3418889/1995840)),s*=i,u[5]=s*(-20648693/638668800),f[5]=.6650675310896665*s,o=l(c,t.phi0),n=-e*(o+function(t,e){var n,r=2*_n(e),i=t.length-1,s=t[i],o=0;for(;--i>=0;)n=r*s-o+t[i],o=s,s=n;return Tn(e)*n}(f,2*o)),t.fwd=function(t,r){var i,s,o,a,u,d=t.phi,y=t.lam;d=l(c,d),i=Tn(d),s=_n(d),a=Tn(y),o=_n(y),d=xn(i,o*s),y=xn(a*s,En(i,s*o)),y=function(t){var e=An(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*In(e)/n}(e*(1+e/(En(1,e)+1))),t<0?-e:e}(kn(y)),u=h(f,2*d,2*y),d+=u[0],y+=u[1],An(y)<=2.623395162778?(r.y=e*d+n,r.x=e*y):r.x=r.y=Fn},t.inv=function(t,r){var i,s,o,c,f,d=t.y,y=t.x;d=(d-n)/e,An(y/=e)<=2.623395162778?(d+=(f=h(u,2*d,2*y))[0],y+=f[1],y=On(Cn(y)),i=Tn(d),s=_n(d),c=Tn(y),o=_n(y),y=xn(c,o*s),d=xn(i*o,En(c,o*s)),r.phi=l(a,d),r.lam=y):r.phi=r.lam=Fn}}const Pn=Math.PI/180,Bn=6378137*Math.PI/180,Dn=85.0511287798,Rn={};function Ln(t,e,n,r){if("EPSG:3857"===n)return function(t,e){const n=Dn,r=e[0],i=Math.max(Math.min(n,e[1]),-n);let s;s=0===i?0:Math.log(Math.tan((90+i)*Pn/2))/Pn;return t[0]=r*Bn,t[1]=s*Bn,t}(t,e);if(!n||"EPSG:9807"!==n.code&&"Traverse_Mercator"!==n.code){if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return jn(t,e);if("baidu"===n)return jn(t,e);throw new Error("unsupported projection:"+n)}{if(!(!r||4326===r.wkid))return function(t,e){return t[0]=e[0],t[1]=e[1],t}(t,e);const i=JSON.stringify(n);let s=Rn[i];return s||(s=Rn[i]=function(t){const e={a:qn,es:Vn,x0:pe(t.falseEasting)?5e5:t.falseEasting,y0:pe(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*zn,phi0:(t.latitudeOfOrigin||0)*zn,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};Nn(e);const n={lam:0,phi:0},r={};let i=0,s=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*zn-e.lam0,n.phi=e.originPhi0*zn,e.fwd(n,r),i=e.a*r.x+e.x0,s=e.a*r.y+e.y0);return{project:function(t,o){n.lam=t[0]*zn-e.lam0,n.phi=t[1]*zn,e.fwd(n,r);const a=e.a*r.x+e.x0-i,c=e.a*r.y+e.y0-s;return o[0]=a,o[1]=c,o}}}(n)),s.project(e,t)}}function jn(t,e){return t[0]=e[0],t[1]=e[1],t}const zn=.017453292519943295,qn=6378137,Vn=.0066943799901413165;const Gn=ft([]),$n=Ye().draco,Xn=Ye().ktx2,Hn={"pbrMetallicRoughness":{"baseColorFactor":[.5,.5,.5,1],"metallicFactor":0,"roughnessFactor":.5}},Jn={"position":{name:"POSITION",accessor:{"componentType":5126,"type":"VEC3"}},"normal":{name:"NORMAL",accessor:{"componentType":5126,"type":"VEC3"}},"uv0":{name:"TEXCOORD_0",accessor:{"componentType":5126,"type":"VEC2"}},"color":{name:"COLOR_0",accessor:{"componentType":5121,"type":"VEC4"}},"uv-region":{name:"uvRegion",accessor:{"componentType":5123,"type":"VEC4"}},"feature-index":{name:"_BATCHID",accessor:{"componentType":5125,"type":"SCALAR"}},"faceRange":{name:"faceRange",accessor:{"componentType":5125,"type":"VEC2"}}};function Kn(t,e,n,r,i,s){const o=[],a=[],c=[];for(let e=0;e<t.meshes.length;e++){const{geometry:n,material:r}=t.meshes[e],i=C.getArrayBuffer(n.url,s);i.xhr.url=n.url,c.push(i.xhr);const u=i.then((t=>({buffer:t})));o.push(u);const f=[];if(rr(r,f),f.length){const t=f.map((t=>{const e=C.getArrayBuffer(t.url,s);return e.xhr.url=t.url,c.push(e.xhr),e.then((e=>e&&e.status?null:{buffer:e,mimeType:t.mimeType,format:t.format}))}));o.push(...t)}a[e]=f.length}const u=Promise.all(o).then((s=>{for(let t=0;t<s.length;t++)if(!s[t]||!s[t].buffer)return Promise.resolve(null);const o=[];let c=0;for(let t=0;t<a.length;t++){const e=a[t];o.push({geoBuffer:{data:s[c].buffer.data},textureBuffers:s.slice(c+1,e+c+1).map((t=>({data:t.buffer.data,mimeType:t.mimeType,format:t.format})))}),c+=1+e}const u=function(t,e,n,r,i,s){const o={asset:{generator:"i3s",version:"2.0"},extensions:{},scene:0,scenes:[{nodes:[]}],nodes:{},meshes:{},materials:[],skins:[],animations:null,textures:[],transferables:[]},a=[];for(let c=0;c<t.meshes.length;c++){let{material:u}=t.meshes[c];const{geometry:f}=t.meshes[c];let l;const h=e[c].geoBuffer.data;if(!h)continue;l=ur(h)?Qn(o,c,f,h,t.transform,t.center,i,s):Zn(o,c,f,h,t.transform,t.center,i,s),a.push(l),o.nodes[c]={mesh:c,nodeIndex:c,matrix:ft([])},o.scenes[0].nodes[c]=o.nodes[c],u||(u=Hn);const d=er(c,o,u,e[c].textureBuffers,n,r);a.push(d)}return Promise.all(a).then((()=>({gltf:o,featureTable:{BATCH_LENGTH:0},transferables:o.transferables})))}(t,o,e,i,n,r);return u}));return u.xhr=c,u}const Yn={"magFilter":9728,"minFilter":9728,"wrapR":33071,"wrapS":33071,"wrapT":33071};function Qn(t,e,n,r,i,s,o,a){const c=n.info.compressedAttributes.attributes.reduce(((t,e,n)=>{const r=Jn[e];if(!r)return t;return t[r.name||e]=n,t}),{});return $n(r,{attributes:c,metadatas:{"POSITION":[{name:"i3s-scale_x",type:"double"},{name:"i3s-scale_y",type:"double"}]},useUniqueIDs:!1,skipAttributeTransform:!1}).then((n=>tr(n,t,e,i,s,o,a)))}const Wn={position:function(t,e,n){const r=3*t.vertexCount,i=new Float32Array(e,n,r);return t.position={array:i,componentType:5126,itemSize:3,count:r/3,meta:{"i3s-scale_x":1,"i3s-scale_y":1},type:"VEC3"},n+=4*r},normal:function(t,e,n){const r=3*t.vertexCount,i=new Float32Array(e,n,r);return t.normal={array:i,componentType:5126,itemSize:3,count:r/3,type:"VEC3"},n+=4*r},uv0:function(t,e,n){const r=2*t.vertexCount,i=new Float32Array(e,n,r);return t.uv0={array:i,componentType:5126,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},color:function(t,e,n){const r=4*t.vertexCount,i=new Uint8Array(e,n,r);return t.color={array:i,componentType:5121,itemSize:4,count:r/4,type:"VEC4"},n+=r},featureId:function(t,e,n){return n+=8*t.featureCount},id:function(t,e,n){return n+=8*t.featureCount},faceRange:function(t,e,n){const r=2*t.featureCount,i=new Uint32Array(e,n,r);return t.faceRange={array:i,componentType:5125,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},uvRegion:function(t,e,n){const r=4*t.vertexCount,i=new Uint16Array(e,n,r);return t["uv-region"]={array:i,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r},region:function(t,e,n){const r=4*t.vertexCount,i=new Uint16Array(e,n,r);return t["uv-region"]={array:i,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r}};function Zn(t,e,n,r,i,s,o,a){const c={vertexCount:0},u=new DataView(r);try{let t=0;c.vertexCount=u.getUint32(t,1),t+=4,c.featureCount=u.getUint32(t,1),t+=4;const e=n.info.ordering?null:n.info;if(e){const n=[];for(const t in e)"offset"!==t&&""!==t&&n.push(t);for(let e=0;e<n.length;e++)Wn[n[e]]?t=Wn[n[e]](c,r,t):console.error("Unknown decoder for",n[e])}else{const e=n.info;let i=e.ordering,s=e.featureAttributeOrder;const o=null;o&&o.geometryData&&o.geometryData[0]&&o.geometryData[0].params;for(let e=0;e<i.length;e++){const n=Wn[i[e]];n||console.log(i[e]),t=n(c,r,t)}for(let e=0;e<s.length;e++){const n=Wn[s[e]];n||console.log(s[e]),t=n(c,r,t)}}}catch(t){}c.scale_x=1,c.scale_y=1;const f={};for(const t in c){const e=Jn[t]&&Jn[t].name;e&&(f[e]=c[t])}if(c.faceRange){const t=c.faceRange.array,e=t.length/2,n=(l=e)<=255?Uint8Array:l<=65535?Uint16Array:Uint32Array,r=new n(f.POSITION.array.length/3);for(let e=0;e<t.length-1;e+=2){const n=e/2,i=t[e],s=t[e+1];for(let t=i;t<=s;t++)r[3*t]=n,r[3*t+1]=n,r[3*t+2]=n}f._BATCHID={componentType:$e(n),array:r,itemSize:1,count:r.length,type:"SCALAR"}}var l;return tr({attributes:f},t,e,i,s,o,a)}function tr(t,e,n,r,i,s,o){const a={attributes:t.attributes,material:n,indices:t.indices,mode:4};!function(t){const e=t.array,n=t.meta&&t.meta["i3s-scale_x"],r=t.meta&&t.meta["i3s-scale_y"];if(n&&r&&(1!==n||1!==r))for(let t=0;t<e.length;t+=3)e[t]*=n.value,e[t+1]*=r.value}(t.attributes.POSITION);const c=function(t,e,n,r,i){let s,o=[0,0,0,1];const a=[0,0],c=Ln([],n,r,i);c[2]=n[2];const u=e&&ht(Gn,e);return yn(t,(t=>(o[0]=t[0],o[1]=t[1],o[2]=t[2],u||(o=Mt(o,o,e)),n&&gt(o,o,n),Ln(a,o,r,i),s=o[2],t[0]=a[0]-c[0],t[1]=a[1]-c[1],t[2]=s-c[2],t))),c}(t.attributes.POSITION,r,i,s,o);e.meshes[n]={primitives:[a],index:n},e.extensions.MAPTALKS_RTC={projCenter:c},e.extensions.CESIUM_RTC={rtcCoord:i};for(const n in t.attributes)cr(e.transferables,t.attributes[n].array.buffer);return t.indices&&cr(e.transferables,t.indices.array.buffer),a}function er(t,e,n,r,i,s){const o=r.map((t=>function(t,e,n,r,i){if("dds"===e){const e=Mn(t),r=e.images.map((e=>new Uint8Array(t,e.offset,e.length))),i="dxt1"===e.format?33777:33779;return Promise.resolve({image:{mipmap:r,width:e.shape[0],height:e.shape[1],mimeType:n},sampler:Yn,format:i})}if("png"===e||"jpg"===e)return function(t,e){ir||(ir=new OffscreenCanvas(2,2),sr=ir.getContext("2d",{willReadFrequently:!0}));const n=new Blob([new Uint8Array(t)]);return createImageBitmap(n).then((t=>{let{width:n,height:r}=t;or(n)||(n=ar(n)),or(r)||(r=ar(r));const i=e;i&&(n=Math.min(i,n),r=Math.min(i,r)),ir.width=n,ir.height=r,sr.drawImage(t,0,0,n,r),t.close();const s=sr.getImageData(0,0,n,r);return{width:n,height:r,array:new Uint8Array(s.data)}})).catch((()=>({width:2,height:2,array:new Uint8Array(4)})))}(t,i).then((t=>{t.mimeType=n;return{image:t,sampler:Yn,format:6408}}));if("ktx2"===e)return Xn(t,r).then((t=>(t.mimeType=n,{image:t,sampler:Yn,format:t.format})));return null}(t.data,t.format,t.mimeType,i,s).then((t=>{if(t.image)if(t.image.array)cr(e.transferables,t.image.array.buffer);else if(t.image.mipmap)for(let n=0;n<t.image.mipmap.length;n++)cr(e.transferables,t.image.mipmap[n].buffer);return t}))));return Promise.all(o).then((r=>{nr(t,e,n,r)}))}function nr(t,e,n,r){const i=JSON.parse(JSON.stringify(n)),s=e.textures;r.ptr||(r.ptr=0);for(const t in n)n[t]&&n[t].url?(s.push(r[r.ptr++]),i[t]={index:s.length-1},void 0!==n[t].factor&&(i[t].scale=n[t].factor)):ge(n[t])&&(i[t]=nr(-1,e,n[t],r));return t>=0&&(e.materials[t]=i),i}function rr(t,e){for(const n in t)t[n]&&t[n].url?e.push({url:t[n].url,mimeType:t[n].mimeType,format:t[n].format}):ge(t[n])&&rr(t[n],e)}let ir,sr;function or(t){return!(t&t-1)&&0!==t}function ar(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function cr(t,e){e&&(t.indexOf(e)>=0||t.push(e))}function ur(t){const e=new Uint8Array(t,0,5);return e[0]==="D".charCodeAt()&&e[1]==="R".charCodeAt()&&e[2]==="A".charCodeAt()&&e[3]==="C".charCodeAt()&&e[4]==="O".charCodeAt()}var fr="undefined"!=typeof Float32Array?Float32Array:Array;function lr(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}var hr=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};!function(){var t=function(){var t=new fr(3);return fr!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}()}();const dr=[];const yr=[],mr=[],br=[],pr=[],gr=[],wr=[],vr=[];function Mr(t,e,n,r,i,s){lr(pr,t[3*e],t[3*e+1],t[3*e+2]),lr(gr,t[3*n],t[3*n+1],t[3*n+2]),lr(wr,t[3*r],t[3*r+1],t[3*r+2]);const o=hr(yr,wr,gr),a=hr(mr,pr,gr),c=function(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[0],a=n[1],c=n[2];return t[0]=i*c-s*a,t[1]=s*o-r*c,t[2]=r*a-i*o,t}(br,o,a);!function(t,e){var n=e[0],r=e[1],i=e[2],s=n*n+r*r+i*i;s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s)}(vr,c),i[3*e]=i[3*e]||0,i[3*n]=i[3*n]||0,i[3*r]=i[3*r]||0,i[3*e+1]=i[3*e+1]||0,i[3*n+1]=i[3*n+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*e+2]=i[3*e+2]||0,i[3*n+2]=i[3*n+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*e]+=vr[0],i[3*n]+=vr[0],i[3*r]+=vr[0],i[3*e+1]+=vr[1],i[3*n+1]+=vr[1],i[3*r+1]+=vr[1],i[3*e+2]+=vr[2],i[3*n+2]+=vr[2],i[3*r+2]+=vr[2],s[e]+=1,s[n]+=1,s[r]+=1}const Ar=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],Tr=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],_r=2*Math.PI*6378137/360,kr="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let Or,xr,Sr=!1;if("undefined"!=typeof OffscreenCanvas){try{xr=new OffscreenCanvas(2,2).getContext("2d",{willReadFrequently:!0})}catch(t){}xr&&"undefined"!=typeof createImageBitmap&&(Sr=!0)}const Ir=ft([]),Er=[0,0,0],Cr=[],Ur=[],Fr=[],Nr=[],Pr={"POSITION":1,"TEXCOORD_0":1,"TEXCOORD_1":1,"NORMAL":1,"TANGENT":1},Br={"TEXCOORD_0":1e-4,"TEXCOORD_1":1e-4};let Dr;class Rr{constructor(t,e,n,r){this.id=t,this.options=e,this.At=(...t)=>this.requestImage.call(this,...t),this.Tt=n,this._t={},r(null,{},[])}kt(t){this.Ot||(this.o=t,this.xt=new nn,this.Ot=new Qe(this.At,Q,t),this.St=new We(this.At,Q,t))}requestImage(t,e){Sr?fetch(t).then((t=>t.arrayBuffer())).then((t=>{const e=new self.Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then((t=>{Or.width=t.width,Or.height=t.height,xr.drawImage(t,0,0);const n=xr.getImageData(0,0,Or.width,Or.height);t.close(),e(null,{width:t.width,height:t.height,data:new Uint8Array(n.data)})})):this.Tt("requestImage",{url:t},null,e)}loadTile(t,e){this.kt(t.supportedFormats);const{service:n,url:r,arraybuffer:i}=t,s=n.fetchOptions||{};if(s.referrer=t.referrer,s.referrerPolicy=s.referrerPolicy||"origin",function(t){return t.indexOf("i3s:")>=0}(r)){const i=t.i3sInfo,o=n.maxTextureSize||0,a=Kn(i,t.supportedFormats,this.options.projection,t.projection,o,s);return a.then((t=>{if(delete this._t[r],!t)return void e({status:404,url:r,i3sInfo:i});if(!Object.keys(t.gltf.meshes).length)return void e({status:404,url:r,i3sInfo:i});t.gltf.url=r;const{transferables:s}=t;t.magic="b3dm",n.createNormalIfMissed&&this.It(t.gltf),Hr(n)&&this.Et(t.gltf),e(null,t,s)})),void(this._t[r]=a.xhr)}if(i){delete this._t[r];const n=Ue(new DataView(i),0);if("{"===n[0]||" "===n[0]||"<"===n[0]){const n=function(t,e,n){if(kr){const r=new Uint8Array(t,e,n);return kr.decode(r)}return Me(new Uint8Array(t,e,n))}(i,0,i.byteLength),s=JSON.parse(n);s.accessors?this.Ct(s,r,t,"gltf",e):this.Ut(t.rootIdx,s,i,r,e)}else this.Ct(i,r,t,n,e)}else{let i=n.urlParams;i&&(i=(r.indexOf("?")>0?"&":"?")+i);const o=r.replace(/\\+/g,"%2B");let a=C.getArrayBuffer(o+(i||""),s);const c=a.xhr;a=a.then((n=>{delete this._t[r],n&&n.status?e(n):(t.arraybuffer=n&&n.data,this.loadTile(t,e))})).catch((t=>{delete this._t[r],e(t)})),this._t[r]=c}}Ct(t,e,n,r,i){r=r&&r.toLowerCase();const{service:s}=n;if("b3dm"===r){this.Ot.load(e,t,0,0,{maxTextureSize:s.maxTextureSize||0}).then((t=>{if(t.error)return void i(t);const{content:e,transferables:r}=this.Ft(t,n);s.createNormalIfMissed&&this.It(e.gltf),Hr(s)&&this.Et(e.gltf),i(null,e,r)})).catch((t=>{i(t)}))}else if("pnts"===r){const r=n.transform||Ir;this.xt.load(e,t).then((t=>{const{content:e,transferables:s}=this.Nt(t,r,n.rootIdx);this.Pt(e),i(null,e,s)}))}else if("i3dm"===r){const r=n.transform||Ir;this.St.load(e,t,0,0,{maxTextureSize:s.maxTextureSize||0}).then((t=>{const{content:e,transferables:o}=this.Bt(t,r,n.rootIdx);s.createNormalIfMissed&&this.It(e.gltf),Hr(s)&&this.Et(e.gltf),i(null,e,o)}))}else if("cmpt"===r){new sn(this.At,Q,this.o,s.maxTextureSize||0).load(e,t,0,0,{maxTextureSize:s.maxTextureSize||0}).then((t=>{const{content:e,transferables:r}=this.Dt(t,n);this.Rt(e,s),Hr(s)&&this.Lt(e),i(null,e,r)})).catch((t=>{i(t)}))}else if("gltf"===r){this.st||(this.st=Ye());const r=e.substring(0,e.lastIndexOf("/")),o=t instanceof ArrayBuffer&&{buffer:t,byteOffset:0,byteLength:t.byteLength}||t;let a;try{a=new Q(r,o,{transferable:!0,requestImage:this.At,decoders:this.st,supportedFormats:this.o,maxTextureSize:s.maxTextureSize||0})}catch(t){i(t)}a.load({skipAttributeTransform:!1}).then((t=>{t.url=e,this.jt(t,null,n),s.createNormalIfMissed&&this.It(t),Hr(s)&&this.Et(t),i(null,{magic:"gltf",gltf:t},a.transferables)}))}else i(new Error("unsupported tile format: "+r))}Rt(t,e){t.content?t.content.forEach((t=>{this.Rt(t,e)})):e.createNormalIfMissed&&this.It(t.gltf)}Lt(t){t.content?t.content.forEach((t=>{this.Lt(t)})):this.Et(t.gltf)}zt(t,e){if(this.qt(t,e)&&!t.attributes.NORMAL){const e=t.attributes.POSITION.array,n=e.length,r=this.Vt()?Dr.subarray(0,n):e,i=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const i=dr;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const s=void 0===e.length?e:e.length;for(let n=0;n<s/3;n++)void 0===e.length?Mr(t,3*n,3*n+1,3*n+2,r,i):Mr(t,e[3*n],e[3*n+1],e[3*n+2],r,i);const o=r.getLength?r.getLength():r.length;for(let t=0;t<o;t+=3){const e=i[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(r,t.indices.array,new Float32Array(r.length));t.attributes.NORMAL={array:i,byteLength:i.byteLength,byteOffset:0,byteStride:0,componentType:5126,count:i.length/3,itemSize:3,name:"NORMAL",type:"VEC3"}}}Et(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const t in e){e[t].primitives.forEach((t=>{t.compressed_int16_params={};const e=t.attributes;for(const n in e)if(Pr[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.Vt()&&"POSITION"===n&&(r=_r,t.compressed_int16_params.compressed_ratio=r);const i=Gr(e[n].array,r,e[n].min,e[n].max,n);if(!i)continue;const{array:s,range:o}=i;e[n].componentType=5124,e[n].array=s,t.compressed_int16_params[n]=o}}))}}It(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const n in e){e[n].primitives.forEach((e=>{this.zt(e,t)}))}}Pt(t){if(!t||!t.pnts)return;const e=t.pnts;t.compressed_int16_params={};for(const n in e)if(Pr[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.Vt()&&"POSITION"===n&&(r=_r,t.compressed_int16_params.compressed_ratio=r);const{array:i,range:s}=Gr(e[n].array,r,e[n].min,e[n].max,n);e[n].array=i,t.compressed_int16_params[n]=s}}Gt(t){const e=[];for(let n=0;n<t.length;n++){const r=t[n];if(!r.childTile)continue;const i={boundingVolume:{sphere:[r.boundingSphere.center.x,r.boundingSphere.center.y,r.boundingSphere.center.z,r.boundingSphere.radius]},content:{uri:r.childTile},geometricError:r.boundingSphere.radius/r.rangeList*16,refine:"REPLACE"};e.push(i)}return e}Ut(t,e,n,r,i){return e.capabilities,void i(null,e)}Dt(t,e){const{tiles:n}=t,r={magic:"cmpt",content:[]},i=[];for(let t=0;t<n.length;t++){const{magic:s}=n[t];if("b3dm"===s){const{content:s,transferables:o}=this.Ft(n[t],e);qr(i,o),r.content.push(s)}else if("i3dm"===s){const{transform:s,rootIdx:o}=e,{content:a,transferables:c}=this.Bt(n[t],s,o);qr(i,c),r.content.push(a)}else if("pnts"===s){const{transform:s,rootIdx:o}=e,{content:a,transferables:c}=this.Nt(n[t],s,o);qr(i,c),r.content.push(a)}else if("cmpt"===s){const{content:s,transferables:o}=this.Dt(n[t],e);qr(i,o),r.content.push(s)}}return{content:r,transferables:i}}Ft(t,e){const{gltf:n,transferables:r,featureTable:i}=t;return this.jt(n,i,e),delete t.transferables,{content:t,transferables:r}}jt(t,e,n){const r=function(t){if(!t||!t.meshes)return!1;const e="visited";let n=1;const r=[];for(const i in t.meshes){const s=t.meshes[i],{primitives:o}=s;if(o)for(let t=0;t<o.length;t++){const i=o[t].attributes&&o[t].attributes.POSITION;if(!i||!i.array)continue;i.array.buffer[e]||(i.array.buffer[e]=n++);const s=n-1+"-"+(i.byteOffset||0);if(r.indexOf(s)>=0)return!0;r.push(s)}}return!1}(t);this.$t(t);n.service.createNormalIfMissed||this.Xt(t),t.asset||(t.asset={}),r?(t.asset.sharePosition=!0,this.Ht(t,e,n.upAxis,n.transform)):this.Jt(t,e,n.upAxis,n.transform)}Bt(t,e,n){const{featureTable:r}=t,i=t.i3dm,s=r&&r.RTC_CENTER||[0,0,0],o=this.options.projection,a=e&&ht(Ir,e),c={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};jr(i.POSITION.array,3,s,Ir,c);const u=zr(c);e&&!a&&Mt(u,u,e);const f=this.Kt(u),l=[];Ln(l,f,o),l[2]=f[2];const h=bt([],u),d=[0,0,0],y=[0,0,0],m=[0,0],b=[1/0,1/0,1/0],p=[-1/0,-1/0,-1/0];yn(i.POSITION,(t=>{d[0]=t[0]+s[0],d[1]=t[1]+s[1],d[2]=t[2]+s[2],e&&!a&&Mt(d,d,e),0===_t(d)?pt(y,0,0,-6378137):xe(y,d),Ln(m,y,o),t[0]=m[0]-l[0],t[1]=m[1]-l[1],t[2]=y[2]-l[2],t[0]<b[0]&&(b[0]=t[0]),t[1]<b[1]&&(b[1]=t[1]),t[2]<b[2]&&(b[2]=t[2]),t[0]>p[0]&&(p[0]=t[0]),t[1]>p[1]&&(p[1]=t[1]),t[2]>p[2]&&(p[2]=t[2])})),i.POSITION.min=b,i.POSITION.max=p,e&&Mt(u,u,e),t.rtcCenter=h,t.rtcCoord=f,t.projCenter=l,t.rootIdx=n;const g=t.transferables;return delete t.transferables,{content:t,transferables:g}}Nt(t,e,n){const{featureTable:r}=t,i=t.pnts,s=r&&r.RTC_CENTER||[0,0,0],o=this.options.projection,a=e&&ht(Ir,e),c={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};jr(i.POSITION.array,3,s,e,c);const u=zr(c),f=this.Yt(u),l=bt([],u),h=[1/0,1/0,1/0],d=[-1/0,-1/0,-1/0];let y=[0,0,0,1];const m=[0,0,0],b=[0,0];yn(i.POSITION,(t=>(y[0]=t[0]+s[0],y[1]=t[1]+s[1],y[2]=t[2]+s[2],e&&!a&&(y=Mt(y,y,e)),0===_t(y)?pt(m,0,0,-6378137):xe(m,y),Ln(b,m,o),t[0]=b[0]-f[0],t[1]=b[1]-f[1],t[2]=m[2]-f[2],t[0]<h[0]&&(h[0]=t[0]),t[1]<h[1]&&(h[1]=t[1]),t[2]<h[2]&&(h[2]=t[2]),t[0]>d[0]&&(d[0]=t[0]),t[1]>d[1]&&(d[1]=t[1]),t[2]>d[2]&&(d[2]=t[2]),t))),i.POSITION.min=h,i.POSITION.max=d,e&&Mt(u,u,e);const p=this.Kt(u);t.rtcCenter=l,t.projCenter=f,t.rtcCoord=p,t.rootIdx=n;const g=t.transferables;return delete t.transferables,{content:t,transferables:g}}$t(t){if(!Array.isArray(t.textures))return;const e=t.textures;for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image&&e[t].image.array;if(n&&n.length){const r=n[0],i=n[1],s=n[2],o=n[3];let a=!0;for(let t=4;t<n.length;t+=4)if(n[t]!==r||n[t+1]!==i||n[t+2]!==s||n[t+3]!==o){a=!1;break}a&&(e[t].image.color=[r/255,i/255,s/255,o/255],delete e[t].image.array)}}}Xt(t){const e=t.meshes;for(const n in e){const r=e[n];if(!r)continue;const i=r.primitives;if(i)for(let e=0;e<i.length;e++){if(!i[e])continue;if(!i[e].attributes||i[e].attributes.NORMAL)continue;const n=i[e].material;if(!pe(n)){const e=t.materials[n];if(!e)continue;e.extensions||(e.extensions={}),e.extensions.KHR_materials_unlit={}}}}}abortTileLoading(t,e){const n=this._t[t.url];if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t].abort();else n&&n.abort&&n.abort();delete this._t[t.url],e(null)}Qt(t,e,n,r){const i=e&&e.RTC_CENTER||t.extensions&&t.extensions.CESIUM_RTC&&t.extensions.CESIUM_RTC.center;let s=Ar;"X"===(n=n&&n.toUpperCase())?s=Tr:"Z"===n&&(s=Ir),t.extensions=t.extensions||{},t.extensions.CESIUM_RTC||(t.extensions.CESIUM_RTC={}),i&&(t.extensions.CESIUM_RTC.center=i),t.extensions.MAPTALKS_RTC={};const o={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};on(t,(t=>{if(!(t.attributes&&t.attributes.POSITION))return;const e=ft(Cr);t.matrices&&Vr(e,t.matrices);const n=t.attributes.POSITION.array,a=t.attributes.POSITION.itemSize;lt(e,s,e),r&&lt(e,r,e),jr(n,a,i||Er,e,o,t.compressUniforms)}));const a=zr(o);return{rtcCenter:i,modelCenter:a,upAxisTransform:s}}Ht(t,e,n,r){const{modelCenter:i,upAxisTransform:s,rtcCenter:o}=this.Qt(t,e,n),a=this.Yt(i);t.extensions.MAPTALKS_RTC.projCenter=a,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.Kt(i);const c=bt([],i);r&&Mt(i,i,r),t.extensions.CESIUM_RTC.rtcCoord=this.Kt(i),o||(on(t,(t=>{if(t.attributes&&t.attributes.POSITION){const e=t.attributes.POSITION;if(e.array.buffer.projected&&e.array.buffer.projected[e.byteOffset])return;const n=ft(Cr);t.matrices&&Vr(n,t.matrices),lt(n,s,n);const r=function(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],c=e[6],u=e[7],f=e[8],l=e[9],h=e[10],d=e[11],y=e[12],m=e[13],b=e[14],p=e[15],g=n*a-r*o,w=n*c-i*o,v=n*u-s*o,M=r*c-i*a,A=r*u-s*a,T=i*u-s*c,_=f*m-l*y,k=f*b-h*y,O=f*p-d*y,x=l*b-h*m,S=l*p-d*m,I=h*p-d*b,E=g*I-w*S+v*x+M*O-A*k+T*_;return E?(E=1/E,t[0]=(a*I-c*S+u*x)*E,t[1]=(i*S-r*I-s*x)*E,t[2]=(m*T-b*A+p*M)*E,t[3]=(h*A-l*T-d*M)*E,t[4]=(c*O-o*I-u*k)*E,t[5]=(n*I-i*O+s*k)*E,t[6]=(b*v-y*T-p*w)*E,t[7]=(f*T-h*v+d*w)*E,t[8]=(o*S-a*O+u*_)*E,t[9]=(r*O-n*S-s*_)*E,t[10]=(y*A-m*v+p*g)*E,t[11]=(l*v-f*A-d*g)*E,t[12]=(a*k-o*x-c*_)*E,t[13]=(n*x-r*k+i*_)*E,t[14]=(m*w-y*M-b*g)*E,t[15]=(f*M-l*w+h*g)*E,t):null}(Ur,n),i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];yn(e,(t=>{Mt(t,t,n),t[0]=t[0]-c[0],t[1]=t[1]-c[1],t[2]=t[2]-c[2],Mt(t,t,r),t[0]<i[0]&&(i[0]=t[0]),t[1]<i[1]&&(i[1]=t[1]),t[2]<i[2]&&(i[2]=t[2]),t[0]>o[0]&&(o[0]=t[0]),t[1]>o[1]&&(o[1]=t[1]),t[2]>o[2]&&(o[2]=t[2])})),e.min=i,e.max=o,e.array.buffer.projected||(e.array.buffer.projected={}),e.array.buffer.projected[e.byteOffset]=1}})),t.extensions.CESIUM_RTC.center=c)}Jt(t,e,n,r){const{modelCenter:i,rtcCenter:s}=this.Qt(t,e,n,r),o=this.Yt(i);t.extensions.MAPTALKS_RTC.projCenter=o,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.Kt(i),on(t,(e=>{if(e.attributes&&e.attributes.POSITION){const i=this.qt(e,t);if(i){const t=e.attributes.POSITION.array.length;(!Dr||Dr.length<t)&&(Dr=new Float32Array(t))}e.attributes.NORMAL&&this.Wt(e.attributes.NORMAL,e.matrices,n),e.attributes.TANGENT&&this.Wt(e.attributes.TANGENT,e.matrices,n);const{newPositions:o}=this.Zt(e.attributes.POSITION,e.matrices,s,t.extensions.MAPTALKS_RTC,n,r,e.compressUniforms,i),{componentType:a}=e.attributes.POSITION;5126!==a&&(e.attributes.POSITION.array=new Float32Array(o))}}));for(const e in t.nodes){t.nodes[e].matrix=Ir}}Yt(t){const e=this.options.projection;"identity"===e?bt(Fr,t):0===_t(t)?pt(Fr,0,0,-6378137):xe(Fr,t),Ln(Nr,Fr,e);const n=Fr[2],r=[];return r[0]=Nr[0],r[1]=Nr[1],r[2]=n,r}Wt(t,e,n){let r;r="Y"===n?Ar:"X"===n?Tr:Ir;const i=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}([],r);if(Vr(i,e),ht(i,Ir))return;const s=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}([],i),o=[];yn(t,(t=>(function(t,e,n){var r=e[0],i=e[1],s=e[2];t[0]=r*n[0]+i*n[3]+s*n[6],t[1]=r*n[1]+i*n[4]+s*n[7],t[2]=r*n[2]+i*n[5]+s*n[8]}(o,t,s),wt(o,o),bt(t,o),o)))}Zt(t,e,n,r,i,s,o,a){if(t.array.buffer.projected&&t.array.buffer.projected[t.byteOffset])return null;const c=ft([]);Vr(c,e);const u=this.options.projection;i=i&&i.toUpperCase();const f=n;let l=null;"Y"===i?l=Ar:"X"===i&&(l=Tr);let h=[0,0,0,1];const d=[0,0,0],y=[0,0],m=r.projCenter,b=Ln([],r.rtcCoord,"EPSG:3857"),p=s&&ht(Ir,s),g=t.min=t.min||[],w=t.max=t.max||[];pt(g,1/0,1/0,1/0),pt(w,-1/0,-1/0,-1/0);const v=o||{},{decode_position_min:M,decode_position_normConstant:A}=v;let T=[0,0,0,0],_=1;M&&(T=M),A&&(_=A);const k=[];return yn(t,((e,n)=>{if(h[0]=e[0]*_+T[0],h[1]=e[1]*_+T[1],h[2]=e[2]*_+T[2],h=Mt(h,h,c),l&&(h=Mt(h,h,l)),f&&gt(h,h,f),s&&!p&&(h=Mt(h,h,s)),0===_t(h)?pt(d,0,0,-6378137):xe(d,h),a){const t=Dr;Ln(y,d,u),t[3*n]=y[0]-b[0],t[3*n+1]=y[0]-b[1],t[3*n+2]=y[0]-b[2]}if(Ln(y,d,u),e instanceof Float32Array)e[0]=y[0]-m[0],e[1]=y[1]-m[1],e[2]=d[2]-m[2];else{const n=y[0]-m[0],r=y[1]-m[1],i=d[2]-m[2];5126!==t.componentType&&(k.push(n),k.push(r),k.push(i),k.push(e[3]))}return e[0]<g[0]&&(g[0]=e[0]),e[1]<g[1]&&(g[1]=e[1]),e[2]<g[2]&&(g[2]=e[2]),e[0]>w[0]&&(w[0]=e[0]),e[1]>w[1]&&(w[1]=e[1]),e[2]>w[2]&&(w[2]=e[2]),e})),t.array.buffer.projected||(t.array.buffer.projected={}),t.array.buffer.projected[t.byteOffset]=1,{projCenter:m,newPositions:k}}Kt(t){return 0===_t(t)?pt([],0,0,-6378137):xe([],t)}onRemove(){}Vt(){return"EPSG:4326"===this.options.projection||"EPSG:4490"===this.options.projection}qt(t,e){if(!t.attributes.POSITION||function(t,e){const n=e.materials[t.material],r=n&&n.extensions&&n.extensions.KHR_materials_unlit;return r}(t,e))return!1;return!t.attributes.TANGENT}}const Lr=[];function jr(t,e,n,r,i,s){const o=s||{},{decode_position_min:a,decode_position_normConstant:c}=o;let u=[0,0,0,0],f=1;a&&(u=a),c&&(f=c);for(let s=0,o=t.length;s<o;s+=e){const{xmin:o,ymin:a,xmax:c,ymax:l,hmin:h,hmax:d}=i;pt(Lr,t[s]*f+u[0],t[s+1]*f+u[1],t[s+2]*f+u[2]),Mt(Lr,Lr,r);const y=gt(Lr,n,Lr);y[0]<o&&(i.xmin=y[0]),y[0]>c&&(i.xmax=y[0]),y[1]<a&&(i.ymin=y[1]),y[1]>l&&(i.ymax=y[1]),e>2&&(y[2]<h&&(i.hmin=y[2]),y[2]>d&&(i.hmax=y[2]))}}function zr(t){const{xmax:e,ymax:n,xmin:r,ymin:i,hmin:s,hmax:o}=t,a=[(r+e)/2,(i+n)/2,(s+o)/2];return e===-1/0&&(a[0]=0),n===-1/0&&(a[1]=0),o===-1/0&&(a[2]=0),isNaN(a[2])&&(a[2]=0),a}function qr(t,e){for(let n=0;n<e.length;n++)t.indexOf(e[n])<0&&t.push(e[n])}function Vr(t,e){const n=t;for(let t=e.length-1;t>=0;t--)lt(n,e[t],n);return n}function Gr(t,e,n,r,i){if(e&&e>1)for(let n=0;n<t.length;n++)(n+1)%3!=0&&(t[n]*=e);let s,o;if(n&&r&&1===e)s=Math.min(...n),o=Math.max(...r);else{const{min:e,max:n}=function(t){let e=1/0,n=-1/0;for(let r=0;r<t.length;r++)t[r]>n&&(n=t[r]),t[r]<e&&(e=t[r]);return{min:e,max:n}}(t);s=e,o=n}return!function(t,e,n,r){for(let i=0;i<t.length;i++){const s=$r(Xr(t[i],e,n),e,n);if(Math.abs(s-t[i])>Br[r])return!1}return!0}(t,s,o,i)&&Br[i]?null:function(t,e,n){const r=new Int16Array(t.length);for(let i=0;i<t.length;i++)r[i]=Xr(t[i],e,n);return{array:r,range:[e,n]}}(t,s,o)}function $r(t,e,n){return((t>=32768?-(65536-t)/32768:t/32767)+1)*(n-e)/2+e}function Xr(t,e,n){const r=2*(t-e)/(n-e)-1,i=Math.max(-1,Math.min(1,r));return i<0?32768*i:32767*i}function Hr(t){return void 0===t.compressGeometry||t.compressGeometry}let Jr=0;class Kr{constructor(t){this.workerId=t,this.workers={},this.te={}}addLayer({actorId:t,mapId:e,layerId:n,params:r},i){if(this.ee(e,n))return;const s=this.ne(e,n),o=r.options;this.workers[s]=new Rr(n,o,((...e)=>this.send.call(this,t,...e)),i)}removeLayer({mapId:t,layerId:e},n){const r=this.ee(t,e),i=this.ne(t,e);delete this.workers[i],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const i=this.ee(t,e);i&&i.loadTile(n,r)}abortTileLoading({mapId:t,layerId:e,params:n},r){const i=this.ee(t,e);i&&i.abortTileLoading(n,r)}receive(t){const e=t.callback,n=this.te[e];delete this.te[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,i){const s=i?\`${uX}t}-${uX}Jr++}\`:null;i&&(this.te[s]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(s)},r||[])}ne(t,e){return\`${uX}t}-${uX}e}\`}ee(t,e){const n=this.ne(t,e);return this.workers[n]}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;this.dispatcher||(this.dispatcher=new Kr(t.workerId)),"<response>"===t.type?this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t):this.dispatcher[n.command]({actorId:n.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},((t,n,r)=>{t&&404!==t.status&&204!==t.status&&console.error(t),t instanceof Error&&(t={message:t.message}),e(t,n,r)}))}}`;var fX={exports:{}},dX={exports:{}},pX=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},gX=Array.prototype.concat,mX=Array.prototype.slice,AX=dX.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];pX(i)?e=gX.call(e,mX.call(i)):e.push(i)}return e};AX.wrap=function(t){return function(){return t(AX(arguments))}};var yX=dX.exports,vX={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},xX=yX,_X=Object.hasOwnProperty,bX=Object.create(null);for(var wX in vX)_X.call(vX,wX)&&(bX[vX[wX]]=wX);var TX=fX.exports={to:{},get:{}};function MX(t,e,n){return Math.min(Math.max(e,t),n)}function CX(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}TX.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=TX.get.hsl(t),n="hsl";break;case"hwb":e=TX.get.hwb(t),n="hwb";break;default:e=TX.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},TX.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var o=2*n;i[n]=parseInt(e.slice(o,o+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:_X.call(vX,e[1])?((i=vX[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=MX(i[n],0,255);return i[3]=MX(i[3],0,1),i},TX.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,MX(parseFloat(e[2]),0,100),MX(parseFloat(e[3]),0,100),MX(isNaN(n)?1:n,0,1)]}return null},TX.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,MX(parseFloat(e[2]),0,100),MX(parseFloat(e[3]),0,100),MX(isNaN(n)?1:n,0,1)]}return null},TX.to.hex=function(){var t=xX(arguments);return"#"+CX(t[0])+CX(t[1])+CX(t[2])+(t[3]<1?CX(Math.round(255*t[3])):"")},TX.to.rgb=function(){var t=xX(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},TX.to.rgb.percent=function(){var t=xX(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},TX.to.hsl=function(){var t=xX(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},TX.to.hwb=function(){var t=xX(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},TX.to.keyword=function(t){return bX[t.slice(0,3)]};var SX=fX.exports,IX={exports:{}},PX={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},EX={};for(var OX in PX)PX.hasOwnProperty(OX)&&(EX[PX[OX]]=OX);var RX=IX.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var kX in RX)if(RX.hasOwnProperty(kX)){if(!("channels"in RX[kX]))throw new Error("missing channels property: "+kX);if(!("labels"in RX[kX]))throw new Error("missing channel labels property: "+kX);if(RX[kX].labels.length!==RX[kX].channels)throw new Error("channel and label counts mismatch: "+kX);var LX=RX[kX].channels,DX=RX[kX].labels;delete RX[kX].channels,delete RX[kX].labels,Object.defineProperty(RX[kX],"channels",{value:LX}),Object.defineProperty(RX[kX],"labels",{value:DX})}RX.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,o=t[2]/255,s=Math.min(r,i,o),a=Math.max(r,i,o),l=a-s;return a===s?e=0:r===a?e=(i-o)/l:i===a?e=2+(o-r)/l:o===a&&(e=4+(r-i)/l),(e=Math.min(60*e,360))<0&&(e+=360),n=(s+a)/2,[e,100*(a===s?0:n<=.5?l/(a+s):l/(2-a-s)),100*n]},RX.rgb.hsv=function(t){var e,n,r,i,o,s=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(s,a,l),u=h-Math.min(s,a,l),c=function(t){return(h-t)/6/u+.5};return 0===u?i=o=0:(o=u/h,e=c(s),n=c(a),r=c(l),s===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*o,100*h]},RX.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[RX.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,r))*100,100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},RX.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},RX.rgb.keyword=function(t){var e=EX[t];if(e)return e;var n,r,i,o=1/0;for(var s in PX)if(PX.hasOwnProperty(s)){var a=(r=t,i=PX[s],Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));a<o&&(o=a,n=s)}return n},RX.keyword.rgb=function(t){return PX[t]},RX.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},RX.rgb.lab=function(t){var e=RX.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},RX.hsl.rgb=function(t){var e,n,r,i,o,s=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return[o=255*l,o,o];e=2*l-(n=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(r=s+1/3*-(h-1))<0&&r++,r>1&&r--,o=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*o;return i},RX.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,o=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=o<=1?o:2-o,[e,100*(0===r?2*i/(o+i):2*n/(r+n)),(r+n)/2*100]},RX.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,o=e-Math.floor(e),s=255*r*(1-n),a=255*r*(1-n*o),l=255*r*(1-n*(1-o));switch(r*=255,i){case 0:return[r,l,s];case 1:return[a,r,s];case 2:return[s,r,l];case 3:return[s,a,r];case 4:return[l,s,r];case 5:return[r,s,a]}},RX.hsv.hsl=function(t){var e,n,r,i=t[0],o=t[1]/100,s=t[2]/100,a=Math.max(s,.01);return r=(2-o)*s,n=o*a,[i,100*(n=(n/=(e=(2-o)*a)<=1?e:2-e)||0),100*(r/=2)]},RX.hwb.rgb=function(t){var e,n,r,i,o,s,a,l=t[0]/360,h=t[1]/100,u=t[2]/100,c=h+u;switch(c>1&&(h/=c,u/=c),r=6*l-(e=Math.floor(6*l)),1&e&&(r=1-r),i=h+r*((n=1-u)-h),e){default:case 6:case 0:o=n,s=i,a=h;break;case 1:o=i,s=n,a=h;break;case 2:o=h,s=n,a=i;break;case 3:o=h,s=i,a=n;break;case 4:o=i,s=h,a=n;break;case 5:o=n,s=h,a=i}return[255*o,255*s,255*a]},RX.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},RX.xyz.rgb=function(t){var e,n,r,i=t[0]/100,o=t[1]/100,s=t[2]/100;return n=-.9689*i+1.8758*o+.0415*s,r=.0557*i+-.204*o+1.057*s,e=(e=3.2406*i+-1.5372*o+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},RX.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},RX.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(r,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},RX.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},RX.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},RX.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:RX.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var o=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(o+=60),o},RX.hsv.ansi16=function(t){return RX.rgb.ansi16(RX.hsv.rgb(t),t[2])},RX.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},RX.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},RX.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},RX.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},RX.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},RX.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,o=Math.max(Math.max(n,r),i),s=Math.min(Math.min(n,r),i),a=o-s;return e=a<=0?0:o===n?(r-i)/a%6:o===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?s/(1-a):0)]},RX.hsl.hcg=function(t){var e,n=t[1]/100,r=t[2]/100,i=0;return(e=r<.5?2*n*r:2*n*(1-r))<1&&(i=(r-.5*e)/(1-e)),[t[0],100*e,100*i]},RX.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},RX.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,o=[0,0,0],s=e%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return i=(1-n)*r,[255*(n*o[0]+i),255*(n*o[1]+i),255*(n*o[2]+i)]},RX.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},RX.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},RX.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},RX.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},RX.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},RX.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},RX.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},RX.gray.hsl=RX.gray.hsv=function(t){return[0,0,t[0]]},RX.gray.hwb=function(t){return[0,100,t[0]]},RX.gray.cmyk=function(t){return[0,0,0,t[0]]},RX.gray.lab=function(t){return[t[0],0,0]},RX.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},RX.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var NX=IX.exports,FX=NX;function zX(t,e){return function(n){return e(t(n))}}function BX(t,e){for(var n=[e[t].parent,t],r=FX[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=zX(FX[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var HX=NX,jX=function(t){for(var e=function(t){var e=function(){for(var t={},e=Object.keys(FX),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(FX[r]),o=i.length,s=0;s<o;s++){var a=i[s],l=e[a];-1===l.distance&&(l.distance=e[r].distance+1,l.parent=r,n.unshift(a))}return e}(t),n={},r=Object.keys(e),i=r.length,o=0;o<i;o++){var s=r[o];null!==e[s].parent&&(n[s]=BX(s,e))}return n},UX={};Object.keys(HX).forEach((function(t){UX[t]={},Object.defineProperty(UX[t],"channels",{value:HX[t].channels}),Object.defineProperty(UX[t],"labels",{value:HX[t].labels});var e=jX(t);Object.keys(e).forEach((function(n){var r,i,o=e[n];UX[t][n]=(i=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var e=r(t);if("object"==typeof e)for(var n=e.length,i=0;i<n;i++)e[i]=Math.round(e[i]);return e},"conversion"in(r=o)&&(i.conversion=r.conversion),i),UX[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(o)}))}));var VX=SX,GX=UX,WX=[].slice,qX=["keyword","gray","hex"],XX={};Object.keys(GX).forEach((function(t){XX[WX.call(GX[t].labels).sort().join("")]=t}));var ZX={};function YX(t,e){if(!(this instanceof YX))return new YX(t,e);if(e&&e in qX&&(e=null),e&&!(e in GX))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof YX)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=VX.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=GX[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=GX[this.model].channels;var o=WX.call(t,0,r);this.color=KX(o,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var s=Object.keys(t);"alpha"in t&&(s.splice(s.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=s.sort().join("");if(!(a in XX))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=XX[a];var l=GX[this.model].labels,h=[];for(n=0;n<l.length;n++)h.push(t[l[n]]);this.color=KX(h)}if(ZX[this.model])for(r=GX[this.model].channels,n=0;n<r;n++){var u=ZX[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function JX(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(ZX[t]||(ZX[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function QX(t){return function(e){return Math.max(0,Math.min(t,e))}}function KX(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}YX.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in VX.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return VX.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return VX.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=GX[this.model].channels,n=GX[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new YX(this.color.map(function(t){return function(e){return n=t,Number(e.toFixed(n));var n}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new YX(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:JX("rgb",0,QX(255)),green:JX("rgb",1,QX(255)),blue:JX("rgb",2,QX(255)),hue:JX(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:JX("hsl",1,QX(100)),lightness:JX("hsl",2,QX(100)),saturationv:JX("hsv",1,QX(100)),value:JX("hsv",2,QX(100)),chroma:JX("hcg",1,QX(100)),gray:JX("hcg",2,QX(100)),white:JX("hwb",1,QX(100)),wblack:JX("hwb",2,QX(100)),cyan:JX("cmyk",0,QX(100)),magenta:JX("cmyk",1,QX(100)),yellow:JX("cmyk",2,QX(100)),black:JX("cmyk",3,QX(100)),x:JX("xyz",0,QX(100)),y:JX("xyz",1,QX(100)),z:JX("xyz",2,QX(100)),l:JX("lab",0,QX(100)),a:JX("lab",1),b:JX("lab",2),keyword:function(t){return arguments.length?new YX(t):GX[this.model].keyword(this.color)},hex:function(t){return arguments.length?new YX(t):VX.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return YX.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,o=2*i-1,s=n.alpha()-r.alpha(),a=((o*s==-1?o:(o+s)/(1+o*s))+1)/2,l=1-a;return YX.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(GX).forEach((function(t){if(-1===qX.indexOf(t)){var e=GX[t].channels;YX.prototype[t]=function(){if(this.model===t)return new YX(this);if(arguments.length)return new YX(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new YX((n=GX[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},YX[t]=function(n){return"number"==typeof n&&(n=KX(WX.call(arguments),e)),new YX(n,t)}}}));var $X=function(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}(YX);function tZ(t){return null==t}function eZ(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function nZ(t){return null!=t&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function rZ(t){return"object"==typeof t&&!!t}function iZ(t){return t*Math.PI/180}function oZ(t){return t/Math.PI*180}function sZ(t){return Math.sign?Math.sign(t):0==(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function aZ(t,e,n){return t[3*n]=e[0],t[3*n+1]=e[1],t[3*n+2]=e[2],t}function lZ(t){return t.flat?t.flat(1/0):t.reduce(((t,e)=>t.concat(e)),[])}function hZ(t){return 0===t.indexOf("data:")}function uZ(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}const cZ={};function fZ(t){return-1===t.indexOf("http://")&&-1===t.indexOf("https://")&&-1===t.indexOf("file://")}function dZ(t){return(t=t||{}).referrerPolicy=t.referrerPolicy||"origin",t.referrer=window&&window.location.href,t}const pZ="undefined"==typeof document?null:document.createElement("canvas");let gZ=class extends h.Actor{constructor(t,e,n){super(t),this.mapId=e,this.i=n}initialize(t){t(null)}loadTile(t,e,n){let r=null;e&&e.arraybuffer&&(r=[e.arraybuffer]);const i={mapId:this.mapId,layerId:t,command:"loadTile",params:e};this.send(i,r,n)}abortTileLoading(t,e,n){const r={mapId:this.mapId,layerId:t,command:"abortTileLoading",params:{url:e}};this.broadcast(r,null,n)}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(r,null,n)}removeLayer(t,e){const n={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(n,null,e)}requestImage({url:t},e){const n=new Image;n.onload=()=>{if(!this.isActive())return;if(!pZ)return void e(new Error("There is no canvas to draw image!"));const t=this.i?n:function(t){if(mZ(t.width)&&mZ(t.height))return t;let e=t.width,n=t.height;mZ(e)||(e=AZ(e)),mZ(n)||(n=AZ(n));const r=document.createElement("canvas");r.width=e,r.height=n,r.getContext("2d").drawImage(t,0,0,e,n);const i=t.src,o=i.lastIndexOf("/")+1,s=i.substring(o);return console.warn(`Texture(${s})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),r}(n);pZ.width=t.width,pZ.height=t.height;const r=pZ.getContext("2d",{willReadFrequently:!0});r.drawImage(t,0,0,t.width,t.height);const i=r.getImageData(0,0,t.width,t.height),o={width:t.width,height:t.height,data:new Uint8Array(i.data)};e(null,o,[o.data.buffer])},n.onerror=function(t){e(t)},n.src=t}};function mZ(t){return!(t&t-1)&&0!==t}function AZ(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function yZ(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,i=r.length;n<i;n++){const i=[];MZ(r[n],i,t,e)}}}const vZ=[],xZ=[],_Z=[],bZ=[0,0,0],wZ=FA([]),TZ=[1,1,1];function MZ(t,e,n,r){const i=e.slice(0);if(t.matrix)i.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=cm(vZ,t.translation||bZ),n=vm(xZ,t.rotation||wZ),r=fm(_Z,t.scale||TZ);am(r,n,r);const o=am([],e,r);i.push(o)}if(t.children&&t.children.length)for(let o=0,s=t.children.length;o<s;o++)MZ(t.children[o],i,n,r);if(void 0!==t.mesh){const e=t.mesh,o=n.meshes[e];if(o){const t=i.slice(0),s=o.primitives;for(let i=0,o=s.length;i<o;i++){const o=s[i];o&&(o.matrices=t,r(o,e,i,n))}}}}function CZ(t,e,n){let{byteOffset:r,byteStride:i}=e;const{componentType:o,itemSize:s}=e,a=e.array.buffer,l=o?gg.getTypedArrayCtor(o):e.array.constructor;if(r=void 0===r?e.array.byteOffset:r,i=i||0,!i||i===s*l.BYTES_PER_ELEMENT&&r%l.BYTES_PER_ELEMENT==0){const e=new l(a,r+n*s*l.BYTES_PER_ELEMENT,s);return t.set(e),t}i||(i=s*l.BYTES_PER_ELEMENT);const h=new Uint8Array(a,i*n+r,s*l.BYTES_PER_ELEMENT);return new Uint8Array(t.buffer).set(h),t}function SZ(t,e,n,r){t[4*e]=n[r],t[4*e+1]=n[r+4],t[4*e+2]=n[r+8],t[4*e+3]=n[r+12]}var IZ="#include <gl2_vert>\n\nconst float SHIFT_RIGHT_11 = 1.0 / 2048.0;\n\nconst float SHIFT_RIGHT_5 = 1.0 / 32.0;\n\nconst float SHIFT_LEFT_11 = 2048.0;\n\nconst float SHIFT_LEFT_5 = 32.0;\n\nconst float NORMALIZE_6 = 1.0 / 64.0;\n\nconst float NORMALIZE_5 = 1.0 / 32.0;\n\n\n\n#ifdef HAS_POSITION\n\n    attribute vec3 POSITION;\n\n#endif\n\n\n\n#if defined(HAS_RGB)\n\n    attribute vec3 RGB;\n\n#elif defined(HAS_RGBA)\n\n    attribute vec4 RGBA;\n\n#elif defined(HAS_RGB565)\n\n    attribute float RGB565;\n\n#endif\n\n\n\nuniform vec4 pointColor;\n\nuniform float pointSize;\n\n\n\nuniform mat4 projViewModelMatrix;\n\nuniform float pointOpacity;\n\n\n\nvarying vec4 vColor;\n\n\n\n#ifdef HAS_NORMAL\n\n    #ifdef HAS_NORMAL_OCT16P\n\n        attribute vec2 NORMAL_OCT16P;\n\n        float signNotZero(float value) {\n\n            return value >= 0.0 ? 1.0 : -1.0;\n\n        }\n\n        vec2 signNotZero(vec2 value) {\n\n            return vec2(signNotZero(value.x), signNotZero(value.y));\n\n        }\n\n        vec3 octDecode(vec2 encoded, float range) {\n\n            if (encoded.x == 0.0 && encoded.y == 0.0) {\n\n                return vec3(0.0, 0.0, 0.0);\n\n            }\n\n            encoded = encoded / range * 2.0 - 1.0;\n\n            vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n\n            if (v.z < 0.0) {\n\n                v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n\n            }\n\n            return normalize(v);\n\n        }\n\n        vec3 octDecode(vec2 encoded) {\n\n            return octDecode(encoded, 255.0);\n\n        }\n\n    #else\n\n        attribute vec3 NORMAL;\n\n    #endif\n\n    uniform vec3 lightDir;\n\n    uniform mat3 modelNormalMatrix;\n\n    uniform mat4 positionMatrix;\n\n    float getLambertDiffuse(vec3 lightDir, vec3 normal) {\n\n        return max(dot(-lightDir, normal), 0.0);\n\n    }\n\n#endif\n\n#ifdef PICKING_MODE\n\n    #include <fbo_picking_vert>\n\n#endif\n\n#include <draco_decode_vert>\n\nvoid main() {\n\n    #ifdef HAS_POSITION\n\n        vec3 localPos = decode_getPosition(POSITION);\n\n    #endif\n\n    gl_Position = projViewModelMatrix * vec4(localPos, 1.0);\n\n    gl_PointSize = pointSize;\n\n\n\n    #ifdef PICKING_MODE\n\n        fbo_picking_setData(gl_Position.w, true);\n\n    #else\n\n        #if defined(HAS_RGB)\n\n            vColor = vec4(RGB / 255.0, 1.0) * pointOpacity;\n\n        #elif defined(HAS_RGBA)\n\n            vColor = RGBA / 255.0 * pointOpacity;\n\n        #elif defined(HAS_RGB565)\n\n            float compressed = RGB565;\n\n            float r = floor(compressed * SHIFT_RIGHT_11);\n\n            compressed -= r * SHIFT_LEFT_11;\n\n            float g = floor(compressed * SHIFT_RIGHT_5);\n\n            compressed -= g * SHIFT_LEFT_5;\n\n            float b = compressed;\n\n            vec3 rgb = vec3(r * NORMALIZE_5, g * NORMALIZE_6, b * NORMALIZE_5);\n\n            vColor = vec4(rgb, 1.0);\n\n        #else\n\n            vColor = pointColor;\n\n        #endif\n\n\n\n        #ifdef HAS_NORMAL\n\n            mat3 positionNormalMatrix = mat3(positionMatrix);\n\n            mat3 normalMatrix = modelNormalMatrix * positionNormalMatrix;\n\n            #ifdef HAS_NORMAL_OCT16P\n\n                vec3 localNormal = octDecode(NORMAL_OCT16P);\n\n            #else\n\n                vec3 localNormal = NORMAL;\n\n            #endif\n\n            vec3 normal = normalize(normalMatrix * localNormal);\n\n            float colorStrength = getLambertDiffuse(lightDir, normal);\n\n            colorStrength = max(colorStrength, 0.5);\n\n            vColor *= colorStrength;\n\n        #endif\n\n    #endif\n\n\n\n\n\n\n\n\n\n}\n\n";const PZ=new Array(3),EZ=new Array(3),OZ=[40680631590769,40680631590769,40408299984661.445];function RZ(t,e,n,r){const i=OZ,o=Math.cos(n);PZ[0]=o*Math.cos(e),PZ[1]=o*Math.sin(e),PZ[2]=Math.sin(n),VZ(PZ,PZ),Fm(EZ,i,PZ);const s=Math.sqrt(Wm(PZ,EZ));var a,l,h;return l=EZ,h=s,(a=EZ)[0]=l[0]/h,a[1]=l[1]/h,a[2]=l[2]/h,Bm(PZ,PZ,r),Dm(t,EZ,PZ)}const kZ=[1/6378137,1/6378137,1/6356752.314245179],LZ=[1/40680631590769,1/40680631590769,1/40408299984661.445],DZ=new Array(3),NZ=new Array(3),FZ=new Array(3);function zZ(t,e){const n=LZ,r=function(t,e,n,r){const i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=n[2],u=i*i*a*a,c=o*o*l*l,f=s*s*h*h,d=u+c+f,p=Math.sqrt(1/d),g=Bm(BZ,e,p);if(d<.1)return isFinite(p)?g:void 0;const m=r[0],A=r[1],y=r[2],v=HZ;v[0]=g[0]*m*2,v[1]=g[1]*A*2,v[2]=g[2]*y*2;let x,_,b,w,T,M,C,S,I,P,E,O=(1-p)*UZ(e)/(.5*UZ(v)),R=0;do{O-=R,b=1/(1+O*m),w=1/(1+O*A),T=1/(1+O*y),M=b*b,C=w*w,S=T*T,I=M*b,P=C*w,E=S*T,x=u*M+c*C+f*S-1,_=u*I*m+c*P*A+f*E*y,R=x/(-2*_)}while(Math.abs(x)>jZ);return t[0]=i*b,t[1]=o*w,t[2]=s*T,t}(DZ,e,kZ,n);let i=$m(NZ,r,n);i=VZ(i,i);const o=Km(FZ,e,r),s=Math.atan2(i[1],i[0]),a=Math.asin(i[2]),l=sZ(Wm(o,e))*UZ(o);return t[0]=oZ(s),t[1]=oZ(a),t[2]=l,t}const BZ=new Array(3),HZ=new Array(3),jZ=1e-12;function UZ(t){return Om(t)}function VZ(t,e){const n=e[0],r=e[1],i=e[2];let o=n*n+r*r+i*i;return o>0&&(o=Math.sqrt(o),t[0]=e[0]/o,t[1]=e[1]/o,t[2]=e[2]/o),t}function GZ(t,e){return Fm(e,t,LZ),Gm(e,e)}function WZ(t,e){const n=t[0],r=t[1],i=Math.cos(r),o=i*Math.cos(n),s=i*Math.sin(n),a=Math.sin(r);return e.x=o,e.y=s,e.z=a,Gm(e,e)}function qZ(t,e,n,r){n=n||0,r=r||n;const i=Math.abs(t-e);return i<=r||i<=n*Math.max(Math.abs(t),Math.abs(e))}function XZ(t,e,n,r){const{byteOffset:i,componentType:o,type:s}=t,{ctor:a}=QZ(o||"UNSIGNED_SHORT"),l=YZ(s),h=new a(e,i,n*l);return 1===l?h[r]:h.subarray(r*l,r*l+l)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const ZZ={SCALAR:1,VEC2:2,VEC3:3,VEC4:4};function YZ(t){return t?ZZ[t]:1}const JZ={BYTE:{ctor:Int8Array,type:5120,name:"Int8Array"},UNSIGNED_BYTE:{ctor:Uint8Array,type:5121,name:"Uint8Array"},SHORT:{ctor:Int16Array,type:5122,name:"Int16Array"},UNSIGNED_SHORT:{ctor:Uint16Array,type:5123,name:"Uint16Array"},INT:{ctor:Int32Array,type:5124,name:"Int32Array"},UNSIGNED_INT:{ctor:Uint32Array,type:5125,name:"Uint32Array"},FLOAT:{ctor:Float32Array,type:5126,name:"Float32Array"},DOUBLE:{ctor:Float64Array,type:5126,name:"Float64Array"}};function QZ(t){return JZ[t]}const KZ={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},$Z={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},tY={},eY={east:[],north:[],up:[],west:[],south:[],down:[]};let nY=[],rY=[],iY=[];const oY=[0,0,0];function sY(t,e,n){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=t[15],n}const aY=function(t,e){const n=KZ[t][e];let r;const i=t+e;return tY[i]?r=tY[i]:(r=function(r,i,o){if(Jm(r,oY))km(nY,$Z[t]),km(rY,$Z[e]),km(iY,$Z[n]);else if(qZ(r[0],0,1e-14)&&qZ(r[1],0,1e-14)){const i=sZ(r[2]);km(nY,$Z[t]),km(rY,$Z[e]),Bm(rY,rY,i),km(iY,$Z[n]),Bm(iY,iY,i)}else{GZ(r,eY.up);const i=eY.up,o=eY.east;o[0]=-r[1],o[1]=r[0],o[2]=0,Gm(eY.east,o),qm(eY.north,i,o),Bm(eY.down,eY.up,-1),Bm(eY.west,eY.east,-1),Bm(eY.south,eY.north,-1),nY=eY[t],rY=eY[e],iY=eY[n]}return o[0]=nY[0],o[1]=nY[1],o[2]=nY[2],o[3]=0,o[4]=rY[0],o[5]=rY[1],o[6]=rY[2],o[7]=0,o[8]=iY[0],o[9]=iY[1],o[10]=iY[2],o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1,o},tY[i]=r),r}("east","north"),lY=[],hY=[],uY=[],cY=[],fY=[],dY=[],pY=[],gY={x:0,y:0},mY={x:0,y:0},AY=Math.PI/180;let yY;const vY={width:100,height:10};let xY=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),xY=!0}catch(Ap){xY=!1}let _Y=class{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},vY,e),this.o()}getImageData(){return this.imgData}o(){const t=function(){if(!yY){const{width:t,height:e}=vY;xY?yY=new OffscreenCanvas(t,e):(yY=document.createElement("canvas"),yY.width=t,yY.height=e)}return yY}(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:s}=this;for(let a=0,l=o.length;a<l;a++){const[t,e]=o[a],n=(t-this.min)/s;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}};var bY;function wY(t,e){var n,r,i;if(kY(t)){var o,s=t.stops&&"object"==typeof t.stops[0][0],a=s||void 0!==t.property,l=s||!a,h=t.type||e||"exponential";if("exponential"===h)o=CY;else if("interval"===h)o=MY;else if("categorical"===h)o=TY;else if("identity"===h)o=PY;else if("color-interpolate"===h)o=IY;else{if("calculate-expression"!==h)throw new Error('Unknown function type "'+h+'"');o=EY}if(s){var u={},c=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===u[f[0].zoom]&&(u[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in u)c.push([u[t].zoom,wY(u[t])]);n=function(e,n){const r=CY({stops:c,base:t.base},e)(e,n);return"function"==typeof r?r(e,n):r},r=!1,i=!1}else l?(n=function(e){const n=o(t,e);return"function"==typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=o(t,n?n[t.property]:null);return"function"==typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function TY(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function MY(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function CY(t,e){for(var n=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:OY(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(bY=new Map);const SY={width:100,height:1};function IY(t,e){const n=t.stops;if(n&&n.length>1){let t;if(bY){const e=JSON.stringify(n);if(!bY.has(e)){const t=new _Y(n,SY);bY.set(e,t)}t=bY.get(e)}else t=new _Y(n,SY);const[r,i,o,s]=t.getColor(e);return[r/255,i/255,o/255,s/255]}return n&&1===n.length?n[0][1]:null}function PY(t,e){return n=e,r=t.default,void 0!==n?n:void 0!==r?r:null;var n,r}function EY(t,e){const n=String(t.property),r=t.expression,i=e;function o(e){return null==e||""===e||isNaN(e)?t.default:e}if(null==e||""===e||isNaN(e)||e<0)return o(t.default);return o(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const r=n[0];if(!["+","-","*","/"].includes(r))throw new Error(`Unknown operator: ${r}`);const i=n.slice(1).map((t=>e(t)));switch(r){case"+":return i.reduce(((t,e)=>t+e),0);case"-":return i.reduce(((t,e)=>t-e));case"*":return i.reduce(((t,e)=>t*e),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,e)=>t/e));default:throw new Error(`Unsupported operator: ${r}`)}}}(function t(e,n,r){const i=Number(r),o=String(n);return Array.isArray(e)?e.map((e=>t(e,o,i))):e===o?i:e}(r,n,i)))}function OY(t,e,n,r,i,o){return"function"==typeof i?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return OY(t,e,n,r,s,a)}:i.length?function(t,e,n,r,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=RY(t,e,n,r,i[a],o[a]);return s}(t,e,n,r,i,o):RY(t,e,n,r,i,o)}function RY(t,e,n,r,i,o){var s,a=r-n,l=t-n;return i*(1-(s=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+o*s}function kY(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function LY(t){return DY(t,"exponential")}function DY(t,e){if(!kY(t))return function(){return t};let n=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let s=0;s<i.length;s++)if(kY(i[s][1])){const t=DY(i[s][1],e);n=n&&t.isZoomConstant,r=r&&t.isFeatureConstant,i[s]=[i[s][0],t]}const o=wY(t,e);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=r&&o.isFeatureConstant,o}const{getTextureMagFilter:NY,getTextureMinFilter:FY,getTextureWrap:zY,getMaterialType:BY,getMaterialFormat:HY,getPrimitive:jY,getUniqueREGLBuffer:UY}=Hx,VY=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],GY=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],{loginIBLResOnCanvas:WY,logoutIBLResOnCanvas:qY,getIBLResOnCanvas:XY,getPBRUniforms:ZY}=xT.PBRUtils,YY={factor:0,units:0},JY=[1,1,1,1],QY=[0,0,0],KY={specularStrength:0,materialShininess:1},$Y=[1,1,1],tJ=im([]),eJ=[0,0,0],nJ=[0,0],rJ=[],iJ=t=>t.material instanceof e_,oJ=t=>t.material instanceof xT.StandardMaterial,sJ=[],aJ=new n(0,0),lJ=new i(0,0),hJ=new i(0,0),uJ=new i(0,0),cJ=[],fJ=[],dJ=[],pJ=[],gJ=[],mJ=[],AJ=[],yJ=[],vJ=[],xJ=[],_J=[],bJ=[],wJ=[],TJ=[],MJ={POSITION:"POSITION",NORMAL:"NORMAL",TEXCOORD_0:"TEXCOORD_0",TEXCOORD_1:"TEXCOORD_1",COLOR_0:"COLOR_0",TANGENT:"TANGENT",_BATCHID:"_BATCHID"},CJ=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],SJ=function(t){const e=2*Math.PI/t,n=[],r=[];for(let o=0;o<=t;o++){const t=1*Math.cos(e*o),r=1*Math.sin(e*o),i=0;n[3*o]=t,n[3*o+1]=r,n[3*o+2]=i}for(let o=t;o<=200;o++){const t=1*Math.cos(e*o),r=1*Math.sin(e*o),i=0;n[3*o]=i,n[3*o+1]=t,n[3*o+2]=r}for(let o=200;o<=300;o++){const t=1*Math.cos(e*o),r=1*Math.sin(e*o),i=0;n[3*o]=t,n[3*o+1]=i,n[3*o+2]=r}const i=n.length/3-1;for(let o=0;o<i;o++)99!==o&&199!==o&&(r[2*o]=o,r[2*o+1]=o+1);return n.push(0,0,0),n.push(1,0,0),n.push(0,1,0),n.push(0,0,1),r.push(i+1,i+2),r.push(i+1,i+3),r.push(i+1,i+4),{vertices:n,indices:r}}(100),IJ=[0,0,0,1],PJ=[1,1,1];let EJ=class{constructor(t,e){this.h=e,this.u=e.getRenderer().canvas,this.pickingFBO=e.getRenderer().pickingFBO,this.m=t,this.p=new f_(t),this.v={},this.T={},this._={},this.M={},this.O={},this.A={},this.I=new __,this.S=new __,this.C=new __,this.N=new __,this.k=new g_(t.texture(2)),this.R=(...t)=>this.L.call(this,...t),this.P=new Gw(this.m,this.B(),this.k);const n=this.getMap();this.U=n.altitudeToPoint(100,n.getGLRes())/100}getI3DMMeshes(){return this.M}getPNTSMeshes(){return this._}getB3DMMeshes(){return this.T}getPaintedMeshes(){return this.D}getMap(){return this.h.getMap()}paint(t,e,n,r){const i=r&&r.renderTarget,o=r&&r.sceneFilter,s=this.getMap();if(!t.length||!s)return null;const a=this.F(),l=s.projViewMatrix,h=[],u=[],c=[],f=[],d=[];for(let A=0,y=t.length;A<y;A++){const n=t[A].data.node;let i=this.j(n);if(!i)continue;const o=this.h.q(n.H),s=o.debugNodes,a=o.heightOffset||0,p=o.coordOffset||nJ;this.O[n.id]&&(i=this.O[n.id],i=lZ(i));let g=o.polygonOffset||YY;nZ(g)&&(g=g()),Array.isArray(i)||(h[0]=i,i=h);for(let h=0,m=i.length;h<m;h++){if(!i[h]||!i[h].isValid||!i[h].isValid())continue;const o=i[h].properties.magic;if(i[h].properties.heightOffset===a&&i[h].properties.coordOffset[0]===p[0]&&i[h].properties.coordOffset[1]===p[1]||(this.G(i[h]),i[h].V=rm([],i[h].localTransform)),i[h].J=n,"b3dm"===o){if(i[h].getBoundingBox&&!Jq(l,i[h].getBoundingBox()))continue;const{batchIdData:t,batchIdMap:e}=i[h].geometry.properties;if(t&&e){const t=i[h].properties.node.H;this.$&&this.$[t]?yE.highlightMesh(this.m,i[h],this.$[t],this.K,e):this.$&&this.$[t]||yE.highlightMesh(this.m,i[h],null,this.K,e),yE.showOnly(this.m,i[h],this.X&&this.X[t],this.Y,e)}if(s&&s.length&&s.indexOf(i[h].J.id)<0)continue;r&&r.bloom&&i[h].properties.hlBloomMesh&&(i[h].properties.hlBloomMesh.properties.depthFunc="always",i[h].properties.hlBloomMesh.properties.polygonOffset=g,c.push(i[h].properties.hlBloomMesh)),c.push(i[h])}else"pnts"===o?f.push(i[h]):"i3dm"===o&&d.push(i[h]);i[h].properties.isLeaf=!!e[n.id],i[h].properties.selectionDepth=255-t[A].selectionDepth,i[h].properties.polygonOffset=g,e[n.id]||u.push(i[h]),this.Z(i[h]),this.W(i[h],n)}}let p=0;const g=this.P.getExcludeFilter();CI.setIncludeUniformValues(a,r),p+=this.tt(this.et,a,[o,iJ,g],i,u,c,d),p+=this.tt(this.nt,a,[o,oJ,g],i,u,c,d),this.P.forEachShader(((t,e,n)=>{const r=this.F(n);p+=this.tt(t,r,[o,e],i,u,c,d)})),this.S.setMeshes(f);const m=this.rt();return p+=this.p.render(this.it,m,this.S,i&&i.fbo),this.D={pntsMeshes:f,i3dmMeshes:d,b3dmMeshes:c},this.N.setMeshes(n),this.p.render(this.st,a,this.N,i&&i.fbo),p}prepareRender(t){this.ot(t)}ot(t){t&&t.states&&t.states.includesChanged&&(this.nt.dispose(),delete this.nt,this.et.dispose(),delete this.et),this.ct(t)}tt(t,e,n,r,i,o,s){t.filter=n.filter((t=>!!t)),e.stencilEnable=!1;const a=r&&r.fbo;let l=0;const h=[];for(let u=0;u<o.length;u++){const{isLeaf:n,selectionDepth:r}=o[u].properties;n&&255===r?(e.stencilEnable&&(this.ht(a),this.I.setMeshes(h),l+=this.p.render(t,e,this.I,a),h.length=0,e.stencilEnable=!1),h.push(o[u])):(e.stencilEnable||(this.I.setMeshes(h),l+=this.p.render(t,e,this.I,a),h.length=0,e.stencilEnable=!0),h.push(o[u])),u===o.length-1&&(e.stencilEnable&&this.ht(a),this.I.setMeshes(h),l+=this.p.render(t,e,this.I,a))}return this.I.setMeshes(o.filter((t=>t.properties.isLeaf))),this.C.setMeshes(s),l+=this.p.render(t,e,this.C,r&&r.fbo),l}ht(t){this.m.clear({stencil:255,framebuffer:t})}getCurrentB3DMMeshes(){return this.I.getMeshes()}getCurrentI3DMMeshes(){return this.C.getMeshes()}lt(t,e){return e.J.ut-t.J.ut}deleteTile(t){const e=t.node;e.ft&&(e.ft.geometry.dispose(),e.ft.dispose(),delete e.ft);const n=e.id;this.dt(n)}dt(t){const e=this.T[t]||this._[t]||this.M[t]||this.O[t]||this.v[t];this.O[t]?this.gt(t):e&&(this.bt(e),delete this.T[t],delete this._[t],delete this.M[t],delete this.v[t])}gt(t){let e=this.O[t];e=lZ(e);for(let n=0;n<e.length;n++){const{id:t}=e[n].properties;this.dt(t)}delete this.O[t]}bt(t){if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)this.bt(t[e]);else{yE.showOnly(this.m,t),yE.highlightMesh(this.m,t);const e=t.geometry.properties.url;if(e){const n=this.A[e];n&&n.refMeshes&&(n.refMeshes.delete(t.uuid),n.refMeshes.size||(n.geometry.dispose(),n.material.dispose(),delete this.A[e]))}else t.geometry.dispose(),t.material&&t.material.dispose();t.dispose()}}remove(){const t=this.h;qY(t.getRenderer().canvas,t.getMap());for(const e in this.O)this.gt(e);this.O={};for(const e in this.T)this.dt(e);this.T={};for(const e in this._)this.dt(e);this._={};for(const e in this.M)this.dt(e);this.M={};for(const e in this.v)this.dt(e);this.v={},this.et&&(this.et.dispose(),delete this.et),this.nt&&(this.nt.dispose(),delete this.nt),this.it&&(this.it.dispose(),delete this.it),this.st&&(this.st.dispose(),delete this.st),this.P.dispose(),this.picking&&this.picking.dispose()}j(t){return this.T[t.id]||this._[t.id]||this.M[t.id]||this.O[t.id]}has(t){return this.j(t)||this.v[t.id]}G(t){const e=t.properties.magic;"b3dm"===e?this.yt(t):"i3dm"===e?this.wt(t):"pnts"===e&&this.vt(t)}createPntsMesh(t,e,n,r){if(this._[e]){const t=this._[e];return console.warn(`pnts mesh with id(${e}) was already created.`),r(null,{id:e,mesh:t}),t}const{pnts:i,featureTable:o,rootIdx:s,compressed_int16_params:a}=t,l=o.POINTS_LENGTH;i.BATCH_ID||(i.BATCH_ID=new Uint8Array(l),i.BATCH_ID.fill(0));const h=new bx(i,null,l,{static:!0,primitive:"points",positionAttribute:"POSITION",pickingIdAttribute:"BATCH_ID"});h.generateBuffers(this.m);const u={};i.POSITION?u.HAS_POSITION=1:i.POSITION_QUANTIZED&&(u.HAS_POSITION_QUANTIZED=1),i.RGB?u.HAS_RGB=1:i.RGBA?u.HAS_RGBA=1:i.RGB565&&(u.HAS_RGB565=1),(i.NORMAL||i.NORMAL_OCT16P)&&(u.HAS_NORMAL=1,i.NORMAL_OCT16P&&(u.HAS_NORMAL_OCT16P=1)),this.Tt(u,a),t.featureTable.CONSTANT_RGBA&&(t.featureTable.CONSTANT_RGBA=t.featureTable.CONSTANT_RGBA.map((t=>t/255)));const{rtcCenter:c,rtcCoord:f,projCenter:d}=t,p=this.h.q(s),g=new h_(h);g.properties.magic="pnts",g.properties.id=e,g.properties.node=n,g.properties.count=l,g.properties.batchTable=t.batchTable,g.properties.batchTableBin=t.batchTableBin,g.properties.serviceIndex=s,g.properties.rtcCoord=f,g.properties.rtcCenter=c,g.properties.projCenter=d,g.setDefines(u),g.setFunctionUniform("pointColor",(function(){return t.featureTable.CONSTANT_RGBA?t.featureTable.CONSTANT_RGBA:p&&p.pointColor||[1,1,1,1]}));const m=this.getMap();let A=null,y=null;g.setFunctionUniform("pointSize",(function(){if(!p)return 2;if(kY(p.pointSize)){const t=JSON.stringify(p.pointSize);return t!==A&&(y=LY(p.pointSize),A=t),y(m.getZoom())}return p.pointSize||2}));let v=null,x=null;return g.setFunctionUniform("pointOpacity",(function(){if(!p)return 1;if(kY(p.pointOpacity)){const t=JSON.stringify(p.pointOpacity);return t!==v&&(x=LY(p.pointOpacity),v=t),x(m.getZoom())}return p.pointOpacity||1})),this._t(g,a),this.vt(g),g.V=rm([],g.localTransform),this._[e]=g,r(null,{id:e,mesh:[g]}),[g]}vt(t){const e=t.localTransform||[],{rtcCoord:n,node:r,projCenter:i}=t.properties;this.Mt(e,n,i,r.H),t.setLocalTransform(e)}createI3DMMesh(t,e,n,r){if(this.M[e]){const t=this.M[e];return console.warn(`i3dm mesh with id(${e}) was already created.`),this.v[e]||r(null,{id:e,mesh:t}),t}const i=this.h.q(n.H),o=this.Ot(n.At),{i3dm:s,featureTable:a,gltf:l,batchTable:h,batchTableBin:u,count:c}=t,f=a.INSTANCES_LENGTH,{rtcCenter:d,rtcCoord:p,projCenter:g}=t,m=this.xt(pJ,n,d,p);sY(m,eJ,m);const A=Am(gJ,m);dy(A,A);const y=mm(mJ,m),v=fm(AJ,y),x=this.It(yJ,g,n),_=this.St(_J),b=this.Et(bJ,p),w=tA(wJ,b,_),T=fm(TJ,w),{POSITION:M,NORMAL_UP:C,NORMAL_RIGHT:S,SCALE:I,SCALE_NON_UNIFORM:P}=s,E={instance_vectorA:new Float32Array(4*f),instance_vectorB:new Float32Array(4*f),instance_vectorC:new Float32Array(4*f),aPickingId:new Uint16Array(f)};for(let q=0;q<f;q++)E.aPickingId[q]=q;const O=new Float32Array(3),R=new Float32Array(3),k=[],L=new Float32Array(1),D=new Float32Array(3),N=[],F=[],z=[],B=[];!function(t,e){let{byteOffset:n,byteStride:r,count:i}=t;const{componentType:o,itemSize:s}=t,a=t.array.buffer,l=o?gg.getTypedArrayCtor(o):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,i=i||t.array.length/s,(!r||r===s*l.BYTES_PER_ELEMENT)&&n%l.BYTES_PER_ELEMENT==0){const t=new l(a,n,i*s);for(let r=0;r<i*s;r+=s)e(new l(t.buffer,n+r*l.BYTES_PER_ELEMENT,s),r/s);return}const h=new Uint8Array(s*l.BYTES_PER_ELEMENT);r||(r=s*l.BYTES_PER_ELEMENT);for(let u=0;u<i;u++){const t=new Uint8Array(a,r*u+n,s*l.BYTES_PER_ELEMENT);h.set(t),e(new l(h.buffer),u),t.set(h)}}(M,((t,e)=>{C?(CZ(R,S,e),CZ(O,C,e),qm(k,R,O),Gm(k,k),aZ(N,R,0),aZ(N,O,1),aZ(N,k,2),qA(F,N),dy(F,F),BA(F,A,F)):FA(F),I?(CZ(L,I,e),Lm(z,L[0],L[0],L[0])):P?(CZ(D,P,e),Lm(z,...D)):Lm(z,1,1,1),ym(B,F,t,z),SZ(E.instance_vectorA,e,B,0),SZ(E.instance_vectorB,e,B,1),SZ(E.instance_vectorC,e,B,2)}));const H={};for(const q in E)H[q]={buffer:this.m.buffer({dimension:E[q].length/f,data:E[q]}),divisor:1};const j=i.shader||"pbr";let U=0,V=!0;const G=[],W=[];return yZ(l,((t,r,i,s)=>{const l=this.Ct(t,r,i,s,n,!0,j,W),{geometry:A,material:y}=l;y&&!y.isReady()&&(V=!1,U++);const _=new u_(H,f,A,y);l.refMeshes||(l.refMeshes=new Set,l.refMeshes.add(_.uuid)),_.properties.magic="i3dm",_.properties.id=e,_.properties.count=c,_.properties.batchTable=h,_.properties.batchTableBin=u,_.properties.serviceIndex=n.H,_.properties.rtcCoord=p,_.properties.rtcCenter=d,_.properties.projCenter=g,_.properties.node=n;const b=this.Nt(t,A,y,n.H,s);t.compressed_int16_params&&this._t(_,t.compressed_int16_params),this.kt(_,t.attributes);const w=im([]);if(t.matrices&&t.matrices.length)for(let e=0;e<t.matrices.length;e++)am(w,w,t.matrices[e]);am(w,o,w),am(w,T,w),a.EAST_NORTH_UP||C?am(w,v,w):am(w,m,w),_.setPositionMatrix(w),this.wt(_,x),_.setDefines(b),_.properties.polygonOffset={offset:0,factor:0},G.push(_),delete t.attributes,_.V=rm([],_.localTransform)})),OJ(W),V?(this.M[e]=G,r(null,{id:e,mesh:G})):(this.v[e]={meshes:G,count:U},G.Rt=r),G}wt(t,e){const{rtcCoord:n,node:r,projCenter:i}=t.properties;e||(e=this.It(yJ,i,r));const o=this.h.q(r.H),s=t.localTransform||[];if(o.coordOffset){am(s,this.Lt(pJ,r.H,n),e)}else rm(s,e);t.setLocalTransform(s),t.properties.heightOffset=o.heightOffset||0,t.properties.coordOffset=o.coordOffset&&o.coordOffset.slice(0)||nJ}It(t,e,n){fm(t,this.St(_J));const r=this.Pt(fJ,e,n.H);return am(t,cm(vJ,r),t),t}createB3DMMesh(t,e,n,r){if(t.gltf&&(t.gltf.transferables=null),this.T[e]||this.v[e]){const t=this.T[e];return console.warn(`mesh with id(${e}) was already created.`),this.v[e]||r(null,{id:e,mesh:t}),t}let i;if(n.maxExtent){const t=new f(n.maxExtent).convertTo((t=>this._pointToPrj(t)));i=[t.xmin,t.ymin,t.xmax,t.ymax]}const o=t.gltf,{projCenter:s}=o.extensions.MAPTALKS_RTC,{rtcCoord:a,center:l}=o.extensions.CESIUM_RTC,h=o.asset.sharePosition,u=this.Ot(n.At),c=this.Bt(yJ,h,a,l,s,n),d=this.h.q(n.H);let p=d.shader||"pbr";if(d.unlit)p="phong";else if(o.materials)for(let f=0;f<o.materials.length;f++)if(o.materials[f]&&o.materials[f].extensions&&o.materials[f].extensions.KHR_materials_unlit){p="phong";break}const g=[],m=[];let A=0,y=!0;return yZ(o,((r,o,f,v)=>{const x=this.Ct(r,o,f,v,n,!1,p,g),{geometry:_,material:b}=x;b&&!b.isReady()&&(y=!1,A++);const w=new h_(_,b);x.refMeshes||(x.refMeshes=new Set,x.refMeshes.add(w.uuid)),w.properties.magic="b3dm",w.properties.id=e,w.properties.node=n,t.batchTable&&(w.properties.batchTable=t.batchTable,w.properties.batchTableBin=t.batchTableBin),w.properties.count=t.featureTable&&t.featureTable.BATCH_LENGTH||0,w.properties.serviceIndex=n.H;const T=this.Nt(r,_,b,n.H,v);w.setDefines(T);const M=r.compressUniforms;if(M)for(const t in M)w.setUniform(t,M[t]);r.compressed_int16_params&&this._t(w,r.compressed_int16_params),this.kt(w,r.attributes),i&&(T.USE_MAX_EXTENT=1,w.setUniform("maxPrjExtent",i)),w.hasFunctionUniform("polygonOpacity")||w.setFunctionUniform("polygonOpacity",(function(){return function(t){return"number"==typeof t&&!isNaN(t)}(d.opacity)?d.opacity:1})),w.hasFunctionUniform("polygonFill")||w.setFunctionUniform("polygonFill",(function(){return function(t,e){if(!Array.isArray(e)){const t=e;e=cZ[t]=cZ[t]||$X(e).array().map((t=>t/255))}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}([],d.polygonFill||JY)})),w.material.hasFunctionUniform("hsv")||w.material.setFunctionUniform("hsv",(function(){return d.hsv||QY}));const C=im([]);if(h&&r.matrices&&r.matrices.length)for(let t=0;t<r.matrices.length;t++)am(C,C,r.matrices[t]);h&&am(C,u,C),w.properties.node=n,w.properties.projCenter=s,w.properties.nodeMatrix=C,w.properties.isSharedPosition=h,w.properties.rtcCoord=a,w.properties.rtcCenter=l,this.yt(w,c),m.push(w),delete r.attributes,w.V=rm([],w.localTransform)})),OJ(g),y?(this.T[e]=m,r(null,{id:e,mesh:m})):(this.v[e]={meshes:m,count:A},m.Rt=r),m}Ut(t){const e=this.h.Dt(t.id);if(!e||t.ft)return;let n,r,i,o;if(e.obbox)n=e.boxPosition,r=CJ,i=e.boxCenter,o=PJ;else if(e.sphereBox){const t=e.sphereBox[0],s=e.sphereBox[1];n=SJ.vertices,r=SJ.indices,i=t,o=[s,s,s]}const s=new bx({POSITION:n},r,0,{primitive:"lines",positionAttribute:"POSITION"}),a=new h_(s,new Kx({lineColor:[.8,.8,.1,1],lineOpacity:1})),l=[];ym(l,IJ,i,o),a.localTransform=l,a.V=rm([],l),a.properties.node=t,t.ft=a}Ft(t){t.ft&&(t.ft.geometry.dispose(),t.ft.dispose(),delete t.ft)}_t(t,e){e.POSITION&&t.setUniform("compressedPositionRange",e.POSITION),e.TEXCOORD_0&&t.setUniform("compressedTexcoordRange_0",e.TEXCOORD_0),e.TEXCOORD_1&&t.setUniform("compressedTexcoordRange_1",e.TEXCOORD_0),e.NORMAL&&t.setUniform("compressedNormalRange",e.NORMAL),e.TANGENT&&t.setUniform("compressedTangentRange",e.TANGENT),e.compressed_ratio&&t.setUniform("compressed_ratio",e.compressed_ratio)}yt(t,e){const{isSharedPosition:n,rtcCoord:r,rtcCenter:i,projCenter:o,nodeMatrix:s,node:a}=t.properties;e||(e=this.Bt(e||yJ,n,r,i,o,a));const l=t.localTransform||im([]);am(l,e,s);const h=this.h.q(a.H);if(h.coordOffset){am(l,this.Lt(pJ,a.H,r),l)}t.setLocalTransform(l),t.properties.heightOffset=h.heightOffset||0,t.properties.coordOffset=h.coordOffset&&h.coordOffset.slice(0)||nJ}Bt(t,e,n,r,i,o){if(e){const e=this.Et(bJ,n),i=fm(dJ,e);am(t,this.xt(pJ,o,r,n),i)}else this.Mt(t,n,i,o.H);return t}kt(t,e){if(e&&e.TEXCOORD_0&&e.TEXCOORD_0.extensions&&e.TEXCOORD_0.extensions.WEB3D_quantized_attributes){const n=e.TEXCOORD_0.extensions.WEB3D_quantized_attributes.decodeMatrix;t.setUniform("decodeMatrix",n)}}xt(t,e,n,r){const i=this.getMap(),o=this.h.q(e.H).heightOffset||0,s=e.matrix?rm(t,e.matrix):im(t);n&&sY(s,Xm(sJ,n,s),s);const a=function(t,e,n,r,i,o,s){e=km(lY,e);const a=RZ(lY,e[0]*AY,e[1]*AY,e[2]),l=gm(hY,n),h=r.ellipsoid;let u;u=0===rA(l)?Lm(uY,0,0,-6378137):zZ(uY,l),gY.x=u[0],gY.y=u[1];const c=r.project(gY,mY);cY[0]=c.x/i,cY[1]=c.y/i,cY[2]=(u[2]+s)*o;const f=aY(a,h,fY);return sY(function(t,e,n){const r=t[0],i=t[1],o=t[2],s=t[4],a=t[5],l=t[6],h=t[8],u=t[9],c=t[10],f=e[0],d=e[1],p=e[2],g=e[3],m=e[4],A=e[5],y=e[6],v=e[7],x=e[8],_=r*f+s*d+h*p,b=i*f+a*d+u*p,w=o*f+l*d+c*p,T=r*g+s*m+h*A,M=i*g+a*m+u*A,C=o*g+l*m+c*A,S=r*y+s*v+h*x,I=i*y+a*v+u*x,P=o*y+l*v+c*x;return n[0]=_,n[1]=b,n[2]=w,n[3]=0,n[4]=T,n[5]=M,n[6]=C,n[7]=0,n[8]=S,n[9]=I,n[10]=P,n[11]=0,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}(sm(dY,f),Wg(pY,n),t),cY,t),t}(s,r,s,i.getProjection(),i.getGLRes(),this.U,o),l=(Lm(h=fJ,(u=a)[12],u[13],u[14]),h);var h,u;let c=this.h.options.offset;if(nZ(c)){const t=this.h.Dt(e.id).boxCoord;c=c.call(this.h,t)}return Lm(cJ,c[0],c[1],0),Km(l,l,cJ),sY(a,l,a),a}Lt(t,e,n){const r=this.h.q(e);if(!r.coordOffset)return null;const i=this.getMap(),o=i.getGLRes();aJ.set(n[0],n[1]);const s=i.coordToPointAtRes(aJ,o,hJ),a=r.coordOffset,l=aJ.set(n[0]+a[0],n[1]+a[1]),h=i.coordToPointAtRes(l,o,uJ),u=h.x-s.x,c=h.y-s.y,f=this.U;return cm(t,Lm(cJ,u,c,(a[2]||0)*f))}createCMPTMesh(t,e,n,r){if(this.O[e]){const t=this.O[e];return console.warn(`mesh with id(${e}) was already created.`),r(null,{id:e,mesh:t}),t}const{content:i}=t,o=[];for(let s=0;s<i.length;s++){const{magic:t}=i[s],r=e+"."+s;"b3dm"===t?this.createB3DMMesh(i[s],r,n,((t,{mesh:e})=>{o.push(e)})):"i3dm"===t?this.createI3DMMesh(i[s],r,n,((t,{mesh:e})=>{o.push(e)})):"pnts"===t?this.createPntsMesh(i[s],r,n,((t,{mesh:e})=>{o.push(e)})):"cmpt"===t&&this.createCMPTMesh(i[s],r,n,((t,{mesh:e})=>{o.push(e)}))}return this.O[e]=o,r(null,{id:e,mesh:o}),o}Nt(t,e,n,r,i){const o=("phong"===(this.h.q(r).shader||"pbr")?this.et:this.nt).getGeometryDefines(e);return i.asset&&"S3M"===i.asset.generator&&this.jt(o,e),e.data.uvRegion&&(o.HAS_I3S_UVREGION=1),e.data[e.desc.normalAttribute]&&(o.VertexNormal=1),e.data[e.desc.color0Attribute]&&(o.VertexColor=1),e.data[e.desc.uv0Attribute]&&(o.TexCoord=1),e.data[e.desc.textureCoordMatrixAttribute]&&(o.HAS_TextureCoordMatrix=1),n.get("uTexture")&&(o.COMPUTE_TEXCOORD=1),n.get("uTexture2")&&(o.TexCoord2=1),"MESHOPT"===this.h.zt&&(o.MeshOPT_Compress=1),this.hasIBL()&&(o.HAS_IBL_LIGHTING=1),t.attributes&&t.attributes.TEXCOORD_0&&"WEB3D_quantized_attributes"===t.attributes.TEXCOORD_0.extensions&&(o.HAS_WEB3D_quantized_attributes_TEXCOORD=1),o.HAS_MIN_ALTITUDE=1,o.HAS_LAYER_OPACITY=1,this.Tt(o,t.compressed_int16_params),eZ(o,t.compressDefines),o}Tt(t,e){e&&Object.keys(e).length>0&&(t.HAS_COMPRESSED_INT16=1,e.POSITION&&(t.HAS_COMPRESSED_INT16_POSITION=1),e.TEXCOORD_0&&(t.HAS_COMPRESSED_INT16_TEXCOORD_0=1),e.TEXCOORD_1&&(t.HAS_COMPRESSED_INT16_TEXCOORD_1=1),e.NORMAL&&(t.HAS_COMPRESSED_INT16_NORMAL=1),e.TANGENT&&(t.HAS_COMPRESSED_INT16_TANGENT=1),e.compressed_ratio&&(t.HAS_COMPRESSED_INT16_RATIO=1))}Z(t){const e=this.h.getRenderer();e&&e.updateMaskDefines(t)}jt(t,e){e.data.aNormal&&(t.VertexNormal=1),e.data.instanceId&&(t.Instance=1),e.data.aTexCoord0&&(t.TexCoord=1),e.data.aColor&&(t.VertexColor=1),e.data.aTexCoord1&&(t.TexCoord2=1),e.data.uv2&&(t.InstanceBim=1)}Ct(t,e,n,r,i,o,s,a){let l=!1;r.asset&&"S3M"===r.asset.generator&&(l=!0,r.extensions=r.extensions||{});const h=r.url+"-"+e+"-"+n;if(this.A[h])return this.A[h];let u,c;a.push(t);const f=r.materials&&r.materials[t.material],d=r.extensions&&r.extensions.KHR_techniques_webgl,p=this.h.q(i.H);if(d&&f.extensions&&f.extensions.KHR_techniques_webgl){const e=this.qt(t,r,o,l);u=e.material,c=e.geometry,p.fillEmptyDataInMissingAttribute&&(c.desc.fillEmptyDataInMissingAttribute=!0)}else{c=this.Ht(t,o,MJ);const e=p.material;u=this.Gt(t.material,r,s,e||KY,a,p)}u&&(u.setFunctionUniform("alphaTest",(function(){const t=p.alphaTest;return tZ(t)?.1:t})),u.setFunctionUniform("environmentExposure",(()=>{const t=p.ambientLight;let e=p.environmentExposure;const n=this.getMap().getLightManager(),r=n&&n.getAmbientLight();if(t&&(!r||r.color)&&void 0===e){const n=r&&r.color?r.color[0]:.2;e=t[0]/n}return e||1}))),u&&!u.isReady()?u.Vt=i.id:u||(u=new e_({baseColorFactor:[1,1,1,1]}));const g={geometry:c,material:u};return c.properties.url=h,this.A[h]=g,g}qt(t,e,n,r){const{geometry:i,material:o}=this.P.createMesh(t,e,n,r);return{geometry:i,material:o}}Ht(t,e,n){const r=t.attributes,i="COLOR_0";let o=r._BATCHID&&r._BATCHID.array;if(o&&o.byteOffset&&(o=new o.constructor(o)),r[i]){const t=r[i].array||r[i];if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);r[i].array?(r[i].array=e,r[i].componentType=5121):r[i]=e}}const s={};for(const h in r){const t=UY(this.m,r[h],{dimension:r[h].itemSize}),e=n[h]||h;s[e]={buffer:t},r[h].quantization&&(s[e].quantization=r[h].quantization),e===n.POSITION&&(s[e].array=r[h].array,s[e].min=r[h].min,s[e].max=r[h].max)}const a=t.indices?t.indices.array?t.indices.array.slice():t.indices:null,l=new bx(s,a,0,{positionAttribute:n.POSITION,normalAttribute:n.NORMAL,uv0Attribute:n.TEXCOORD_0,uv1Attribute:n.TEXCOORD_1,color0Attribute:n.COLOR_0,tangentAttribute:n.TANGENT,pickingIdAttribute:n._BATCHID,primitive:void 0===t.mode?"triangles":jY(t.mode)});return o&&a&&(l.properties.batchIdData=o,l.properties.batchIdMap=function(t,e){if(!e)return null;const n=new Map;for(let r=0;r<e.length;r++){const i=e[r],o=t[i];let s=n.get(o);s||(s=[],n.set(o,s)),s.push(i)}return n}(o,a)),l.generateBuffers(this.m,{excludeElementsInVAO:e}),l}Mt(t,e,n,r){const i=im(t),o=this.St($Y);return this.Pt(fJ,n,r),lm(i,i,fJ),hm(i,i,o),i}Pt(t,e,n){const r=this.U;aJ.x=e[0],aJ.y=e[1];const i=this._prjToPoint(aJ);let o=this.h.options.offset;nZ(o)&&(o=o.call(this.h,aJ));const s=this.h.q(n).heightOffset||0;return Lm(t,i.x-o[0],i.y-o[1],r*e[2]+r*s),t}W(t,e){const n=this.h.Jt(xJ,e);t.localTransform=am(t.localTransform,n,t.V)}Et(t,e){const n=this.getMap();aJ.x=e[0],aJ.y=e[1];const r=n.distanceToPointAtRes(100,100,n.getGLRes(),aJ),i=this.U;return Lm(t,r.x/100,r.y/100,i),t}ct(t){if(this.nt)return;const e={x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},n=[],r=[];this.it=new U_({vert:IZ,frag:"#define SHADER_NAME PNTS\n\nprecision mediump float;\n\n\n\nvarying vec4 vColor;\n\n\n\nvoid main() {\n\n    vec2 circCoord = 2.0 * gl_PointCoord - 1.0;\n\n    if (dot(circCoord, circCoord) > 1.0) {\n\n        discard;\n\n    } else {\n\n        gl_FragColor = vColor;\n\n    }\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am(r,e.projViewMatrix,e.modelMatrix)},{name:"modelNormalMatrix",type:"function",fn:(t,e)=>Wg(n,e.modelMatrix)}],extraCommandProps:{viewport:e,blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,range:[0,1],func:"<"}}});const i={},o=[];CI.fillIncludes(i,o,t);const s=this.B();this.et=new V_({uniforms:o,defines:i,extraCommandProps:s}),this.nt=new xT.StandardShader({uniforms:o,defines:i,extraCommandProps:s}),this.st=new ub({extraCommandProps:{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}});const a=this.h;WY(a.getRenderer().canvas,this.m,a.getMap()),this.picking=new Nw(this.p,{vert:this.nt.vert,extraCommandProps:s,uniforms:this.nt.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap()),this.$t=new Nw(this.p,{vert:IZ,extraCommandProps:s,uniforms:this.it.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap())}B(){return{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},cull:{enable:!0},stencil:{enable:(t,e)=>e.stencilEnable,func:{cmp:">=",ref:(t,e)=>e.meshProperties.selectionDepth},opFront:{fail:"keep",zfail:"keep",zpass:"replace"},opBack:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:[0,1],func:(t,e)=>e.meshProperties.depthFunc||"<"},blend:{enable:!0,func:{src:1,dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:(t,e)=>e.meshProperties.polygonOffset}}}rt(t){const e=this.getMap(),n=e.getLightManager(),r=(n&&n.getDirectionalLight()||{}).direction||[1,1,-1],i=t&&t.pointOpacity||1;return{projViewMatrix:e.projViewMatrix,pointOpacity:i,lightDir:Gm(rJ,r)}}F(){const t=this.getMap(),e=this.h,n=e.getRenderer().canvas,{iblTexes:r,dfgLUT:i}=XY(n),o=ZY(t,r,i),s=this.h.getRenderer(),a=s.getMaskUniforms();o.minAltitude=e.options.altitude||0;const l=s.canvas.gl&&s.canvas.gl.wrap?e.options.opacity||0:1;return o.layerOpacity=l,eZ(o,{czm_lightDirectionEC:o.light0_viewDirection,lightSpecular:[1,1,1],viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],polygonFill:[1,1,1,1],polygonOpacity:1}),eZ(o,a),o}Gt(t,e,n,r,i,o){const s=e.materials&&e.materials[t];if(!s||!s.baseColorTexture&&!s.pbrMetallicRoughness)return null;const a=eZ({},r);if(s.baseColorTexture){const t=e.textures[s.baseColorTexture.index];let n;t&&!t.image.color&&(n=this.Kt(t,i)),a.baseColorFactor=t&&t.image.color||s.baseColorFactor||[1,1,1,1],n&&(a.baseColorTexture=n)}else{if(s.normalTexture){const t=this.Kt(e.textures[s.normalTexture.index],i);if(t){const e=s.normalTexture.scale||1;a.normalTexture=t,a.normalMapFactor=e}}if(s.occlusionTexture){const t=this.Kt(e.textures[s.occlusionTexture.index],i);if(t){const e=s.occlusionTexture.strength||1;a.occlusionTexture=t,a.occlusionFactor=e}}if(s.emissiveTexture){const t=this.Kt(e.textures[s.emissiveTexture.index],i);t&&(a.emissiveTexture=t)}s.emissiveFactor&&(a.emissiveFactor=s.emissiveFactor);const t=s.pbrMetallicRoughness;if(t){if(t.baseColorFactor&&(a.baseColorFactor=t.baseColorFactor),t.baseColorTexture&&void 0!==t.baseColorTexture.index){const n=e.textures[t.baseColorTexture.index];if(n&&n.image&&n.image.color)a.baseColorFactor=a.baseColorFactor?pA(a.baseColorFactor,a.baseColorFactor,n.image.color):n.image.color;else{const t=this.Kt(n,i);t&&(a.baseColorTexture=t,a.baseColorTexture.getREGLTexture(this.m))}}if(tZ(t.metallicFactor)||(a.metallicFactor=t.metallicFactor),tZ(t.roughnessFactor)||(a.roughnessFactor=t.roughnessFactor),s.metallicRoughnessTexture){const t=this.Kt(e.textures[s.metallicRoughnessTexture.index],i);t&&(a.metallicRoughnessTexture=t)}}}if(s.s3mMaterial)return new Kx(a);if(o.unlit||s.extensions&&s.extensions.KHR_materials_unlit){a.ambientColor=[1,1,1],a.light0_diffuse=[0,0,0,0],a.lightSpecular=[0,0,0];const t=new e_(a);return t.unlit=void 0===o.unlit||!!o.unlit,t}let l=new xT.StandardMaterial(a);"phong"===n&&(l=e_.convertFrom(l));const h=s.pbrMetallicRoughness,u=h&&h.baseColorTexture&&h.baseColorTexture.extensions;return u&&u.KHR_texture_transform&&(l.set("khr_offset",u.KHR_texture_transform.offset||[0,0]),l.set("khr_rotation",u.KHR_texture_transform.rotation||0),l.set("khr_scale",u.KHR_texture_transform.scale||[1,1])),l.doubleSided=!(!o.doubleSided&&!s.doubleSided),l.once("complete",this.R),l}Kt(t,e){if(!t)return null;const n={type:t.type?BY(t.type):"uint8",format:t.format?HY(t.format):"rgba",flipY:!!t.flipY},r=t.image;if(e.push(r),r.array?n.data=r.array:r.mipmap&&(n.mipmap=r.mipmap),!n.data&&!n.mipmap)return null;if(n.width=r.width,n.height=r.height,n.mipmap&&(n.width<4||n.height<4))return null;const i=t.sampler||t.texture&&t.texture.sampler;return i&&(i.magFilter&&(n.mag=NY(i.magFilter)),i.minFilter&&(n.min=FY(i.minFilter)),i.wrapS&&(n.wrapS=zY(i.wrapS)),i.wrapT&&(n.wrapT=zY(i.wrapT))),new O_(n,this.k)}L({target:t}){const e=t.Vt,n=this.v[e];if(n.count--,!n.count){const t=n.meshes;this.T[e]=t,delete this.v[e];const r=t.Rt;delete t.Rt,r(null,{mesh:n.meshes,id:e})}}St(t){const e=1/this.getMap().getGLRes(),n=this.U;return t[0]=t[1]=e,t[2]=n,t}Xt(t){return this.h.Xt(t)}_pointToPrj(t){const e=this.getMap();return e.getGLZoom?e._pointToPrj(t,e.getGLZoom()):e._pointToPrjAtRes(t,e.getGLRes())}_prjToPoint(t){const e=this.getMap();return e.getGLZoom?e._prjToPoint(t,e.getGLZoom()):e._prjToPointAtRes(t,e.getGLRes(),lJ)}Ot(t){return"Y"===t?VY:"X"===t?GY:tJ}pick(t,e,n=3){const r=this.h;if(!r||!r.options.picking)return[];if(!this.pickingFBO||!this.picking)return[];const i=[],o=this.F(),s=this.Yt(this.picking,o,this.I,t,e,n);s&&i.push(s);const a=this.Yt(this.picking,o,this.C,t,e,n);a&&i.push(a);const l=this.rt(),h=this.Yt(this.$t,l,this.S,t,e,n);return h&&i.push(h),i}Yt(t,e,n,r,i,o){if(!n.getMeshes().length)return null;const s=this.h,a=this.getMap();t.render(n.getMeshes().filter((t=>!t.bloom)),e,!0);let l={};t.getRenderedMeshes().length&&(l=t.pick(r,i,o,e,{viewMatrix:a.viewMatrix,projMatrix:a.projMatrix,returnPoint:s.options.pickingPoint}));const{meshId:h,pickingId:u,point:c,coordinate:f}=l,d=(0===h||h)&&t.getMeshAt(h);if(!d||!d.geometry)return null;const p=d.properties;c&&c.length&&(c[0]=Math.round(1e5*c[0])/1e5,c[1]=Math.round(1e5*c[1])/1e5,c[2]=Math.round(1e5*c[2])/1e5);const g={batchId:u},m=s.options.services,A=m&&m[d.properties.serviceIndex];if(A&&A.debug&&(g.debugInfo=p),p&&p.batchTable){const{batchTable:t,batchTableBin:e,count:n}=p,r=u;for(const i in t)void 0!==t[i].byteOffset?g[i]=XZ(t[i],e,n,r):g[i]=t[i][r]}return{service:d.properties.serviceIndex,data:g,point:c,coordinate:f}}highlight(t){this.$=t;const e=this.h.getRenderer();this.K=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelAllHighlight(){this.$=null;const t=this.h.getRenderer();this.K=t.getFrameTimestamp(),t.setToRedraw(!0)}showOnly(t){this.X=t;const e=this.h.getRenderer();this.Y=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelShowOnly(){this.X=null;const t=this.h.getRenderer();this.Y=t.getFrameTimestamp(),t.setToRedraw(!0)}Zt(){if(!this.D)return[];const t={},e=[];for(const n in this.D){const r=this.D[n];if(r)for(let n=0;n<r.length;n++){const i=r[n],o=i&&i.geometry;if(!i||!o)continue;const s=i.properties.serviceIndex;t[s]||(t[s]=new Set);const a=o.properties.batchIdData;if(a)for(let n=0;n<a.length;n++)t[s].has(a[n])||(e.push({id:a[n],service:s}),t[s].add(a[n]))}}return e}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}};function OJ(t){for(let e=0;e<t.length;e++)t[e]&&(t[e].array&&(t[e].array=null),t[e].mipmap&&(t[e].mipmap=null),t[e].indices&&(t[e].indices=null))}const RJ=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},kJ=RJ(),LJ=kJ.gl_trans__coders=kJ.gl_trans__coders||{};function DJ(t,e){if(e)for(let n=0;n<e.length;n++)t[e[n].id||e[n].index]=e[n]}LJ.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=kJ.gl_trans__coders=kJ.gl_trans__coders||{};let o=`${r}\n    const _____getGlobal = ${RJ.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const s in i)"inject"!==s&&"getTranscoder"!==s&&"registerTranscoder"!==s&&(o+='tran_____scoders["'+s+'"] ='+i[s].toString()+"\n;");return o+="\n"+e.substring(r.length),o},LJ.registerTranscoder=function(t,e){LJ[t]=e},LJ.getTranscoder=function(t){return LJ[t]};const NJ=[];let FJ=class{constructor(t,e,n,r,i){this.h=r,this.Wt=t,this.H=e,this.Qt=i,this.te=n.version,t.indexOf("i3s:tileset:")<0?(this.te<=1.6?this.ee="root":this.ee=0,n.version=this.te):(this.ee=t.substring(12),this.te>1.6&&(this.ee=parseInt(this.ee))),this.Wt=t,this.ne=n}load(){const t=this.ne,e=t.layerScene.baseUrl;if(this.te<=1.6)return t[this.ee]&&t[this.ee].lodSelection?(this.re=t[this.ee],this.ie()):new Promise((n=>{let r=e+"/nodes/"+this.ee;t.layerScene.eslpk&&(r+="/3dNodeIndexDocument.json"),this.Qt(this.H,r,(()=>{this.re=t[this.ee],n(this.ie())}))}));if(this.te>=1.7){if(t[this.ee])return this.re=t[this.ee],this.ie();const n=Math.floor(this.ee/t.nodesPerPage);return new Promise((r=>{let i=e+"/nodepages/"+n;t.layerScene.eslpk&&(i+=".json"),this.Qt(this.H,i,(()=>{this.re=t[this.ee],r(this.ie())}))}))}return null}getTileset(){return this.se}getChildrenURL(){return this.oe}ie(){const t=this.ne,e=t.layerScene.baseUrl,n=this.re.children,r=[],i={};if(n)for(let o=0;o<n.length;o++)if(this.te<=1.6){const s=n[o].id;if(t[s])continue;const a=s;i[a]||(i[a]=new Promise((n=>{let r=e+"/nodes/"+a;t.layerScene.eslpk&&(r+="/3dNodeIndexDocument.json"),this.Qt(this.H,r,(()=>{n()}))})),r.push(i[a]))}else{const s=n[o];if(t[s])continue;const a=Math.floor(s/t.nodesPerPage);i[a]||(i[a]=new Promise((n=>{let r=e+"/nodepages/"+a;t.layerScene.eslpk&&(r+=".json"),this.Qt(this.H,r,(()=>{n()}))})),r.push(i[a]))}return r.length?Promise.all(r).then((()=>this.ae())):this.ae()}ae(){return Promise.resolve(this.ce())}he(t){DJ(this.ne,t)}ce(){return{asset:{i3s:!0,version:"1.0",gltfUpAxis:"Z"},geometricError:Number.MAX_VALUE,root:this.le(this.re,!0)}}le(t){const e=this.h.getRenderer(),n=this.ne.projection,r=!n||n&&4326===n.wkid,i=this.te,o=this.ne,s=t,a=s.obb,l=s.mbs,h={};let u;if(l)u=Lm([],l[0],l[1],l[2]),r||(u=e.ue(u,u)),u=zJ([],u[0],u[1],u[2]),h.sphere=[...u,l[3]];else if(a){u=Lm([],a.center[0],a.center[1],a.center[2]),r||(u=e.ue(u,u)),u=zJ([],u[0],u[1],u[2]);const t=function(t,e,n){const r=Qg([],n);return r[0]=r[0]*e[0],r[1]=r[1]*e[0],r[2]=r[2]*e[0],r[3]=r[3]*e[1],r[4]=r[4]*e[1],r[5]=r[5]*e[1],r[6]=r[6]*e[2],r[7]=r[7]*e[2],r[8]=r[8]*e[2],[...t,...r]}(u,a.halfSize,a.quaternion),n=t[3]+t[6]+t[9],i=t[4]+t[7]+t[10],o=t[5]+t[8]+t[11];Lm(NJ,n,i,o);const s=rA(NJ);h.sphere=[...u,s]}let c=1/0,f=0;if(s.mbs?f=s.mbs[3]:s.obb&&(f=Math.max(Math.max(s.obb.halfSize[0],s.obb.halfSize[1]),s.obb.halfSize[2])),void 0!==s.lodThreshold)"maxScreenThresholdSQ"===o.lodSelectionMetricType?c=f/(Math.sqrt(s.lodThreshold)/(.25*Math.PI)):console.error("Unsupported lodSelectionMetricType in Layer");else if(void 0!==s.lodSelection)for(let y=0;y<s.lodSelection.length;y++)"maxScreenThreshold"===s.lodSelection[y].metricType&&(c=f/s.lodSelection[y].maxError);(c===1/0||isNaN(c))&&(c=1e5);const d=16*c,p=im([]),g=s.children;let m;if(g){m=[];const t=this.ne;for(let e=0;e<g.length;e++){const n=i<=1.6?g[e].id:g[e];if(!t[n]){m=null;break}m.push(this.le(t[n]))}}const A={refine:"REPLACE",boundingVolume:h,transform:p,geometricError:d};return i<=1.6?t.lodSelection?t.geometryData&&(A.content={uri:"i3s:mesh:"+(t.id||t.index)}):A.content={uri:"i3s:tileset:"+(t.id||t.index)}:g&&g.length&&!m?A.content={uri:"i3s:tileset:"+(t.id||t.index)}:s.mesh&&(A.content={uri:"i3s:mesh:"+(t.id||t.index)}),m&&m.length&&(A.children=m),A}getJSON(){return this.re}};function zJ(t,e,n,r){return RZ(t,iZ(e),iZ(n),r)}const BJ=!!LJ.ktx2,HJ=im([]),jJ=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(Ap){}return!1})();function UJ(t){return t.indexOf("i3s:mesh")>=0}function VJ(t,e,n,r,i){const o=e.layerScene.eslpk,s=function(t,e){const n=e.substring(9);return t>=1.7?parseInt(n):n}(e.version,t),a=e[s],l=e.layerScene.baseUrl,h=[];let u=!1;const c=HJ;let f,d;if(e.version<=1.6){if(!a.geometryData)return null;const t=a.geometryData.length;if(!t)return null;let n=l+`/nodes/${a.id}/`+a.geometryData[t-1].href;o&&(n+=".bin");const r={geometry:{url:n,info:e.layerScene.store.defaultGeometrySchema}};let i=a.textureData&&a.textureData[0]&&a.textureData[0].href;if(i){const t=e.layerScene.store.textureEncoding[0];let n;n="image/jpeg"===t?"jpg":"png",o&&(i+="."+n);const s={pbrMetallicRoughness:{baseColorTexture:{url:l+`/nodes/${a.id}/`+i,factor:1,format:n,mimeType:t},metallicFactor:0}};r.material=s}h.push(r)}else{f=a.mesh.geometry,d=a.mesh.material;const t=e.layerScene.geometryDefinitions,s=(e.layerScene.store||{}).textureEncoding,c=t[f.definition],{geometryBuffers:p}=c;u=r&&2===p.length;const g=LJ.draco&&u?p[1]:p[0],m=LJ.draco&&u?1:0;let A=l+`/nodes/${f.resource}/geometries/`+m;o&&(A+=".bin");const y={geometry:{url:A,info:g}};if(i&&jJ&&u&&!LJ.draco)throw new Error("Must import @maptalks/transcoder.draco to load i3s draco compressed geometry");const v=e.layerScene.materialDefinitions,x=e.layerScene.textureSetDefinitions;let _,b=0;d&&(b=v[d.definition]),_=v?function(t,e,n,r,i,o,s){const a=JSON.parse(JSON.stringify(e));return GJ(t,a,n,r,i,o,s),a}(s,b,x,l,d.resource,n,e.layerScene.eslpk):{pbrMetallicRoughness:{metallicFactor:0}},y.material=_,h.push(y)}return{dracoCompression:u,meshes:h,nodeIndex:s,center:a.obb&&a.obb.center||a.mbs&&[a.mbs[0],a.mbs[1],a.mbs[2]],transform:c}}function GJ(t,e,n,r,i,o,s){for(const a in e)if(e[a]&&e[a].textureSetDefinitionId>=0){const l=n[e[a].textureSetDefinitionId],h="images/"+l.formats[0].format,u=qJ(l.formats,o,t),c={url:r+`/nodes/${i}/textures/${u.name}`,factor:void 0===e[a].factor?1:e[a].factor,format:u.format,mimeType:h};if(s){let t="";switch(u.format){case"dds":t="bin.dds";break;case"jpg":case"png":t=u.format}c.url+="."+t}e[a]=c}else rZ(e[a])&&GJ(t,e[a],n,r,i,o,s)}const WJ={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"jpg","image/vnd-ms.dds":"dds","image/ktx":"jpg"};function qJ(t,e,n){if(n&&n.length){const e=n[n.length-1],r=WJ[e];if(r){for(let n=0,i=t.length;n<i;n++)if(t[n].format===r)return t[n]}else console.error("i3s not find texture format type from:",WJ,"current textureEncoding:",e)}for(let r=0;r<=t.length;r++){const n=t[r].format;if("dds"===n&&e.hasExtension("WEBGL_compressed_texture_s3tc"))return t[r];if("jpg"===n||"png"===n)return t[r];if("ktx2"===n&&BJ)return t[r]}return null}const XJ=new n(0,0),ZJ=new n(0,0),YJ=new Set,JJ=[],QJ=new class{constructor(t,e){this.max=t,this.currentSize=0,this.data=new Map,this.onRemove=e}reset(t){if(this.data){const e=this.data.keys();for(const n of e){const e=this.data.get(n);t&&t!==e.renderer||this.fe(n,e)}}return t||(this.data=new Map,this.currentSize=0),this}clear(t){this.reset(t)}add(t,e){if(!e)return this;if(e.node&&e.node.memorySize&&(this.currentSize+=e.node.memorySize),this.has(t)){const n=this.data.get(t);n&&n.node&&n.node.memorySize&&(this.currentSize-=n.node.memorySize),this.data.delete(t),this.data.set(t,e)}else this.data.set(t,e);return this}shrink(){if(this.currentSize>this.max){let t=!1;const e=this.data.keys();let n=e.next();for(;this.currentSize>this.max&&void 0!==n.value;){!t&&this.data.get(n.value).current&&(t=!0,console.warn(`current maxGPUMemory(${this.max/1024/1024}) for Geo3DTilesLayer is not enough, one or more current tiles will be discarded.`));const r=this.getAndRemove(n.value);r&&this.onRemove(r),n=e.next()}}}has(t){return this.data.has(t)}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const r of n)t[e++]=r;return t}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),e}get(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),this.data.set(t,e),e}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.fe(t,e),this}fe(t,e){e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),this.onRemove(e)}setMaxSize(t){return this.max=t,this.shrink(),this}getMemorySize(){let t=0;const e=this.data.values();for(const n of e){const e=n&&n.node;e&&e.memorySize&&(t+=e.memorySize)}return t}markAll(t,e){const n=this.data.values();for(const r of n)t&&r.renderer!==t||(r.current=e)}}(1024*(I.mobile?32:1024)*1024,(t=>{const e=t.renderer;delete t.renderer,e.deleteTile(t)}));let KJ=0,$J=class extends(jI(r.CanvasRenderer)){constructor(t){super(t);const e=1024*t.options.maxGPUMemory*1024;e>QJ.max&&QJ.setMaxSize(e),this.tileCache=QJ,KJ++,this.tilesLoading={},this.de={},this.me=[],this.Qt=(...t)=>this.pe.call(this,...t)}getAnalysisMeshes(){if(!this.painter)return JJ;const t=this.painter.getPaintedMeshes();if(!t)return JJ;const e=[],{b3dmMeshes:n,pntsMeshes:r,i3dmMeshes:i}=t;return n.length&&uZ(e,n.filter((t=>!(!t||!t.geometry)))),r.length&&uZ(e,r.filter((t=>!(!t||!t.geometry)))),i.length&&uZ(e,i.filter((t=>!(!t||!t.geometry)))),e}needToRedraw(){return!!this.getMap().isInteracting()||!!this.me.length||super.needToRedraw()}getFrameTimestamp(){return this.ge}drawOnInteracting(t,e,n){this.draw(e,n)}draw(t,e){this.ge=t;const n=this.prepareCanvas();if(n&&!n.intersects(this.canvasExtent2D))return void this.completeRender();const{root:r,tiles:i}=this.layer.getTiles(),o=i.length;if(!i||!o)return void this.completeRender();this.painter.prepareRender(e),this.be(),this.ye(e);const{selectedTiles:s,leaves:a,requests:l}=this.we(r,i);l.length&&this.loadTiles(l),this.ve(s,a,e),this.Te(),l.length||this.completeRender()}we(t,e){let n=[];this._e();let r=0;const i=this.Me(),o={};let s=!1,a=!1;for(let u=0;u<e.length;u++){const t=e[u],i=t.node;if(o[i.id])continue;o[i.id]=1;let l=!1;const h=this.getCachedTile(i.id);(this.Oe(i.id)?(r++,l=a=!0,this.tilesLoading[i.id].current=!0):h?(this.getTileOpacity(h)<1&&(l=a=!0),s=!0,t.selected=!0,t.data=h):this.painter.has(i)||(l=a=!0,n.push(i)),l)&&((this.Ae(t)||this.xe(t).length)&&(s=!0))}let l=[],h={};if(s&&({selectedTiles:l,leaves:h}=this.Ie(t)),n.length>1&&(n.sort(tQ),i)){const t=i-r;n=t>0?n.slice(0,t):[]}return{loading:a,requests:n,selectedTiles:l,leaves:h}}Ie(t){const e=[],n={};let r;const i=[t],o=[];for(;i.length>0||o.length>0;){if(o.length>0){const t=o[o.length-1];if(t.Se===i.length){o.pop(),t===r&&(t.leave=!0,n[t.node.id]=1),e.push(t);continue}}const t=i.pop(),s=t.children;if(t.selected)if("add"===t.node.refine)n[t.node.id]=1,t.selectionDepth=o.length,e.push(t);else{if(t.selectionDepth=o.length,r=t,0===s.length){t.leave=!0,n[t.node.id]=1,e.push(t);continue}o.push(t),t.Se=i.length}for(let e=0;e<s.length;e++)i.push(s[e])}return{selectedTiles:e,leaves:n}}Ae(t){if(!t.parent)return null;let e=t.parent;for(;e&&e.level>=0;){const t=e.node.id;if(this.tileCache.has(t))return e.selected=!0,e.data=this.tileCache.get(t),e;e=e.parent}return null}xe(t){const e=[];if(!t.node.children||!t.node.children.length)return e;const n=t.Ee+1,r=[t.node];for(;r.length>0;){const i=r.pop().children;for(let o=0,s=i.length;o<s;o++){if((!i[o].content||!i[o].content.url)&&i[o].children&&i[o].children.length){r.push(i[o]);continue}const s=i[o].id;if(this.tileCache.has(s)){const n=this.layer.Ce(i[o],t);n.selected=!0,n.data=this.tileCache.get(s),t.children.push(n),e.push(n)}else i[o].Ee<=n&&r.push(i[o])}}return e}ve(t,e,n){this.tileCache.markAll(this,!1);const r=[];for(let a=0,l=t.length;a<l;a++){const e=t[a].data;e.current=!0,e.renderer=this,this.tileCache.add(t[a].node.id,e);const n=e.node,i=this.layer.q(n.H);n.ft&&i.debug&&!Array.isArray(i.debug)&&r.push(n.ft)}const i=this.layer.options.services;for(let a=0;a<i.length;a++){const t=i[a],e=Array.isArray(t.debug)&&t.debug;if(e)for(const n of e){const t=this.layer.Dt(n),e=t&&t.node;e&&e.ft&&r.push(e.ft)}}const o={tiles:t,leaves:e};this.onDrawTileStart(o);const s=this.painter.paint(t,e,r,n);this.layer.fire("drawtiles",{count:s}),this.onDrawTileEnd(o),s&&this.layer.fire("canvasisdirty",{renderCount:s}),this.tileCache.shrink()}onDrawTileStart(){}onDrawTileEnd(){}loadTiles(t){for(let e=0,n=t.length;e<n;e++){const n=t[e];this.tilesLoading[n.id]={current:!0,node:n},this.loadTile(n)}}loadTile(t){let e=t.content.url;if(hZ(e)){const n=function(t){const e=t.indexOf("base64,"),n=t.substring(e+7),r=window.atob(n),i=r.length,o=new Uint8Array(i);for(let s=0;s<i;s++)o[s]=r.charCodeAt(s);return o.buffer}(e);return this.Ne(e,n,t),null}if(e.indexOf("i3s:tileset")>=0){const n=t.H,r=this.ke[n];return new FJ(e,n,r,this.layer,this.Qt).load().then((n=>{this.onTilesetLoad(n,t,e)}))}return t&&fZ(e)&&!UJ(e)&&(e=t.baseUrl+e),this.Ne(e,null,t),null}Ne(t,e,n){let r=this.Re;r||(r=sx.getSupportedFormats(this.gl.gl||this.gl),this.Re=r);const i=this.layer.q(n.H);i.isSuperMapiServer&&(t=function(t,e){const n=t.substring(e.length).split("/"),r=[];for(let i=0;i<n.length;i++)r.push(encodeURIComponent(n[i]));return e+r.join("/")}(t,n.baseUrl));const o={url:this.layer.getTileUrl(t,this.layer.Le[n.H]),arraybuffer:e,rootIdx:n.H,upAxis:n.At,transform:n.matrix,supportedFormats:r};if(UJ(t)){const e=this.ke[n.H];if(o.projection=e.projection,o.i3sInfo=VJ(t,e,this.regl,this.layer.options.enableI3SCompressedGeometry,this.layer.options.forceI3SCompressedGeometry),!o.i3sInfo)return void this.onTileError({status:404},n,t)}o.service=eZ({},i),i.offset&&delete o.service.offset,o.referrer=window&&window.location.href,this.workerConn.loadTile(this.layer.getId(),o,((e,r)=>{if(e)return void this.onTileError(e,n,t);const{magic:i}=r;"b3dm"===i||"pnts"===i||"i3dm"===i||"cmpt"===i||"gltf"===i?this.me.push({data:r,tile:n}):this.onTilesetLoad(r,n,t)}))}Ut(t){this.painter&&this.painter.Ut(t)}Ft(t){this.painter&&this.painter.Ft(t)}ye(){const t=this.getMap(),e=this.layer.options.meshLimitPerFrame;let n=0;for(;this.me.length&&(n<e||!t.isInteracting());){const{data:t,tile:e}=this.me.shift(),{magic:r}=t;"b3dm"===r||"gltf"===r?this.painter.createB3DMMesh(t,e.id,e,((n,{mesh:r})=>{this.Pe(t,e,n,r)})):"pnts"===r?this.painter.createPntsMesh(t,e.id,e,((n,{mesh:r})=>{this.Pe(t,e,n,r)})):"i3dm"===r?this.painter.createI3DMMesh(t,e.id,e,((n,{mesh:r})=>{this.Pe(t,e,n,r)})):"cmpt"===r&&this.painter.createCMPTMesh(t,e.id,e,((n,{mesh:r})=>{this.Pe(t,e,n,r)})),n++}}Pe(t,e,n,r){if(n)this.onTileError(n,e);else{const n=this.Be(r);e.memorySize=n,this.onTileLoad(t,e)}}Be(t){let e=0;if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&(e+=this.Be(t[n]));else t&&(e+=t.getMemorySize());return e}onTileLoad(t,e){this.layer&&(delete this.tilesLoading[e.id],this.layer.onTileLoad(t,e),this.Ue(e),this.setToRedraw(),this.layer.fire("tileload",{node:e}))}onTilesetLoad(t,e,n){this.layer&&(this.layer.zt=t.extensions&&t.extensions["s3m:VertexCompressionType"],t.capabilities||t.layers&&t.layers[0]&&t.layers[0].capabilities?this.De(t,e,n):(delete this.tilesLoading[e.id],this.layer.onTilesetLoad(t,e,n)))}onTileError(t,e,n){if(!this.layer)return;const r=n||e.content.url,i=t&&t.message||t;t&&(404===t.status||204===t.status)||YJ.has(i)||(console.warn("failed to load 3d tile: "+r),console.warn(t),YJ.add(i)),delete this.tilesLoading[e.id],(!this.layer.options.onlyCacheNoContentTileWhenError||t&&!s.isNoContentHttpCode(t.status))&&this.Fe(e,t),this.setToRedraw(),this.layer.fire("tileerror",{node:e,error:t})}getCachedTile(t){return this.tileCache.get(t)}getShadowMeshes(){if(!this.painter)return[];const t=[],e=this.painter.getCurrentB3DMMeshes();for(const r in e)e[r]&&e[r].isValid&&e[r].isValid()&&t.push(e[r]);const n=this.painter.getCurrentI3DMMeshes();for(const r in n)n[r]&&n[r].isValid&&n[r].isValid()&&t.push(n[r]);return t}Fe(t,e){const n={loadTime:s.now(),current:!0,error:e,node:t};n.renderer=this,this.tileCache.add(t.id,n)}Ue(t){const e={loadTime:s.now(),current:!0,node:t};e.renderer=this,this.tileCache.add(t.id,e)}abortTileLoading(t){if(!t||!this.workerConn)return;const e=t.node.content.url;this.workerConn.abortTileLoading(this.layer.getId(),e),delete this.de[e]}_e(){if(this.tilesLoading)for(const t in this.tilesLoading)this.tilesLoading[t].current=!1}deleteTile(t){this.painter.deleteTile(t)}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:t.options.antialias},n=this.canvas.gl&&this.canvas.gl.wrap;n?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):(this.glOptions=e,this.gl=this.je(this.canvas,e)),this.regl=this.regl||mp({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.optionalExtensions||[]}),this.prepareWorker(),n&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=new EJ(this.regl,t),this.layer.ze(),this.layer.fire("contextcreate",{regl:this.regl})}prepareWorker(){const t=this.getMap();this.workerConn||(this.workerConn=new gZ("@maptalks/3dtiles",t.id,sx.supportNPOT(this.regl)));const e=this.workerConn;if(!e.isActive())return;let n=this.layer.options||{};n=eZ({},n),delete n.offset;const r=t.options.spatialReference;n.projection=r&&r.coordType||r&&r.projection||t.getSpatialReference().getProjection().code;const i=this.layer.getId();e.addLayer(i,n,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}onRemove(){this.painter&&this.painter.remove(),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),KJ--,KJ||QJ.reset(),this.clear(),delete this.tileCache,super.onRemove()}clear(){this.Te(!0),this.tileCache.reset(this),this.tilesLoading={},super.clear()}clearCanvas(){this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas()}getTileOpacity(){return 1}getStencilValue(){return 0}Te(t){this.qe||(this.qe=Date.now());const e=Date.now();if(!t&&e-this.qe<this.layer.options.retireInterval)return;this.qe=e;const n=[];for(const r in this.tilesLoading){const e=this.tilesLoading[r];!t&&e.current||(n.push(r),this.abortTileLoading(e))}for(let r=0;r<n.length;r++)delete this.tilesLoading[n[r]]}Me(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit}je(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let o=0;o<n.length;++o){try{r=t.getContext(n[o],e)}catch(i){}if(r)break}return r}Oe(t){return!!this.tilesLoading[t]}getI3DMMeshes(){return this.painter.getI3DMMeshes()}getPNTSMeshes(){return this.painter.getPNTSMeshes()}getB3DMMeshes(){return this.painter.getB3DMMeshes()}readBatchData(t,e,n){return function(t,e,n,r){const{byteOffset:i,componentType:o,type:s}=t,{ctor:a,type:l}=QZ(o||"UNSIGNED_SHORT"),h=YZ(s);return{byteStride:0,byteOffset:i+n,itemSize:h,count:r*h,componentType:l,array:new a(e,n+i,r*h)}}(t,e,0,n)}be(){if(!this.He)return;const t=this.layer.options.i3sNodepageLimitPerFrame||Number.MAX_VALUE;let e=0;const n=[];for(const r in this.He){const i=this.He[r];if("pending"===i.status)continue;i.status="pending";const o=i.rootIdx,s=dZ(this.layer.q(o).fetchOptions);if(n.push(Yp.getJSON(r,s).then((t=>{delete this.He[r];const e=this.ke[o];if(e){t.nodes?DJ(e,t.nodes):(e[t.id]=t,DJ(e,t.children));for(let t=0;t<i.length;t++)i[t]();this.setToRedraw()}else this.setToRedraw()}))),e++,e>=t)break}n.length&&Promise.all(n)}pe(t,e,n){this.He||(this.He={}),this.He[e]=this.He[e]||[],this.He[e].rootIdx=t,this.He[e].push(n),this.setToRedraw()}De(t,e,n){this.ke||(this.ke=[]);const r=e.H;this.ke[r]||(this.ke[r]={});const i=this.ke[r],o=this.layer.q(r);t.layers&&(t=t.layers[0],"/"!==n[n.length-1]&&(n+="/"),n+="layers/0"),i.version=+(o.i3sVersion||t.store.version),!t.spatialReference||t.spatialReference.wkid&&4326===t.spatialReference.wkid||console.warn("i3s has a spatialReference other than 4326.",t.spatialReference),t.spatialReference&&4490===t.spatialReference.wkid&&(console.warn("i3s spatialReference is 4490,auto set spatialReference to 4326,This may cause some location issues, please ensure that your service is 4326"),t.spatialReference.wkid=4326),i.projection=t.spatialReference,function(t,e,n,r,i,o,s){if(!o.layerScene){o.layerScene=e,o.nodesPerPage=e.nodePages&&e.nodePages.nodesPerPage||64,o.lodSelectionMetricType=e.nodePages&&e.nodePages.lodSelectionMetricType;let t=i;if(o.layerScene.eslpk=t.indexOf("3dSceneLayer.json")>=0,t.endsWith(".json")){const e=i.lastIndexOf("/");t=e<0?"./":i.substring(0,e)}o.layerScene.baseUrl=t.split("?")[0]}return new FJ(i,n,o,t,s).load()}(this.layer,t,r,0,n,i,this.Qt).then((t=>{this.onTilesetLoad(t,e,n)}))}pick(t,e,n){if(!this.painter)return[];const r=this.pickingFBO,{width:i,height:o}=this.canvas;return!this.pickingFBO||r.width===i&&r.height===o||r.resize(i,o),this.painter.pick(t,e,n&&n.tolerance)}highlight(t){if(this.$||(this.$=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let r=this.$[n];r||(r=this.$[n]=new Map),r.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.$[e];n||(n=this.$[e]=new Map),n.set(t.id,t)}this.painter.highlight(this.$)}cancelHighlight(t,e){if(!this.$)return;const n=this.$[t];if(n){if(Array.isArray(e))for(let t=0;t<e.length;t++)n.delete(e[t]);else n.delete(e);n.size||(this.$[t]=null),this.painter.highlight(this.$)}}cancelAllHighlight(){delete this.$,this.painter.cancelAllHighlight()}showOnly(t){if(this.X||(this.X=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let r=this.X[n];r||(r=this.X[n]=new Map),r.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.X[e];n||(n=this.X[e]=new Map),n.set(t.id,t)}this.painter.showOnly(this.X)}cancelShowOnly(){delete this.X,this.painter.cancelShowOnly()}Zt(){return this.painter?this.painter.Zt():[]}ue(t,e){const n=this.getMap();if("identity"===n.getProjection().code.toLowerCase()){const n=this.Ge();return XJ.set(e[0],e[1]),n.unproject(XJ,ZJ),t[0]=ZJ.x,t[1]=ZJ.y,t}return XJ.set(e[0],e[1]),n.getProjection().unproject(XJ,ZJ),t[0]=ZJ.x,t[1]=ZJ.y,t}Ve(t,e){const n=this.Ge();return XJ.set(e[0],e[1]),n.project(XJ,ZJ),t[0]=ZJ.x,t[1]=ZJ.y,t}Je(t,e){const n=this.Ge();return XJ.set(e[0],e[1]),n.unproject(XJ,ZJ),t[0]=ZJ.x,t[1]=ZJ.y,t}Ge(){const t=this.getMap().options.spatialReference.coordType;if(!t)throw new Error("Missing coordType in map spatialReference.");return this.$e||(this.$e=P.getProjectionInstance(t)),this.$e}};function tQ(t,e){return t.ut-e.ut}function eQ(t,e,n){return t[0]=e[n],t[1]=e[n+3],t[2]=e[n+6],t}const nQ=[],rQ=[],iQ=[],oQ=[],sQ=[],aQ=2*Math.PI;let lQ=class{constructor(t,e,n,r){this.west=t,this.south=e,this.east=n,this.north=r}static contains(t,e){let n=e[0];const r=e[1],i=t.west;let o=t.east;return o<i&&(o+=aQ,n<0&&(n+=aQ)),(n>i||qZ(n,i,1e-14))&&(n<o||qZ(n,o,1e-14))&&r>=t.south&&r<=t.north}static southwest(t,e){return e[0]=t.west,e[1]=t.south,e[2]=0,e}static northeast(t,e){return e[0]=t.east,e[1]=t.north,e[2]=0,e}static southeast(t,e){return e[0]=t.east,e[1]=t.south,e[2]=0,e}static northwest(t,e){return e[0]=t.west,e[1]=t.north,e[2]=0,e}};const hQ=[0,0,1];function uQ(t,e){return RZ(e,t[0],t[1],t[2])}let cQ=class{constructor(t,e){this.normal=km([],t),this.distance=e}static fromPointNormal(t,e,n){const r=-Wm(e,t);return km(n.normal,e),n.distance=r,n}};const fQ=[],dQ=[],pQ=[],gQ=[],mQ=[],AQ=[],yQ=[],vQ=[],xQ=[],_Q=[],bQ=new cQ([1,0,0],0),wQ=[];let TQ=class{constructor(t){this.southwestCornerCartesian=[],this.northeastCornerCartesian=[],this.westNormal=[],this.eastNormal=[],this.southNormal=[],this.northNormal=[],this.rectangle=new lQ(...t),this.minimumHeight=t[4],this.maximumHeight=t[5],this.computeBox(this.rectangle)}distanceToCamera(t,e){let n=0;if(!lQ.contains(this.rectangle,e)){const e=this.southwestCornerCartesian,r=this.northeastCornerCartesian,i=this.westNormal,o=this.southNormal,s=this.eastNormal,a=this.northNormal,l=Nm(wQ,t,e),h=Wm(l,i),u=Wm(l,o),c=Nm(wQ,t,r),f=Wm(c,s),d=Wm(c,a);h>0?n+=h*h:f>0&&(n+=f*f),u>0?n+=u*u:d>0&&(n+=d*d)}const r=e[2],i=this.minimumHeight,o=this.maximumHeight;if(r>o){const t=r-o;n+=t*t}else if(r<i){const t=i-r;n+=t*t}return Math.sqrt(n)}computeBox(t){const e=this;uQ(lQ.southwest(t,dQ),e.southwestCornerCartesian),uQ(lQ.northeast(t,dQ),e.northeastCornerCartesian),fQ[0]=t.west,fQ[1]=.5*(t.south+t.north),fQ[2]=0;const n=uQ(fQ,pQ),r=qm(mQ,n,hQ);Gm(e.westNormal,r),fQ[0]=t.east;const i=uQ(fQ,vQ),o=qm(mQ,hQ,i);Gm(e.eastNormal,o);const s=Nm(mQ,n,i),a=Gm(gQ,s),l=t.south;let h;if(l>0){fQ[0]=.5*(t.west+t.east),fQ[1]=l;const n=uQ(fQ,xQ);km(_Q,a);const r=cQ.fromPointNormal(e.southwestCornerCartesian,e.westNormal,bQ);MQ(xQ,_Q,r,e.southwestCornerCartesian),h=GZ(n,AQ)}else h=WZ(lQ.southeast(t,dQ),AQ);const u=qm(yQ,h,s);Gm(e.southNormal,u);const c=t.north;let f;if(c<0){fQ[0]=.5*(t.west+t.east),fQ[1]=c;const n=uQ(fQ,xQ);Bm(_Q,a,-1);const r=cQ.fromPointNormal(e.northeastCornerCartesian,e.eastNormal,bQ);MQ(xQ,_Q,r,e.northeastCornerCartesian),f=GZ(n,AQ)}else f=WZ(lQ.northwest(t,dQ),AQ);const d=qm(yQ,s,f);Gm(e.northNormal,d)}};function MQ(t,e,n,r){const i=t,o=e,s=n.normal,a=Wm(s,o);if(Math.abs(a)<1e-15)return;const l=(-n.distance-Wm(s,i))/a;return l<0?void 0:Dm(r=Bm(r,o,l),i,r)}function CQ(t){return[t.xmin,t.ymin,t.xmax,t.ymax]}const SQ=E,IQ={services:[],maxGPUMemory:I.mobile?32:1536,retireInterval:2e3,loadingLimitOnInteracting:5,loadingLimit:10,debug:!1,meshLimitPerFrame:1,i3sNodepageLimitPerFrame:1,enableI3SCompressedGeometry:!0,forceI3SCompressedGeometry:!0,onlyCacheNoContentTileWhenError:!0,picking:!0,pickingPoint:!0,geometryEvents:!1,alwaysShowTopTiles:!0,antialias:!1,offset:[0,0],renderer:"gl",forceRenderOnZooming:!0,forceRenderOnRotating:!0,forceRenderOnMoving:!0,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"]},PQ=[0,0,0],EQ=[0,0,0],OQ=[0,0,0],RQ=[0,0,0],kQ=[0,0,0],LQ=[0,0,0],DQ=[0,0,0],NQ=[1,1,1],FQ=[1,1,1],zQ=[0,0,0,0],BQ=[],HQ=new n(0,0),jQ=new i(0,0),UQ=[0,0,0,0,0,0,0,0,0],VQ=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],GQ=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WQ=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],qQ=new i(0,0),XQ=im([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),ZQ=[0,0],YQ=[0,0,0],JQ=[1,1,1],QQ=[0,0,0],KQ=[0,0,0],$Q=[0,0,0,0],tK=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1];let eK=class t extends(vP(u)){static fromJSON(e){return e&&"Geo3DTilesLayer"===e.type?new t(e.id,e.options):null}static getEnuTransform(t,e=[1,1,1],n=[0,0,0]){const r=RZ([],t[0]*Math.PI/180,t[1]*Math.PI/180,t[2]||0),i=aY(r,null,[]),o=ym([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],XA([0,0,0,0],...n),[0,0,0],e);return am(o,i,o)}constructor(t,e){super(t,e),this.isGeo3DTilesLayer=!0,this.Ke(),this.Xe=[]}Ke(){const t=this.options.services.map((t=>t.url));this.Ye=this.Ye||{},this.Le=this.Le||[];for(let e=0;e<t.length;e++){const n=t[e];let r=this.Ye[n];void 0===r&&(r=this.Ye[n]=this.Le.length),this.Le[r]=iK(n,r,this.options.services[e])}this.fire("rootready",{roots:this.Le.slice(0)})}showService(t){return this.updateService(t,{visible:!0}),this}hideService(t){return this.updateService(t,{visible:!1}),this}setToRedraw(){return this.Ze(),this}addService(t){return this.options.services=this.options.services||[],this.options.services.push(t),this.Ke(),this.Ze(),this}updateService(t,e){if(!e)return this;const n=this.options.services;let r=!1;n&&n[t]&&(r=!(aK(n[t].coordOffset,e.coordOffset)&&aK(n[t].heightOffset,e.heightOffset)&&aK(n[t].scale,e.scale)&&aK(n[t].rotation,e.rotation)),eZ(n[t],e));const i=n[t].url,o=this.Ye[i],s=this.Le&&this.Le[o];return s&&(tZ(e.visible)||(s.visible=e.visible),r&&s.version++),this.Ze(),this}removeService(t){const e=this.options.services;if(e&&e[t]){const n=e[t].url,r=this.Ye[n];this.Le[r]&&(this.Le[r]=null),delete this.Ye[n],e.splice(t,1)}return this.Ze(),this}getTileUrl(t,e){const n=e&&e.service&&e.service.subdomains;if(n&&e.domainKey){const r=n.length;if(r){const i=[...t].reduce(((t,e)=>t+e.charCodeAt(0)),0)%r;return t.replace(e.domainKey,n[i])}}return t}getExtent(t){if(!t&&0!==t){const t=new f;for(let e=0;e<this.Le.length;e++){const n=this.Le[e];if(n&&n.boundingVolume){const e=this.boundingVolumeToExtent(n);t._combine(e)}}return t}const e=this.Le[t];return e&&e.boundingVolume?this.boundingVolumeToExtent(e):null}boundingVolumeToExtent(t){const e=t.boundingVolume.We?XQ:t.matrix,r=this.getMap(),i="identity"===r.getProjection().code.toLowerCase(),o=this.getRenderer();if(t.boundingVolume.region){const e=t.boundingVolume.region;return new f(oZ(e[0]),oZ(e[1]),oZ(e[2]),oZ(e[3]))}if(t.boundingVolume.sphere){const n=t.boundingVolume.sphere,s=zZ([],Xm([0,0,0],n,e));i&&o.Ve(s,s);const a=n[3],l=r.locate(s,-a,a),h=r.locate(s,a,-a);return new f(l,h)}if(t.boundingVolume.box){const s=t.boundingVolume.box,a=Xm([0,0,0],s,e),l=new n(zZ([],a));i&&o.Ve(l,l);const h=s.slice(3);Yg(h,Wg([0,0,0,0,0,0,0,0,0],t.matrix),h);const u=Om(h.slice(0,3)),c=Om(h.slice(3,6)),d=Om(h.slice(6,9)),p=Math.max(u,c,d),g=r.locate(l,-p,p),m=r.locate(l,p,-p);return new f(g,m)}return null}getRootTiles(){return this.Le}getTiles(){const t=this.getRenderer();if(!t.ready)return this.Ze(),{tiles:BQ};const e=this.getMap(),n=e.cameraPosition,r=e.pointAtResToDistance(n[2],0,e.getGLRes()),i=this.Qe(n);this.tn=this.tn||[0,0,0],Lm(this.tn,iZ(i.x),iZ(i.y),r),this.nn=RZ(this.nn||[],this.tn[0],this.tn[1],this.tn[2]),this.rn=2*Math.tan(.5*iZ(e.getFov()));const o=e.projViewMatrix;let s;if(e.getPitch()<=80){const t=e.getExtent(),n=t.getWidth()/2,r=t.getHeight()/2;t.xmin-=n,t.ymin-=r,t.xmax+=n,t.ymax+=r,s=CQ(t)}const a=(this.getMasks()||[]).filter((t=>t&&t instanceof wE));a.forEach((t=>{if(!t.maskGeoJSON&&t.toGeoJSON)try{t.maskGeoJSON=t.toGeoJSON();const e=t.getExtent();t.maskGeoJSON.bbox=CQ(e)}catch(e){console.error(e)}}));const l={children:[],level:-1};let h=l;const u=[];for(let c=0;c<this.Le.length;c++){const e=this.Le[c];if(!e||!e.visible)continue;const n=e.service,r=[e],i=this.sn(c);for(;r.length>0;){const e=r.pop();for(e.id||this.an(e);h.level>=e.Ee;)h=h.parent;const l=this.cn(e,i,o,s,a);if(e.service=n,!(l===lK.VISIBLE||l!==lK.OUT_OF_FRUSTUM&&this.options.alwaysShowTopTiles&&sK(e))){let t=h;for(;t&&!t.content;)t=t.parent;l===lK.SCREEN_ERROR_TOO_SMALL&&t&&t.content&&this.hn(u,t);continue}e.ut<1/0&&this.ln(e);const c=this.Ce(e,h);h.children.push(c);const f=e.children,d=f&&f.length,p=c.content;if(p&&(!d||l===lK.SCREEN_ERROR_TOO_SMALL)&&this.hn(u,c),l!==lK.SCREEN_ERROR_TOO_SMALL&&d){p&&"add"===e.refine&&this.hn(u,c),h=c;const n=f[0].parent;let i=!1;for(let o=0,s=f.length;o<s;o++){if(n){const e=t.getCachedTile(f[o].id);if(e&&e.error&&404!==e.error.status)continue;i=!0}else{i=!0,f[o].parent=e,f[o].At=e.At,f[o].baseUrl=e.baseUrl;const t=f[o].content&&(f[o].content.url||f[o].content.uri);t&&(hZ(t)||t.indexOf("i3s:")>=0?f[o].baseUrl=e.baseUrl:fZ(t)?f[o].content.url=e.baseUrl+t:f[o].baseUrl=t.substring(0,t.lastIndexOf("/")+1))}r.push(f[o])}!i&&p&&this.hn(u,c)}}}return{root:l,tiles:u}}hn(t,e){const{viewerRequestVolume:n,matrix:r}=e.node;n&&!function(t,e,n,r){if(n.region){const e=n.region;if(t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3])return!0}else{if(n.sphere)return nK(n,e,r)<=0;if(n.box)return 0===rK(n,e,r)}return!1}(this.tn,this.nn,n,r)||t.push(e)}Ce(t,e){return{id:t.id,node:t,children:[],level:t.Ee,parent:e,content:t.content&&t.content.url}}an(t){const e=this.getId();t.id=e+":"+s.GUID(),t.matrix=t.transform||im([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),t.un=this.dn(t),t.parent&&(function(t){return t.content&&t.content.uri&&t.content.uri.indexOf("i3s:")>=0}(t)||(t.matrix=am(t.matrix,t.parent.matrix,t.matrix)),t.H=t.parent.H,void 0===t.Ee&&(t.Ee=t.parent.Ee+1),t.maxExtent=t.parent.maxExtent),t.refine=t.refine&&t.refine.toLowerCase()||"replace",t.content&&!t.content.url&&t.content.uri&&(t.content.url=t.content.uri)}q(t){return this.Le[t].service}mn(t){const e=t.boundingVolume;if(!e||e.We&&!this.pn(t))return;const n=this.q(t.H),r=n.heightOffset||0,i=this.options.offset,o=nZ(i)||i[0]||i[1],s=n.coordOffset||ZQ;if(!Array.isArray(s))throw new Error("service.coordOffset must be an array");if(!e.We&&(!t.boundingVolume||!r&&Cm(t.matrix,XQ)&&!o&&s===ZQ))return;e.box&&e.region&&delete e.region;const{region:a,box:l,sphere:h}=e;if(e.coordOffset=[s[0],s[1]],e.heightOffset=r,a){e.originalVolume||(e.originalVolume=a.slice(0));const t=e.originalVolume,n=this.gn([oZ(t[0]),oZ(t[1])]);a[0]=iZ(n.x+s[0]),a[1]=iZ(n.y+s[1]);const i=this.gn([oZ(t[2]),oZ(t[3])]);a[2]=iZ(i.x+s[0]),a[3]=iZ(i.y+s[1]),a[4]=t[4]+r+(s[2]||0),a[5]=t[5]+r+(s[2]||0)}else if(l||h){e.originalVolume||(e.originalVolume=(l||h).slice(0));const n=l||h,i=e.originalVolume,o=Xm(PQ,i,t.matrix),a=zZ(EQ,o),u=this.gn([a[0]+s[0],a[1]+s[1]]);a[0]=u.x,a[1]=u.y,a[2]+=r+(s[2]||0),RZ(n,iZ(a[0]),iZ(a[1]),a[2])}e.We=!0;try{t.extent=this.boundingVolumeToExtent(t)}catch(u){console.error(u)}}pn(t){const e=t.boundingVolume,n=this.q(t.H),r=n.heightOffset||0,i=n.coordOffset||ZQ;return e.coordOffset[0]!==i[0]||e.coordOffset[1]!==i[1]||e.heightOffset!==r}dn(t){return void 0===t.geometricError||!t.boundingVolume}ln(t){let e=t.parent;for(;e&&e.un&&!(e.ut<=t.ut);)e.ut=t.ut,e=t.parent}onTileLoad(t,e){if(t.children&&(!e.children||!e.children.length)){e.children=t.children;const n=e.content.url;e.baseUrl=n.substring(0,n.lastIndexOf("/")+1),this.Ze()}}onTilesetLoad(t,e,n){if(!t)return void console.warn("invalid tileset at : "+n);const r=(t.asset&&t.asset.gltfUpAxis||e&&e.At||"Y").toUpperCase();t.root.baseUrl=n.substring(0,n.lastIndexOf("/")+1);const i=n.indexOf("realspace/")>-1;0===e.Ee&&t.asset&&t.asset.s3mType&&i&&(t.root.baseUrl+="data/path/");const o=t.asset.i3s;if(t.root.At=r,e){const n=e.boundingVolume;eZ(e,t.root),e.refine=e.refine&&e.refine.toLowerCase()||"replace",n&&(e.boundingVolume=n);const r=t.root.transform||im([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);if(e.parent)o||(e.matrix=am([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.parent.matrix,r));else{const t=this.q(e.H);t.ecefTransform?e.matrix=am([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.ecefTransform,r):e.matrix=r}delete e.content,t.root.content&&(e.content=t.root.content),e.un=this.dn(e);const i=e.content&&(e.content.url||e.content.uri);i&&e.content.uri&&(e.content.url=e.content.uri,delete e.content.uri),!o&&i&&!hZ(i)&&fZ(i)&&(e.content.url=e.baseUrl+i),t.root&&!e.parent&&this.bn(e)}this.Ze(),this.fire("loadtileset",{tileset:t,index:e&&e.H,url:n})}yn(t,e,n){if(!t.extent||!SQ)return!0;const r=t.extent;if($Q[0]=r.xmin,$Q[1]=r.ymin,$Q[2]=r.xmax,$Q[3]=r.ymax,e&&!SQ.bboxIntersect($Q,e))return!1;if(n.length){for(let t=0,e=n.length;t<e;t++){const e=n[t].maskGeoJSON;if(!e||!e.bbox||SQ.bboxInMask($Q,e))return!0}return!1}return!0}cn(t,e,n,r,i){if(!this.yn(t,r,i))return lK.OUT_OF_FRUSTUM;if(t.ut=1/0,0===t.Ee||t.un)return this.bn(t),lK.VISIBLE;if(this.mn(t),!this.wn(t,e,n))return lK.OUT_OF_FRUSTUM;if(0===t.geometricError)return lK.VISIBLE;let o=this.q(t.H).maximumScreenSpaceError;null==o&&(o=16);let s=this.vn(t);return 0===s&&t.parent&&(s=.5*(t.parent.Tn||0)),s>=o?lK.VISIBLE:lK.SCREEN_ERROR_TOO_SMALL}Xt(t,e){e||(e=new i(0,0));const n=this.getMap();return n.coordToPointAtRes(t,n.getGLRes(),e)}wn(t,e,n){const r=t.id;let i=this.Xe[r];const{boundingVolume:o}=t,s=o.region,a=o.box,l=o.sphere,h=this._n(t.H),u=this.getRenderer();return i&&i.version===h.version||(s?i=this.Xe[r]=this.Mn(t):a?i=this.Xe[r]=this.On(t):l&&(i=this.Xe[r]=this.An(t)),i.version=h.version,t.ft&&(u.Ft(t.ft),delete t.ft)),this.q(t.H).debug&&(this.Xe[r].node=t,u.Ut(t)),i.obbox?function(t,e){aX(t);for(var n=0;n<6;n++)if(!sX(Xq[n],e))return!1;return!0}(n,i.obbox):!!l&&function(t,e){aX(t);for(var n=e[0],r=-e[1],i=0;i<6;i++)if(hX(Xq[i],n)<r)return!1;return!0}(n,i.sphereBox)}Mn(t){const e=this.getMap(),r=e.getGLRes(),o=t.boundingVolume.region;let{ws:s,en:a}=function(t){const e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],s=t[5],a=RZ([],e,n,o),l=RZ([],r,i,s);return{ws:zZ(a,a),en:zZ(l,l)}}(o);s=new n(s),a=new n(a);const l=e.coordToPointAtRes(s,r);l.z=e.altitudeToPoint(s.z,r);const h=e.coordToPointAtRes(a,r);h.z=e.altitudeToPoint(a.z,r);const u=[h.x,l.y,h.z,h.x,h.y,h.z,l.x,h.y,h.z,l.x,l.y,h.z,h.x,l.y,l.z,h.x,h.y,l.z,l.x,h.y,l.z,l.x,l.y,l.z],c=[(u[0]+u[18])/2,(u[1]+u[19])/2,(u[2]+u[20])/2],f=this._n(t.H);t!==f||f.xn||(f.xn=c);const d=this.Jt([],t),p=Cm(XQ,d);if(!p){Xm(c,c,d);const t=PQ;for(let e=0;e<u.length;e+=3){let n=Lm(t,u[e],u[e+1],u[e+2]);p||(n=Xm(n,n,d)),u[e]=n[0],u[e+1]=n[1],u[e+2]=n[2]}}const g=e.pointAtResToCoord(new i(c),r);g.z=(s.z+a.z)/2;const m=this.In(u,c);for(let n=0;n<u.length;n++)u[n]-=c[n%3];return{obbox:m,boxPosition:u,boxCenter:c,boxCoord:g}}On(t){const e=this.getRenderer(),n=this.getMap(),r="identity"===n.getProjection().code.toLowerCase(),i=n.getGLRes(),{boxCenter:o,boxCoord:s}=this.Sn(t),a=t.boundingVolume.box,l=this.En(a,t.matrix),h=(T=a,u=[],c=(w=l)[0],f=w[3],d=w[6],p=T[0],g=w[1],m=w[4],A=w[7],y=T[1],v=w[2],x=w[5],_=w[8],b=T[2],u[0]=c||0,u[1]=g||0,u[2]=v||0,u[3]=0,u[4]=f||0,u[5]=m||0,u[6]=x||0,u[7]=0,u[8]=d||0,u[9]=A||0,u[10]=_||0,u[11]=0,u[12]=p||0,u[13]=y||0,u[14]=b||0,u[15]=1,u);var u,c,f,d,p,g,m,A,y,v,x,_,b,w,T;const M=this.Jt([],t),C=Cm(XQ,M);C||Xm(o,o,M);const S=[],I=PQ;for(let E=0;E<tK.length;E+=3){I[0]=tK[E],I[1]=tK[E+1],I[2]=tK[E+2],Xm(I,I,h),zZ(I,I),r&&e.Ve(I,I);const t=HQ.set(I[0],I[1],I[2]);n.coordToPointAtRes(t,i,jQ);let o=Lm(I,jQ.x,jQ.y,n.altitudeToPoint(t.z,i));C||(o=Xm(o,o,M)),S[E]=o[0],S[E+1]=o[1],S[E+2]=o[2]}const P=this.In(S,o);for(let E=0;E<S.length;E++)S[E]-=o[E%3];return{obbox:P,boxPosition:S,boxCenter:o,boxCoord:s}}An(t){const e=this.getMap(),r=this.getRenderer(),i="identity"===e.getProjection().code.toLowerCase(),o=t.boundingVolume.sphere,s=o;let a=PQ;0===s[0]&&0===s[1]&&0===s[2]?a=[0,0,-6378137]:zZ(a,s),i&&r.Ve(a,a);const l=new n(a),h=this.Xt(l,jQ).toArray();h[2]=e.altitudeToPoint(l.z,e.getGLRes());const u=this.Cn(l);return{boxCenter:h,boxCoord:l,sphereBox:[h,o[3]*u[2]]}}In(t,e){const n=oK(kQ,t,0,1,4,5),r=oK(LQ,t,0,3,4,7),i=oK(DQ,t,0,1,2,3);return[...e,...Km(PQ,n,e),...Km(EQ,r,e),...Km(OQ,i,e)]}Sn(t){const e=this.getMap(),r=this.getRenderer(),i="identity"===e.getProjection().code.toLowerCase(),o=e.getGLRes(),s=t.boundingVolume.box.slice(0,3);zZ(s,s),i&&r.Ve(s,s);const a=new n(s),l=e.coordToPointAtRes(a,o);return{boxCenter:[l.x,l.y,e.altitudeToPoint(a.z,o)],boxCoord:a}}Jt(t,e){const n=this._n(e.H),r=this.q(e.H),i=n.xn,o=cm(VQ,Lm(PQ,-i[0],-i[1],-i[2])),s=cm(GQ,i),a=r.rotation||YQ,l=XA(zQ,...a),h=r.scale;let u;u=Array.isArray(h)?Lm(QQ,h[0],h[1],h[2]):h&&Lm(QQ,h,h,h)||JQ;return t=am(t,ym(WQ,l,KQ,u),o),am(t,s,t)}bn(t){const e=this.q(t.H);if(!t.boundingVolume||this.Nn(t,e))return;const n=t.boundingVolume.box,r=t.boundingVolume.region,i=t.boundingVolume.sphere;let o=null;n?o=this.kn(t).boxCenter:r?o=this.Rn(t).boxCenter:i&&(o=this.An(t).boxCenter);const s=e.heightOffset||0,a=e.coordOffset||[0,0];t.Ln=[a[0]||0,a[1]||0],t.Pn=s,t.xn=o}Nn(t,e){if(!t.Ln)return!1;const n=e.coordOffset||ZQ;return t.Ln[0]===n[0]&&t.Ln[1]===n[1]&&t.Pn===(e.heightOffset||0)}Rn(t){return this.mn(t),this.Mn(t)}kn(t){return this.mn(t),this.Sn(t)}En(t,e){let n=t.slice(3,12);return n=Yg(n,Wg(UQ,e),n),n}Cn(t){const e=this.getMap(),n=e.distanceToPointAtRes(100,100,e.getGLRes(),t);let r;return r=e.altitudeToPoint?e.altitudeToPoint(100,e.getGLRes())/100:n.y/100,Lm(NQ,n.x/100*1.01,n.y/100*1.01,r),NQ}gn(t){Array.isArray(t)&&(t=new n(t));let e=this.options.offset;if(nZ(e)&&(e=e.call(this,Array.isArray(t)?new n(t):t)),e[0]||e[1]){const n=this.getMap(),r=n.getGLRes(),i=n.coordToPointAtRes(t,r);return jQ.set(e[0],e[1]),i._sub(jQ),n.pointAtResToCoord(i,r)}return t}_n(t){return this.Le[t]}sn(t){const e=this.q(t).maxExtent;if(!e)return null;const n=this.Le[t];return n.maxExtent||(n.maxExtent=new f(e).convertTo((t=>this.Xt(t)))),n.maxExtent}vn(t){const e=this.rn,n=t.geometricError;if(0===n)return t.Tn=0,0;const r=this.q(t.H);let i=r.scale||1;if(Array.isArray(i)&&(i=Om(i)),r.ecefTransform){const t=mm(FQ,r.ecefTransform);i*=rA(t)}const o=this.getMap();let s;var a,l,h;t.boundingVolume.region?(a=t,l=this.nn,h=this.tn,a.Bn||(a.Bn=new TQ(a.boundingVolume.region)),s=a.Bn.distanceToCamera(l,h)):t.boundingVolume.sphere?s=nK(t.boundingVolume,this.nn):t.boundingVolume.box&&(s=rK(t.boundingVolume,this.nn));const u=Math.max(Math.abs(s),1e-7),c=n*i*o.height/(u*e);return t.ut=s,t.Tn=c,c}Ze(){const t=this.getRenderer();t&&t.setToRedraw()}Dt(t){return this.Xe[t]}identify(t,e={}){const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];Array.isArray(t)&&(t=new n(t));const o=r.coordToContainerPoint(t);return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=[];if(!e.excludeMasks){const r=this.identifyMask(t,e);r&&r.length&&uZ(n,r)}const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const o=r.getDevicePixelRatio();return uZ(n,i.pick(t.x*o,t.y*o,e)),e&&e.filter&&!e.excludeMasks?n.filter((t=>e.filter(t))):n}getCurrentBatchIDs(){const t=this.getMap(),e=this.getRenderer();return t&&e?e.Zt():[]}highlight(t){const e=this.getRenderer();return Array.isArray(t)||(t=[t]),e?(e.highlight(t),this):(this.$||(this.$=[]),this.$.push(t),this)}ze(){if(this.$){for(let t=0;t<this.$.length;t++)this.highlight(this.$[t]);delete this.$}}cancelHighlight(t,e){const n=this.getRenderer();return n?(n.cancelHighlight(t,e),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}showOnly(t){const e=this.getRenderer();return e?(e.showOnly(t),this):(this.X||(this.X=[]),this.X.push(t),this)}Un(){if(this.X){for(let t=0;t<this.X.length;t++)this.showOnly(this.X[t]);delete this.X}}cancelShowOnly(t){const e=this.getRenderer();return e?(e.cancelShowOnly(t),this):this}setServiceOpacity(t,e){const n=this.options.services[t];return n&&(n.opacity=e),this.getRenderer()?(this.Ze(),this):this}setServiceDebug(t,e){const n=this.options.services[t];return n&&(n.debug=e),this.getRenderer()?(this.Ze(),this):this}Qe(t){const e=this.getMap(),n=e.getGLRes();qQ.set(t[0],t[1]);const r=e.pointAtResToCoord(qQ,n);return"identity"===e.getProjection().code.toLowerCase()?(EQ[0]=r.x,EQ[1]=r.y,this.getRenderer().Je(PQ,EQ),r.set(PQ[0],PQ[1]),r):r}toJSON(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}}};function nK(t,e,n){let r=t.sphere;n&&(r=Xm([0,0,0],r,n));const i=eA(r,e),o=t.sphere[3];return i<o?0:i-o}function rK(t,e,n){const r=t.box;let i=Lm(PQ,r[0],r[1],r[2]);return n&&(i=Xm([0,0,0],i,n)),function(t,e,n){return Math.sqrt(function(t,e,n){const r=Nm(nQ,n,t),i=eQ(rQ,e,0),o=eQ(iQ,e,1),s=eQ(oQ,e,2),a=rA(i),l=rA(o),h=rA(s);Gm(i,i),Gm(o,o),Gm(s,s);const u=sQ;u[0]=Wm(r,i),u[1]=Wm(r,o),u[2]=Wm(r,s);let c,f=0;return u[0]<-a?(c=u[0]+a,f+=c*c):u[0]>a&&(c=u[0]-a,f+=c*c),u[1]<-l?(c=u[1]+l,f+=c*c):u[1]>l&&(c=u[1]-l,f+=c*c),u[2]<-h?(c=u[2]+h,f+=c*c):u[2]>h&&(c=u[2]-h,f+=c*c),f}(t,e,n))}(i,qg(UQ,r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11]),e)}function iK(t,e,n){const r=(t=function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t)).indexOf("{s}")>=0?"{s}":t.indexOf("%7Bs%7D")>=0?"%7Bs%7D":null;return{version:0,un:!0,service:n,visible:!!tZ(n.visible)||n.visible,baseUrl:t.substring(0,t.lastIndexOf("/"))+"/",content:{url:t},refine:"replace",matrix:im([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),H:e,Ee:0,domainKey:r}}function oK(t,e,n,r,i,o){const s=Lm(PQ,e[3*n],e[3*n+1],e[3*n+2]),a=Lm(EQ,e[3*r],e[3*r+1],e[3*r+2]),l=Lm(OQ,e[3*i],e[3*i+1],e[3*i+2]),h=Lm(RQ,e[3*o],e[3*o+1],e[3*o+2]);return t[0]=(s[0]+a[0]+l[0]+h[0])/4,t[1]=(s[1]+a[1]+l[1]+h[1])/4,t[2]=(s[2]+a[2]+l[2]+h[2])/4,t}function sK(t){if(!t.content||t.hasParentContent)return!1;let e=t.parent;if(e&&(e.content||e.hasParentContent))return t.hasParentContent||(t.hasParentContent=!0),!1;for(;e;){if(e.content||e.hasParentContent)return t.hasParentContent||(t.hasParentContent=!0),!1;e=e.parent}return!0}function aK(t,e){return Array.isArray(t)&&Array.isArray(e)?2===t.length?Xy(t,e):Ym(t,e):t===e}var lK;if(eK.mergeOptions(IQ),eK.registerRenderer("gl",$J),eK.registerJSONType("Geo3DTilesLayer"),function(t){t[t.OUT_OF_FRUSTUM=0]="OUT_OF_FRUSTUM",t[t.SCREEN_ERROR_TOO_SMALL=1]="SCREEN_ERROR_TOO_SMALL",t[t.VISIBLE=2]="VISIBLE"}(lK||(lK={})),BE){const t=a.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){l("@maptalks/3dtiles",BE.inject(cX))}else l("@maptalks/3dtiles",(function(){return BE.inject(cX)}))}else l("@maptalks/3dtiles",cX);const hK="${",uK=`function(t){\n/*!\n     * @maptalks/gltf-loader v0.98.4\n     * LICENSE : UNLICENSED\n     * (c) 2016-2024 maptalks.org\n     */\nvar e="undefined"!=typeof Float32Array?Float32Array:Array;function n(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3],c=e[4],a=e[5],u=e[6],h=e[7],f=e[8],l=e[9],d=e[10],m=e[11],p=e[12],w=e[13],g=e[14],y=e[15],_=n[0],b=n[1],A=n[2],T=n[3];return t[0]=_*r+b*c+A*f+T*p,t[1]=_*s+b*a+A*l+T*w,t[2]=_*i+b*u+A*d+T*g,t[3]=_*o+b*h+A*m+T*y,_=n[4],b=n[5],A=n[6],T=n[7],t[4]=_*r+b*c+A*f+T*p,t[5]=_*s+b*a+A*l+T*w,t[6]=_*i+b*u+A*d+T*g,t[7]=_*o+b*h+A*m+T*y,_=n[8],b=n[9],A=n[10],T=n[11],t[8]=_*r+b*c+A*f+T*p,t[9]=_*s+b*a+A*l+T*w,t[10]=_*i+b*u+A*d+T*g,t[11]=_*o+b*h+A*m+T*y,_=n[12],b=n[13],A=n[14],T=n[15],t[12]=_*r+b*c+A*f+T*p,t[13]=_*s+b*a+A*l+T*w,t[14]=_*i+b*u+A*d+T*g,t[15]=_*o+b*h+A*m+T*y,t}function r(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,n,r){var s=new e(3);return s[0]=t,s[1]=n,s[2]=r,s}function i(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function c(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function a(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(t,e,n,r,s){return t[0]=e,t[1]=n,t[2]=r,t[3]=s,t}function h(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3];return t[0]=n[0]*r+n[4]*s+n[8]*i+n[12]*o,t[1]=n[1]*r+n[5]*s+n[9]*i+n[13]*o,t[2]=n[2]*r+n[6]*s+n[10]*i+n[14]*o,t[3]=n[3]*r+n[7]*s+n[11]*i+n[15]*o,t}function f(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),r(),function(){var t;t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}();var l,d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};r(),s(1,0,0),s(0,1,0),f(),f(),l=new e(9),e!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1;let m=0;function p(t){return null==t}function w(t){return!p(t)}function g(t){return!p(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function y(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function _(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function b(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function A(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=e.charCodeAt(t);return r.buffer}const T=[],x=[],I=[],M=[0,0,0],E=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),v=[1,1,1];function O(t,e,n,r,s,i,o){const c=_(o),a=c.BYTES_PER_ELEMENT;if((0===s||s===r*a)&&i%a==0){const s=new c(e,i,n*r);return t.set(s),t}0===s&&(s=r*a);const u=new Uint8Array(r*a);for(let o=0;o<n;o++){let n=null;const h=new Uint8Array(e,s*o+i,r*a);u.set(h),n=new c(u.buffer,0,r);for(let e=0;e<r;e++)t[o*r+e]=n[e]}return t}const P="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function k(t,e,n){const r=new Uint8Array(t,e,n);return P.decode(r)}const N={get:function(t,e={},n){e||(e={});const r=new AbortController,s=r.signal,i=y({},e);i.signal=s,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),n&&(t=n(t));const o=fetch(t,i).then((t=>{const n=this.t(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return o.xhr=r,o},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${hK}t.status}): ${hK}t.statusText}\`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",N.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?N.jsonp(t):((e=e||{}).responseType="json",N.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+m++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class S{constructor(t,e,n,r,s){this.i=t,this.decoders=e,this.o=n,this.images={},this.u={},this.h=r||{},this.l=s}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],s=this.m(e,r);return this.getImageByBuffer(s,n)}if(this.u[t.id])return this.u[t.id].then((()=>{const r=this.buffers[t.id],s=this.m(e,r);return this.getImageByBuffer(s,n)}));if(b(t.uri)){const r=this.buffers[t.id]=A(t.uri),s=this.m(e,r);return this.getImageByBuffer(s,n)}let r;const s=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||s?t.uri:this.rootPath+"/"+t.uri,this.u[t.id]=N.getArrayBuffer(r,this.h,this.l).then((r=>{const s=this.buffers[t.id]=r.data,i=this.m(e,s);return this.getImageByBuffer(i,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this.o}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this.p(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.u[t.id]?this.u[t.id].then((()=>this.images[t.id])):this.u[t.id]=this.p(t.id,e)}p(t,e){return new Promise(((n,r)=>{let s=e;this.l&&(s=this.l(e)),this.i(s,this.h,((s,i)=>{s?r(s):(URL.revokeObjectURL(e),this.images[t]=i,n(this.images[t]))}))}))}}const B=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],R=[];class U{constructor(t,e,n,r,s){this.rootPath=t,this.gltf=e,this._=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.A(),this.h=r,this.l=s}T(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this.I(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const s=n.bufferViews[r.bufferView];return this.M(s).then((n=>{const{buffer:s,byteOffset:i}=n;return this.accessors[r.id]=this.I(t,e,s,i)}))}M(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(b(e.uri)){const t=this.buffers[e.id]=A(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=N.getArrayBuffer(t,this.h,!n&&this.l).then((r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}I(t,e,n,r=0){const s=this.gltf,i=s.accessors[e],o=void 0!==i.bufferView?s.bufferViews[i.bufferView]:{},c=(o.byteOffset||0)+r,a=this.v(i.type),u=_(i.componentType),f=o.byteStride||0,l={array:void 0,name:t,accessorName:e,byteLength:i.count*a*u.BYTES_PER_ELEMENT,componentType:i.componentType,count:i.count,type:i.type,itemSize:a,max:i.max,min:i.min,extensions:i.extensions};if(i.min&&(l.min=i.min),i.max&&(l.max=i.max),n)if(this._)l.byteStride=f,l.byteOffset=c+(i.byteOffset||0),!f||f===a*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(l.array=this.O(n,i.count,a,c+(i.byteOffset||0),u),l.array.buffer.byteLength===l.byteLength&&(l.byteOffset=0)):l.array=new Uint8Array(n,c,o.byteLength);else if(i.interleaved){l.byteStride=0,l.byteOffset=0;const t=new u(i.count*a);if(l.array=O(t,n,i.count,a,f,c+(i.byteOffset||0),i.componentType),l.extensions&&l.extensions.WEB3D_quantized_attributes&&a>2){const t=new Float32Array(l.array.length),{decodeMatrix:e}=l.extensions.WEB3D_quantized_attributes;for(let n=0;n<l.array.length;n+=a){R[0]=l.array[n],R[1]=l.array[n+1],R[2]=l.array[n+2],R[3]=1;const r=h(R,R,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}l.componentType=5126,l.array=t}}else l.byteStride=0,l.array=this.O(n,i.count,a,c+(i.byteOffset||0),u),l.byteOffset=l.array.byteOffset;else{l.array=new u(i.count);const t=l.min||l.max;t&&(l.array[0]=t[0],l.array[1]=t[1],l.array[2]=t[2])}return l}A(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}O(t,e,n,r,s){return r%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*s.BYTES_PER_ELEMENT),r=0),new s(t,r,n*e)}v(t){const e=B.indexOf(t);return B[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this.M(e).then((r=>{const{buffer:s,byteOffset:i}=r,o=k(s,i+(e.byteOffset||0),n);return t.content=o,t}))}if(t.uri){if(b(t.uri)){const e=A(t.uri),n=k(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return N.get(e,this.h,this.l).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}}class C extends S{constructor(t,e,n,r,s,i,o,c){super(r,s,i,o,c),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new U(t,e,n,o,c)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const e in n)t(e,n[e],r++)}createNode(t){const e={};if(w(t.name)&&(e.name=t.name),w(t.children)&&(e.children=t.children),w(t.jointName)&&(e.jointName=t.jointName),w(t.matrix)&&(e.matrix=t.matrix),w(t.rotation)&&(e.rotation=t.rotation),w(t.scale)&&(e.scale=t.scale),w(t.translation)&&(e.translation=t.translation),w(t.extras)&&(e.extras=t.extras),w(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const r=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(T,e.translation||M),s=function(t,e){var n=e[0],r=e[1],s=e[2],i=e[3],o=n+n,c=r+r,a=s+s,u=n*o,h=r*o,f=r*c,l=s*o,d=s*c,m=s*a,p=i*o,w=i*c,g=i*a;return t[0]=1-f-m,t[1]=h+g,t[2]=l-w,t[3]=0,t[4]=h-g,t[5]=1-u-m,t[6]=d+p,t[7]=0,t[8]=l+w,t[9]=d-p,t[10]=1-u-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(x,e.rotation||E),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(I,e.scale||v);return n(i,s,i),n(t,r,i)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}P(t){const e={};for(const n in t){const r=t[n];let s,i;r.instanceTechnique&&r.instanceTechnique.values?(s=r.instanceTechnique,i=s.values.diffuse):(s=r,i=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:i}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}k(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,s=n.byteLength,i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,s);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}N(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.k(n).then((t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const s=this.gltf.textures[r];if(!s)return null;const i=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:i,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}const L=9729;class D extends S{constructor(t,e,n,r,s,i,o,c){super(r,s,i,o,c),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new U(t,e,n,o,c)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return y(e,t),!w(t.weights)&&this.gltf.meshes&&w(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}N(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!w(n))return null;const r=this.gltf.images[n];return this.k(r).then((t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};y(n,e);const s=w(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(s&&(n.sampler=s,n.sampler.magFilter=s.magFilter||L,n.sampler.minFilter=s.minFilter||9987,n.sampler.wrapS=s.wrapS||10497,n.sampler.wrapT=s.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==L&&9728!==n.sampler.minFilter){const t=n.sampler.minFilter;n.sampler.minFilter=9984===t||9986===t?9728:L}return t.format&&(n.format=t.format),n}))}k(t){if(!w(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.S(e,t)}return null}S(t,e){const n=this.m(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}m(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,s=t.byteLength;return new Uint8Array(e,r,s)}B(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);n.join("");const r="data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)));return r}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(w(t[n].input)||w(t[n].output))&&(e.push(this.accessor.T("input",t[n].input)),e.push(this.accessor.T("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}}const q="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class F{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),s=r.getUint32(4,!0);if(1===s)return F.readV1(r,e);if(2===s)return F.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const s=V(t.buffer,20+e,r);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,s;const i=new DataView(t,e+12);let o=0;for(;o+8<i.byteLength;){const c=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,1313821514===a)n=V(t,e+12+o,c);else if(5130562===a){s=e+12+o,r=c;break}o+=c}return{json:JSON.parse(n),glbBuffer:{byteOffset:s,buffer:t,byteLength:r}}}}function V(t,e,n){if(q){const r=new Uint8Array(t,e,n);return q.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let s=t[r++];if(128&s){let n=j[s>>3&7];if(!(64&s)||!n||r+n>e)return null;for(s&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;s=s<<6|63&e}}n+=String.fromCharCode(s)}return n}(new Uint8Array(t,e,n))}const j=[1,1,1,1,2,2,3,0],H=[0,0,0],K=[0,0,0,1],X=[1,1,1],$={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},G={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},z={R(t,e,n,r,s,o,c,a){const u=w(t)?e.animations:[e.animations[0]],h={};for(let e=0;e<u.length;e++){const f=u[e],l=f.name||e;if(w(t)&&l!==t)continue;const m=f.channelsMap[n];if(m)for(let t=0;t<m.length;t++){const e=m[t];"translation"===e.target.path?(this.U(s,f.samplers[e.sampler],r,1),h.translation=i(H,s)):"rotation"===e.target.path?(this.C(o,f.samplers[e.sampler],r,1),h.rotation=d(K,o)):"scale"===e.target.path?(this.U(c,f.samplers[e.sampler],r,1),h.scale=i(X,c)):"weights"===e.target.path&&a&&(this.U(a,f.samplers[e.sampler],r,a.length),h.weights=a)}}return h},U(t,e,n,r){switch(e.interpolation){case"LINEAR":{const s=this.L(G,e,n,1*r);s&&(t=function(t,e,n,r){for(let s=0;s<t.length;s++)t[s]=e[s]+r*(n[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.L(G,e,n,1*r);s&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.L(G,e,n,3*r);s&&(t=this.D(t,s,e.input.array,3*r));break}}return t},C(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this.L(G,e,n,1);r&&function(t,e,n,r){var s,i,o,c,a,u=e[0],h=e[1],f=e[2],l=e[3],d=n[0],m=n[1],p=n[2],w=n[3];(i=u*d+h*m+f*p+l*w)<0&&(i=-i,d=-d,m=-m,p=-p,w=-w),1-i>1e-6?(s=Math.acos(i),o=Math.sin(s),c=Math.sin((1-r)*s)/o,a=Math.sin(r*s)/o):(c=1-r,a=r),t[0]=c*u+a*d,t[1]=c*h+a*m,t[2]=c*f+a*p,t[3]=c*l+a*w}(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this.L(G,e,n,1);r&&(t=u(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this.L(G,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this.D(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},q(t,e){const n=t.length;let r,s,i,o=0,c=n-1,a=Math.floor((o+c)/2);for(;o<=n-1&&c>=0;){if(o===c)return null;if(t[a]<=e&&e<=t[a+1]){const n=t[a];return r=a,s=a+1,i=(e-n)/(t[a+1]-n),{preIndx:r,nextIndex:s,interpolation:i}}e<t[a]?(c=a,a=Math.floor((o+c)/2)):t[a+1]<e&&(o=a,a=Math.floor((o+c)/2))}return null},L(t,e,n,r){const s=e.input.array,i=e.output.array,o=e.output.itemSize;(n<s[0]||n>s[s.length-1])&&(n=Math.max(s[0],Math.min(s[s.length-1],n))),n===s[s.length-1]&&(n=s[0]);const c=this.q(s,n);if(!c||!c.nextIndex)return null;const{preIndx:a,nextIndex:u,interpolation:h}=c;t.PREINDEX=a,t.NEXTINDEX=u,t.INTERPOLATION=h;const f=o*r;return t.PREVIOUS=i.subarray(t.PREINDEX*f,(t.PREINDEX+1)*f),t.NEXT=i.subarray(t.NEXTINDEX*f,(t.NEXTINDEX+1)*f),t},D(t,e,n,r){const s=e.INTERPOLATION,i=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let n=0;n<3;n++){const c=e.PREVIOUS[r+n],a=(o-i)*e.PREVIOUS[2*r+n],u=e.NEXT[3+n],h=(o-i)*e.NEXT[n],f=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*c+(Math.pow(s,3)-2*Math.pow(s,2)+s)*a+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*h;t[n]=f}return t},getAnimationClip(t,e,n,r){const s=t.nodes[e]&&t.nodes[e].weights;return o(H,...$.TRANSLATION),u(K,...$.ROTATION),o(X,...$.SCALE),this.R(r,t,e,n,H,K,X,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let r=-1/0,s=1/0;const i=e.channels;for(let t=0;t<i.length;t++){const n=i[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:s}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?w(e)?n[e]:n[Object.keys(n)[0]]:null}};let J=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(ft){}t&&"undefined"!=typeof createImageBitmap&&(J=!0)}const W="undefined"==typeof document?null:document.createElement("canvas");class Q{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.h=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=F.read(e.buffer,e.byteOffset,e.byteLength);this.F(t,n,r)}else this.F(t,e);this.V=new U(this.rootPath,this.gltf,this.glbBuffer,this.h,this.options.urlModifier),this.j()}j(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}H(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.V.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this.K(t),n=this.X(),r=this.$(),s=this.H();return Promise.all([e,n,r,s]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,r){return z.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return z.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return _(t)}static readInterleavedArray(t,e,n,r,s,i,o){return O(t,e,n,r,s,i,o)}F(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=J?st.bind(this):this.options.requestImage||Y,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new D(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.h,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new C(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.h,this.options.urlModifier),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}G(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||g(t.children[0])))return t;const r=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this.G(n,e)}));t.children=r}var n;return t}K(t){return this.J(t).then((t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.G(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((r,s,i)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map((e=>t[e]))),this.gltf.scene===r&&(n=i),e.push(o)}),"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.P(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r}))}J(t){return this.W(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r}),"nodes"),t}))}Y(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,r)=>{t.push(this.Z(n).then((t=>{t.index=r,this.skins.push(t)})))}),"skins"),t}Z(t){const e=t.inverseBindMatrices;return this.adapter.accessor.T("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}X(){const t=this.gltf.animations;return w(t)?this.adapter.getAnimations(t):null}W(t){this.meshes={};let e=[];return this.adapter.iterate(((n,r,s)=>{e.push(this.tt(r,t).then((t=>{t.index=s,this.meshes[n]=t})))}),"meshes"),e=e.concat(this.Y()),Promise.all(e)}tt(t,e){const n=t.primitives.map((t=>this.et(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return y(n,t),n.primitives=e,n}))}$(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.N(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image.array;if(n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e}))}et(t,e){let n;const r=[],s=t.extensions;if(w(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const s=this.adapter.accessor.T(\`morphTargets_${hK}t}_${hK}e}\`,n[t]);s&&r.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:i,attributes:o}=s.KHR_draco_mesh_compression,c=this.gltf.bufferViews[i],a=this.V.M(c).then((n=>{const{buffer:r,byteOffset:s}=n;let{byteOffset:i}=c;const a=c.byteLength;i||(i=0);const u=new DataView(r,s+i,a),h={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,h).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));r.push(a),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor.T(t,e[t]);n&&r.push(n)}if(w(t.indices)){const e=this.adapter.accessor.T("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then((e=>{if(s&&s.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const i={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:s}=e,i=s.length/r;for(let e=0;e<i;e++)for(let i=0;i<r;i++){const o=e*r+i;s[o]<t[i]&&(t[i]=s[o]),s[o]>n[i]&&(n[i]=s[o])}if(e.quantization){const r=e.quantization,s=r.range/(1<<r.quantizationBits),i=r.minValues;a(t,t,s),c(t,t,i),a(n,n,s),c(n,n,i)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(i.indices=n),r&&(i.morphTargets=r),i.mode=w(t.mode)?t.mode:4,w(t.extras)&&(i.extras=t.extras),i}))}}function Y(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!W)return void n(new Error("There is no canvas to draw image!"));W.width=r.width,W.height=r.height;const t=W.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),s={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,s)},r.onerror=function(t){n(t)},r.src=t}const Z=[],tt=[],et=30;let nt,rt;function st(t,e,n){nt||(nt=new OffscreenCanvas(2,2),rt=nt.getContext("2d",{willReadFrequently:!0}));let r=null;if(g(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),Z.push([t,e,n,this]),it();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(ot.bind(this)).then((t=>{n(null,t)})).catch((t=>{console.warn(t),n(t)}))}}function it(){if(!Z.length||tt.length>et)return;const t=Z.shift(),[e,n,r,s]=t;tt.push(t),fetch(e,n).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then(ot.bind(s)).then((e=>{r.call(s,null,e);const n=tt.indexOf(t);tt.splice(n,1),it()})).catch((e=>{console.warn(e),r.call(s,e);const n=tt.indexOf(t);tt.splice(n,1),it()}))}function ot(t){let{width:e,height:n}=t;ct(e)||(e=at(e)),ct(n)||(n=at(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),nt.width=e,nt.height=n,rt.drawImage(t,0,0,e,n),t.close();const s=rt.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(s.data)}}function ct(t){return!(t&t-1)&&0!==t}function at(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}\n/*!\n     * @maptalks/gl v0.102.1\n     * LICENSE : UNLICENSED\n     * (c) 2016-2024 maptalks.com\n     */const ut=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},ht=ut(),ft=ht.gl_trans__coders=ht.gl_trans__coders||{};ft.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),s=ht.gl_trans__coders=ht.gl_trans__coders||{};let i=\`${hK}r}\\n    const _____getGlobal = ${hK}ut.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};\`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(i+='tran_____scoders["'+t+'"] ='+s[t].toString()+"\\n;");return i+="\\n"+e.substring(r.length),i},ft.registerTranscoder=function(t,e){ft[t]=e},ft.getTranscoder=function(t){return ft[t]};const lt={"image/crn":ft.crn&&ft.crn(),"image/ktx2":ft.ktx2&&ft.ktx2(),"image/cttf":ft.ktx2&&ft.ktx2(),"draco":ft.draco&&ft.draco()};let dt;const mt={};function pt(t,e,n){return new Q(t,e,n).load({skipAttributeTransform:!0})}function wt(t,e,n,r){const s=e.lastIndexOf("/"),i=e.slice(0,s);r&&(e=r(e));const o=(...e)=>gt.call(this,t,...e);return function(t,e){return N.getArrayBuffer(t,e)}(e,n).then((t=>{if(t.message)return t;const s=t.data;return new DataView(s,s.byteOffset,s.byteLength).getUint32(4,!0)>2?function(t,e){return N.getJSON(t,e)}(e,n).then((t=>t.message?t:pt(i,t,{requestImage:o,decoders:lt,transferable:!0,fetchOptions:n,urlModifier:r}))):pt(i,{buffer:t.data,byteOffset:0},{requestImage:o,decoders:lt,transferable:!0,fetchOptions:n,urlModifier:r})}))}function gt(t,e,n,r){t?mt[e]?mt[e].push(r):(mt[e]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:dt,params:e})):function(t,e){const n=new Image;n.onload=()=>{if(!yt)return void e(new Error("There is no canvas to draw image!"));yt.width=n.width,yt.height=n.height;const t=yt.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,s,[s.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(e,r)}const yt="undefined"==typeof document?null:document.createElement("canvas");t.loadGLTF=wt,t.onmessage=function(t){const e=t.data,n=e.url;if("addLayer"===e.command||"removeLayer"===e.command)dt=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:dt,params:"ok"});else if(n)!function(t){const e=t.data,n=t.callback,r=t.actorId,s=e.url,i=e.fetchOptions||{};i.referrerPolicy=i.referrerPolicy||"origin",i.referrer=e.referrer,wt(r,s,i).then((t=>{t.message?self.postMessage({callback:n,error:t}):self.postMessage({callback:n,data:t},t.transferables)})).catch((t=>{self.postMessage({callback:n,error:t})})),mt.receive=n}(t);else if(e.imageUrl){const t=mt[e.imageUrl];if(delete mt[e.imageUrl],t)for(let n=0;n<t.length;n++)t[n](null,e.result)}}}`;function cK(t){return null==t}function fK(t){return!cK(t)}function dK(t,e){if(!t||!e)return null;let r=e;if(Array.isArray(e)){if(!s.isNumber(e[0]))return null;r=new n(e)}const i=t.coordinateToPointAtRes(r,t.getGLRes()),o=t.altitudeToPoint(r.z||0,t.getGLRes());return[i.x,i.y,o]}function pK(t,e){return Math.abs(t)*Math.sign(e)}function gK(t,e,n){const r=O.Measurer.getInstance().measureLenBetween(t,e),i=n.gapLength+n.bboxWidth;let o=n.count;o&&n.snapToEndVertexes&&(o-=1);const a=o>0?r/o:i,l=Math.floor(r/a),h=[],u=n.map,c=n.rotateAlongLine+function(t,e,n){const r=n.getGLRes(),i=n.coordinateToPointAtRes(t,r),o=n.coordinateToPointAtRes(e,r);return s.computeDegree(o.x,o.y,i.x,i.y)/Math.PI*180}(t,e,u);if(l>=1){const i=0,o=l;if(n.snapToEndVertexes)for(let n=i;n<=o;n++){const i={coordinates:mK(t,e,a*n/r),scale:[1,1,1],rotation:[0,0,c]};h.push(i)}else for(let n=i+1;n<=o;n++){const i={coordinates:mK(t,e,a*(n-.5)/r),scale:[1,1,1],rotation:[0,0,c]};h.push(i)}if(n.scaleEndModel){const n=(r-a*l)/a,i={coordinates:mK(t,e,(a*l+(r-a*l)/2)/r),scale:[n,1,1],rotation:[0,0,c]};h.push(i)}}else if(n.scaleEndModel){const n=r/a,i={coordinates:mK(t,e,.5),scale:[n,1,1],rotation:[0,0,c]};h.push(i)}return h}function mK(t,e,r){const i=AK(t.x,e.x,r),o=AK(t.y,e.y,r);return new n(i,o)}function AK(t,e,n){return t+n*(e-t)}const yK={},vK="undefined"==typeof document?null:document.createElement("canvas");let xK=class extends h.Actor{constructor(t,e){super(t),this.mapId=e.getMap().id,this.t=e}loadGLTF(t){const e={url:function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),referrer:window&&window.location.href,fetchOptions:this.t.options.fetchOptions};return new Promise(((t,n)=>{this.send(e,null,((e,r)=>{e?n(e):t(r)}))}))}sendImageData(t,e){!function(t,e){const n=new Image;n.onload=()=>{if(!vK)return void e(new Error("There is no canvas to draw image!"));vK.width=n.width,vK.height=n.height;const t=vK.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),i={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,i,i.data.buffer)},n.onerror=function(t){e(t)},n.src=t}(t,((n,r)=>{n||this.isActive()&&e(null,{result:r,imageUrl:t})}))}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(r,null,n)}removeLayer(t,e,n){const r={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(r,null,n)}};const _K=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},bK=_K(),wK=bK.gl_trans__coders=bK.gl_trans__coders||{};wK.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=bK.gl_trans__coders=bK.gl_trans__coders||{};let o=`${r}\n    const _____getGlobal = ${_K.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const s in i)"inject"!==s&&"getTranscoder"!==s&&"registerTranscoder"!==s&&(o+='tran_____scoders["'+s+'"] ='+i[s].toString()+"\n;");return o+="\n"+e.substring(r.length),o},wK.registerTranscoder=function(t,e){wK[t]=e},wK.getTranscoder=function(t){return wK[t]};const TK={"image/crn":wK.crn&&wK.crn(),"image/ktx2":wK.ktx2&&wK.ktx2(),"image/cttf":wK.ktx2&&wK.ktx2(),draco:wK.draco&&wK.draco()};let MK;const CK={};function SK(t,e,n){return new gg(t,e,n).load({skipAttributeTransform:!0})}function IK(t,e,n,r){const i=e.lastIndexOf("/"),o=e.slice(0,i);r&&(e=r(e));const s=(...e)=>PK.call(this,t,...e);return(a=e,l=n,Yp.getArrayBuffer(a,l)).then((t=>{if(t.message)return t;const i=t.data;return new DataView(i,i.byteOffset,i.byteLength).getUint32(4,!0)>2?function(t,e){return Yp.getJSON(t,e)}(e,n).then((t=>t.message?t:SK(o,t,{requestImage:s,decoders:TK,transferable:!0,fetchOptions:n,urlModifier:r}))):SK(o,{buffer:t.data,byteOffset:0},{requestImage:s,decoders:TK,transferable:!0,fetchOptions:n,urlModifier:r})}));var a,l}function PK(t,e,n,r){t?CK[e]?CK[e].push(r):(CK[e]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:MK,params:e})):function(t,e){const n=new Image;n.onload=()=>{if(!EK)return void e(new Error("There is no canvas to draw image!"));EK.width=n.width,EK.height=n.height;const t=EK.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),i={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,i,[i.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(e,r)}const EK="undefined"==typeof document?null:document.createElement("canvas"),OK=[],RK=[],kK=[],LK=[],DK=[1,1,1],NK=[],FK=[],zK=[1,1,1],BK=[],HK=new gx,jK=function(t,e){const n=[];return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=0,n[4]=t[3],n[5]=t[4],n[6]=t[5],n[7]=0,n[8]=t[6],n[9]=t[7],n[10]=t[8],n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}(function(t){const e=Math.cos(t),n=Math.sin(t),r=[];return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=e,r[5]=n,r[6]=0,r[7]=-n,r[8]=e,r}(.5*Math.PI),[0,0,0]),UK=new i(0,0),VK=[186/255,186/255,186/255,1],GK={lightAmbient:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightDirection:[1,1,1]},WK=new Set(["url","translationX","translationY","translationZ","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorZ","markerPixelHeight","modelHeight"]),qK=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],XK=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],ZK=[.8,.8,.1,1];let YK=class t extends g{constructor(t,e){const n=s.extend({},e),r=n.symbol;super(t,n),this.options.symbol=r,this.i=!1,this.o=im([]),this.h="gltfmarker",this.l=!0,this.u=!0,this.m={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this.p()}static parseJSONData(e){const n=t.fromJSON(e);return n.setZoomOnAdded(e.zoomOnAdded),n}static fromJSON(e){return new t(e.coordinates,e.options)}static getGLTFAnchorsAlongLineString(t,e,n,r){const i=[];for(let o=0;o<t.length-1;o++){const a=gK(t[o],t[o+1],{map:n,bboxWidth:e,gapLength:r.gapLength||0,count:r.count,rotateAlongLine:r.rotateAlongLine,snapToEndVertexes:r.snapToEndVertexes,scaleEndModel:r.scaleEndModel});s.pushIn(i,a)}return i}static combineGLTFBoundingBox(t){const e=[];for(let o=0;o<t.length;o++){const n=t[o].getBoundingBox();e.push([n.min,n.max])}const n=e[0];if(!n)return null;const r=km([],n[0]),i=km([],n[1]);for(let o=1;o<e.length;o++){const t=e[o],n=km([],t[0]),s=km([],t[1]);n[0]<r[0]&&(r[0]=n[0]),n[1]<r[1]&&(r[1]=n[1]),n[2]<r[2]&&(r[2]=n[2]),s[0]>i[0]&&(i[0]=s[0]),s[1]>i[1]&&(i[1]=s[1]),s[2]>i[2]&&(i[2]=s[2])}return{min:r,max:i}}setTransformOrigin(t){this._=t}getTransformOrigin(){return this._||this.getCenter()}getMeshes(t,e,n){let r=[];const i=this.getMap();if(e&&(this.regl=e),this.getLayer().isVisible()&&this.isVisible()&&this.T()){if(!this.v)return this.M(t,e),r;let o=this.isAnimated()||this.O()&&i.isZooming()||this.u||"multigltfmarker"===this.getGLTFMarkerType()&&this.l;if(!o){const t=this.o;rm(NK,t),this.p(),o=!Cm(t,NK)}o&&this.A(this.v,n),r=this.v.filter((t=>!!(Jq(i.projViewMatrix,t.getBoundingBox())||t instanceof u_)&&(this.S(t),this.I(t),!0))),this.P(!1)}return r}getGLTFJSON(){return this.k}getAllMeshes(){return this.v}L(){return this.k}N(t){this.k=t}C(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this.R=!0)}setUrl(t){return this.updateSymbol({url:t}),this}setSymbol(t){const e=this.getUrl();super.setSymbol(t);const n=this.getShader(),r=this.B;r&&t.url!==e&&(r.logoutGLTF(e),this.F=!1,this.D(!1),delete this.v),this.U&&this.U!==n&&this.V(r,this.regl),this.U=n,this.R=!0,this.l=!0}getCenter(){const t=this.getMap();if(!t)return null;const e=dK(t,super.getCenter()||this.getCoordinates());if(!e)return null;const n=this.q(),r=new i([e[0]+n[0],e[1]+n[1],e[2]+n[2]]),o=t.getGLRes(),s=t.pointAtResToCoord(r,o);return s.z=r.z/t.altitudeToPoint(100,o)*100,s}getPointZ(){const t=this.getCoordinates(),e=this.getMap();return e&&t?e.altitudeToPoint(t.z||0,e.getGLRes()):null}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.getLayer())throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}M(t,e){const n=this.getUrl();if(this.B=t,!this.F){const e=this.getLayer().getRenderer();t.loginGLTF(n,((...t)=>e.G.apply(e,t))),this.F=!0}const r=t.getGLTF(n);r&&!r.then&&(this.D(!0),this.j(r,t,e))}S(t,e){"effectmarker"===this.getGLTFMarkerType()?this.updateUV(e):"glowmarker"===this.getGLTFMarkerType()&&this.X();const n=this.getUniforms();if(n&&this.isDirty()&&this.H())for(const r in n)t.setUniform(r,n[r]);this.J()&&(t.transparent=!0),t.setUniform("uPickingId",this.W()),t.properties.isAnimated=this.isAnimated()}I(t){const e=this.getShader(),n=t.getDefines();let r=!1;if("pbr"===e||"pbr-lite"===e){const t=this.getLayer(),{iblTexes:e}=xT.PBRUtils.getIBLResOnCanvas(t.getRenderer().canvas);e?n.HAS_IBL_LIGHTING||(n.HAS_IBL_LIGHTING=1,r=!0):n.HAS_IBL_LIGHTING&&(r=!0,delete n.HAS_IBL_LIGHTING)}r&&t.setDefines(n);const i=this.getLayer().getRenderer();i&&i.updateMaskDefines(t)}V(t){const e=this.getUrl(),n=this.v;t&&n&&(t.isSimpleModel(e)?this.Z(n):t.getGLTF(e)&&(n.forEach((t=>{this.S(t)})),this.Z(n)))}Z(t){const e=this.getShader();t.forEach((t=>{const n=this.Y(t.properties.geometryResource);"wireframe"===e?(t.properties.geometryResource&&!t.properties.geometryResource.copyGeometry&&t.properties.geometryResource.copyEdgeGeometry(),t.geometry=t.properties.geometryResource.copyGeometry):t.geometry=t.properties.geometryResource.geometry,t.material=n}))}A(t,e){Lm(DK,1,1,1);const n=im(NK),r=this.isAnimated();this.p();const i=this.getModelMatrix(),{nodeMatrixMap:o,skinMap:s}=this.K(e);this.$(DK);let a=0;t.forEach((t=>{const e=t.properties.geometryResource.nodeIndex,l=o[e],h=r&&l?l:t.nodeMatrix;hm(n,i,DK),am(n,n,jK),t.tt=t.tt||im([]);const u=am(BK,t.tt,h);t instanceof u_?(t.positionMatrix=am(t.positionMatrix,n,u),t.localTransform=this.et(),this.nt(t)):t.localTransform=am(t.localTransform,n,u);const c=t.geometry.boundingBox.copy(HK);c.transform(t.positionMatrix,t.localTransform);const f=this.st(c);if(Math.abs(f)>Math.abs(a)&&(a=f),r){const n=s[e];n&&(t.material.set("skinAnimation",1),t.material.set("jointTextureSize",n.jointTextureSize),t.material.set("numJoints",n.numJoints),t.material.set("jointTexture",n.jointTexture));const r=t.geometry.properties.morphWeights;r&&this.it(r,t.material)}else t.material.set("skinAnimation",0)}));const l=this.rt();if(l&&(hm(n,i,DK),am(n,n,jK),this.ot.localTransform=am(this.ot.localTransform,n,this.ot.ht)),0!==a){Lm(FK,0,0,a);const e=cm(NK,FK);t.forEach((t=>{if(t instanceof u_)t.positionMatrix=am(t.positionMatrix,e,t.positionMatrix),this.nt(t);else{const n=am(t.localTransform,e,t.localTransform);t.localTransform=n}})),l&&(this.ot.localTransform=am(this.ot.localTransform,e,this.ot.localTransform))}t.forEach((t=>{t instanceof u_&&this.nt(t)})),this.fire("updatematrix",{target:this})}getBoundingBoxCenter(){const t=this.ct,e=this.getMap();if(!t||!this.ot||!e)return null;const n=e.getGLRes(),{min:r,max:o}=t,s=Dm([],r,o);Bm(s,s,.5),Xm(s,s,this.ot.localTransform);const a=new i(s),l=e.pointAtResToCoordinate(a,n);return l.z=100/e.altitudeToPoint(100,n)*s[2],l}getBoundingBoxWidth(t){const e=this.ct;if(!e)return 0;let n=0;"x"===t?n=0:"y"===t?n=2:"z"===t&&(n=1);const{min:r,max:i}=e,o=this.lt()[n];return(i[n]-r[n])*o}getAxisXWidth(){return this.getBoundingBoxWidth("x")}getAxisYWidth(){return this.getBoundingBoxWidth("y")}getAxisZWidth(){return this.getBoundingBoxWidth("z")}$(t){const e=this.getMap(),n=e.getGLRes(),r=e.altitudeToPoint(100,n);return t[0]*=r/100,t[1]*=r/100,t[2]*=r/100,t}ut(t,e){const n=this.ct,r=e/Math.abs(n.max[1]-n.min[1]);return Lm(t,r,r,r)}ft(t,e){const n=this.ct;if(!e||e<0||!n)return t;const r=this.getMap(),i=Math.abs(n.max[1]-n.min[1]),o=r.altitudeToPoint(i,r.getGLRes()),s=e*r.getGLScale()/o;return Lm(t,s,s,s)}getCurrentPixelHeight(){const t=this.getBoundingBox();return Math.abs(t.max[2]-t.min[2])/this.getMap().getGLScale()}getFitTranslate(t){const e=this.ct,n=Lm(t,(e.min[0]+e.max[0])/2,(e.min[1]+e.max[1])/2,(e.min[2]+e.max[2])/2);return Bm(n,n,-1)}st(t){const e=this.getSymbol(),n=e&&e.anchorZ||"center";let r=0;const i=t.max[2]-t.min[2];return"bottom"===n?r=i/2:"top"===n&&(r=-i/2),r}K(t){const e=this.isAnimated(),n=this.dt(),r={},i=this.gt();if(t&&e&&this.gltfPack&&n){const e=this.bt();if(fK(e)){this.yt(t);const n=this._t(),o=this.isAnimationLooped(),s=this.getAnimationSpeed(),a=this.getSymbol(),l=a&&a.animationNodes;for(let h=0;h<e.length;h++)this.gltfPack.updateAnimation(t,o,s,e[h],n,r,i,l)}else console.warn("animation specified does not exist!")}return{nodeMatrixMap:r,skinMap:i}}j(t,e,n){const r=this.getUrl();this.N(t.json),this.wt(r,e,n),this.V(e,n),this.createdBygltfmarker||(this.fire("load",{data:t.json}),this.fire("setUrl-debug"),this._fireEvent("meshcreate",{url:r}))}wt(t,e,n){const r=[],i=this.getShader(),o=e.getGLTF(t);if(o&&o.resources){if(!o.resources.length)return void this._fireEvent("modelerror",{url:t,info:"there are no geomtries in the gltf model"});this.gltfPack=o.gltfPack,o.resources.forEach((t=>{const e=this.xt(t,i,n);r.push(e)}))}this.v=r,this.ct=this.Tt(),this.vt(this.v),this.fire("createscene-debug",{meshes:this.v})}vt(t){this.A(t);const e=this.getBoundingBox();if(!e)return;const n=this.getMap(),{max:r,min:i}=e;Om([r[0]-i[0],r[1]-i[1],r[2]-i[2]])/n.getGLScale()<20&&(console.warn("Model's size on screen is too small, try to increase its symbol.scaleX/Y/Z"),this.fire("smallonscreen"))}rt(){if(this.ot)return this.ot.material.set("lineColor",this.Mt||ZK),this.ot.material.set("lineOpacity",this.Ot||1),this.ot;const t=this.ct;if(!t)return null;const{min:e,max:n}=t;qK[0]=n[0],qK[1]=e[1],qK[2]=n[2],qK[3]=n[0],qK[4]=n[1],qK[5]=n[2],qK[6]=e[0],qK[7]=n[1],qK[8]=n[2],qK[9]=e[0],qK[10]=e[1],qK[11]=n[2],qK[12]=n[0],qK[13]=e[1],qK[14]=e[2],qK[15]=n[0],qK[16]=n[1],qK[17]=e[2],qK[18]=e[0],qK[19]=n[1],qK[20]=e[2],qK[21]=e[0],qK[22]=e[1],qK[23]=e[2];const r=new bx({POSITION:qK},XK,0,{primitive:"lines",positionAttribute:"POSITION"});r.generateBuffers(this.regl);const i=new h_(r,new Kx({lineColor:this.Mt||ZK,lineOpacity:this.Ot||1}));return this.ot=i,this.ot.ht=rm([],i.localTransform),i}showBoundingBox(t){this.options.showDebugBoundingBox=!0,this.Mt=t&&t.lineColor,this.Ot=t&&t.lineOpacity,this.l=!0}hideBoundingBox(){this.options.showDebugBoundingBox=!1,this.l=!0}getBoundingBox(){const t=this.v;if(!t||!t.length)return null;if(!this.u)return this.At;"multigltfmarker"===this.getGLTFMarkerType()&&t.forEach((t=>{this.nt(t),t.updateBoundingBox()}));const e=t[0].getBoundingBox(),n=km([],e[0]),r=km([],e[1]);for(let o=1;o<t.length;o++){const e=t[o].getBoundingBox(),i=km([],e[0]),s=km([],e[1]);i[0]<n[0]&&(n[0]=i[0]),i[1]<n[1]&&(n[1]=i[1]),i[2]<n[2]&&(n[2]=i[2]),s[0]>r[0]&&(r[0]=s[0]),s[1]>r[1]&&(r[1]=s[1]),s[2]>r[2]&&(r[2]=s[2])}const i={min:n,max:r};return this.At=i,this.u=!1,i}Tt(){return this.gltfPack.getGLTFBBox()}xt(t,e,n){const r=t,i=this.St(r,e,n),o=i.getDefines();return i instanceof u_?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,i.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),o.HAS_MIN_ALTITUDE=1,o.HAS_LAYER_OPACITY=1,i.setDefines(o),i}St(t,e,n){const r=this.getGLTFMarkerType();let i=null;const o=this.Y(t);let s=t.geometry;if("wireframe"===e&&(t.copyEdgeGeometry(),s=t.copyGeometry),n?s.generateBuffers(n):(this.It=this.It||[],this.It.push(s)),"multigltfmarker"===r){this.Et();const t=this.Pt(im(LK)),e=this.kt();i=new u_(t.attributesData,e,s,o),i.setUniform("instance",1),n?i.generateInstancedBuffers(n):(this.Lt=this.Lt||[],this.Lt.push(i))}else i=new h_(s,o),i.setUniform("instance",0);i.nodeMatrix=rm([],t.nodeMatrix),i.properties.geometryResource=t,i.properties.nodeIndex=t.nodeIndex,this.isBloom()&&(i.bloom=1),i.transparent=this.J(),"BLEND"===t.extraInfo.alphaMode&&(i.transparent=!0),i.properties.pickingId=this.W(),this.Nt(i);const a=this.getLayer();return Object.defineProperty(i.uniforms,"minAltitude",{enumerable:!0,get:()=>a.options.altitude||0}),i}Y(t){let e=null;const n=this.getShader(),r=this.getUniforms()||{},i=t.materialInfo||{},o=this.getLayer().getRenderer();if("phong"===n)if("pbrSpecularGlossiness"===i.name)e=new s_(i);else{for(const t in GK)r[t]=r[t]||GK[t];e=new e_(i)}else if("pbr"===n){if(e="pbrSpecularGlossiness"===i.name?new xT.StandardSpecularGlossinessMaterial(i):new xT.StandardMaterial(i),o.regl&&!xT.PBRUtils.isSupported(o.regl)){e=e_.convertFrom(e);for(const t in GK)r[t]=r[t]||GK[t]}}else e="pbr-lite"===n?new r_(i):new Kx(i);const s=this.getSymbol(),a=s&&s.doubleSided;fK(a)&&(e.doubleSided=a);for(const l in r)e.set(l,r[l]);return t.morphWeights&&this.it(t.morphWeights,e),t.skin&&e.set("skinAnimation",0),e}it(t,e){const n=e.get("morphWeights1")||[],r=e.get("morphWeights2")||[];for(let i=0;i<4;i++)n[i]=t[i]||0,r[i]=t[i+4]||0;e.set("morphWeights1",n),e.set("morphWeights2",r)}Nt(t){const e=this.getSymbol();e&&e.uniforms?(t.setUniform("polygonFill",e.uniforms.polygonFill||VK),t.setUniform("polygonOpacity",void 0===e.uniforms.polygonOpacity?1:e.uniforms.polygonOpacity),t.setUniform("lineColor",e.uniforms.lineColor||VK),t.setUniform("lineOpacity",void 0===e.uniforms.lineOpacity?1:e.uniforms.lineOpacity)):(t.setUniform("polygonFill",VK),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",VK),t.setUniform("lineOpacity",1))}Ct(){const t=this.getLayer();if(!t)return null;const e=t.getMap();if(!e)return null;const n=this.getBoundingBox();if(!n)return null;const r=this.getPointZ()||0,i=n.min,o=n.max,s=cA(RK,(i[0]+o[0])/2,(i[1]+o[1])/2,i[2]+r,1),a=cA(kK,(i[0]+o[0])/2,(i[1]+o[1])/2,o[2]+r,1),l=TA(s,s,e.projViewMatrix),h=TA(a,a,e.projViewMatrix),u=(l[0]/l[3]+1)*e.width/2,c=(1-l[1]/l[3])*e.height/2,d=(h[0]/h[3]+1)*e.width/2,p=(1-h[1]/h[3])*e.height/2,g=Math.min(u,d),m=Math.max(u,d),A=Math.min(c,p),y=Math.max(c,p);return new f({xmin:g,ymin:A,xmax:m,ymax:y})}onAdd(){const t=this.getLayer().getMap();if(t&&!fK(this.Rt)){const e=t.getZoom();this.Rt=e}}onRemove(){this.Bt()}remove(){const t=this.getUrl();if(this.B&&(delete this.v,this.B.logoutGLTF(t),delete this.B),this.Ft){for(const t in this.Ft)this.Ft[t]&&this.Ft[t].jointTexture&&this.Ft[t].jointTexture.destroy();delete this.Ft}this.ot&&(this.ot.geometry.dispose(),this.ot.dispose(),delete this.ot),this.v&&this.v.forEach((t=>{t.dispose(),t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)})),this.F=!1,delete this.k,delete this.gltfPack,super.remove()}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return this.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&(t.shadow||void 0===t.shadow)}outlineNodes(t){const e=this.v;return e?(e.forEach((e=>{t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!0)})),this.l=!0,this):this}outline(){this.updateSymbol({outline:!0});const t=this.v;return t?(t.forEach((t=>{t.properties.outline=!0})),this.l=!0,this):this}cancelOutline(t){this.updateSymbol({outline:!1});const e=this.v;return e?(e.forEach((e=>{t?t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!1):e.properties.outline=!1})),this.l=!0,this):this}isOutline(){const t=this._getInternalSymbol();return!(!t||!fK(t.outline))&&t.outline}isVisible(){const t=this._getInternalSymbol();return!t||!fK(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.l=!0,this.u=!0,this}copy(){const e=this.toJSON(),n=t.fromJSON(e);return n.setZoomOnAdded(this.Rt),n}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this.R=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const n=this.getUniforms()||{};return n[t]=e,super.updateSymbol({uniforms:n}),this.R=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.k&&this.k.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),delete this.Dt,this}setAnimationLoop(t){return super.updateSymbol({loop:t}),delete this.Dt,this.l=!0,this}isAnimationLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&fK(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}Ut(t){const e=this.getMap();return e?dK(e,t||this.getCoordinates()):null}setTRS(t,e,n){const r=t||this.m.translation;return this.updateSymbol({translationX:r[0],translationY:r[1],translationZ:r[2],rotationX:e[0],rotationY:e[1],rotationZ:e[2],scaleX:n[0],scaleY:n[1],scaleZ:n[2]}),this}Vt(){const t=this.q(),e=this.Ut();return e?Dm(t,t,e):t}updateSymbol(t){for(const e in t)if("bloom"===e&&this.v&&this.v.forEach((n=>{n.bloom=+!!t[e]})),WK.has(e)){this.u=!0;break}return super.updateSymbol(t)}setTranslation(t,e,n){return this.updateSymbol({translationX:t,translationY:e,translationZ:n}),this}setRotation(t,e,n){return this.updateSymbol({rotationX:t,rotationY:e,rotationZ:n}),this}rotateAround(t,e){const n=this.getMap();if(!n)return;const r=n.getGLRes();let i=this.getCoordinates();const o=n.coordinateToPointAtRes(i,r),s=n.coordinateToPointAtRes(t,r),a=o.x-s.x,l=o.y-s.y,h=180*Math.atan2(l,a)/Math.PI+e,u=Math.sqrt(a*a+l*l),c=Math.PI*h/180,f=u*Math.cos(c)+s.x,d=u*Math.sin(c)+s.y;UK.set(f,d),i=n.pointAtResToCoordinate(UK,r),this.setCoordinates(i),this.updateSymbol({rotationZ:h})}setScale(t,e,n){return this.updateSymbol({scaleX:t,scaleY:e,scaleZ:n}),this}getTranslation(){const t=this._getInternalSymbol(),e=t&&t.translationX||0,n=t&&t.translationY||0,r=t&&t.translationZ||0;return Lm(this.m.translation,e,n,r)}q(){const t=this.getTranslation();return this.getMap()?this.qt(t):this.m.translation}qt(t){const e=this.getMap(),n=e.distanceToPointAtRes(t[0],t[1],e.getGLRes(),UK),r=e.altitudeToPoint(t[2],e.getGLRes());return Lm(FK,pK(n.x,t[0]),pK(n.y,t[1]),pK(r,t[2]))}getRotation(){const t=this._getInternalSymbol(),e=t&&t.rotationX||0,n=t&&t.rotationY||0,r=t&&t.rotationZ||0;return Lm(this.m.rotation,e,n,r)}getScale(){const t=this._getInternalSymbol(),e=t&&t.scaleX||1,n=t&&t.scaleY||1,r=t&&t.scaleZ||1;return Lm(this.m.scale,e,n,r)}lt(){const t=this.getScale();if(this.ct){const e=this.O(),n=this.getModelHeight();if(e&&e>0){const n=this.ft(zK,e);return Fm(n,n,t)}if(n){const e=this.ut(zK,n);return Fm(e,e,t)}}return t}cancelMarkerPixelHeight(){return this.updateSymbol({markerPixelHeight:null})}setAnchorZ(t){return this.updateSymbol({anchorZ:t}),this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.l=!0,super._setExternSymbol(t)}Gt(t){return sO(t,(()=>{const t=this.getMap();return t?[t.getZoom()]:null}))}_prepareSymbol(t){super._prepareSymbol(t);const e=this.Gt(t);return e&&e.uniforms&&(e.uniforms=this.Gt(t.uniforms)),delete this.jt,e}hasFunctionDefinition(){if(fK(this.jt))return this.jt;const t=this._getInternalSymbol();return this.jt=rO(t)||t&&t.uniforms&&rO(t.uniforms),this.jt}setModelMatrix(t){const e=gm(this.m.translation,t),n=Am(this.m.rotation,t),r=mm(this.m.scale,t);return this.setTranslation(e[0],e[1],e[2]),this.setRotation(n[0],n[1],n[2]),this.setScale(r[0],r[1],r[2]),this}getModelMatrix(){return this.o}p(){const t=this.Vt(),e=this.getRotation(),n=XA(OK,e[0],e[1],e[2]),r=this.lt();this.o=ym(this.o,n,t,r)}isDirty(){return this.l}P(t){return this.l=t,this}Xt(){const t=this.toJSON();return t.zoomOnAdded=this.Rt,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{},type:"GLTFMarker"})),e=this.getId();s.isNil(e)||(t.options.id=e);const n=this.getProperties();n&&(t.options.properties=JSON.parse(JSON.stringify(n)));const r=this.getSymbol();return r&&(t.options.symbol=JSON.parse(JSON.stringify(r))),t}setZoomOnAdded(t){this.Rt=t}getZoomOnAdded(){return this.Rt}J(){return this.T()<1}T(){const t=this.getUniforms(),e=this.getShader();return"pbr"===e||"phong"===e?t&&fK(t.polygonOpacity)?t.polygonOpacity:1:"wireframe"===e&&t&&fK(t.lineOpacity)?t.lineOpacity:1}D(t){this.i=t}isLoaded(){return this.i}getGLTFMarkerType(){return this.h}Ht(t){this.zt=t}W(){return this.zt}getCount(){return 1}getContainerExtent(){return this.Ct()}getGLTFAsset(){return this.k&&this.k.asset}openInfoWindow(t){this.k?super.openInfoWindow(t):this.once("load",(()=>{super.openInfoWindow(t)}))}getAnimations(){if(!this.k)return null;const t=this.k,e=t.animations?t.animations.map(((t,e)=>({name:fK(t.name)?t.name:e}))):null;return e?e.map(((t,e)=>t.name||e)):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}bt(){const t=this.getAnimations();if(!t)return null;let e=this.getCurrentAnimation();if(!fK(e))return t.slice(0,1);const n=[];e=Array.isArray(e)?e:[e];for(let r=0;r<e.length;r++)t.indexOf(e[r])>-1&&n.push(e[r]);return n.length?n:null}setCurrentAnimation(t){this.updateSymbol({animationName:t})}yt(t){fK(this.Dt)||(this.Dt=t)}_t(){return this.Dt||0}gt(){return this.Ft=this.Ft||{},this.Ft}O(){const t=this._getInternalSymbol();return t&&t.markerPixelHeight}setModelHeight(t){return this.updateSymbol({modelHeight:t}),this}getModelHeight(){const t=this._getInternalSymbol();return t&&t.modelHeight}getGLTFBBox(){return this.ct}zoomTo(t,e={animation:!1}){const n=this.getBoundingBox(),r=this.getMap();if(!r||!n)return;const{min:i,max:o}=n;UK.set(i[0],i[1]);const s=r.pointAtResToCoordinate(UK,r.getGLRes());UK.set(o[0],o[1]);const a=r.pointAtResToCoordinate(UK,r.getGLRes()),l=new f(s,a);r.fitExtent(l,t,e,(t=>{"finished"===t.state.playState&&this.Jt(i,o,l)})),!1===e.animation&&this.Jt(i,o,l)}Jt(t,e,n){const r=this.getMap(),o=r.getGLRes(),s=(t[2]+e[2])/2/r.altitudeToPoint(1,o),a=r.cameraPosition,l=r.pointAtResToCoordinate(new i(a),o),h=a[2]/r.altitudeToPoint(1,o);l.z=h+s,r.setCameraOrientation({position:[l.x,l.y,l.z],pitch:r.getPitch(),bearing:r.getBearing()}),this.fire("zoomtoend",{target:this,extent:n})}H(){return this.R}Wt(){this.R=!1}setAnimationTimeframe(t){const e=this._t(),n=this.gt();this.gltfPack.updateAnimation(t,this.isAnimationLooped(),this.getAnimationSpeed(),e,{},n)}Bt(){delete this.At,delete this.Rt}dt(){return"effectmarker"!==this.getGLTFMarkerType()&&"glowmarker"!==this.getGLTFMarkerType()}_onEvent(t,e){const n=this.getLayer();if(!n)return;const r=n.getId();this.Zt=t.gltfPickingInfo&&t.gltfPickingInfo[r]||{},super._onEvent(t,e)}_fireEvent(t,e){for(const n in this.Zt)e[n]=this.Zt[n];delete this.Zt,super._fireEvent(t,e)}Yt(){let t=[];return this.v&&this.isVisible()&&this.T()?this.isOutline&&this.isOutline()?this.v:(t=this.v.filter((t=>t.properties.outline)),t):t}highlightNodes(t){const e=this.v;e?this.Kt(t,e):this.once("load",(()=>{this.Kt(t,this.v)}),this)}Kt(t,e){t.forEach((t=>{e.forEach((e=>{e.properties.nodeIndex===t.nodeIndex&&this.$t(e,t.color,t.opacity,t.bloom)}))})),this.l=!0}highlight(t){const{color:e,opacity:n,bloom:r}=t,i=this.v;i?(i.forEach((t=>{this.$t(t,e,n,r)})),this.l=!0):this.once("load",(()=>{this.v.forEach((t=>{this.$t(t,e,n,r)})),this.l=!0}),this)}$t(t,e,n,r){t.properties.polygonFill||(t.properties.polygonFill=t.getUniform("polygonFill")||VK),t.properties.polygonOpacity||(t.properties.polygonOpacity=t.getUniform("polygonOpacity")||1),t.setUniform("polygonFill",e||VK),t.setUniform("polygonOpacity",n||1),t.bloom=r}Qt(){if(this.te)if(Array.isArray(this.te)){const t=this.te.map((t=>t.nodeIndex));this.cancelHighlight(t)}else this.cancelHighlight(this.te.nodeIndex)}cancelHighlight(t){const e=this.getLayer();if(!e)return;const n=e.getRenderer();if(!n)return;let r=this.v;if(r){if(t){let e=t;Array.isArray(e)||(e=[e]),r=r.filter((t=>e.indexOf(t.properties.nodeIndex)>-1))}r.forEach((t=>{const{polygonFill:e,polygonOpacity:n}=t.properties;t.setUniform("polygonFill",e),t.setUniform("polygonOpacity",n),t.bloom=!1})),n.setToRedraw()}}setNodeTRS(t,e={}){const n=this.v;if(!n)return;const r=e.translation||this.m.translation,i=e.rotation||this.m.rotation,o=XA(OK,i[0],i[1],i[2]),s=e.scale||this.m.scale;return n.forEach((e=>{e.properties.nodeIndex===t&&(e.tt=ym(e.tt||[],o,r,s))})),this.A(n),this.l=!0,this}};YK.mergeOptions({symbol:null}),YK.registerJSONType("GLTFMarker");const JK=[1,1,1,1],QK=[],KK=[],$K=[1,1,1],t$=new n(0,0),e$=[1,1,1],n$=[1,1,1];let r$=class t extends YK{constructor(t,e){super(null,e),this.ee=t||[],this.ne=[],this.se=[0,0,0],this.ie=im([]),this.h="multigltfmarker",this.re=[]}static fromJSON(e){return new t(e.data,e.options)}setCoordinates(t){return Array.isArray(t[0])?this.oe=t.map((t=>new n(t))):this.oe=t,this.updateAllData("coordinates",this.oe),this.l=!0,this}getCoordinates(t){if(t&&this.ee&&this.ee.length){const e=t.index;return this.ee[e].coordinates}return null}addData(t){return this.ee||(this.ee=[]),this.ee.push(t),this.l=!0,this}removeData(t){this.ee.splice(t,1),this.ne&&this.ne.splice(t,1);const e=this.getLayer();return e&&e.ae(),this.l=!0,this}getData(t){return this.ee[t]}updateData(t,e,n){return this.ee[t][e]=n,this.l=!0,this}getAllData(){return this.ee}updateAllData(t,e){for(let n=0;n<this.ee.length;n++)this.updateData(n,t,e[n]);return this}removeAllData(){this.ee&&(this.ee=[],this.ne=[],this.l=!0)}Et(){const t=this.getMap();if(this.ee&&t){this.he(),this.ne=this.ne||[];for(let t=0;t<this.ee.length;t++)if(!1!==this.ee[t].visible){const e=this.ce(t);this.ne[t]=e}}}openInfoWindow(t){let e=null;e=fK(t)&&this.ee[t]?this.ee[t].coordinates:this.getCenter(),super.openInfoWindow(e)}getCenter(){let t=0,e=0,r=0,i=0;for(let o=0,s=this.ee.length;o<s;o++){let s=this.ee[o].coordinates;s instanceof n&&(s=s.toArray()),t+=s[0],e+=s[1],r+=s[2]||0,i++}return 0===i?null:t$.set(t/i,e/i,r/i)}getMap(){return super.getMap()||this.t&&this.t.getMap()}le(t){this.t=t}getLayer(){return super.getLayer()||this.t}he(){const t=this.getMap(),e=this.getCenter();if(!e)return;this.se=dK(t,e);const n=XA(KK,0,0,0);ym(this.ie,n,this.se,$K)}ce(t){const e=this.ee[t],n=this.Ut(e.coordinates);if(!n)return null;const r=Km(QK,n,this.se),i=this.qt(e.translation||this.m.translation),o=Dm(QK,i||this.m.translation,r||this.m.translation),s=e.rotation||this.m.rotation,a=this.ue(t),l=XA(KK,s[0]||0,s[1]||0,s[2]||0);return ym(this.ne[t]||[],l,o,a)}ue(t){const e=this.ee[t],{modelHeight:n,markerPixelHeight:r}=e,i=e.scale||this.m.scale;if(this.ct){if(r&&r>0){const t=this.ft(e$,r);return Fm(t,t,i)}if(n){const t=this.ut(e$,n);return Fm(t,t,i)}}return i}D(t){if(super.D(t),this.ee)for(let e=0;e<this.ee.length;e++){const n=this.ee[e];n.target&&n.target instanceof YK&&n.target.D(t)}}p(){super.p(),this.Et()}fe(){this.de={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]},this.me={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]};for(let t=0;t<this.ne.length;t++){let e=this.de;this.ee[t].bloom&&(e=this.me);const n=this.ne[t],r=e.instance_vectorA.length/4;this.ge(e,"instance_vectorA",r,n,0),this.ge(e,"instance_vectorB",r,n,1),this.ge(e,"instance_vectorC",r,n,2);const i=this.ee[t].color||JK,o=this.ee[t].highlightColor||JK;e.instance_color[4*r]=i[0],e.instance_color[4*r+1]=i[1],e.instance_color[4*r+2]=i[2],e.instance_color[4*r+3]=i[3],e.aPickingId[r]=this.W()+t,e.aOutline[r]=this.ee[t].outline?1:0,e.highlight_color[4*r]=o[0],e.highlight_color[4*r+1]=o[1],e.highlight_color[4*r+2]=o[2],e.highlight_color[4*r+3]=o[3],e.aBloom[r]=this.ee[t].bloom?1:0}return{attributesData:this.de,bloomAttributesData:this.me}}nt(t){const{attributesData:e,bloomAttributesData:n}=this.Pt();for(const r in e)t.updateInstancedData(r,e[r]);if(this.regl?t.generateInstancedBuffers(this.regl):(this.Lt=this.Lt||[],this.Lt.push(t)),t.instanceCount=this.de.instance_vectorA.length/4,this.pe()){const e=n,r=e.aBloom.length;t.properties.bloomMesh=t.properties.bloomMesh||new u_(e,r,t.geometry,t.material);const i=t.properties.bloomMesh;i.positionMatrix=t.positionMatrix,i.localTransform=t.localTransform;for(const t in e)i.updateInstancedData(t,e[t]);i.generateInstancedBuffers(this.regl);const o=t.getDefines();i.setDefines(o),i.uniforms=t.uniforms,i.bloom=1,i.instanceCount=r}else t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)}be(t,e,n,r){this.me[t]&&n&&(this.me[t][4*e]=n[r],this.me[t][4*e+1]=n[r+4],this.me[t][4*e+2]=n[r+8],this.me[t][4*e+3]=n[r+12])}pe(){return this.me&&this.me.aBloom.length}ge(t,e,n,r,i){t[e]&&r&&(t[e][4*n]=r[i],t[e][4*n+1]=r[i+4],t[e][4*n+2]=r[i+8],t[e][4*n+3]=r[i+12])}Pt(t){return!this.l&&this.de?{attributesData:this.de,bloomAttributesData:this.me}:this.fe(t)}et(){return this.ie}getCount(){return this.ee.length}ye(){return this.Et(),this.me?this.me.aBloom.length:0}kt(){return this.getCount()-this.ye()}toJSON(){const t=JSON.parse(JSON.stringify({data:this.ee,options:this.options,type:"MultiGLTFMarker"})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.W()}outline(t){return fK(t)&&this.updateData(t,"outline",!0),this}cancelOutline(t){return fK(t)&&this.updateData(t,"outline",!1),this}isOutline(){if(!this.ee||!this.ee.length)return!1;for(let t=0;t<this.ee.length;t++)if(this.ee[t].outline)return!0;return!1}J(){const t=this.getAllData();for(let e=0;e<t.length;e++){const n=t[e].color;if(n&&n[3]<1)return!0}return!1}highlightNodes(t,e){const n=this.v;if(!n)return;const r=this.ee[t];r&&(e.forEach((t=>{n.forEach((e=>{if(e.properties.nodeIndex===t.nodeIndex){const{color:n,opacity:i,bloom:o}=t;r.highlightColor=n||n$,r.highlightColor[3]=i||1,r.highlightBloom=o;const s=e.getDefines();s.HAS_INSTANCE_HIGHLIGHT=1,e.setDefines(s)}}))})),this.l=!0)}highlight(t,e){const{color:n,opacity:r,bloom:i}=e,o=this.v;if(!o)return;const s=this.ee[t];s&&(s.highlightColor=n||n$,s.highlightColor[3]=r||1,s.highlightBloom=i,o.forEach((t=>{const e=t.getDefines();e.HAS_INSTANCE_HIGHLIGHT=1,t.setDefines(e)})),this.l=!0)}cancelHighlight(t,e){let n=this.v;if(!n)return;const r=this.ee[t];if(r){if(e){let t=e;Array.isArray(t)||(t=[t]),n=n.filter((e=>t.indexOf(e.properties.nodeIndex)>-1))}n.forEach((t=>{const e=t.getDefines();delete e.HAS_INSTANCE_HIGHLIGHT,t.setDefines(e),r.highlightColor=n$,r.highlightColor[3]=1,r.highlightBloom=0})),this.l=!0}}};r$.registerJSONType("MultiGLTFMarker");const i$=[],o$=[],s$=["points","lines","line strip","line loop"];let a$=class extends(jI(r.OverlayLayerCanvasRenderer)){constructor(t){super(t),this._e={},this.we=[],this.xe={}}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){this.prepareCanvas(),this.Te(e,t)}drawOnInteracting(t,e,n){this.Te(n,e)}Te(t,e){this.ve=t,this.Me=e;let n=0;this.Oe(t),this.Ae={},this.Se(t);const r=this.Ie(t);this.Ee(e);const i=t&&t.renderTarget?t.renderTarget.fbo:null;let o=0;for(const l in this._e){if("pointline"===l)continue;if(t){const{newShader:e,uniforms:n}=this.Pe(t,l);this._e[l].shader=e,s.extend(r,n)}const e=this.ke(l),a=this._e[l].shader;a.filter=t&&t.sceneFilter||null,o+=this.renderer.render(a,r,e,i),n++}const a=this.ke("pointline");if(a.getMeshes().length){r.pointSize=this.layer.options.pointSize||1;const e=this._e.pointline.shader;e.filter=t&&t.sceneFilter||null,o+=this.renderer.render(e,r,a,i),n++}this.Le(r,i),o&&this.layer.fire("canvasisdirty",{renderCount:o}),this.Ne=!0,this.completeRender(),this.layer.fire("rendercomplete-debug",{count:n})}Le(t,e){this.Ce||(this.Ce=new __);const n=this.layer.getGeometries(),r=[];for(let i=0;i<n.length;i++){if(!n[i].options.showDebugBoundingBox)continue;const t=n[i].rt();t&&r.push(t)}r.length&&(this.Ce.setMeshes(r),this.renderer.render(this._e.wireframe.shader,t,this.Ce,e))}Re(t){const e=t.getUniform("polygonFill")||[1,1,1,1],n=t.getUniform("polygonOpacity")||1;return e[3]=n,{coordinates:t.getCoordinates(),translation:t.getTranslation(),rotation:t.getRotation(),scale:t.getScale(),visible:t.isVisible(),color:e,bloom:t.isBloom(),outline:t.isOutline(),modelHeight:t.getModelHeight(),markerPixelHeight:t.O(),anchorZ:t.getAnchorZ(),pickingId:t.W(),target:t}}Be(t){const e=this.Re(t),n=new r$([e],{symbol:{url:t.getUrl(),shader:t.getShader(),shadow:t.isCastShadow()}});return n.Fe=n.Fe||[],t.De=!0,n.Fe.push(t),n.le(t.getLayer()),n}Ue(){for(const t in this.xe)this.xe[t].removeAllData()}Ve(t,e){const n=t.getMeshes(this.B,this.regl,e),r=t.getShader();if(n.length){this.we.push(t),this.Ae[r]=this.Ae[r]||[],s.pushIn(this.Ae[r],n);for(let t=0;t<n.length;t++)n[t].properties.bloomMesh&&this.Ae[r].push(n[t].properties.bloomMesh)}}Ee(t){this.we.length=0;const e=this.layer.getGeometries();this.qe()&&this.Ue();for(let n=0;n<e.length;n++){const r=e[n],i=r.getUrl();if(r instanceof r$||r.isAnimated()||!r.De)this.Ve(r,t);else if(this.qe()){const t=`${i}_${r.getShader()}_${r.isCastShadow()?1:0}`;this.xe[t]?this.xe[t].addData(this.Re(r)):this.xe[t]=this.Be(r)}}for(const n in this.xe){const e=this.xe[n];e.createdBygltfmarker=!0,this.Ve(e,t)}}Ie(){const t={};this.Ge.outSize=[this.canvas.width,this.canvas.height],this.Ge.halton=[0,0];const e=this.canvas.gl&&this.canvas.gl.wrap?this.layer.options.opacity||0:1;t.layerOpacity=e,s.extend(t,this.Ge);const n=this.getMaskUniforms();return s.extend(t,n),t}ke(t){const e=[],n=[];if("pointline"===t){for(const n in this.Ae)"wireframe"!==n&&this.Ae[n].forEach((t=>{s$.indexOf(t.geometry.desc.primitive)>-1&&e.push(t)}));const t=new __(e);return t.sortMeshes(this.Ge.cameraPosition),t}for(const i in this.Ae){const e=this.Ae[i];i===t&&e.forEach((e=>{(s$.indexOf(e.geometry.desc.primitive)<0||"wireframe"===t)&&n.push(e)}))}const r=this.je=this.je||new __;return r.setMeshes(n),r.sortMeshes(this.Ge.cameraPosition),r}needToRedraw(){return!!super.needToRedraw()||this.qe()}qe(){const t=this.layer.getGeometries();for(let e=0;e<t.length;e++)if(this.we.indexOf(t[e])>-1&&(t[e].isDirty()||t[e].isAnimated()))return!0;return!1}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.Xe(this.canvas,t),this.regl=mp({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.B=this.regl.gltfManager=this.regl.gltfManager||this.He(),this.ze(),this.Lt&&this.Lt.forEach((t=>{t.generateInstancedBuffers(this.regl)})),this.It&&this.It.forEach((t=>{t.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:this.regl})}getGLTFManager(){return this.B}He(){return new Jb(this.regl)}ze(){const t=this.layer.getMap(),e=new f_(this.regl);this.renderer=e,this.Ge={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,cameraPosition:t.cameraPosition,altitudeScale:1},xT.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.Je=new Nw(e,{vert:"#include <gl2_vert>\n\nattribute vec3 aPosition;\n\nuniform mat4 projMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform float pointSize;\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n\n    gl_PointSize = pointSize;\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return am([],e.viewMatrix,e.modelMatrix)}}]},this.pickingFBO,t)}prepareWorker(){this.workerConn||(this.workerConn=new xK("@maptalks/gltf-layer",this.layer));const t=this.workerConn;if(!t.isActive())return;const e=this.layer.options||{},n=this.layer.getId();t.addLayer(n,{markerType:e.markerTypes,pointSize:e.pointSize},(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}G(t){let e;if(this.layer.getURLModifier()){const n=this.layer.options.fetchOptions;e=IK(null,t,n,(t=>{const e=this.layer.getURLModifier();return e?e(t):t}))}else e=this.workerConn.loadGLTF(t);return e.then((t=>(this.setToRedraw(),this.We=!0,t))).catch((e=>{console.error(e),this.layer.fire("modelerror",{type:"modelerror",url:t,info:e})}))}Se(t){const e=yK;for(const n in e){if(this._e[n])continue;const r=e[n];this.Ze(t,r.name,r.type,r.config)}}Ze(t,e,n,r){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),r.extraCommandProps||(r.extraCommandProps={});const i={};t&&this.Ye(i,i$,t);const o=s.extend({},r);o.extraCommandProps=s.extend({},r.extraCommandProps),o.extraCommandProps.viewport=this.viewport,o.uniforms=s.extend([],r.uniforms,i$),o.defines=s.extend({},o.defines,i),n.indexOf(".")>-1?(n=n.split("."),this._e[e]={shader:new _T[n[0]][n[1]](o),type:n}):this._e[e]={shader:new _T[n](o),type:n}}remove(){this.Ke();const t=this._e;for(const e in t)t[e].shader.dispose();this.extentShader&&this.extentShader.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}getFrameTimestamp(){return this.Me}getFrameContext(){return this.ve}needRetireFrames(){return this.We}Ye(t,e,n){const r=n&&n.includes;if(r)for(const i in r)r[i]&&(n[i].uniformDeclares&&(e.length=0,e.push(...n[i].uniformDeclares)),n[i].defines&&s.extend(t,n[i].defines))}$e(t,e){const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&s.extend(t,e[r].renderUniforms)}Pe(t,e){const{shader:n,type:r}=this._e[e];let i=null;const o={};if(this.$e(o,t),t.states.includesChanged){const e={};this.Ye(e,i$,t);const o={vert:n.vert,frag:n.frag,uniforms:n.uniforms,extraCommandProps:n.extraCommandProps};o.defines=e,o.uniforms=s.extend([],o.uniforms,i$),i=Array.isArray(r)?new _T[r[0]][r[1]](o):new _T[r](o),n.dispose()}else i=n;return{uniforms:o,newShader:i}}Qe(t,e,n){if(t.viewshed){for(const e in t.viewshed.renderUniforms)n[e]=t.viewshed.renderUniforms[e];s.extend(e.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)n[e]=t.floodAnalysis.renderUniforms[e];s.extend(e.shaderDefines,t.floodAnalysis.defines)}return n}getShadowMeshes(){const t=[];if(!this.layer||!this.layer.isVisible()||!this.Ae)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++)if(e[n].isCastShadow()&&e[n].isVisible()&&e[n].T()&&!e[n].De){const r=e[n].v||[];s.pushIn(t,r)}for(const n in this.xe){const e=this.xe[n];if(e.isCastShadow()&&e.isVisible()&&e.T()){const n=e.v||[];s.pushIn(t,n)}}return t}tn(){const t=[];if(!this.Ae||!Object.keys(this.Ae).length)return t;for(const e in this.Ae)s.pushIn(t,this.Ae[e]);return t}getAnalysisMeshes(){return this.tn()}getRayCastData(t){const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){const r=e[n].v;if(r&&r.indexOf(t)>-1)return e[n]}return null}drawOutline(t){this.extentShader||(this.extentShader=new U_({vert:"attribute vec3 aPosition;\n\nattribute float aOutline;\n\nuniform mat4 projMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float instance;\n\n#include <get_output>\n\n\n\nvarying float vOutline;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n\n    if (instance == 0.0) {\n\n        vOutline = 1.0;\n\n    } else {\n\n        vOutline = aOutline;\n\n    }\n\n}\n\n",frag:"precision highp float;\n\nvarying float vOutline;\n\nvoid main() {\n\n    gl_FragColor = vec4(vOutline);\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>am([],e.viewMatrix,e.modelMatrix)}],positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}));const e=this.getOutlineMeshes();e.length&&(this.en=this.en||new __,this.en.setMeshes(e),this.renderer.render(this.extentShader,{projMatrix:this.Ge.projMatrix,viewMatrix:this.Ge.viewMatrix},this.en,t))}getOutlineMeshes(){const t=[];if(!this.layer)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){if(e[n].De)continue;const r=e[n].Yt();s.pushIn(t,r)}for(const n in this.xe){const e=this.xe[n].Yt();s.pushIn(t,e)}return t}Ke(){this.canvas&&xT.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}Oe(t){const e=this.layer.getMap(),{iblTexes:n,dfgLUT:r}=xT.PBRUtils.getIBLResOnCanvas(this.canvas);if(e&&e.getLights()){const i=xT.PBRUtils.getPBRUniforms(e,n,r,t&&t.ssr,t&&t.jitter),o=e.getLights(),a=o.ambient&&o.ambient.color?o.ambient.color:[.2,.2,.2];this.Ge.ambientColor=a,i&&s.extend(this.Ge,i)}else{const n=xT.PBRUtils.getPBRUniforms(e,null,r,t&&t.ssr,t&&t.jitter);s.extend(this.Ge,n)}}Xe(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let o=0;o<n.length;++o){try{r=t.getContext(n[o],e)}catch(i){}if(r)break}return r}nn(t,e,n={}){if(!this.Je||!this.layer.isVisible())return null;const r=this.layer.getMap(),i=this.canvas.gl&&this.canvas.gl.wrap;if(this.Ne||i){if(!this.Ae||!Object.keys(this.Ae).length)return null;const t=this.tn(),e=s.extend({},this.Ge);e.pointSize=this.layer.options.pointSize||1,this.Je.render(t,e,!0),this.Ne=!1}const o=n.returnAll?"pickAll":"pick",a=this.Je[o](t,e,n.tolerance||3,{projMatrix:r.projMatrix,viewMatrix:r.viewMatrix,pointSize:this.layer.options.pointSize||1},{viewMatrix:r.viewMatrix,projMatrix:r.projMatrix,returnPoint:!0});if(a.length){const t={},e=[];for(let n=0;n<a.length;n++)if(!t[a[n].pickingId]){const r=this.sn(a[n]);t[a[n].pickingId]=!0,e.push(r)}return e}return this.sn(a)}sn(t){const{meshId:e,pickingId:n,point:r,coordinate:i}=t,o=this.tn()[e],s=this.rn(n);return{meshId:e,mesh:o,data:this.layer.an()[s],pickingId:n,point:r,coordinate:i,index:n-s,nodeIndex:this.hn(e)}}hn(t){const e=this.tn()[t];return e&&e.properties.nodeIndex}rn(t){if(!fK(t))return null;if(this.layer.an()[t])return t;const e=Object.keys(this.layer.an()),n=e.length;let r=0,i=n-1,o=Math.floor((r+i)/2);for(;r<=n-1&&i>=0;){if(r===i)return e[r];if(e[o]<=t&&t<e[o+1])return e[o];t<e[o]?(i=o-1,o=Math.floor((r+i)/2)):e[o+1]<t&&(r=o+1,o=Math.floor((r+i)/2))}return null}isInFrustum(t){const e=this.layer.getMap(),n=t.getBoundingBox();if(!n||"multigltfmarker"===t.getGLTFMarkerType())return!0;const r=Ly(o$,n.min,n.max);return!!Jq(e.projViewMatrix,r)}getRenderMeshesTest(){return this.tn()}isMarkerTransparent(t){return t.J()}getMarkerFitSizeScale(t){return t.cn()}getMarkerFitTranslate(t){return t.ln()}getFBORayPicking(){return this.Je}getShaderList(){return this._e}};const l$=/\{ *([\w_]+) *\}/g;let h$=class t extends YK{constructor(t,e){super(t,e),this.h="effectmarker"}static fromJSON(e){return new t(e.coordinates,e.options)}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const n=this.getTextureUrl();e.un(n),e.dn(t)}return super.updateSymbol({textureUrl:t}),this}mn(t){const e=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){let r=e;const i=this.gn();if(i){const n=this.isAnimationLooped(),o=this.getAnimationSpeed()||1,s=n?Math.floor(.01*t*o)%i.length:Math.floor(.01*t);r=e.replace(l$,i[s]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return n.pn(r,this.W())}return null}gn(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isAnimationLooped(),n=this.getAnimationSpeed()||1,r=this.getUniforms()||{},i=r.width||1,o=r.height||1;let s;const a=this.getEffectType();"uv"===a?s=e?.01*t*n%(i*o):.01*t:"sequence"===a&&(s=e?Math.floor(.01*t*n)%(i*o):Math.floor(.01*t));const l=Number(s%i),h=Math.floor(s/i),u=this.mn(t);this._getSymbol()?(this.setUniform("uvOffset",[l,h]),this.setUniform("width",i),this.setUniform("height",o),this.setUniform("texture",u)):this.C("uniforms",{uvOffset:[l,h],width:i,height:o,texture:u})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.dn(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.un(e)}super.remove()}};const u$=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((t,e)=>(t[e]=!0,t)),{}),c$={toGeometry:function(t,e){if(s.isString(t)&&(t=s.parseJSON(t)),Array.isArray(t)){const n=[];for(let r=0,i=t.length;r<i;r++){const i=c$.bn(t[r],e);Array.isArray(i)?s.pushIn(n,i):n.push(i)}return n}return c$.bn(t,e)},bn:function(t,e){if(!t||s.isNil(t.type))return null;const n=t.type;if("Feature"===n){const n=t.geometry,r=c$.bn(n,e);return r?(r.setId(t.id),r.setProperties(t.properties),r):null}if("FeatureCollection"===n){const n=t.features;return n?c$.toGeometry(n,e):null}if("Point"===n)return function(t,e){return"EffectLayer"===e?new h$(t):new YK(t)}(t.coordinates,e);if("GeometryCollection"===n){const n=t.geometries,r=[],i=n.length;for(let t=0;t<i;t++)r.push(c$.bn(n[t],e));return r}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t||!t.type||!u$[t.type]||t instanceof C)}},f$=/\{*(\$root)*\}/g;let d$=class extends _{constructor(t,e,n){!e||e instanceof C||Array.isArray(e)||u$[e.type]||(n=e,e=null),super(t,null,n),this.pickingId=0,this.yn={},this._n={},this.wn={};const r=n&&n.style;this.setStyle(r),e&&this.addGeometry(e)}static registerShader(t,e,n,r){yK[t]={name:t,type:e,config:n,uniforms:r}}static removeShader(t){delete yK[t]}static getShaders(){const t=[];for(const e in yK)t.push({shader:e,uniforms:yK[e].uniforms});return t}static getShaderMap(){return yK}addGeometry(t,e){let n=c$.isGeoJSON(t)?c$.toGeometry(t,this.getJSONType()):t;n=Array.isArray(n)?n:[n];for(let r=0;r<n.length;r++)if(!this.xn(n[r]))return void console.error("type of geometry is invalid");super.addGeometry(n,e),Array.isArray(n)&&this.addMarker(n)}addMarker(t){for(let e=0;e<t.length;e++){const n=t[e];n.Ht(this.pickingId),this.yn[this.pickingId]=n;const r=n.getId();r&&(this.wn[r]=n),n.fire("add",{type:"add",target:n,layer:this});const i=n.getUrl(),o=this.getRenderer();if(o&&o.xe[i]){const t=o.xe[i];n.fire("load",{type:"load",target:n,data:t.L()})}if("multigltfmarker"===n.getGLTFMarkerType()){const t=n.getCount()||1;this.pickingId+=t}else this.pickingId++}}Tn(t){const e=this.getRenderer();e&&e.loginGLTFMarker(t)}toJSON(t){t||(t={});const e={type:this.getJSONType(),id:this.getId(),options:this.config()};if((cK(t.style)||t.style)&&(e.style=this.getStyle()),cK(t.geometries)||t.geometries){const t=[],n=this._geoList;for(let e=0;e<n.length;e++){const r=n[e].Xt();t.push(r)}e.geometries=t}return e}xn(t){return!!t.getGLTFMarkerType&&this.options.markerTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.vn=JSON.parse(JSON.stringify(t)),this.Mn(),this.fire("setstyle",{target:this,style:this.vn}),this):(delete this.vn,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const n=this.getStyle();this.On(t,e,n),this.On(t,e,this.vn),this.Mn(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}On(t,e,n){if(!n)return;const r=(n.style?n.style:n)[t].symbol||{};for(const i in e)r[i]=e[i]}Mn(){this._processRootUrl(this.vn);const t=this.vn.style?this.vn.style:this.vn;this.An=hR(t),this._geoList.forEach((function(t){this.Sn(t)}),this)}getGLTFUrls(){return Object.keys(this._n)}_processRootUrl(t){s.isString(t.$root)&&t.style.forEach((e=>{const n=e.symbol.url;n&&n.indexOf("{$root}")>-1&&(e.symbol.url=n.replace(f$,t.$root))}))}Sn(t){if(!this.An)return!1;for(let e=0,n=this.An.length;e<n;e++)if(!0===this.An[e].filter({properties:t.getProperties()})){const n=this.An[e].symbol,r=n.url;return t.C("url",r),t.updateSymbol(n),!0}return!1}In(t){if(this.An)for(let e=0,n=this.An.length;e<n;e++)!0===this.An[e].filter({properties:t.getProperties()})&&this.An[e].outline&&t.outline()}En(t){const e=s.isString(t)?this.wn[t].W():t.W(),n=this.getRenderer();n&&n.Pn(e),delete this.yn[e],delete this.wn[t]}clear(){return super.clear(),this.yn={},this.wn={},this}an(){return this.yn}nn(t,e,n){const r=this.getRenderer();return r?r.nn(t,e,n):null}_isModelsLoadComplete(){const t=this._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}Ct(t){const e=this.getRenderer();return e?e.Ct(t):null}V(t){const e=this.getRenderer();e&&e.V(t)}outlineBatch(t){const e=this.vn.style?this.vn.style:this.vn;e[t].outline=!0,this.An=hR(e),this._geoList.forEach((t=>{this.In(t)}))}outlineAll(){this._geoList.forEach((t=>{t.outline()}))}cancelOutline(){this.vn&&(this.vn.style?this.vn.style:this.vn).forEach((t=>{delete t.outline})),this._geoList.forEach((t=>{t.cancelOutline()}))}};d$.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0});let p$=class t extends(vP(d$)){static initDefaultShader(){const e={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new e_};t.registerShader("phong","PhongShader",e.shader,e.material.getUniforms());const n={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new xT.StandardMaterial({})};t.registerShader("pbr","pbr.StandardShader",n.shader,n.material.getUniforms()),t.registerShader("depth","pbr.StandardDepthShader",n.shader,n.material.getUniforms());const r={shader:{positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new Kx};t.registerShader("pointline","PointLineShader",r.shader,r.material.getUniforms());const i={shader:{positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new Kx({lineColor:[0,0,0,1],lineOpacity:1})};t.registerShader("wireframe","EdgeShader",i.shader,i.material.getUniforms());const o={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new r_};t.registerShader("pbr-lite","StandardLiteShader",o.shader,o.material.getUniforms())}static fromJSON(e){if(!e||"GLTFLayer"!==e.type)return null;const n=new t(e.id,e.options),r=e.geometries,i=[];for(let t=0;t<r.length;t++){const e=r[t].type,n=YK.getJSONClass(e);if(!n||!n.fromJSON)throw new Error("unsupported gltfmarker type:"+e);const o=n.fromJSON(r[t]);o&&i.push(o)}return n.addGeometry(i),e.style&&n.setStyle(e.style),n}setURLModifier(t){return this.kn=t,this}getURLModifier(){return this.kn}onAdd(){const t=this.getMap();this._geoList.forEach((e=>{fK(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}identify(t,e){const r=this.getMap();if(!r)return[];const i=r.coordinateToContainerPoint(new n(t));return this.identifyAtPoint(i,e)}identifyAtPoint(t,e={}){const n=[];if(!e.excludeMasks){const r=this.identifyMask(t,e);r&&r.length&&s.pushIn(n,r)}const r=this.getMap();if(!r)return[];const i=r.getDevicePixelRatio(),o=t.x*i,a=t.y*i,l=this.nn(o,a,e);if(l&&(l.data||l.length))if(e.includeInternals&&!e.excludeMasks){n.push(l.data);const t=e.domEvent;t&&(t.gltfPickingInfo=t.gltfPickingInfo||{},t.gltfPickingInfo[this.getId()]=l)}else n.push(l);return e&&e.filter&&!e.excludeMasks?n.filter((t=>e.filter(t.data||t))):n}ae(){this.pickingId=0;const t={};for(const e in this.yn){const n=this.yn[e];n.Ht(this.pickingId),n.P(!0),t[this.pickingId]=n;const r=n.getCount()||1;this.pickingId+=r}this.yn=t}_onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;if("meshcreate"===e)this.Ln(t);else if("modelerror"===e)this.Nn(t);else if("positionchange"===e){const t=this.getRenderer();t&&t.setToRedraw()}super._onGeometryEvent(t)}Nn(t){const{url:e,info:n}=t;console.error(n),this.fire("modelerror",{type:"modelerror",url:e,info:n})}Ln(t){const e=t.url;this._n[e]=1,this.getRenderer().setToRedraw(),this._isModelsLoadComplete()&&this.fire("modelload",{models:this.getGLTFUrls()})}};p$.initDefaultShader(),p$.mergeOptions({markerTypes:["gltfmarker","multigltfmarker"],pointSize:1}),p$.registerJSONType("GLTFLayer"),p$.registerRenderer("gl",a$),new n(0,0),new i(0,0),new i(0,0),new i(0,0);const g$=[];let m$=class t extends r${constructor(t,e){super(null,e),this.on("load",(()=>{this.setCoordinates(t)}))}static fromJSON(e){return new t(e.data,e.options)}setCoordinates(t){this.oe=t,this.Cn()}getCoordinates(){return this.oe}toJSON(){const t=super.toJSON();return t.type="GLTFLineString",t}Cn(){const t=this.oe;if(t){this.removeAllData();for(let e=0;e<t.length-1;e++){const n=this.Rn(t[e]),r=this.Rn(t[e+1]);this.Bn(n,r).forEach((t=>{this.addData(t)}))}this.l=!0}}Bn(t,e){const n=[],r=this.getMap();if(!r)return n;const i=r.getProjection().measureLenBetween(t,e),o=this.Fn(t,e),s=Math.floor(i/o),a=this.Dn(t,e);if(s>=1){for(let r=1;r<=s;r++){const s=o*(r-.5)/i,l={coordinates:this.Un(t,e,s),scale:[1,1,1],rotation:[0,0,a]};n.push(l)}if(this.options.scaleVertex){const r=(o*s+(i-o*s)/2)/i,l=(i-o*s)/o,h={coordinates:this.Un(t,e,r),scale:[l,1,1],rotation:[0,0,a]};n.push(h)}}else if(this.options.scaleVertex){const r=i/o,s={coordinates:this.Un(t,e,.5),scale:[r,1,1],rotation:[0,0,a]};n.push(s)}return n}Un(t,e,r){const i=A$(t.x,e.x,r),o=A$(t.y,e.y,r),s=A$(t.z||0,e.z||0,r);return new n(i,o,s)}Fn(t,e){const r=this.getMap(),i=r.getGLRes(),o=new n(0,(t.y+e.y)/2),s=r.altitudeToPoint(100,i,o)/r.altitudeToPoint(100,i),a=this.getGLTFBBox(),l=this.options.direction||0,h=[1,1,1];if(this.getModelHeight())this.ut(h);else{const t=this.getSymbol();Lm(h,t.scaleX||1,t.scaleY||1,t.scaleZ||1)}const u=Km(g$,a.max,a.min);Fm(u,u,h);const c=this.options.gapLength;return u[l]/s+c}Dn(t,e){const n=this.getMap(),r=n.getGLRes(),i=n.coordinateToPointAtRes(t,r),o=n.coordinateToPointAtRes(e,r);return s.computeDegree(o.x,o.y,i.x,i.y)/Math.PI*180}Rn(t){return Array.isArray(t)?new n(t):t}};function A$(t,e,n){return t+n*(e-t)}m$.mergeOptions({direction:0,gapLength:0,scaleVertex:!0}),m$.registerJSONType("GLTFLineString");const y$=new O_({url:void 0,mag:"linear"});let v$=class extends a${constructor(t){super(t),this._textureMap={}}pn(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):y$}dn(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.Vn=this.Vn||new g_;const e=new O_({url:"default"===t?void 0:t,mag:"linear"},this.Vn);e.once("complete",(()=>{this.setToRedraw()}),this),this._textureMap[t]={count:1,texture:e}}}un(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}},x$=class t extends d${static initDefaultShader(){const e={shader:{vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},material:new Kx};t.registerShader("effect","MeshShader",e.shader,e.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),n=this.getRenderer();n?n.dn(e):this.on("renderercreate",(t=>{t.renderer.dn(e)}))}remove(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.un(n)})),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.un(n)})),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}};x$.initDefaultShader(),x$.mergeOptions({markerTypes:["effectmarker"]}),x$.registerJSONType("EffectLayer"),x$.registerRenderer("gl",v$);(class t extends YK{constructor(t,e){super(t,e),this.h="glowmarker"}static fromJSON(e){return new t(e.coordinates,e.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}X(){let t=this._getInternalSymbol().uniforms.time||0;t+=.01,this.setUniform("time",t)}}).mergeOptions({visible:!0});let _$=class t extends d${static initDefaultShader(){const e={shader:{vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 positionMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        #include <get_output>\n        void main(){\n            mat4 localPositionMatrix = getPositionMatrix();\n            vec4 localVertex = getPosition(aPosition);\n            vec4 position = localPositionMatrix * localVertex;\n            gl_Position = projViewModelMatrix * position;\n            vec4 worldPos = modelMatrix * position;\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},material:new Kx};t.registerShader("glowmarker","MeshShader",e.shader,e.material.getUniforms())}};_$.initDefaultShader(),_$.mergeOptions({markerTypes:["glowmarker"]}),_$.registerJSONType("GlowMarkerLayer"),_$.registerRenderer("gl",a$);let b$=class t extends d${static initDefaultShader(){const e={shader:{vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},material:new Kx};t.registerShader("effectline","MeshShader",e.shader)}};b$.initDefaultShader(),b$.mergeOptions({markerTypes:["effectmarker"]}),b$.registerJSONType("EffectLineLayer"),b$.registerRenderer("gl",v$);let w$=class t extends d${static initDefaultShader(){const e={shader:{vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const n=[];return sm(n,e.modelMatrix),om(n,n),n}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},material:new Kx};t.registerShader("effectring","MeshShader",e.shader)}};if(w$.initDefaultShader(),w$.mergeOptions({markerTypes:["effectring"]}),w$.registerJSONType("EffectRingLayer"),w$.registerRenderer("gl",a$),BE){const t=a.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){l("@maptalks/gltf-layer",BE.inject(uK))}else l("@maptalks/gltf-layer",(function(){return BE.inject(uK)}))}else l("@maptalks/gltf-layer",uK);const T$={yuanhuan:{accessors:[{name:"����С��_1_0_positions",componentType:5126,count:104,min:[-5.407599925994873,-5.404099941253662,0],max:[5.405200004577637,5.406300067901611,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"����С��_1_0_normals",componentType:5126,count:104,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"����С��_1_0_indices",componentType:5123,count:288,min:[0],max:[103],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"缩放圈-新",byteLength:3072,uri:"data:application/octet-stream;base64,KVyjQLbzPT4AAAAAZvesQLbzPT4AAAAAhsmqQC7/YT8AAAAAZ0ShQDC7Vz8AAAAA+u2lwGKhxr8AAAAArK2cwLpJvL8AAAAAEFihwB04V78AAAAAXdyqwE7RYb8AAAAAat6lQEaUxj8AAAAAApqcQG+BvD8AAAAAB18EQFOWlcAAAAAA+u0LQLBynsAAAAAARPoxQNSalMAAAAAAJzEoQIxKjMAAAAAAQBNVQFyPiMAAAAAAIEFJQMDsgMAAAAAA0950QK36dMAAAAAAejZnQFRSZ8AAAAAAXdyAQBBYScAAAAAA+n6IQI0oVcAAAAAAcoqUQAMJMsAAAAAAKjqMQIlBKMAAAAAAXdyAQFdbSUAAAAAA+n6IQDsBVUAAAAAA0950QBTQdEAAAAAAejZnQA5PZ0AAAAAA+n6IwI0oVcAAAAAAwOyAwBBYScAAAAAAXkuMwIlBKMAAAAAA0ZGUwAMJMsAAAAAA5j+8P9ejnMAAAAAAkDFXP65HocAAAAAA1JrGPz7opcAAAAAA/7I7PvhTo8AAAAAA/7I7PmPurMAAAAAAM8RhP/vLqsAAAAAADwutwLbzPT4AAAAA0m+jwLbzPT4AAAAAEFihwDC7Vz8AAAAAXdyqwC7/YT8AAAAArK2cwG+BvD8AAAAA+u2lwEaUxj8AAAAADXGewN/gC0AAAAAAa5qVwIV8BEAAAAAAXkuMwAFNKEAAAAAA0ZGUwD7oMUAAAAAAlIeVQIV8BEAAAAAAlWWeQN/gC0AAAAAAcoqUQD7oMUAAAAAAKjqMQAFNKEAAAAAAQBNVQBB6iEAAAAAAIEFJQKfogEAAAAAAW9N0wK36dMAAAAAAsVBnwFRSZ8AAAAAAlWWeQM/3C8AAAAAAlIeVQNxoBMAAAAAA+n6IwDsBVUAAAAAAwOyAwFdbSUAAAAAAsVBnwA5PZ0AAAAAAW9N0wBTQdEAAAAAAd74LwLBynsAAAAAAkxi8v9ejnMAAAAAAwFsEwFOWlcAAAAAARpRWv65HocAAAAAAayvGvz7opcAAAAAA2c43vvhTo8AAAAAA2c43vmPurMAAAAAAt9Fgv/vLqsAAAAAAt9Fgv7fRqkAAAAAAayvGvybkpUAAAAAAd74LwAponkAAAAAA2c43vv5lo0AAAAAA2c43vmkArUAAAAAARpRWvzxOoUAAAAAAkxi8v9ejnEAAAAAAOdYxwHKKlEAAAAAAwFsEwDqSlUAAAAAA+zoowNBEjEAAAAAAJlNJwKfogEAAAAAAUPxUwBB6iEAAAAAAat6lQGKhxr8AAAAAApqcQLpJvL8AAAAAhsmqQE7RYb8AAAAAZ0ShQB04V78AAAAAZvesQP+yO74AAAAAKVyjQP+yO74AAAAAM8RhP7fRqkAAAAAA/7I7PmkArUAAAAAA/7I7Pv5lo0AAAAAA+u0LQAponkAAAAAA1JrGPybkpUAAAAAAkDFXPzxOoUAAAAAA5j+8P9ejnEAAAAAARPoxQHKKlEAAAAAAB18EQDqSlUAAAAAAJzEoQNBEjEAAAAAA+zoowIxKjMAAAAAAOdYxwNSalMAAAAAAUPxUwFyPiMAAAAAAJlNJwMDsgMAAAAAAa5qVwNxoBMAAAAAADXGewM/3C8AAAAAA0m+jwP+yO74AAAAADwutwP+yO74AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMABAAFAAYABAAGAAcAAwACAAgAAwAIAAkACgALAAwACgAMAA0ADQAMAA4ADQAOAA8ADwAOABAADwAQABEAEgATABQAEgAUABUAFgAXABgAFgAYABkAGgAbABwAGgAcAB0AHgALAAoAHwALAB4AHwAgAAsAIQAgAB8AIgAjACAAIgAgACEAJAAlACYAJAAmACcAJwAmACgAJwAoACkAKgArACwAKgAsAC0ALgAvADAALgAwADEAGQAYADIAGQAyADMANAA1ABsANAAbABoAFQAUADYAFQA2ADcAOAA5ADoAOAA6ADsAPAA9AD4APAA/AD0AQAA/ADwAQABBAD8AQgBBAEAAQgBAAEMARABFAEYARABGAEcARABHAEgARgBJAEcARgBKAEkASwBKAEYASwBMAEoASwBNAEwACQAIAC8ACQAvAC4ALQAsADkALQA5ADgAOwA6AE4AOwBOAE8ATwBOAE0ATwBNAEsAKQAoACsAKQArACoANwA2AFAANwBQAFEAUQBQAFIAUQBSAFMAUwBSAFQAUwBUAFUAVgBXAFgAVgBYAFkAVgBZAFoAWwBZAFgAXABZAFsAXABdAFkAXgBdAFwAXwBdAF4APAA+AGAAPABgAGEAMQAwABcAMQAXABYAYgBjADUAYgA1ADQAYQBgAGMAYQBjAGIAMwAyAF0AMwBdAF8AHQAcAGQAHQBkAGUAZQBkAAUAZQAFAAQAZgBnAAcAZgAHAAYAEQAQABMAEQATABIA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:1248,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:1248,byteOffset:1248,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:576,byteOffset:2496,target:34963}],materials:[{name:"SVGMat_001",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"����С��_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"����С��",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan41:{accessors:[{name:"Բ��_1_0_positions",componentType:5126,count:39,min:[0,0,0],max:[5.489999771118164,0,5.488900184631348],type:"VEC3",bufferView:0,byteOffset:0},{name:"Բ��_1_0_normals",componentType:5126,count:39,min:[0,-.999939501285553,-1],max:[.13969914615154266,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Բ��_1_0_indices",componentType:5123,count:105,min:[0],max:[38],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yh41",byteLength:1148,uri:"data:application/octet-stream;base64,8tKXQAAAAACoNU09FK6vQAAAAAB1Ako/FK6vQAAAAAAAAACATfOAQAAAAAACmkg+K4dWQAAAAAAIrNw+WvUtQAAAAABbsT8/X5gIQAAAAACMSpI/OUWbQAAAAAD0/VQ/LbKHQAAAAAD0/XQ/W0JqQAAAAAC6SZQ/dLXNPwAAAACfq80/H4VHQAAAAAB0JLc/ZognQAAAAAA1XuI/YVSSPwAAAAAukAhABaMKQAAAAAB4nApABcU/PwAAAACF6y1Aw2TiPwAAAACRfidASS63PwAAAABKe0dAJLncPgAAAACze1ZAj1OUPwAAAADjNmpAAppIPgAAAADu64BAnRF1PwAAAAD8qYdAqDVNPQAAAADBypdAgQRVPwAAAAAIPZtAAAAAAAAAAAASpa9AAwlKPwAAAAASpa9AJJd/PAAAAAASpa9AAwlKPwAAAAASpa9AAAAAAAAAAAASpa9Asp1vPQAAAAASpa9AJLn8PQAAAAASpa9AqoJRPgAAAAASpa9ARwOYPgAAAAASpa9AHhbKPgAAAAASpa9A2hv8PgAAAAASpa9A5q4VPwAAAAASpa9A+n4qPwAAAAASpa9AQxw7PwAAAAASpa9AwhdGPwAAAAASpa9AAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAJ5X/OwL+fz8AAACAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIC/Kzs0PAn8f78AAACApLK/PA7uf78AAACAeJkZPefRfz8AAACA+ZldPQSgf78AAACA6XSTPelVfz8AAACALLO3PdT3fr8AAACAfkjZPR2Ofr8AAACANf32Paohfj8AAACAeUYHPqDBfT8AAACASw0PPlt9fb8AAACAAAABAAIAAwABAAAABAABAAMABQABAAQABgAHAAUABwABAAUABgAIAAcABgAJAAgACgAJAAYACgALAAkACgAMAAsADQAMAAoADQAOAAwADwAOAA0ADwAQAA4ADwARABAAEgARAA8AEgATABEAFAATABIAFAAVABMAFgAVABQAFgAXABUAGAAXABYAGAAZABcAGgAbABwAHQAbABoAHgAbAB0AHwAbAB4AIAAbAB8AIQAbACAAIgAbACEAIwAbACIAJAAbACMAJQAbACQAJgAbACUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:468,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:468,byteOffset:468,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:212,byteOffset:936,target:34963}],materials:[{name:"SVGMat_002",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Բ��_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Բ��",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan411:{accessors:[{name:"����СȦ_1_0_positions",componentType:5126,count:28,min:[.026000000536441803,-4.6834001541137695,0],max:[4.696700096130371,-.014800000004470348,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"����СȦ_1_0_normals",componentType:5126,count:28,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"����СȦ_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanhuan411",byteLength:828,uri:"data:application/octet-stream;base64,ufwXQLN7Mr8AAAAAObRAQLFQK78AAAAA1ediQMWP8b4AAAAAGQQ6QCv2174AAAAAqFdeQHUCWr4AAAAA7FGCQL6fmr0AAAAAHHyDQDLmrr4AAAAAXkuWQJf/kL4AAAAAXkuWQLN7crwAAAAAMCrxP2RdhL8AAAAA/BgDQJeQn78AAAAADeARQAg9i78AAAAAukkIQISeXb8AAAAAZaogQH/Zbb8AAAAA7Q3ePr4wOcAAAAAA5IMuP9/gP8AAAAAAJQZxPwrXH8AAAAAAPZs1P6UsF8AAAAAAdy2hP0VHAsAAAAAAb/CFP5eQ778AAAAA0ES4P32utr8AAAAAAprQPyL9zr8AAAAAi/1lPqqCXcAAAAAA9dv3PtcSYsAAAAAADi2yPZvmgcAAAAAAYTK1PssQg8AAAAAA9P3UPGrelcAAAAAA4liXPmrelcAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMAAwACAAQABQAGAAcABQAHAAgABAACAAYABAAGAAUACQAKAAsACQALAAwAAAANAAEADgAPABAADgAQABEAEQAQABIAEQASABMAFAAVAAoAFAAKAAkADAALAA0ADAANAAAAFgAXAA8AFgAPAA4AGAAZABcAGAAXABYAGgAZABgAGgAbABkAEwASABUAEwAVABQA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"����СȦ_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"����СȦ",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanpan:{accessors:[{name:"Circle001_1_0_positions",componentType:5126,count:28,min:[-1.9510999917984009,0,-1.9510999917984009],max:[1.9510999917984009,0,1.9510999917984009],type:"VEC3",bufferView:0,byteOffset:0},{name:"Circle001_1_0_normals",componentType:5126,count:28,min:[0,1,0],max:[0,1,0],type:"VEC3",bufferView:1,byteOffset:0},{name:"Circle001_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanpan",byteLength:828,uri:"data:application/octet-stream;base64,S+rkvgAAAADRIvM/AAAAAAAAAAClvfk/S+rkPgAAAADRIvM/0SLzvwAAAABL6uQ+MlXgvwAAAACsi1s/c9fCvwAAAACvJZw/pb35vwAAAAAAAAAA0SLzvwAAAABL6uS+MlXgvwAAAACsi1u/c9fCvwAAAACvJZy/ryWcvwAAAABz18K/rItbvwAAAAAyVeC/S+rkvgAAAADRIvO/AAAAgAAAAAClvfm/S+rkPgAAAADRIvO/rItbPwAAAAAyVeC/ryWcPwAAAABz18K/c9fCPwAAAACvJZy/MlXgPwAAAACsi1u/0SLzPwAAAABL6uS+pb35PwAAAAAAAACA0SLzPwAAAABL6uQ+MlXgPwAAAACsi1s/c9fCPwAAAACvJZw/ryWcvwAAAABz18I/ryWcPwAAAABz18I/rItbvwAAAAAyVeA/rItbPwAAAAAyVeA/AAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAABAAIAAwAEAAUABgADAAUABwAGAAUACAAHAAUACQAIAAUACgAJAAUACwAKAAUADAALAAUADQAMAAUADgANAAUADwAOAAUAEAAPAAUAEQAQAAUAEgARAAUAEwASAAUAFAATAAUAFQAUAAUAFgAVAAUAFwAWAAUAFwAFABgAGQAXABgAGQAYABoAGwAZABoAAgAbABoAAAACABoA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"wire_008110135",pbrMetallicRoughness:{baseColorFactor:[.0314,.4314,.5294,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Circle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Circle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},zzhou:{accessors:[{name:"Cube.001-Mesh_0_positions",componentType:5126,count:45,min:[-.2711470127105713,-5.473427772521973,-.2711470127105713],max:[.2711470127105713,.46298399567604065,.2711470127105713],type:"VEC3",bufferView:0,byteOffset:0},{name:"Cube.001-Mesh_0_normals",componentType:5126,count:45,min:[-1,-1,-1],max:[1,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Cube.001-Mesh_0_texcoords",componentType:5126,count:45,min:[.125,0],max:[.875,1],type:"VEC2",bufferView:2,byteOffset:0},{name:"Cube.001-Mesh_0_indices",componentType:5123,count:72,min:[0],max:[44],type:"SCALAR",bufferView:3,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"Z",byteLength:1584,uri:"data:application/octet-stream;base64,/waNvZMdK77/Bo09/waNPZMdK77/Bo09/waNPR4Kr8D/Bo09l+KKPVImr8D/Bo09/waNvVImr8D/Bo09yNOKPsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04o+yNOKvsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04q+yNOKvsjTir7I04q+yNOKPsjTir7I04q+yNOKPsjTir7I04o+yNOKvsjTir7I04o+yNOKPsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04o+yNOKvsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04q+/waNPZMdK77/Bo09/waNPZMdK77/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09/waNPR4Kr8D/Bo09/waNvZMdK77/Bo09/waNvVImr8D/Bo09/waNvVImr8D/Bo29/waNvZMdK77/Bo29/waNvZMdK77/Bo29/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPZMdK77/Bo29/waNPZMdK77/Bo09/waNvZMdK77/Bo09/waNvZMdK77/Bo29/waNPZMdK77/Bo29/waNvVImr8D/Bo09cooOO1Imr8BAMTI7/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09l+KKPVImr8D/Bo09/waNPVImr8D/Bo09AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/cCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAAAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAADAPgAAQD8AAMA+AACAP2L1Hz8AAIA/AAAgP3uDfz8AACA/AABAPwAAwD4AAIA+AAAgPwAAAAAAAMA+AAAAAAAAwD4AAIA/AAAgPwAAQD8AAMA+AABAPwAAAD4AAAA/AADAPgAAAD8AAMA+AACAPgAAAD4AAIA+AADAPgAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAQD8AACA/AAAAPwAAwD4AAAA/AADAPgAAAD8AAMA+AABAPwAAID8AAEA/AAAgPwAAAD9i9R8/AAAAPwAAwD4AAAA/AAAgPwAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAgD4AACA/AACAPgAAID8AAAAAAADAPgAAAAAAAAA+AAAAPwAAwD4AAAA/AADAPgAAgD4AAAA+AACAPgAAID8AAAA/vAJBP/mGwj4AACA/AACAPgAAYD8AAIA+AAAgPwAAgD97g18/AAAAPwAAYD8AAAA/AAABAAIAAgADAAQAAgAEAAAABQAGAAcACAAJAAoACwAMAA0ACwANAA4ADwAQABEAEgATABQAFQAWABcAFwAYABkAFwAZABUAGgAbABwAGgAcAB0AHgAfACAAHgAgACEAIgAjACQAIgAkACUAJgAnACgAKAAnACkAAwACACoAKQAnACsAKQArACwAJwAmACsA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:540,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:540,byteOffset:540,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:360,byteOffset:1080,byteStride:8,target:34962},{name:"bufferView_3",buffer:0,byteLength:144,byteOffset:1440,target:34963}],materials:[{name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.8,.8,.8,1],metallicFactor:0,roughnessFactor:.676000006},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Cube.001-Mesh",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0,mode:4}]}],nodes:[{name:"Cube.001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},jiantou:{accessors:[{name:"��ͷ_1_0_positions",componentType:5126,count:7,min:[-.47690001130104065,-.8044000267982483,0],max:[.47780001163482666,0,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"��ͷ_1_0_normals",componentType:5126,count:7,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"��ͷ_1_0_indices",componentType:5123,count:15,min:[0],max:[6],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"jiantou",byteLength:200,uri:"data:application/octet-stream;base64,bxIDOintTb8AAAAAH/RsvsKGp74AAAAAPSz0vsKGp74AAAAANs17PsKGp74AAAAANKL0PsKGp74AAAAANs17PgAAAAAAAAAAH/RsvgAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAADAAEAAAAEAAMAAQAFAAYAAQADAAUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:84,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:84,byteOffset:84,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:32,byteOffset:168,target:34963}],materials:[{name:"SVGMat_003",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"��ͷ_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"��ͷ",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xuanzhuan:{accessors:[{name:"��ת001_1_0_positions",componentType:5126,count:369,min:[-6.572299957275391,-7.298999786376953,0],max:[6.5742998123168945,7.298299789428711,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"��ת001_1_0_normals",componentType:5126,count:369,min:[0,-1,0],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"��ת001_1_0_indices",componentType:5123,count:1089,min:[0],max:[368],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"旋转-新",byteLength:11036,uri:"data:application/octet-stream;base64,1zQDwHql3kAAAAAA48e4vgMJ1kAAAAAAQmD1v6yL6UAAAAAA2qxqv1Fr0EAAAAAAVHSkvnuD1UAAAAAAF7eRvjXv1EAAAAAAyeV/vqVO1EAAAAAA5INevsuh00AAAAAAW7E/vpHt0kAAAAAAZogjvoMv0kAAAAAAAwkKvrpr0UAAAAAA+aDnvTSi0EAAAAAAXCDBvWfVz0AAAAAAqoLZv4NRy0AAAAAALv+hvfcGz0AAAAAAAwmKvVg5zkAAAAAA/Yd0vYtszUAAAAAAak1zvSBBzUAAAAAA1xJyveQUzUAAAAAAIEFxvTLmzEAAAAAARdhwvd21zEAAAAAARdhwvbaEzEAAAAAAIEFxvb1SzEAAAAAAs3tyvSEfzEAAAAAARrZzvYXry0AAAAAAayt2vRe3y0AAAAAAkKB4vQaBy0AAAAAASFB8vfVKy0AAAAAAhXwcwLRZw0AAAAAAbjSAveQUy0AAAAAA3EaDvcX+ykAAAAAAb/CFvTLmykAAAAAAcM6IvRTQykAAAAAAcayLvSS5ykAAAAAAcoqOvQWjykAAAAAA4XqUvWx4ykAAAAAAUI2XvSBjykAAAAAACD2bvQFNykAAAAAAUrievbU3ykAAAAAAeJyivTojykAAAAAA5x2nve0NykAAAAAAMCqpvaMBykAAAAAAVp+rvVr1yUAAAAAAexSuvbPqyUAAAAAAxSCwvTvfyUAAAAAA6pWyvfLSyUAAAAAAoda0vUvIyUAAAAAAx0u3vQK8yUAAAAAAWvW5vVuxyUAAAAAA7Z68vYenyUAAAAAA7ny/veCcyUAAAAAAgSbCvQyTyUAAAAAAgQTFvQmKyUAAAAAA1CvlvRUdyUAAAAAAXW0FviS5yEAAAAAALNQavjVeyEAAAAAADi0yvqYKyEAAAAAAlkNLvki/x0AAAAAA5q5lvhx8x0AAAAAAZaqAvqs+x0AAAAAA4L6OvsgHx0AAAAAAyAedvnPXxkAAAAAAlkOrvqytxkAAAAAAEFi5vs6IxkAAAAAAH4XLvpVlxkAAAAAAAwnKvjhnxkAAAAAA54zIvjhnxkAAAAAAsAPHvgpoxkAAAAAAOwHNvsNkxkAAAAAAO3DOvvFjxkAAAAAA0ETYvpJcxkAAAAAAV+zPvk5ixkAAAAAAV1vRvtlfxkAAAAAAWMrSvgdfxkAAAAAAWDnUvmRdxkAAAAAAIo7VvpJcxkAAAAAA6+LWvpJcxkAAAAAAiIXavgRWxkAAAAAAJLncvkhQxkAAAAAA2/nevl5LxkAAAAAAkzrhvhdIxkAAAAAASnvjvtBExkAAAAAAMzPzvoY4xkAAAAAAArzlvrhAxkAAAAAAufznvkI+xkAAAAAAcT3qvs07xkAAAAAAKH7svlg5xkAAAAAAxLHuvoY4xkAAAAAAfPLwvoY4xkAAAAAA9Gz2vsoyxkAAAAAAtab5vj0sxkAAAAAAduD8vlInxkAAAAAAqRMAvzojxkAAAAAApb0Bv08exkAAAAAAE2EDvzcaxkAAAAAAnREFv00VxkAAAAAAC7UGvzQRxkAAAAAAlWUIv0oMxkAAAAAAHhYKv18HxkAAAAAAGsALv6MBxkAAAAAADk8Pv7n8xUAAAAAAgEgPv7n8xUAAAAAApHANv7n8xUAAAAAAUwWrv90kwkAAAAAASS4Pv7n8xUAAAAAApHANv7n8xUAAAAAAgEgPv7n8xUAAAAAA9wYPv7n8xUAAAAAAidIOv7n8xUAAAAAAG54Ov7n8xUAAAAAAIGMOv7n8xUAAAAAAJCgOv7n8xUAAAAAAKe0Nv7n8xUAAAAAASL8Nv7n8xUAAAAAA9pcNv7n8xUAAAAAAv30Nv7n8xUAAAAAABoFJwDm0uEAAAAAAZvcEwJtVu0AAAAAAwcoxwOzAsUAAAAAARiUFQFdbu8AAAAAAdZMcQM9mw8AAAAAA9pdJQIPAuMAAAAAAtvMxQEvIscAAAAAA2IFzQISeq8AAAAAAjLlbQECkpcAAAAAAZveMQPkxnMAAAAAAPQqBQNEil8AAAAAA+zqeQJOpisAAAAAAdk+SQPd1hsAAAAAAA3ihQFafZ8AAAAAAnl6tQN5xbsAAAAAAsi66QCEfRMAAAAAASFCuQLTIPsAAAAAA4XrEQPW5FsAAAAAAHqe4QJ/NEsAAAAAA1xLMQJhMzb8AAAAA6UjAQFInyL8AAAAAnMTQQM4ZUb8AAAAAsAPFQKMBTL8AAAAAduCMwKMjWcAAAAAA9P1wwOauOcAAAAAA6GqDwG1WGcAAAAAA46WZwA5PM8AAAAAANKLGQBe30TkAAAAAqmDSQBe30TkAAAAAdQLMwEYlzT8AAAAALUPAwAAAyD8AAAAAvp+4wFK4EkAAAAAArWnEwAWjFkAAAAAAF0iuwGizPkAAAAAATx66wI4GREAAAAAAXW2hwAmKZ0AAAAAAPE6twEtZbkAAAAAAW0KSwFFrhkAAAAAAayuewO2eikAAAAAAUPyAwPwYl0AAAAAA1eeMwK8lnEAAAAAAyJhbwA+cpUAAAAAAoWdzwDqSq0AAAAAA6GqrP8cpwsAAAAAA+zoQP6MBxsAAAAAAbqPZPxNhy8AAAAAAYHYPPxsNxsAAAAAAukkMPzQRxsAAAAAA0gAOPxsNxsAAAAAARPoNPxsNxsAAAAAAexQOPxsNxsAAAAAAPzUOPxsNxsAAAAAAIGMOPxsNxsAAAAAAcooOPxsNxsAAAAAAUrgOPxsNxsAAAAAAMuYOPxsNxsAAAAAAoBoPPxsNxsAAAAAAZDsPPxsNxsAAAAAAKVwPPxsNxsAAAAAA0m8PPxsNxsAAAAAAMZkKP00VxsAAAAAAp+gIPzcaxsAAAAAAqz4HPyEfxsAAAAAAIo4FP90kxsAAAAAAmN0DP2srxsAAAAAADi0CPycxxsAAAAAAhXwAP+M2xsAAAAAA9pf9PnE9xsAAAAAA/kP6PltCxsAAAAAA6+L2PqJFxsAAAAAA2IHzPulIxsAAAAAAc2jxPl5LxsAAAAAADk/vPtNNxsAAAAAAqDXtPkhQxsAAAAAAKA/rPr1SxsAAAAAAjNvoPmFUxsAAAAAAC7XmPjJVxsAAAAAAVHTkPgRWxsAAAAAA003iPnlYxsAAAAAAGw3gPh1axsAAAAAAZMzdPpJcxsAAAAAArIvbPgdfxsAAAAAA9UrZPnxhxsAAAAAA2c7XPvFjxsAAAAAA2V/WPpVlxsAAAAAA2PDUPgpoxsAAAAAA847TPn9qxsAAAAAA8x/SPiJsxsAAAAAA8rDQPvRsxsAAAAAA8kHPPphuxsAAAAAAKe3NPg1xxsAAAAAAKH7MPt5xxsAAAAAADALLPlR0xsAAAAAADJPJPsl2xsAAAAAA8BbIPj55xsAAAAAA4za6PryWxsAAAAAATRWsPvW5xsAAAAAASL+dPuvixsAAAAAAYHaPPp0Rx8AAAAAA5WGBPgtGx8AAAAAAi2xnPtiBx8AAAAAAOwFNPtbFx8AAAAAA6gQ0PmIQyMAAAAAAP8YcPiBjyMAAAAAA3pMHPrG/yMAAAAAAZ0TpPdEiycAAAAAAg1HJPcWPycAAAAAAy6HFPQ+cycAAAAAA7lrCPYenycAAAAAAEhS/PdCzycAAAAAAowG8PRrAycAAAAAAEFi5PZLLycAAAAAAfa62PdzXycAAAAAA6gS0PVTjycAAAAAAxY+xPZ7vycAAAAAADk+vPef7ycAAAAAA6NmsPV8HysAAAAAAn82qPakTysAAAAAAeVioPfMfysAAAAAAwaikPT81ysAAAAAA5WGhPYxKysAAAAAACRuePapgysAAAAAACD2bPcl2ysAAAAAAB1+YPbmNysAAAAAAdLWVPamkysAAAAAAvJaQPVvTysAAAAAABFaOPRzrysAAAAAA3+CLPd4Cy8AAAAAAldSJPXEby8AAAAAAcF+HPTMzy8AAAAAA3bWEPc9my8AAAAAALNRqP1Z90MAAAAAAuECCPciYy8AAAAAA3GiAPZLLy8AAAAAAtvN9PS7/y8AAAAAASFB8PScxzMAAAAAA/kN6PSBjzMAAAAAAI9t5PUaUzMAAAAAAI9t5PRHHzMAAAAAAI9t5PTj4zMAAAAAA/kN6PV8pzcAAAAAAkX57PYZazcAAAAAAJLl8PQmKzcAAAAAAcoqOPdZWzsAAAAAAMEymPaMjz8AAAAAAXW3FPZ7vz8AAAAAAjLnrPfW50MAAAAAAqz4DQN213sAAAAAAgy8MPmN/0cAAAAAA5q4lPrhA0sAAAAAAE/JBPn/70sAAAAAAnMRgPhSu08AAAAAAJQaBPnlY1MAAAAAAPL2SPpT21MAAAAAAeHqlPgmK1cAAAAAAhxa5Pr8O1sAAAAAA63P1P2iR6cAAAAAApb1Bv4xKsEAAAAAAMlVAP4xKsEAAAAAAw2QquxDpsUAAAAAAMne9v/OOq0AAAAAA3bW8P/OOq0AAAAAAYqEKwG/wo0AAAAAAcT0KQG/wo0AAAAAA/7IzwG6jmUAAAAAAak0zQG6jmUAAAAAA8IVZwAHejEAAAAAAHcklvw6+lkAAAAAAw2Qqu8UgmEAAAAAAxm0kPw6+lkAAAAAAuB5ZQAHejEAAAAAAc2ihP5aykkAAAAAA1xKiv5aykkAAAAAAKH7sP+AtjEAAAAAAjSjtv+AtjEAAAAAAuK97wBSue0AAAAAAOUV7QBSue0AAAAAAnl4ZQHBfg0AAAAAAdLUZwHBfg0AAAAAAXro5QGDlcEAAAAAA7Q06wGDlcEAAAAAAduCMwPCFWUAAAAAAZaqMQPCFWUAAAAAAqvFWQJAxV0AAAAAA3EZXwJAxV0AAAAAA46WZwEa2M0AAAAAA0m+ZQEa2M0AAAAAAHqdwQIv9OUAAAAAA9P1wwIv9OUAAAAAAIEGDQLWmGUAAAAAA6GqDwLWmGUAAAAAAnzyMwMZt7L8AAAAAiPSjwHE9CsAAAAAAIEGDQG1WGcAAAAAA0m+ZQA5PM8AAAAAA07yjQHE9CsAAAAAANBGMQMZt7L8AAAAA+1yrQAisvL8AAAAA6pWSQBBYob8AAAAAOpKrwAisvL8AAAAAVcGSwBBYob8AAAAA+8uWwI9TJL8AAAAA002wwG40QL8AAAAAYqGWQMbcJT8AAAAA8BawQPfkQT8AAAAA+1yrQE2EvT8AAAAA6pWSQJEPoj8AAAAAVTCYwInSXjsAAAAA+u2xwInSXjsAAAAA6gSYQInSXjsAAAAARraxQInSXjsAAAAAObTQwEXYUD8AAAAAIv3EwBrASz8AAAAAYqGWQI9TJL8AAAAA8BawQG40QL8AAAAA+8uWwMbcJT8AAAAA002wwPfkQT8AAAAAVcGSwJEPoj8AAAAAOpKrwE2EvT8AAAAAnzyMwOQU7T8AAAAAiPSjwEymCkAAAAAA07yjQEymCkAAAAAANBGMQOQU7T8AAAAAHqdwQOauOcAAAAAAZaqMQKMjWcAAAAAA3EZXwOviVsAAAAAAqvFWQOviVsAAAAAA7Q06wLyWcMAAAAAAXro5QLyWcMAAAAAAOUV7QMdLe8AAAAAAuK97wMdLe8AAAAAAdLUZwHo2g8AAAAAAnl4ZQHo2g8AAAAAAuB5ZQE+vjMAAAAAA8IVZwE+vjMAAAAAAjSjtv+oEjMAAAAAAKH7sP+oEjMAAAAAA1xKiv86IksAAAAAAc2ihP86IksAAAAAAak0zQGB2mcAAAAAA/7IzwGB2mcAAAAAAHcklv0aUlsAAAAAAxm0kP0aUlsAAAAAAw2Qqu/32l8AAAAAAcT0KQDPEo8AAAAAAYqEKwDPEo8AAAAAA3bW8P4hjq8AAAAAAMne9v4hjq8AAAAAAMlVAPyEfsMAAAAAApb1BvyEfsMAAAAAAw2Qqu3e+scAAAAAASFDSwG8Sg7oAAAAASZ3GwG8Sg7oAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAwABAAAAAwAEAAEAAwAFAAQAAwAGAAUAAwAHAAYAAwAIAAcAAwAJAAgAAwAKAAkAAwALAAoAAwAMAAsADQAMAAMADQAOAAwADQAPAA4ADQAQAA8ADQARABAADQASABEADQATABIADQAUABMADQAVABQADQAWABUADQAXABYADQAYABcADQAZABgADQAaABkADQAbABoAHAAbAA0AHAAdABsAHAAeAB0AHAAfAB4AHAAgAB8AHAAhACAAHAAiACEAHAAjACIAHAAkACMAHAAlACQAHAAmACUAHAAnACYAHAAoACcAHAApACgAHAAqACkAHAArACoAHAAsACsAHAAtACwAHAAuAC0AHAAvAC4AHAAwAC8AHAAxADAAHAAyADEAHAAzADIAHAA0ADMAHAA1ADQAHAA2ADUAHAA3ADYAHAA4ADcAHAA5ADgAHAA6ADkAHAA7ADoAHAA8ADsAHAA9ADwAHAA+AD0AHAA/AD4AHABAAD8AQABBAD8AQQBCAD8AQgBDAD8AHABAAEQAHABEAEUAHABGAEUARgBHAEUARgBIAEcARgBJAEgARgBKAEkARgBLAEoARgBMAEsAHABNAEYAHABOAE0AHABPAE4AHABQAE8AHABRAFAAHABSAFEAUgBTAFEAUgBUAFMAUgBVAFQAUgBWAFUAUgBXAFYAUgBYAFcAHABZAFIAHABaAFkAHABbAFoAHABcAFsAHABdAFwAHABeAF0AHABfAF4AHABgAF8AHABhAGAAHABiAGEAHABjAGIAHABjAGQAZABlAGMAZQBmAGMAHABnAGQAaABpAGoAawBpAGgAbABpAGsAbQBpAGwAbgBpAG0AbwBpAG4AcABpAG8AcQBpAHAAcgBpAHEAcwBpAHIAdABnABwAdAB1AGcAdAB2AHUAdwB4AHkAdwB5AHoAegB5AHsAegB7AHwAfAB7AH0AfAB9AH4AfgB9AH8AfgB/AIAAgQCCAIMAgQCDAIQAhACDAIUAhACFAIYAhgCFAIcAhgCHAIgAiACHAIkAiACJAIoAiwCMAI0AiwCNAI4AjwCKAJAAigCJAJAAkQCSAJMAkQCTAJQAlACTAJUAlACVAJYAlgCVAJcAlgCXAJgAgAB/AIIAgACCAIEAmACXAJkAmACZAJoAmgCZAJsAmgCbAJwAnACbAJ0AnACdAJ4AngCdAHYAngB2AHQAnwB4AHcAoAB4AJ8AoAChAHgAogChAKAAowCkAKUAowCmAKQAowCnAKYAowCoAKcAowCpAKgAowCqAKkAowCrAKoAowCsAKsAowCtAKwAowCuAK0AowCvAK4AowCiAK8AowChAKIAsAChAKMAsQChALAAsgChALEAswChALIAtAChALMAtQChALQAtgChALUAtwChALYAuAChALcAuQChALgAugChALkAuwChALoAvAChALsAvQChALwAvgChAL0AvwChAL4AwAChAL8AwQChAMAAwgChAMEAwwChAMIAxAChAMMAxQChAMQAxgChAMUAxwChAMYAyAChAMcAyQChAMgAygChAMkAywChAMoAzAChAMsAzQChAMwAzgChAM0AzwChAM4A0AChAM8A0QChANAA0gChANEA0wChANIA1AChANMA1QChANQA1gChANUA1wChANYA2AChANcA2QChANgA2gChANkA2wChANoA3AChANsA3QChANwA3gChAN0A3wChAN4A4AChAN8A4QChAOAA4gChAOEA4wChAOIA5AChAOMA5QChAOQA5gChAOUA5wChAOYA6AChAOcA6QChAOgA6gChAOkA6wChAOoA7AChAOsA7QChAOwA7gChAO0A7wChAO4A8AChAO8A8QChAO8A8gChAPEA8wChAPIA9AChAPMA9QChAPQA9gChAPUA9gD3AKEA+AD3APYA+QD3APgA+gD3APkA+wD3APoA/AD3APsA/QD3APwA/gD3AP0A/wD3AP4AAAH3AP8AAQH3AAABAgH3AAEBAwH3AAIBBAH3AAMBBQH3AAQBBgH3AAUBBgEHAfcACAEHAQYBCQEHAQgBCgEHAQkBCwEHAQoBDAEHAQsBDQEHAQwBDgEHAQ0BDwEHAQ4BEAEHAQ8BEQESARMBFAESAREBFAEVARIBFgEVARQBFgEXARUBGAEXARYBGAEZARcBGgEbARgBGwEcARgBHAEZARgBHAEdARkBHQEeARkBHwEeAR0BGgEgARsBIQEeAR8BGgEiASABIwEiARoBIQEkAR4BJQEkASEBIwEmASIBJwEkASUBIwEoASYBKQEoASMBJwEqASQBKwEqAScBKQEsASgBLQEsASkBKwEuASoBLwEuASsBLQEwASwBMQEuAS8BLQEyATABjgCNADMBjgAzATQBNQE2ATcBNQE3ATgBOAE3ATkBOAE5AToBOwE8AT0BOwE9AT4BPwFAAUEBPwFBAUIBPgE9AUMBPgFDAUQBRQFGAUABRQFAAT8BRwFIAZIARwGSAJEASQFKAUYBSQFGAUUBRAFDAUsBRAFLAUwBOgE5AUoBOgFKAUkBTAFLAU0BTAFNAU4BTgFNAU8BTgFPAVABQgFBAVEBQgFRAVIBUgFRAS4BUgEuATEBNAEzATwBNAE8ATsBUwFUATYBUwE2ATUBUAFPATIBUAEyAS0BiwBVAYwAVgFUAVMBiwBXAVUBWAFUAVYBWAFZAVQBWgFXAYsAWgFbAVcBXAFZAVgBXAFdAVkBXgFbAVoBXgFfAVsBYAFdAVwBXgFhAV8BYgFdAWABYgFjAV0BZAFhAV4BZAFlAWEBZgFjAWIBZAFnAWUBZwFjAWYBZAFjAWcBZAFoAWMBaQFoAWQBaQFqAWgBawFqAWkBawFsAWoBbQFsAWsBbQFuAWwBbwFwAUgBbwFIAUcBAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:4428,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:4428,byteOffset:4428,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:2180,byteOffset:8856,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"��ת001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"��ת001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},plane:{accessors:[{name:"Rectangle001_1_0_positions",componentType:5126,count:4,min:[-5,-5,0],max:[5,5,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"Rectangle001_1_0_normals",componentType:5126,count:4,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Rectangle001_1_0_indices",componentType:5123,count:6,min:[0],max:[3],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"plane",byteLength:108,uri:"data:application/octet-stream;base64,AACgQAAAoEAAAAAAAACgwAAAoEAAAAAAAACgwAAAoMAAAAAAAACgQAAAoMAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAgADAAAA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:48,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:48,byteOffset:48,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:12,byteOffset:96,target:34963}],materials:[{name:"wire_225198087",pbrMetallicRoughness:{baseColorFactor:[.8824,.7765,.3412,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Rectangle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Rectangle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xyzScale:{asset:{generator:"Khronos glTF Blender I/O v1.6.16",version:"2.0"},scene:0,scenes:[{name:"Scene",nodes:[0,1,2,3,4,5,6]}],nodes:[{mesh:0,name:"Cube",scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:1,name:"Cube.001",scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:2,name:"Cube.004",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:3,name:"Cube.003",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:4,name:"Cube.006",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:5,name:"Cube.005",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:6,name:"Cube.002",scale:[.10000000149011612,.10000000149011612,.10000000149011612]}],materials:[{doubleSided:!0,name:"Material",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.002",pbrMetallicRoughness:{baseColorFactor:[.626582869887352,.626582869887352,.626582869887352,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.006",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.005",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.010",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.009",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}}],meshes:[{name:"Cube",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0}]},{name:"Cube.001",primitives:[{attributes:{POSITION:4,NORMAL:5,TEXCOORD_0:6},indices:3,material:1}]},{name:"Cube.006",primitives:[{attributes:{POSITION:10,NORMAL:11,TEXCOORD_0:12},indices:3,material:3}]},{name:"Cube.005",primitives:[{attributes:{POSITION:13,NORMAL:14,TEXCOORD_0:15},indices:3,material:4}]},{name:"Cube.010",primitives:[{attributes:{POSITION:16,NORMAL:17,TEXCOORD_0:18},indices:3,material:5}]},{name:"Cube.009",primitives:[{attributes:{POSITION:19,NORMAL:20,TEXCOORD_0:21},indices:3,material:6}]},{name:"Cube.002",primitives:[{attributes:{POSITION:7,NORMAL:8,TEXCOORD_0:9},indices:3,material:2}]}],accessors:[{bufferView:0,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:1,componentType:5126,count:24,type:"VEC3"},{bufferView:2,componentType:5126,count:24,type:"VEC2"},{bufferView:3,componentType:5123,count:36,type:"SCALAR"},{bufferView:4,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:5,componentType:5126,count:24,type:"VEC3"},{bufferView:6,componentType:5126,count:24,type:"VEC2"},{bufferView:7,componentType:5126,count:24,max:[1,1,1],min:[-1,-1,-1],type:"VEC3"},{bufferView:8,componentType:5126,count:24,type:"VEC3"},{bufferView:9,componentType:5126,count:24,type:"VEC2"},{bufferView:10,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:11,componentType:5126,count:24,type:"VEC3"},{bufferView:12,componentType:5126,count:24,type:"VEC2"},{bufferView:13,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:14,componentType:5126,count:24,type:"VEC3"},{bufferView:15,componentType:5126,count:24,type:"VEC2"},{bufferView:16,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:17,componentType:5126,count:24,type:"VEC3"},{bufferView:18,componentType:5126,count:24,type:"VEC2"},{bufferView:19,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:20,componentType:5126,count:24,type:"VEC3"},{bufferView:21,componentType:5126,count:24,type:"VEC2"}],bufferViews:[{buffer:0,byteLength:288,byteOffset:0},{buffer:0,byteLength:288,byteOffset:288},{buffer:0,byteLength:192,byteOffset:576},{buffer:0,byteLength:72,byteOffset:768},{buffer:0,byteLength:288,byteOffset:840},{buffer:0,byteLength:288,byteOffset:1128},{buffer:0,byteLength:192,byteOffset:1416},{buffer:0,byteLength:288,byteOffset:1608},{buffer:0,byteLength:288,byteOffset:1896},{buffer:0,byteLength:192,byteOffset:2184},{buffer:0,byteLength:288,byteOffset:2376},{buffer:0,byteLength:288,byteOffset:2664},{buffer:0,byteLength:192,byteOffset:2952},{buffer:0,byteLength:288,byteOffset:3144},{buffer:0,byteLength:288,byteOffset:3432},{buffer:0,byteLength:192,byteOffset:3720},{buffer:0,byteLength:288,byteOffset:3912},{buffer:0,byteLength:288,byteOffset:4200},{buffer:0,byteLength:192,byteOffset:4488},{buffer:0,byteLength:288,byteOffset:4680},{buffer:0,byteLength:288,byteOffset:4968},{buffer:0,byteLength:192,byteOffset:5256}],buffers:[{byteLength:5448,uri:"data:application/octet-stream;base64,6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAQAOABQAAQAUAAcACgAGABMACgATABcAFQASAAwAFQAMAA8AEAADAAkAEAAJABYABQACAAgABQAIAAsAEQANAAAAEQAAAAQAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA"}]}};function M$(t,e,n,r,i,o){const s=[],a=ym([],XA([],n[0],n[1],n[2]),e,r);var l;return(l=t,new WM.GLTFLoader("",JSON.parse(JSON.stringify(T$[l]))).load().then((t=>t))).then((t=>{Vb.exportGLTFPack(t).getMeshesInfo().forEach(((t,l)=>{const h=new Kx({color:i||t.materialInfo.baseColorFactor}),u=new h_(t.geometry,h);u.setUniform("uPickingId",o+l);const c=u.getDefines();c.HAS_PICKING_ID=2,u.setDefines(c),u.translate=e,u.rotation=n,u.scaling=r,am(u.localTransform,a,t.nodeMatrix),u.originTransform=rm([],u.localTransform),u.originColor=i||t.materialInfo.baseColorFactor,s.push(u)})),o>100&&(s[0].properties.relatedMeshes=s.slice(1,2),s[1].properties.relatedMeshes=s.slice(0,1),s[2].properties.relatedMeshes=s.slice(3,4),s[3].properties.relatedMeshes=s.slice(2,3),s[4].properties.relatedMeshes=s.slice(5,6),s[5].properties.relatedMeshes=s.slice(4,5),s[6].properties.relatedMeshes=s.slice(0,6))})),s}function C$(t,e){return Math.abs(t)*Math.sign(e)}function S$(t,e){const n=t.getCoordinates(),r=e.coordinateToPointAtRes(n,e.getGLRes()),o=[r.x,r.y,0];Dm(o,o,I$(e,t.getTranslation()));const s=(a=e,l=new i(o[0],o[1]),h=e.getGLRes(),a._pointAtResToContainerPoint(l,h,void 0));var a,l,h;s.x+=85;const u=function(t,e,n){{const r=t.containerPointToCoordinate(e);return t.coordinateToPointAtRes(r,n)}}(e,s,e.getGLRes());return Math.sqrt(Math.pow(u.x-o[0],2)+Math.pow(u.y-o[1],2))/5.272881136101205}function I$(t,e){if(!t)return e;const n=t.distanceToPointAtRes(e[0],e[1],t.getGLRes()),r=t.altitudeToPoint(e[2],t.getGLRes());return Lm([],C$(n.x,e[0]),C$(n.y,e[1]),C$(r,e[2]))}let P$=class{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=M$("jiantou",[1.2*e,0,0],[0,0,90],[e,e,e],[89/255,206/255,147/255,0],7),r=M$("jiantou",[0,1.2*e,0],[0,0,180],[e,e,e],[89/255,206/255,147/255,0],8),i=M$("jiantou",[-1.2*e,0,0],[0,0,270],[e,e,e],[89/255,206/255,147/255,0],9),o=M$("jiantou",[0,-1.2*e,0],[0,0,0],[e,e,e],[89/255,206/255,147/255,0],10);return t.push(n,r,i,o),t}getMeshes(){return this._meshes}},E$=class{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=M$("xuanzhuan",[0,0,0],[180,0,0],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.8],11);return t.push(n),t}getMeshes(){return this._meshes}},O$=class{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=M$("yuanhuan",[0,0,0],[0,0,0],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.5],12);return t.push(n),t}getMeshes(){return this._meshes}};class R${constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=M$("plane",[0,0,0],[0,0,0],[10,10,10],[1,0,0,.5],16);return t.push(e),t}getMeshes(){return this._meshes}}let k$=class{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=M$("xyzScale",[0,0,0],[0,0,0],[2,2,2],null,113);return t.push(e),t}getMeshes(){return this._meshes}};const L$=[],D$=[],N$=[],F$=[],z$=[],B$=[177/170,177/170,177/170],H$=[],j$=[1,2,3,4,12];let U$=class{constructor(){this.translate=new P$,this.rotation=new E$,this.scaling=new O$,this.planeHelper=new R$,this.xyzScaleHelper=new k$,this._meshes=this.t(),this.i=!0}t(){const t={};t.translate=this.translate.getMeshes(),t.rotation=this.rotation.getMeshes(),t.scaling=this.scaling.getMeshes(),t.planeHelper=this.planeHelper.getMeshes(),t.xyzScale=this.xyzScaleHelper.getMeshes();const e=340/177,n=M$("yuanhuan41",[-2.745*e,2.745*e,0],[90,0,0],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],1),r=M$("yuanhuan41",[2.745*e,2.745*e,0],[-90,0,180],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],2),i=M$("yuanhuan41",[2.745*e,-2.745*e,0],[90,0,180],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],3),o=M$("yuanhuan41",[-2.745*e,-2.745*e,0],[-90,0,0],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],4),s=M$("yuanpan",[0,0,0],[90,0,0],[.5*e,.5*e,.5*e],[89/255,206/255,147/255,.5],5),a=M$("zzhou",[0,0,6.5],[90,0,0],[1,1,1],[14/255,127/255,191/255,1],6);return t.translate.push(n,r,i,o,s,a),t}updateMatrix(t,e,n,r,i){const o=e.getCoordinates(),s=t.coordinateToPointAtRes(o,t.getGLRes()),a=e.I();Lm(D$,s.x,s.y,a);const l=km(L$,i),h=I$(t,e.getTranslation());Dm(D$,D$,h),Dm(D$,D$,l);for(const u in this._meshes)for(let i=0;i<this._meshes[u].length;i++){const o=this._meshes[u][i];for(let i=0;i<o.length;i++){const s=o[i],a=s.getUniform("uPickingId"),l=km(L$,s.translate);let h=km(H$,s.rotation);const c=s.scaling;if(11===a&&(this.i?(h[2]+=n,s.rotation[2]+=n):this.i||(h[2]+=n,s.rotation[2]+=n,h[0]=360,h[2]-=90)),a>100&&1===e.getTargets().length&&(h=e.getTargets()[0].getRotation()),j$.indexOf(a)>-1)if(12!==a)c[0]+=r,c[1]+=r,c[2]+=r;else{const t=this._meshes.translate[4][0];c[0]=1.2*t.scaling[0],c[1]=1.2*t.scaling[0],c[2]=1.2*t.scaling[0]}let f=S$(e,t);if(f=Lm(N$,f,f,f),Fm(l,l,f),Fm(f,f,c),1===a||2===a||3===a||4===a){const t=Fm(z$,c,B$);Fm(l,l,t)}const d=XA(F$,h[0],h[1],h[2]);if(Dm(l,l,D$),"xyzScale"===u){const t=ym([],d,l,f);am(s.localTransform,t,s.originTransform)}else ym(s.localTransform,d,l,f)}}}getMeshes(t){const e={};return t?("xyzScale"===t?e[t]=this._meshes[t]:(e.translate=this._meshes.translate,"translate"!==t&&(e[t]=this._meshes[t])),e):e}o(t){this.i=t}dispose(){for(const t in this._meshes)for(let e=0;e<this._meshes[t].length;e++){const n=this._meshes[t][e];for(let t=0;t<n.length;t++){const e=n[t];e.geometry.dispose(),e.dispose()}}}};const V$=[],G$=[],W$=[],q$=new i(0,0),X$=[],Z$=[],Y$=[],J$=[0,0,0];class Q${constructor(){this.C=[],this.h=[0,0,0],this.l=[1,1,1],this.P=[0,0,0]}D(t){Array.isArray(t)?t.forEach((t=>{this.D(t)})):(t.on("remove",this.u,this),t.m={coordinate:t.getCoordinates(),translation:t.getTranslation(),rotation:t.getRotation(),scale:t.getScale()},this.C.push(t))}B(){this.C.forEach((t=>{t.off("remove",this.u,this)})),this.C=[]}p(t,e,n,r,i,o,s){for(let a=0;a<this.C.length;a++){const s=this.C[a],l=s.getRotation(),h=s.getScale(),u=this.v(o,s,r,n,e);let c=null;c=r>=0?r:r*(this.options&&this.options.scaleStrength||1);const f=Dm(Y$,Lm(V$,c*h[0],c*h[1],c*h[2]),h),d=Math.min(...f);if(Math.abs(d)<i){const t=Math.abs(d);f[0]=f[0]*(i/t),f[1]=f[1]*(i/t),f[2]=f[2]*(i/t)}const p=Dm(l,n,l);s.setCoordinates(u),this.L(t,f,h);const g=s.getTranslation();s.setTRS(g,p,f)}Lm(Y$,r,r,r),Dm(this.P,n,this.P),Dm(this.l,Y$,this.l),Dm(this.h,e,this.h),t.indexOf("translate")>-1?s.fire("positionchange",{action:t,type:"positionchange",target:this.C,center:this.getCoordinates(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:e,deltaRotation:n,deltaScale:r}):s.fire("transforming",{action:t,type:"transforming",target:this.C,center:this.C[0].getTransformOrigin(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:e,deltaRotation:n,deltaScale:r})}v(t,e,n,r,i){const o=e.getCenter(),s=e.getTransformOrigin(),a=t.getGLRes(),l=t.coordinateToPointAtRes(o,a,q$);l.z=t.altitudeToPoint(o.z,a),Lm(X$,l.x,l.y,l.z||0);const h=t.coordinateToPointAtRes(s,a,q$);h.z=t.altitudeToPoint(s.z,a),Lm(Z$,h.x,h.y,h.z||0);const u=Km(V$,X$,Z$),c=XA(G$,0,0,r[2]);Lm(Y$,n+1,n+1,n+1);Xm(u,u,ym(W$,c,i,Y$)),Dm(u,u,Z$),q$.set(u[0],u[1]);const f=t.pointAtResToCoordinate(q$,a);return f.z=u[2]/t.altitudeToPoint(1,a),f}L(t,e,n){return"x-scale"===t&&(e[1]=n[1],e[2]=n[2]),"y-scale"===t&&(e[0]=n[0],e[2]=n[2]),"z-scale"===t&&(e[0]=n[0],e[1]=n[1]),e}M(){this.C.forEach((t=>{if(t.m){const{coordinate:e,translation:n,rotation:r,scale:i}=t.m;t.setCoordinates(e),t.setTRS(n,r,i)}}))}getScale(){return this.l}getTranslation(){return 1===this.C.length&&this.C[0].getTranslation()||J$}getRotation(){return this.P}O(){return this.C[0]?this.C[0].getLayer():null}getCoordinates(){let t=0,e=0,r=0;const i=this.C.length;if(!i)return null;for(let n=0;n<i;n++){const i=this.C[n].getCenter();t+=i.x,e+=i.y,r+=i.z||0}t/=i,e/=i,r/=i;const o=new n(t,e,r);for(let n=0;n<i;n++)this.C[n].setTransformOrigin(o);return o}u(t){const e=t.target,n=this.C.indexOf(e);n>-1&&(delete e.m,this.C.splice(n,1))}getTargets(){return this.C}I(){let t=0;const e=this.C.length;for(let n=0;n<e;n++)t+=this.C[n].getPointZ();return t/=e,t}F(){for(let t=0;t<this.C.length;t++)if(this.C[t].isVisible())return!0;return!1}}const K$=[5,6,7,8,9,10],$$=[5,7,8,9,10],t0=[2,4,11],e0=[1,3,12],n0=[12,16],r0=[1,2,3,4],i0=[1,2,3,4,12],o0=[],s0=[],a0=[],l0=[],h0=[],u0=[],c0=[];class f0 extends(R(k(D))){constructor(t={}){super(t),this.options=t,this.mouseAction="moving",this.U=this.options.mode||"translate",this.V=!0,this.TransformHelper=new U$,this.S=new Q$,this.helperScene=new __([]),this.addToMapCount=0,this.k()}setCoordinates(t){this.T.setCoordinates(t),this.transform(this.T)}enable(){return this.V=!0,this.layerRenderer&&this.layerRenderer.setToRedraw(),this}disable(){return this.V=!1,this.layerRenderer&&this.layerRenderer.setToRedraw(),this.map&&this.map.resetCursor(),this}setMode(t){this.U=t,this.H(),this.layerRenderer&&this.layerRenderer.setToRedraw(),this.fire("modechange",{mode:t,type:"modechange"})}getMode(){return this.U}isEnable(){return this.V}J(t){K$.indexOf(t)>-1?this.U="translate":t0.indexOf(t)>-1?this.U="rotation":e0.indexOf(t)>-1?this.U="scaling":"xyzScale"!==this.U&&(this.U="translate")}N(){return this.U}addTo(t){if(this.map)return this.R(),void console.warn("transform control has been added to a map, it suggest remove from the map before");this.addToMapCount++,this.map=t,this._.addTo(this.map),this.container=t.getContainer(),t.on("dom:mousemove",this.K,this),t.on("dom:mousedown",this.G,this),t.on("dom:mouseup",this.j,this),t.on("zooming moving dragrotating",this.Z,this),this.Y()}k(){this._=new p$(`${L}_transformcontrol`),this.T=new YK([0,0],{symbol:{url:"cube",modelHeight:1,uniforms:{polygonOpacity:.01}}}).addTo(this._)}remove(){this.map&&this.container&&this.layerRenderer&&(this.R(),this.TransformHelper.dispose(),this.layerRenderer.setToRedraw(),this._.remove(),delete this.T,delete this._,delete this.map,delete this.layer,delete this.layerRenderer,delete this.container,delete this.S)}R(){this.container&&this.map&&(this.map.off("dom:mousemove",this.K,this),this.map.off("dom:mousedown",this.G,this),this.map.off("dom:mouseup",this.j,this),this.map.off("zooming moving dragrotating",this.Z,this),this.layer&&this.layer.off("renderend",this.render,this))}K(t){if(this.W()){if(this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},"moving"===this.mouseAction){const t=this.q();this.currentPickingObject=this.X(this.currentMousePosition,t,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.pickingId?(this.J(this.currentPickingObject.pickingId),6===this.currentPickingObject.pickingId?this.$(!0):this.$(!1)):(this.$(!1),this.J()),this.AA()}this.eA(this.currentMousePosition)}}G(t){if(!this.W()||0!==t.domEvent.button)return;const e=this.q();this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},this.tA=!0,this.currentPickingObject=this.X(this.currentMousePosition,e,"meshes"),this.firstDownPoint=this.X(this.currentMousePosition,e,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.meshId?(this.mouseAction="transform",this.sA(this.currentPickingObject.pickingId),this.map.config("zoomable",!1),this.map.config("draggable",!1),this.layerRenderer&&this.layerRenderer.setToRedraw()):(this.mouseAction="pan",this.map.config("zoomable",!0),this.map.config("draggable",!0),this.H()),this.lastMousePosition=this.currentMousePosition,this.lastPickingObject=this.currentPickingObject,this.lastPickingMesh=e[this.currentPickingObject.meshId]}j(){"transform"===this.mouseAction&&(this.firstDownPoint=null,this.H(),this.tA=!0,this.fire("transformend",{action:this.iA,type:"transformend"})),this.mouseAction="moving","xyzScale"!==this.U&&(this.U="translate"),this.map.config("zoomable",!0),this.map.config("draggable",!0),this.layerRenderer&&this.layerRenderer.setToRedraw()}Z(){const t=this.TransformHelper.planeHelper.getMeshes()[0][0],e=this.map.getBearing();t.rotation[2]=-e,this.nA()}nA(){this.W()&&(this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]),this.tA=!0)}picked(t){if(!this.layerRenderer)return!1;const e=this.q(),r=this.map;let o=t;t instanceof i||(o=r.coordinateToContainerPoint(new n(t)));const s=this.X(o,e,"picked");return!(!s||null===s.meshId)}H(){const t=this.TransformHelper.getMeshes("scaling").scaling[0][0],e=340/177;t.scaling=[.6*e,.6*e,.6*e],this.layerRenderer&&(this.IA(t),this.oA())}oA(){this.TransformHelper._meshes.translate.forEach((t=>{for(let e=0;e<t.length;e++){const n=t[e];r0.indexOf(n.getUniform("uPickingId"))>-1&&n.material.set("color",n.originColor)}}))}IA(t){const e=this.S.getCoordinates(),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes()),r=[n.x,n.y,0],i=I$(this.map,this.S.getTranslation());Dm(r,r,i);const o=km([],t.translate),s=t.scaling;let a=S$(this.S,this.map);a=Lm([],a,a,a),Fm(o,o,a),Fm(a,a,s),Dm(o,o,r),ym(t.localTransform,[0,0,0,1],o,a),this.q().forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=km([],t.translate),n=170/177;t.scaling=[n,n,n];const i=t.scaling,o=t.rotation;let s=S$(this.S,this.map);s=Lm([],s,s,s),Fm(e,e,s),Fm(s,s,i),Dm(e,e,r);const a=XA([],o[0],o[1],o[2]);ym(t.localTransform,a,e,s)}}))}gA(t){const e=this.map.containerPointToCoordinate(t),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes());return{point:[n.x,n.y]}}eA(t){if("transform"===this.mouseAction){const t=this.N(),e=I$(this.map,this.S.getTranslation()),n=this.S.I();let r=null,o=null;if(e[2]+n<.01&&"z-translate"!==this.iA)r=this.gA(this.currentMousePosition),o=this.gA(this.lastMousePosition);else{const t=this.TransformHelper.planeHelper.getMeshes()[0];if(r=this.X(this.currentMousePosition,t,"plane"),o=this.X(this.lastMousePosition,t,"plane"),!r||null===r.meshId||!o||null===o.meshId)return}const s=[0,0,0],a=[0,0,0];let l=0,h=0,u=0;if("translate"===t){if("xy-translate"===this.iA){const t=r.point[0]-o.point[0],e=r.point[1]-o.point[1];s[0]=t,s[1]=e}else if("x-translate"===this.iA){const t=r.point[0]-o.point[0];s[0]=t}else if("y-translate"===this.iA){const t=r.point[1]-o.point[1];s[1]=t}else if("z-translate"===this.iA){let t=0;if(this.rA()){const e=this.map.getGLRes(),n=this.map._pointAtResToContainerPoint(new i(o.point[0],o.point[1]),e),s=this.map._pointAtResToContainerPoint(new i(r.point[0],r.point[1]),e),a=Uy(Ly(l0,r.point[0]-o.point[0],r.point[1]-o.point[1]));t=s.y<n.y?a:-a}else t=r.point[2]-o.point[2];s[2]=t}}else if("rotation"===t)h=this.aA(r.point,o.point),h>=0?this.TransformHelper.o(!0):this.TransformHelper.o(!1),a[2]+=h;else if("scaling"===t||"xyzScale"===t){const t=this.CA(),e=Uy(Ly(l0,this.firstDownPoint.point[0]-t[0],this.firstDownPoint.point[1]-t[1])),n=Uy(Ly(l0,o.point[0]-t[0],o.point[1]-t[1]));l=this.hA(r.point,o.point,t,n),u=this.hA(r.point,o.point,t,e)}this.TransformHelper.updateMatrix(this.map,this.S,h,u,s),this.S.p(this.iA,s,a,l,.01,this.map,this)}this.lastMousePosition=t,this.lastPickingObject=this.currentPickingObject;const e=this.q();this.lastPickingMesh=e[this.currentPickingObject.meshId]}hA(t,e,n,r,i){const o=(Uy(Ly(l0,t[0]-n[0],t[1]-n[1]))-Uy(Ly(l0,e[0]-n[0],e[1]-n[1])))/r;return i?(i[0]-.01)*o:o}CA(){const t=this.map,e=this.S.getCoordinates(),n=t.coordinateToPointAtRes(e,t.getGLRes()),r=Lm(h0,n.x,n.y,0);return Dm(r,r,I$(t,this.S.getTranslation())),r}$(t){const e=this.TransformHelper.planeHelper.getMeshes()[0][0],n=gm(a0,e.localTransform),r=mm(s0,e.localTransform);let i=XA(o0,0,0,0);const o=this.map.getBearing();t&&!this.rA()?(i=XA(o0,90,0,-o),0===e.rotation[0]&&(this.tA=!0),Lm(e.rotation,90,0,-o)):(90===e.rotation[0]&&(this.tA=!0),Lm(e.rotation,0,0,-o)),ym(e.localTransform,i,n,r)}rA(){if(this.map.getPitch())return!1;const t=this.map.cameraPosition,e=this.map.coordinateToPointAtRes(this.map.getCenter(),this.map.getGLRes());Lm(e,e.x,e.y,0);const n=this.S.getCoordinates(),r=this.map.coordinateToPointAtRes(n,this.map.getGLRes()),i=I$(this.map,this.S.getTranslation()),o=Lm(a0,r.x,r.y,0);return Zm(Nm([],t,Dm(o,o,i)),Nm([],t,e))<1/180*Math.PI}AA(){const t=this.q();if(this.currentPickingObject&&null!=this.currentPickingObject.meshId){this.wA(),this.lastPickingObject&&null!=this.lastPickingObject.meshId&&this.lastPickingObject.meshId!==this.currentPickingObject.meshId&&this.cA();const e=t[this.currentPickingObject.meshId];if(e&&n0.indexOf(this.currentPickingObject.pickingId)<0)if(this.currentPickingObject.pickingId>100)this.QA(e);else{const t=[e.originColor[0],e.originColor[1],e.originColor[2],.8];e.material.set("color",t),this.fA(e,.5)}this.layerRenderer.setToRedraw()}else this.lastPickingObject&&null!=this.lastPickingObject.meshId&&(this.map.resetCursor(),this.cA(),this.layerRenderer.setToRedraw())}QA(t){const e=[1,179/255,2/255,1];t.material.set("color",e),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach((t=>{t.material.set("color",e)}))}wA(){6===this.currentPickingObject.pickingId?this.map.setCursor("ns-resize"):$$.indexOf(this.currentPickingObject.pickingId)>-1?this.map.setCursor("move"):this.map.setCursor("pointer")}cA(){const t=this.lastPickingMesh;if(!t)return;const e=t.getUniform("uPickingId"),n=this.q();$$.indexOf(e)>-1?n.forEach((t=>{$$.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)})):i0.indexOf(e)>-1?n.forEach((t=>{const e=t.getUniform("uPickingId");r0.indexOf(e)>-1&&t.material.set("color",t.originColor)})):11===e&&n.forEach((t=>{r0.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)})),t.material.set("color",t.originColor),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach((t=>{t.material.set("color",t.originColor)}))}fA(t,e){const n=t.getUniform("uPickingId"),r=this.q();$$.indexOf(n)>-1?r.forEach((n=>{if($$.indexOf(n.getUniform("uPickingId"))>-1&&n.getUniform("uPickingId")!==t.getUniform("uPickingId")){const t=[n.originColor[0],n.originColor[1],n.originColor[2],e];n.material.set("color",t)}})):"scaling"===this.U?r.forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=[149/255,179/255,199/255,.8];t.material.set("color",e)}})):"rotation"===this.U&&r.forEach((t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=t.originColor;t.material.set("color",[e[0],e[1],e[2],0])}}))}reset(){this.map&&this.S&&(this.S.M(),this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]))}aA(t,e){const n=this.CA(),r=Ly(u0,e[0]-n[0],e[1]-n[1]),i=Ly(c0,t[0]-n[0],t[1]-n[1]),o=Math.atan2(r[1],r[0]);return(Math.atan2(i[1],i[0])-o)/Math.PI*180}sA(t){return this.iA=113===t||114===t?"x-scale":115===t||116===t?"z-scale":117===t||118===t?"y-scale":119===t?"xyz-scale":5===t?"xy-translate":6===t?"z-translate":7===t||9===t?"x-translate":8===t||10===t?"y-translate":11===t?"z-rotate":"scale",this.iA}transform(t){if(!t)return;if(this.layerRenderer&&this.layerRenderer.layer&&(this.layerRenderer.layer.off("renderend",this.render),this.layerRenderer.layer.off("resizeCanvas",this.lA)),!this.map)return void console.error("should add to a target first");if(this.S&&(this.S.B(),this.S.D(t)),!this.S.getTargets().length)return;const e=this.map;this.TransformHelper.updateMatrix(e,this.S,0,0,[0,0,0]),this.PA(),this.tA=!0}getTransformTarget(){return this.S}u(){delete this.S}PA(){const t=this.S.O();t&&(t.off("renderend",this.render),t.off("resizeCanvas",this.lA));const e=this.map,n=t.getRenderer();this.layerRenderer=n,this.regl=n.regl,this.renderer=n.renderer,this.DA=this.layerRenderer.getFBORayPicking(),this.uA={projViewMatrix:e.projViewMatrix,projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,pointSize:1},t.on("renderend",this.render,this),t.on("resizeCanvas",this.lA,this),n.setToRedraw()}lA(){this.DA.clear(),this.tA=!0}X(t,e,n){const r=this.map;if(!(r&&this.DA&&this.layerRenderer&&this.layerRenderer.canvas))return null;const i=r.getDevicePixelRatio(),o=t.x*i,s=t.y*i,a=this.uA,l=this.layerRenderer.canvas.gl&&this.layerRenderer.canvas.gl.wrap;return(this.tA||l||!this.mA||this.mA!==n)&&(this.DA.render(e,a,!0),this.mA=n,this.tA=!1),this.DA.pick(o,s,10,a,{viewMatrix:this.map.viewMatrix,projMatrix:this.map.projMatrix,returnPoint:!0})}Y(){const t=this.map.getDevicePixelRatio(),e={x:0,y:0,width:()=>this.map?this.map.width*t:1,height:()=>this.map?this.map.height*t:1};this.bA=new U_({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewModelMatrix;\n\n\n\nvoid main()\n\n{\n\n    gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n\n\n\n}\n\n",frag:"precision mediump float;\n\nuniform vec4 color;\n\n\n\nvoid main() {\n\n    gl_FragColor = color;\n\n}\n\n",uniforms:["color",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return am([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,func:"always",mask:!0,range:[0,0]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}},defines:{}})}render(){if(!this.W())return;const t=this.q();this.helperScene.setMeshes(t);const e=this.layerRenderer.getFrameContext();if(e&&e.renderTarget&&this.layerRenderer.getFrameTimestamp()!==e.timestamp)return;this.nA(),this.bA.filter=e&&e.sceneFilter;const n=e&&e.renderTarget&&e.renderTarget.fbo;this.renderer.render(this.bA,this.uA,this.helperScene,n)}q(){let t=[];const e=this.TransformHelper.getMeshes(this.U);for(const r in e){if("translate"===r)continue;const n=e[r];for(let e=0;e<n.length;e++)t=t.concat(n[e])}const n=e.translate;if(n)for(let r=0;r<n.length;r++)t=t.concat(n[r]);return t}W(){const t=this.layerRenderer,e=t&&t.layer;return t&&this.S&&e&&e.isVisible()&&this.S.F()&&this.regl&&this.V}}f0.mergeOptions({scaleStrength:2});for(var d0=[],p0=0;p0<6;p0++)d0[p0]=[];var g0=[];function m0(t,e,n){var r,i,o,s,a,l,h,u,c,f,d,p,g,m,A,y,v;i=(r=t)[0],o=r[1],s=r[2],a=r[3],l=r[4],h=r[5],u=r[6],c=r[7],f=r[8],d=r[9],p=r[10],g=r[11],m=r[12],A=r[13],y=r[14],v=r[15],A0(d0[0],a-i,c-l,g-f,v-m),A0(d0[1],a+i,c+l,g+f,v+m),A0(d0[2],a+o,c+h,g+d,v+A),A0(d0[3],a-o,c-h,g-d,v-A),A0(d0[4],a-s,c-u,g-p,v-y),A0(d0[5],a+s,c+u,g+p,v+y);for(var x=0;x<6;x++){var _=d0[x];if(g0[0]=_[0]>0?e[1][0]:e[0][0],g0[1]=_[1]>0?e[1][1]:e[0][1],g0[2]=_[2]>0?e[1][2]:e[0][2],y0(_,g0)<0)return!1}return!0}function A0(t,e,n,r,i){var o=1/Math.sqrt(e*e+n*n+r*r);return t[0]=e*o,t[1]=n*o,t[2]=r*o,t[3]=i*o,t}function y0(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const v0={vert:"\n    attribute vec3 aPosition;\n    attribute vec2 aTexCoord;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 positionMatrix;\n    uniform mat4 modelMatrix;\n    varying vec2 vTexCoords;\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        vTexCoords = aTexCoord;\n    }\n",frag:"\n    precision mediump float;\n    uniform sampler2D videoTexture;\n    uniform float opacity;\n\n    varying vec2 vTexCoords;\n    void main() {\n        vec4 color = texture2D(videoTexture, vTexCoords);\n        gl_FragColor = color * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am([],e.projViewMatrix,e.modelMatrix)},"texture","opacity"],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,func:"always"},cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},x0=[1,0,3,3,2,1];let _0=class extends r.CanvasRenderer{constructor(t){super(t),this.t={}}draw(t,e){this.prepareCanvas(),this.i(e)}drawOnInteracting(t,e,n){this.i(n)}needToRedraw(){return!0}hitDetect(){return!1}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.o(this.canvas,t),this.regl=mp({gl:this.gl,extensions:["ANGLE_instanced_arrays","OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","EXT_shader_texture_lod","OES_element_index_uint","OES_standard_derivatives","WEBGL_depth_texture"],optionalExtensions:this.layer.options.glExtensions||[]})}this.h(),this.l();const t=this.layer.getVideoSurfaces();for(let e=0;e<t.length;e++)this.u(t[e])}o(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let o=0;o<n.length;++o){try{r=t.getContext(n[o],e)}catch(i){}if(r)break}return r}l(){const t=this.layer.getMap(),e=new f_(this.regl);this.renderer=e,this.p={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,halton:[.2107,-.0202],uHalton:[.2107,-.0202],uCameraPosition:t.cameraPosition,cameraPosition:t.cameraPosition,globalTexSize:[t.width,t.height]}}m(){return this.regl}h(){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.v()}v(){this._&&this._.dispose(),this.layer.options.showTopAlways?(v0.extraCommandProps.depth.mask=!1,v0.extraCommandProps.depth.range=[0,0]):(delete v0.extraCommandProps.depth.mask,delete v0.extraCommandProps.depth.range),v0.extraCommandProps.cull.enable=!this.layer.options.doubleSide,this._=new U_(v0)}u(t){const e=this.regl.texture(),n=new Kx({videoTexture:e,opacity:1}),r=t.getCoordinates(),{worldCenter:i,points:o}=this.O(r),s=this.S(o),a=new h_(s,n);this.T(a,i);const l=new __(a),h=t.C();this.t[h]=l}M(t){const e=t.C(),n=this.t[e].getMeshes()[0],r=t.getCoordinates();n.geometry.dispose();const{worldCenter:i,points:o}=this.O(r),s=this.S(o);n.geometry=s,this.T(n,i)}i(t){const e=this.layer.getVideoSurfaces().filter((t=>t.isVisible()));if(!e.length)return;const n=this.P(e);if(!n)return;let r=null;t&&(r=t.renderTarget&&t.renderTarget.fbo),this.renderer.render(this._,this.p,n,r)}S(t){return new bx({POSITION:t,TEXCOORD:[0,0,1,0,1,1,0,1]},x0,0,{primitive:"triangles",positionAttribute:"POSITION",uv0Attribute:"TEXCOORD",normalAttribute:"NORMAL",positionSize:3})}O(t){let e=[];const r=this.getMap(),i=new c(t).getCenter(),o=b0(r,i,0);return this.V=o,r&&t.forEach((t=>{const i=new n(t[0],t[1]),s=r.altitudeToPoint(t[2]||0,r.getGLRes()),a=b0(r,i,s);a[0]=a[0]-o[0],a[1]=a[1]-o[1],e=e.concat(a)})),{worldCenter:o,points:e}}P(t){const e=[],n=this.layer.getMap();for(let r=0;r<t.length;r++){const i=t[r],o=this.t[i.C()];if(!o)continue;const s=o.getMeshes();for(let t=0;t<s.length;t++){const r=s[t],o=r.getMaterial(),a=o.get("videoTexture");a&&i.A()&&(a(i.video),o.set("opacity",i.getOpacity())),m0(n.projViewMatrix,r.getBoundingBox())&&e.push(r)}}return e.length?new __(e):null}T(t,e){ym(t.localTransform,XA([],0,0,0),e,[1,1,1])}remove(){this._&&this._.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}k(t){const e=this.t[t];e&&e.getMeshes().forEach((t=>{t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose()}))}};function b0(t,e,n){if(!t)return null;const r=t.coordinateToPointAtRes(e,t.getGLRes());return[r.x,r.y,n]}class w0 extends(R(k(D))){constructor(t,e){super(e),this.setCoordinates(t),this.I()}setCoordinates(t){this.R=t}getCoordinates(){return this.R}setVideo(t){this.D="stop",this.options.url=t,delete this.options.elementId,this.I()}setElementId(t){this.D="stop",this.options.elementId=t,delete this.options.url,this.I()}I(){this.D="stop";const t=this.options.url,e=this.options.elementId;let n=document.getElementById(e);if(t&&(n=document.createElement("video"),n.src=t),!n)throw new Error("there is no element or url setting for video mask");n.autoplay=!0,n.loop=!0,n.muted=!0,n.play(),n.addEventListener("playing",(()=>{this.D="playing",this.fire("playing",{state:this.D,url:t})})),n.addEventListener("pause",(()=>{this.D="pause",this.fire("pause",{state:this.D,url:t})})),n.addEventListener("error",(()=>{throw this.D="pause",this.fire("error",{state:this.D,url:t}),new Error("video resource load error")})),this.video=n}getVideo(){return this.video}L(t){this.j=t}C(){return this.j}addTo(t){if(this.F)throw new Error("VideoSurface cannot be added to two or more layers at the same time.");return t.addSurfaces(this),this}show(){return this.options.visible=!0,this}hide(){return this.options.visible=!1,this}isVisible(){return this.options.visible}play(){this.video&&this.video.play()}pause(){this.video&&this.video.pause()}setAudio(t){this.video.muted=t}setOpacity(t){this.options.opacity=t}getOpacity(){return this.options.opacity}remove(){delete this.video;const t=this.getLayer();t&&t.removeVideoSurfaces(this),this.endEdit()}getLayer(){return this.F}A(){return"playing"===this.D}startEdit(){const t=this.getLayer();if(!t)return void console.warn("videosurface should be added to a map before edit");const e=t.getMap();if(!e)return void console.warn("videosurface should be added to a map before edit");if(this.N(),!this.G){const n=t.getId();this.G=new N(`internal_${n}_edit`,{enableAltitude:!0}).addTo(e)}const n=this.getCoordinates();this.H=new c(n,{symbol:{lineColor:"#34495e",lineWidth:2,polygonFill:"rgb(135,196,240)",polygonOpacity:.1}}).addTo(this.G),this.H.startEdit({newVertexHandleSymbol:{polygonFill:"rgba(0, 0, 0, 0)",polygonOpacity:0,markerType:"ellipse",markerWidth:1,markerHeight:1}}),this.H.on("shapechange",(e=>{const n=e.target.getCoordinates()[0].slice(0,4).map((t=>[t.x,t.y,0]));this.setCoordinates(n),t.getRenderer().M(this)}),this)}endEdit(){this.G&&(this.H.endEdit(),this.H.remove(),this.G.remove()),delete this.G,delete this.H}N(){this.G&&this.G.clear(),delete this.H}}w0.mergeOptions({opacity:1,visible:!0});let T0=class extends u{constructor(t,e,n){!e||Array.isArray(e)||e instanceof w0||(n=e,e=null),super(t,n),this.W={},this.videoId=0,this.W={},this.videoId=0,e&&this.addSurfaces(e)}addSurfaces(t){if(t)if(Array.isArray(t))t.forEach((t=>{this.addMarker(t)}));else{t.F=this,this.W[this.videoId]=t,t.L(this.videoId);const e=this.getRenderer();e?e.m()&&e.u(t):this.on("renderercreate",(e=>{e.renderer.m()&&e.renderer.u(t)})),this.videoId++}}showTopAlways(t){this.options.showTopAlways=t;const e=this.getRenderer();e&&e.v()}setDoubleSide(t){this.options.doubleSide=t;const e=this.getRenderer();e&&e.v()}getVideoSurfaces(){const t=[];for(const e in this.W)t.push(this.W[e]);return t}removeVideoSurfaces(t){if(Array.isArray(t))t.forEach((t=>{this.removeVideoSurfaces(t)}));else{const e=t.C(),n=this.getRenderer();n&&n.k(e),delete this.W[e]}}remove(){this.clear(),super.remove()}clear(){const t=this.getVideoSurfaces();for(let e=0;e<t.length;e++)t[e].remove()}};T0.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,showTopAlways:!0,doubleSide:!0}),T0.registerJSONType("VideoLayer"),T0.registerRenderer("gl",_0);const M0=2048;class C0{constructor(t,e){this.renderer=t,this.regl=t.regl,this.i=e,this.u()}u(){this.h=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:M0,height:M0,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0})}l(t,e,n){const r={projViewMatrix:e,minAltitude:0,logDepthBufFC:2/(Math.log(n+1)/Math.LN2)};this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this.h}),this.renderer.render(this.C,r,t,this.h)}D(t,e){this.C=new U_({vert:"#include <gl2_vert>\n\n#ifdef HAS_ALTITUDE\n\n    attribute vec2 aPosition;\n\n    attribute float aAltitude;\n\n#else\n\n    attribute vec3 aPosition;\n\n#endif\n\n// uniform mat4 projViewMatrix;\n\n// uniform mat4 modelMatrix;\n\nuniform mat4 projViewModelMatrix;\n\nuniform mat4 positionMatrix;\n\nvarying vec2 vHighPrecisionZW;\n\n#include <get_output>\n\nvarying float vFragDepth;\n\n\n\n#ifdef HAS_ALTITUDE\n\n    vec3 unpackVTPosition() {\n\n        return vec3(aPosition, aAltitude);\n\n    }\n\n#endif\n\nvoid main()\n\n{\n\n    #ifdef HAS_ALTITUDE\n\n        vec3 i = unpackVTPosition();\n\n        vec4 j = vec4(i, 1.);\n\n        gl_Position = projViewModelMatrix * j;\n\n    #else\n\n        mat4 localPositionMatrix = getPositionMatrix();\n\n        gl_Position = projViewModelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    #endif\n\n    vFragDepth = 1.0 + gl_Position.w;\n\n    vHighPrecisionZW = gl_Position.zw;\n\n}\n\n",frag:"#ifdef GL_ES\n\nprecision highp float;\n\n#endif\n\n#include <gl2_frag>\n\n\n\nuniform float logDepthBufFC;\n\nvarying float vFragDepth;\n\nvarying vec2 vHighPrecisionZW;\n\n\n\nconst float PackUpscale = 256. / 255.;\n\nconst float UnpackDownscale = 255. / 256.;\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA(const in float v ) {\n\n    vec4 r = vec4(fract(v * PackFactors), v);\n\n    r.yzw -= r.xyz * ShiftRight8;\n\n    return r * PackUpscale;\n\n}\n\nvoid main() {\n\n    gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n\n    float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\n    glFragColor = packDepthToRGBA(fragCoordZ);\n\n    #if __VERSION__ == 100\n\n        gl_FragColor = glFragColor;\n\n    #endif\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am([],e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:{x:0,y:0,width:()=>{const n=this.I(t,e);return n?n.width:1},height:()=>{const n=this.I(t,e);return n?n.height:1}}}}),this.C.version=300}I(t,e){return this.m(t,e)?{width:M0,height:M0}:null}m(t,e){return t&&e&&t*e>0}dispose(){this.h&&this.h.destroy(),this.C&&this.C.dispose()}}function S0(t,e){return t.altitudeToPoint(e||0,t.getGLRes())}const I0=new n(0,0);function P0(t,e,n,r){if(!t)return null;I0.set(e,n);const i=t.coordinateToPointAtRes(I0,t.getGLRes()),o=S0(t,r);return[i.x,i.y,o]}R(k(D));FA([]),FA([]),new i(0,0),"undefined"!=typeof document&&document.createElement("canvas");const E0=[0,0,0,1],O0=[],R0=[];class k0 extends C0{u(){this.T=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.O=new U_({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewModelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n#include <get_output>\n\nvarying vec4 vPosition;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    vec4 worldPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    vPosition = worldPosition;\n\n    gl_Position = projViewModelMatrix * localPositionMatrix * getPosition(aPosition);\n\n}\n\n",frag:"#ifdef GL_ES\n\nprecision highp float;\n\n#endif\n\n#include <gl2_frag>\n\n\n\nvarying vec4 vPosition;\n\n\n\nconst vec2 range = vec2(-100.0, 1000.0);\n\nvec4 encodeHeight(const in float height) {\n\n    float alpha = 1.0;\n\n    vec4 pack = vec4(0.0);\n\n    pack.a = alpha;\n\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n\n    pack.rgb = vec3(code * height);\n\n    pack.gb = fract(pack.gb);\n\n    pack.rg -= pack.gb * (1.0 / 256.0);\n\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n\n    return pack;\n\n}\n\n\n\nvoid main() {\n\n    float height = (vPosition.z - range.x) / (range.y - range.x);\n\n    glFragColor = encodeHeight(height);\n\n    #if __VERSION__ == 100\n\n        gl_FragColor = glFragColor;\n\n    #endif\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>am(O0,e.viewMatrix,e.modelMatrix)},{name:"projViewModelMatrix",type:"function",fn:(t,e)=>am(R0,e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:this.i,cull:{enable:!0},frontFace:"ccw"}}),this.F=new __}render(t,e){this.U(),this.renderer.clear({color:E0,depth:1,framebuffer:this.T}),this.F.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this.O,n,this.F,this.T),this.T}U(){const t=s.isFunction(this.i.width)?this.i.width():this.i.width,e=s.isFunction(this.i.height)?this.i.height():this.i.height;!this.T||this.T.width===t&&this.T.height===e||this.T.resize(t,e)}dispose(){this.T&&(this.T.destroy(),delete this.T),this.O&&(this.O.dispose(),delete this.O)}}const L0=Vq.getRendererClass("gl");function D0(t,e,n){if(null!==t)for(var r,i,o,s,a,l,h,u,c=0,f=0,d=t.type,p="FeatureCollection"===d,g="Feature"===d,m=p?t.features.length:1,A=0;A<m;A++){a=(u=!!(h=p?t.features[A].geometry:g?t.geometry:t)&&"GeometryCollection"===h.type)?h.geometries.length:1;for(var y=0;y<a;y++){var v=0,x=0;if(null!==(s=u?h.geometries[y]:h)){l=s.coordinates;var _=s.type;switch(c=0,_){case null:break;case"Point":if(!1===e(l,f,A,v,x))return!1;f++,v++;break;case"LineString":case"MultiPoint":for(r=0;r<l.length;r++){if(!1===e(l[r],f,A,v,x))return!1;f++,"MultiPoint"===_&&v++}"LineString"===_&&v++;break;case"Polygon":case"MultiLineString":for(r=0;r<l.length;r++){for(i=0;i<l[r].length-c;i++){if(!1===e(l[r][i],f,A,v,x))return!1;f++}"MultiLineString"===_&&v++,"Polygon"===_&&x++}"Polygon"===_&&v++;break;case"MultiPolygon":for(r=0;r<l.length;r++){for(x=0,i=0;i<l[r].length;i++){for(o=0;o<l[r][i].length-c;o++){if(!1===e(l[r][i][o],f,A,v,x))return!1;f++}x++}v++}break;case"GeometryCollection":for(r=0;r<s.geometries.length;r++)if(!1===D0(s.geometries[r],e))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function N0(t){var e=[1/0,1/0,-1/0,-1/0];return D0(t,(function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])})),e}(class extends Vq{excavate(t){this.N=!0,this.wt=Array.isArray(t)?t:[t];const e=this.getRenderer();e&&(e.Pt(),e.setToRedraw())}getExcavatedLayers(){return this.wt}enable(){this.N=!0,this.Ct()}disable(){this.N=!1,this.Ct()}isEnable(){return this.N}Ct(){const t=this.getRenderer();t&&t.setToRedraw()}}).registerRenderer("gl",class extends L0{draw(t,e){this.layer.getExcavatedLayers()&&this.layer.isEnable()&&(this.Dt(),super.draw(t,e))}Dt(){this._&&this.It||this.bt(),this.Mt=this.Mt||this.Pt();const t=this.getMap(),e=this.meshes;if(e&&this.Mt){for(let n=0;n<e.length;n++){const r=e[n],i=r.getDefines();i.HAS_EXCAVATE_ANALYSIS=1,r.setDefines(i),r.setUniform("heightmap",this.Mt),r.setUniform("excavateExtent",this.It),r.setUniform("excavateHeight",S0(t,this.options.height))}this.setToRedraw()}}Pt(){const t=this.layer.getExcavatedLayers();this.zt=[];for(let e=0;e<t.length;e++){const n=t[e].getRenderer();if(!n.getAnalysisMeshes)continue;const r=n.getAnalysisMeshes();s.pushIn(this.zt,r)}return this.zt.length?(this.B=this.B||this.S(),this.B.render(this.zt,this._)):null}bt(){const t=this.layer.getMap(),e=this.layer.getExtent(),n=t.getCenter(),r=t.getZoom(),i=t.getPitch(),o=t.getBearing(),s=t.getFitZoom(e),a=e.getCenter();t.setZoom(s),t.setCenter(a),t.setPitch(0),t.setBearing(0);const l=t.getExtent();this._=this._||[],rm(this._,t.projViewMatrix);const h=P0(t,l.xmin,l.ymin),u=P0(t,l.xmax,l.ymax);this.It=cA(this.It||[],h[0],h[1],u[0],u[1]),t.setZoom(r),t.setCenter(n),t.setPitch(i),t.setBearing(o)}S(){this.i={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1};const t=new f_(this.regl);return this.B=this.B||new k0(t,this.i),this.B}dt(){this.bt(),this.setToRedraw()}onGeometryAdd(t){super.onGeometryAdd(t),this.dt()}onGeometryRemove(){super.onGeometryRemove(),this.dt()}remove(){super.remove(),this.B&&this.B.dispose()}}),N0.default=N0,"fill"in Array.prototype||Object.defineProperty(Array.prototype,"fill",{configurable:!0,value:function(t){if(null==this)throw new TypeError(this+" is not an object");var e=Object(this),n=Math.max(Math.min(e.length,9007199254740991),0)||0,r=1 in arguments&&parseInt(Number(arguments[1]),10)||0;r=r<0?Math.max(n+r,0):Math.min(r,n);var i=2 in arguments&&void 0!==arguments[2]?parseInt(Number(arguments[2]),10)||0:n;for(i=i<0?Math.max(n+arguments[2],0):Math.min(i,n);r<i;)e[r]=t,++r;return e},writable:!0}),Number.isFinite=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Number.parseFloat=Number.parseFloat||parseFloat,Number.isNaN=Number.isNaN||function(t){return t!=t},Math.trunc=Math.trunc||function(t){return t<0?Math.ceil(t):Math.floor(t)};var F0=function(){};F0.prototype.interfaces_=function(){return[]},F0.prototype.getClass=function(){return F0},F0.prototype.equalsWithTolerance=function(t,e,n){return Math.abs(t-e)<=n};var z0=function(t){function e(e){t.call(this,e),this.name="IllegalArgumentException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),B0=function(){},H0={MAX_VALUE:{configurable:!0}};B0.isNaN=function(t){return Number.isNaN(t)},B0.doubleToLongBits=function(t){return t},B0.longBitsToDouble=function(t){return t},B0.isInfinite=function(t){return!Number.isFinite(t)},H0.MAX_VALUE.get=function(){return Number.MAX_VALUE},Object.defineProperties(B0,H0);var j0=function(){},U0=function(){},V0=function(){};function G0(){}var W0=function t(){if(this.x=null,this.y=null,this.z=null,0===arguments.length)this.x=0,this.y=0,this.z=t.NULL_ORDINATE;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.z=e.z}else 2===arguments.length?(this.x=arguments[0],this.y=arguments[1],this.z=t.NULL_ORDINATE):3===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2])},q0={DimensionalComparator:{configurable:!0},serialVersionUID:{configurable:!0},NULL_ORDINATE:{configurable:!0},X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0}};W0.prototype.setOrdinate=function(t,e){switch(t){case W0.X:this.x=e;break;case W0.Y:this.y=e;break;case W0.Z:this.z=e;break;default:throw new z0("Invalid ordinate index: "+t)}},W0.prototype.equals2D=function(){if(1===arguments.length){var t=arguments[0];return this.x===t.x&&this.y===t.y}if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!F0.equalsWithTolerance(this.x,e.x,n)&&!!F0.equalsWithTolerance(this.y,e.y,n)}},W0.prototype.getOrdinate=function(t){switch(t){case W0.X:return this.x;case W0.Y:return this.y;case W0.Z:return this.z}throw new z0("Invalid ordinate index: "+t)},W0.prototype.equals3D=function(t){return this.x===t.x&&this.y===t.y&&(this.z===t.z||B0.isNaN(this.z))&&B0.isNaN(t.z)},W0.prototype.equals=function(t){return t instanceof W0&&this.equals2D(t)},W0.prototype.equalInZ=function(t,e){return F0.equalsWithTolerance(this.z,t.z,e)},W0.prototype.compareTo=function(t){var e=t;return this.x<e.x?-1:this.x>e.x?1:this.y<e.y?-1:this.y>e.y?1:0},W0.prototype.clone=function(){},W0.prototype.copy=function(){return new W0(this)},W0.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},W0.prototype.distance3D=function(t){var e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return Math.sqrt(e*e+n*n+r*r)},W0.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},W0.prototype.hashCode=function(){var t=17;return 37*(t=37*t+W0.hashCode(this.x))+W0.hashCode(this.y)},W0.prototype.setCoordinate=function(t){this.x=t.x,this.y=t.y,this.z=t.z},W0.prototype.interfaces_=function(){return[j0,U0,G0]},W0.prototype.getClass=function(){return W0},W0.hashCode=function(){if(1===arguments.length)return B0.doubleToLongBits(arguments[0]),Math.trunc(0)},q0.DimensionalComparator.get=function(){return X0},q0.serialVersionUID.get=function(){return 0x5cbf2c235c7e5800},q0.NULL_ORDINATE.get=function(){return B0.NaN},q0.X.get=function(){return 0},q0.Y.get=function(){return 1},q0.Z.get=function(){return 2},Object.defineProperties(W0,q0);var X0=function(t){if(this.xt=2,0===arguments.length);else if(1===arguments.length){var e=arguments[0];if(2!==e&&3!==e)throw new z0("only 2 or 3 dimensions may be specified");this.xt=e}};X0.prototype.compare=function(t,e){var n=t,r=e,i=X0.compare(n.x,r.x);if(0!==i)return i;var o=X0.compare(n.y,r.y);return 0!==o?o:this.xt<=2?0:X0.compare(n.z,r.z)},X0.prototype.interfaces_=function(){return[V0]},X0.prototype.getClass=function(){return X0},X0.compare=function(t,e){return t<e?-1:t>e?1:B0.isNaN(t)?B0.isNaN(e)?0:-1:B0.isNaN(e)?1:0};var Z0=function(){};Z0.prototype.create=function(){},Z0.prototype.interfaces_=function(){return[]},Z0.prototype.getClass=function(){return Z0};var Y0=function(){},J0={INTERIOR:{configurable:!0},BOUNDARY:{configurable:!0},EXTERIOR:{configurable:!0},NONE:{configurable:!0}};Y0.prototype.interfaces_=function(){return[]},Y0.prototype.getClass=function(){return Y0},Y0.toLocationSymbol=function(t){switch(t){case Y0.EXTERIOR:return"e";case Y0.BOUNDARY:return"b";case Y0.INTERIOR:return"i";case Y0.NONE:return"-"}throw new z0("Unknown location value: "+t)},J0.INTERIOR.get=function(){return 0},J0.BOUNDARY.get=function(){return 1},J0.EXTERIOR.get=function(){return 2},J0.NONE.get=function(){return-1},Object.defineProperties(Y0,J0);var Q0=function(t,e){return t.interfaces_&&t.interfaces_().indexOf(e)>-1},K0=function(){},$0={LOG_10:{configurable:!0}};K0.prototype.interfaces_=function(){return[]},K0.prototype.getClass=function(){return K0},K0.log10=function(t){var e=Math.log(t);return B0.isInfinite(e)||B0.isNaN(e)?e:e/K0.LOG_10},K0.min=function(t,e,n,r){var i=t;return e<i&&(i=e),n<i&&(i=n),r<i&&(i=r),i},K0.clamp=function(){if("number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1],n=arguments[2];return t<e?e:t>n?n:t}if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var r=arguments[0],i=arguments[1],o=arguments[2];return r<i?i:r>o?o:r}},K0.wrap=function(t,e){return t<0?e- -t%e:t%e},K0.max=function(){if(3===arguments.length){var t=arguments[1],e=arguments[2],n=arguments[0];return t>n&&(n=t),e>n&&(n=e),n}if(4===arguments.length){var r=arguments[1],i=arguments[2],o=arguments[3],s=arguments[0];return r>s&&(s=r),i>s&&(s=i),o>s&&(s=o),s}},K0.average=function(t,e){return(t+e)/2},$0.LOG_10.get=function(){return Math.log(10)},Object.defineProperties(K0,$0);var t1=function(t){this.str=t};t1.prototype.append=function(t){this.str+=t},t1.prototype.setCharAt=function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)},t1.prototype.toString=function(t){return this.str};var e1=function(t){this.value=t};e1.prototype.intValue=function(){return this.value},e1.prototype.compareTo=function(t){return this.value<t?-1:this.value>t?1:0},e1.isNaN=function(t){return Number.isNaN(t)};var n1=function(){};n1.isWhitespace=function(t){return t<=32&&t>=0||127===t},n1.toUpperCase=function(t){return t.toUpperCase()};var r1=function t(){if(this.yt=0,this.Lt=0,0===arguments.length)this.init(0);else if(1===arguments.length)if("number"==typeof arguments[0]){var e=arguments[0];this.init(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}else"string"==typeof arguments[0]&&t.call(this,t.parse(arguments[0]));else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.init(r,i)}},i1={PI:{configurable:!0},TWO_PI:{configurable:!0},PI_2:{configurable:!0},E:{configurable:!0},NaN:{configurable:!0},EPS:{configurable:!0},SPLIT:{configurable:!0},MAX_PRINT_DIGITS:{configurable:!0},TEN:{configurable:!0},ONE:{configurable:!0},SCI_NOT_EXPONENT_CHAR:{configurable:!0},SCI_NOT_ZERO:{configurable:!0}};r1.prototype.le=function(t){return(this.yt<t.yt||this.yt===t.yt)&&this.Lt<=t.Lt},r1.prototype.extractSignificantDigits=function(t,e){var n=this.abs(),r=r1.magnitude(n.yt),i=r1.TEN.pow(r);(n=n.divide(i)).gt(r1.TEN)?(n=n.divide(r1.TEN),r+=1):n.lt(r1.ONE)&&(n=n.multiply(r1.TEN),r-=1);for(var o=r+1,s=new t1,a=r1.MAX_PRINT_DIGITS-1,l=0;l<=a;l++){t&&l===o&&s.append(".");var h=Math.trunc(n.yt);if(h<0)break;var u=!1,c=0;h>9?(u=!0,c="9"):c="0"+h,s.append(c),n=n.subtract(r1.valueOf(h)).multiply(r1.TEN),u&&n.selfAdd(r1.TEN);var f=!0,d=r1.magnitude(n.yt);if(d<0&&Math.abs(d)>=a-l&&(f=!1),!f)break}return e[0]=r,s.toString()},r1.prototype.sqr=function(){return this.multiply(this)},r1.prototype.doubleValue=function(){return this.yt+this.Lt},r1.prototype.subtract=function(){if(arguments[0]instanceof r1){var t=arguments[0];return this.add(t.negate())}if("number"==typeof arguments[0]){var e=arguments[0];return this.add(-e)}},r1.prototype.equals=function(){if(1===arguments.length){var t=arguments[0];return this.yt===t.yt&&this.Lt===t.Lt}},r1.prototype.isZero=function(){return 0===this.yt&&0===this.Lt},r1.prototype.selfSubtract=function(){if(arguments[0]instanceof r1){var t=arguments[0];return this.isNaN()?this:this.selfAdd(-t.yt,-t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.isNaN()?this:this.selfAdd(-e,0)}},r1.prototype.getSpecialNumberString=function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null},r1.prototype.min=function(t){return this.le(t)?this:t},r1.prototype.selfDivide=function(){if(1===arguments.length){if(arguments[0]instanceof r1){var t=arguments[0];return this.selfDivide(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.selfDivide(e,0)}}else if(2===arguments.length){var n,r,i,o,s=arguments[0],a=arguments[1],l=null,h=null,u=null,c=null;return i=this.yt/s,c=(l=(u=r1.SPLIT*i)-(l=u-i))*(h=(c=r1.SPLIT*s)-(h=c-s))-(o=i*s)+l*(r=s-h)+(n=i-l)*h+n*r,c=i+(u=(this.yt-o-c+this.Lt-i*a)/s),this.yt=c,this.Lt=i-c+u,this}},r1.prototype.dump=function(){return"DD<"+this.yt+", "+this.Lt+">"},r1.prototype.divide=function(){if(arguments[0]instanceof r1){var t,e,n,r,i=arguments[0],o=null,s=null,a=null,l=null;return t=(n=this.yt/i.yt)-(o=(a=r1.SPLIT*n)-(o=a-n)),l=o*(s=(l=r1.SPLIT*i.yt)-(s=l-i.yt))-(r=n*i.yt)+o*(e=i.yt-s)+t*s+t*e,a=(this.yt-r-l+this.Lt-n*i.Lt)/i.yt,new r1(l=n+a,n-l+a)}if("number"==typeof arguments[0]){var h=arguments[0];return B0.isNaN(h)?r1.createNaN():r1.copy(this).selfDivide(h,0)}},r1.prototype.ge=function(t){return(this.yt>t.yt||this.yt===t.yt)&&this.Lt>=t.Lt},r1.prototype.pow=function(t){if(0===t)return r1.valueOf(1);var e=new r1(this),n=r1.valueOf(1),r=Math.abs(t);if(r>1)for(;r>0;)r%2==1&&n.selfMultiply(e),(r/=2)>0&&(e=e.sqr());else n=e;return t<0?n.reciprocal():n},r1.prototype.ceil=function(){if(this.isNaN())return r1.NaN;var t=Math.ceil(this.yt),e=0;return t===this.yt&&(e=Math.ceil(this.Lt)),new r1(t,e)},r1.prototype.compareTo=function(t){var e=t;return this.yt<e.yt?-1:this.yt>e.yt?1:this.Lt<e.Lt?-1:this.Lt>e.Lt?1:0},r1.prototype.rint=function(){return this.isNaN()?this:this.add(.5).floor()},r1.prototype.setValue=function(){if(arguments[0]instanceof r1){var t=arguments[0];return this.init(t),this}if("number"==typeof arguments[0]){var e=arguments[0];return this.init(e),this}},r1.prototype.max=function(t){return this.ge(t)?this:t},r1.prototype.sqrt=function(){if(this.isZero())return r1.valueOf(0);if(this.isNegative())return r1.NaN;var t=1/Math.sqrt(this.yt),e=this.yt*t,n=r1.valueOf(e),r=this.subtract(n.sqr()).yt*(.5*t);return n.add(r)},r1.prototype.selfAdd=function(){if(1===arguments.length){if(arguments[0]instanceof r1){var t=arguments[0];return this.selfAdd(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e,n,r,i,o,s=arguments[0],a=null;return a=(r=this.yt+s)-(i=r-this.yt),n=(o=(a=s-i+(this.yt-a))+this.Lt)+(r-(e=r+o)),this.yt=e+n,this.Lt=n+(e-this.yt),this}}else if(2===arguments.length){var l,h,u,c,f=arguments[0],d=arguments[1],p=null,g=null,m=null;u=this.yt+f,h=this.Lt+d,g=u-(m=u-this.yt),p=h-(c=h-this.Lt);var A=(l=u+(m=(g=f-m+(this.yt-g))+h))+(m=(p=d-c+(this.Lt-p))+(m+(u-l))),y=m+(l-A);return this.yt=A,this.Lt=y,this}},r1.prototype.selfMultiply=function(){if(1===arguments.length){if(arguments[0]instanceof r1){var t=arguments[0];return this.selfMultiply(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.selfMultiply(e,0)}}else if(2===arguments.length){var n,r,i=arguments[0],o=arguments[1],s=null,a=null,l=null,h=null;s=(l=r1.SPLIT*this.yt)-this.yt,h=r1.SPLIT*i,s=l-s,n=this.yt-s,a=h-i;var u=(l=this.yt*i)+(h=s*(a=h-a)-l+s*(r=i-a)+n*a+n*r+(this.yt*o+this.Lt*i)),c=h+(s=l-u);return this.yt=u,this.Lt=c,this}},r1.prototype.selfSqr=function(){return this.selfMultiply(this)},r1.prototype.floor=function(){if(this.isNaN())return r1.NaN;var t=Math.floor(this.yt),e=0;return t===this.yt&&(e=Math.floor(this.Lt)),new r1(t,e)},r1.prototype.negate=function(){return this.isNaN()?this:new r1(-this.yt,-this.Lt)},r1.prototype.clone=function(){},r1.prototype.multiply=function(){if(arguments[0]instanceof r1){var t=arguments[0];return t.isNaN()?r1.createNaN():r1.copy(this).selfMultiply(t)}if("number"==typeof arguments[0]){var e=arguments[0];return B0.isNaN(e)?r1.createNaN():r1.copy(this).selfMultiply(e,0)}},r1.prototype.isNaN=function(){return B0.isNaN(this.yt)},r1.prototype.intValue=function(){return Math.trunc(this.yt)},r1.prototype.toString=function(){var t=r1.magnitude(this.yt);return t>=-3&&t<=20?this.toStandardNotation():this.toSciNotation()},r1.prototype.toStandardNotation=function(){var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!0,e),r=e[0]+1,i=n;if("."===n.charAt(0))i="0"+n;else if(r<0)i="0."+r1.stringOfChar("0",-r)+n;else if(-1===n.indexOf(".")){var o=r-n.length;i=n+r1.stringOfChar("0",o)+".0"}return this.isNegative()?"-"+i:i},r1.prototype.reciprocal=function(){var t,e,n,r,i=null,o=null,s=null,a=null;t=(n=1/this.yt)-(i=(s=r1.SPLIT*n)-(i=s-n)),o=(a=r1.SPLIT*this.yt)-this.yt;var l=n+(s=(1-(r=n*this.yt)-(a=i*(o=a-o)-r+i*(e=this.yt-o)+t*o+t*e)-n*this.Lt)/this.yt);return new r1(l,n-l+s)},r1.prototype.toSciNotation=function(){if(this.isZero())return r1.SCI_NOT_ZERO;var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!1,e),r=r1.SCI_NOT_EXPONENT_CHAR+e[0];if("0"===n.charAt(0))throw new Error("Found leading zero: "+n);var i="";n.length>1&&(i=n.substring(1));var o=n.charAt(0)+"."+i;return this.isNegative()?"-"+o+r:o+r},r1.prototype.abs=function(){return this.isNaN()?r1.NaN:this.isNegative()?this.negate():new r1(this)},r1.prototype.isPositive=function(){return(this.yt>0||0===this.yt)&&this.Lt>0},r1.prototype.lt=function(t){return(this.yt<t.yt||this.yt===t.yt)&&this.Lt<t.Lt},r1.prototype.add=function(){if(arguments[0]instanceof r1){var t=arguments[0];return r1.copy(this).selfAdd(t)}if("number"==typeof arguments[0]){var e=arguments[0];return r1.copy(this).selfAdd(e)}},r1.prototype.init=function(){if(1===arguments.length){if("number"==typeof arguments[0]){var t=arguments[0];this.yt=t,this.Lt=0}else if(arguments[0]instanceof r1){var e=arguments[0];this.yt=e.yt,this.Lt=e.Lt}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.yt=n,this.Lt=r}},r1.prototype.gt=function(t){return(this.yt>t.yt||this.yt===t.yt)&&this.Lt>t.Lt},r1.prototype.isNegative=function(){return(this.yt<0||0===this.yt)&&this.Lt<0},r1.prototype.trunc=function(){return this.isNaN()?r1.NaN:this.isPositive()?this.floor():this.ceil()},r1.prototype.signum=function(){return this.yt>0?1:this.yt<0?-1:this.Lt>0?1:this.Lt<0?-1:0},r1.prototype.interfaces_=function(){return[G0,j0,U0]},r1.prototype.getClass=function(){return r1},r1.sqr=function(t){return r1.valueOf(t).selfMultiply(t)},r1.valueOf=function(){return"string"==typeof arguments[0]?r1.parse(arguments[0]):"number"==typeof arguments[0]?new r1(arguments[0]):void 0},r1.sqrt=function(t){return r1.valueOf(t).sqrt()},r1.parse=function(t){for(var e=0,n=t.length;n1.isWhitespace(t.charAt(e));)e++;var r=!1;if(e<n){var i=t.charAt(e);"-"!==i&&"+"!==i||(e++,"-"===i&&(r=!0))}for(var o=new r1,s=0,a=0,l=0;!(e>=n);){var h=t.charAt(e);if(e++,n1.isDigit(h)){var u=h-"0";o.selfMultiply(r1.TEN),o.selfAdd(u),s++}else{if("."!==h){if("e"===h||"E"===h){var c=t.substring(e);try{l=e1.parseInt(c)}catch(m){throw m instanceof Error?new Error("Invalid exponent "+c+" in string "+t):m}break}throw new Error("Unexpected character '"+h+"' at position "+e+" in string "+t)}a=s}}var f=o,d=s-a-l;if(0===d)f=o;else if(d>0){var p=r1.TEN.pow(d);f=o.divide(p)}else if(d<0){var g=r1.TEN.pow(-d);f=o.multiply(g)}return r?f.negate():f},r1.createNaN=function(){return new r1(B0.NaN,B0.NaN)},r1.copy=function(t){return new r1(t)},r1.magnitude=function(t){var e=Math.abs(t),n=Math.log(e)/Math.log(10),r=Math.trunc(Math.floor(n));return 10*Math.pow(10,r)<=e&&(r+=1),r},r1.stringOfChar=function(t,e){for(var n=new t1,r=0;r<e;r++)n.append(t);return n.toString()},i1.PI.get=function(){return new r1(3.141592653589793,12246467991473532e-32)},i1.TWO_PI.get=function(){return new r1(6.283185307179586,24492935982947064e-32)},i1.PI_2.get=function(){return new r1(1.5707963267948966,6123233995736766e-32)},i1.E.get=function(){return new r1(2.718281828459045,14456468917292502e-32)},i1.NaN.get=function(){return new r1(B0.NaN,B0.NaN)},i1.EPS.get=function(){return 123259516440783e-46},i1.SPLIT.get=function(){return 134217729},i1.MAX_PRINT_DIGITS.get=function(){return 32},i1.TEN.get=function(){return r1.valueOf(10)},i1.ONE.get=function(){return r1.valueOf(1)},i1.SCI_NOT_EXPONENT_CHAR.get=function(){return"E"},i1.SCI_NOT_ZERO.get=function(){return"0.0E0"},Object.defineProperties(r1,i1);var o1=function(){},s1={DP_SAFE_EPSILON:{configurable:!0}};o1.prototype.interfaces_=function(){return[]},o1.prototype.getClass=function(){return o1},o1.orientationIndex=function(t,e,n){var r=o1.orientationIndexFilter(t,e,n);if(r<=1)return r;var i=r1.valueOf(e.x).selfAdd(-t.x),o=r1.valueOf(e.y).selfAdd(-t.y),s=r1.valueOf(n.x).selfAdd(-e.x),a=r1.valueOf(n.y).selfAdd(-e.y);return i.selfMultiply(a).selfSubtract(o.selfMultiply(s)).signum()},o1.signOfDet2x2=function(t,e,n,r){return t.multiply(r).selfSubtract(e.multiply(n)).signum()},o1.intersection=function(t,e,n,r){var i=r1.valueOf(r.y).selfSubtract(n.y).selfMultiply(r1.valueOf(e.x).selfSubtract(t.x)),o=r1.valueOf(r.x).selfSubtract(n.x).selfMultiply(r1.valueOf(e.y).selfSubtract(t.y)),s=i.subtract(o),a=r1.valueOf(r.x).selfSubtract(n.x).selfMultiply(r1.valueOf(t.y).selfSubtract(n.y)),l=r1.valueOf(r.y).selfSubtract(n.y).selfMultiply(r1.valueOf(t.x).selfSubtract(n.x)),h=a.subtract(l).selfDivide(s).doubleValue(),u=r1.valueOf(t.x).selfAdd(r1.valueOf(e.x).selfSubtract(t.x).selfMultiply(h)).doubleValue(),c=r1.valueOf(e.x).selfSubtract(t.x).selfMultiply(r1.valueOf(t.y).selfSubtract(n.y)),f=r1.valueOf(e.y).selfSubtract(t.y).selfMultiply(r1.valueOf(t.x).selfSubtract(n.x)),d=c.subtract(f).selfDivide(s).doubleValue(),p=r1.valueOf(n.y).selfAdd(r1.valueOf(r.y).selfSubtract(n.y).selfMultiply(d)).doubleValue();return new W0(u,p)},o1.orientationIndexFilter=function(t,e,n){var r=null,i=(t.x-n.x)*(e.y-n.y),o=(t.y-n.y)*(e.x-n.x),s=i-o;if(i>0){if(o<=0)return o1.signum(s);r=i+o}else{if(!(i<0))return o1.signum(s);if(o>=0)return o1.signum(s);r=-i-o}var a=o1.DP_SAFE_EPSILON*r;return s>=a||-s>=a?o1.signum(s):2},o1.signum=function(t){return t>0?1:t<0?-1:0},s1.DP_SAFE_EPSILON.get=function(){return 1e-15},Object.defineProperties(o1,s1);var a1=function(){},l1={X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0},M:{configurable:!0}};l1.X.get=function(){return 0},l1.Y.get=function(){return 1},l1.Z.get=function(){return 2},l1.M.get=function(){return 3},a1.prototype.setOrdinate=function(t,e,n){},a1.prototype.size=function(){},a1.prototype.getOrdinate=function(t,e){},a1.prototype.getCoordinate=function(){},a1.prototype.getCoordinateCopy=function(t){},a1.prototype.getDimension=function(){},a1.prototype.getX=function(t){},a1.prototype.clone=function(){},a1.prototype.expandEnvelope=function(t){},a1.prototype.copy=function(){},a1.prototype.getY=function(t){},a1.prototype.toCoordinateArray=function(){},a1.prototype.interfaces_=function(){return[U0]},a1.prototype.getClass=function(){return a1},Object.defineProperties(a1,l1);var h1=function(){},u1=function(t){function e(){t.call(this,"Projective point not representable on the Cartesian plane.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(h1),c1=function(){};c1.arraycopy=function(t,e,n,r,i){for(var o=0,s=e;s<e+i;s++)n[r+o]=t[s],o++},c1.getProperty=function(t){return{"line.separator":"\n"}[t]};var f1=function t(){if(this.x=null,this.y=null,this.w=null,0===arguments.length)this.x=0,this.y=0,this.w=1;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.w=1}else if(2===arguments.length){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var n=arguments[0],r=arguments[1];this.x=n,this.y=r,this.w=1}else if(arguments[0]instanceof t&&arguments[1]instanceof t){var i=arguments[0],o=arguments[1];this.x=i.y*o.w-o.y*i.w,this.y=o.x*i.w-i.x*o.w,this.w=i.x*o.y-o.x*i.y}else if(arguments[0]instanceof W0&&arguments[1]instanceof W0){var s=arguments[0],a=arguments[1];this.x=s.y-a.y,this.y=a.x-s.x,this.w=s.x*a.y-a.x*s.y}}else if(3===arguments.length){var l=arguments[0],h=arguments[1],u=arguments[2];this.x=l,this.y=h,this.w=u}else if(4===arguments.length){var c=arguments[0],f=arguments[1],d=arguments[2],p=arguments[3],g=c.y-f.y,m=f.x-c.x,A=c.x*f.y-f.x*c.y,y=d.y-p.y,v=p.x-d.x,x=d.x*p.y-p.x*d.y;this.x=m*x-v*A,this.y=y*A-g*x,this.w=g*v-y*m}};f1.prototype.getY=function(){var t=this.y/this.w;if(B0.isNaN(t)||B0.isInfinite(t))throw new u1;return t},f1.prototype.getX=function(){var t=this.x/this.w;if(B0.isNaN(t)||B0.isInfinite(t))throw new u1;return t},f1.prototype.getCoordinate=function(){var t=new W0;return t.x=this.getX(),t.y=this.getY(),t},f1.prototype.interfaces_=function(){return[]},f1.prototype.getClass=function(){return f1},f1.intersection=function(t,e,n,r){var i=t.y-e.y,o=e.x-t.x,s=t.x*e.y-e.x*t.y,a=n.y-r.y,l=r.x-n.x,h=n.x*r.y-r.x*n.y,u=i*l-a*o,c=(o*h-l*s)/u,f=(a*s-i*h)/u;if(B0.isNaN(c)||B0.isInfinite(c)||B0.isNaN(f)||B0.isInfinite(f))throw new u1;return new W0(c,f)};var d1=function t(){if(this.Tt=null,this.Ot=null,this.Ft=null,this.Ut=null,0===arguments.length)this.init();else if(1===arguments.length){if(arguments[0]instanceof W0){var e=arguments[0];this.init(e.x,e.x,e.y,e.y)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.init(r.x,i.x,r.y,i.y)}else if(4===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2],l=arguments[3];this.init(o,s,a,l)}},p1={serialVersionUID:{configurable:!0}};d1.prototype.getArea=function(){return this.getWidth()*this.getHeight()},d1.prototype.equals=function(t){if(!(t instanceof d1))return!1;var e=t;return this.isNull()?e.isNull():this.Ot===e.getMaxX()&&this.Ut===e.getMaxY()&&this.Tt===e.getMinX()&&this.Ft===e.getMinY()},d1.prototype.intersection=function(t){if(this.isNull()||t.isNull()||!this.intersects(t))return new d1;var e=this.Tt>t.Tt?this.Tt:t.Tt,n=this.Ft>t.Ft?this.Ft:t.Ft,r=this.Ot<t.Ot?this.Ot:t.Ot,i=this.Ut<t.Ut?this.Ut:t.Ut;return new d1(e,r,n,i)},d1.prototype.isNull=function(){return this.Ot<this.Tt},d1.prototype.getMaxX=function(){return this.Ot},d1.prototype.covers=function(){if(1===arguments.length){if(arguments[0]instanceof W0){var t=arguments[0];return this.covers(t.x,t.y)}if(arguments[0]instanceof d1){var e=arguments[0];return!this.isNull()&&!e.isNull()&&e.getMinX()>=this.Tt&&e.getMaxX()<=this.Ot&&e.getMinY()>=this.Ft&&e.getMaxY()<=this.Ut}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return!this.isNull()&&n>=this.Tt&&n<=this.Ot&&r>=this.Ft&&r<=this.Ut}},d1.prototype.intersects=function(){if(1===arguments.length){if(arguments[0]instanceof d1){var t=arguments[0];return!this.isNull()&&!t.isNull()&&!(t.Tt>this.Ot||t.Ot<this.Tt||t.Ft>this.Ut||t.Ut<this.Ft)}if(arguments[0]instanceof W0){var e=arguments[0];return this.intersects(e.x,e.y)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return!this.isNull()&&!(n>this.Ot||n<this.Tt||r>this.Ut||r<this.Ft)}},d1.prototype.getMinY=function(){return this.Ft},d1.prototype.getMinX=function(){return this.Tt},d1.prototype.expandToInclude=function(){if(1===arguments.length){if(arguments[0]instanceof W0){var t=arguments[0];this.expandToInclude(t.x,t.y)}else if(arguments[0]instanceof d1){var e=arguments[0];if(e.isNull())return null;this.isNull()?(this.Tt=e.getMinX(),this.Ot=e.getMaxX(),this.Ft=e.getMinY(),this.Ut=e.getMaxY()):(e.Tt<this.Tt&&(this.Tt=e.Tt),e.Ot>this.Ot&&(this.Ot=e.Ot),e.Ft<this.Ft&&(this.Ft=e.Ft),e.Ut>this.Ut&&(this.Ut=e.Ut))}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.isNull()?(this.Tt=n,this.Ot=n,this.Ft=r,this.Ut=r):(n<this.Tt&&(this.Tt=n),n>this.Ot&&(this.Ot=n),r<this.Ft&&(this.Ft=r),r>this.Ut&&(this.Ut=r))}},d1.prototype.minExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t<e?t:e},d1.prototype.getWidth=function(){return this.isNull()?0:this.Ot-this.Tt},d1.prototype.compareTo=function(t){var e=t;return this.isNull()?e.isNull()?0:-1:e.isNull()?1:this.Tt<e.Tt?-1:this.Tt>e.Tt?1:this.Ft<e.Ft?-1:this.Ft>e.Ft?1:this.Ot<e.Ot?-1:this.Ot>e.Ot?1:this.Ut<e.Ut?-1:this.Ut>e.Ut?1:0},d1.prototype.translate=function(t,e){if(this.isNull())return null;this.init(this.getMinX()+t,this.getMaxX()+t,this.getMinY()+e,this.getMaxY()+e)},d1.prototype.toString=function(){return"Env["+this.Tt+" : "+this.Ot+", "+this.Ft+" : "+this.Ut+"]"},d1.prototype.setToNull=function(){this.Tt=0,this.Ot=-1,this.Ft=0,this.Ut=-1},d1.prototype.getHeight=function(){return this.isNull()?0:this.Ut-this.Ft},d1.prototype.maxExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t>e?t:e},d1.prototype.expandBy=function(){if(1===arguments.length){var t=arguments[0];this.expandBy(t,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.isNull())return null;this.Tt-=e,this.Ot+=e,this.Ft-=n,this.Ut+=n,(this.Tt>this.Ot||this.Ft>this.Ut)&&this.setToNull()}},d1.prototype.contains=function(){if(1===arguments.length){if(arguments[0]instanceof d1){var t=arguments[0];return this.covers(t)}if(arguments[0]instanceof W0){var e=arguments[0];return this.covers(e)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return this.covers(n,r)}},d1.prototype.centre=function(){return this.isNull()?null:new W0((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)},d1.prototype.init=function(){if(0===arguments.length)this.setToNull();else if(1===arguments.length){if(arguments[0]instanceof W0){var t=arguments[0];this.init(t.x,t.x,t.y,t.y)}else if(arguments[0]instanceof d1){var e=arguments[0];this.Tt=e.Tt,this.Ot=e.Ot,this.Ft=e.Ft,this.Ut=e.Ut}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.init(n.x,r.x,n.y,r.y)}else if(4===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];i<o?(this.Tt=i,this.Ot=o):(this.Tt=o,this.Ot=i),s<a?(this.Ft=s,this.Ut=a):(this.Ft=a,this.Ut=s)}},d1.prototype.getMaxY=function(){return this.Ut},d1.prototype.distance=function(t){if(this.intersects(t))return 0;var e=0;this.Ot<t.Tt?e=t.Tt-this.Ot:this.Tt>t.Ot&&(e=this.Tt-t.Ot);var n=0;return this.Ut<t.Ft?n=t.Ft-this.Ut:this.Ft>t.Ut&&(n=this.Ft-t.Ut),0===e?n:0===n?e:Math.sqrt(e*e+n*n)},d1.prototype.hashCode=function(){var t=17;return 37*(t=37*(t=37*(t=37*t+W0.hashCode(this.Tt))+W0.hashCode(this.Ot))+W0.hashCode(this.Ft))+W0.hashCode(this.Ut)},d1.prototype.interfaces_=function(){return[j0,G0]},d1.prototype.getClass=function(){return d1},d1.intersects=function(){if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];return n.x>=(t.x<e.x?t.x:e.x)&&n.x<=(t.x>e.x?t.x:e.x)&&n.y>=(t.y<e.y?t.y:e.y)&&n.y<=(t.y>e.y?t.y:e.y)}if(4===arguments.length){var r=arguments[0],i=arguments[1],o=arguments[2],s=arguments[3],a=Math.min(o.x,s.x),l=Math.max(o.x,s.x),h=Math.min(r.x,i.x),u=Math.max(r.x,i.x);return!(h>l||u<a||(a=Math.min(o.y,s.y),l=Math.max(o.y,s.y),h=Math.min(r.y,i.y),u=Math.max(r.y,i.y),h>l||u<a))}},p1.serialVersionUID.get=function(){return 0x51845cd552189800},Object.defineProperties(d1,p1);var g1={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,emptyTypeStr:/^\s*(\w+)\s*EMPTY\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},m1=function(t){this.geometryFactory=t||new e5};m1.prototype.read=function(t){var e,n,r;t=t.replace(/[\n\r]/g," ");var i=g1.typeStr.exec(t);if(-1!==t.search("EMPTY")&&((i=g1.emptyTypeStr.exec(t))[2]=void 0),i&&(n=i[1].toLowerCase(),r=i[2],y1[n]&&(e=y1[n].apply(this,[r]))),void 0===e)throw new Error("Could not parse WKT "+t);return e},m1.prototype.write=function(t){return this.extractGeometry(t)},m1.prototype.extractGeometry=function(t){var e=t.getGeometryType().toLowerCase();if(!A1[e])return null;var n=e.toUpperCase();return t.isEmpty()?n+" EMPTY":n+"("+A1[e].apply(this,[t])+")"};var A1={coordinate:function(t){return t.x+" "+t.y},point:function(t){return A1.coordinate.call(this,t.Et.Et[0])},multipoint:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+A1.point.apply(this,[t.Nt[n]])+")");return e.join(",")},linestring:function(t){for(var e=[],n=0,r=t.jt.Et.length;n<r;++n)e.push(A1.coordinate.apply(this,[t.jt.Et[n]]));return e.join(",")},linearring:function(t){for(var e=[],n=0,r=t.jt.Et.length;n<r;++n)e.push(A1.coordinate.apply(this,[t.jt.Et[n]]));return e.join(",")},multilinestring:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+A1.linestring.apply(this,[t.Nt[n]])+")");return e.join(",")},polygon:function(t){var e=[];e.push("("+A1.linestring.apply(this,[t.Qt])+")");for(var n=0,r=t.St.length;n<r;++n)e.push("("+A1.linestring.apply(this,[t.St[n]])+")");return e.join(",")},multipolygon:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+A1.polygon.apply(this,[t.Nt[n]])+")");return e.join(",")},geometrycollection:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push(this.extractGeometry(t.Nt[n]));return e.join(",")}},y1={point:function(t){if(void 0===t)return this.geometryFactory.createPoint();var e=t.trim().split(g1.spaces);return this.geometryFactory.createPoint(new W0(Number.parseFloat(e[0]),Number.parseFloat(e[1])))},multipoint:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiPoint();for(var n=t.trim().split(","),r=[],i=0,o=n.length;i<o;++i)e=n[i].replace(g1.trimParens,"$1"),r.push(y1.point.apply(this,[e]));return this.geometryFactory.createMultiPoint(r)},linestring:function(t){if(void 0===t)return this.geometryFactory.createLineString();for(var e,n=t.trim().split(","),r=[],i=0,o=n.length;i<o;++i)e=n[i].trim().split(g1.spaces),r.push(new W0(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLineString(r)},linearring:function(t){if(void 0===t)return this.geometryFactory.createLinearRing();for(var e,n=t.trim().split(","),r=[],i=0,o=n.length;i<o;++i)e=n[i].trim().split(g1.spaces),r.push(new W0(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLinearRing(r)},multilinestring:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiLineString();for(var n=t.trim().split(g1.parenComma),r=[],i=0,o=n.length;i<o;++i)e=n[i].replace(g1.trimParens,"$1"),r.push(y1.linestring.apply(this,[e]));return this.geometryFactory.createMultiLineString(r)},polygon:function(t){var e,n,r;if(void 0===t)return this.geometryFactory.createPolygon();for(var i,o=t.trim().split(g1.parenComma),s=[],a=0,l=o.length;a<l;++a)e=o[a].replace(g1.trimParens,"$1"),n=y1.linestring.apply(this,[e]),r=this.geometryFactory.createLinearRing(n.jt),0===a?i=r:s.push(r);return this.geometryFactory.createPolygon(i,s)},multipolygon:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiPolygon();for(var n=t.trim().split(g1.doubleParenComma),r=[],i=0,o=n.length;i<o;++i)e=n[i].replace(g1.trimParens,"$1"),r.push(y1.polygon.apply(this,[e]));return this.geometryFactory.createMultiPolygon(r)},geometrycollection:function(t){if(void 0===t)return this.geometryFactory.createGeometryCollection();for(var e=(t=t.replace(/,\s*([A-Za-z])/g,"|$1")).trim().split("|"),n=[],r=0,i=e.length;r<i;++r)n.push(this.read(e[r]));return this.geometryFactory.createGeometryCollection(n)}},v1=function(t){this.parser=new m1(t)};v1.prototype.write=function(t){return this.parser.write(t)},v1.toLineString=function(t,e){if(2!==arguments.length)throw new Error("Not implemented");return"LINESTRING ( "+t.x+" "+t.y+", "+e.x+" "+e.y+" )"};var x1=function(t){function e(e){t.call(this,e),this.name="RuntimeException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),_1=function(t){function e(){if(t.call(this),0===arguments.length)t.call(this);else if(1===arguments.length){var e=arguments[0];t.call(this,e)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(x1),b1=function(){};b1.prototype.interfaces_=function(){return[]},b1.prototype.getClass=function(){return b1},b1.shouldNeverReachHere=function(){if(0===arguments.length)b1.shouldNeverReachHere(null);else if(1===arguments.length){var t=arguments[0];throw new _1("Should never reach here"+(null!==t?": "+t:""))}},b1.isTrue=function(){var t;if(1===arguments.length)b1.isTrue(arguments[0],null);else if(2===arguments.length&&(t=arguments[1],!arguments[0]))throw null===t?new _1:new _1(t)},b1.equals=function(){var t,e,n;if(2===arguments.length)b1.equals(t=arguments[0],e=arguments[1],null);else if(3===arguments.length&&(t=arguments[0],n=arguments[2],!(e=arguments[1]).equals(t)))throw new _1("Expected "+t+" but encountered "+e+(null!==n?": "+n:""))};var w1=function(){this.Bt=null,this.kt=Array(2).fill().map((function(){return Array(2)})),this.Rt=new Array(2).fill(null),this.Gt=null,this.Yt=null,this.qt=null,this.Vt=null,this.Wt=null,this.Rt[0]=new W0,this.Rt[1]=new W0,this.qt=this.Rt[0],this.Vt=this.Rt[1],this.Bt=0},T1={DONT_INTERSECT:{configurable:!0},DO_INTERSECT:{configurable:!0},COLLINEAR:{configurable:!0},NO_INTERSECTION:{configurable:!0},POINT_INTERSECTION:{configurable:!0},COLLINEAR_INTERSECTION:{configurable:!0}};w1.prototype.getIndexAlongSegment=function(t,e){return this.computeIntLineIndex(),this.Gt[t][e]},w1.prototype.getTopologySummary=function(){var t=new t1;return this.isEndPoint()&&t.append(" endpoint"),this.Yt&&t.append(" proper"),this.isCollinear()&&t.append(" collinear"),t.toString()},w1.prototype.computeIntersection=function(t,e,n,r){this.kt[0][0]=t,this.kt[0][1]=e,this.kt[1][0]=n,this.kt[1][1]=r,this.Bt=this.computeIntersect(t,e,n,r)},w1.prototype.getIntersectionNum=function(){return this.Bt},w1.prototype.computeIntLineIndex=function(){if(0===arguments.length)null===this.Gt&&(this.Gt=Array(2).fill().map((function(){return Array(2)})),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(1===arguments.length){var t=arguments[0];this.getEdgeDistance(t,0)>this.getEdgeDistance(t,1)?(this.Gt[t][0]=0,this.Gt[t][1]=1):(this.Gt[t][0]=1,this.Gt[t][1]=0)}},w1.prototype.isProper=function(){return this.hasIntersection()&&this.Yt},w1.prototype.setPrecisionModel=function(t){this.Wt=t},w1.prototype.isInteriorIntersection=function(){var t=this;if(0===arguments.length)return!!this.isInteriorIntersection(0)||!!this.isInteriorIntersection(1);if(1===arguments.length){for(var e=arguments[0],n=0;n<this.Bt;n++)if(!t.Rt[n].equals2D(t.kt[e][0])&&!t.Rt[n].equals2D(t.kt[e][1]))return!0;return!1}},w1.prototype.getIntersection=function(t){return this.Rt[t]},w1.prototype.isEndPoint=function(){return this.hasIntersection()&&!this.Yt},w1.prototype.hasIntersection=function(){return this.Bt!==w1.NO_INTERSECTION},w1.prototype.getEdgeDistance=function(t,e){return w1.computeEdgeDistance(this.Rt[e],this.kt[t][0],this.kt[t][1])},w1.prototype.isCollinear=function(){return this.Bt===w1.COLLINEAR_INTERSECTION},w1.prototype.toString=function(){return v1.toLineString(this.kt[0][0],this.kt[0][1])+" - "+v1.toLineString(this.kt[1][0],this.kt[1][1])+this.getTopologySummary()},w1.prototype.getEndpoint=function(t,e){return this.kt[t][e]},w1.prototype.isIntersection=function(t){for(var e=0;e<this.Bt;e++)if(this.Rt[e].equals2D(t))return!0;return!1},w1.prototype.getIntersectionAlongSegment=function(t,e){return this.computeIntLineIndex(),this.Rt[this.Gt[t][e]]},w1.prototype.interfaces_=function(){return[]},w1.prototype.getClass=function(){return w1},w1.computeEdgeDistance=function(t,e,n){var r=Math.abs(n.x-e.x),i=Math.abs(n.y-e.y),o=-1;if(t.equals(e))o=0;else if(t.equals(n))o=r>i?r:i;else{var s=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y);0!==(o=r>i?s:a)||t.equals(e)||(o=Math.max(s,a))}return b1.isTrue(!(0===o&&!t.equals(e)),"Bad distance calculation"),o},w1.nonRobustComputeEdgeDistance=function(t,e,n){var r=t.x-e.x,i=t.y-e.y,o=Math.sqrt(r*r+i*i);return b1.isTrue(!(0===o&&!t.equals(e)),"Invalid distance calculation"),o},T1.DONT_INTERSECT.get=function(){return 0},T1.DO_INTERSECT.get=function(){return 1},T1.COLLINEAR.get=function(){return 2},T1.NO_INTERSECTION.get=function(){return 0},T1.POINT_INTERSECTION.get=function(){return 1},T1.COLLINEAR_INTERSECTION.get=function(){return 2},Object.defineProperties(w1,T1);var M1=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isInSegmentEnvelopes=function(t){var e=new d1(this.kt[0][0],this.kt[0][1]),n=new d1(this.kt[1][0],this.kt[1][1]);return e.contains(t)&&n.contains(t)},e.prototype.computeIntersection=function(){if(3!==arguments.length)return t.prototype.computeIntersection.apply(this,arguments);var e=arguments[0],n=arguments[1],r=arguments[2];if(this.Yt=!1,d1.intersects(n,r,e)&&0===I1.orientationIndex(n,r,e)&&0===I1.orientationIndex(r,n,e))return this.Yt=!0,(e.equals(n)||e.equals(r))&&(this.Yt=!1),this.Bt=t.POINT_INTERSECTION,null;this.Bt=t.NO_INTERSECTION},e.prototype.normalizeToMinimum=function(t,e,n,r,i){i.x=this.smallestInAbsValue(t.x,e.x,n.x,r.x),i.y=this.smallestInAbsValue(t.y,e.y,n.y,r.y),t.x-=i.x,t.y-=i.y,e.x-=i.x,e.y-=i.y,n.x-=i.x,n.y-=i.y,r.x-=i.x,r.y-=i.y},e.prototype.safeHCoordinateIntersection=function(t,n,r,i){var o=null;try{o=f1.intersection(t,n,r,i)}catch(s){if(!(s instanceof u1))throw s;o=e.nearestEndpoint(t,n,r,i)}return o},e.prototype.intersection=function(t,n,r,i){var o=this.intersectionWithNormalization(t,n,r,i);return this.isInSegmentEnvelopes(o)||(o=new W0(e.nearestEndpoint(t,n,r,i))),null!==this.Wt&&this.Wt.makePrecise(o),o},e.prototype.smallestInAbsValue=function(t,e,n,r){var i=t,o=Math.abs(i);return Math.abs(e)<o&&(i=e,o=Math.abs(e)),Math.abs(n)<o&&(i=n,o=Math.abs(n)),Math.abs(r)<o&&(i=r),i},e.prototype.checkDD=function(t,e,n,r,i){var o=o1.intersection(t,e,n,r),s=this.isInSegmentEnvelopes(o);c1.out.println("DD in env = "+s+"  --------------------- "+o),i.distance(o)>1e-4&&c1.out.println("Distance = "+i.distance(o))},e.prototype.intersectionWithNormalization=function(t,e,n,r){var i=new W0(t),o=new W0(e),s=new W0(n),a=new W0(r),l=new W0;this.normalizeToEnvCentre(i,o,s,a,l);var h=this.safeHCoordinateIntersection(i,o,s,a);return h.x+=l.x,h.y+=l.y,h},e.prototype.computeCollinearIntersection=function(e,n,r,i){var o=d1.intersects(e,n,r),s=d1.intersects(e,n,i),a=d1.intersects(r,i,e),l=d1.intersects(r,i,n);return o&&s?(this.Rt[0]=r,this.Rt[1]=i,t.COLLINEAR_INTERSECTION):a&&l?(this.Rt[0]=e,this.Rt[1]=n,t.COLLINEAR_INTERSECTION):o&&a?(this.Rt[0]=r,this.Rt[1]=e,!r.equals(e)||s||l?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):o&&l?(this.Rt[0]=r,this.Rt[1]=n,!r.equals(n)||s||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):s&&a?(this.Rt[0]=i,this.Rt[1]=e,!i.equals(e)||o||l?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):s&&l?(this.Rt[0]=i,this.Rt[1]=n,!i.equals(n)||o||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):t.NO_INTERSECTION},e.prototype.normalizeToEnvCentre=function(t,e,n,r,i){var o=t.x<e.x?t.x:e.x,s=t.y<e.y?t.y:e.y,a=t.x>e.x?t.x:e.x,l=t.y>e.y?t.y:e.y,h=n.x<r.x?n.x:r.x,u=n.y<r.y?n.y:r.y,c=n.x>r.x?n.x:r.x,f=n.y>r.y?n.y:r.y,d=((o>h?o:h)+(a<c?a:c))/2,p=((s>u?s:u)+(l<f?l:f))/2;i.x=d,i.y=p,t.x-=i.x,t.y-=i.y,e.x-=i.x,e.y-=i.y,n.x-=i.x,n.y-=i.y,r.x-=i.x,r.y-=i.y},e.prototype.computeIntersect=function(e,n,r,i){if(this.Yt=!1,!d1.intersects(e,n,r,i))return t.NO_INTERSECTION;var o=I1.orientationIndex(e,n,r),s=I1.orientationIndex(e,n,i);if(o>0&&s>0||o<0&&s<0)return t.NO_INTERSECTION;var a=I1.orientationIndex(r,i,e),l=I1.orientationIndex(r,i,n);return a>0&&l>0||a<0&&l<0?t.NO_INTERSECTION:0===o&&0===s&&0===a&&0===l?this.computeCollinearIntersection(e,n,r,i):(0===o||0===s||0===a||0===l?(this.Yt=!1,e.equals2D(r)||e.equals2D(i)?this.Rt[0]=e:n.equals2D(r)||n.equals2D(i)?this.Rt[0]=n:0===o?this.Rt[0]=new W0(r):0===s?this.Rt[0]=new W0(i):0===a?this.Rt[0]=new W0(e):0===l&&(this.Rt[0]=new W0(n))):(this.Yt=!0,this.Rt[0]=this.intersection(e,n,r,i)),t.POINT_INTERSECTION)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.nearestEndpoint=function(t,e,n,r){var i=t,o=I1.distancePointLine(t,n,r),s=I1.distancePointLine(e,n,r);return s<o&&(o=s,i=e),(s=I1.distancePointLine(n,t,e))<o&&(o=s,i=n),(s=I1.distancePointLine(r,t,e))<o&&(o=s,i=r),i},e}(w1),C1=function(){};C1.prototype.interfaces_=function(){return[]},C1.prototype.getClass=function(){return C1},C1.orientationIndex=function(t,e,n){var r=e.x-t.x,i=e.y-t.y,o=n.x-e.x,s=n.y-e.y;return C1.signOfDet2x2(r,i,o,s)},C1.signOfDet2x2=function(t,e,n,r){var i=null,o=null,s=null;if(i=1,0===t||0===r)return 0===e||0===n?0:e>0?n>0?-i:i:n>0?i:-i;if(0===e||0===n)return r>0?t>0?i:-i:t>0?-i:i;if(e>0?r>0?e<=r||(i=-i,o=t,t=n,n=o,o=e,e=r,r=o):e<=-r?(i=-i,n=-n,r=-r):(o=t,t=-n,n=o,o=e,e=-r,r=o):r>0?-e<=r?(i=-i,t=-t,e=-e):(o=-t,t=n,n=o,o=-e,e=r,r=o):e>=r?(t=-t,e=-e,n=-n,r=-r):(i=-i,o=-t,t=-n,n=o,o=-e,e=-r,r=o),t>0){if(!(n>0))return i;if(!(t<=n))return i}else{if(n>0)return-i;if(!(t>=n))return-i;i=-i,t=-t,n=-n}for(;;){if((r-=(s=Math.floor(n/t))*e)<0)return-i;if(r>e)return i;if(t>(n-=s*t)+n){if(e<r+r)return i}else{if(e>r+r)return-i;n=t-n,r=e-r,i=-i}if(0===r)return 0===n?0:-i;if(0===n)return i;if((e-=(s=Math.floor(t/n))*r)<0)return i;if(e>r)return-i;if(n>(t-=s*n)+t){if(r<e+e)return-i}else{if(r>e+e)return i;t=n-t,e=r-e,i=-i}if(0===e)return 0===t?0:i;if(0===t)return-i}};var S1=function(){this._t=null,this.Kt=0,this.Ht=!1;var t=arguments[0];this._t=t};S1.prototype.countSegment=function(t,e){if(t.x<this._t.x&&e.x<this._t.x)return null;if(this._t.x===e.x&&this._t.y===e.y)return this.Ht=!0,null;if(t.y===this._t.y&&e.y===this._t.y){var n=t.x,r=e.x;return n>r&&(n=e.x,r=t.x),this._t.x>=n&&this._t.x<=r&&(this.Ht=!0),null}if(t.y>this._t.y&&e.y<=this._t.y||e.y>this._t.y&&t.y<=this._t.y){var i=t.x-this._t.x,o=t.y-this._t.y,s=e.x-this._t.x,a=e.y-this._t.y,l=C1.signOfDet2x2(i,o,s,a);if(0===l)return this.Ht=!0,null;a<o&&(l=-l),l>0&&this.Kt++}},S1.prototype.isPointInPolygon=function(){return this.getLocation()!==Y0.EXTERIOR},S1.prototype.getLocation=function(){return this.Ht?Y0.BOUNDARY:this.Kt%2==1?Y0.INTERIOR:Y0.EXTERIOR},S1.prototype.isOnSegment=function(){return this.Ht},S1.prototype.interfaces_=function(){return[]},S1.prototype.getClass=function(){return S1},S1.locatePointInRing=function(){if(arguments[0]instanceof W0&&Q0(arguments[1],a1)){for(var t=arguments[1],e=new S1(arguments[0]),n=new W0,r=new W0,i=1;i<t.size();i++)if(t.getCoordinate(i,n),t.getCoordinate(i-1,r),e.countSegment(n,r),e.isOnSegment())return e.getLocation();return e.getLocation()}if(arguments[0]instanceof W0&&arguments[1]instanceof Array){for(var o=arguments[1],s=new S1(arguments[0]),a=1;a<o.length;a++){var l=o[a],h=o[a-1];if(s.countSegment(l,h),s.isOnSegment())return s.getLocation()}return s.getLocation()}};var I1=function(){},P1={CLOCKWISE:{configurable:!0},RIGHT:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},LEFT:{configurable:!0},COLLINEAR:{configurable:!0},STRAIGHT:{configurable:!0}};I1.prototype.interfaces_=function(){return[]},I1.prototype.getClass=function(){return I1},I1.orientationIndex=function(t,e,n){return o1.orientationIndex(t,e,n)},I1.signedArea=function(){if(arguments[0]instanceof Array){var t=arguments[0];if(t.length<3)return 0;for(var e=0,n=t[0].x,r=1;r<t.length-1;r++){var i=t[r].x-n,o=t[r+1].y;e+=i*(t[r-1].y-o)}return e/2}if(Q0(arguments[0],a1)){var s=arguments[0],a=s.size();if(a<3)return 0;var l=new W0,h=new W0,u=new W0;s.getCoordinate(0,h),s.getCoordinate(1,u);var c=h.x;u.x-=c;for(var f=0,d=1;d<a-1;d++)l.y=h.y,h.x=u.x,h.y=u.y,s.getCoordinate(d+1,u),u.x-=c,f+=h.x*(l.y-u.y);return f/2}},I1.distanceLineLine=function(t,e,n,r){if(t.equals(e))return I1.distancePointLine(t,n,r);if(n.equals(r))return I1.distancePointLine(r,t,e);var i=!1;if(d1.intersects(t,e,n,r)){var o=(e.x-t.x)*(r.y-n.y)-(e.y-t.y)*(r.x-n.x);if(0===o)i=!0;else{var s=(t.y-n.y)*(r.x-n.x)-(t.x-n.x)*(r.y-n.y),a=((t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y))/o,l=s/o;(l<0||l>1||a<0||a>1)&&(i=!0)}}else i=!0;return i?K0.min(I1.distancePointLine(t,n,r),I1.distancePointLine(e,n,r),I1.distancePointLine(n,t,e),I1.distancePointLine(r,t,e)):0},I1.isPointInRing=function(t,e){return I1.locatePointInRing(t,e)!==Y0.EXTERIOR},I1.computeLength=function(t){var e=t.size();if(e<=1)return 0;var n=0,r=new W0;t.getCoordinate(0,r);for(var i=r.x,o=r.y,s=1;s<e;s++){t.getCoordinate(s,r);var a=r.x,l=r.y,h=a-i,u=l-o;n+=Math.sqrt(h*h+u*u),i=a,o=l}return n},I1.isCCW=function(t){var e=t.length-1;if(e<3)throw new z0("Ring has fewer than 4 points, so orientation cannot be determined");for(var n=t[0],r=0,i=1;i<=e;i++){var o=t[i];o.y>n.y&&(n=o,r=i)}var s=r;do{(s-=1)<0&&(s=e)}while(t[s].equals2D(n)&&s!==r);var a=r;do{a=(a+1)%e}while(t[a].equals2D(n)&&a!==r);var l=t[s],h=t[a];if(l.equals2D(n)||h.equals2D(n)||l.equals2D(h))return!1;var u=I1.computeOrientation(l,n,h);return 0===u?l.x>h.x:u>0},I1.locatePointInRing=function(t,e){return S1.locatePointInRing(t,e)},I1.distancePointLinePerpendicular=function(t,e,n){var r=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y),i=((e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y))/r;return Math.abs(i)*Math.sqrt(r)},I1.computeOrientation=function(t,e,n){return I1.orientationIndex(t,e,n)},I1.distancePointLine=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(0===e.length)throw new z0("Line array must contain at least one vertex");for(var n=t.distance(e[0]),r=0;r<e.length-1;r++){var i=I1.distancePointLine(t,e[r],e[r+1]);i<n&&(n=i)}return n}if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];if(s.x===a.x&&s.y===a.y)return o.distance(s);var l=(a.x-s.x)*(a.x-s.x)+(a.y-s.y)*(a.y-s.y),h=((o.x-s.x)*(a.x-s.x)+(o.y-s.y)*(a.y-s.y))/l;if(h<=0)return o.distance(s);if(h>=1)return o.distance(a);var u=((s.y-o.y)*(a.x-s.x)-(s.x-o.x)*(a.y-s.y))/l;return Math.abs(u)*Math.sqrt(l)}},I1.isOnLine=function(t,e){for(var n=new M1,r=1;r<e.length;r++){var i=e[r-1],o=e[r];if(n.computeIntersection(t,i,o),n.hasIntersection())return!0}return!1},P1.CLOCKWISE.get=function(){return-1},P1.RIGHT.get=function(){return I1.CLOCKWISE},P1.COUNTERCLOCKWISE.get=function(){return 1},P1.LEFT.get=function(){return I1.COUNTERCLOCKWISE},P1.COLLINEAR.get=function(){return 0},P1.STRAIGHT.get=function(){return I1.COLLINEAR},Object.defineProperties(I1,P1);var E1=function(){};E1.prototype.filter=function(t){},E1.prototype.interfaces_=function(){return[]},E1.prototype.getClass=function(){return E1};var O1=function(){var t=arguments[0];this.Jt=null,this.Zt=null,this.Xt=null,this.$t=null,this.Zt=t,this.Xt=t.getSRID()},R1={serialVersionUID:{configurable:!0},SORTINDEX_POINT:{configurable:!0},SORTINDEX_MULTIPOINT:{configurable:!0},SORTINDEX_LINESTRING:{configurable:!0},SORTINDEX_LINEARRING:{configurable:!0},SORTINDEX_MULTILINESTRING:{configurable:!0},SORTINDEX_POLYGON:{configurable:!0},SORTINDEX_MULTIPOLYGON:{configurable:!0},SORTINDEX_GEOMETRYCOLLECTION:{configurable:!0},geometryChangedFilter:{configurable:!0}};O1.prototype.isGeometryCollection=function(){return this.getSortIndex()===O1.SORTINDEX_GEOMETRYCOLLECTION},O1.prototype.getFactory=function(){return this.Zt},O1.prototype.getGeometryN=function(t){return this},O1.prototype.getArea=function(){return 0},O1.prototype.isRectangle=function(){return!1},O1.prototype.equals=function(){if(arguments[0]instanceof O1){var t=arguments[0];return null!==t&&this.equalsTopo(t)}if(arguments[0]instanceof Object){var e=arguments[0];if(!(e instanceof O1))return!1;var n=e;return this.equalsExact(n)}},O1.prototype.equalsExact=function(t){return this===t||this.equalsExact(t,0)},O1.prototype.geometryChanged=function(){this.apply(O1.geometryChangedFilter)},O1.prototype.geometryChangedAction=function(){this.Jt=null},O1.prototype.equalsNorm=function(t){return null!==t&&this.norm().equalsExact(t.norm())},O1.prototype.getLength=function(){return 0},O1.prototype.getNumGeometries=function(){return 1},O1.prototype.compareTo=function(){if(1===arguments.length){var t=arguments[0],e=t;return this.getSortIndex()!==e.getSortIndex()?this.getSortIndex()-e.getSortIndex():this.isEmpty()&&e.isEmpty()?0:this.isEmpty()?-1:e.isEmpty()?1:this.compareToSameClass(t)}if(2===arguments.length){var n=arguments[0],r=arguments[1];return this.getSortIndex()!==n.getSortIndex()?this.getSortIndex()-n.getSortIndex():this.isEmpty()&&n.isEmpty()?0:this.isEmpty()?-1:n.isEmpty()?1:this.compareToSameClass(n,r)}},O1.prototype.getUserData=function(){return this.$t},O1.prototype.getSRID=function(){return this.Xt},O1.prototype.getEnvelope=function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())},O1.prototype.checkNotGeometryCollection=function(t){if(t.getSortIndex()===O1.SORTINDEX_GEOMETRYCOLLECTION)throw new z0("This method does not support GeometryCollection arguments")},O1.prototype.equal=function(t,e,n){return 0===n?t.equals(e):t.distance(e)<=n},O1.prototype.norm=function(){var t=this.copy();return t.normalize(),t},O1.prototype.getPrecisionModel=function(){return this.Zt.getPrecisionModel()},O1.prototype.getEnvelopeInternal=function(){return null===this.Jt&&(this.Jt=this.computeEnvelopeInternal()),new d1(this.Jt)},O1.prototype.setSRID=function(t){this.Xt=t},O1.prototype.setUserData=function(t){this.$t=t},O1.prototype.compare=function(t,e){for(var n=t.iterator(),r=e.iterator();n.hasNext()&&r.hasNext();){var i=n.next(),o=r.next(),s=i.compareTo(o);if(0!==s)return s}return n.hasNext()?1:r.hasNext()?-1:0},O1.prototype.hashCode=function(){return this.getEnvelopeInternal().hashCode()},O1.prototype.isGeometryCollectionOrDerived=function(){return this.getSortIndex()===O1.SORTINDEX_GEOMETRYCOLLECTION||this.getSortIndex()===O1.SORTINDEX_MULTIPOINT||this.getSortIndex()===O1.SORTINDEX_MULTILINESTRING||this.getSortIndex()===O1.SORTINDEX_MULTIPOLYGON},O1.prototype.interfaces_=function(){return[U0,j0,G0]},O1.prototype.getClass=function(){return O1},O1.hasNonEmptyElements=function(t){for(var e=0;e<t.length;e++)if(!t[e].isEmpty())return!0;return!1},O1.hasNullElements=function(t){for(var e=0;e<t.length;e++)if(null===t[e])return!0;return!1},R1.serialVersionUID.get=function(){return 0x799ea46522854c00},R1.SORTINDEX_POINT.get=function(){return 0},R1.SORTINDEX_MULTIPOINT.get=function(){return 1},R1.SORTINDEX_LINESTRING.get=function(){return 2},R1.SORTINDEX_LINEARRING.get=function(){return 3},R1.SORTINDEX_MULTILINESTRING.get=function(){return 4},R1.SORTINDEX_POLYGON.get=function(){return 5},R1.SORTINDEX_MULTIPOLYGON.get=function(){return 6},R1.SORTINDEX_GEOMETRYCOLLECTION.get=function(){return 7},R1.geometryChangedFilter.get=function(){return k1},Object.defineProperties(O1,R1);var k1=function(){};k1.interfaces_=function(){return[E1]},k1.filter=function(t){t.geometryChangedAction()};var L1=function(){};L1.prototype.filter=function(t){},L1.prototype.interfaces_=function(){return[]},L1.prototype.getClass=function(){return L1};var D1=function(){},N1={Mod2BoundaryNodeRule:{configurable:!0},EndPointBoundaryNodeRule:{configurable:!0},MultiValentEndPointBoundaryNodeRule:{configurable:!0},MonoValentEndPointBoundaryNodeRule:{configurable:!0},MOD2_BOUNDARY_RULE:{configurable:!0},ENDPOINT_BOUNDARY_RULE:{configurable:!0},MULTIVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},MONOVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},OGC_SFS_BOUNDARY_RULE:{configurable:!0}};D1.prototype.isInBoundary=function(t){},D1.prototype.interfaces_=function(){return[]},D1.prototype.getClass=function(){return D1},N1.Mod2BoundaryNodeRule.get=function(){return F1},N1.EndPointBoundaryNodeRule.get=function(){return z1},N1.MultiValentEndPointBoundaryNodeRule.get=function(){return B1},N1.MonoValentEndPointBoundaryNodeRule.get=function(){return H1},N1.MOD2_BOUNDARY_RULE.get=function(){return new F1},N1.ENDPOINT_BOUNDARY_RULE.get=function(){return new z1},N1.MULTIVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new B1},N1.MONOVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new H1},N1.OGC_SFS_BOUNDARY_RULE.get=function(){return D1.MOD2_BOUNDARY_RULE},Object.defineProperties(D1,N1);var F1=function(){};F1.prototype.isInBoundary=function(t){return t%2==1},F1.prototype.interfaces_=function(){return[D1]},F1.prototype.getClass=function(){return F1};var z1=function(){};z1.prototype.isInBoundary=function(t){return t>0},z1.prototype.interfaces_=function(){return[D1]},z1.prototype.getClass=function(){return z1};var B1=function(){};B1.prototype.isInBoundary=function(t){return t>1},B1.prototype.interfaces_=function(){return[D1]},B1.prototype.getClass=function(){return B1};var H1=function(){};H1.prototype.isInBoundary=function(t){return 1===t},H1.prototype.interfaces_=function(){return[D1]},H1.prototype.getClass=function(){return H1};var j1=function(){};function U1(t){this.message=t||""}j1.prototype.add=function(){},j1.prototype.addAll=function(){},j1.prototype.isEmpty=function(){},j1.prototype.iterator=function(){},j1.prototype.size=function(){},j1.prototype.toArray=function(){},j1.prototype.remove=function(){},U1.prototype=new Error,U1.prototype.name="IndexOutOfBoundsException";var V1=function(){};V1.prototype.hasNext=function(){},V1.prototype.next=function(){},V1.prototype.remove=function(){};var G1=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){},e.prototype.set=function(){},e.prototype.isEmpty=function(){},e}(j1);function W1(t){this.message=t||""}W1.prototype=new Error,W1.prototype.name="NoSuchElementException";var q1=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof j1&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.ensureCapacity=function(){},e.prototype.interfaces_=function(){return[t,j1]},e.prototype.add=function(t){return 1===arguments.length?this.array_.push(t):this.array_.splice(arguments[0],arguments[1]),!0},e.prototype.clear=function(){this.array_=[]},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.set=function(t,e){var n=this.array_[t];return this.array_[t]=e,n},e.prototype.iterator=function(){return new X1(this)},e.prototype.get=function(t){if(t<0||t>=this.size())throw new U1;return this.array_[t]},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.size=function(){return this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.remove=function(t){for(var e=!1,n=0,r=this.array_.length;n<r;n++)if(this.array_[n]===t){this.array_.splice(n,1),e=!0;break}return e},e}(G1),X1=function(t){function e(e){t.call(this),this.arrayList_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.arrayList_.size())throw new W1;return this.arrayList_.get(this.position_++)},e.prototype.hasNext=function(){return this.position_<this.arrayList_.size()},e.prototype.set=function(t){return this.arrayList_.set(this.position_-1,t)},e.prototype.remove=function(){this.arrayList_.remove(this.arrayList_.get(this.position_))},e}(V1),Z1=function(t){function e(){if(t.call(this),0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.ensureCapacity(e.length),this.add(e,!0)}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.ensureCapacity(n.length),this.add(n,r)}}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={coordArrayType:{configurable:!0}};return n.coordArrayType.get=function(){return new Array(0).fill(null)},e.prototype.getCoordinate=function(t){return this.get(t)},e.prototype.addAll=function(){if(2===arguments.length){for(var e=arguments[1],n=!1,r=arguments[0].iterator();r.hasNext();)this.add(r.next(),e),n=!0;return n}return t.prototype.addAll.apply(this,arguments)},e.prototype.clone=function(){for(var e=t.prototype.clone.call(this),n=0;n<this.size();n++)e.add(n,this.get(n).copy());return e},e.prototype.toCoordinateArray=function(){return this.toArray(e.coordArrayType)},e.prototype.add=function(){var e=this;if(1===arguments.length){var n=arguments[0];t.prototype.add.call(this,n)}else if(2===arguments.length){if(arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var r=arguments[0],i=arguments[1];return this.add(r,i,!0),!0}if(arguments[0]instanceof W0&&"boolean"==typeof arguments[1]){var o=arguments[0];if(!arguments[1]&&this.size()>=1&&this.get(this.size()-1).equals2D(o))return null;t.prototype.add.call(this,o)}else if(arguments[0]instanceof Object&&"boolean"==typeof arguments[1]){var s=arguments[0],a=arguments[1];return this.add(s,a),!0}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var l=arguments[0],h=arguments[1];if(arguments[2])for(var u=0;u<l.length;u++)e.add(l[u],h);else for(var c=l.length-1;c>=0;c--)e.add(l[c],h);return!0}if("boolean"==typeof arguments[2]&&Number.isInteger(arguments[0])&&arguments[1]instanceof W0){var f=arguments[0],d=arguments[1];if(!arguments[2]){var p=this.size();if(p>0){if(f>0&&this.get(f-1).equals2D(d))return null;if(f<p&&this.get(f).equals2D(d))return null}}t.prototype.add.call(this,f,d)}}else if(4===arguments.length){var g=arguments[0],m=arguments[1],A=arguments[2],y=arguments[3],v=1;A>y&&(v=-1);for(var x=A;x!==y;x+=v)e.add(g[x],m);return!0}},e.prototype.closeRing=function(){this.size()>0&&this.add(new W0(this.get(0)),!1)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},Object.defineProperties(e,n),e}(q1),Y1=function(){},J1={ForwardComparator:{configurable:!0},BidirectionalComparator:{configurable:!0},coordArrayType:{configurable:!0}};J1.ForwardComparator.get=function(){return Q1},J1.BidirectionalComparator.get=function(){return K1},J1.coordArrayType.get=function(){return new Array(0).fill(null)},Y1.prototype.interfaces_=function(){return[]},Y1.prototype.getClass=function(){return Y1},Y1.isRing=function(t){return!(t.length<4||!t[0].equals2D(t[t.length-1]))},Y1.ptNotInList=function(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(Y1.indexOf(r,e)<0)return r}return null},Y1.scroll=function(t,e){var n=Y1.indexOf(e,t);if(n<0)return null;var r=new Array(t.length).fill(null);c1.arraycopy(t,n,r,0,t.length-n),c1.arraycopy(t,0,r,t.length-n,n),c1.arraycopy(r,0,t,0,t.length)},Y1.equals=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].equals(e[n]))return!1;return!0}if(3===arguments.length){var r=arguments[0],i=arguments[1],o=arguments[2];if(r===i)return!0;if(null===r||null===i)return!1;if(r.length!==i.length)return!1;for(var s=0;s<r.length;s++)if(0!==o.compare(r[s],i[s]))return!1;return!0}},Y1.intersection=function(t,e){for(var n=new Z1,r=0;r<t.length;r++)e.intersects(t[r])&&n.add(t[r],!0);return n.toCoordinateArray()},Y1.hasRepeatedPoints=function(t){for(var e=1;e<t.length;e++)if(t[e-1].equals(t[e]))return!0;return!1},Y1.removeRepeatedPoints=function(t){return Y1.hasRepeatedPoints(t)?new Z1(t,!1).toCoordinateArray():t},Y1.reverse=function(t){for(var e=t.length-1,n=Math.trunc(e/2),r=0;r<=n;r++){var i=t[r];t[r]=t[e-r],t[e-r]=i}},Y1.removeNull=function(t){for(var e=0,n=0;n<t.length;n++)null!==t[n]&&e++;var r=new Array(e).fill(null);if(0===e)return r;for(var i=0,o=0;o<t.length;o++)null!==t[o]&&(r[i++]=t[o]);return r},Y1.copyDeep=function(){if(1===arguments.length){for(var t=arguments[0],e=new Array(t.length).fill(null),n=0;n<t.length;n++)e[n]=new W0(t[n]);return e}if(5===arguments.length)for(var r=arguments[0],i=arguments[1],o=arguments[2],s=arguments[3],a=arguments[4],l=0;l<a;l++)o[s+l]=new W0(r[i+l])},Y1.isEqualReversed=function(t,e){for(var n=0;n<t.length;n++){var r=t[n],i=e[t.length-n-1];if(0!==r.compareTo(i))return!1}return!0},Y1.envelope=function(t){for(var e=new d1,n=0;n<t.length;n++)e.expandToInclude(t[n]);return e},Y1.toCoordinateArray=function(t){return t.toArray(Y1.coordArrayType)},Y1.atLeastNCoordinatesOrNothing=function(t,e){return e.length>=t?e:[]},Y1.indexOf=function(t,e){for(var n=0;n<e.length;n++)if(t.equals(e[n]))return n;return-1},Y1.increasingDirection=function(t){for(var e=0;e<Math.trunc(t.length/2);e++){var n=t.length-1-e,r=t[e].compareTo(t[n]);if(0!==r)return r}return 1},Y1.compare=function(t,e){for(var n=0;n<t.length&&n<e.length;){var r=t[n].compareTo(e[n]);if(0!==r)return r;n++}return n<e.length?-1:n<t.length?1:0},Y1.minCoordinate=function(t){for(var e=null,n=0;n<t.length;n++)(null===e||e.compareTo(t[n])>0)&&(e=t[n]);return e},Y1.extract=function(t,e,n){e=K0.clamp(e,0,t.length);var r=(n=K0.clamp(n,-1,t.length))-e+1;n<0&&(r=0),e>=t.length&&(r=0),n<e&&(r=0);var i=new Array(r).fill(null);if(0===r)return i;for(var o=0,s=e;s<=n;s++)i[o++]=t[s];return i},Object.defineProperties(Y1,J1);var Q1=function(){};Q1.prototype.compare=function(t,e){return Y1.compare(t,e)},Q1.prototype.interfaces_=function(){return[V0]},Q1.prototype.getClass=function(){return Q1};var K1=function(){};K1.prototype.compare=function(t,e){var n=t,r=e;if(n.length<r.length)return-1;if(n.length>r.length)return 1;if(0===n.length)return 0;var i=Y1.compare(n,r);return Y1.isEqualReversed(n,r)?0:i},K1.prototype.OLDcompare=function(t,e){var n=t,r=e;if(n.length<r.length)return-1;if(n.length>r.length)return 1;if(0===n.length)return 0;for(var i=Y1.increasingDirection(n),o=Y1.increasingDirection(r),s=i>0?0:n.length-1,a=o>0?0:n.length-1,l=0;l<n.length;l++){var h=n[s].compareTo(r[a]);if(0!==h)return h;s+=i,a+=o}return 0},K1.prototype.interfaces_=function(){return[V0]},K1.prototype.getClass=function(){return K1};var $1=function(){};$1.prototype.get=function(){},$1.prototype.put=function(){},$1.prototype.size=function(){},$1.prototype.values=function(){},$1.prototype.entrySet=function(){};var t2=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}($1);function e2(t){this.message=t||""}function n2(){}e2.prototype=new Error,e2.prototype.name="OperationNotSupported",n2.prototype=new j1,n2.prototype.contains=function(){};var r2=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof j1&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(this.array_[e]===t)return!0;return!1},e.prototype.add=function(t){return!this.contains(t)&&(this.array_.push(t),!0)},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.remove=function(t){throw new Error},e.prototype.size=function(){return this.array_.length},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.iterator=function(){return new i2(this)},e}(n2),i2=function(t){function e(e){t.call(this),this.hashSet_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.hashSet_.size())throw new W1;return this.hashSet_.array_[this.position_++]},e.prototype.hasNext=function(){return this.position_<this.hashSet_.size()},e.prototype.remove=function(){throw new e2},e}(V1);function o2(t){return null===t?0:t.color}function s2(t){return null===t?null:t.parent}function a2(t,e){null!==t&&(t.color=e)}function l2(t){return null===t?null:t.left}function h2(t){return null===t?null:t.right}function u2(){this.root_=null,this.size_=0}u2.prototype=new t2,u2.prototype.get=function(t){for(var e=this.root_;null!==e;){var n=t.compareTo(e.key);if(n<0)e=e.left;else{if(!(n>0))return e.value;e=e.right}}return null},u2.prototype.put=function(t,e){if(null===this.root_)return this.root_={key:t,value:e,left:null,right:null,parent:null,color:0,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var n,r,i=this.root_;do{if(n=i,(r=t.compareTo(i.key))<0)i=i.left;else{if(!(r>0)){var o=i.value;return i.value=e,o}i=i.right}}while(null!==i);var s={key:t,left:null,right:null,value:e,parent:n,color:0,getValue:function(){return this.value},getKey:function(){return this.key}};return r<0?n.left=s:n.right=s,this.fixAfterInsertion(s),this.size_++,null},u2.prototype.fixAfterInsertion=function(t){var e=this;for(t.color=1;null!=t&&t!==this.root_&&1===t.parent.color;)if(s2(t)===l2(s2(s2(t)))){var n=h2(s2(s2(t)));1===o2(n)?(a2(s2(t),0),a2(n,0),a2(s2(s2(t)),1),t=s2(s2(t))):(t===h2(s2(t))&&(t=s2(t),e.rotateLeft(t)),a2(s2(t),0),a2(s2(s2(t)),1),e.rotateRight(s2(s2(t))))}else{var r=l2(s2(s2(t)));1===o2(r)?(a2(s2(t),0),a2(r,0),a2(s2(s2(t)),1),t=s2(s2(t))):(t===l2(s2(t))&&(t=s2(t),e.rotateRight(t)),a2(s2(t),0),a2(s2(s2(t)),1),e.rotateLeft(s2(s2(t))))}this.root_.color=0},u2.prototype.values=function(){var t=new q1,e=this.getFirstEntry();if(null!==e)for(t.add(e.value);null!==(e=u2.successor(e));)t.add(e.value);return t},u2.prototype.entrySet=function(){var t=new r2,e=this.getFirstEntry();if(null!==e)for(t.add(e);null!==(e=u2.successor(e));)t.add(e);return t},u2.prototype.rotateLeft=function(t){if(null!=t){var e=t.right;t.right=e.left,null!=e.left&&(e.left.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.left===t?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e}},u2.prototype.rotateRight=function(t){if(null!=t){var e=t.left;t.left=e.right,null!=e.right&&(e.right.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.right===t?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e}},u2.prototype.getFirstEntry=function(){var t=this.root_;if(null!=t)for(;null!=t.left;)t=t.left;return t},u2.successor=function(t){if(null===t)return null;if(null!==t.right){for(var e=t.right;null!==e.left;)e=e.left;return e}for(var n=t.parent,r=t;null!==n&&r===n.right;)r=n,n=n.parent;return n},u2.prototype.size=function(){return this.size_};var c2=function(){};function f2(){}function d2(){this.array_=[],arguments[0]instanceof j1&&this.addAll(arguments[0])}c2.prototype.interfaces_=function(){return[]},c2.prototype.getClass=function(){return c2},f2.prototype=new n2,d2.prototype=new f2,d2.prototype.contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(0===this.array_[e].compareTo(t))return!0;return!1},d2.prototype.add=function(t){if(this.contains(t))return!1;for(var e=0,n=this.array_.length;e<n;e++)if(1===this.array_[e].compareTo(t))return this.array_.splice(e,0,t),!0;return this.array_.push(t),!0},d2.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},d2.prototype.remove=function(t){throw new e2},d2.prototype.size=function(){return this.array_.length},d2.prototype.isEmpty=function(){return 0===this.array_.length},d2.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},d2.prototype.iterator=function(){return new p2(this)};var p2=function(t){this.treeSet_=t,this.position_=0};p2.prototype.next=function(){if(this.position_===this.treeSet_.size())throw new W1;return this.treeSet_.array_[this.position_++]},p2.prototype.hasNext=function(){return this.position_<this.treeSet_.size()},p2.prototype.remove=function(){throw new e2};var g2=function(){};g2.sort=function(){var t,e,n,r,i=arguments[0];if(1===arguments.length)r=function(t,e){return t.compareTo(e)},i.sort(r);else if(2===arguments.length)n=arguments[1],r=function(t,e){return n.compare(t,e)},i.sort(r);else if(3===arguments.length){(e=i.slice(arguments[1],arguments[2])).sort();var o=i.slice(0,arguments[1]).concat(e,i.slice(arguments[2],i.length));for(i.splice(0,i.length),t=0;t<o.length;t++)i.push(o[t])}else if(4===arguments.length)for(e=i.slice(arguments[1],arguments[2]),n=arguments[3],r=function(t,e){return n.compare(t,e)},e.sort(r),o=i.slice(0,arguments[1]).concat(e,i.slice(arguments[2],i.length)),i.splice(0,i.length),t=0;t<o.length;t++)i.push(o[t])},g2.asList=function(t){for(var e=new q1,n=0,r=t.length;n<r;n++)e.add(t[n]);return e};var m2=function(){},A2={P:{configurable:!0},L:{configurable:!0},A:{configurable:!0},FALSE:{configurable:!0},TRUE:{configurable:!0},DONTCARE:{configurable:!0},SYM_FALSE:{configurable:!0},SYM_TRUE:{configurable:!0},SYM_DONTCARE:{configurable:!0},SYM_P:{configurable:!0},SYM_L:{configurable:!0},SYM_A:{configurable:!0}};A2.P.get=function(){return 0},A2.L.get=function(){return 1},A2.A.get=function(){return 2},A2.FALSE.get=function(){return-1},A2.TRUE.get=function(){return-2},A2.DONTCARE.get=function(){return-3},A2.SYM_FALSE.get=function(){return"F"},A2.SYM_TRUE.get=function(){return"T"},A2.SYM_DONTCARE.get=function(){return"*"},A2.SYM_P.get=function(){return"0"},A2.SYM_L.get=function(){return"1"},A2.SYM_A.get=function(){return"2"},m2.prototype.interfaces_=function(){return[]},m2.prototype.getClass=function(){return m2},m2.toDimensionSymbol=function(t){switch(t){case m2.FALSE:return m2.SYM_FALSE;case m2.TRUE:return m2.SYM_TRUE;case m2.DONTCARE:return m2.SYM_DONTCARE;case m2.P:return m2.SYM_P;case m2.L:return m2.SYM_L;case m2.A:return m2.SYM_A}throw new z0("Unknown dimension value: "+t)},m2.toDimensionValue=function(t){switch(n1.toUpperCase(t)){case m2.SYM_FALSE:return m2.FALSE;case m2.SYM_TRUE:return m2.TRUE;case m2.SYM_DONTCARE:return m2.DONTCARE;case m2.SYM_P:return m2.P;case m2.SYM_L:return m2.L;case m2.SYM_A:return m2.A}throw new z0("Unknown dimension symbol: "+t)},Object.defineProperties(m2,A2);var y2=function(){};y2.prototype.filter=function(t){},y2.prototype.interfaces_=function(){return[]},y2.prototype.getClass=function(){return y2};var v2=function(){};v2.prototype.filter=function(t,e){},v2.prototype.isDone=function(){},v2.prototype.isGeometryChanged=function(){},v2.prototype.interfaces_=function(){return[]},v2.prototype.getClass=function(){return v2};var x2=function(t){function e(e,n){if(t.call(this,n),this.Nt=e||[],t.hasNullElements(this.Nt))throw new z0("geometries must not contain null elements")}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){for(var t=new d1,e=0;e<this.Nt.length;e++)t.expandToInclude(this.Nt[e].getEnvelopeInternal());return t},e.prototype.getGeometryN=function(t){return this.Nt[t]},e.prototype.getSortIndex=function(){return t.SORTINDEX_GEOMETRYCOLLECTION},e.prototype.getCoordinates=function(){for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=0;n<this.Nt.length;n++)for(var r=this.Nt[n].getCoordinates(),i=0;i<r.length;i++)t[++e]=r[i];return t},e.prototype.getArea=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getArea();return t},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var r=e;if(this.Nt.length!==r.Nt.length)return!1;for(var i=0;i<this.Nt.length;i++)if(!this.Nt[i].equalsExact(r.Nt[i],n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=0;t<this.Nt.length;t++)this.Nt[t].normalize();g2.sort(this.Nt)},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this.Nt[0].getCoordinate()},e.prototype.getBoundaryDimension=function(){for(var t=m2.FALSE,e=0;e<this.Nt.length;e++)t=Math.max(t,this.Nt[e].getBoundaryDimension());return t},e.prototype.getDimension=function(){for(var t=m2.FALSE,e=0;e<this.Nt.length;e++)t=Math.max(t,this.Nt[e].getDimension());return t},e.prototype.getLength=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getNumPoints();return t},e.prototype.getNumGeometries=function(){return this.Nt.length},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[n]=this.Nt[n].reverse();return this.getFactory().createGeometryCollection(e)},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0],e=new d2(g2.asList(this.Nt)),n=new d2(g2.asList(t.Nt));return this.compare(e,n)}if(2===arguments.length){for(var r=arguments[1],i=arguments[0],o=this.getNumGeometries(),s=i.getNumGeometries(),a=0;a<o&&a<s;){var l=this.getGeometryN(a),h=i.getGeometryN(a),u=l.compareToSameClass(h,r);if(0!==u)return u;a++}return a<o?1:a<s?-1:0}},e.prototype.apply=function(){var t=this;if(Q0(arguments[0],L1))for(var e=arguments[0],n=0;n<this.Nt.length;n++)t.Nt[n].apply(e);else if(Q0(arguments[0],v2)){var r=arguments[0];if(0===this.Nt.length)return null;for(var i=0;i<this.Nt.length&&(t.Nt[i].apply(r),!r.isDone());i++);r.isGeometryChanged()&&this.geometryChanged()}else if(Q0(arguments[0],y2)){var o=arguments[0];o.filter(this);for(var s=0;s<this.Nt.length;s++)t.Nt[s].apply(o)}else if(Q0(arguments[0],E1)){var a=arguments[0];a.filter(this);for(var l=0;l<this.Nt.length;l++)t.Nt[l].apply(a)}},e.prototype.getBoundary=function(){return this.checkNotGeometryCollection(this),b1.shouldNeverReachHere(),null},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e.Nt=new Array(this.Nt.length).fill(null);for(var n=0;n<this.Nt.length;n++)e.Nt[n]=this.Nt[n].clone();return e},e.prototype.getGeometryType=function(){return"GeometryCollection"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.isEmpty=function(){for(var t=0;t<this.Nt.length;t++)if(!this.Nt[t].isEmpty())return!1;return!0},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x4f07bcb1f857d800},Object.defineProperties(e,n),e}(O1),_2=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return O1.SORTINDEX_MULTILINESTRING},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?m2.FALSE:0},e.prototype.isClosed=function(){if(this.isEmpty())return!1;for(var t=0;t<this.Nt.length;t++)if(!this.Nt[t].isClosed())return!1;return!0},e.prototype.getDimension=function(){return 1},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[t-1-n]=this.Nt[n].reverse();return this.getFactory().createMultiLineString(e)},e.prototype.getBoundary=function(){return new b2(this).getBoundary()},e.prototype.getGeometryType=function(){return"MultiLineString"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[c2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x7155d2ab4afa8000},Object.defineProperties(e,n),e}(x2),b2=function(){if(this.An=null,this.tn=null,this.nn=null,this.rn=null,1===arguments.length){var t=arguments[0],e=D1.MOD2_BOUNDARY_RULE;this.An=t,this.tn=t.getFactory(),this.nn=e}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.An=n,this.tn=n.getFactory(),this.nn=r}};b2.prototype.boundaryMultiLineString=function(t){if(this.An.isEmpty())return this.getEmptyMultiPoint();var e=this.computeBoundaryCoordinates(t);return 1===e.length?this.tn.createPoint(e[0]):this.tn.createMultiPointFromCoords(e)},b2.prototype.getBoundary=function(){return this.An instanceof k2?this.boundaryLineString(this.An):this.An instanceof _2?this.boundaryMultiLineString(this.An):this.An.getBoundary()},b2.prototype.boundaryLineString=function(t){return this.An.isEmpty()?this.getEmptyMultiPoint():t.isClosed()?this.nn.isInBoundary(2)?t.getStartPoint():this.tn.createMultiPoint():this.tn.createMultiPoint([t.getStartPoint(),t.getEndPoint()])},b2.prototype.getEmptyMultiPoint=function(){return this.tn.createMultiPoint()},b2.prototype.computeBoundaryCoordinates=function(t){var e=this,n=new q1;this.rn=new u2;for(var r=0;r<t.getNumGeometries();r++){var i=t.getGeometryN(r);0!==i.getNumPoints()&&(e.addEndpoint(i.getCoordinateN(0)),e.addEndpoint(i.getCoordinateN(i.getNumPoints()-1)))}for(var o=this.rn.entrySet().iterator();o.hasNext();){var s=o.next(),a=s.getValue().count;e.nn.isInBoundary(a)&&n.add(s.getKey())}return Y1.toCoordinateArray(n)},b2.prototype.addEndpoint=function(t){var e=this.rn.get(t);null===e&&(e=new w2,this.rn.put(t,e)),e.count++},b2.prototype.interfaces_=function(){return[]},b2.prototype.getClass=function(){return b2},b2.getBoundary=function(){return 1===arguments.length?new b2(arguments[0]).getBoundary():2===arguments.length?new b2(arguments[0],arguments[1]).getBoundary():void 0};var w2=function(){this.count=null};function T2(){}function M2(){}w2.prototype.interfaces_=function(){return[]},w2.prototype.getClass=function(){return w2};var C2=function(){};function S2(){}function I2(){}function P2(){}var E2=function(){},O2={NEWLINE:{configurable:!0},SIMPLE_ORDINATE_FORMAT:{configurable:!0}};E2.prototype.interfaces_=function(){return[]},E2.prototype.getClass=function(){return E2},E2.chars=function(t,e){for(var n=new Array(e).fill(null),r=0;r<e;r++)n[r]=t;return String(n)},E2.getStackTrace=function(){if(1===arguments.length){var t=arguments[0],e=new S2,n=new T2;return t.printStackTrace(n),e.toString()}if(2===arguments.length){var r=arguments[1],i="";new M2(E2.getStackTrace(arguments[0]));for(var o=new P2,s=0;s<r;s++)try{i+=o.readLine()+E2.NEWLINE}catch(a){if(!(a instanceof I2))throw a;b1.shouldNeverReachHere()}return i}},E2.split=function(t,e){for(var n=e.length,r=new q1,i=""+t,o=i.indexOf(e);o>=0;){var s=i.substring(0,o);r.add(s),o=(i=i.substring(o+n)).indexOf(e)}i.length>0&&r.add(i);for(var a=new Array(r.size()).fill(null),l=0;l<a.length;l++)a[l]=r.get(l);return a},E2.toString=function(){if(1===arguments.length){var t=arguments[0];return E2.SIMPLE_ORDINATE_FORMAT.format(t)}},E2.spaces=function(t){return E2.chars(" ",t)},O2.NEWLINE.get=function(){return c1.getProperty("line.separator")},O2.SIMPLE_ORDINATE_FORMAT.get=function(){return new C2},Object.defineProperties(E2,O2);var R2=function(){};R2.prototype.interfaces_=function(){return[]},R2.prototype.getClass=function(){return R2},R2.copyCoord=function(t,e,n,r){for(var i=Math.min(t.getDimension(),n.getDimension()),o=0;o<i;o++)n.setOrdinate(r,o,t.getOrdinate(e,o))},R2.isRing=function(t){var e=t.size();return 0===e||!(e<=3)&&t.getOrdinate(0,a1.X)===t.getOrdinate(e-1,a1.X)&&t.getOrdinate(0,a1.Y)===t.getOrdinate(e-1,a1.Y)},R2.isEqual=function(t,e){var n=t.size();if(n!==e.size())return!1;for(var r=Math.min(t.getDimension(),e.getDimension()),i=0;i<n;i++)for(var o=0;o<r;o++){var s=t.getOrdinate(i,o),a=e.getOrdinate(i,o);if(!(t.getOrdinate(i,o)===e.getOrdinate(i,o)||B0.isNaN(s)&&B0.isNaN(a)))return!1}return!0},R2.extend=function(t,e,n){var r=t.create(n,e.getDimension()),i=e.size();if(R2.copy(e,0,r,0,i),i>0)for(var o=i;o<n;o++)R2.copy(e,i-1,r,o,1);return r},R2.reverse=function(t){for(var e=t.size()-1,n=Math.trunc(e/2),r=0;r<=n;r++)R2.swap(t,r,e-r)},R2.swap=function(t,e,n){if(e===n)return null;for(var r=0;r<t.getDimension();r++){var i=t.getOrdinate(e,r);t.setOrdinate(e,r,t.getOrdinate(n,r)),t.setOrdinate(n,r,i)}},R2.copy=function(t,e,n,r,i){for(var o=0;o<i;o++)R2.copyCoord(t,e+o,n,r+o)},R2.toString=function(){if(1===arguments.length){var t=arguments[0],e=t.size();if(0===e)return"()";var n=t.getDimension(),r=new t1;r.append("(");for(var i=0;i<e;i++){i>0&&r.append(" ");for(var o=0;o<n;o++)o>0&&r.append(","),r.append(E2.toString(t.getOrdinate(i,o)))}return r.append(")"),r.toString()}},R2.ensureValidRing=function(t,e){var n=e.size();return 0===n?e:n<=3?R2.createClosedRing(t,e,4):e.getOrdinate(0,a1.X)===e.getOrdinate(n-1,a1.X)&&e.getOrdinate(0,a1.Y)===e.getOrdinate(n-1,a1.Y)?e:R2.createClosedRing(t,e,n+1)},R2.createClosedRing=function(t,e,n){var r=t.create(n,e.getDimension()),i=e.size();R2.copy(e,0,r,0,i);for(var o=i;o<n;o++)R2.copy(e,0,r,o,1);return r};var k2=function(t){function e(e,n){t.call(this,n),this.jt=null,this.init(e)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this.isEmpty()?new d1:this.jt.expandEnvelope(new d1)},e.prototype.isRing=function(){return this.isClosed()&&this.isSimple()},e.prototype.getSortIndex=function(){return t.SORTINDEX_LINESTRING},e.prototype.getCoordinates=function(){return this.jt.toCoordinateArray()},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var r=e;if(this.jt.size()!==r.jt.size())return!1;for(var i=0;i<this.jt.size();i++)if(!this.equal(this.jt.getCoordinate(i),r.jt.getCoordinate(i),n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=this,e=0;e<Math.trunc(this.jt.size()/2);e++){var n=t.jt.size()-1-e;if(!t.jt.getCoordinate(e).equals(t.jt.getCoordinate(n)))return t.jt.getCoordinate(e).compareTo(t.jt.getCoordinate(n))>0&&R2.reverse(t.jt),null}},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this.jt.getCoordinate(0)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?m2.FALSE:0},e.prototype.isClosed=function(){return!this.isEmpty()&&this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))},e.prototype.getEndPoint=function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)},e.prototype.getDimension=function(){return 1},e.prototype.getLength=function(){return I1.computeLength(this.jt)},e.prototype.getNumPoints=function(){return this.jt.size()},e.prototype.reverse=function(){var t=this.jt.copy();return R2.reverse(t),this.getFactory().createLineString(t)},e.prototype.compareToSameClass=function(){if(1===arguments.length){for(var t=arguments[0],e=0,n=0;e<this.jt.size()&&n<t.jt.size();){var r=this.jt.getCoordinate(e).compareTo(t.jt.getCoordinate(n));if(0!==r)return r;e++,n++}return e<this.jt.size()?1:n<t.jt.size()?-1:0}if(2===arguments.length){var i=arguments[0];return arguments[1].compare(this.jt,i.jt)}},e.prototype.apply=function(){if(Q0(arguments[0],L1))for(var t=arguments[0],e=0;e<this.jt.size();e++)t.filter(this.jt.getCoordinate(e));else if(Q0(arguments[0],v2)){var n=arguments[0];if(0===this.jt.size())return null;for(var r=0;r<this.jt.size()&&(n.filter(this.jt,r),!n.isDone());r++);n.isGeometryChanged()&&this.geometryChanged()}else(Q0(arguments[0],y2)||Q0(arguments[0],E1))&&arguments[0].filter(this)},e.prototype.getBoundary=function(){return new b2(this).getBoundary()},e.prototype.isEquivalentClass=function(t){return t instanceof e},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e.jt=this.jt.clone(),e},e.prototype.getCoordinateN=function(t){return this.jt.getCoordinate(t)},e.prototype.getGeometryType=function(){return"LineString"},e.prototype.copy=function(){return new e(this.jt.copy(),this.Zt)},e.prototype.getCoordinateSequence=function(){return this.jt},e.prototype.isEmpty=function(){return 0===this.jt.size()},e.prototype.init=function(t){if(null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),1===t.size())throw new z0("Invalid number of points in LineString (found "+t.size()+" - must be 0 or >= 2)");this.jt=t},e.prototype.isCoordinate=function(t){for(var e=0;e<this.jt.size();e++)if(this.jt.getCoordinate(e).equals(t))return!0;return!1},e.prototype.getStartPoint=function(){return this.isEmpty()?null:this.getPointN(0)},e.prototype.getPointN=function(t){return this.getFactory().createPoint(this.jt.getCoordinate(t))},e.prototype.interfaces_=function(){return[c2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x2b2b51ba435c8e00},Object.defineProperties(e,n),e}(O1),L2=function(){};L2.prototype.interfaces_=function(){return[]},L2.prototype.getClass=function(){return L2};var D2=function(t){function e(e,n){t.call(this,n),this.Et=e||null,this.init(this.Et)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){if(this.isEmpty())return new d1;var t=new d1;return t.expandToInclude(this.Et.getX(0),this.Et.getY(0)),t},e.prototype.getSortIndex=function(){return t.SORTINDEX_POINT},e.prototype.getCoordinates=function(){return this.isEmpty()?[]:[this.getCoordinate()]},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&(!(!this.isEmpty()||!e.isEmpty())||this.isEmpty()===e.isEmpty()&&this.equal(e.getCoordinate(),this.getCoordinate(),n))}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){},e.prototype.getCoordinate=function(){return 0!==this.Et.size()?this.Et.getCoordinate(0):null},e.prototype.getBoundaryDimension=function(){return m2.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getNumPoints=function(){return this.isEmpty()?0:1},e.prototype.reverse=function(){return this.copy()},e.prototype.getX=function(){if(null===this.getCoordinate())throw new Error("getX called on empty Point");return this.getCoordinate().x},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0];return this.getCoordinate().compareTo(t.getCoordinate())}if(2===arguments.length){var e=arguments[0];return arguments[1].compare(this.Et,e.Et)}},e.prototype.apply=function(){if(Q0(arguments[0],L1)){var t=arguments[0];if(this.isEmpty())return null;t.filter(this.getCoordinate())}else if(Q0(arguments[0],v2)){var e=arguments[0];if(this.isEmpty())return null;e.filter(this.Et,0),e.isGeometryChanged()&&this.geometryChanged()}else(Q0(arguments[0],y2)||Q0(arguments[0],E1))&&arguments[0].filter(this)},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e.Et=this.Et.clone(),e},e.prototype.getGeometryType=function(){return"Point"},e.prototype.copy=function(){return new e(this.Et.copy(),this.Zt)},e.prototype.getCoordinateSequence=function(){return this.Et},e.prototype.getY=function(){if(null===this.getCoordinate())throw new Error("getY called on empty Point");return this.getCoordinate().y},e.prototype.isEmpty=function(){return 0===this.Et.size()},e.prototype.init=function(t){null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),b1.isTrue(t.size()<=1),this.Et=t},e.prototype.isSimple=function(){return!0},e.prototype.interfaces_=function(){return[L2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x44077bad161cbc00},Object.defineProperties(e,n),e}(O1),N2=function(){};N2.prototype.interfaces_=function(){return[]},N2.prototype.getClass=function(){return N2};var F2=function(t){function e(e,n,r){if(t.call(this,r),this.Qt=null,this.St=null,null===e&&(e=this.getFactory().createLinearRing()),null===n&&(n=[]),t.hasNullElements(n))throw new z0("holes must not contain null elements");if(e.isEmpty()&&t.hasNonEmptyElements(n))throw new z0("shell is empty but holes are not");this.Qt=e,this.St=n}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this.Qt.getEnvelopeInternal()},e.prototype.getSortIndex=function(){return t.SORTINDEX_POLYGON},e.prototype.getCoordinates=function(){if(this.isEmpty())return[];for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=this.Qt.getCoordinates(),r=0;r<n.length;r++)t[++e]=n[r];for(var i=0;i<this.St.length;i++)for(var o=this.St[i].getCoordinates(),s=0;s<o.length;s++)t[++e]=o[s];return t},e.prototype.getArea=function(){var t=0;t+=Math.abs(I1.signedArea(this.Qt.getCoordinateSequence()));for(var e=0;e<this.St.length;e++)t-=Math.abs(I1.signedArea(this.St[e].getCoordinateSequence()));return t},e.prototype.isRectangle=function(){if(0!==this.getNumInteriorRing())return!1;if(null===this.Qt)return!1;if(5!==this.Qt.getNumPoints())return!1;for(var t=this.Qt.getCoordinateSequence(),e=this.getEnvelopeInternal(),n=0;n<5;n++){var r=t.getX(n);if(r!==e.getMinX()&&r!==e.getMaxX())return!1;var i=t.getY(n);if(i!==e.getMinY()&&i!==e.getMaxY())return!1}for(var o=t.getX(0),s=t.getY(0),a=1;a<=4;a++){var l=t.getX(a),h=t.getY(a);if(l!==o==(h!==s))return!1;o=l,s=h}return!0},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var r=e,i=this.Qt,o=r.Qt;if(!i.equalsExact(o,n))return!1;if(this.St.length!==r.St.length)return!1;for(var s=0;s<this.St.length;s++)if(!this.St[s].equalsExact(r.St[s],n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){if(0===arguments.length){this.normalize(this.Qt,!0);for(var t=0;t<this.St.length;t++)this.normalize(this.St[t],!1);g2.sort(this.St)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(e.isEmpty())return null;var r=new Array(e.getCoordinates().length-1).fill(null);c1.arraycopy(e.getCoordinates(),0,r,0,r.length);var i=Y1.minCoordinate(e.getCoordinates());Y1.scroll(r,i),c1.arraycopy(r,0,e.getCoordinates(),0,r.length),e.getCoordinates()[r.length]=r[0],I1.isCCW(e.getCoordinates())===n&&Y1.reverse(e.getCoordinates())}},e.prototype.getCoordinate=function(){return this.Qt.getCoordinate()},e.prototype.getNumInteriorRing=function(){return this.St.length},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.getLength=function(){var t=0;t+=this.Qt.getLength();for(var e=0;e<this.St.length;e++)t+=this.St[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=this.Qt.getNumPoints(),e=0;e<this.St.length;e++)t+=this.St[e].getNumPoints();return t},e.prototype.reverse=function(){var t=this.copy();t.Qt=this.Qt.copy().reverse(),t.St=new Array(this.St.length).fill(null);for(var e=0;e<this.St.length;e++)t.St[e]=this.St[e].copy().reverse();return t},e.prototype.convexHull=function(){return this.getExteriorRing().convexHull()},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0],e=this.Qt,n=t.Qt;return e.compareToSameClass(n)}if(2===arguments.length){var r=arguments[1],i=arguments[0],o=this.Qt,s=i.Qt,a=o.compareToSameClass(s,r);if(0!==a)return a;for(var l=this.getNumInteriorRing(),h=i.getNumInteriorRing(),u=0;u<l&&u<h;){var c=this.getInteriorRingN(u),f=i.getInteriorRingN(u),d=c.compareToSameClass(f,r);if(0!==d)return d;u++}return u<l?1:u<h?-1:0}},e.prototype.apply=function(t){var e=this;if(Q0(t,L1)){this.Qt.apply(t);for(var n=0;n<this.St.length;n++)e.St[n].apply(t)}else if(Q0(t,v2)){if(this.Qt.apply(t),!t.isDone())for(var r=0;r<this.St.length&&(e.St[r].apply(t),!t.isDone());r++);t.isGeometryChanged()&&this.geometryChanged()}else if(Q0(t,y2))t.filter(this);else if(Q0(t,E1)){t.filter(this),this.Qt.apply(t);for(var i=0;i<this.St.length;i++)e.St[i].apply(t)}},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();var t=new Array(this.St.length+1).fill(null);t[0]=this.Qt;for(var e=0;e<this.St.length;e++)t[e+1]=this.St[e];return t.length<=1?this.getFactory().createLinearRing(t[0].getCoordinateSequence()):this.getFactory().createMultiLineString(t)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e.Qt=this.Qt.clone(),e.St=new Array(this.St.length).fill(null);for(var n=0;n<this.St.length;n++)e.St[n]=this.St[n].clone();return e},e.prototype.getGeometryType=function(){return"Polygon"},e.prototype.copy=function(){for(var t=this.Qt.copy(),n=new Array(this.St.length).fill(null),r=0;r<n.length;r++)n[r]=this.St[r].copy();return new e(t,n,this.Zt)},e.prototype.getExteriorRing=function(){return this.Qt},e.prototype.isEmpty=function(){return this.Qt.isEmpty()},e.prototype.getInteriorRingN=function(t){return this.St[t]},e.prototype.interfaces_=function(){return[N2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x307ffefd8dc97200},Object.defineProperties(e,n),e}(O1),z2=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return O1.SORTINDEX_MULTIPOINT},e.prototype.isValid=function(){return!0},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getCoordinate=function(){if(1===arguments.length){var e=arguments[0];return this.Nt[e].getCoordinate()}return t.prototype.getCoordinate.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return m2.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.getGeometryType=function(){return"MultiPoint"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[L2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x6fb1ed4162e0fc00},Object.defineProperties(e,n),e}(x2),B2=function(t){function e(e,n){e instanceof W0&&n instanceof e5&&(e=n.getCoordinateSequenceFactory().create(e)),t.call(this,e,n),this.validateConstruction()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={MINIMUM_VALID_SIZE:{configurable:!0},serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return O1.SORTINDEX_LINEARRING},e.prototype.getBoundaryDimension=function(){return m2.FALSE},e.prototype.isClosed=function(){return!!this.isEmpty()||t.prototype.isClosed.call(this)},e.prototype.reverse=function(){var t=this.jt.copy();return R2.reverse(t),this.getFactory().createLinearRing(t)},e.prototype.validateConstruction=function(){if(!this.isEmpty()&&!t.prototype.isClosed.call(this))throw new z0("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<e.MINIMUM_VALID_SIZE)throw new z0("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")},e.prototype.getGeometryType=function(){return"LinearRing"},e.prototype.copy=function(){return new e(this.jt.copy(),this.Zt)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.MINIMUM_VALID_SIZE.get=function(){return 4},n.serialVersionUID.get=function(){return-0x3b229e262367a600},Object.defineProperties(e,n),e}(k2),H2=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return O1.SORTINDEX_MULTIPOLYGON},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[n]=this.Nt[n].reverse();return this.getFactory().createMultiPolygon(e)},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();for(var t=new q1,e=0;e<this.Nt.length;e++)for(var n=this.Nt[e].getBoundary(),r=0;r<n.getNumGeometries();r++)t.add(n.getGeometryN(r));var i=new Array(t.size()).fill(null);return this.getFactory().createMultiLineString(t.toArray(i))},e.prototype.getGeometryType=function(){return"MultiPolygon"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[N2]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x7a5aa1369171980},Object.defineProperties(e,n),e}(x2),j2=function(t){this.Zt=t||null,this.en=!1},U2={NoOpGeometryOperation:{configurable:!0},CoordinateOperation:{configurable:!0},CoordinateSequenceOperation:{configurable:!0}};j2.prototype.setCopyUserData=function(t){this.en=t},j2.prototype.edit=function(t,e){if(null===t)return null;var n=this.editInternal(t,e);return this.en&&n.setUserData(t.getUserData()),n},j2.prototype.editInternal=function(t,e){return null===this.Zt&&(this.Zt=t.getFactory()),t instanceof x2?this.editGeometryCollection(t,e):t instanceof F2?this.editPolygon(t,e):t instanceof D2||t instanceof k2?e.edit(t,this.Zt):(b1.shouldNeverReachHere("Unsupported Geometry class: "+t.getClass().getName()),null)},j2.prototype.editGeometryCollection=function(t,e){for(var n=e.edit(t,this.Zt),r=new q1,i=0;i<n.getNumGeometries();i++){var o=this.edit(n.getGeometryN(i),e);null===o||o.isEmpty()||r.add(o)}return n.getClass()===z2?this.Zt.createMultiPoint(r.toArray([])):n.getClass()===_2?this.Zt.createMultiLineString(r.toArray([])):n.getClass()===H2?this.Zt.createMultiPolygon(r.toArray([])):this.Zt.createGeometryCollection(r.toArray([]))},j2.prototype.editPolygon=function(t,e){var n=e.edit(t,this.Zt);if(null===n&&(n=this.Zt.createPolygon(null)),n.isEmpty())return n;var r=this.edit(n.getExteriorRing(),e);if(null===r||r.isEmpty())return this.Zt.createPolygon();for(var i=new q1,o=0;o<n.getNumInteriorRing();o++){var s=this.edit(n.getInteriorRingN(o),e);null===s||s.isEmpty()||i.add(s)}return this.Zt.createPolygon(r,i.toArray([]))},j2.prototype.interfaces_=function(){return[]},j2.prototype.getClass=function(){return j2},j2.GeometryEditorOperation=function(){},U2.NoOpGeometryOperation.get=function(){return V2},U2.CoordinateOperation.get=function(){return G2},U2.CoordinateSequenceOperation.get=function(){return W2},Object.defineProperties(j2,U2);var V2=function(){};V2.prototype.edit=function(t,e){return t},V2.prototype.interfaces_=function(){return[j2.GeometryEditorOperation]},V2.prototype.getClass=function(){return V2};var G2=function(){};G2.prototype.edit=function(t,e){var n=this.editCoordinates(t.getCoordinates(),t);return null===n?t:t instanceof B2?e.createLinearRing(n):t instanceof k2?e.createLineString(n):t instanceof D2?n.length>0?e.createPoint(n[0]):e.createPoint():t},G2.prototype.interfaces_=function(){return[j2.GeometryEditorOperation]},G2.prototype.getClass=function(){return G2};var W2=function(){};W2.prototype.edit=function(t,e){return t instanceof B2?e.createLinearRing(this.edit(t.getCoordinateSequence(),t)):t instanceof k2?e.createLineString(this.edit(t.getCoordinateSequence(),t)):t instanceof D2?e.createPoint(this.edit(t.getCoordinateSequence(),t)):t},W2.prototype.interfaces_=function(){return[j2.GeometryEditorOperation]},W2.prototype.getClass=function(){return W2};var q2=function(){var t=this;if(this.sn=3,this.Et=null,1===arguments.length){if(arguments[0]instanceof Array)this.Et=arguments[0],this.sn=3;else if(Number.isInteger(arguments[0])){var e=arguments[0];this.Et=new Array(e).fill(null);for(var n=0;n<e;n++)t.Et[n]=new W0}else if(Q0(arguments[0],a1)){var r=arguments[0];if(null===r)return this.Et=new Array(0).fill(null),null;this.sn=r.getDimension(),this.Et=new Array(r.size()).fill(null);for(var i=0;i<this.Et.length;i++)t.Et[i]=r.getCoordinateCopy(i)}}else if(2===arguments.length)if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var o=arguments[0],s=arguments[1];this.Et=o,this.sn=s,null===o&&(this.Et=new Array(0).fill(null))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var a=arguments[0],l=arguments[1];this.Et=new Array(a).fill(null),this.sn=l;for(var h=0;h<a;h++)t.Et[h]=new W0}},X2={serialVersionUID:{configurable:!0}};q2.prototype.setOrdinate=function(t,e,n){switch(e){case a1.X:this.Et[t].x=n;break;case a1.Y:this.Et[t].y=n;break;case a1.Z:this.Et[t].z=n;break;default:throw new z0("invalid ordinateIndex")}},q2.prototype.size=function(){return this.Et.length},q2.prototype.getOrdinate=function(t,e){switch(e){case a1.X:return this.Et[t].x;case a1.Y:return this.Et[t].y;case a1.Z:return this.Et[t].z}return B0.NaN},q2.prototype.getCoordinate=function(){if(1===arguments.length){var t=arguments[0];return this.Et[t]}if(2===arguments.length){var e=arguments[0],n=arguments[1];n.x=this.Et[e].x,n.y=this.Et[e].y,n.z=this.Et[e].z}},q2.prototype.getCoordinateCopy=function(t){return new W0(this.Et[t])},q2.prototype.getDimension=function(){return this.sn},q2.prototype.getX=function(t){return this.Et[t].x},q2.prototype.clone=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this.Et.length;e++)t[e]=this.Et[e].clone();return new q2(t,this.sn)},q2.prototype.expandEnvelope=function(t){for(var e=0;e<this.Et.length;e++)t.expandToInclude(this.Et[e]);return t},q2.prototype.copy=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this.Et.length;e++)t[e]=this.Et[e].copy();return new q2(t,this.sn)},q2.prototype.toString=function(){if(this.Et.length>0){var t=new t1(17*this.Et.length);t.append("("),t.append(this.Et[0]);for(var e=1;e<this.Et.length;e++)t.append(", "),t.append(this.Et[e]);return t.append(")"),t.toString()}return"()"},q2.prototype.getY=function(t){return this.Et[t].y},q2.prototype.toCoordinateArray=function(){return this.Et},q2.prototype.interfaces_=function(){return[a1,G0]},q2.prototype.getClass=function(){return q2},X2.serialVersionUID.get=function(){return-0xcb44a778db18e00},Object.defineProperties(q2,X2);var Z2=function(){},Y2={serialVersionUID:{configurable:!0},instanceObject:{configurable:!0}};Z2.prototype.readResolve=function(){return Z2.instance()},Z2.prototype.create=function(){if(1===arguments.length){if(arguments[0]instanceof Array)return new q2(arguments[0]);if(Q0(arguments[0],a1))return new q2(arguments[0])}else if(2===arguments.length){var t=arguments[0],e=arguments[1];return e>3&&(e=3),e<2?new q2(t):new q2(t,e)}},Z2.prototype.interfaces_=function(){return[Z0,G0]},Z2.prototype.getClass=function(){return Z2},Z2.instance=function(){return Z2.instanceObject},Y2.serialVersionUID.get=function(){return-0x38e49fa6cf6f2e00},Y2.instanceObject.get=function(){return new Z2},Object.defineProperties(Z2,Y2);var J2=function(t){function e(){t.call(this),this.map_=new Map}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(t){return this.map_.get(t)||null},e.prototype.put=function(t,e){return this.map_.set(t,e),e},e.prototype.values=function(){for(var t=new q1,e=this.map_.values(),n=e.next();!n.done;)t.add(n.value),n=e.next();return t},e.prototype.entrySet=function(){var t=new r2;return this.map_.entries().forEach((function(e){return t.add(e)})),t},e.prototype.size=function(){return this.map_.size()},e}($1),Q2=function t(){if(this.un=null,this.xA=null,0===arguments.length)this.un=t.FLOATING;else if(1===arguments.length)if(arguments[0]instanceof $2){var e=arguments[0];this.un=e,e===t.FIXED&&this.setScale(1)}else if("number"==typeof arguments[0]){var n=arguments[0];this.un=t.FIXED,this.setScale(n)}else if(arguments[0]instanceof t){var r=arguments[0];this.un=r.un,this.xA=r.xA}},K2={serialVersionUID:{configurable:!0},maximumPreciseValue:{configurable:!0}};Q2.prototype.equals=function(t){if(!(t instanceof Q2))return!1;var e=t;return this.un===e.un&&this.xA===e.xA},Q2.prototype.compareTo=function(t){var e=t,n=this.getMaximumSignificantDigits(),r=e.getMaximumSignificantDigits();return new e1(n).compareTo(new e1(r))},Q2.prototype.getScale=function(){return this.xA},Q2.prototype.isFloating=function(){return this.un===Q2.FLOATING||this.un===Q2.FLOATING_SINGLE},Q2.prototype.getType=function(){return this.un},Q2.prototype.toString=function(){var t="UNKNOWN";return this.un===Q2.FLOATING?t="Floating":this.un===Q2.FLOATING_SINGLE?t="Floating-Single":this.un===Q2.FIXED&&(t="Fixed (Scale="+this.getScale()+")"),t},Q2.prototype.makePrecise=function(){if("number"==typeof arguments[0]){var t=arguments[0];return B0.isNaN(t)||this.un===Q2.FLOATING_SINGLE?t:this.un===Q2.FIXED?Math.round(t*this.xA)/this.xA:t}if(arguments[0]instanceof W0){var e=arguments[0];if(this.un===Q2.FLOATING)return null;e.x=this.makePrecise(e.x),e.y=this.makePrecise(e.y)}},Q2.prototype.getMaximumSignificantDigits=function(){var t=16;return this.un===Q2.FLOATING?t=16:this.un===Q2.FLOATING_SINGLE?t=6:this.un===Q2.FIXED&&(t=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),t},Q2.prototype.setScale=function(t){this.xA=Math.abs(t)},Q2.prototype.interfaces_=function(){return[G0,j0]},Q2.prototype.getClass=function(){return Q2},Q2.mostPrecise=function(t,e){return t.compareTo(e)>=0?t:e},K2.serialVersionUID.get=function(){return 0x6bee6404e9a25c00},K2.maximumPreciseValue.get=function(){return 9007199254740992},Object.defineProperties(Q2,K2);var $2=function t(e){this.hn=e||null,t.nameToTypeMap.put(e,this)},t5={serialVersionUID:{configurable:!0},nameToTypeMap:{configurable:!0}};$2.prototype.readResolve=function(){return $2.nameToTypeMap.get(this.hn)},$2.prototype.toString=function(){return this.hn},$2.prototype.interfaces_=function(){return[G0]},$2.prototype.getClass=function(){return $2},t5.serialVersionUID.get=function(){return-552860263173159e4},t5.nameToTypeMap.get=function(){return new J2},Object.defineProperties($2,t5),Q2.Type=$2,Q2.FIXED=new $2("FIXED"),Q2.FLOATING=new $2("FLOATING"),Q2.FLOATING_SINGLE=new $2("FLOATING SINGLE");var e5=function t(){this.Wt=new Q2,this.Xt=0,this.cn=t.getDefaultCoordinateSequenceFactory(),0===arguments.length||(1===arguments.length?Q0(arguments[0],Z0)?this.cn=arguments[0]:arguments[0]instanceof Q2&&(this.Wt=arguments[0]):2===arguments.length?(this.Wt=arguments[0],this.Xt=arguments[1]):3===arguments.length&&(this.Wt=arguments[0],this.Xt=arguments[1],this.cn=arguments[2]))},n5={serialVersionUID:{configurable:!0}};e5.prototype.toGeometry=function(t){return t.isNull()?this.createPoint(null):t.getMinX()===t.getMaxX()&&t.getMinY()===t.getMaxY()?this.createPoint(new W0(t.getMinX(),t.getMinY())):t.getMinX()===t.getMaxX()||t.getMinY()===t.getMaxY()?this.createLineString([new W0(t.getMinX(),t.getMinY()),new W0(t.getMaxX(),t.getMaxY())]):this.createPolygon(this.createLinearRing([new W0(t.getMinX(),t.getMinY()),new W0(t.getMinX(),t.getMaxY()),new W0(t.getMaxX(),t.getMaxY()),new W0(t.getMaxX(),t.getMinY()),new W0(t.getMinX(),t.getMinY())]),null)},e5.prototype.createLineString=function(t){return t?t instanceof Array?new k2(this.getCoordinateSequenceFactory().create(t),this):Q0(t,a1)?new k2(t,this):void 0:new k2(this.getCoordinateSequenceFactory().create([]),this)},e5.prototype.createMultiLineString=function(){return 0===arguments.length?new _2(null,this):1===arguments.length?new _2(arguments[0],this):void 0},e5.prototype.buildGeometry=function(t){for(var e=null,n=!1,r=!1,i=t.iterator();i.hasNext();){var o=i.next(),s=o.getClass();null===e&&(e=s),s!==e&&(n=!0),o.isGeometryCollectionOrDerived()&&(r=!0)}if(null===e)return this.createGeometryCollection();if(n||r)return this.createGeometryCollection(e5.toGeometryArray(t));var a=t.iterator().next();if(t.size()>1){if(a instanceof F2)return this.createMultiPolygon(e5.toPolygonArray(t));if(a instanceof k2)return this.createMultiLineString(e5.toLineStringArray(t));if(a instanceof D2)return this.createMultiPoint(e5.toPointArray(t));b1.shouldNeverReachHere("Unhandled class: "+a.getClass().getName())}return a},e5.prototype.createMultiPointFromCoords=function(t){return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)},e5.prototype.createPoint=function(){if(0===arguments.length)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof W0){var t=arguments[0];return this.createPoint(null!==t?this.getCoordinateSequenceFactory().create([t]):null)}if(Q0(arguments[0],a1))return new D2(arguments[0],this)}},e5.prototype.getCoordinateSequenceFactory=function(){return this.cn},e5.prototype.createPolygon=function(){if(0===arguments.length)return new F2(null,null,this);if(1===arguments.length){if(Q0(arguments[0],a1)){var t=arguments[0];return this.createPolygon(this.createLinearRing(t))}if(arguments[0]instanceof Array){var e=arguments[0];return this.createPolygon(this.createLinearRing(e))}if(arguments[0]instanceof B2){var n=arguments[0];return this.createPolygon(n,null)}}else if(2===arguments.length)return new F2(arguments[0],arguments[1],this)},e5.prototype.getSRID=function(){return this.Xt},e5.prototype.createGeometryCollection=function(){return 0===arguments.length?new x2(null,this):1===arguments.length?new x2(arguments[0],this):void 0},e5.prototype.createGeometry=function(t){return new j2(this).edit(t,{edit:function(){if(2===arguments.length){var t=arguments[0];return this.cn.create(t)}}})},e5.prototype.getPrecisionModel=function(){return this.Wt},e5.prototype.createLinearRing=function(){if(0===arguments.length)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLinearRing(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(Q0(arguments[0],a1))return new B2(arguments[0],this)}},e5.prototype.createMultiPolygon=function(){return 0===arguments.length?new H2(null,this):1===arguments.length?new H2(arguments[0],this):void 0},e5.prototype.createMultiPoint=function(){if(0===arguments.length)return new z2(null,this);if(1===arguments.length){if(arguments[0]instanceof Array)return new z2(arguments[0],this);if(arguments[0]instanceof Array){var t=arguments[0];return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(Q0(arguments[0],a1)){var e=arguments[0];if(null===e)return this.createMultiPoint(new Array(0).fill(null));for(var n=new Array(e.size()).fill(null),r=0;r<e.size();r++){var i=this.getCoordinateSequenceFactory().create(1,e.getDimension());R2.copy(e,r,i,0,1),n[r]=this.createPoint(i)}return this.createMultiPoint(n)}}},e5.prototype.interfaces_=function(){return[G0]},e5.prototype.getClass=function(){return e5},e5.toMultiPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toGeometryArray=function(t){if(null===t)return null;var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.getDefaultCoordinateSequenceFactory=function(){return Z2.instance()},e5.toMultiLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toMultiPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toLinearRingArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.toPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},e5.createPointFromInternalCoord=function(t,e){return e.getPrecisionModel().makePrecise(t),e.getFactory().createPoint(t)},n5.serialVersionUID.get=function(){return-0x5ea75f2051eeb400},Object.defineProperties(e5,n5);var r5=function(){},i5={ON:{configurable:!0},LEFT:{configurable:!0},RIGHT:{configurable:!0}};function o5(t){this.message=t||""}function s5(){this.array_=[]}r5.prototype.interfaces_=function(){return[]},r5.prototype.getClass=function(){return r5},r5.opposite=function(t){return t===r5.LEFT?r5.RIGHT:t===r5.RIGHT?r5.LEFT:t},i5.ON.get=function(){return 0},i5.LEFT.get=function(){return 1},i5.RIGHT.get=function(){return 2},Object.defineProperties(r5,i5),o5.prototype=new Error,o5.prototype.name="EmptyStackException",s5.prototype=new G1,s5.prototype.add=function(t){return this.array_.push(t),!0},s5.prototype.get=function(t){if(t<0||t>=this.size())throw new Error;return this.array_[t]},s5.prototype.push=function(t){return this.array_.push(t),t},s5.prototype.pop=function(t){if(0===this.array_.length)throw new o5;return this.array_.pop()},s5.prototype.peek=function(){if(0===this.array_.length)throw new o5;return this.array_[this.array_.length-1]},s5.prototype.empty=function(){return 0===this.array_.length},s5.prototype.isEmpty=function(){return this.empty()},s5.prototype.search=function(t){return this.array_.indexOf(t)},s5.prototype.size=function(){return this.array_.length},s5.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t};var a5=function(){this.an=-1,this.vn=null,this.ln=null,this.wn=null};a5.prototype.getCoordinate=function(){return this.vn},a5.prototype.getRightmostSide=function(t,e){var n=this.getRightmostSideOfSegment(t,e);return n<0&&(n=this.getRightmostSideOfSegment(t,e-1)),n<0&&(this.vn=null,this.checkForRightmostCoordinate(t)),n},a5.prototype.findRightmostEdgeAtVertex=function(){var t=this.ln.getEdge().getCoordinates();b1.isTrue(this.an>0&&this.an<t.length,"rightmost point expected to be interior vertex of edge");var e=t[this.an-1],n=t[this.an+1],r=I1.computeOrientation(this.vn,n,e),i=!1;(e.y<this.vn.y&&n.y<this.vn.y&&r===I1.COUNTERCLOCKWISE||e.y>this.vn.y&&n.y>this.vn.y&&r===I1.CLOCKWISE)&&(i=!0),i&&(this.an=this.an-1)},a5.prototype.getRightmostSideOfSegment=function(t,e){var n=t.getEdge().getCoordinates();if(e<0||e+1>=n.length)return-1;if(n[e].y===n[e+1].y)return-1;var r=r5.LEFT;return n[e].y<n[e+1].y&&(r=r5.RIGHT),r},a5.prototype.getEdge=function(){return this.wn},a5.prototype.checkForRightmostCoordinate=function(t){for(var e=this,n=t.getEdge().getCoordinates(),r=0;r<n.length-1;r++)(null===e.vn||n[r].x>e.vn.x)&&(e.ln=t,e.an=r,e.vn=n[r])},a5.prototype.findRightmostEdgeAtNode=function(){var t=this.ln.getNode().getEdges();this.ln=t.getRightmostEdge(),this.ln.isForward()||(this.ln=this.ln.getSym(),this.an=this.ln.getEdge().getCoordinates().length-1)},a5.prototype.findEdge=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();n.isForward()&&this.checkForRightmostCoordinate(n)}b1.isTrue(0!==this.an||this.vn.equals(this.ln.getCoordinate()),"inconsistency in rightmost processing"),0===this.an?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this.wn=this.ln,this.getRightmostSide(this.ln,this.an)===r5.LEFT&&(this.wn=this.ln.getSym())},a5.prototype.interfaces_=function(){return[]},a5.prototype.getClass=function(){return a5};var l5=function(t){function e(n,r){t.call(this,e.msgWithCoord(n,r)),this.pt=r?new W0(r):null,this.name="TopologyException"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getCoordinate=function(){return this.pt},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.msgWithCoord=function(t,e){return e?t:t+" [ "+e+" ]"},e}(x1),h5=function(){this.array_=[]};h5.prototype.addLast=function(t){this.array_.push(t)},h5.prototype.removeFirst=function(){return this.array_.shift()},h5.prototype.isEmpty=function(){return 0===this.array_.length};var u5=function(){this.Pn=null,this.gn=new q1,this.Cn=new q1,this.Dn=null,this.In=null,this.Pn=new a5};u5.prototype.clearVisitedEdges=function(){for(var t=this.gn.iterator();t.hasNext();)t.next().setVisited(!1)},u5.prototype.getRightmostCoordinate=function(){return this.Dn},u5.prototype.computeNodeDepth=function(t){for(var e=null,n=t.getEdges().iterator();n.hasNext();){var r=n.next();if(r.isVisited()||r.getSym().isVisited()){e=r;break}}if(null===e)throw new l5("unable to find edge to compute depths at "+t.getCoordinate());t.getEdges().computeDepths(e);for(var i=t.getEdges().iterator();i.hasNext();){var o=i.next();o.setVisited(!0),this.copySymDepths(o)}},u5.prototype.computeDepth=function(t){this.clearVisitedEdges();var e=this.Pn.getEdge();e.setEdgeDepths(r5.RIGHT,t),this.copySymDepths(e),this.computeDepths(e)},u5.prototype.create=function(t){this.addReachable(t),this.Pn.findEdge(this.gn),this.Dn=this.Pn.getCoordinate()},u5.prototype.findResultEdges=function(){for(var t=this.gn.iterator();t.hasNext();){var e=t.next();e.getDepth(r5.RIGHT)>=1&&e.getDepth(r5.LEFT)<=0&&!e.isInteriorAreaEdge()&&e.setInResult(!0)}},u5.prototype.computeDepths=function(t){var e=new r2,n=new h5,r=t.getNode();for(n.addLast(r),e.add(r),t.setVisited(!0);!n.isEmpty();){var i=n.removeFirst();e.add(i),this.computeNodeDepth(i);for(var o=i.getEdges().iterator();o.hasNext();){var s=o.next().getSym();if(!s.isVisited()){var a=s.getNode();e.contains(a)||(n.addLast(a),e.add(a))}}}},u5.prototype.compareTo=function(t){var e=t;return this.Dn.x<e.Dn.x?-1:this.Dn.x>e.Dn.x?1:0},u5.prototype.getEnvelope=function(){if(null===this.In){for(var t=new d1,e=this.gn.iterator();e.hasNext();)for(var n=e.next().getEdge().getCoordinates(),r=0;r<n.length-1;r++)t.expandToInclude(n[r]);this.In=t}return this.In},u5.prototype.addReachable=function(t){var e=new s5;for(e.add(t);!e.empty();){var n=e.pop();this.add(n,e)}},u5.prototype.copySymDepths=function(t){var e=t.getSym();e.setDepth(r5.LEFT,t.getDepth(r5.RIGHT)),e.setDepth(r5.RIGHT,t.getDepth(r5.LEFT))},u5.prototype.add=function(t,e){t.setVisited(!0),this.Cn.add(t);for(var n=t.getEdges().iterator();n.hasNext();){var r=n.next();this.gn.add(r);var i=r.getSym().getNode();i.isVisited()||e.push(i)}},u5.prototype.getNodes=function(){return this.Cn},u5.prototype.getDirectedEdges=function(){return this.gn},u5.prototype.interfaces_=function(){return[j0]},u5.prototype.getClass=function(){return u5};var c5=function t(){if(this.location=null,1===arguments.length){if(arguments[0]instanceof Array){var e=arguments[0];this.init(e.length)}else if(Number.isInteger(arguments[0])){var n=arguments[0];this.init(1),this.location[r5.ON]=n}else if(arguments[0]instanceof t){var r=arguments[0];if(this.init(r.location.length),null!==r)for(var i=0;i<this.location.length;i++)this.location[i]=r.location[i]}}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.init(3),this.location[r5.ON]=o,this.location[r5.LEFT]=s,this.location[r5.RIGHT]=a}};c5.prototype.setAllLocations=function(t){for(var e=0;e<this.location.length;e++)this.location[e]=t},c5.prototype.isNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]!==Y0.NONE)return!1;return!0},c5.prototype.setAllLocationsIfNull=function(t){for(var e=0;e<this.location.length;e++)this.location[e]===Y0.NONE&&(this.location[e]=t)},c5.prototype.isLine=function(){return 1===this.location.length},c5.prototype.merge=function(t){if(t.location.length>this.location.length){var e=new Array(3).fill(null);e[r5.ON]=this.location[r5.ON],e[r5.LEFT]=Y0.NONE,e[r5.RIGHT]=Y0.NONE,this.location=e}for(var n=0;n<this.location.length;n++)this.location[n]===Y0.NONE&&n<t.location.length&&(this.location[n]=t.location[n])},c5.prototype.getLocations=function(){return this.location},c5.prototype.flip=function(){if(this.location.length<=1)return null;var t=this.location[r5.LEFT];this.location[r5.LEFT]=this.location[r5.RIGHT],this.location[r5.RIGHT]=t},c5.prototype.toString=function(){var t=new t1;return this.location.length>1&&t.append(Y0.toLocationSymbol(this.location[r5.LEFT])),t.append(Y0.toLocationSymbol(this.location[r5.ON])),this.location.length>1&&t.append(Y0.toLocationSymbol(this.location[r5.RIGHT])),t.toString()},c5.prototype.setLocations=function(t,e,n){this.location[r5.ON]=t,this.location[r5.LEFT]=e,this.location[r5.RIGHT]=n},c5.prototype.get=function(t){return t<this.location.length?this.location[t]:Y0.NONE},c5.prototype.isArea=function(){return this.location.length>1},c5.prototype.isAnyNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]===Y0.NONE)return!0;return!1},c5.prototype.setLocation=function(){if(1===arguments.length){var t=arguments[0];this.setLocation(r5.ON,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.location[e]=n}},c5.prototype.init=function(t){this.location=new Array(t).fill(null),this.setAllLocations(Y0.NONE)},c5.prototype.isEqualOnSide=function(t,e){return this.location[e]===t.location[e]},c5.prototype.allPositionsEqual=function(t){for(var e=0;e<this.location.length;e++)if(this.location[e]!==t)return!1;return!0},c5.prototype.interfaces_=function(){return[]},c5.prototype.getClass=function(){return c5};var f5=function t(){if(this.elt=new Array(2).fill(null),1===arguments.length){if(Number.isInteger(arguments[0])){var e=arguments[0];this.elt[0]=new c5(e),this.elt[1]=new c5(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.elt[0]=new c5(n.elt[0]),this.elt[1]=new c5(n.elt[1])}}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.elt[0]=new c5(Y0.NONE),this.elt[1]=new c5(Y0.NONE),this.elt[r].setLocation(i)}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.elt[0]=new c5(o,s,a),this.elt[1]=new c5(o,s,a)}else if(4===arguments.length){var l=arguments[0],h=arguments[1],u=arguments[2],c=arguments[3];this.elt[0]=new c5(Y0.NONE,Y0.NONE,Y0.NONE),this.elt[1]=new c5(Y0.NONE,Y0.NONE,Y0.NONE),this.elt[l].setLocations(h,u,c)}};f5.prototype.getGeometryCount=function(){var t=0;return this.elt[0].isNull()||t++,this.elt[1].isNull()||t++,t},f5.prototype.setAllLocations=function(t,e){this.elt[t].setAllLocations(e)},f5.prototype.isNull=function(t){return this.elt[t].isNull()},f5.prototype.setAllLocationsIfNull=function(){if(1===arguments.length){var t=arguments[0];this.setAllLocationsIfNull(0,t),this.setAllLocationsIfNull(1,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.elt[e].setAllLocationsIfNull(n)}},f5.prototype.isLine=function(t){return this.elt[t].isLine()},f5.prototype.merge=function(t){for(var e=this,n=0;n<2;n++)null===e.elt[n]&&null!==t.elt[n]?e.elt[n]=new c5(t.elt[n]):e.elt[n].merge(t.elt[n])},f5.prototype.flip=function(){this.elt[0].flip(),this.elt[1].flip()},f5.prototype.getLocation=function(){if(1===arguments.length){var t=arguments[0];return this.elt[t].get(r5.ON)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return this.elt[e].get(n)}},f5.prototype.toString=function(){var t=new t1;return null!==this.elt[0]&&(t.append("A:"),t.append(this.elt[0].toString())),null!==this.elt[1]&&(t.append(" B:"),t.append(this.elt[1].toString())),t.toString()},f5.prototype.isArea=function(){if(0===arguments.length)return this.elt[0].isArea()||this.elt[1].isArea();if(1===arguments.length){var t=arguments[0];return this.elt[t].isArea()}},f5.prototype.isAnyNull=function(t){return this.elt[t].isAnyNull()},f5.prototype.setLocation=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.elt[t].setLocation(r5.ON,e)}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.elt[n].setLocation(r,i)}},f5.prototype.isEqualOnSide=function(t,e){return this.elt[0].isEqualOnSide(t.elt[0],e)&&this.elt[1].isEqualOnSide(t.elt[1],e)},f5.prototype.allPositionsEqual=function(t,e){return this.elt[t].allPositionsEqual(e)},f5.prototype.toLine=function(t){this.elt[t].isArea()&&(this.elt[t]=new c5(this.elt[t].location[0]))},f5.prototype.interfaces_=function(){return[]},f5.prototype.getClass=function(){return f5},f5.toLineLabel=function(t){for(var e=new f5(Y0.NONE),n=0;n<2;n++)e.setLocation(n,t.getLocation(n));return e};var d5=function(){this.bn=null,this.Mn=-1,this.zn=new q1,this.dn=new q1,this.xn=new f5(Y0.NONE),this.mn=null,this.yn=null,this.Qt=null,this.St=new q1,this.pn=null;var t=arguments[0],e=arguments[1];this.pn=e,this.computePoints(t),this.computeRing()};d5.prototype.computeRing=function(){if(null!==this.mn)return null;for(var t=new Array(this.dn.size()).fill(null),e=0;e<this.dn.size();e++)t[e]=this.dn.get(e);this.mn=this.pn.createLinearRing(t),this.yn=I1.isCCW(this.mn.getCoordinates())},d5.prototype.isIsolated=function(){return 1===this.xn.getGeometryCount()},d5.prototype.computePoints=function(t){var e=this;this.bn=t;var n=t,r=!0;do{if(null===n)throw new l5("Found null DirectedEdge");if(n.getEdgeRing()===e)throw new l5("Directed Edge visited twice during ring-building at "+n.getCoordinate());e.zn.add(n);var i=n.getLabel();b1.isTrue(i.isArea()),e.mergeLabel(i),e.addPoints(n.getEdge(),n.isForward(),r),r=!1,e.setEdgeRing(n,e),n=e.getNext(n)}while(n!==this.bn)},d5.prototype.getLinearRing=function(){return this.mn},d5.prototype.getCoordinate=function(t){return this.dn.get(t)},d5.prototype.computeMaxNodeDegree=function(){var t=this;this.Mn=0;var e=this.bn;do{var n=e.getNode().getEdges().getOutgoingDegree(t);n>t.Mn&&(t.Mn=n),e=t.getNext(e)}while(e!==this.bn);this.Mn*=2},d5.prototype.addPoints=function(t,e,n){var r=t.getCoordinates();if(e){var i=1;n&&(i=0);for(var o=i;o<r.length;o++)this.dn.add(r[o])}else{var s=r.length-2;n&&(s=r.length-1);for(var a=s;a>=0;a--)this.dn.add(r[a])}},d5.prototype.isHole=function(){return this.yn},d5.prototype.setInResult=function(){var t=this.bn;do{t.getEdge().setInResult(!0),t=t.getNext()}while(t!==this.bn)},d5.prototype.containsPoint=function(t){var e=this.getLinearRing();if(!e.getEnvelopeInternal().contains(t))return!1;if(!I1.isPointInRing(t,e.getCoordinates()))return!1;for(var n=this.St.iterator();n.hasNext();)if(n.next().containsPoint(t))return!1;return!0},d5.prototype.addHole=function(t){this.St.add(t)},d5.prototype.isShell=function(){return null===this.Qt},d5.prototype.getLabel=function(){return this.xn},d5.prototype.getEdges=function(){return this.zn},d5.prototype.getMaxNodeDegree=function(){return this.Mn<0&&this.computeMaxNodeDegree(),this.Mn},d5.prototype.getShell=function(){return this.Qt},d5.prototype.mergeLabel=function(){if(1===arguments.length){var t=arguments[0];this.mergeLabel(t,0),this.mergeLabel(t,1)}else if(2===arguments.length){var e=arguments[1],n=arguments[0].getLocation(e,r5.RIGHT);if(n===Y0.NONE)return null;if(this.xn.getLocation(e)===Y0.NONE)return this.xn.setLocation(e,n),null}},d5.prototype.setShell=function(t){this.Qt=t,null!==t&&t.addHole(this)},d5.prototype.toPolygon=function(t){for(var e=new Array(this.St.size()).fill(null),n=0;n<this.St.size();n++)e[n]=this.St.get(n).getLinearRing();return t.createPolygon(this.getLinearRing(),e)},d5.prototype.interfaces_=function(){return[]},d5.prototype.getClass=function(){return d5};var p5=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setEdgeRing=function(t,e){t.setMinEdgeRing(e)},e.prototype.getNext=function(t){return t.getNextMin()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(d5),g5=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildMinimalRings=function(){var t=new q1,e=this.bn;do{if(null===e.getMinEdgeRing()){var n=new p5(e,this.pn);t.add(n)}e=e.getNext()}while(e!==this.bn);return t},e.prototype.setEdgeRing=function(t,e){t.setEdgeRing(e)},e.prototype.linkDirectedEdgesForMinimalEdgeRings=function(){var t=this.bn;do{t.getNode().getEdges().linkMinimalDirectedEdges(this),t=t.getNext()}while(t!==this.bn)},e.prototype.getNext=function(t){return t.getNext()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(d5),m5=function(){if(this.xn=null,this.Ln=!1,this.Tn=!1,this.On=!1,this.Fn=!1,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.xn=t}};m5.prototype.setVisited=function(t){this.Fn=t},m5.prototype.setInResult=function(t){this.Ln=t},m5.prototype.isCovered=function(){return this.Tn},m5.prototype.isCoveredSet=function(){return this.On},m5.prototype.setLabel=function(t){this.xn=t},m5.prototype.getLabel=function(){return this.xn},m5.prototype.setCovered=function(t){this.Tn=t,this.On=!0},m5.prototype.updateIM=function(t){b1.isTrue(this.xn.getGeometryCount()>=2,"found partial label"),this.computeIM(t)},m5.prototype.isInResult=function(){return this.Ln},m5.prototype.isVisited=function(){return this.Fn},m5.prototype.interfaces_=function(){return[]},m5.prototype.getClass=function(){return m5};var A5=function(t){function e(){t.call(this),this.Un=null,this.zn=null;var e=arguments[0],n=arguments[1];this.Un=e,this.zn=n,this.xn=new f5(0,Y0.NONE)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isIncidentEdgeInResult=function(){for(var t=this.getEdges().getEdges().iterator();t.hasNext();)if(t.next().getEdge().isInResult())return!0;return!1},e.prototype.isIsolated=function(){return 1===this.xn.getGeometryCount()},e.prototype.getCoordinate=function(){return this.Un},e.prototype.print=function(t){t.println("node "+this.Un+" lbl: "+this.xn)},e.prototype.computeIM=function(t){},e.prototype.computeMergedLocation=function(t,e){var n=Y0.NONE;if(n=this.xn.getLocation(e),!t.isNull(e)){var r=t.getLocation(e);n!==Y0.BOUNDARY&&(n=r)}return n},e.prototype.setLabel=function(){if(2!==arguments.length)return t.prototype.setLabel.apply(this,arguments);var e=arguments[0],n=arguments[1];null===this.xn?this.xn=new f5(e,n):this.xn.setLocation(e,n)},e.prototype.getEdges=function(){return this.zn},e.prototype.mergeLabel=function(){var t=this;if(arguments[0]instanceof e){var n=arguments[0];this.mergeLabel(n.xn)}else if(arguments[0]instanceof f5)for(var r=arguments[0],i=0;i<2;i++){var o=t.computeMergedLocation(r,i);t.xn.getLocation(i)===Y0.NONE&&t.xn.setLocation(i,o)}},e.prototype.add=function(t){this.zn.insert(t),t.setNode(this)},e.prototype.setLabelBoundary=function(t){if(null===this.xn)return null;var e=Y0.NONE;null!==this.xn&&(e=this.xn.getLocation(t));var n=null;n=e===Y0.BOUNDARY?Y0.INTERIOR:Y0.BOUNDARY,this.xn.setLocation(t,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(m5),y5=function(){this.nodeMap=new u2,this.nodeFact=null;var t=arguments[0];this.nodeFact=t};y5.prototype.find=function(t){return this.nodeMap.get(t)},y5.prototype.addNode=function(){if(arguments[0]instanceof W0){var t=arguments[0],e=this.nodeMap.get(t);return null===e&&(e=this.nodeFact.createNode(t),this.nodeMap.put(t,e)),e}if(arguments[0]instanceof A5){var n=arguments[0],r=this.nodeMap.get(n.getCoordinate());return null===r?(this.nodeMap.put(n.getCoordinate(),n),n):(r.mergeLabel(n),r)}},y5.prototype.print=function(t){for(var e=this.iterator();e.hasNext();)e.next().print(t)},y5.prototype.iterator=function(){return this.nodeMap.values().iterator()},y5.prototype.values=function(){return this.nodeMap.values()},y5.prototype.getBoundaryNodes=function(t){for(var e=new q1,n=this.iterator();n.hasNext();){var r=n.next();r.getLabel().getLocation(t)===Y0.BOUNDARY&&e.add(r)}return e},y5.prototype.add=function(t){var e=t.getCoordinate();this.addNode(e).add(t)},y5.prototype.interfaces_=function(){return[]},y5.prototype.getClass=function(){return y5};var v5=function(){},x5={NE:{configurable:!0},NW:{configurable:!0},SW:{configurable:!0},SE:{configurable:!0}};v5.prototype.interfaces_=function(){return[]},v5.prototype.getClass=function(){return v5},v5.isNorthern=function(t){return t===v5.NE||t===v5.NW},v5.isOpposite=function(t,e){return t!==e&&2==(t-e+4)%4},v5.commonHalfPlane=function(t,e){if(t===e)return t;if(2==(t-e+4)%4)return-1;var n=t<e?t:e;return 0===n&&3===(t>e?t:e)?3:n},v5.isInHalfPlane=function(t,e){return e===v5.SE?t===v5.SE||t===v5.SW:t===e||t===e+1},v5.quadrant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new z0("Cannot compute the quadrant for point ( "+t+", "+e+" )");return t>=0?e>=0?v5.NE:v5.SE:e>=0?v5.NW:v5.SW}if(arguments[0]instanceof W0&&arguments[1]instanceof W0){var n=arguments[0],r=arguments[1];if(r.x===n.x&&r.y===n.y)throw new z0("Cannot compute the quadrant for two identical points "+n);return r.x>=n.x?r.y>=n.y?v5.NE:v5.SE:r.y>=n.y?v5.NW:v5.SW}},x5.NE.get=function(){return 0},x5.NW.get=function(){return 1},x5.SW.get=function(){return 2},x5.SE.get=function(){return 3},Object.defineProperties(v5,x5);var _5=function(){if(this.En=null,this.xn=null,this.Nn=null,this.jn=null,this.Qn=null,this.Sn=null,this.Bn=null,this.kn=null,1===arguments.length){var t=arguments[0];this.En=t}else if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2];this.En=e,this.init(n,r),this.xn=null}else if(4===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];this.En=i,this.init(o,s),this.xn=a}};_5.prototype.compareDirection=function(t){return this.Sn===t.Sn&&this.Bn===t.Bn?0:this.kn>t.kn?1:this.kn<t.kn?-1:I1.computeOrientation(t.jn,t.Qn,this.Qn)},_5.prototype.getDy=function(){return this.Bn},_5.prototype.getCoordinate=function(){return this.jn},_5.prototype.setNode=function(t){this.Nn=t},_5.prototype.print=function(t){var e=Math.atan2(this.Bn,this.Sn),n=this.getClass().getName(),r=n.lastIndexOf("."),i=n.substring(r+1);t.print("  "+i+": "+this.jn+" - "+this.Qn+" "+this.kn+":"+e+"   "+this.xn)},_5.prototype.compareTo=function(t){var e=t;return this.compareDirection(e)},_5.prototype.getDirectedCoordinate=function(){return this.Qn},_5.prototype.getDx=function(){return this.Sn},_5.prototype.getLabel=function(){return this.xn},_5.prototype.getEdge=function(){return this.En},_5.prototype.getQuadrant=function(){return this.kn},_5.prototype.getNode=function(){return this.Nn},_5.prototype.toString=function(){var t=Math.atan2(this.Bn,this.Sn),e=this.getClass().getName(),n=e.lastIndexOf(".");return"  "+e.substring(n+1)+": "+this.jn+" - "+this.Qn+" "+this.kn+":"+t+"   "+this.xn},_5.prototype.computeLabel=function(t){},_5.prototype.init=function(t,e){this.jn=t,this.Qn=e,this.Sn=e.x-t.x,this.Bn=e.y-t.y,this.kn=v5.quadrant(this.Sn,this.Bn),b1.isTrue(!(0===this.Sn&&0===this.Bn),"EdgeEnd with identical endpoints found")},_5.prototype.interfaces_=function(){return[j0]},_5.prototype.getClass=function(){return _5};var b5=function(t){function e(){var e=arguments[0],n=arguments[1];if(t.call(this,e),this.Rn=null,this.Ln=!1,this.Fn=!1,this.Gn=null,this.Yn=null,this.qn=null,this.Vn=null,this.Wn=null,this._n=[0,-999,-999],this.Rn=n,n)this.init(e.getCoordinate(0),e.getCoordinate(1));else{var r=e.getNumPoints()-1;this.init(e.getCoordinate(r),e.getCoordinate(r-1))}this.computeDirectedLabel()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getNextMin=function(){return this.qn},e.prototype.getDepth=function(t){return this._n[t]},e.prototype.setVisited=function(t){this.Fn=t},e.prototype.computeDirectedLabel=function(){this.xn=new f5(this.En.getLabel()),this.Rn||this.xn.flip()},e.prototype.getNext=function(){return this.Yn},e.prototype.setDepth=function(t,e){if(-999!==this._n[t]&&this._n[t]!==e)throw new l5("assigned depths do not match",this.getCoordinate());this._n[t]=e},e.prototype.isInteriorAreaEdge=function(){for(var t=this,e=!0,n=0;n<2;n++)t.xn.isArea(n)&&t.xn.getLocation(n,r5.LEFT)===Y0.INTERIOR&&t.xn.getLocation(n,r5.RIGHT)===Y0.INTERIOR||(e=!1);return e},e.prototype.setNextMin=function(t){this.qn=t},e.prototype.print=function(e){t.prototype.print.call(this,e),e.print(" "+this._n[r5.LEFT]+"/"+this._n[r5.RIGHT]),e.print(" ("+this.getDepthDelta()+")"),this.Ln&&e.print(" inResult")},e.prototype.setMinEdgeRing=function(t){this.Wn=t},e.prototype.isLineEdge=function(){var t=this.xn.isLine(0)||this.xn.isLine(1),e=!this.xn.isArea(0)||this.xn.allPositionsEqual(0,Y0.EXTERIOR),n=!this.xn.isArea(1)||this.xn.allPositionsEqual(1,Y0.EXTERIOR);return t&&e&&n},e.prototype.setEdgeRing=function(t){this.Vn=t},e.prototype.getMinEdgeRing=function(){return this.Wn},e.prototype.getDepthDelta=function(){var t=this.En.getDepthDelta();return this.Rn||(t=-t),t},e.prototype.setInResult=function(t){this.Ln=t},e.prototype.getSym=function(){return this.Gn},e.prototype.isForward=function(){return this.Rn},e.prototype.getEdge=function(){return this.En},e.prototype.printEdge=function(t){this.print(t),t.print(" "),this.Rn?this.En.print(t):this.En.printReverse(t)},e.prototype.setSym=function(t){this.Gn=t},e.prototype.setVisitedEdge=function(t){this.setVisited(t),this.Gn.setVisited(t)},e.prototype.setEdgeDepths=function(t,e){var n=this.getEdge().getDepthDelta();this.Rn||(n=-n);var r=1;t===r5.LEFT&&(r=-1);var i=r5.opposite(t),o=e+n*r;this.setDepth(t,e),this.setDepth(i,o)},e.prototype.getEdgeRing=function(){return this.Vn},e.prototype.isInResult=function(){return this.Ln},e.prototype.setNext=function(t){this.Yn=t},e.prototype.isVisited=function(){return this.Fn},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.depthFactor=function(t,e){return t===Y0.EXTERIOR&&e===Y0.INTERIOR?1:t===Y0.INTERIOR&&e===Y0.EXTERIOR?-1:0},e}(_5),w5=function(){};w5.prototype.createNode=function(t){return new A5(t,null)},w5.prototype.interfaces_=function(){return[]},w5.prototype.getClass=function(){return w5};var T5=function(){if(this.zn=new q1,this.Cn=null,this.Kn=new q1,0===arguments.length)this.Cn=new y5(new w5);else if(1===arguments.length){var t=arguments[0];this.Cn=new y5(t)}};T5.prototype.printEdges=function(t){t.println("Edges:");for(var e=0;e<this.zn.size();e++){t.println("edge "+e+":");var n=this.zn.get(e);n.print(t),n.eiList.print(t)}},T5.prototype.find=function(t){return this.Cn.find(t)},T5.prototype.addNode=function(){if(arguments[0]instanceof A5){var t=arguments[0];return this.Cn.addNode(t)}if(arguments[0]instanceof W0){var e=arguments[0];return this.Cn.addNode(e)}},T5.prototype.getNodeIterator=function(){return this.Cn.iterator()},T5.prototype.linkResultDirectedEdges=function(){for(var t=this.Cn.iterator();t.hasNext();)t.next().getEdges().linkResultDirectedEdges()},T5.prototype.debugPrintln=function(t){c1.out.println(t)},T5.prototype.isBoundaryNode=function(t,e){var n=this.Cn.find(e);if(null===n)return!1;var r=n.getLabel();return null!==r&&r.getLocation(t)===Y0.BOUNDARY},T5.prototype.linkAllDirectedEdges=function(){for(var t=this.Cn.iterator();t.hasNext();)t.next().getEdges().linkAllDirectedEdges()},T5.prototype.matchInSameDirection=function(t,e,n,r){return!!t.equals(n)&&I1.computeOrientation(t,e,r)===I1.COLLINEAR&&v5.quadrant(t,e)===v5.quadrant(n,r)},T5.prototype.getEdgeEnds=function(){return this.Kn},T5.prototype.debugPrint=function(t){c1.out.print(t)},T5.prototype.getEdgeIterator=function(){return this.zn.iterator()},T5.prototype.findEdgeInSameDirection=function(t,e){for(var n=this,r=0;r<this.zn.size();r++){var i=n.zn.get(r),o=i.getCoordinates();if(n.matchInSameDirection(t,e,o[0],o[1]))return i;if(n.matchInSameDirection(t,e,o[o.length-1],o[o.length-2]))return i}return null},T5.prototype.insertEdge=function(t){this.zn.add(t)},T5.prototype.findEdgeEnd=function(t){for(var e=this.getEdgeEnds().iterator();e.hasNext();){var n=e.next();if(n.getEdge()===t)return n}return null},T5.prototype.addEdges=function(t){for(var e=this,n=t.iterator();n.hasNext();){var r=n.next();e.zn.add(r);var i=new b5(r,!0),o=new b5(r,!1);i.setSym(o),o.setSym(i),e.add(i),e.add(o)}},T5.prototype.add=function(t){this.Cn.add(t),this.Kn.add(t)},T5.prototype.getNodes=function(){return this.Cn.values()},T5.prototype.findEdge=function(t,e){for(var n=0;n<this.zn.size();n++){var r=this.zn.get(n),i=r.getCoordinates();if(t.equals(i[0])&&e.equals(i[1]))return r}return null},T5.prototype.interfaces_=function(){return[]},T5.prototype.getClass=function(){return T5},T5.linkResultDirectedEdges=function(t){for(var e=t.iterator();e.hasNext();)e.next().getEdges().linkResultDirectedEdges()};var M5=function(){this.pn=null,this.Hn=new q1;var t=arguments[0];this.pn=t};M5.prototype.sortShellsAndHoles=function(t,e,n){for(var r=t.iterator();r.hasNext();){var i=r.next();i.isHole()?n.add(i):e.add(i)}},M5.prototype.computePolygons=function(t){for(var e=new q1,n=t.iterator();n.hasNext();){var r=n.next().toPolygon(this.pn);e.add(r)}return e},M5.prototype.placeFreeHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();if(null===r.getShell()){var i=this.findEdgeRingContaining(r,t);if(null===i)throw new l5("unable to assign hole to a shell",r.getCoordinate(0));r.setShell(i)}}},M5.prototype.buildMinimalEdgeRings=function(t,e,n){for(var r=new q1,i=t.iterator();i.hasNext();){var o=i.next();if(o.getMaxNodeDegree()>2){o.linkDirectedEdgesForMinimalEdgeRings();var s=o.buildMinimalRings(),a=this.findShell(s);null!==a?(this.placePolygonHoles(a,s),e.add(a)):n.addAll(s)}else r.add(o)}return r},M5.prototype.containsPoint=function(t){for(var e=this.Hn.iterator();e.hasNext();)if(e.next().containsPoint(t))return!0;return!1},M5.prototype.buildMaximalEdgeRings=function(t){for(var e=new q1,n=t.iterator();n.hasNext();){var r=n.next();if(r.isInResult()&&r.getLabel().isArea()&&null===r.getEdgeRing()){var i=new g5(r,this.pn);e.add(i),i.setInResult()}}return e},M5.prototype.placePolygonHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();r.isHole()&&r.setShell(t)}},M5.prototype.getPolygons=function(){return this.computePolygons(this.Hn)},M5.prototype.findEdgeRingContaining=function(t,e){for(var n=t.getLinearRing(),r=n.getEnvelopeInternal(),i=n.getCoordinateN(0),o=null,s=null,a=e.iterator();a.hasNext();){var l=a.next(),h=l.getLinearRing(),u=h.getEnvelopeInternal();null!==o&&(s=o.getLinearRing().getEnvelopeInternal());var c=!1;u.contains(r)&&I1.isPointInRing(i,h.getCoordinates())&&(c=!0),c&&(null===o||s.contains(u))&&(o=l)}return o},M5.prototype.findShell=function(t){for(var e=0,n=null,r=t.iterator();r.hasNext();){var i=r.next();i.isHole()||(n=i,e++)}return b1.isTrue(e<=1,"found two shells in MinimalEdgeRing list"),n},M5.prototype.add=function(){if(1===arguments.length){var t=arguments[0];this.add(t.getEdgeEnds(),t.getNodes())}else if(2===arguments.length){var e=arguments[0];T5.linkResultDirectedEdges(arguments[1]);var n=this.buildMaximalEdgeRings(e),r=new q1,i=this.buildMinimalEdgeRings(n,this.Hn,r);this.sortShellsAndHoles(i,this.Hn,r),this.placeFreeHoles(this.Hn,r)}},M5.prototype.interfaces_=function(){return[]},M5.prototype.getClass=function(){return M5};var C5=function(){};C5.prototype.getBounds=function(){},C5.prototype.interfaces_=function(){return[]},C5.prototype.getClass=function(){return C5};var S5=function(){this.Jn=null,this.Zn=null;var t=arguments[0],e=arguments[1];this.Jn=t,this.Zn=e};S5.prototype.getItem=function(){return this.Zn},S5.prototype.getBounds=function(){return this.Jn},S5.prototype.interfaces_=function(){return[C5,G0]},S5.prototype.getClass=function(){return S5};var I5=function(){this.Xn=null,this.$n=null,this.Xn=0,this.$n=new q1,this.$n.add(null)};I5.prototype.poll=function(){if(this.isEmpty())return null;var t=this.$n.get(1);return this.$n.set(1,this.$n.get(this.Xn)),this.Xn-=1,this.reorder(1),t},I5.prototype.size=function(){return this.Xn},I5.prototype.reorder=function(t){for(var e=this,n=null,r=this.$n.get(t);2*t<=this.Xn&&((n=2*t)!==e.Xn&&e.$n.get(n+1).compareTo(e.$n.get(n))<0&&n++,e.$n.get(n).compareTo(r)<0);t=n)e.$n.set(t,e.$n.get(n));this.$n.set(t,r)},I5.prototype.clear=function(){this.Xn=0,this.$n.clear()},I5.prototype.isEmpty=function(){return 0===this.Xn},I5.prototype.add=function(t){this.$n.add(null),this.Xn+=1;var e=this.Xn;for(this.$n.set(0,t);t.compareTo(this.$n.get(Math.trunc(e/2)))<0;e/=2)this.$n.set(e,this.$n.get(Math.trunc(e/2)));this.$n.set(e,t)},I5.prototype.interfaces_=function(){return[]},I5.prototype.getClass=function(){return I5};var P5=function(){};P5.prototype.visitItem=function(t){},P5.prototype.interfaces_=function(){return[]},P5.prototype.getClass=function(){return P5};var E5=function(){};E5.prototype.insert=function(t,e){},E5.prototype.remove=function(t,e){},E5.prototype.query=function(){},E5.prototype.interfaces_=function(){return[]},E5.prototype.getClass=function(){return E5};var O5=function(){if(this.Ai=new q1,this.Jn=null,this.ti=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.ti=t}},R5={serialVersionUID:{configurable:!0}};O5.prototype.getLevel=function(){return this.ti},O5.prototype.size=function(){return this.Ai.size()},O5.prototype.getChildBoundables=function(){return this.Ai},O5.prototype.addChildBoundable=function(t){b1.isTrue(null===this.Jn),this.Ai.add(t)},O5.prototype.isEmpty=function(){return this.Ai.isEmpty()},O5.prototype.getBounds=function(){return null===this.Jn&&(this.Jn=this.computeBounds()),this.Jn},O5.prototype.interfaces_=function(){return[C5,G0]},O5.prototype.getClass=function(){return O5},R5.serialVersionUID.get=function(){return 0x5a1e55ec41369800},Object.defineProperties(O5,R5);var k5=function(){};k5.reverseOrder=function(){return{compare:function(t,e){return e.compareTo(t)}}},k5.min=function(t){return k5.sort(t),t.get(0)},k5.sort=function(t,e){var n=t.toArray();e?g2.sort(n,e):g2.sort(n);for(var r=t.iterator(),i=0,o=n.length;i<o;i++)r.next(),r.set(n[i])},k5.singletonList=function(t){var e=new q1;return e.add(t),e};var L5=function(){this.ni=null,this.ii=null,this.ri=null,this.ei=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.ni=t,this.ii=e,this.ei=n,this.ri=this.distance()};L5.prototype.expandToQueue=function(t,e){var n=L5.isComposite(this.ni),r=L5.isComposite(this.ii);if(n&&r)return L5.area(this.ni)>L5.area(this.ii)?(this.expand(this.ni,this.ii,t,e),null):(this.expand(this.ii,this.ni,t,e),null);if(n)return this.expand(this.ni,this.ii,t,e),null;if(r)return this.expand(this.ii,this.ni,t,e),null;throw new z0("neither boundable is composite")},L5.prototype.isLeaves=function(){return!(L5.isComposite(this.ni)||L5.isComposite(this.ii))},L5.prototype.compareTo=function(t){var e=t;return this.ri<e.ri?-1:this.ri>e.ri?1:0},L5.prototype.expand=function(t,e,n,r){for(var i=t.getChildBoundables().iterator();i.hasNext();){var o=i.next(),s=new L5(o,e,this.ei);s.getDistance()<r&&n.add(s)}},L5.prototype.getBoundable=function(t){return 0===t?this.ni:this.ii},L5.prototype.getDistance=function(){return this.ri},L5.prototype.distance=function(){return this.isLeaves()?this.ei.distance(this.ni,this.ii):this.ni.getBounds().distance(this.ii.getBounds())},L5.prototype.interfaces_=function(){return[j0]},L5.prototype.getClass=function(){return L5},L5.area=function(t){return t.getBounds().getArea()},L5.isComposite=function(t){return t instanceof O5};var D5=function t(){if(this.si=null,this.ui=!1,this.oi=new q1,this.hi=null,0===arguments.length){var e=t.DEFAULT_NODE_CAPACITY;this.hi=e}else if(1===arguments.length){var n=arguments[0];b1.isTrue(n>1,"Node capacity must be greater than 1"),this.hi=n}},N5={IntersectsOp:{configurable:!0},serialVersionUID:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};D5.prototype.getNodeCapacity=function(){return this.hi},D5.prototype.lastNode=function(t){return t.get(t.size()-1)},D5.prototype.size=function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.size(this.si));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();n instanceof O5?t+=this.size(n):n instanceof S5&&(t+=1)}return t}},D5.prototype.removeItem=function(t,e){for(var n=null,r=t.getChildBoundables().iterator();r.hasNext();){var i=r.next();i instanceof S5&&i.getItem()===e&&(n=i)}return null!==n&&(t.getChildBoundables().remove(n),!0)},D5.prototype.itemsTree=function(){if(0===arguments.length){this.build();var t=this.itemsTree(this.si);return null===t?new q1:t}if(1===arguments.length){for(var e=arguments[0],n=new q1,r=e.getChildBoundables().iterator();r.hasNext();){var i=r.next();if(i instanceof O5){var o=this.itemsTree(i);null!==o&&n.add(o)}else i instanceof S5?n.add(i.getItem()):b1.shouldNeverReachHere()}return n.size()<=0?null:n}},D5.prototype.insert=function(t,e){b1.isTrue(!this.ui,"Cannot insert items into an STR packed R-tree after it has been built."),this.oi.add(new S5(t,e))},D5.prototype.boundablesAtLevel=function(){if(1===arguments.length){var t=arguments[0],e=new q1;return this.boundablesAtLevel(t,this.si,e),e}if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];if(b1.isTrue(n>-2),r.getLevel()===n)return i.add(r),null;for(var o=r.getChildBoundables().iterator();o.hasNext();){var s=o.next();s instanceof O5?this.boundablesAtLevel(n,s,i):(b1.isTrue(s instanceof S5),-1===n&&i.add(s))}return null}},D5.prototype.query=function(){var t=this;if(1===arguments.length){var e=arguments[0];this.build();var n=new q1;return this.isEmpty()||this.getIntersectsOp().intersects(this.si.getBounds(),e)&&this.query(e,this.si,n),n}if(2===arguments.length){var r=arguments[0],i=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this.si.getBounds(),r)&&this.query(r,this.si,i)}else if(3===arguments.length)if(Q0(arguments[2],P5)&&arguments[0]instanceof Object&&arguments[1]instanceof O5)for(var o=arguments[0],s=arguments[2],a=arguments[1].getChildBoundables(),l=0;l<a.size();l++){var h=a.get(l);t.getIntersectsOp().intersects(h.getBounds(),o)&&(h instanceof O5?t.query(o,h,s):h instanceof S5?s.visitItem(h.getItem()):b1.shouldNeverReachHere())}else if(Q0(arguments[2],G1)&&arguments[0]instanceof Object&&arguments[1]instanceof O5)for(var u=arguments[0],c=arguments[2],f=arguments[1].getChildBoundables(),d=0;d<f.size();d++){var p=f.get(d);t.getIntersectsOp().intersects(p.getBounds(),u)&&(p instanceof O5?t.query(u,p,c):p instanceof S5?c.add(p.getItem()):b1.shouldNeverReachHere())}},D5.prototype.build=function(){if(this.ui)return null;this.si=this.oi.isEmpty()?this.createNode(0):this.createHigherLevels(this.oi,-1),this.oi=null,this.ui=!0},D5.prototype.getRoot=function(){return this.build(),this.si},D5.prototype.remove=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.build(),!!this.getIntersectsOp().intersects(this.si.getBounds(),t)&&this.remove(t,this.si,e)}if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2],o=this.removeItem(r,i);if(o)return!0;for(var s=null,a=r.getChildBoundables().iterator();a.hasNext();){var l=a.next();if(this.getIntersectsOp().intersects(l.getBounds(),n)&&l instanceof O5&&(o=this.remove(n,l,i))){s=l;break}}return null!==s&&s.getChildBoundables().isEmpty()&&r.getChildBoundables().remove(s),o}},D5.prototype.createHigherLevels=function(t,e){b1.isTrue(!t.isEmpty());var n=this.createParentBoundables(t,e+1);return 1===n.size()?n.get(0):this.createHigherLevels(n,e+1)},D5.prototype.depth=function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.depth(this.si));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();if(n instanceof O5){var r=this.depth(n);r>t&&(t=r)}}return t+1}},D5.prototype.createParentBoundables=function(t,e){var n=this;b1.isTrue(!t.isEmpty());var r=new q1;r.add(this.createNode(e));var i=new q1(t);k5.sort(i,this.getComparator());for(var o=i.iterator();o.hasNext();){var s=o.next();n.lastNode(r).getChildBoundables().size()===n.getNodeCapacity()&&r.add(n.createNode(e)),n.lastNode(r).addChildBoundable(s)}return r},D5.prototype.isEmpty=function(){return this.ui?this.si.isEmpty():this.oi.isEmpty()},D5.prototype.interfaces_=function(){return[G0]},D5.prototype.getClass=function(){return D5},D5.compareDoubles=function(t,e){return t>e?1:t<e?-1:0},N5.IntersectsOp.get=function(){return F5},N5.serialVersionUID.get=function(){return-0x35ef64c82d4c5400},N5.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(D5,N5);var F5=function(){},z5=function(){};z5.prototype.distance=function(t,e){},z5.prototype.interfaces_=function(){return[]},z5.prototype.getClass=function(){return z5};var B5=function(t){function e(n){n=n||e.DEFAULT_NODE_CAPACITY,t.call(this,n)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={STRtreeNode:{configurable:!0},serialVersionUID:{configurable:!0},xComparator:{configurable:!0},yComparator:{configurable:!0},intersectsOp:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};return e.prototype.createParentBoundablesFromVerticalSlices=function(t,e){b1.isTrue(t.length>0);for(var n=new q1,r=0;r<t.length;r++)n.addAll(this.createParentBoundablesFromVerticalSlice(t[r],e));return n},e.prototype.createNode=function(t){return new H5(t)},e.prototype.size=function(){return 0===arguments.length?t.prototype.size.call(this):t.prototype.size.apply(this,arguments)},e.prototype.insert=function(){if(2!==arguments.length)return t.prototype.insert.apply(this,arguments);var e=arguments[0],n=arguments[1];if(e.isNull())return null;t.prototype.insert.call(this,e,n)},e.prototype.getIntersectsOp=function(){return e.intersectsOp},e.prototype.verticalSlices=function(t,e){for(var n=Math.trunc(Math.ceil(t.size()/e)),r=new Array(e).fill(null),i=t.iterator(),o=0;o<e;o++){r[o]=new q1;for(var s=0;i.hasNext()&&s<n;){var a=i.next();r[o].add(a),s++}}return r},e.prototype.query=function(){if(1===arguments.length){var e=arguments[0];return t.prototype.query.call(this,e)}if(2===arguments.length){var n=arguments[0],r=arguments[1];t.prototype.query.call(this,n,r)}else if(3===arguments.length)if(Q0(arguments[2],P5)&&arguments[0]instanceof Object&&arguments[1]instanceof O5){var i=arguments[0],o=arguments[1],s=arguments[2];t.prototype.query.call(this,i,o,s)}else if(Q0(arguments[2],G1)&&arguments[0]instanceof Object&&arguments[1]instanceof O5){var a=arguments[0],l=arguments[1],h=arguments[2];t.prototype.query.call(this,a,l,h)}},e.prototype.getComparator=function(){return e.yComparator},e.prototype.createParentBoundablesFromVerticalSlice=function(e,n){return t.prototype.createParentBoundables.call(this,e,n)},e.prototype.remove=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return t.prototype.remove.call(this,e,n)}return t.prototype.remove.apply(this,arguments)},e.prototype.depth=function(){return 0===arguments.length?t.prototype.depth.call(this):t.prototype.depth.apply(this,arguments)},e.prototype.createParentBoundables=function(t,n){b1.isTrue(!t.isEmpty());var r=Math.trunc(Math.ceil(t.size()/this.getNodeCapacity())),i=new q1(t);k5.sort(i,e.xComparator);var o=this.verticalSlices(i,Math.trunc(Math.ceil(Math.sqrt(r))));return this.createParentBoundablesFromVerticalSlices(o,n)},e.prototype.nearestNeighbour=function(){if(1===arguments.length){if(Q0(arguments[0],z5)){var t=arguments[0],n=new L5(this.getRoot(),this.getRoot(),t);return this.nearestNeighbour(n)}if(arguments[0]instanceof L5){var r=arguments[0];return this.nearestNeighbour(r,B0.POSITIVE_INFINITY)}}else if(2===arguments.length){if(arguments[0]instanceof e&&Q0(arguments[1],z5)){var i=arguments[0],o=arguments[1],s=new L5(this.getRoot(),i.getRoot(),o);return this.nearestNeighbour(s)}if(arguments[0]instanceof L5&&"number"==typeof arguments[1]){var a=arguments[0],l=arguments[1],h=null,u=new I5;for(u.add(a);!u.isEmpty()&&l>0;){var c=u.poll(),f=c.getDistance();if(f>=l)break;c.isLeaves()?(l=f,h=c):c.expandToQueue(u,l)}return[h.getBoundable(0).getItem(),h.getBoundable(1).getItem()]}}else if(3===arguments.length){var d=arguments[2],p=new S5(arguments[0],arguments[1]),g=new L5(this.getRoot(),p,d);return this.nearestNeighbour(g)[0]}},e.prototype.interfaces_=function(){return[E5,G0]},e.prototype.getClass=function(){return e},e.centreX=function(t){return e.avg(t.getMinX(),t.getMaxX())},e.avg=function(t,e){return(t+e)/2},e.centreY=function(t){return e.avg(t.getMinY(),t.getMaxY())},n.STRtreeNode.get=function(){return H5},n.serialVersionUID.get=function(){return 0x39920f7d5f261e0},n.xComparator.get=function(){return{interfaces_:function(){return[V0]},compare:function(n,r){return t.compareDoubles(e.centreX(n.getBounds()),e.centreX(r.getBounds()))}}},n.yComparator.get=function(){return{interfaces_:function(){return[V0]},compare:function(n,r){return t.compareDoubles(e.centreY(n.getBounds()),e.centreY(r.getBounds()))}}},n.intersectsOp.get=function(){return{interfaces_:function(){return[t.IntersectsOp]},intersects:function(t,e){return t.intersects(e)}}},n.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(e,n),e}(D5),H5=function(t){function e(){var e=arguments[0];t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.computeBounds=function(){for(var t=null,e=this.getChildBoundables().iterator();e.hasNext();){var n=e.next();null===t?t=new d1(n.getBounds()):t.expandToInclude(n.getBounds())}return t},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(O5),j5=function(){};j5.prototype.interfaces_=function(){return[]},j5.prototype.getClass=function(){return j5},j5.relativeSign=function(t,e){return t<e?-1:t>e?1:0},j5.compare=function(t,e,n){if(e.equals2D(n))return 0;var r=j5.relativeSign(e.x,n.x),i=j5.relativeSign(e.y,n.y);switch(t){case 0:return j5.compareValue(r,i);case 1:return j5.compareValue(i,r);case 2:return j5.compareValue(i,-r);case 3:return j5.compareValue(-r,i);case 4:return j5.compareValue(-r,-i);case 5:return j5.compareValue(-i,-r);case 6:return j5.compareValue(-i,r);case 7:return j5.compareValue(r,-i)}return b1.shouldNeverReachHere("invalid octant value"),0},j5.compareValue=function(t,e){return t<0?-1:t>0?1:e<0?-1:e>0?1:0};var U5=function(){this.fi=null,this.coord=null,this.segmentIndex=null,this.ci=null,this.ai=null;var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.fi=t,this.coord=new W0(e),this.segmentIndex=n,this.ci=r,this.ai=!e.equals2D(t.getCoordinate(n))};U5.prototype.getCoordinate=function(){return this.coord},U5.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex)},U5.prototype.compareTo=function(t){var e=t;return this.segmentIndex<e.segmentIndex?-1:this.segmentIndex>e.segmentIndex?1:this.coord.equals2D(e.coord)?0:j5.compare(this.ci,this.coord,e.coord)},U5.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&!this.ai||this.segmentIndex===t},U5.prototype.isInterior=function(){return this.ai},U5.prototype.interfaces_=function(){return[j0]},U5.prototype.getClass=function(){return U5};var V5=function(){this.vi=new u2,this.En=null;var t=arguments[0];this.En=t};V5.prototype.getSplitCoordinates=function(){var t=new Z1;this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next();this.addEdgeCoordinates(n,r,t),n=r}return t.toCoordinateArray()},V5.prototype.addCollapsedNodes=function(){var t=new q1;this.findCollapsesFromInsertedNodes(t),this.findCollapsesFromExistingVertices(t);for(var e=t.iterator();e.hasNext();){var n=e.next().intValue();this.add(this.En.getCoordinate(n),n)}},V5.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},V5.prototype.findCollapsesFromExistingVertices=function(t){for(var e=0;e<this.En.size()-2;e++){var n=this.En.getCoordinate(e),r=this.En.getCoordinate(e+2);n.equals2D(r)&&t.add(new e1(e+1))}},V5.prototype.addEdgeCoordinates=function(t,e,n){var r=this.En.getCoordinate(e.segmentIndex),i=e.isInterior()||!e.coord.equals2D(r);n.add(new W0(t.coord),!1);for(var o=t.segmentIndex+1;o<=e.segmentIndex;o++)n.add(this.En.getCoordinate(o));i&&n.add(new W0(e.coord))},V5.prototype.iterator=function(){return this.vi.values().iterator()},V5.prototype.addSplitEdges=function(t){this.addEndpoints(),this.addCollapsedNodes();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next(),i=this.createSplitEdge(n,r);t.add(i),n=r}},V5.prototype.findCollapseIndex=function(t,e,n){if(!t.coord.equals2D(e.coord))return!1;var r=e.segmentIndex-t.segmentIndex;return e.isInterior()||r--,1===r&&(n[0]=t.segmentIndex+1,!0)},V5.prototype.findCollapsesFromInsertedNodes=function(t){for(var e=new Array(1).fill(null),n=this.iterator(),r=n.next();n.hasNext();){var i=n.next();this.findCollapseIndex(r,i,e)&&t.add(new e1(e[0])),r=i}},V5.prototype.getEdge=function(){return this.En},V5.prototype.addEndpoints=function(){var t=this.En.size()-1;this.add(this.En.getCoordinate(0),0),this.add(this.En.getCoordinate(t),t)},V5.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,r=this.En.getCoordinate(e.segmentIndex),i=e.isInterior()||!e.coord.equals2D(r);i||n--;var o=new Array(n).fill(null),s=0;o[s++]=new W0(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)o[s++]=this.En.getCoordinate(a);return i&&(o[s]=new W0(e.coord)),new X5(o,this.En.getData())},V5.prototype.add=function(t,e){var n=new U5(this.En,t,e,this.En.getSegmentOctant(e)),r=this.vi.get(n);return null!==r?(b1.isTrue(r.coord.equals2D(t),"Found equal nodes with different coordinates"),r):(this.vi.put(n,n),n)},V5.prototype.checkSplitEdgesCorrectness=function(t){var e=this.En.getCoordinates(),n=t.get(0).getCoordinate(0);if(!n.equals2D(e[0]))throw new x1("bad split edge start point at "+n);var r=t.get(t.size()-1).getCoordinates(),i=r[r.length-1];if(!i.equals2D(e[e.length-1]))throw new x1("bad split edge end point at "+i)},V5.prototype.interfaces_=function(){return[]},V5.prototype.getClass=function(){return V5};var G5=function(){};G5.prototype.interfaces_=function(){return[]},G5.prototype.getClass=function(){return G5},G5.octant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new z0("Cannot compute the octant for point ( "+t+", "+e+" )");var n=Math.abs(t),r=Math.abs(e);return t>=0?e>=0?n>=r?0:1:n>=r?7:6:e>=0?n>=r?3:2:n>=r?4:5}if(arguments[0]instanceof W0&&arguments[1]instanceof W0){var i=arguments[0],o=arguments[1],s=o.x-i.x,a=o.y-i.y;if(0===s&&0===a)throw new z0("Cannot compute the octant for two identical points "+i);return G5.octant(s,a)}};var W5=function(){};W5.prototype.getCoordinates=function(){},W5.prototype.size=function(){},W5.prototype.getCoordinate=function(t){},W5.prototype.isClosed=function(){},W5.prototype.setData=function(t){},W5.prototype.getData=function(){},W5.prototype.interfaces_=function(){return[]},W5.prototype.getClass=function(){return W5};var q5=function(){};q5.prototype.addIntersection=function(t,e){},q5.prototype.interfaces_=function(){return[W5]},q5.prototype.getClass=function(){return q5};var X5=function(){this.li=new V5(this),this.dn=null,this.wi=null;var t=arguments[0],e=arguments[1];this.dn=t,this.wi=e};X5.prototype.getCoordinates=function(){return this.dn},X5.prototype.size=function(){return this.dn.length},X5.prototype.getCoordinate=function(t){return this.dn[t]},X5.prototype.isClosed=function(){return this.dn[0].equals(this.dn[this.dn.length-1])},X5.prototype.getSegmentOctant=function(t){return t===this.dn.length-1?-1:this.safeOctant(this.getCoordinate(t),this.getCoordinate(t+1))},X5.prototype.setData=function(t){this.wi=t},X5.prototype.safeOctant=function(t,e){return t.equals2D(e)?0:G5.octant(t,e)},X5.prototype.getData=function(){return this.wi},X5.prototype.addIntersection=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.addIntersectionNode(t,e)}else if(4===arguments.length){var n=arguments[1],r=arguments[3],i=new W0(arguments[0].getIntersection(r));this.addIntersection(i,n)}},X5.prototype.toString=function(){return v1.toLineString(new q2(this.dn))},X5.prototype.getNodeList=function(){return this.li},X5.prototype.addIntersectionNode=function(t,e){var n=e,r=n+1;if(r<this.dn.length){var i=this.dn[r];t.equals2D(i)&&(n=r)}return this.li.add(t,n)},X5.prototype.addIntersections=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++)this.addIntersection(t,e,n,r)},X5.prototype.interfaces_=function(){return[q5]},X5.prototype.getClass=function(){return X5},X5.getNodedSubstrings=function(){if(1===arguments.length){var t=arguments[0],e=new q1;return X5.getNodedSubstrings(t,e),e}if(2===arguments.length)for(var n=arguments[1],r=arguments[0].iterator();r.hasNext();)r.next().getNodeList().addSplitEdges(n)};var Z5=function(){if(this.p0=null,this.p1=null,0===arguments.length)this.p0=new W0,this.p1=new W0;else if(1===arguments.length){var t=arguments[0];this.p0=new W0(t.p0),this.p1=new W0(t.p1)}else if(2===arguments.length)this.p0=arguments[0],this.p1=arguments[1];else if(4===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2],i=arguments[3];this.p0=new W0(e,n),this.p1=new W0(r,i)}},Y5={serialVersionUID:{configurable:!0}};Z5.prototype.minX=function(){return Math.min(this.p0.x,this.p1.x)},Z5.prototype.orientationIndex=function(){if(arguments[0]instanceof Z5){var t=arguments[0],e=I1.orientationIndex(this.p0,this.p1,t.p0),n=I1.orientationIndex(this.p0,this.p1,t.p1);return e>=0&&n>=0||e<=0&&n<=0?Math.max(e,n):0}if(arguments[0]instanceof W0){var r=arguments[0];return I1.orientationIndex(this.p0,this.p1,r)}},Z5.prototype.toGeometry=function(t){return t.createLineString([this.p0,this.p1])},Z5.prototype.isVertical=function(){return this.p0.x===this.p1.x},Z5.prototype.equals=function(t){if(!(t instanceof Z5))return!1;var e=t;return this.p0.equals(e.p0)&&this.p1.equals(e.p1)},Z5.prototype.intersection=function(t){var e=new M1;return e.computeIntersection(this.p0,this.p1,t.p0,t.p1),e.hasIntersection()?e.getIntersection(0):null},Z5.prototype.project=function(){if(arguments[0]instanceof W0){var t=arguments[0];if(t.equals(this.p0)||t.equals(this.p1))return new W0(t);var e=this.projectionFactor(t),n=new W0;return n.x=this.p0.x+e*(this.p1.x-this.p0.x),n.y=this.p0.y+e*(this.p1.y-this.p0.y),n}if(arguments[0]instanceof Z5){var r=arguments[0],i=this.projectionFactor(r.p0),o=this.projectionFactor(r.p1);if(i>=1&&o>=1)return null;if(i<=0&&o<=0)return null;var s=this.project(r.p0);i<0&&(s=this.p0),i>1&&(s=this.p1);var a=this.project(r.p1);return o<0&&(a=this.p0),o>1&&(a=this.p1),new Z5(s,a)}},Z5.prototype.normalize=function(){this.p1.compareTo(this.p0)<0&&this.reverse()},Z5.prototype.angle=function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)},Z5.prototype.getCoordinate=function(t){return 0===t?this.p0:this.p1},Z5.prototype.distancePerpendicular=function(t){return I1.distancePointLinePerpendicular(t,this.p0,this.p1)},Z5.prototype.minY=function(){return Math.min(this.p0.y,this.p1.y)},Z5.prototype.midPoint=function(){return Z5.midPoint(this.p0,this.p1)},Z5.prototype.projectionFactor=function(t){if(t.equals(this.p0))return 0;if(t.equals(this.p1))return 1;var e=this.p1.x-this.p0.x,n=this.p1.y-this.p0.y,r=e*e+n*n;return r<=0?B0.NaN:((t.x-this.p0.x)*e+(t.y-this.p0.y)*n)/r},Z5.prototype.closestPoints=function(t){var e=this.intersection(t);if(null!==e)return[e,e];var n=new Array(2).fill(null),r=B0.MAX_VALUE,i=null,o=this.closestPoint(t.p0);r=o.distance(t.p0),n[0]=o,n[1]=t.p0;var s=this.closestPoint(t.p1);(i=s.distance(t.p1))<r&&(r=i,n[0]=s,n[1]=t.p1);var a=t.closestPoint(this.p0);(i=a.distance(this.p0))<r&&(r=i,n[0]=this.p0,n[1]=a);var l=t.closestPoint(this.p1);return(i=l.distance(this.p1))<r&&(r=i,n[0]=this.p1,n[1]=l),n},Z5.prototype.closestPoint=function(t){var e=this.projectionFactor(t);return e>0&&e<1?this.project(t):this.p0.distance(t)<this.p1.distance(t)?this.p0:this.p1},Z5.prototype.maxX=function(){return Math.max(this.p0.x,this.p1.x)},Z5.prototype.getLength=function(){return this.p0.distance(this.p1)},Z5.prototype.compareTo=function(t){var e=t,n=this.p0.compareTo(e.p0);return 0!==n?n:this.p1.compareTo(e.p1)},Z5.prototype.reverse=function(){var t=this.p0;this.p0=this.p1,this.p1=t},Z5.prototype.equalsTopo=function(t){return this.p0.equals(t.p0)&&(this.p1.equals(t.p1)||this.p0.equals(t.p1))&&this.p1.equals(t.p0)},Z5.prototype.lineIntersection=function(t){try{return f1.intersection(this.p0,this.p1,t.p0,t.p1)}catch(e){if(!(e instanceof u1))throw e}return null},Z5.prototype.maxY=function(){return Math.max(this.p0.y,this.p1.y)},Z5.prototype.pointAlongOffset=function(t,e){var n=this.p0.x+t*(this.p1.x-this.p0.x),r=this.p0.y+t*(this.p1.y-this.p0.y),i=this.p1.x-this.p0.x,o=this.p1.y-this.p0.y,s=Math.sqrt(i*i+o*o),a=0,l=0;if(0!==e){if(s<=0)throw new Error("Cannot compute offset from zero-length line segment");a=e*i/s,l=e*o/s}return new W0(n-l,r+a)},Z5.prototype.setCoordinates=function(){if(1===arguments.length){var t=arguments[0];this.setCoordinates(t.p0,t.p1)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.p0.x=e.x,this.p0.y=e.y,this.p1.x=n.x,this.p1.y=n.y}},Z5.prototype.segmentFraction=function(t){var e=this.projectionFactor(t);return e<0?e=0:(e>1||B0.isNaN(e))&&(e=1),e},Z5.prototype.toString=function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"},Z5.prototype.isHorizontal=function(){return this.p0.y===this.p1.y},Z5.prototype.distance=function(){if(arguments[0]instanceof Z5){var t=arguments[0];return I1.distanceLineLine(this.p0,this.p1,t.p0,t.p1)}if(arguments[0]instanceof W0){var e=arguments[0];return I1.distancePointLine(e,this.p0,this.p1)}},Z5.prototype.pointAlong=function(t){var e=new W0;return e.x=this.p0.x+t*(this.p1.x-this.p0.x),e.y=this.p0.y+t*(this.p1.y-this.p0.y),e},Z5.prototype.hashCode=function(){var t=B0.doubleToLongBits(this.p0.x);t^=31*B0.doubleToLongBits(this.p0.y);var e=Math.trunc(t)^Math.trunc(t>>32),n=B0.doubleToLongBits(this.p1.x);return n^=31*B0.doubleToLongBits(this.p1.y),e^Math.trunc(n)^Math.trunc(n>>32)},Z5.prototype.interfaces_=function(){return[j0,G0]},Z5.prototype.getClass=function(){return Z5},Z5.midPoint=function(t,e){return new W0((t.x+e.x)/2,(t.y+e.y)/2)},Y5.serialVersionUID.get=function(){return 0x2d2172135f411c00},Object.defineProperties(Z5,Y5);var J5=function(){this.tempEnv1=new d1,this.tempEnv2=new d1,this.Pi=new Z5,this.gi=new Z5};J5.prototype.overlap=function(){if(2===arguments.length);else if(4===arguments.length){var t=arguments[1],e=arguments[2],n=arguments[3];arguments[0].getLineSegment(t,this.Pi),e.getLineSegment(n,this.gi),this.overlap(this.Pi,this.gi)}},J5.prototype.interfaces_=function(){return[]},J5.prototype.getClass=function(){return J5};var Q5=function(){this.dn=null,this.Ci=null,this.Di=null,this.In=null,this.Ii=null,this.bi=null;var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.dn=t,this.Ci=e,this.Di=n,this.Ii=r};Q5.prototype.getLineSegment=function(t,e){e.p0=this.dn[t],e.p1=this.dn[t+1]},Q5.prototype.computeSelect=function(t,e,n,r){var i=this.dn[e],o=this.dn[n];if(r.tempEnv1.init(i,o),n-e==1)return r.select(this,e),null;if(!t.intersects(r.tempEnv1))return null;var s=Math.trunc((e+n)/2);e<s&&this.computeSelect(t,e,s,r),s<n&&this.computeSelect(t,s,n,r)},Q5.prototype.getCoordinates=function(){for(var t=new Array(this.Di-this.Ci+1).fill(null),e=0,n=this.Ci;n<=this.Di;n++)t[e++]=this.dn[n];return t},Q5.prototype.computeOverlaps=function(t,e){this.computeOverlapsInternal(this.Ci,this.Di,t,t.Ci,t.Di,e)},Q5.prototype.setId=function(t){this.bi=t},Q5.prototype.select=function(t,e){this.computeSelect(t,this.Ci,this.Di,e)},Q5.prototype.getEnvelope=function(){if(null===this.In){var t=this.dn[this.Ci],e=this.dn[this.Di];this.In=new d1(t,e)}return this.In},Q5.prototype.getEndIndex=function(){return this.Di},Q5.prototype.getStartIndex=function(){return this.Ci},Q5.prototype.getContext=function(){return this.Ii},Q5.prototype.getId=function(){return this.bi},Q5.prototype.computeOverlapsInternal=function(t,e,n,r,i,o){var s=this.dn[t],a=this.dn[e],l=n.dn[r],h=n.dn[i];if(e-t==1&&i-r==1)return o.overlap(this,t,n,r),null;if(o.tempEnv1.init(s,a),o.tempEnv2.init(l,h),!o.tempEnv1.intersects(o.tempEnv2))return null;var u=Math.trunc((t+e)/2),c=Math.trunc((r+i)/2);t<u&&(r<c&&this.computeOverlapsInternal(t,u,n,r,c,o),c<i&&this.computeOverlapsInternal(t,u,n,c,i,o)),u<e&&(r<c&&this.computeOverlapsInternal(u,e,n,r,c,o),c<i&&this.computeOverlapsInternal(u,e,n,c,i,o))},Q5.prototype.interfaces_=function(){return[]},Q5.prototype.getClass=function(){return Q5};var K5=function(){};K5.prototype.interfaces_=function(){return[]},K5.prototype.getClass=function(){return K5},K5.getChainStartIndices=function(t){var e=0,n=new q1;n.add(new e1(e));do{var r=K5.findChainEnd(t,e);n.add(new e1(r)),e=r}while(e<t.length-1);return K5.toIntArray(n)},K5.findChainEnd=function(t,e){for(var n=e;n<t.length-1&&t[n].equals2D(t[n+1]);)n++;if(n>=t.length-1)return t.length-1;for(var r=v5.quadrant(t[n],t[n+1]),i=e+1;i<t.length&&(t[i-1].equals2D(t[i])||v5.quadrant(t[i-1],t[i])===r);)i++;return i-1},K5.getChains=function(){if(1===arguments.length)return K5.getChains(arguments[0],null);if(2===arguments.length){for(var t=arguments[0],e=arguments[1],n=new q1,r=K5.getChainStartIndices(t),i=0;i<r.length-1;i++){var o=new Q5(t,r[i],r[i+1],e);n.add(o)}return n}},K5.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var $5=function(){};$5.prototype.computeNodes=function(t){},$5.prototype.getNodedSubstrings=function(){},$5.prototype.interfaces_=function(){return[]},$5.prototype.getClass=function(){return $5};var t3=function(){if(this.Mi=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.setSegmentIntersector(t)}};t3.prototype.setSegmentIntersector=function(t){this.Mi=t},t3.prototype.interfaces_=function(){return[$5]},t3.prototype.getClass=function(){return t3};var e3=function(t){function e(e){e?t.call(this,e):t.call(this),this.zi=new q1,this.di=new B5,this.xi=0,this.mi=null,this.yi=0}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={SegmentOverlapAction:{configurable:!0}};return e.prototype.getMonotoneChains=function(){return this.zi},e.prototype.getNodedSubstrings=function(){return X5.getNodedSubstrings(this.mi)},e.prototype.getIndex=function(){return this.di},e.prototype.add=function(t){for(var e=this,n=K5.getChains(t.getCoordinates(),t).iterator();n.hasNext();){var r=n.next();r.setId(e.xi++),e.di.insert(r.getEnvelope(),r),e.zi.add(r)}},e.prototype.computeNodes=function(t){this.mi=t;for(var e=t.iterator();e.hasNext();)this.add(e.next());this.intersectChains()},e.prototype.intersectChains=function(){for(var t=this,e=new n3(this.Mi),n=this.zi.iterator();n.hasNext();)for(var r=n.next(),i=t.di.query(r.getEnvelope()).iterator();i.hasNext();){var o=i.next();if(o.getId()>r.getId()&&(r.computeOverlaps(o,e),t.yi++),t.Mi.isDone())return null}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.SegmentOverlapAction.get=function(){return n3},Object.defineProperties(e,n),e}(t3),n3=function(t){function e(){t.call(this),this.pi=null;var e=arguments[0];this.pi=e}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.overlap=function(){if(4!==arguments.length)return t.prototype.overlap.apply(this,arguments);var e=arguments[1],n=arguments[2],r=arguments[3],i=arguments[0].getContext(),o=n.getContext();this.pi.processIntersections(i,e,o,r)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(J5),r3=function t(){if(this.Li=t.DEFAULT_QUADRANT_SEGMENTS,this.Ti=t.CAP_ROUND,this.Oi=t.JOIN_ROUND,this.Fi=t.DEFAULT_MITRE_LIMIT,this.Ui=!1,this.Ei=t.DEFAULT_SIMPLIFY_FACTOR,0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.setQuadrantSegments(e)}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.setQuadrantSegments(n),this.setEndCapStyle(r)}else if(4===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];this.setQuadrantSegments(i),this.setEndCapStyle(o),this.setJoinStyle(s),this.setMitreLimit(a)}},i3={CAP_ROUND:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},JOIN_ROUND:{configurable:!0},JOIN_MITRE:{configurable:!0},JOIN_BEVEL:{configurable:!0},DEFAULT_QUADRANT_SEGMENTS:{configurable:!0},DEFAULT_MITRE_LIMIT:{configurable:!0},DEFAULT_SIMPLIFY_FACTOR:{configurable:!0}};r3.prototype.getEndCapStyle=function(){return this.Ti},r3.prototype.isSingleSided=function(){return this.Ui},r3.prototype.setQuadrantSegments=function(t){this.Li=t,0===this.Li&&(this.Oi=r3.JOIN_BEVEL),this.Li<0&&(this.Oi=r3.JOIN_MITRE,this.Fi=Math.abs(this.Li)),t<=0&&(this.Li=1),this.Oi!==r3.JOIN_ROUND&&(this.Li=r3.DEFAULT_QUADRANT_SEGMENTS)},r3.prototype.getJoinStyle=function(){return this.Oi},r3.prototype.setJoinStyle=function(t){this.Oi=t},r3.prototype.setSimplifyFactor=function(t){this.Ei=t<0?0:t},r3.prototype.getSimplifyFactor=function(){return this.Ei},r3.prototype.getQuadrantSegments=function(){return this.Li},r3.prototype.setEndCapStyle=function(t){this.Ti=t},r3.prototype.getMitreLimit=function(){return this.Fi},r3.prototype.setMitreLimit=function(t){this.Fi=t},r3.prototype.setSingleSided=function(t){this.Ui=t},r3.prototype.interfaces_=function(){return[]},r3.prototype.getClass=function(){return r3},r3.bufferDistanceError=function(t){var e=Math.PI/2/t;return 1-Math.cos(e/2)},i3.CAP_ROUND.get=function(){return 1},i3.CAP_FLAT.get=function(){return 2},i3.CAP_SQUARE.get=function(){return 3},i3.JOIN_ROUND.get=function(){return 1},i3.JOIN_MITRE.get=function(){return 2},i3.JOIN_BEVEL.get=function(){return 3},i3.DEFAULT_QUADRANT_SEGMENTS.get=function(){return 8},i3.DEFAULT_MITRE_LIMIT.get=function(){return 5},i3.DEFAULT_SIMPLIFY_FACTOR.get=function(){return.01},Object.defineProperties(r3,i3);var o3=function(t){this.Ni=null,this.ji=null,this.Qi=I1.COUNTERCLOCKWISE,this.Si=t||null},s3={INIT:{configurable:!0},DELETE:{configurable:!0},KEEP:{configurable:!0},NUM_PTS_TO_CHECK:{configurable:!0}};o3.prototype.isDeletable=function(t,e,n,r){var i=this.Si[t],o=this.Si[e],s=this.Si[n];return!!this.isConcave(i,o,s)&&!!this.isShallow(i,o,s,r)&&this.isShallowSampled(i,o,t,n,r)},o3.prototype.deleteShallowConcavities=function(){for(var t=this,e=1,n=this.findNextNonDeletedIndex(e),r=this.findNextNonDeletedIndex(n),i=!1;r<this.Si.length;){var o=!1;t.isDeletable(e,n,r,t.Ni)&&(t.ji[n]=o3.DELETE,o=!0,i=!0),e=o?r:n,n=t.findNextNonDeletedIndex(e),r=t.findNextNonDeletedIndex(n)}return i},o3.prototype.isShallowConcavity=function(t,e,n,r){return I1.computeOrientation(t,e,n)===this.Qi&&I1.distancePointLine(e,t,n)<r},o3.prototype.isShallowSampled=function(t,e,n,r,i){var o=Math.trunc((r-n)/o3.NUM_PTS_TO_CHECK);o<=0&&(o=1);for(var s=n;s<r;s+=o)if(!this.isShallow(t,e,this.Si[s],i))return!1;return!0},o3.prototype.isConcave=function(t,e,n){return I1.computeOrientation(t,e,n)===this.Qi},o3.prototype.simplify=function(t){this.Ni=Math.abs(t),t<0&&(this.Qi=I1.CLOCKWISE),this.ji=new Array(this.Si.length).fill(null);var e=!1;do{e=this.deleteShallowConcavities()}while(e);return this.collapseLine()},o3.prototype.findNextNonDeletedIndex=function(t){for(var e=t+1;e<this.Si.length&&this.ji[e]===o3.DELETE;)e++;return e},o3.prototype.isShallow=function(t,e,n,r){return I1.distancePointLine(e,t,n)<r},o3.prototype.collapseLine=function(){for(var t=new Z1,e=0;e<this.Si.length;e++)this.ji[e]!==o3.DELETE&&t.add(this.Si[e]);return t.toCoordinateArray()},o3.prototype.interfaces_=function(){return[]},o3.prototype.getClass=function(){return o3},o3.simplify=function(t,e){return new o3(t).simplify(e)},s3.INIT.get=function(){return 0},s3.DELETE.get=function(){return 1},s3.KEEP.get=function(){return 1},s3.NUM_PTS_TO_CHECK.get=function(){return 10},Object.defineProperties(o3,s3);var a3=function(){this.Bi=null,this.Wt=null,this.ki=0,this.Bi=new q1},l3={COORDINATE_ARRAY_TYPE:{configurable:!0}};a3.prototype.getCoordinates=function(){return this.Bi.toArray(a3.COORDINATE_ARRAY_TYPE)},a3.prototype.setPrecisionModel=function(t){this.Wt=t},a3.prototype.addPt=function(t){var e=new W0(t);if(this.Wt.makePrecise(e),this.isRedundant(e))return null;this.Bi.add(e)},a3.prototype.revere=function(){},a3.prototype.addPts=function(t,e){if(e)for(var n=0;n<t.length;n++)this.addPt(t[n]);else for(var r=t.length-1;r>=0;r--)this.addPt(t[r])},a3.prototype.isRedundant=function(t){if(this.Bi.size()<1)return!1;var e=this.Bi.get(this.Bi.size()-1);return t.distance(e)<this.ki},a3.prototype.toString=function(){return(new e5).createLineString(this.getCoordinates()).toString()},a3.prototype.closeRing=function(){if(this.Bi.size()<1)return null;var t=new W0(this.Bi.get(0)),e=this.Bi.get(this.Bi.size()-1);if(t.equals(e))return null;this.Bi.add(t)},a3.prototype.setMinimumVertexDistance=function(t){this.ki=t},a3.prototype.interfaces_=function(){return[]},a3.prototype.getClass=function(){return a3},l3.COORDINATE_ARRAY_TYPE.get=function(){return new Array(0).fill(null)},Object.defineProperties(a3,l3);var h3=function(){},u3={PI_TIMES_2:{configurable:!0},PI_OVER_2:{configurable:!0},PI_OVER_4:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},CLOCKWISE:{configurable:!0},NONE:{configurable:!0}};h3.prototype.interfaces_=function(){return[]},h3.prototype.getClass=function(){return h3},h3.toDegrees=function(t){return 180*t/Math.PI},h3.normalize=function(t){for(;t>Math.PI;)t-=h3.PI_TIMES_2;for(;t<=-Math.PI;)t+=h3.PI_TIMES_2;return t},h3.angle=function(){if(1===arguments.length){var t=arguments[0];return Math.atan2(t.y,t.x)}if(2===arguments.length){var e=arguments[0],n=arguments[1],r=n.x-e.x,i=n.y-e.y;return Math.atan2(i,r)}},h3.isAcute=function(t,e,n){var r=t.x-e.x,i=t.y-e.y;return r*(n.x-e.x)+i*(n.y-e.y)>0},h3.isObtuse=function(t,e,n){var r=t.x-e.x,i=t.y-e.y;return r*(n.x-e.x)+i*(n.y-e.y)<0},h3.interiorAngle=function(t,e,n){var r=h3.angle(e,t),i=h3.angle(e,n);return Math.abs(i-r)},h3.normalizePositive=function(t){if(t<0){for(;t<0;)t+=h3.PI_TIMES_2;t>=h3.PI_TIMES_2&&(t=0)}else{for(;t>=h3.PI_TIMES_2;)t-=h3.PI_TIMES_2;t<0&&(t=0)}return t},h3.angleBetween=function(t,e,n){var r=h3.angle(e,t),i=h3.angle(e,n);return h3.diff(r,i)},h3.diff=function(t,e){var n=null;return(n=t<e?e-t:t-e)>Math.PI&&(n=2*Math.PI-n),n},h3.toRadians=function(t){return t*Math.PI/180},h3.getTurn=function(t,e){var n=Math.sin(e-t);return n>0?h3.COUNTERCLOCKWISE:n<0?h3.CLOCKWISE:h3.NONE},h3.angleBetweenOriented=function(t,e,n){var r=h3.angle(e,t),i=h3.angle(e,n)-r;return i<=-Math.PI?i+h3.PI_TIMES_2:i>Math.PI?i-h3.PI_TIMES_2:i},u3.PI_TIMES_2.get=function(){return 2*Math.PI},u3.PI_OVER_2.get=function(){return Math.PI/2},u3.PI_OVER_4.get=function(){return Math.PI/4},u3.COUNTERCLOCKWISE.get=function(){return I1.COUNTERCLOCKWISE},u3.CLOCKWISE.get=function(){return I1.CLOCKWISE},u3.NONE.get=function(){return I1.COLLINEAR},Object.defineProperties(h3,u3);var c3=function t(){this.Ri=0,this.Gi=null,this.Yi=1,this.qi=null,this.ri=0,this.Wt=null,this.Vi=null,this.Wi=null,this._i=null,this.Ki=null,this.Hi=null,this.Ji=new Z5,this.Zi=new Z5,this.Xi=new Z5,this.$i=new Z5,this.Ar=0,this.tr=!1;var e=arguments[0],n=arguments[1],r=arguments[2];this.Wt=e,this.Vi=n,this.Wi=new M1,this.Gi=Math.PI/2/n.getQuadrantSegments(),n.getQuadrantSegments()>=8&&n.getJoinStyle()===r3.JOIN_ROUND&&(this.Yi=t.MAX_CLOSING_SEG_LEN_FACTOR),this.init(r)},f3={OFFSET_SEGMENT_SEPARATION_FACTOR:{configurable:!0},INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},CURVE_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},MAX_CLOSING_SEG_LEN_FACTOR:{configurable:!0}};c3.prototype.addNextSegment=function(t,e){if(this._i=this.Ki,this.Ki=this.Hi,this.Hi=t,this.Ji.setCoordinates(this._i,this.Ki),this.computeOffsetSegment(this.Ji,this.Ar,this.ri,this.Xi),this.Zi.setCoordinates(this.Ki,this.Hi),this.computeOffsetSegment(this.Zi,this.Ar,this.ri,this.$i),this.Ki.equals(this.Hi))return null;var n=I1.computeOrientation(this._i,this.Ki,this.Hi),r=n===I1.CLOCKWISE&&this.Ar===r5.LEFT||n===I1.COUNTERCLOCKWISE&&this.Ar===r5.RIGHT;0===n?this.addCollinear(e):r?this.addOutsideTurn(n,e):this.addInsideTurn(n,e)},c3.prototype.addLineEndCap=function(t,e){var n=new Z5(t,e),r=new Z5;this.computeOffsetSegment(n,r5.LEFT,this.ri,r);var i=new Z5;this.computeOffsetSegment(n,r5.RIGHT,this.ri,i);var o=e.x-t.x,s=e.y-t.y,a=Math.atan2(s,o);switch(this.Vi.getEndCapStyle()){case r3.CAP_ROUND:this.qi.addPt(r.p1),this.addFilletArc(e,a+Math.PI/2,a-Math.PI/2,I1.CLOCKWISE,this.ri),this.qi.addPt(i.p1);break;case r3.CAP_FLAT:this.qi.addPt(r.p1),this.qi.addPt(i.p1);break;case r3.CAP_SQUARE:var l=new W0;l.x=Math.abs(this.ri)*Math.cos(a),l.y=Math.abs(this.ri)*Math.sin(a);var h=new W0(r.p1.x+l.x,r.p1.y+l.y),u=new W0(i.p1.x+l.x,i.p1.y+l.y);this.qi.addPt(h),this.qi.addPt(u)}},c3.prototype.getCoordinates=function(){return this.qi.getCoordinates()},c3.prototype.addMitreJoin=function(t,e,n,r){var i=!0,o=null;try{o=f1.intersection(e.p0,e.p1,n.p0,n.p1),(r<=0?1:o.distance(t)/Math.abs(r))>this.Vi.getMitreLimit()&&(i=!1)}catch(s){if(!(s instanceof u1))throw s;o=new W0(0,0),i=!1}i?this.qi.addPt(o):this.addLimitedMitreJoin(e,n,r,this.Vi.getMitreLimit())},c3.prototype.addFilletCorner=function(t,e,n,r,i){var o=e.x-t.x,s=e.y-t.y,a=Math.atan2(s,o),l=n.x-t.x,h=n.y-t.y,u=Math.atan2(h,l);r===I1.CLOCKWISE?a<=u&&(a+=2*Math.PI):a>=u&&(a-=2*Math.PI),this.qi.addPt(e),this.addFilletArc(t,a,u,r,i),this.qi.addPt(n)},c3.prototype.addOutsideTurn=function(t,e){if(this.Xi.p1.distance(this.$i.p0)<this.ri*c3.OFFSET_SEGMENT_SEPARATION_FACTOR)return this.qi.addPt(this.Xi.p1),null;this.Vi.getJoinStyle()===r3.JOIN_MITRE?this.addMitreJoin(this.Ki,this.Xi,this.$i,this.ri):this.Vi.getJoinStyle()===r3.JOIN_BEVEL?this.addBevelJoin(this.Xi,this.$i):(e&&this.qi.addPt(this.Xi.p1),this.addFilletCorner(this.Ki,this.Xi.p1,this.$i.p0,t,this.ri),this.qi.addPt(this.$i.p0))},c3.prototype.createSquare=function(t){this.qi.addPt(new W0(t.x+this.ri,t.y+this.ri)),this.qi.addPt(new W0(t.x+this.ri,t.y-this.ri)),this.qi.addPt(new W0(t.x-this.ri,t.y-this.ri)),this.qi.addPt(new W0(t.x-this.ri,t.y+this.ri)),this.qi.closeRing()},c3.prototype.addSegments=function(t,e){this.qi.addPts(t,e)},c3.prototype.addFirstSegment=function(){this.qi.addPt(this.$i.p0)},c3.prototype.addLastSegment=function(){this.qi.addPt(this.$i.p1)},c3.prototype.initSideSegments=function(t,e,n){this.Ki=t,this.Hi=e,this.Ar=n,this.Zi.setCoordinates(t,e),this.computeOffsetSegment(this.Zi,n,this.ri,this.$i)},c3.prototype.addLimitedMitreJoin=function(t,e,n,r){var i=this.Ji.p1,o=h3.angle(i,this.Ji.p0),s=h3.angleBetweenOriented(this.Ji.p0,i,this.Zi.p1)/2,a=h3.normalize(o+s),l=h3.normalize(a+Math.PI),h=r*n,u=n-h*Math.abs(Math.sin(s)),c=i.x+h*Math.cos(l),f=i.y+h*Math.sin(l),d=new W0(c,f),p=new Z5(i,d),g=p.pointAlongOffset(1,u),m=p.pointAlongOffset(1,-u);this.Ar===r5.LEFT?(this.qi.addPt(g),this.qi.addPt(m)):(this.qi.addPt(m),this.qi.addPt(g))},c3.prototype.computeOffsetSegment=function(t,e,n,r){var i=e===r5.LEFT?1:-1,o=t.p1.x-t.p0.x,s=t.p1.y-t.p0.y,a=Math.sqrt(o*o+s*s),l=i*n*o/a,h=i*n*s/a;r.p0.x=t.p0.x-h,r.p0.y=t.p0.y+l,r.p1.x=t.p1.x-h,r.p1.y=t.p1.y+l},c3.prototype.addFilletArc=function(t,e,n,r,i){var o=r===I1.CLOCKWISE?-1:1,s=Math.abs(e-n),a=Math.trunc(s/this.Gi+.5);if(a<1)return null;for(var l=s/a,h=0,u=new W0;h<s;){var c=e+o*h;u.x=t.x+i*Math.cos(c),u.y=t.y+i*Math.sin(c),this.qi.addPt(u),h+=l}},c3.prototype.addInsideTurn=function(t,e){if(this.Wi.computeIntersection(this.Xi.p0,this.Xi.p1,this.$i.p0,this.$i.p1),this.Wi.hasIntersection())this.qi.addPt(this.Wi.getIntersection(0));else if(this.tr=!0,this.Xi.p1.distance(this.$i.p0)<this.ri*c3.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this.qi.addPt(this.Xi.p1);else{if(this.qi.addPt(this.Xi.p1),this.Yi>0){var n=new W0((this.Yi*this.Xi.p1.x+this.Ki.x)/(this.Yi+1),(this.Yi*this.Xi.p1.y+this.Ki.y)/(this.Yi+1));this.qi.addPt(n);var r=new W0((this.Yi*this.$i.p0.x+this.Ki.x)/(this.Yi+1),(this.Yi*this.$i.p0.y+this.Ki.y)/(this.Yi+1));this.qi.addPt(r)}else this.qi.addPt(this.Ki);this.qi.addPt(this.$i.p0)}},c3.prototype.createCircle=function(t){var e=new W0(t.x+this.ri,t.y);this.qi.addPt(e),this.addFilletArc(t,0,2*Math.PI,-1,this.ri),this.qi.closeRing()},c3.prototype.addBevelJoin=function(t,e){this.qi.addPt(t.p1),this.qi.addPt(e.p0)},c3.prototype.init=function(t){this.ri=t,this.Ri=t*(1-Math.cos(this.Gi/2)),this.qi=new a3,this.qi.setPrecisionModel(this.Wt),this.qi.setMinimumVertexDistance(t*c3.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)},c3.prototype.addCollinear=function(t){this.Wi.computeIntersection(this._i,this.Ki,this.Ki,this.Hi),this.Wi.getIntersectionNum()>=2&&(this.Vi.getJoinStyle()===r3.JOIN_BEVEL||this.Vi.getJoinStyle()===r3.JOIN_MITRE?(t&&this.qi.addPt(this.Xi.p1),this.qi.addPt(this.$i.p0)):this.addFilletCorner(this.Ki,this.Xi.p1,this.$i.p0,I1.CLOCKWISE,this.ri))},c3.prototype.closeRing=function(){this.qi.closeRing()},c3.prototype.hasNarrowConcaveAngle=function(){return this.tr},c3.prototype.interfaces_=function(){return[]},c3.prototype.getClass=function(){return c3},f3.OFFSET_SEGMENT_SEPARATION_FACTOR.get=function(){return.001},f3.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return.001},f3.CURVE_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return 1e-6},f3.MAX_CLOSING_SEG_LEN_FACTOR.get=function(){return 80},Object.defineProperties(c3,f3);var d3=function(){this.ri=0,this.Wt=null,this.Vi=null;var t=arguments[0],e=arguments[1];this.Wt=t,this.Vi=e};d3.prototype.getOffsetCurve=function(t,e){if(this.ri=e,0===e)return null;var n=e<0,r=Math.abs(e),i=this.getSegGen(r);t.length<=1?this.computePointCurve(t[0],i):this.computeOffsetCurve(t,n,i);var o=i.getCoordinates();return n&&Y1.reverse(o),o},d3.prototype.computeSingleSidedBufferCurve=function(t,e,n){var r=this.simplifyTolerance(this.ri);if(e){n.addSegments(t,!0);var i=o3.simplify(t,-r),o=i.length-1;n.initSideSegments(i[o],i[o-1],r5.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(i[s],!0)}else{n.addSegments(t,!1);var a=o3.simplify(t,r),l=a.length-1;n.initSideSegments(a[0],a[1],r5.LEFT),n.addFirstSegment();for(var h=2;h<=l;h++)n.addNextSegment(a[h],!0)}n.addLastSegment(),n.closeRing()},d3.prototype.computeRingBufferCurve=function(t,e,n){var r=this.simplifyTolerance(this.ri);e===r5.RIGHT&&(r=-r);var i=o3.simplify(t,r),o=i.length-1;n.initSideSegments(i[o-1],i[0],e);for(var s=1;s<=o;s++){var a=1!==s;n.addNextSegment(i[s],a)}n.closeRing()},d3.prototype.computeLineBufferCurve=function(t,e){var n=this.simplifyTolerance(this.ri),r=o3.simplify(t,n),i=r.length-1;e.initSideSegments(r[0],r[1],r5.LEFT);for(var o=2;o<=i;o++)e.addNextSegment(r[o],!0);e.addLastSegment(),e.addLineEndCap(r[i-1],r[i]);var s=o3.simplify(t,-n),a=s.length-1;e.initSideSegments(s[a],s[a-1],r5.LEFT);for(var l=a-2;l>=0;l--)e.addNextSegment(s[l],!0);e.addLastSegment(),e.addLineEndCap(s[1],s[0]),e.closeRing()},d3.prototype.computePointCurve=function(t,e){switch(this.Vi.getEndCapStyle()){case r3.CAP_ROUND:e.createCircle(t);break;case r3.CAP_SQUARE:e.createSquare(t)}},d3.prototype.getLineCurve=function(t,e){if(this.ri=e,e<0&&!this.Vi.isSingleSided())return null;if(0===e)return null;var n=Math.abs(e),r=this.getSegGen(n);if(t.length<=1)this.computePointCurve(t[0],r);else if(this.Vi.isSingleSided()){var i=e<0;this.computeSingleSidedBufferCurve(t,i,r)}else this.computeLineBufferCurve(t,r);return r.getCoordinates()},d3.prototype.getBufferParameters=function(){return this.Vi},d3.prototype.simplifyTolerance=function(t){return t*this.Vi.getSimplifyFactor()},d3.prototype.getRingCurve=function(t,e,n){if(this.ri=n,t.length<=2)return this.getLineCurve(t,n);if(0===n)return d3.copyCoordinates(t);var r=this.getSegGen(n);return this.computeRingBufferCurve(t,e,r),r.getCoordinates()},d3.prototype.computeOffsetCurve=function(t,e,n){var r=this.simplifyTolerance(this.ri);if(e){var i=o3.simplify(t,-r),o=i.length-1;n.initSideSegments(i[o],i[o-1],r5.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(i[s],!0)}else{var a=o3.simplify(t,r),l=a.length-1;n.initSideSegments(a[0],a[1],r5.LEFT),n.addFirstSegment();for(var h=2;h<=l;h++)n.addNextSegment(a[h],!0)}n.addLastSegment()},d3.prototype.getSegGen=function(t){return new c3(this.Wt,this.Vi,t)},d3.prototype.interfaces_=function(){return[]},d3.prototype.getClass=function(){return d3},d3.copyCoordinates=function(t){for(var e=new Array(t.length).fill(null),n=0;n<e.length;n++)e[n]=new W0(t[n]);return e};var p3=function(){this.nr=null,this.ir=new Z5,this.rr=new I1;var t=arguments[0];this.nr=t},g3={DepthSegment:{configurable:!0}};p3.prototype.findStabbedSegments=function(){var t=this;if(1===arguments.length){for(var e=arguments[0],n=new q1,r=this.nr.iterator();r.hasNext();){var i=r.next(),o=i.getEnvelope();e.y<o.getMinY()||e.y>o.getMaxY()||t.findStabbedSegments(e,i.getDirectedEdges(),n)}return n}if(3===arguments.length)if(Q0(arguments[2],G1)&&arguments[0]instanceof W0&&arguments[1]instanceof b5){for(var s=arguments[0],a=arguments[1],l=arguments[2],h=a.getEdge().getCoordinates(),u=0;u<h.length-1;u++)if(t.ir.p0=h[u],t.ir.p1=h[u+1],t.ir.p0.y>t.ir.p1.y&&t.ir.reverse(),!(Math.max(t.ir.p0.x,t.ir.p1.x)<s.x||t.ir.isHorizontal()||s.y<t.ir.p0.y||s.y>t.ir.p1.y||I1.computeOrientation(t.ir.p0,t.ir.p1,s)===I1.RIGHT)){var c=a.getDepth(r5.LEFT);t.ir.p0.equals(h[u])||(c=a.getDepth(r5.RIGHT));var f=new m3(t.ir,c);l.add(f)}}else if(Q0(arguments[2],G1)&&arguments[0]instanceof W0&&Q0(arguments[1],G1))for(var d=arguments[0],p=arguments[2],g=arguments[1].iterator();g.hasNext();){var m=g.next();m.isForward()&&t.findStabbedSegments(d,m,p)}},p3.prototype.getDepth=function(t){var e=this.findStabbedSegments(t);return 0===e.size()?0:k5.min(e).er},p3.prototype.interfaces_=function(){return[]},p3.prototype.getClass=function(){return p3},g3.DepthSegment.get=function(){return m3},Object.defineProperties(p3,g3);var m3=function(){this.sr=null,this.er=null;var t=arguments[0],e=arguments[1];this.sr=new Z5(t),this.er=e};m3.prototype.compareTo=function(t){var e=t;if(this.sr.minX()>=e.sr.maxX())return 1;if(this.sr.maxX()<=e.sr.minX())return-1;var n=this.sr.orientationIndex(e.sr);return 0!==n||0!=(n=-1*e.sr.orientationIndex(this.sr))?n:this.sr.compareTo(e.sr)},m3.prototype.compareX=function(t,e){var n=t.p0.compareTo(e.p0);return 0!==n?n:t.p1.compareTo(e.p1)},m3.prototype.toString=function(){return this.sr.toString()},m3.prototype.interfaces_=function(){return[j0]},m3.prototype.getClass=function(){return m3};var A3=function(t,e,n){this.p0=t||null,this.p1=e||null,this.p2=n||null};A3.prototype.area=function(){return A3.area(this.p0,this.p1,this.p2)},A3.prototype.signedArea=function(){return A3.signedArea(this.p0,this.p1,this.p2)},A3.prototype.interpolateZ=function(t){if(null===t)throw new z0("Supplied point is null.");return A3.interpolateZ(t,this.p0,this.p1,this.p2)},A3.prototype.longestSideLength=function(){return A3.longestSideLength(this.p0,this.p1,this.p2)},A3.prototype.isAcute=function(){return A3.isAcute(this.p0,this.p1,this.p2)},A3.prototype.circumcentre=function(){return A3.circumcentre(this.p0,this.p1,this.p2)},A3.prototype.area3D=function(){return A3.area3D(this.p0,this.p1,this.p2)},A3.prototype.centroid=function(){return A3.centroid(this.p0,this.p1,this.p2)},A3.prototype.inCentre=function(){return A3.inCentre(this.p0,this.p1,this.p2)},A3.prototype.interfaces_=function(){return[]},A3.prototype.getClass=function(){return A3},A3.area=function(t,e,n){return Math.abs(((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2)},A3.signedArea=function(t,e,n){return((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2},A3.det=function(t,e,n,r){return t*r-e*n},A3.interpolateZ=function(t,e,n,r){var i=e.x,o=e.y,s=n.x-i,a=r.x-i,l=n.y-o,h=r.y-o,u=s*h-a*l,c=t.x-i,f=t.y-o,d=(h*c-a*f)/u,p=(-l*c+s*f)/u;return e.z+d*(n.z-e.z)+p*(r.z-e.z)},A3.longestSideLength=function(t,e,n){var r=t.distance(e),i=e.distance(n),o=n.distance(t),s=r;return i>s&&(s=i),o>s&&(s=o),s},A3.isAcute=function(t,e,n){return!!h3.isAcute(t,e,n)&&!!h3.isAcute(e,n,t)&&!!h3.isAcute(n,t,e)},A3.circumcentre=function(t,e,n){var r=n.x,i=n.y,o=t.x-r,s=t.y-i,a=e.x-r,l=e.y-i,h=2*A3.det(o,s,a,l),u=A3.det(s,o*o+s*s,l,a*a+l*l),c=A3.det(o,o*o+s*s,a,a*a+l*l);return new W0(r-u/h,i+c/h)},A3.perpendicularBisector=function(t,e){var n=e.x-t.x,r=e.y-t.y,i=new f1(t.x+n/2,t.y+r/2,1),o=new f1(t.x-r+n/2,t.y+n+r/2,1);return new f1(i,o)},A3.angleBisector=function(t,e,n){var r=e.distance(t),i=r/(r+e.distance(n)),o=n.x-t.x,s=n.y-t.y;return new W0(t.x+i*o,t.y+i*s)},A3.area3D=function(t,e,n){var r=e.x-t.x,i=e.y-t.y,o=e.z-t.z,s=n.x-t.x,a=n.y-t.y,l=n.z-t.z,h=i*l-o*a,u=o*s-r*l,c=r*a-i*s,f=h*h+u*u+c*c;return Math.sqrt(f)/2},A3.centroid=function(t,e,n){var r=(t.x+e.x+n.x)/3,i=(t.y+e.y+n.y)/3;return new W0(r,i)},A3.inCentre=function(t,e,n){var r=e.distance(n),i=t.distance(n),o=t.distance(e),s=r+i+o,a=(r*t.x+i*e.x+o*n.x)/s,l=(r*t.y+i*e.y+o*n.y)/s;return new W0(a,l)};var y3=function(){this.ur=null,this.ri=null,this.hr=null,this.cr=new q1;var t=arguments[0],e=arguments[1],n=arguments[2];this.ur=t,this.ri=e,this.hr=n};y3.prototype.addPoint=function(t){if(this.ri<=0)return null;var e=t.getCoordinates(),n=this.hr.getLineCurve(e,this.ri);this.addCurve(n,Y0.EXTERIOR,Y0.INTERIOR)},y3.prototype.addPolygon=function(t){var e=this,n=this.ri,r=r5.LEFT;this.ri<0&&(n=-this.ri,r=r5.RIGHT);var i=t.getExteriorRing(),o=Y1.removeRepeatedPoints(i.getCoordinates());if(this.ri<0&&this.isErodedCompletely(i,this.ri))return null;if(this.ri<=0&&o.length<3)return null;this.addPolygonRing(o,n,r,Y0.EXTERIOR,Y0.INTERIOR);for(var s=0;s<t.getNumInteriorRing();s++){var a=t.getInteriorRingN(s),l=Y1.removeRepeatedPoints(a.getCoordinates());e.ri>0&&e.isErodedCompletely(a,-e.ri)||e.addPolygonRing(l,n,r5.opposite(r),Y0.INTERIOR,Y0.EXTERIOR)}},y3.prototype.isTriangleErodedCompletely=function(t,e){var n=new A3(t[0],t[1],t[2]),r=n.inCentre();return I1.distancePointLine(r,n.p0,n.p1)<Math.abs(e)},y3.prototype.addLineString=function(t){if(this.ri<=0&&!this.hr.getBufferParameters().isSingleSided())return null;var e=Y1.removeRepeatedPoints(t.getCoordinates()),n=this.hr.getLineCurve(e,this.ri);this.addCurve(n,Y0.EXTERIOR,Y0.INTERIOR)},y3.prototype.addCurve=function(t,e,n){if(null===t||t.length<2)return null;var r=new X5(t,new f5(0,Y0.BOUNDARY,e,n));this.cr.add(r)},y3.prototype.getCurves=function(){return this.add(this.ur),this.cr},y3.prototype.addPolygonRing=function(t,e,n,r,i){if(0===e&&t.length<B2.MINIMUM_VALID_SIZE)return null;var o=r,s=i;t.length>=B2.MINIMUM_VALID_SIZE&&I1.isCCW(t)&&(o=i,s=r,n=r5.opposite(n));var a=this.hr.getRingCurve(t,n,e);this.addCurve(a,o,s)},y3.prototype.add=function(t){if(t.isEmpty())return null;t instanceof F2?this.addPolygon(t):t instanceof k2?this.addLineString(t):t instanceof D2?this.addPoint(t):(t instanceof z2||t instanceof _2||t instanceof H2||t instanceof x2)&&this.addCollection(t)},y3.prototype.isErodedCompletely=function(t,e){var n=t.getCoordinates();if(n.length<4)return e<0;if(4===n.length)return this.isTriangleErodedCompletely(n,e);var r=t.getEnvelopeInternal(),i=Math.min(r.getHeight(),r.getWidth());return e<0&&2*Math.abs(e)>i},y3.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},y3.prototype.interfaces_=function(){return[]},y3.prototype.getClass=function(){return y3};var v3=function(){};v3.prototype.locate=function(t){},v3.prototype.interfaces_=function(){return[]},v3.prototype.getClass=function(){return v3};var x3=function(){this.ar=null,this.vr=null,this.lr=null,this.di=null,this.wr=null;var t=arguments[0];this.ar=t,this.vr=!0,this.di=0,this.lr=t.getNumGeometries()};x3.prototype.next=function(){if(this.vr)return this.vr=!1,x3.isAtomic(this.ar)&&this.di++,this.ar;if(null!==this.wr){if(this.wr.hasNext())return this.wr.next();this.wr=null}if(this.di>=this.lr)throw new W1;var t=this.ar.getGeometryN(this.di++);return t instanceof x2?(this.wr=new x3(t),this.wr.next()):t},x3.prototype.remove=function(){throw new Error(this.getClass().getName())},x3.prototype.hasNext=function(){if(this.vr)return!0;if(null!==this.wr){if(this.wr.hasNext())return!0;this.wr=null}return!(this.di>=this.lr)},x3.prototype.interfaces_=function(){return[V1]},x3.prototype.getClass=function(){return x3},x3.isAtomic=function(t){return!(t instanceof x2)};var _3=function(){this.An=null;var t=arguments[0];this.An=t};_3.prototype.locate=function(t){return _3.locate(t,this.An)},_3.prototype.interfaces_=function(){return[v3]},_3.prototype.getClass=function(){return _3},_3.isPointInRing=function(t,e){return!!e.getEnvelopeInternal().intersects(t)&&I1.isPointInRing(t,e.getCoordinates())},_3.containsPointInPolygon=function(t,e){if(e.isEmpty())return!1;var n=e.getExteriorRing();if(!_3.isPointInRing(t,n))return!1;for(var r=0;r<e.getNumInteriorRing();r++){var i=e.getInteriorRingN(r);if(_3.isPointInRing(t,i))return!1}return!0},_3.containsPoint=function(t,e){if(e instanceof F2)return _3.containsPointInPolygon(t,e);if(e instanceof x2)for(var n=new x3(e);n.hasNext();){var r=n.next();if(r!==e&&_3.containsPoint(t,r))return!0}return!1},_3.locate=function(t,e){return e.isEmpty()?Y0.EXTERIOR:_3.containsPoint(t,e)?Y0.INTERIOR:Y0.EXTERIOR};var b3=function(){this.Pr=new u2,this.gr=null,this.Cr=[Y0.NONE,Y0.NONE]};b3.prototype.getNextCW=function(t){this.getEdges();var e=this.gr.indexOf(t),n=e-1;return 0===e&&(n=this.gr.size()-1),this.gr.get(n)},b3.prototype.propagateSideLabels=function(t){for(var e=Y0.NONE,n=this.iterator();n.hasNext();){var r=n.next().getLabel();r.isArea(t)&&r.getLocation(t,r5.LEFT)!==Y0.NONE&&(e=r.getLocation(t,r5.LEFT))}if(e===Y0.NONE)return null;for(var i=e,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getLabel();if(a.getLocation(t,r5.ON)===Y0.NONE&&a.setLocation(t,r5.ON,i),a.isArea(t)){var l=a.getLocation(t,r5.LEFT),h=a.getLocation(t,r5.RIGHT);if(h!==Y0.NONE){if(h!==i)throw new l5("side location conflict",s.getCoordinate());l===Y0.NONE&&b1.shouldNeverReachHere("found single null side (at "+s.getCoordinate()+")"),i=l}else b1.isTrue(a.getLocation(t,r5.LEFT)===Y0.NONE,"found single null side"),a.setLocation(t,r5.RIGHT,i),a.setLocation(t,r5.LEFT,i)}}},b3.prototype.getCoordinate=function(){var t=this.iterator();return t.hasNext()?t.next().getCoordinate():null},b3.prototype.print=function(t){c1.out.println("EdgeEndStar:   "+this.getCoordinate());for(var e=this.iterator();e.hasNext();)e.next().print(t)},b3.prototype.isAreaLabelsConsistent=function(t){return this.computeEdgeEndLabels(t.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)},b3.prototype.checkAreaLabelsConsistent=function(t){var e=this.getEdges();if(e.size()<=0)return!0;var n=e.size()-1,r=e.get(n).getLabel().getLocation(t,r5.LEFT);b1.isTrue(r!==Y0.NONE,"Found unlabelled area edge");for(var i=r,o=this.iterator();o.hasNext();){var s=o.next().getLabel();b1.isTrue(s.isArea(t),"Found non-area edge");var a=s.getLocation(t,r5.LEFT),l=s.getLocation(t,r5.RIGHT);if(a===l)return!1;if(l!==i)return!1;i=a}return!0},b3.prototype.findIndex=function(t){this.iterator();for(var e=0;e<this.gr.size();e++)if(this.gr.get(e)===t)return e;return-1},b3.prototype.iterator=function(){return this.getEdges().iterator()},b3.prototype.getEdges=function(){return null===this.gr&&(this.gr=new q1(this.Pr.values())),this.gr},b3.prototype.getLocation=function(t,e,n){return this.Cr[t]===Y0.NONE&&(this.Cr[t]=_3.locate(e,n[t].getGeometry())),this.Cr[t]},b3.prototype.toString=function(){var t=new t1;t.append("EdgeEndStar:   "+this.getCoordinate()),t.append("\n");for(var e=this.iterator();e.hasNext();){var n=e.next();t.append(n),t.append("\n")}return t.toString()},b3.prototype.computeEdgeEndLabels=function(t){for(var e=this.iterator();e.hasNext();)e.next().computeLabel(t)},b3.prototype.computeLabelling=function(t){this.computeEdgeEndLabels(t[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var e=[!1,!1],n=this.iterator();n.hasNext();)for(var r=n.next().getLabel(),i=0;i<2;i++)r.isLine(i)&&r.getLocation(i)===Y0.BOUNDARY&&(e[i]=!0);for(var o=this.iterator();o.hasNext();)for(var s=o.next(),a=s.getLabel(),l=0;l<2;l++)if(a.isAnyNull(l)){var h=Y0.NONE;if(e[l])h=Y0.EXTERIOR;else{var u=s.getCoordinate();h=this.getLocation(l,u,t)}a.setAllLocationsIfNull(l,h)}},b3.prototype.getDegree=function(){return this.Pr.size()},b3.prototype.insertEdgeEnd=function(t,e){this.Pr.put(t,e),this.gr=null},b3.prototype.interfaces_=function(){return[]},b3.prototype.getClass=function(){return b3};var w3=function(t){function e(){t.call(this),this.Dr=null,this.xn=null,this.Ir=1,this.br=2}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.linkResultDirectedEdges=function(){var t=this;this.getResultAreaEdges();for(var e=null,n=null,r=this.Ir,i=0;i<this.Dr.size();i++){var o=t.Dr.get(i),s=o.getSym();if(o.getLabel().isArea())switch(null===e&&o.isInResult()&&(e=o),r){case t.Ir:if(!s.isInResult())continue;n=s,r=t.br;break;case t.br:if(!o.isInResult())continue;n.setNext(o),r=t.Ir}}if(r===this.br){if(null===e)throw new l5("no outgoing dirEdge found",this.getCoordinate());b1.isTrue(e.isInResult(),"unable to link last incoming dirEdge"),n.setNext(e)}},e.prototype.insert=function(t){var e=t;this.insertEdgeEnd(e,e)},e.prototype.getRightmostEdge=function(){var t=this.getEdges(),e=t.size();if(e<1)return null;var n=t.get(0);if(1===e)return n;var r=t.get(e-1),i=n.getQuadrant(),o=r.getQuadrant();return v5.isNorthern(i)&&v5.isNorthern(o)?n:v5.isNorthern(i)||v5.isNorthern(o)?0!==n.getDy()?n:0!==r.getDy()?r:(b1.shouldNeverReachHere("found two horizontal edges incident on node"),null):r},e.prototype.print=function(t){c1.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var e=this.iterator();e.hasNext();){var n=e.next();t.print("out "),n.print(t),t.println(),t.print("in "),n.getSym().print(t),t.println()}},e.prototype.getResultAreaEdges=function(){if(null!==this.Dr)return this.Dr;this.Dr=new q1;for(var t=this.iterator();t.hasNext();){var e=t.next();(e.isInResult()||e.getSym().isInResult())&&this.Dr.add(e)}return this.Dr},e.prototype.updateLabelling=function(t){for(var e=this.iterator();e.hasNext();){var n=e.next().getLabel();n.setAllLocationsIfNull(0,t.getLocation(0)),n.setAllLocationsIfNull(1,t.getLocation(1))}},e.prototype.linkAllDirectedEdges=function(){this.getEdges();for(var t=null,e=null,n=this.gr.size()-1;n>=0;n--){var r=this.gr.get(n),i=r.getSym();null===e&&(e=i),null!==t&&i.setNext(t),t=r}e.setNext(t)},e.prototype.computeDepths=function(){if(1===arguments.length){var t=arguments[0],e=this.findIndex(t),n=t.getDepth(r5.LEFT),r=t.getDepth(r5.RIGHT),i=this.computeDepths(e+1,this.gr.size(),n);if(this.computeDepths(0,e,i)!==r)throw new l5("depth mismatch at "+t.getCoordinate())}else if(3===arguments.length){for(var o=arguments[1],s=arguments[2],a=arguments[0];a<o;a++){var l=this.gr.get(a);l.setEdgeDepths(r5.RIGHT,s),s=l.getDepth(r5.LEFT)}return s}},e.prototype.mergeSymLabels=function(){for(var t=this.iterator();t.hasNext();){var e=t.next();e.getLabel().merge(e.getSym().getLabel())}},e.prototype.linkMinimalDirectedEdges=function(t){for(var e=this,n=null,r=null,i=this.Ir,o=this.Dr.size()-1;o>=0;o--){var s=e.Dr.get(o),a=s.getSym();switch(null===n&&s.getEdgeRing()===t&&(n=s),i){case e.Ir:if(a.getEdgeRing()!==t)continue;r=a,i=e.br;break;case e.br:if(s.getEdgeRing()!==t)continue;r.setNextMin(s),i=e.Ir}}i===this.br&&(b1.isTrue(null!==n,"found null for first outgoing dirEdge"),b1.isTrue(n.getEdgeRing()===t,"unable to link last incoming dirEdge"),r.setNextMin(n))},e.prototype.getOutgoingDegree=function(){if(0===arguments.length){for(var t=0,e=this.iterator();e.hasNext();)e.next().isInResult()&&t++;return t}if(1===arguments.length){for(var n=arguments[0],r=0,i=this.iterator();i.hasNext();)i.next().getEdgeRing()===n&&r++;return r}},e.prototype.getLabel=function(){return this.xn},e.prototype.findCoveredLineEdges=function(){for(var t=Y0.NONE,e=this.iterator();e.hasNext();){var n=e.next(),r=n.getSym();if(!n.isLineEdge()){if(n.isInResult()){t=Y0.INTERIOR;break}if(r.isInResult()){t=Y0.EXTERIOR;break}}}if(t===Y0.NONE)return null;for(var i=t,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getSym();s.isLineEdge()?s.getEdge().setCovered(i===Y0.INTERIOR):(s.isInResult()&&(i=Y0.EXTERIOR),a.isInResult()&&(i=Y0.INTERIOR))}},e.prototype.computeLabelling=function(e){t.prototype.computeLabelling.call(this,e),this.xn=new f5(Y0.NONE);for(var n=this.iterator();n.hasNext();)for(var r=n.next().getEdge().getLabel(),i=0;i<2;i++){var o=r.getLocation(i);o!==Y0.INTERIOR&&o!==Y0.BOUNDARY||this.xn.setLocation(i,Y0.INTERIOR)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(b3),T3=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createNode=function(t){return new A5(t,new w3)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(w5),M3=function t(){this.dn=null,this.Mr=null;var e=arguments[0];this.dn=e,this.Mr=t.orientation(e)};M3.prototype.compareTo=function(t){var e=t;return M3.compareOriented(this.dn,this.Mr,e.dn,e.Mr)},M3.prototype.interfaces_=function(){return[j0]},M3.prototype.getClass=function(){return M3},M3.orientation=function(t){return 1===Y1.increasingDirection(t)},M3.compareOriented=function(t,e,n,r){for(var i=e?1:-1,o=r?1:-1,s=e?t.length:-1,a=r?n.length:-1,l=e?0:t.length-1,h=r?0:n.length-1;;){var u=t[l].compareTo(n[h]);if(0!==u)return u;var c=(l+=i)===s,f=(h+=o)===a;if(c&&!f)return-1;if(!c&&f)return 1;if(c&&f)return 0}};var C3=function(){this.zn=new q1,this.zr=new u2};C3.prototype.print=function(t){t.print("MULTILINESTRING ( ");for(var e=0;e<this.zn.size();e++){var n=this.zn.get(e);e>0&&t.print(","),t.print("(");for(var r=n.getCoordinates(),i=0;i<r.length;i++)i>0&&t.print(","),t.print(r[i].x+" "+r[i].y);t.println(")")}t.print(")  ")},C3.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next())},C3.prototype.findEdgeIndex=function(t){for(var e=0;e<this.zn.size();e++)if(this.zn.get(e).equals(t))return e;return-1},C3.prototype.iterator=function(){return this.zn.iterator()},C3.prototype.getEdges=function(){return this.zn},C3.prototype.get=function(t){return this.zn.get(t)},C3.prototype.findEqualEdge=function(t){var e=new M3(t.getCoordinates());return this.zr.get(e)},C3.prototype.add=function(t){this.zn.add(t);var e=new M3(t.getCoordinates());this.zr.put(e,t)},C3.prototype.interfaces_=function(){return[]},C3.prototype.getClass=function(){return C3};var S3=function(){};S3.prototype.processIntersections=function(t,e,n,r){},S3.prototype.isDone=function(){},S3.prototype.interfaces_=function(){return[]},S3.prototype.getClass=function(){return S3};var I3=function(){this.dr=!1,this.mr=!1,this.yr=!1,this.pr=!1,this.Lr=null,this.Wi=null,this.Tr=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0;var t=arguments[0];this.Wi=t};I3.prototype.isTrivialIntersection=function(t,e,n,r){if(t===n&&1===this.Wi.getIntersectionNum()){if(I3.isAdjacentSegments(e,r))return!0;if(t.isClosed()){var i=t.size()-1;if(0===e&&r===i||0===r&&e===i)return!0}}return!1},I3.prototype.getProperIntersectionPoint=function(){return this.Lr},I3.prototype.hasProperInteriorIntersection=function(){return this.yr},I3.prototype.getLineIntersector=function(){return this.Wi},I3.prototype.hasProperIntersection=function(){return this.mr},I3.prototype.processIntersections=function(t,e,n,r){if(t===n&&e===r)return null;this.numTests++;var i=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Wi.computeIntersection(i,o,s,a),this.Wi.hasIntersection()&&(this.numIntersections++,this.Wi.isInteriorIntersection()&&(this.numInteriorIntersections++,this.pr=!0),this.isTrivialIntersection(t,e,n,r)||(this.dr=!0,t.addIntersections(this.Wi,e,0),n.addIntersections(this.Wi,r,1),this.Wi.isProper()&&(this.numProperIntersections++,this.mr=!0,this.yr=!0)))},I3.prototype.hasIntersection=function(){return this.dr},I3.prototype.isDone=function(){return!1},I3.prototype.hasInteriorIntersection=function(){return this.pr},I3.prototype.interfaces_=function(){return[S3]},I3.prototype.getClass=function(){return I3},I3.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var P3=function(){this.coord=null,this.segmentIndex=null,this.dist=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.coord=new W0(t),this.segmentIndex=e,this.dist=n};P3.prototype.getSegmentIndex=function(){return this.segmentIndex},P3.prototype.getCoordinate=function(){return this.coord},P3.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex),t.println(" dist = "+this.dist)},P3.prototype.compareTo=function(t){var e=t;return this.compare(e.segmentIndex,e.dist)},P3.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&0===this.dist||this.segmentIndex===t},P3.prototype.toString=function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist},P3.prototype.getDistance=function(){return this.dist},P3.prototype.compare=function(t,e){return this.segmentIndex<t?-1:this.segmentIndex>t?1:this.dist<e?-1:this.dist>e?1:0},P3.prototype.interfaces_=function(){return[j0]},P3.prototype.getClass=function(){return P3};var E3=function(){this.vi=new u2,this.edge=null;var t=arguments[0];this.edge=t};E3.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},E3.prototype.iterator=function(){return this.vi.values().iterator()},E3.prototype.addSplitEdges=function(t){this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next(),i=this.createSplitEdge(n,r);t.add(i),n=r}},E3.prototype.addEndpoints=function(){var t=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[t],t,0)},E3.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,r=this.edge.pts[e.segmentIndex],i=e.dist>0||!e.coord.equals2D(r);i||n--;var o=new Array(n).fill(null),s=0;o[s++]=new W0(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)o[s++]=this.edge.pts[a];return i&&(o[s]=e.coord),new D3(o,new f5(this.edge.xn))},E3.prototype.add=function(t,e,n){var r=new P3(t,e,n),i=this.vi.get(r);return null!==i?i:(this.vi.put(r,r),r)},E3.prototype.isIntersection=function(t){for(var e=this.iterator();e.hasNext();)if(e.next().coord.equals(t))return!0;return!1},E3.prototype.interfaces_=function(){return[]},E3.prototype.getClass=function(){return E3};var O3=function(){};O3.prototype.getChainStartIndices=function(t){var e=0,n=new q1;n.add(new e1(e));do{var r=this.findChainEnd(t,e);n.add(new e1(r)),e=r}while(e<t.length-1);return O3.toIntArray(n)},O3.prototype.findChainEnd=function(t,e){for(var n=v5.quadrant(t[e],t[e+1]),r=e+1;r<t.length&&v5.quadrant(t[r-1],t[r])===n;)r++;return r-1},O3.prototype.interfaces_=function(){return[]},O3.prototype.getClass=function(){return O3},O3.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var R3=function(){this.e=null,this.pts=null,this.startIndex=null,this.env1=new d1,this.env2=new d1;var t=arguments[0];this.e=t,this.pts=t.getCoordinates();var e=new O3;this.startIndex=e.getChainStartIndices(this.pts)};R3.prototype.getCoordinates=function(){return this.pts},R3.prototype.getMaxX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e>n?e:n},R3.prototype.getMinX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e<n?e:n},R3.prototype.computeIntersectsForChain=function(){if(4===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.computeIntersectsForChain(this.startIndex[t],this.startIndex[t+1],e,e.startIndex[n],e.startIndex[n+1],r)}else if(6===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3],l=arguments[4],h=arguments[5],u=this.pts[i],c=this.pts[o],f=s.pts[a],d=s.pts[l];if(o-i==1&&l-a==1)return h.addIntersections(this.e,i,s.e,a),null;if(this.env1.init(u,c),this.env2.init(f,d),!this.env1.intersects(this.env2))return null;var p=Math.trunc((i+o)/2),g=Math.trunc((a+l)/2);i<p&&(a<g&&this.computeIntersectsForChain(i,p,s,a,g,h),g<l&&this.computeIntersectsForChain(i,p,s,g,l,h)),p<o&&(a<g&&this.computeIntersectsForChain(p,o,s,a,g,h),g<l&&this.computeIntersectsForChain(p,o,s,g,l,h))}},R3.prototype.getStartIndexes=function(){return this.startIndex},R3.prototype.computeIntersects=function(t,e){for(var n=0;n<this.startIndex.length-1;n++)for(var r=0;r<t.startIndex.length-1;r++)this.computeIntersectsForChain(n,t,r,e)},R3.prototype.interfaces_=function(){return[]},R3.prototype.getClass=function(){return R3};var k3=function t(){this._n=Array(2).fill().map((function(){return Array(3)}));for(var e=0;e<2;e++)for(var n=0;n<3;n++)this._n[e][n]=t.NULL_VALUE},L3={NULL_VALUE:{configurable:!0}};k3.prototype.getDepth=function(t,e){return this._n[t][e]},k3.prototype.setDepth=function(t,e,n){this._n[t][e]=n},k3.prototype.isNull=function(){if(0===arguments.length){for(var t=0;t<2;t++)for(var e=0;e<3;e++)if(this._n[t][e]!==k3.NULL_VALUE)return!1;return!0}if(1===arguments.length){var n=arguments[0];return this._n[n][1]===k3.NULL_VALUE}if(2===arguments.length){var r=arguments[0],i=arguments[1];return this._n[r][i]===k3.NULL_VALUE}},k3.prototype.normalize=function(){for(var t=this,e=0;e<2;e++)if(!t.isNull(e)){var n=t._n[e][1];t._n[e][2]<n&&(n=t._n[e][2]),n<0&&(n=0);for(var r=1;r<3;r++){var i=0;t._n[e][r]>n&&(i=1),t._n[e][r]=i}}},k3.prototype.getDelta=function(t){return this._n[t][r5.RIGHT]-this._n[t][r5.LEFT]},k3.prototype.getLocation=function(t,e){return this._n[t][e]<=0?Y0.EXTERIOR:Y0.INTERIOR},k3.prototype.toString=function(){return"A: "+this._n[0][1]+","+this._n[0][2]+" B: "+this._n[1][1]+","+this._n[1][2]},k3.prototype.add=function(){var t=this;if(1===arguments.length)for(var e=arguments[0],n=0;n<2;n++)for(var r=1;r<3;r++){var i=e.getLocation(n,r);i!==Y0.EXTERIOR&&i!==Y0.INTERIOR||(t.isNull(n,r)?t._n[n][r]=k3.depthAtLocation(i):t._n[n][r]+=k3.depthAtLocation(i))}else if(3===arguments.length){var o=arguments[0],s=arguments[1];arguments[2]===Y0.INTERIOR&&this._n[o][s]++}},k3.prototype.interfaces_=function(){return[]},k3.prototype.getClass=function(){return k3},k3.depthAtLocation=function(t){return t===Y0.EXTERIOR?0:t===Y0.INTERIOR?1:k3.NULL_VALUE},L3.NULL_VALUE.get=function(){return-1},Object.defineProperties(k3,L3);var D3=function(t){function e(){if(t.call(this),this.pts=null,this.In=null,this.eiList=new E3(this),this.hn=null,this.Or=null,this.Fr=!0,this._n=new k3,this.Ur=0,1===arguments.length){var n=arguments[0];e.call(this,n,null)}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.pts=r,this.xn=i}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getDepth=function(){return this._n},e.prototype.getCollapsedEdge=function(){var t=new Array(2).fill(null);return t[0]=this.pts[0],t[1]=this.pts[1],new e(t,f5.toLineLabel(this.xn))},e.prototype.isIsolated=function(){return this.Fr},e.prototype.getCoordinates=function(){return this.pts},e.prototype.setIsolated=function(t){this.Fr=t},e.prototype.setName=function(t){this.hn=t},e.prototype.equals=function(t){if(!(t instanceof e))return!1;var n=t;if(this.pts.length!==n.pts.length)return!1;for(var r=!0,i=!0,o=this.pts.length,s=0;s<this.pts.length;s++)if(this.pts[s].equals2D(n.pts[s])||(r=!1),this.pts[s].equals2D(n.pts[--o])||(i=!1),!r&&!i)return!1;return!0},e.prototype.getCoordinate=function(){if(0===arguments.length)return this.pts.length>0?this.pts[0]:null;if(1===arguments.length){var t=arguments[0];return this.pts[t]}},e.prototype.print=function(t){t.print("edge "+this.hn+": "),t.print("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.print(","),t.print(this.pts[e].x+" "+this.pts[e].y);t.print(")  "+this.xn+" "+this.Ur)},e.prototype.computeIM=function(t){e.updateIM(this.xn,t)},e.prototype.isCollapsed=function(){return!!this.xn.isArea()&&3===this.pts.length&&!!this.pts[0].equals(this.pts[2])},e.prototype.isClosed=function(){return this.pts[0].equals(this.pts[this.pts.length-1])},e.prototype.getMaximumSegmentIndex=function(){return this.pts.length-1},e.prototype.getDepthDelta=function(){return this.Ur},e.prototype.getNumPoints=function(){return this.pts.length},e.prototype.printReverse=function(t){t.print("edge "+this.hn+": ");for(var e=this.pts.length-1;e>=0;e--)t.print(this.pts[e]+" ");t.println("")},e.prototype.getMonotoneChainEdge=function(){return null===this.Or&&(this.Or=new R3(this)),this.Or},e.prototype.getEnvelope=function(){if(null===this.In){this.In=new d1;for(var t=0;t<this.pts.length;t++)this.In.expandToInclude(this.pts[t])}return this.In},e.prototype.addIntersection=function(t,e,n,r){var i=new W0(t.getIntersection(r)),o=e,s=t.getEdgeDistance(n,r),a=o+1;if(a<this.pts.length){var l=this.pts[a];i.equals2D(l)&&(o=a,s=0)}this.eiList.add(i,o,s)},e.prototype.toString=function(){var t=new t1;t.append("edge "+this.hn+": "),t.append("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.append(","),t.append(this.pts[e].x+" "+this.pts[e].y);return t.append(")  "+this.xn+" "+this.Ur),t.toString()},e.prototype.isPointwiseEqual=function(t){if(this.pts.length!==t.pts.length)return!1;for(var e=0;e<this.pts.length;e++)if(!this.pts[e].equals2D(t.pts[e]))return!1;return!0},e.prototype.setDepthDelta=function(t){this.Ur=t},e.prototype.getEdgeIntersectionList=function(){return this.eiList},e.prototype.addIntersections=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++)this.addIntersection(t,e,n,r)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.updateIM=function(){if(2!==arguments.length)return t.prototype.updateIM.apply(this,arguments);var e=arguments[0],n=arguments[1];n.setAtLeastIfValid(e.getLocation(0,r5.ON),e.getLocation(1,r5.ON),1),e.isArea()&&(n.setAtLeastIfValid(e.getLocation(0,r5.LEFT),e.getLocation(1,r5.LEFT),2),n.setAtLeastIfValid(e.getLocation(0,r5.RIGHT),e.getLocation(1,r5.RIGHT),2))},e}(m5),N3=function(t){this.Er=null,this.Nr=null,this.tn=null,this.jr=null,this.gr=new C3,this.Vi=t||null};N3.prototype.setWorkingPrecisionModel=function(t){this.Er=t},N3.prototype.insertUniqueEdge=function(t){var e=this.gr.findEqualEdge(t);if(null!==e){var n=e.getLabel(),r=t.getLabel();e.isPointwiseEqual(t)||(r=new f5(t.getLabel())).flip(),n.merge(r);var i=N3.depthDelta(r),o=e.getDepthDelta()+i;e.setDepthDelta(o)}else this.gr.add(t),t.setDepthDelta(N3.depthDelta(t.getLabel()))},N3.prototype.buildSubgraphs=function(t,e){for(var n=new q1,r=t.iterator();r.hasNext();){var i=r.next(),o=i.getRightmostCoordinate(),s=new p3(n).getDepth(o);i.computeDepth(s),i.findResultEdges(),n.add(i),e.add(i.getDirectedEdges(),i.getNodes())}},N3.prototype.createSubgraphs=function(t){for(var e=new q1,n=t.getNodes().iterator();n.hasNext();){var r=n.next();if(!r.isVisited()){var i=new u5;i.create(r),e.add(i)}}return k5.sort(e,k5.reverseOrder()),e},N3.prototype.createEmptyResultGeometry=function(){return this.tn.createPolygon()},N3.prototype.getNoder=function(t){if(null!==this.Nr)return this.Nr;var e=new e3,n=new M1;return n.setPrecisionModel(t),e.setSegmentIntersector(new I3(n)),e},N3.prototype.buffer=function(t,e){var n=this.Er;null===n&&(n=t.getPrecisionModel()),this.tn=t.getFactory();var r=new d3(n,this.Vi),i=new y3(t,e,r).getCurves();if(i.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(i,n),this.jr=new T5(new T3),this.jr.addEdges(this.gr.getEdges());var o=this.createSubgraphs(this.jr),s=new M5(this.tn);this.buildSubgraphs(o,s);var a=s.getPolygons();return a.size()<=0?this.createEmptyResultGeometry():this.tn.buildGeometry(a)},N3.prototype.computeNodedEdges=function(t,e){var n=this.getNoder(e);n.computeNodes(t);for(var r=n.getNodedSubstrings().iterator();r.hasNext();){var i=r.next(),o=i.getCoordinates();if(2!==o.length||!o[0].equals2D(o[1])){var s=i.getData(),a=new D3(i.getCoordinates(),new f5(s));this.insertUniqueEdge(a)}}},N3.prototype.setNoder=function(t){this.Nr=t},N3.prototype.interfaces_=function(){return[]},N3.prototype.getClass=function(){return N3},N3.depthDelta=function(t){var e=t.getLocation(0,r5.LEFT),n=t.getLocation(0,r5.RIGHT);return e===Y0.INTERIOR&&n===Y0.EXTERIOR?1:e===Y0.EXTERIOR&&n===Y0.INTERIOR?-1:0},N3.convertSegStrings=function(t){for(var e=new e5,n=new q1;t.hasNext();){var r=t.next(),i=e.createLineString(r.getCoordinates());n.add(i)}return e.buildGeometry(n)};var F3=function(){if(this.Qr=null,this.Sr=null,this.Br=null,this.kr=null,this.Rr=!1,2===arguments.length){var t=arguments[0],e=arguments[1];this.Qr=t,this.Sr=e,this.Br=0,this.kr=0,this.Rr=!this.isIntegerPrecision()}else if(4===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2],o=arguments[3];this.Qr=n,this.Sr=r,this.Br=i,this.kr=o,this.Rr=!this.isIntegerPrecision()}};F3.prototype.rescale=function(){var t=this;if(Q0(arguments[0],j1))for(var e=arguments[0].iterator();e.hasNext();){var n=e.next();t.rescale(n.getCoordinates())}else if(arguments[0]instanceof Array){for(var r=arguments[0],i=0;i<r.length;i++)r[i].x=r[i].x/t.Sr+t.Br,r[i].y=r[i].y/t.Sr+t.kr;2===r.length&&r[0].equals2D(r[1])&&c1.out.println(r)}},F3.prototype.scale=function(){var t=this;if(Q0(arguments[0],j1)){for(var e=arguments[0],n=new q1,r=e.iterator();r.hasNext();){var i=r.next();n.add(new X5(t.scale(i.getCoordinates()),i.getData()))}return n}if(arguments[0]instanceof Array){for(var o=arguments[0],s=new Array(o.length).fill(null),a=0;a<o.length;a++)s[a]=new W0(Math.round((o[a].x-t.Br)*t.Sr),Math.round((o[a].y-t.kr)*t.Sr),o[a].z);return Y1.removeRepeatedPoints(s)}},F3.prototype.isIntegerPrecision=function(){return 1===this.Sr},F3.prototype.getNodedSubstrings=function(){var t=this.Qr.getNodedSubstrings();return this.Rr&&this.rescale(t),t},F3.prototype.computeNodes=function(t){var e=t;this.Rr&&(e=this.scale(t)),this.Qr.computeNodes(e)},F3.prototype.interfaces_=function(){return[$5]},F3.prototype.getClass=function(){return F3};var z3=function(){this.Wi=new M1,this.Gr=null;var t=arguments[0];this.Gr=t},B3={fact:{configurable:!0}};z3.prototype.checkEndPtVertexIntersections=function(){var t=this;if(0===arguments.length)for(var e=this.Gr.iterator();e.hasNext();){var n=e.next().getCoordinates();t.checkEndPtVertexIntersections(n[0],t.Gr),t.checkEndPtVertexIntersections(n[n.length-1],t.Gr)}else if(2===arguments.length)for(var r=arguments[0],i=arguments[1].iterator();i.hasNext();)for(var o=i.next().getCoordinates(),s=1;s<o.length-1;s++)if(o[s].equals(r))throw new x1("found endpt/interior pt intersection at index "+s+" :pt "+r)},z3.prototype.checkInteriorIntersections=function(){if(0===arguments.length)for(var t=this.Gr.iterator();t.hasNext();)for(var e=t.next(),n=this.Gr.iterator();n.hasNext();){var r=n.next();this.checkInteriorIntersections(e,r)}else if(2===arguments.length)for(var i=arguments[0],o=arguments[1],s=i.getCoordinates(),a=o.getCoordinates(),l=0;l<s.length-1;l++)for(var h=0;h<a.length-1;h++)this.checkInteriorIntersections(i,l,o,h);else if(4===arguments.length){var u=arguments[0],c=arguments[1],f=arguments[2],d=arguments[3];if(u===f&&c===d)return null;var p=u.getCoordinates()[c],g=u.getCoordinates()[c+1],m=f.getCoordinates()[d],A=f.getCoordinates()[d+1];if(this.Wi.computeIntersection(p,g,m,A),this.Wi.hasIntersection()&&(this.Wi.isProper()||this.hasInteriorIntersection(this.Wi,p,g)||this.hasInteriorIntersection(this.Wi,m,A)))throw new x1("found non-noded intersection at "+p+"-"+g+" and "+m+"-"+A)}},z3.prototype.checkValid=function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()},z3.prototype.checkCollapses=function(){if(0===arguments.length)for(var t=this.Gr.iterator();t.hasNext();){var e=t.next();this.checkCollapses(e)}else if(1===arguments.length)for(var n=arguments[0].getCoordinates(),r=0;r<n.length-2;r++)this.checkCollapse(n[r],n[r+1],n[r+2])},z3.prototype.hasInteriorIntersection=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++){var i=t.getIntersection(r);if(!i.equals(e)&&!i.equals(n))return!0}return!1},z3.prototype.checkCollapse=function(t,e,n){if(t.equals(n))throw new x1("found non-noded collapse at "+z3.fact.createLineString([t,e,n]))},z3.prototype.interfaces_=function(){return[]},z3.prototype.getClass=function(){return z3},B3.fact.get=function(){return new e5},Object.defineProperties(z3,B3);var H3=function(){this.Wi=null,this.Yr=null,this.qr=null,this.Vr=null,this.Wr=null,this._r=null,this.Sr=null,this.Tt=null,this.Ot=null,this.Ft=null,this.Ut=null,this.Kr=new Array(4).fill(null),this.Hr=null;var t=arguments[0],e=arguments[1],n=arguments[2];if(this.qr=t,this.Yr=t,this.Sr=e,this.Wi=n,e<=0)throw new z0("Scale factor must be non-zero");1!==e&&(this.Yr=new W0(this.scale(t.x),this.scale(t.y)),this.Wr=new W0,this._r=new W0),this.initCorners(this.Yr)},j3={SAFE_ENV_EXPANSION_FACTOR:{configurable:!0}};H3.prototype.intersectsScaled=function(t,e){var n=Math.min(t.x,e.x),r=Math.max(t.x,e.x),i=Math.min(t.y,e.y),o=Math.max(t.y,e.y),s=this.Ot<n||this.Tt>r||this.Ut<i||this.Ft>o;if(s)return!1;var a=this.intersectsToleranceSquare(t,e);return b1.isTrue(!(s&&a),"Found bad envelope test"),a},H3.prototype.initCorners=function(t){var e=.5;this.Tt=t.x-e,this.Ot=t.x+e,this.Ft=t.y-e,this.Ut=t.y+e,this.Kr[0]=new W0(this.Ot,this.Ut),this.Kr[1]=new W0(this.Tt,this.Ut),this.Kr[2]=new W0(this.Tt,this.Ft),this.Kr[3]=new W0(this.Ot,this.Ft)},H3.prototype.intersects=function(t,e){return 1===this.Sr?this.intersectsScaled(t,e):(this.copyScaled(t,this.Wr),this.copyScaled(e,this._r),this.intersectsScaled(this.Wr,this._r))},H3.prototype.scale=function(t){return Math.round(t*this.Sr)},H3.prototype.getCoordinate=function(){return this.qr},H3.prototype.copyScaled=function(t,e){e.x=this.scale(t.x),e.y=this.scale(t.y)},H3.prototype.getSafeEnvelope=function(){if(null===this.Hr){var t=H3.SAFE_ENV_EXPANSION_FACTOR/this.Sr;this.Hr=new d1(this.qr.x-t,this.qr.x+t,this.qr.y-t,this.qr.y+t)}return this.Hr},H3.prototype.intersectsPixelClosure=function(t,e){return this.Wi.computeIntersection(t,e,this.Kr[0],this.Kr[1]),!!(this.Wi.hasIntersection()||(this.Wi.computeIntersection(t,e,this.Kr[1],this.Kr[2]),this.Wi.hasIntersection()||(this.Wi.computeIntersection(t,e,this.Kr[2],this.Kr[3]),this.Wi.hasIntersection()||(this.Wi.computeIntersection(t,e,this.Kr[3],this.Kr[0]),this.Wi.hasIntersection()))))},H3.prototype.intersectsToleranceSquare=function(t,e){var n=!1,r=!1;return this.Wi.computeIntersection(t,e,this.Kr[0],this.Kr[1]),!!(this.Wi.isProper()||(this.Wi.computeIntersection(t,e,this.Kr[1],this.Kr[2]),this.Wi.isProper()||(this.Wi.hasIntersection()&&(n=!0),this.Wi.computeIntersection(t,e,this.Kr[2],this.Kr[3]),this.Wi.isProper()||(this.Wi.hasIntersection()&&(r=!0),this.Wi.computeIntersection(t,e,this.Kr[3],this.Kr[0]),this.Wi.isProper()||n&&r||t.equals(this.Yr)||e.equals(this.Yr)))))},H3.prototype.addSnappedNode=function(t,e){var n=t.getCoordinate(e),r=t.getCoordinate(e+1);return!!this.intersects(n,r)&&(t.addIntersection(this.getCoordinate(),e),!0)},H3.prototype.interfaces_=function(){return[]},H3.prototype.getClass=function(){return H3},j3.SAFE_ENV_EXPANSION_FACTOR.get=function(){return.75},Object.defineProperties(H3,j3);var U3=function(){this.tempEnv1=new d1,this.selectedSegment=new Z5};U3.prototype.select=function(){if(1===arguments.length);else if(2===arguments.length){var t=arguments[1];arguments[0].getLineSegment(t,this.selectedSegment),this.select(this.selectedSegment)}},U3.prototype.interfaces_=function(){return[]},U3.prototype.getClass=function(){return U3};var V3=function(){this.di=null;var t=arguments[0];this.di=t},G3={HotPixelSnapAction:{configurable:!0}};V3.prototype.snap=function(){if(1===arguments.length){var t=arguments[0];return this.snap(t,null,-1)}if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2],i=e.getSafeEnvelope(),o=new W3(e,n,r);return this.di.query(i,{interfaces_:function(){return[P5]},visitItem:function(t){t.select(i,o)}}),o.isNodeAdded()}},V3.prototype.interfaces_=function(){return[]},V3.prototype.getClass=function(){return V3},G3.HotPixelSnapAction.get=function(){return W3},Object.defineProperties(V3,G3);var W3=function(t){function e(){t.call(this),this.Jr=null,this.Zr=null,this.Xr=null,this.$r=!1;var e=arguments[0],n=arguments[1],r=arguments[2];this.Jr=e,this.Zr=n,this.Xr=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isNodeAdded=function(){return this.$r},e.prototype.select=function(){if(2!==arguments.length)return t.prototype.select.apply(this,arguments);var e=arguments[1],n=arguments[0].getContext();if(null!==this.Zr&&n===this.Zr&&e===this.Xr)return null;this.$r=this.Jr.addSnappedNode(n,e)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(U3),q3=function(){this.Wi=null,this.Ae=null;var t=arguments[0];this.Wi=t,this.Ae=new q1};q3.prototype.processIntersections=function(t,e,n,r){if(t===n&&e===r)return null;var i=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[r],a=n.getCoordinates()[r+1];if(this.Wi.computeIntersection(i,o,s,a),this.Wi.hasIntersection()&&this.Wi.isInteriorIntersection()){for(var l=0;l<this.Wi.getIntersectionNum();l++)this.Ae.add(this.Wi.getIntersection(l));t.addIntersections(this.Wi,e,0),n.addIntersections(this.Wi,r,1)}},q3.prototype.isDone=function(){return!1},q3.prototype.getInteriorIntersections=function(){return this.Ae},q3.prototype.interfaces_=function(){return[S3]},q3.prototype.getClass=function(){return q3};var X3=function(){this.te=null,this.Wi=null,this.Sr=null,this.Qr=null,this.ne=null,this.mi=null;var t=arguments[0];this.te=t,this.Wi=new M1,this.Wi.setPrecisionModel(t),this.Sr=t.getScale()};X3.prototype.checkCorrectness=function(t){var e=X5.getNodedSubstrings(t),n=new z3(e);try{n.checkValid()}catch(r){if(!(r instanceof h1))throw r;r.printStackTrace()}},X3.prototype.getNodedSubstrings=function(){return X5.getNodedSubstrings(this.mi)},X3.prototype.snapRound=function(t,e){var n=this.findInteriorIntersections(t,e);this.computeIntersectionSnaps(n),this.computeVertexSnaps(t)},X3.prototype.findInteriorIntersections=function(t,e){var n=new q3(e);return this.Qr.setSegmentIntersector(n),this.Qr.computeNodes(t),n.getInteriorIntersections()},X3.prototype.computeVertexSnaps=function(){var t=this;if(Q0(arguments[0],j1))for(var e=arguments[0].iterator();e.hasNext();){var n=e.next();t.computeVertexSnaps(n)}else if(arguments[0]instanceof X5)for(var r=arguments[0],i=r.getCoordinates(),o=0;o<i.length;o++){var s=new H3(i[o],t.Sr,t.Wi);t.ne.snap(s,r,o)&&r.addIntersection(i[o],o)}},X3.prototype.computeNodes=function(t){this.mi=t,this.Qr=new e3,this.ne=new V3(this.Qr.getIndex()),this.snapRound(t,this.Wi)},X3.prototype.computeIntersectionSnaps=function(t){for(var e=this,n=t.iterator();n.hasNext();){var r=n.next(),i=new H3(r,e.Sr,e.Wi);e.ne.snap(i)}},X3.prototype.interfaces_=function(){return[$5]},X3.prototype.getClass=function(){return X3};var Z3=function(){if(this.ie=null,this.ri=null,this.Vi=new r3,this.re=null,this.ee=null,1===arguments.length){var t=arguments[0];this.ie=t}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.ie=e,this.Vi=n}},Y3={CAP_ROUND:{configurable:!0},CAP_BUTT:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},MAX_PRECISION_DIGITS:{configurable:!0}};Z3.prototype.bufferFixedPrecision=function(t){var e=new F3(new X3(new Q2(1)),t.getScale()),n=new N3(this.Vi);n.setWorkingPrecisionModel(t),n.setNoder(e),this.re=n.buffer(this.ie,this.ri)},Z3.prototype.bufferReducedPrecision=function(){var t=this;if(0===arguments.length){for(var e=Z3.MAX_PRECISION_DIGITS;e>=0;e--){try{t.bufferReducedPrecision(e)}catch(o){if(!(o instanceof l5))throw o;t.ee=o}if(null!==t.re)return null}throw this.ee}if(1===arguments.length){var n=arguments[0],r=Z3.precisionScaleFactor(this.ie,this.ri,n),i=new Q2(r);this.bufferFixedPrecision(i)}},Z3.prototype.computeGeometry=function(){if(this.bufferOriginalPrecision(),null!==this.re)return null;var t=this.ie.getFactory().getPrecisionModel();t.getType()===Q2.FIXED?this.bufferFixedPrecision(t):this.bufferReducedPrecision()},Z3.prototype.setQuadrantSegments=function(t){this.Vi.setQuadrantSegments(t)},Z3.prototype.bufferOriginalPrecision=function(){try{var t=new N3(this.Vi);this.re=t.buffer(this.ie,this.ri)}catch(e){if(!(e instanceof x1))throw e;this.ee=e}},Z3.prototype.getResultGeometry=function(t){return this.ri=t,this.computeGeometry(),this.re},Z3.prototype.setEndCapStyle=function(t){this.Vi.setEndCapStyle(t)},Z3.prototype.interfaces_=function(){return[]},Z3.prototype.getClass=function(){return Z3},Z3.bufferOp=function(){if(2===arguments.length){var t=arguments[1];return new Z3(arguments[0]).getResultGeometry(t)}if(3===arguments.length){if(Number.isInteger(arguments[2])&&arguments[0]instanceof O1&&"number"==typeof arguments[1]){var e=arguments[1],n=arguments[2],r=new Z3(arguments[0]);return r.setQuadrantSegments(n),r.getResultGeometry(e)}if(arguments[2]instanceof r3&&arguments[0]instanceof O1&&"number"==typeof arguments[1]){var i=arguments[1];return new Z3(arguments[0],arguments[2]).getResultGeometry(i)}}else if(4===arguments.length){var o=arguments[1],s=arguments[2],a=arguments[3],l=new Z3(arguments[0]);return l.setQuadrantSegments(s),l.setEndCapStyle(a),l.getResultGeometry(o)}},Z3.precisionScaleFactor=function(t,e,n){var r=t.getEnvelopeInternal(),i=K0.max(Math.abs(r.getMaxX()),Math.abs(r.getMaxY()),Math.abs(r.getMinX()),Math.abs(r.getMinY()))+2*(e>0?e:0),o=n-Math.trunc(Math.log(i)/Math.log(10)+1);return Math.pow(10,o)},Y3.CAP_ROUND.get=function(){return r3.CAP_ROUND},Y3.CAP_BUTT.get=function(){return r3.CAP_FLAT},Y3.CAP_FLAT.get=function(){return r3.CAP_FLAT},Y3.CAP_SQUARE.get=function(){return r3.CAP_SQUARE},Y3.MAX_PRECISION_DIGITS.get=function(){return 12},Object.defineProperties(Z3,Y3);var J3=function(){this.Yr=[new W0,new W0],this.ri=B0.NaN,this.se=!0};J3.prototype.getCoordinates=function(){return this.Yr},J3.prototype.getCoordinate=function(t){return this.Yr[t]},J3.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t.Yr[0],t.Yr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.se)return this.initialize(e,n),null;var r=e.distance(n);r<this.ri&&this.initialize(e,n,r)}},J3.prototype.initialize=function(){if(0===arguments.length)this.se=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this.Yr[0].setCoordinate(t),this.Yr[1].setCoordinate(e),this.ri=t.distance(e),this.se=!1}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.Yr[0].setCoordinate(n),this.Yr[1].setCoordinate(r),this.ri=i,this.se=!1}},J3.prototype.getDistance=function(){return this.ri},J3.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t.Yr[0],t.Yr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.se)return this.initialize(e,n),null;var r=e.distance(n);r>this.ri&&this.initialize(e,n,r)}},J3.prototype.interfaces_=function(){return[]},J3.prototype.getClass=function(){return J3};var Q3=function(){};Q3.prototype.interfaces_=function(){return[]},Q3.prototype.getClass=function(){return Q3},Q3.computeDistance=function(){if(arguments[2]instanceof J3&&arguments[0]instanceof k2&&arguments[1]instanceof W0)for(var t=arguments[1],e=arguments[2],n=arguments[0].getCoordinates(),r=new Z5,i=0;i<n.length-1;i++){r.setCoordinates(n[i],n[i+1]);var o=r.closestPoint(t);e.setMinimum(o,t)}else if(arguments[2]instanceof J3&&arguments[0]instanceof F2&&arguments[1]instanceof W0){var s=arguments[0],a=arguments[1],l=arguments[2];Q3.computeDistance(s.getExteriorRing(),a,l);for(var h=0;h<s.getNumInteriorRing();h++)Q3.computeDistance(s.getInteriorRingN(h),a,l)}else if(arguments[2]instanceof J3&&arguments[0]instanceof O1&&arguments[1]instanceof W0){var u=arguments[0],c=arguments[1],f=arguments[2];if(u instanceof k2)Q3.computeDistance(u,c,f);else if(u instanceof F2)Q3.computeDistance(u,c,f);else if(u instanceof x2)for(var d=u,p=0;p<d.getNumGeometries();p++){var g=d.getGeometryN(p);Q3.computeDistance(g,c,f)}else f.setMinimum(u.getCoordinate(),c)}else if(arguments[2]instanceof J3&&arguments[0]instanceof Z5&&arguments[1]instanceof W0){var m=arguments[1],A=arguments[2],y=arguments[0].closestPoint(m);A.setMinimum(y,m)}};var K3=function(t){this.ue=new J3,this.ur=t||null},$3={MaxPointDistanceFilter:{configurable:!0},MaxMidpointDistanceFilter:{configurable:!0}};K3.prototype.computeMaxMidpointDistance=function(t){var e=new e4(this.ur);t.apply(e),this.ue.setMaximum(e.getMaxPointDistance())},K3.prototype.computeMaxVertexDistance=function(t){var e=new t4(this.ur);t.apply(e),this.ue.setMaximum(e.getMaxPointDistance())},K3.prototype.findDistance=function(t){return this.computeMaxVertexDistance(t),this.computeMaxMidpointDistance(t),this.ue.getDistance()},K3.prototype.getDistancePoints=function(){return this.ue},K3.prototype.interfaces_=function(){return[]},K3.prototype.getClass=function(){return K3},$3.MaxPointDistanceFilter.get=function(){return t4},$3.MaxMidpointDistanceFilter.get=function(){return e4},Object.defineProperties(K3,$3);var t4=function(t){this.ue=new J3,this.oe=new J3,this.An=t||null};t4.prototype.filter=function(t){this.oe.initialize(),Q3.computeDistance(this.An,t,this.oe),this.ue.setMaximum(this.oe)},t4.prototype.getMaxPointDistance=function(){return this.ue},t4.prototype.interfaces_=function(){return[L1]},t4.prototype.getClass=function(){return t4};var e4=function(t){this.ue=new J3,this.oe=new J3,this.An=t||null};e4.prototype.filter=function(t,e){if(0===e)return null;var n=t.getCoordinate(e-1),r=t.getCoordinate(e),i=new W0((n.x+r.x)/2,(n.y+r.y)/2);this.oe.initialize(),Q3.computeDistance(this.An,i,this.oe),this.ue.setMaximum(this.oe)},e4.prototype.isDone=function(){return!1},e4.prototype.isGeometryChanged=function(){return!1},e4.prototype.getMaxPointDistance=function(){return this.ue},e4.prototype.interfaces_=function(){return[v2]},e4.prototype.getClass=function(){return e4};var n4=function(t){this.he=t||null};n4.prototype.filter=function(t){t instanceof F2&&this.he.add(t)},n4.prototype.interfaces_=function(){return[y2]},n4.prototype.getClass=function(){return n4},n4.getPolygons=function(){if(1===arguments.length)return n4.getPolygons(arguments[0],new q1);if(2===arguments.length){var t=arguments[0],e=arguments[1];return t instanceof F2?e.add(t):t instanceof x2&&t.apply(new n4(e)),e}};var r4=function(){if(this.ot=null,this.fe=!1,1===arguments.length){var t=arguments[0];this.ot=t}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.ot=e,this.fe=n}};r4.prototype.filter=function(t){if(this.fe&&t instanceof B2){var e=t.getFactory().createLineString(t.getCoordinateSequence());return this.ot.add(e),null}t instanceof k2&&this.ot.add(t)},r4.prototype.setForceToLineString=function(t){this.fe=t},r4.prototype.interfaces_=function(){return[E1]},r4.prototype.getClass=function(){return r4},r4.getGeometry=function(){if(1===arguments.length){var t=arguments[0];return t.getFactory().buildGeometry(r4.getLines(t))}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e.getFactory().buildGeometry(r4.getLines(e,n))}},r4.getLines=function(){if(1===arguments.length)return r4.getLines(arguments[0],!1);if(2===arguments.length){if(Q0(arguments[0],j1)&&Q0(arguments[1],j1)){for(var t=arguments[1],e=arguments[0].iterator();e.hasNext();){var n=e.next();r4.getLines(n,t)}return t}if(arguments[0]instanceof O1&&"boolean"==typeof arguments[1]){var r=arguments[0],i=arguments[1],o=new q1;return r.apply(new r4(o,i)),o}if(arguments[0]instanceof O1&&Q0(arguments[1],j1)){var s=arguments[0],a=arguments[1];return s instanceof k2?a.add(s):s.apply(new r4(a)),a}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&Q0(arguments[0],j1)&&Q0(arguments[1],j1)){for(var l=arguments[1],h=arguments[2],u=arguments[0].iterator();u.hasNext();){var c=u.next();r4.getLines(c,l,h)}return l}if("boolean"==typeof arguments[2]&&arguments[0]instanceof O1&&Q0(arguments[1],j1)){var f=arguments[1],d=arguments[2];return arguments[0].apply(new r4(f,d)),f}}};var i4=function(){if(this.ce=D1.OGC_SFS_BOUNDARY_RULE,this.ae=null,this.ve=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];if(null===t)throw new z0("Rule must be non-null");this.ce=t}};i4.prototype.locateInternal=function(){if(arguments[0]instanceof W0&&arguments[1]instanceof F2){var t=arguments[0],e=arguments[1];if(e.isEmpty())return Y0.EXTERIOR;var n=e.getExteriorRing(),r=this.locateInPolygonRing(t,n);if(r===Y0.EXTERIOR)return Y0.EXTERIOR;if(r===Y0.BOUNDARY)return Y0.BOUNDARY;for(var i=0;i<e.getNumInteriorRing();i++){var o=e.getInteriorRingN(i),s=this.locateInPolygonRing(t,o);if(s===Y0.INTERIOR)return Y0.EXTERIOR;if(s===Y0.BOUNDARY)return Y0.BOUNDARY}return Y0.INTERIOR}if(arguments[0]instanceof W0&&arguments[1]instanceof k2){var a=arguments[0],l=arguments[1];if(!l.getEnvelopeInternal().intersects(a))return Y0.EXTERIOR;var h=l.getCoordinates();return l.isClosed()||!a.equals(h[0])&&!a.equals(h[h.length-1])?I1.isOnLine(a,h)?Y0.INTERIOR:Y0.EXTERIOR:Y0.BOUNDARY}if(arguments[0]instanceof W0&&arguments[1]instanceof D2){var u=arguments[0];return arguments[1].getCoordinate().equals2D(u)?Y0.INTERIOR:Y0.EXTERIOR}},i4.prototype.locateInPolygonRing=function(t,e){return e.getEnvelopeInternal().intersects(t)?I1.locatePointInRing(t,e.getCoordinates()):Y0.EXTERIOR},i4.prototype.intersects=function(t,e){return this.locate(t,e)!==Y0.EXTERIOR},i4.prototype.updateLocationInfo=function(t){t===Y0.INTERIOR&&(this.ae=!0),t===Y0.BOUNDARY&&this.ve++},i4.prototype.computeLocation=function(t,e){var n=this;if(e instanceof D2&&this.updateLocationInfo(this.locateInternal(t,e)),e instanceof k2)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof F2)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof _2)for(var r=e,i=0;i<r.getNumGeometries();i++){var o=r.getGeometryN(i);n.updateLocationInfo(n.locateInternal(t,o))}else if(e instanceof H2)for(var s=e,a=0;a<s.getNumGeometries();a++){var l=s.getGeometryN(a);n.updateLocationInfo(n.locateInternal(t,l))}else if(e instanceof x2)for(var h=new x3(e);h.hasNext();){var u=h.next();u!==e&&n.computeLocation(t,u)}},i4.prototype.locate=function(t,e){return e.isEmpty()?Y0.EXTERIOR:e instanceof k2||e instanceof F2?this.locateInternal(t,e):(this.ae=!1,this.ve=0,this.computeLocation(t,e),this.ce.isInBoundary(this.ve)?Y0.BOUNDARY:this.ve>0||this.ae?Y0.INTERIOR:Y0.EXTERIOR)},i4.prototype.interfaces_=function(){return[]},i4.prototype.getClass=function(){return i4};var o4=function t(){if(this.we=null,this.Pe=null,this.Yr=null,2===arguments.length)t.call(this,arguments[0],t.INSIDE_AREA,arguments[1]);else if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2];this.we=e,this.Pe=n,this.Yr=r}},s4={INSIDE_AREA:{configurable:!0}};o4.prototype.isInsideArea=function(){return this.Pe===o4.INSIDE_AREA},o4.prototype.getCoordinate=function(){return this.Yr},o4.prototype.getGeometryComponent=function(){return this.we},o4.prototype.getSegmentIndex=function(){return this.Pe},o4.prototype.interfaces_=function(){return[]},o4.prototype.getClass=function(){return o4},s4.INSIDE_AREA.get=function(){return-1},Object.defineProperties(o4,s4);var a4=function(t){this.dn=t||null};a4.prototype.filter=function(t){t instanceof D2&&this.dn.add(t)},a4.prototype.interfaces_=function(){return[y2]},a4.prototype.getClass=function(){return a4},a4.getPoints=function(){if(1===arguments.length){var t=arguments[0];return t instanceof D2?k5.singletonList(t):a4.getPoints(t,new q1)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e instanceof D2?n.add(e):e instanceof x2&&e.apply(new a4(n)),n}};var l4=function(){this.Ce=null;var t=arguments[0];this.Ce=t};l4.prototype.filter=function(t){(t instanceof D2||t instanceof k2||t instanceof F2)&&this.Ce.add(new o4(t,0,t.getCoordinate()))},l4.prototype.interfaces_=function(){return[y2]},l4.prototype.getClass=function(){return l4},l4.getLocations=function(t){var e=new q1;return t.apply(new l4(e)),e};var h4=function(){if(this.An=null,this.De=0,this.Ie=new i4,this.be=null,this.Me=B0.MAX_VALUE,2===arguments.length){var t=arguments[0],e=arguments[1];this.An=[t,e],this.De=0}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.An=new Array(2).fill(null),this.An[0]=n,this.An[1]=r,this.De=i}};h4.prototype.computeContainmentDistance=function(){var t=this;if(0===arguments.length){var e=new Array(2).fill(null);if(this.computeContainmentDistance(0,e),this.Me<=this.De)return null;this.computeContainmentDistance(1,e)}else if(2===arguments.length){var n=arguments[0],r=arguments[1],i=1-n,o=n4.getPolygons(this.An[n]);if(o.size()>0){var s=l4.getLocations(this.An[i]);if(this.computeContainmentDistance(s,o,r),this.Me<=this.De)return this.be[i]=r[0],this.be[n]=r[1],null}}else if(3===arguments.length)if(arguments[2]instanceof Array&&Q0(arguments[0],G1)&&Q0(arguments[1],G1)){for(var a=arguments[0],l=arguments[1],h=arguments[2],u=0;u<a.size();u++)for(var c=a.get(u),f=0;f<l.size();f++)if(t.computeContainmentDistance(c,l.get(f),h),t.Me<=t.De)return null}else if(arguments[2]instanceof Array&&arguments[0]instanceof o4&&arguments[1]instanceof F2){var d=arguments[0],p=arguments[1],g=arguments[2],m=d.getCoordinate();if(Y0.EXTERIOR!==this.Ie.locate(m,p))return this.Me=0,g[0]=d,g[1]=new o4(p,m),null}},h4.prototype.computeMinDistanceLinesPoints=function(t,e,n){for(var r=this,i=0;i<t.size();i++)for(var o=t.get(i),s=0;s<e.size();s++){var a=e.get(s);if(r.computeMinDistance(o,a,n),r.Me<=r.De)return null}},h4.prototype.computeFacetDistance=function(){var t=new Array(2).fill(null),e=r4.getLines(this.An[0]),n=r4.getLines(this.An[1]),r=a4.getPoints(this.An[0]),i=a4.getPoints(this.An[1]);return this.computeMinDistanceLines(e,n,t),this.updateMinDistance(t,!1),this.Me<=this.De?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(e,i,t),this.updateMinDistance(t,!1),this.Me<=this.De?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(n,r,t),this.updateMinDistance(t,!0),this.Me<=this.De?null:(t[0]=null,t[1]=null,this.computeMinDistancePoints(r,i,t),void this.updateMinDistance(t,!1))))},h4.prototype.nearestLocations=function(){return this.computeMinDistance(),this.be},h4.prototype.updateMinDistance=function(t,e){if(null===t[0])return null;e?(this.be[0]=t[1],this.be[1]=t[0]):(this.be[0]=t[0],this.be[1]=t[1])},h4.prototype.nearestPoints=function(){return this.computeMinDistance(),[this.be[0].getCoordinate(),this.be[1].getCoordinate()]},h4.prototype.computeMinDistance=function(){var t=this;if(0===arguments.length){if(null!==this.be)return null;if(this.be=new Array(2).fill(null),this.computeContainmentDistance(),this.Me<=this.De)return null;this.computeFacetDistance()}else if(3===arguments.length)if(arguments[2]instanceof Array&&arguments[0]instanceof k2&&arguments[1]instanceof D2){var e=arguments[0],n=arguments[1],r=arguments[2];if(e.getEnvelopeInternal().distance(n.getEnvelopeInternal())>this.Me)return null;for(var i=e.getCoordinates(),o=n.getCoordinate(),s=0;s<i.length-1;s++){var a=I1.distancePointLine(o,i[s],i[s+1]);if(a<t.Me){t.Me=a;var l=new Z5(i[s],i[s+1]).closestPoint(o);r[0]=new o4(e,s,l),r[1]=new o4(n,0,o)}if(t.Me<=t.De)return null}}else if(arguments[2]instanceof Array&&arguments[0]instanceof k2&&arguments[1]instanceof k2){var h=arguments[0],u=arguments[1],c=arguments[2];if(h.getEnvelopeInternal().distance(u.getEnvelopeInternal())>this.Me)return null;for(var f=h.getCoordinates(),d=u.getCoordinates(),p=0;p<f.length-1;p++)for(var g=0;g<d.length-1;g++){var m=I1.distanceLineLine(f[p],f[p+1],d[g],d[g+1]);if(m<t.Me){t.Me=m;var A=new Z5(f[p],f[p+1]),y=new Z5(d[g],d[g+1]),v=A.closestPoints(y);c[0]=new o4(h,p,v[0]),c[1]=new o4(u,g,v[1])}if(t.Me<=t.De)return null}}},h4.prototype.computeMinDistancePoints=function(t,e,n){for(var r=this,i=0;i<t.size();i++)for(var o=t.get(i),s=0;s<e.size();s++){var a=e.get(s),l=o.getCoordinate().distance(a.getCoordinate());if(l<r.Me&&(r.Me=l,n[0]=new o4(o,0,o.getCoordinate()),n[1]=new o4(a,0,a.getCoordinate())),r.Me<=r.De)return null}},h4.prototype.distance=function(){if(null===this.An[0]||null===this.An[1])throw new z0("null geometries are not supported");return this.An[0].isEmpty()||this.An[1].isEmpty()?0:(this.computeMinDistance(),this.Me)},h4.prototype.computeMinDistanceLines=function(t,e,n){for(var r=this,i=0;i<t.size();i++)for(var o=t.get(i),s=0;s<e.size();s++){var a=e.get(s);if(r.computeMinDistance(o,a,n),r.Me<=r.De)return null}},h4.prototype.interfaces_=function(){return[]},h4.prototype.getClass=function(){return h4},h4.distance=function(t,e){return new h4(t,e).distance()},h4.isWithinDistance=function(t,e,n){return new h4(t,e,n).distance()<=n},h4.nearestPoints=function(t,e){return new h4(t,e).nearestPoints()};var u4=function(){this.Yr=[new W0,new W0],this.ri=B0.NaN,this.se=!0};u4.prototype.getCoordinates=function(){return this.Yr},u4.prototype.getCoordinate=function(t){return this.Yr[t]},u4.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t.Yr[0],t.Yr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.se)return this.initialize(e,n),null;var r=e.distance(n);r<this.ri&&this.initialize(e,n,r)}},u4.prototype.initialize=function(){if(0===arguments.length)this.se=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this.Yr[0].setCoordinate(t),this.Yr[1].setCoordinate(e),this.ri=t.distance(e),this.se=!1}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.Yr[0].setCoordinate(n),this.Yr[1].setCoordinate(r),this.ri=i,this.se=!1}},u4.prototype.toString=function(){return v1.toLineString(this.Yr[0],this.Yr[1])},u4.prototype.getDistance=function(){return this.ri},u4.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t.Yr[0],t.Yr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.se)return this.initialize(e,n),null;var r=e.distance(n);r>this.ri&&this.initialize(e,n,r)}},u4.prototype.interfaces_=function(){return[]},u4.prototype.getClass=function(){return u4};var c4=function(){};c4.prototype.interfaces_=function(){return[]},c4.prototype.getClass=function(){return c4},c4.computeDistance=function(){if(arguments[2]instanceof u4&&arguments[0]instanceof k2&&arguments[1]instanceof W0)for(var t=arguments[0],e=arguments[1],n=arguments[2],r=new Z5,i=t.getCoordinates(),o=0;o<i.length-1;o++){r.setCoordinates(i[o],i[o+1]);var s=r.closestPoint(e);n.setMinimum(s,e)}else if(arguments[2]instanceof u4&&arguments[0]instanceof F2&&arguments[1]instanceof W0){var a=arguments[0],l=arguments[1],h=arguments[2];c4.computeDistance(a.getExteriorRing(),l,h);for(var u=0;u<a.getNumInteriorRing();u++)c4.computeDistance(a.getInteriorRingN(u),l,h)}else if(arguments[2]instanceof u4&&arguments[0]instanceof O1&&arguments[1]instanceof W0){var c=arguments[0],f=arguments[1],d=arguments[2];if(c instanceof k2)c4.computeDistance(c,f,d);else if(c instanceof F2)c4.computeDistance(c,f,d);else if(c instanceof x2)for(var p=c,g=0;g<p.getNumGeometries();g++){var m=p.getGeometryN(g);c4.computeDistance(m,f,d)}else d.setMinimum(c.getCoordinate(),f)}else if(arguments[2]instanceof u4&&arguments[0]instanceof Z5&&arguments[1]instanceof W0){var A=arguments[1],y=arguments[2],v=arguments[0].closestPoint(A);y.setMinimum(v,A)}};var f4=function(){this.ze=null,this.de=null,this.xe=new u4,this.me=0;var t=arguments[0],e=arguments[1];this.ze=t,this.de=e},d4={MaxPointDistanceFilter:{configurable:!0},MaxDensifiedByFractionDistanceFilter:{configurable:!0}};f4.prototype.getCoordinates=function(){return this.xe.getCoordinates()},f4.prototype.setDensifyFraction=function(t){if(t>1||t<=0)throw new z0("Fraction is not in range (0.0 - 1.0]");this.me=t},f4.prototype.compute=function(t,e){this.computeOrientedDistance(t,e,this.xe),this.computeOrientedDistance(e,t,this.xe)},f4.prototype.distance=function(){return this.compute(this.ze,this.de),this.xe.getDistance()},f4.prototype.computeOrientedDistance=function(t,e,n){var r=new p4(e);if(t.apply(r),n.setMaximum(r.getMaxPointDistance()),this.me>0){var i=new g4(e,this.me);t.apply(i),n.setMaximum(i.getMaxPointDistance())}},f4.prototype.orientedDistance=function(){return this.computeOrientedDistance(this.ze,this.de,this.xe),this.xe.getDistance()},f4.prototype.interfaces_=function(){return[]},f4.prototype.getClass=function(){return f4},f4.distance=function(){if(2===arguments.length)return new f4(arguments[0],arguments[1]).distance();if(3===arguments.length){var t=arguments[2],e=new f4(arguments[0],arguments[1]);return e.setDensifyFraction(t),e.distance()}},d4.MaxPointDistanceFilter.get=function(){return p4},d4.MaxDensifiedByFractionDistanceFilter.get=function(){return g4},Object.defineProperties(f4,d4);var p4=function(){this.ue=new u4,this.oe=new u4,this.ye=new c4,this.An=null;var t=arguments[0];this.An=t};p4.prototype.filter=function(t){this.oe.initialize(),c4.computeDistance(this.An,t,this.oe),this.ue.setMaximum(this.oe)},p4.prototype.getMaxPointDistance=function(){return this.ue},p4.prototype.interfaces_=function(){return[L1]},p4.prototype.getClass=function(){return p4};var g4=function(){this.ue=new u4,this.oe=new u4,this.An=null,this.pe=0;var t=arguments[0],e=arguments[1];this.An=t,this.pe=Math.trunc(Math.round(1/e))};g4.prototype.filter=function(t,e){var n=this;if(0===e)return null;for(var r=t.getCoordinate(e-1),i=t.getCoordinate(e),o=(i.x-r.x)/this.pe,s=(i.y-r.y)/this.pe,a=0;a<this.pe;a++){var l=r.x+a*o,h=r.y+a*s,u=new W0(l,h);n.oe.initialize(),c4.computeDistance(n.An,u,n.oe),n.ue.setMaximum(n.oe)}},g4.prototype.isDone=function(){return!1},g4.prototype.isGeometryChanged=function(){return!1},g4.prototype.getMaxPointDistance=function(){return this.ue},g4.prototype.interfaces_=function(){return[v2]},g4.prototype.getClass=function(){return g4};var m4=function(t,e,n){this.Le=null,this.Te=null,this.Oe=null,this.Fe=null,this.Ue=!0,this.Ee=null,this.Ne=null,this.je=null,this.Qe=t||null,this.Se=e||null,this.Bt=n||null},A4={VERBOSE:{configurable:!0},MAX_DISTANCE_DIFF_FRAC:{configurable:!0}};m4.prototype.checkMaximumDistance=function(t,e,n){var r=new f4(e,t);if(r.setDensifyFraction(.25),this.Fe=r.orientedDistance(),this.Fe>n){this.Ue=!1;var i=r.getCoordinates();this.Ne=i[1],this.je=t.getFactory().createLineString(i),this.Ee="Distance between buffer curve and input is too large ("+this.Fe+" at "+v1.toLineString(i[0],i[1])+")"}},m4.prototype.isValid=function(){var t=Math.abs(this.Se),e=m4.MAX_DISTANCE_DIFF_FRAC*t;return this.Le=t-e,this.Te=t+e,!(!this.Qe.isEmpty()&&!this.Bt.isEmpty())||(this.Se>0?this.checkPositiveValid():this.checkNegativeValid(),m4.VERBOSE&&c1.out.println("Min Dist= "+this.Oe+"  err= "+(1-this.Oe/this.Se)+"  Max Dist= "+this.Fe+"  err= "+(this.Fe/this.Se-1)),this.Ue)},m4.prototype.checkNegativeValid=function(){if(!(this.Qe instanceof F2||this.Qe instanceof H2||this.Qe instanceof x2))return null;var t=this.getPolygonLines(this.Qe);if(this.checkMinimumDistance(t,this.Bt,this.Le),!this.Ue)return null;this.checkMaximumDistance(t,this.Bt,this.Te)},m4.prototype.getErrorIndicator=function(){return this.je},m4.prototype.checkMinimumDistance=function(t,e,n){var r=new h4(t,e,n);if(this.Oe=r.distance(),this.Oe<n){this.Ue=!1;var i=r.nearestPoints();this.Ne=r.nearestPoints()[1],this.je=t.getFactory().createLineString(i),this.Ee="Distance between buffer curve and input is too small ("+this.Oe+" at "+v1.toLineString(i[0],i[1])+" )"}},m4.prototype.checkPositiveValid=function(){var t=this.Bt.getBoundary();if(this.checkMinimumDistance(this.Qe,t,this.Le),!this.Ue)return null;this.checkMaximumDistance(this.Qe,t,this.Te)},m4.prototype.getErrorLocation=function(){return this.Ne},m4.prototype.getPolygonLines=function(t){for(var e=new q1,n=new r4(e),r=n4.getPolygons(t).iterator();r.hasNext();)r.next().apply(n);return t.getFactory().buildGeometry(e)},m4.prototype.getErrorMessage=function(){return this.Ee},m4.prototype.interfaces_=function(){return[]},m4.prototype.getClass=function(){return m4},A4.VERBOSE.get=function(){return!1},A4.MAX_DISTANCE_DIFF_FRAC.get=function(){return.012},Object.defineProperties(m4,A4);var y4=function(t,e,n){this.Ue=!0,this.Be=null,this.Ne=null,this.je=null,this.Qe=t||null,this.ri=e||null,this.Bt=n||null},v4={VERBOSE:{configurable:!0},MAX_ENV_DIFF_FRAC:{configurable:!0}};y4.prototype.isValid=function(){return this.checkPolygonal(),this.Ue?(this.checkExpectedEmpty(),this.Ue?(this.checkEnvelope(),this.Ue?(this.checkArea(),this.Ue?(this.checkDistance(),this.Ue):this.Ue):this.Ue):this.Ue):this.Ue},y4.prototype.checkEnvelope=function(){if(this.ri<0)return null;var t=this.ri*y4.MAX_ENV_DIFF_FRAC;0===t&&(t=.001);var e=new d1(this.Qe.getEnvelopeInternal());e.expandBy(this.ri);var n=new d1(this.Bt.getEnvelopeInternal());n.expandBy(t),n.contains(e)||(this.Ue=!1,this.Be="Buffer envelope is incorrect",this.je=this.Qe.getFactory().toGeometry(n)),this.report("Envelope")},y4.prototype.checkDistance=function(){var t=new m4(this.Qe,this.ri,this.Bt);t.isValid()||(this.Ue=!1,this.Be=t.getErrorMessage(),this.Ne=t.getErrorLocation(),this.je=t.getErrorIndicator()),this.report("Distance")},y4.prototype.checkArea=function(){var t=this.Qe.getArea(),e=this.Bt.getArea();this.ri>0&&t>e&&(this.Ue=!1,this.Be="Area of positive buffer is smaller than input",this.je=this.Bt),this.ri<0&&t<e&&(this.Ue=!1,this.Be="Area of negative buffer is larger than input",this.je=this.Bt),this.report("Area")},y4.prototype.checkPolygonal=function(){this.Bt instanceof F2||this.Bt instanceof H2||(this.Ue=!1),this.Be="Result is not polygonal",this.je=this.Bt,this.report("Polygonal")},y4.prototype.getErrorIndicator=function(){return this.je},y4.prototype.getErrorLocation=function(){return this.Ne},y4.prototype.checkExpectedEmpty=function(){return this.Qe.getDimension()>=2||this.ri>0?null:(this.Bt.isEmpty()||(this.Ue=!1,this.Be="Result is non-empty",this.je=this.Bt),void this.report("ExpectedEmpty"))},y4.prototype.report=function(t){if(!y4.VERBOSE)return null;c1.out.println("Check "+t+": "+(this.Ue?"passed":"FAILED"))},y4.prototype.getErrorMessage=function(){return this.Be},y4.prototype.interfaces_=function(){return[]},y4.prototype.getClass=function(){return y4},y4.isValidMsg=function(t,e,n){var r=new y4(t,e,n);return r.isValid()?null:r.getErrorMessage()},y4.isValid=function(t,e,n){return!!new y4(t,e,n).isValid()},v4.VERBOSE.get=function(){return!1},v4.MAX_ENV_DIFF_FRAC.get=function(){return.012},Object.defineProperties(y4,v4);var x4=function(){this.dn=null,this.wi=null;var t=arguments[0],e=arguments[1];this.dn=t,this.wi=e};x4.prototype.getCoordinates=function(){return this.dn},x4.prototype.size=function(){return this.dn.length},x4.prototype.getCoordinate=function(t){return this.dn[t]},x4.prototype.isClosed=function(){return this.dn[0].equals(this.dn[this.dn.length-1])},x4.prototype.getSegmentOctant=function(t){return t===this.dn.length-1?-1:G5.octant(this.getCoordinate(t),this.getCoordinate(t+1))},x4.prototype.setData=function(t){this.wi=t},x4.prototype.getData=function(){return this.wi},x4.prototype.toString=function(){return v1.toLineString(new q2(this.dn))},x4.prototype.interfaces_=function(){return[W5]},x4.prototype.getClass=function(){return x4};var _4=function(){this.ke=!1,this.Re=!1,this.Wi=null,this.Ge=null,this.Ye=null,this.qe=new q1,this.Ve=0,this.We=!0;var t=arguments[0];this.Wi=t,this.Ge=null};_4.prototype.getInteriorIntersection=function(){return this.Ge},_4.prototype.setCheckEndSegmentsOnly=function(t){this.Re=t},_4.prototype.getIntersectionSegments=function(){return this.Ye},_4.prototype.count=function(){return this.Ve},_4.prototype.getIntersections=function(){return this.qe},_4.prototype.setFindAllIntersections=function(t){this.ke=t},_4.prototype.setKeepIntersections=function(t){this.We=t},_4.prototype.processIntersections=function(t,e,n,r){if(!this.ke&&this.hasIntersection())return null;if(t===n&&e===r)return null;if(this.Re&&!this.isEndSegment(t,e)&&!this.isEndSegment(n,r))return null;var i=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Wi.computeIntersection(i,o,s,a),this.Wi.hasIntersection()&&this.Wi.isInteriorIntersection()&&(this.Ye=new Array(4).fill(null),this.Ye[0]=i,this.Ye[1]=o,this.Ye[2]=s,this.Ye[3]=a,this.Ge=this.Wi.getIntersection(0),this.We&&this.qe.add(this.Ge),this.Ve++)},_4.prototype.isEndSegment=function(t,e){return 0===e||e>=t.size()-2},_4.prototype.hasIntersection=function(){return null!==this.Ge},_4.prototype.isDone=function(){return!this.ke&&null!==this.Ge},_4.prototype.interfaces_=function(){return[S3]},_4.prototype.getClass=function(){return _4},_4.createAllIntersectionsFinder=function(t){var e=new _4(t);return e.setFindAllIntersections(!0),e},_4.createAnyIntersectionFinder=function(t){return new _4(t)},_4.createIntersectionCounter=function(t){var e=new _4(t);return e.setFindAllIntersections(!0),e.setKeepIntersections(!1),e};var b4=function(){this.Wi=new M1,this.Gr=null,this.ke=!1,this.Mi=null,this.Ue=!0;var t=arguments[0];this.Gr=t};b4.prototype.execute=function(){if(null!==this.Mi)return null;this.checkInteriorIntersections()},b4.prototype.getIntersections=function(){return this.Mi.getIntersections()},b4.prototype.isValid=function(){return this.execute(),this.Ue},b4.prototype.setFindAllIntersections=function(t){this.ke=t},b4.prototype.checkInteriorIntersections=function(){this.Ue=!0,this.Mi=new _4(this.Wi),this.Mi.setFindAllIntersections(this.ke);var t=new e3;if(t.setSegmentIntersector(this.Mi),t.computeNodes(this.Gr),this.Mi.hasIntersection())return this.Ue=!1,null},b4.prototype.checkValid=function(){if(this.execute(),!this.Ue)throw new l5(this.getErrorMessage(),this.Mi.getInteriorIntersection())},b4.prototype.getErrorMessage=function(){if(this.Ue)return"no intersections found";var t=this.Mi.getIntersectionSegments();return"found non-noded intersection between "+v1.toLineString(t[0],t[1])+" and "+v1.toLineString(t[2],t[3])},b4.prototype.interfaces_=function(){return[]},b4.prototype.getClass=function(){return b4},b4.computeIntersections=function(t){var e=new b4(t);return e.setFindAllIntersections(!0),e.isValid(),e.getIntersections()};var w4=function t(){this._e=null;var e=arguments[0];this._e=new b4(t.toSegmentStrings(e))};w4.prototype.checkValid=function(){this._e.checkValid()},w4.prototype.interfaces_=function(){return[]},w4.prototype.getClass=function(){return w4},w4.toSegmentStrings=function(t){for(var e=new q1,n=t.iterator();n.hasNext();){var r=n.next();e.add(new x4(r.getCoordinates(),r))}return e},w4.checkValid=function(t){new w4(t).checkValid()};var T4=function(t){this.Ke=t};T4.prototype.map=function(t){for(var e=new q1,n=0;n<t.getNumGeometries();n++){var r=this.Ke.map(t.getGeometryN(n));r.isEmpty()||e.add(r)}return t.getFactory().createGeometryCollection(e5.toGeometryArray(e))},T4.prototype.interfaces_=function(){return[]},T4.prototype.getClass=function(){return T4},T4.map=function(t,e){return new T4(e).map(t)};var M4=function(){this.He=null,this.pn=null,this.Ie=null,this.Je=new q1,this.Ze=new q1;var t=arguments[0],e=arguments[1],n=arguments[2];this.He=t,this.pn=e,this.Ie=n};M4.prototype.collectLines=function(t){for(var e=this,n=this.He.getGraph().getEdgeEnds().iterator();n.hasNext();){var r=n.next();e.collectLineEdge(r,t,e.Je),e.collectBoundaryTouchEdge(r,t,e.Je)}},M4.prototype.labelIsolatedLine=function(t,e){var n=this.Ie.locate(t.getCoordinate(),this.He.getArgGeometry(e));t.getLabel().setLocation(e,n)},M4.prototype.build=function(t){return this.findCoveredLineEdges(),this.collectLines(t),this.buildLines(t),this.Ze},M4.prototype.collectLineEdge=function(t,e,n){var r=t.getLabel(),i=t.getEdge();t.isLineEdge()&&(t.isVisited()||!o6.isResultOfOp(r,e)||i.isCovered()||(n.add(i),t.setVisitedEdge(!0)))},M4.prototype.findCoveredLineEdges=function(){for(var t=this.He.getGraph().getNodes().iterator();t.hasNext();)t.next().getEdges().findCoveredLineEdges();for(var e=this.He.getGraph().getEdgeEnds().iterator();e.hasNext();){var n=e.next(),r=n.getEdge();if(n.isLineEdge()&&!r.isCoveredSet()){var i=this.He.isCoveredByA(n.getCoordinate());r.setCovered(i)}}},M4.prototype.labelIsolatedLines=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),r=n.getLabel();n.isIsolated()&&(r.isNull(0)?this.labelIsolatedLine(n,0):this.labelIsolatedLine(n,1))}},M4.prototype.buildLines=function(t){for(var e=this.Je.iterator();e.hasNext();){var n=e.next(),r=this.pn.createLineString(n.getCoordinates());this.Ze.add(r),n.setInResult(!0)}},M4.prototype.collectBoundaryTouchEdge=function(t,e,n){var r=t.getLabel();return t.isLineEdge()||t.isVisited()||t.isInteriorAreaEdge()||t.getEdge().isInResult()?null:(b1.isTrue(!(t.isInResult()||t.getSym().isInResult())||!t.getEdge().isInResult()),void(o6.isResultOfOp(r,e)&&e===o6.INTERSECTION&&(n.add(t.getEdge()),t.setVisitedEdge(!0))))},M4.prototype.interfaces_=function(){return[]},M4.prototype.getClass=function(){return M4};var C4=function(){this.He=null,this.pn=null,this.Xe=new q1;var t=arguments[0],e=arguments[1];this.He=t,this.pn=e};C4.prototype.filterCoveredNodeToPoint=function(t){var e=t.getCoordinate();if(!this.He.isCoveredByLA(e)){var n=this.pn.createPoint(e);this.Xe.add(n)}},C4.prototype.extractNonCoveredResultNodes=function(t){for(var e=this.He.getGraph().getNodes().iterator();e.hasNext();){var n=e.next();if(!(n.isInResult()||n.isIncidentEdgeInResult()||0!==n.getEdges().getDegree()&&t!==o6.INTERSECTION)){var r=n.getLabel();o6.isResultOfOp(r,t)&&this.filterCoveredNodeToPoint(n)}}},C4.prototype.build=function(t){return this.extractNonCoveredResultNodes(t),this.Xe},C4.prototype.interfaces_=function(){return[]},C4.prototype.getClass=function(){return C4};var S4=function(){this.ur=null,this.Zt=null,this.$e=!0,this.As=!0,this.ts=!1,this.ns=!1};S4.prototype.transformPoint=function(t,e){return this.Zt.createPoint(this.transformCoordinates(t.getCoordinateSequence(),t))},S4.prototype.transformPolygon=function(t,e){var n=!0,r=this.transformLinearRing(t.getExteriorRing(),t);null!==r&&r instanceof B2&&!r.isEmpty()||(n=!1);for(var i=new q1,o=0;o<t.getNumInteriorRing();o++){var s=this.transformLinearRing(t.getInteriorRingN(o),t);null===s||s.isEmpty()||(s instanceof B2||(n=!1),i.add(s))}if(n)return this.Zt.createPolygon(r,i.toArray([]));var a=new q1;return null!==r&&a.add(r),a.addAll(i),this.Zt.buildGeometry(a)},S4.prototype.createCoordinateSequence=function(t){return this.Zt.getCoordinateSequenceFactory().create(t)},S4.prototype.getInputGeometry=function(){return this.ur},S4.prototype.transformMultiLineString=function(t,e){for(var n=new q1,r=0;r<t.getNumGeometries();r++){var i=this.transformLineString(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},S4.prototype.transformCoordinates=function(t,e){return this.copy(t)},S4.prototype.transformLineString=function(t,e){return this.Zt.createLineString(this.transformCoordinates(t.getCoordinateSequence(),t))},S4.prototype.transformMultiPoint=function(t,e){for(var n=new q1,r=0;r<t.getNumGeometries();r++){var i=this.transformPoint(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},S4.prototype.transformMultiPolygon=function(t,e){for(var n=new q1,r=0;r<t.getNumGeometries();r++){var i=this.transformPolygon(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},S4.prototype.copy=function(t){return t.copy()},S4.prototype.transformGeometryCollection=function(t,e){for(var n=new q1,r=0;r<t.getNumGeometries();r++){var i=this.transform(t.getGeometryN(r));null!==i&&(this.$e&&i.isEmpty()||n.add(i))}return this.As?this.Zt.createGeometryCollection(e5.toGeometryArray(n)):this.Zt.buildGeometry(n)},S4.prototype.transform=function(t){if(this.ur=t,this.Zt=t.getFactory(),t instanceof D2)return this.transformPoint(t,null);if(t instanceof z2)return this.transformMultiPoint(t,null);if(t instanceof B2)return this.transformLinearRing(t,null);if(t instanceof k2)return this.transformLineString(t,null);if(t instanceof _2)return this.transformMultiLineString(t,null);if(t instanceof F2)return this.transformPolygon(t,null);if(t instanceof H2)return this.transformMultiPolygon(t,null);if(t instanceof x2)return this.transformGeometryCollection(t,null);throw new z0("Unknown Geometry subtype: "+t.getClass().getName())},S4.prototype.transformLinearRing=function(t,e){var n=this.transformCoordinates(t.getCoordinateSequence(),t);if(null===n)return this.Zt.createLinearRing(null);var r=n.size();return r>0&&r<4&&!this.ns?this.Zt.createLineString(n):this.Zt.createLinearRing(n)},S4.prototype.interfaces_=function(){return[]},S4.prototype.getClass=function(){return S4};var I4=function t(){if(this.rs=0,this.es=null,this.ir=new Z5,this.ss=!1,this.us=!1,arguments[0]instanceof k2&&"number"==typeof arguments[1]){var e=arguments[1];t.call(this,arguments[0].getCoordinates(),e)}else if(arguments[0]instanceof Array&&"number"==typeof arguments[1]){var n=arguments[0],r=arguments[1];this.es=n,this.us=t.isClosed(n),this.rs=r}};I4.prototype.snapVertices=function(t,e){for(var n=this.us?t.size()-1:t.size(),r=0;r<n;r++){var i=t.get(r),o=this.findSnapForVertex(i,e);null!==o&&(t.set(r,new W0(o)),0===r&&this.us&&t.set(t.size()-1,new W0(o)))}},I4.prototype.findSnapForVertex=function(t,e){for(var n=0;n<e.length;n++){if(t.equals2D(e[n]))return null;if(t.distance(e[n])<this.rs)return e[n]}return null},I4.prototype.snapTo=function(t){var e=new Z1(this.es);return this.snapVertices(e,t),this.snapSegments(e,t),e.toCoordinateArray()},I4.prototype.snapSegments=function(t,e){if(0===e.length)return null;var n=e.length;e[0].equals2D(e[e.length-1])&&(n=e.length-1);for(var r=0;r<n;r++){var i=e[r],o=this.findSegmentIndexToSnap(i,t);o>=0&&t.add(o+1,new W0(i),!1)}},I4.prototype.findSegmentIndexToSnap=function(t,e){for(var n=this,r=B0.MAX_VALUE,i=-1,o=0;o<e.size()-1;o++){if(n.ir.p0=e.get(o),n.ir.p1=e.get(o+1),n.ir.p0.equals2D(t)||n.ir.p1.equals2D(t)){if(n.ss)continue;return-1}var s=n.ir.distance(t);s<n.rs&&s<r&&(r=s,i=o)}return i},I4.prototype.setAllowSnappingToSourceVertices=function(t){this.ss=t},I4.prototype.interfaces_=function(){return[]},I4.prototype.getClass=function(){return I4},I4.isClosed=function(t){return!(t.length<=1)&&t[0].equals2D(t[t.length-1])};var P4=function(t){this.os=t||null},E4={SNAP_PRECISION_FACTOR:{configurable:!0}};P4.prototype.snapTo=function(t,e){var n=this.extractTargetCoordinates(t);return new O4(e,n).transform(this.os)},P4.prototype.snapToSelf=function(t,e){var n=this.extractTargetCoordinates(this.os),r=new O4(t,n,!0).transform(this.os),i=r;return e&&Q0(i,N2)&&(i=r.buffer(0)),i},P4.prototype.computeSnapTolerance=function(t){return this.computeMinimumSegmentLength(t)/10},P4.prototype.extractTargetCoordinates=function(t){for(var e=new d2,n=t.getCoordinates(),r=0;r<n.length;r++)e.add(n[r]);return e.toArray(new Array(0).fill(null))},P4.prototype.computeMinimumSegmentLength=function(t){for(var e=B0.MAX_VALUE,n=0;n<t.length-1;n++){var r=t[n].distance(t[n+1]);r<e&&(e=r)}return e},P4.prototype.interfaces_=function(){return[]},P4.prototype.getClass=function(){return P4},P4.snap=function(t,e,n){var r=new Array(2).fill(null),i=new P4(t);r[0]=i.snapTo(e,n);var o=new P4(e);return r[1]=o.snapTo(r[0],n),r},P4.computeOverlaySnapTolerance=function(){if(1===arguments.length){var t=arguments[0],e=P4.computeSizeBasedSnapTolerance(t),n=t.getPrecisionModel();if(n.getType()===Q2.FIXED){var r=1/n.getScale()*2/1.415;r>e&&(e=r)}return e}if(2===arguments.length){var i=arguments[0],o=arguments[1];return Math.min(P4.computeOverlaySnapTolerance(i),P4.computeOverlaySnapTolerance(o))}},P4.computeSizeBasedSnapTolerance=function(t){var e=t.getEnvelopeInternal();return Math.min(e.getHeight(),e.getWidth())*P4.SNAP_PRECISION_FACTOR},P4.snapToSelf=function(t,e,n){return new P4(t).snapToSelf(e,n)},E4.SNAP_PRECISION_FACTOR.get=function(){return 1e-9},Object.defineProperties(P4,E4);var O4=function(t){function e(e,n,r){t.call(this),this.rs=e||null,this.hs=n||null,this.fs=void 0!==r&&r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.snapLine=function(t,e){var n=new I4(t,this.rs);return n.setAllowSnappingToSourceVertices(this.fs),n.snapTo(e)},e.prototype.transformCoordinates=function(t,e){var n=t.toCoordinateArray(),r=this.snapLine(n,this.hs);return this.Zt.getCoordinateSequenceFactory().create(r)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(S4),R4=function(){this.cs=!0,this.vs=53,this.ls=0,this.ws=null};R4.prototype.getCommon=function(){return B0.longBitsToDouble(this.ls)},R4.prototype.add=function(t){var e=B0.doubleToLongBits(t);return this.cs?(this.ls=e,this.ws=R4.signExpBits(this.ls),this.cs=!1,null):R4.signExpBits(e)!==this.ws?(this.ls=0,null):(this.vs=R4.numCommonMostSigMantissaBits(this.ls,e),void(this.ls=R4.zeroLowerBits(this.ls,64-(12+this.vs))))},R4.prototype.toString=function(){if(1===arguments.length){var t=arguments[0],e=B0.longBitsToDouble(t),n="0000000000000000000000000000000000000000000000000000000000000000"+B0.toBinaryString(t),r=n.substring(n.length-64);return r.substring(0,1)+"  "+r.substring(1,12)+"(exp) "+r.substring(12)+" [ "+e+" ]"}},R4.prototype.interfaces_=function(){return[]},R4.prototype.getClass=function(){return R4},R4.getBit=function(t,e){return t&1<<e?1:0},R4.signExpBits=function(t){return t>>52},R4.zeroLowerBits=function(t,e){return t&~((1<<e)-1)},R4.numCommonMostSigMantissaBits=function(t,e){for(var n=0,r=52;r>=0;r--){if(R4.getBit(t,r)!==R4.getBit(e,r))return n;n++}return 52};var k4=function(){this.Ps=null,this.gs=new D4},L4={CommonCoordinateFilter:{configurable:!0},Translater:{configurable:!0}};k4.prototype.addCommonBits=function(t){var e=new N4(this.Ps);t.apply(e),t.geometryChanged()},k4.prototype.removeCommonBits=function(t){if(0===this.Ps.x&&0===this.Ps.y)return t;var e=new W0(this.Ps);e.x=-e.x,e.y=-e.y;var n=new N4(e);return t.apply(n),t.geometryChanged(),t},k4.prototype.getCommonCoordinate=function(){return this.Ps},k4.prototype.add=function(t){t.apply(this.gs),this.Ps=this.gs.getCommonCoordinate()},k4.prototype.interfaces_=function(){return[]},k4.prototype.getClass=function(){return k4},L4.CommonCoordinateFilter.get=function(){return D4},L4.Translater.get=function(){return N4},Object.defineProperties(k4,L4);var D4=function(){this.Cs=new R4,this.Ds=new R4};D4.prototype.filter=function(t){this.Cs.add(t.x),this.Ds.add(t.y)},D4.prototype.getCommonCoordinate=function(){return new W0(this.Cs.getCommon(),this.Ds.getCommon())},D4.prototype.interfaces_=function(){return[L1]},D4.prototype.getClass=function(){return D4};var N4=function(){this.trans=null;var t=arguments[0];this.trans=t};N4.prototype.filter=function(t,e){var n=t.getOrdinate(e,0)+this.trans.x,r=t.getOrdinate(e,1)+this.trans.y;t.setOrdinate(e,0,n),t.setOrdinate(e,1,r)},N4.prototype.isDone=function(){return!1},N4.prototype.isGeometryChanged=function(){return!0},N4.prototype.interfaces_=function(){return[v2]},N4.prototype.getClass=function(){return N4};var F4=function(t,e){this.An=new Array(2).fill(null),this.rs=null,this.Is=null,this.An[0]=t,this.An[1]=e,this.computeSnapTolerance()};F4.prototype.selfSnap=function(t){return new P4(t).snapTo(t,this.rs)},F4.prototype.removeCommonBits=function(t){this.Is=new k4,this.Is.add(t[0]),this.Is.add(t[1]);var e=new Array(2).fill(null);return e[0]=this.Is.removeCommonBits(t[0].copy()),e[1]=this.Is.removeCommonBits(t[1].copy()),e},F4.prototype.prepareResult=function(t){return this.Is.addCommonBits(t),t},F4.prototype.getResultGeometry=function(t){var e=this.snap(this.An),n=o6.overlayOp(e[0],e[1],t);return this.prepareResult(n)},F4.prototype.checkValid=function(t){t.isValid()||c1.out.println("Snapped geometry is invalid")},F4.prototype.computeSnapTolerance=function(){this.rs=P4.computeOverlaySnapTolerance(this.An[0],this.An[1])},F4.prototype.snap=function(t){var e=this.removeCommonBits(t);return P4.snap(e[0],e[1],this.rs)},F4.prototype.interfaces_=function(){return[]},F4.prototype.getClass=function(){return F4},F4.overlayOp=function(t,e,n){return new F4(t,e).getResultGeometry(n)},F4.union=function(t,e){return F4.overlayOp(t,e,o6.UNION)},F4.intersection=function(t,e){return F4.overlayOp(t,e,o6.INTERSECTION)},F4.symDifference=function(t,e){return F4.overlayOp(t,e,o6.SYMDIFFERENCE)},F4.difference=function(t,e){return F4.overlayOp(t,e,o6.DIFFERENCE)};var z4=function(t,e){this.An=new Array(2).fill(null),this.An[0]=t,this.An[1]=e};z4.prototype.getResultGeometry=function(t){var e=null,n=!1,r=null;try{e=o6.overlayOp(this.An[0],this.An[1],t),n=!0}catch(i){if(!(i instanceof x1))throw i;r=i}if(!n)try{e=F4.overlayOp(this.An[0],this.An[1],t)}catch(i){throw i instanceof x1?r:i}return e},z4.prototype.interfaces_=function(){return[]},z4.prototype.getClass=function(){return z4},z4.overlayOp=function(t,e,n){return new z4(t,e).getResultGeometry(n)},z4.union=function(t,e){return z4.overlayOp(t,e,o6.UNION)},z4.intersection=function(t,e){return z4.overlayOp(t,e,o6.INTERSECTION)},z4.symDifference=function(t,e){return z4.overlayOp(t,e,o6.SYMDIFFERENCE)},z4.difference=function(t,e){return z4.overlayOp(t,e,o6.DIFFERENCE)};var B4=function(){this.mce=null,this.chainIndex=null;var t=arguments[0],e=arguments[1];this.mce=t,this.chainIndex=e};B4.prototype.computeIntersections=function(t,e){this.mce.computeIntersectsForChain(this.chainIndex,t.mce,t.chainIndex,e)},B4.prototype.interfaces_=function(){return[]},B4.prototype.getClass=function(){return B4};var H4=function t(){if(this.xn=null,this.bs=null,this.Ms=null,this.zs=null,this.ds=null,this.xs=null,2===arguments.length){var e=arguments[0],n=arguments[1];this.Ms=t.DELETE,this.bs=e,this.zs=n}else if(3===arguments.length){var r=arguments[0],i=arguments[1],o=arguments[2];this.Ms=t.INSERT,this.xn=r,this.bs=i,this.xs=o}},j4={INSERT:{configurable:!0},DELETE:{configurable:!0}};H4.prototype.isDelete=function(){return this.Ms===H4.DELETE},H4.prototype.setDeleteEventIndex=function(t){this.ds=t},H4.prototype.getObject=function(){return this.xs},H4.prototype.compareTo=function(t){var e=t;return this.bs<e.bs?-1:this.bs>e.bs?1:this.Ms<e.Ms?-1:this.Ms>e.Ms?1:0},H4.prototype.getInsertEvent=function(){return this.zs},H4.prototype.isInsert=function(){return this.Ms===H4.INSERT},H4.prototype.isSameLabel=function(t){return null!==this.xn&&this.xn===t.xn},H4.prototype.getDeleteEventIndex=function(){return this.ds},H4.prototype.interfaces_=function(){return[j0]},H4.prototype.getClass=function(){return H4},j4.INSERT.get=function(){return 1},j4.DELETE.get=function(){return 2},Object.defineProperties(H4,j4);var U4=function(){};U4.prototype.interfaces_=function(){return[]},U4.prototype.getClass=function(){return U4};var V4=function(){this.dr=!1,this.mr=!1,this.yr=!1,this.Lr=null,this.Wi=null,this.ys=null,this.ps=null,this.Tr=null,this.Ls=0,this.numTests=0,this.Ts=null,this.Os=!1,this.Fs=!1;var t=arguments[0],e=arguments[1],n=arguments[2];this.Wi=t,this.ys=e,this.ps=n};V4.prototype.isTrivialIntersection=function(t,e,n,r){if(t===n&&1===this.Wi.getIntersectionNum()){if(V4.isAdjacentSegments(e,r))return!0;if(t.isClosed()){var i=t.getNumPoints()-1;if(0===e&&r===i||0===r&&e===i)return!0}}return!1},V4.prototype.getProperIntersectionPoint=function(){return this.Lr},V4.prototype.setIsDoneIfProperInt=function(t){this.Fs=t},V4.prototype.hasProperInteriorIntersection=function(){return this.yr},V4.prototype.isBoundaryPointInternal=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next().getCoordinate();if(t.isIntersection(r))return!0}return!1},V4.prototype.hasProperIntersection=function(){return this.mr},V4.prototype.hasIntersection=function(){return this.dr},V4.prototype.isDone=function(){return this.Os},V4.prototype.isBoundaryPoint=function(t,e){return!(null===e||!this.isBoundaryPointInternal(t,e[0])&&!this.isBoundaryPointInternal(t,e[1]))},V4.prototype.setBoundaryNodes=function(t,e){this.Ts=new Array(2).fill(null),this.Ts[0]=t,this.Ts[1]=e},V4.prototype.addIntersections=function(t,e,n,r){if(t===n&&e===r)return null;this.numTests++;var i=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Wi.computeIntersection(i,o,s,a),this.Wi.hasIntersection()&&(this.ps&&(t.setIsolated(!1),n.setIsolated(!1)),this.Ls++,this.isTrivialIntersection(t,e,n,r)||(this.dr=!0,!this.ys&&this.Wi.isProper()||(t.addIntersections(this.Wi,e,0),n.addIntersections(this.Wi,r,1)),this.Wi.isProper()&&(this.Lr=this.Wi.getIntersection(0).copy(),this.mr=!0,this.Fs&&(this.Os=!0),this.isBoundaryPoint(this.Wi,this.Ts)||(this.yr=!0))))},V4.prototype.interfaces_=function(){return[]},V4.prototype.getClass=function(){return V4},V4.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var G4=function(t){function e(){t.call(this),this.events=new q1,this.nOverlaps=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.prepareEvents=function(){k5.sort(this.events);for(var t=0;t<this.events.size();t++){var e=this.events.get(t);e.isDelete()&&e.getInsertEvent().setDeleteEventIndex(t)}},e.prototype.computeIntersections=function(){if(1===arguments.length){var t=arguments[0];this.nOverlaps=0,this.prepareEvents();for(var e=0;e<this.events.size();e++){var n=this.events.get(e);if(n.isInsert()&&this.processOverlaps(e,n.getDeleteEventIndex(),n,t),t.isDone())break}}else if(3===arguments.length)if(arguments[2]instanceof V4&&Q0(arguments[0],G1)&&Q0(arguments[1],G1)){var r=arguments[0],i=arguments[1],o=arguments[2];this.addEdges(r,r),this.addEdges(i,i),this.computeIntersections(o)}else if("boolean"==typeof arguments[2]&&Q0(arguments[0],G1)&&arguments[1]instanceof V4){var s=arguments[0],a=arguments[1];arguments[2]?this.addEdges(s,null):this.addEdges(s),this.computeIntersections(a)}},e.prototype.addEdge=function(t,e){for(var n=t.getMonotoneChainEdge(),r=n.getStartIndexes(),i=0;i<r.length-1;i++){var o=new B4(n,i),s=new H4(e,n.getMinX(i),o);this.events.add(s),this.events.add(new H4(n.getMaxX(i),s))}},e.prototype.processOverlaps=function(t,e,n,r){for(var i=n.getObject(),o=t;o<e;o++){var s=this.events.get(o);if(s.isInsert()){var a=s.getObject();n.isSameLabel(s)||(i.computeIntersections(a,r),this.nOverlaps++)}}},e.prototype.addEdges=function(){if(1===arguments.length)for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.addEdge(e,e)}else if(2===arguments.length)for(var n=arguments[1],r=arguments[0].iterator();r.hasNext();){var i=r.next();this.addEdge(i,n)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(U4),W4=function(){this.Us=B0.POSITIVE_INFINITY,this.lr=B0.NEGATIVE_INFINITY},q4={NodeComparator:{configurable:!0}};W4.prototype.getMin=function(){return this.Us},W4.prototype.intersects=function(t,e){return!(this.Us>e||this.lr<t)},W4.prototype.getMax=function(){return this.lr},W4.prototype.toString=function(){return v1.toLineString(new W0(this.Us,0),new W0(this.lr,0))},W4.prototype.interfaces_=function(){return[]},W4.prototype.getClass=function(){return W4},q4.NodeComparator.get=function(){return X4},Object.defineProperties(W4,q4);var X4=function(){};X4.prototype.compare=function(t,e){var n=t,r=e,i=(n.Us+n.lr)/2,o=(r.Us+r.lr)/2;return i<o?-1:i>o?1:0},X4.prototype.interfaces_=function(){return[V0]},X4.prototype.getClass=function(){return X4};var Z4=function(t){function e(){t.call(this),this.Zn=null;var e=arguments[0],n=arguments[1],r=arguments[2];this.Us=e,this.lr=n,this.Zn=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;n.visitItem(this.Zn)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(W4),Y4=function(t){function e(){t.call(this),this.Es=null,this.Ns=null;var e=arguments[0],n=arguments[1];this.Es=e,this.Ns=n,this.buildExtent(this.Es,this.Ns)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildExtent=function(t,e){this.Us=Math.min(t.Us,e.Us),this.lr=Math.max(t.lr,e.lr)},e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;null!==this.Es&&this.Es.query(t,e,n),null!==this.Ns&&this.Ns.query(t,e,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(W4),J4=function(){this.js=new q1,this.si=null,this.ti=0};J4.prototype.buildTree=function(){k5.sort(this.js,new W4.NodeComparator);for(var t=this.js,e=null,n=new q1;;){if(this.buildLevel(t,n),1===n.size())return n.get(0);e=t,t=n,n=e}},J4.prototype.insert=function(t,e,n){if(null!==this.si)throw new Error("Index cannot be added to once it has been queried");this.js.add(new Z4(t,e,n))},J4.prototype.query=function(t,e,n){this.init(),this.si.query(t,e,n)},J4.prototype.buildRoot=function(){if(null!==this.si)return null;this.si=this.buildTree()},J4.prototype.printNode=function(t){c1.out.println(v1.toLineString(new W0(t.Us,this.ti),new W0(t.lr,this.ti)))},J4.prototype.init=function(){if(null!==this.si)return null;this.buildRoot()},J4.prototype.buildLevel=function(t,e){this.ti++,e.clear();for(var n=0;n<t.size();n+=2){var r=t.get(n);if(null===(n+1<t.size()?t.get(n):null))e.add(r);else{var i=new Y4(t.get(n),t.get(n+1));e.add(i)}}},J4.prototype.interfaces_=function(){return[]},J4.prototype.getClass=function(){return J4};var Q4=function(){this.$n=new q1};Q4.prototype.visitItem=function(t){this.$n.add(t)},Q4.prototype.getItems=function(){return this.$n},Q4.prototype.interfaces_=function(){return[P5]},Q4.prototype.getClass=function(){return Q4};var K4=function(){this.di=null;var t=arguments[0];if(!Q0(t,N2))throw new z0("Argument must be Polygonal");this.di=new e6(t)},$4={SegmentVisitor:{configurable:!0},IntervalIndexedGeometry:{configurable:!0}};K4.prototype.locate=function(t){var e=new S1(t),n=new t6(e);return this.di.query(t.y,t.y,n),e.getLocation()},K4.prototype.interfaces_=function(){return[v3]},K4.prototype.getClass=function(){return K4},$4.SegmentVisitor.get=function(){return t6},$4.IntervalIndexedGeometry.get=function(){return e6},Object.defineProperties(K4,$4);var t6=function(){this.Qs=null;var t=arguments[0];this.Qs=t};t6.prototype.visitItem=function(t){var e=t;this.Qs.countSegment(e.getCoordinate(0),e.getCoordinate(1))},t6.prototype.interfaces_=function(){return[P5]},t6.prototype.getClass=function(){return t6};var e6=function(){this.di=new J4;var t=arguments[0];this.init(t)};e6.prototype.init=function(t){for(var e=r4.getLines(t).iterator();e.hasNext();){var n=e.next().getCoordinates();this.addLine(n)}},e6.prototype.addLine=function(t){for(var e=1;e<t.length;e++){var n=new Z5(t[e-1],t[e]),r=Math.min(n.p0.y,n.p1.y),i=Math.max(n.p0.y,n.p1.y);this.di.insert(r,i,n)}},e6.prototype.query=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new Q4;return this.di.query(t,e,n),n.getItems()}if(3===arguments.length){var r=arguments[0],i=arguments[1],o=arguments[2];this.di.query(r,i,o)}},e6.prototype.interfaces_=function(){return[]},e6.prototype.getClass=function(){return e6};var n6=function(t){function e(){if(t.call(this),this.Ss=null,this.Bs=new J2,this.ks=null,this.Rs=!0,this.Gs=null,this.Ys=null,this.qs=!1,this.Vs=null,this.Ws=null,this.Ie=new i4,2===arguments.length){var e=arguments[0],n=arguments[1],r=D1.OGC_SFS_BOUNDARY_RULE;this.Gs=e,this.Ss=n,this.ks=r,null!==n&&this.add(n)}else if(3===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2];this.Gs=i,this.Ss=o,this.ks=s,null!==o&&this.add(o)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertBoundaryPoint=function(t,n){var r=this.Cn.addNode(n).getLabel(),i=1;r.getLocation(t,r5.ON)===Y0.BOUNDARY&&i++;var o=e.determineBoundary(this.ks,i);r.setLocation(t,o)},e.prototype.computeSelfNodes=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.computeSelfNodes(t,e,!1)}if(3===arguments.length){var n=arguments[1],r=arguments[2],i=new V4(arguments[0],!0,!1);i.setIsDoneIfProperInt(r);var o=this.createEdgeSetIntersector(),s=this.Ss instanceof B2||this.Ss instanceof F2||this.Ss instanceof H2,a=n||!s;return o.computeIntersections(this.zn,i,a),this.addSelfIntersectionNodes(this.Gs),i}},e.prototype.computeSplitEdges=function(t){for(var e=this.zn.iterator();e.hasNext();)e.next().eiList.addSplitEdges(t)},e.prototype.computeEdgeIntersections=function(t,e,n){var r=new V4(e,n,!0);return r.setBoundaryNodes(this.getBoundaryNodes(),t.getBoundaryNodes()),this.createEdgeSetIntersector().computeIntersections(this.zn,t.zn,r),r},e.prototype.getGeometry=function(){return this.Ss},e.prototype.getBoundaryNodeRule=function(){return this.ks},e.prototype.hasTooFewPoints=function(){return this.qs},e.prototype.addPoint=function(){if(arguments[0]instanceof D2){var t=arguments[0].getCoordinate();this.insertPoint(this.Gs,t,Y0.INTERIOR)}else if(arguments[0]instanceof W0){var e=arguments[0];this.insertPoint(this.Gs,e,Y0.INTERIOR)}},e.prototype.addPolygon=function(t){this.addPolygonRing(t.getExteriorRing(),Y0.EXTERIOR,Y0.INTERIOR);for(var e=0;e<t.getNumInteriorRing();e++){var n=t.getInteriorRingN(e);this.addPolygonRing(n,Y0.INTERIOR,Y0.EXTERIOR)}},e.prototype.addEdge=function(t){this.insertEdge(t);var e=t.getCoordinates();this.insertPoint(this.Gs,e[0],Y0.BOUNDARY),this.insertPoint(this.Gs,e[e.length-1],Y0.BOUNDARY)},e.prototype.addLineString=function(t){var e=Y1.removeRepeatedPoints(t.getCoordinates());if(e.length<2)return this.qs=!0,this.Vs=e[0],null;var n=new D3(e,new f5(this.Gs,Y0.INTERIOR));this.Bs.put(t,n),this.insertEdge(n),b1.isTrue(e.length>=2,"found LineString with single point"),this.insertBoundaryPoint(this.Gs,e[0]),this.insertBoundaryPoint(this.Gs,e[e.length-1])},e.prototype.getInvalidPoint=function(){return this.Vs},e.prototype.getBoundaryPoints=function(){for(var t=this.getBoundaryNodes(),e=new Array(t.size()).fill(null),n=0,r=t.iterator();r.hasNext();){var i=r.next();e[n++]=i.getCoordinate().copy()}return e},e.prototype.getBoundaryNodes=function(){return null===this.Ys&&(this.Ys=this.Cn.getBoundaryNodes(this.Gs)),this.Ys},e.prototype.addSelfIntersectionNode=function(t,e,n){if(this.isBoundaryNode(t,e))return null;n===Y0.BOUNDARY&&this.Rs?this.insertBoundaryPoint(t,e):this.insertPoint(t,e,n)},e.prototype.addPolygonRing=function(t,e,n){if(t.isEmpty())return null;var r=Y1.removeRepeatedPoints(t.getCoordinates());if(r.length<4)return this.qs=!0,this.Vs=r[0],null;var i=e,o=n;I1.isCCW(r)&&(i=n,o=e);var s=new D3(r,new f5(this.Gs,Y0.BOUNDARY,i,o));this.Bs.put(t,s),this.insertEdge(s),this.insertPoint(this.Gs,r[0],Y0.BOUNDARY)},e.prototype.insertPoint=function(t,e,n){var r=this.Cn.addNode(e),i=r.getLabel();null===i?r.xn=new f5(t,n):i.setLocation(t,n)},e.prototype.createEdgeSetIntersector=function(){return new G4},e.prototype.addSelfIntersectionNodes=function(t){for(var e=this.zn.iterator();e.hasNext();)for(var n=e.next(),r=n.getLabel().getLocation(t),i=n.eiList.iterator();i.hasNext();){var o=i.next();this.addSelfIntersectionNode(t,o.coord,r)}},e.prototype.add=function(){if(1!==arguments.length)return t.prototype.add.apply(this,arguments);var e=arguments[0];if(e.isEmpty())return null;if(e instanceof H2&&(this.Rs=!1),e instanceof F2)this.addPolygon(e);else if(e instanceof k2)this.addLineString(e);else if(e instanceof D2)this.addPoint(e);else if(e instanceof z2)this.addCollection(e);else if(e instanceof _2)this.addCollection(e);else if(e instanceof H2)this.addCollection(e);else{if(!(e instanceof x2))throw new Error(e.getClass().getName());this.addCollection(e)}},e.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},e.prototype.locate=function(t){return Q0(this.Ss,N2)&&this.Ss.getNumGeometries()>50?(null===this.Ws&&(this.Ws=new K4(this.Ss)),this.Ws.locate(t)):this.Ie.locate(t,this.Ss)},e.prototype.findEdge=function(){if(1===arguments.length){var e=arguments[0];return this.Bs.get(e)}return t.prototype.findEdge.apply(this,arguments)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.determineBoundary=function(t,e){return t.isInBoundary(e)?Y0.BOUNDARY:Y0.INTERIOR},e}(T5),r6=function(){if(this.Wi=new M1,this._s=null,this.Ks=null,1===arguments.length){var t=arguments[0];this.setComputationPrecision(t.getPrecisionModel()),this.Ks=new Array(1).fill(null),this.Ks[0]=new n6(0,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1],r=D1.OGC_SFS_BOUNDARY_RULE;e.getPrecisionModel().compareTo(n.getPrecisionModel())>=0?this.setComputationPrecision(e.getPrecisionModel()):this.setComputationPrecision(n.getPrecisionModel()),this.Ks=new Array(2).fill(null),this.Ks[0]=new n6(0,e,r),this.Ks[1]=new n6(1,n,r)}else if(3===arguments.length){var i=arguments[0],o=arguments[1],s=arguments[2];i.getPrecisionModel().compareTo(o.getPrecisionModel())>=0?this.setComputationPrecision(i.getPrecisionModel()):this.setComputationPrecision(o.getPrecisionModel()),this.Ks=new Array(2).fill(null),this.Ks[0]=new n6(0,i,s),this.Ks[1]=new n6(1,o,s)}};r6.prototype.getArgGeometry=function(t){return this.Ks[t].getGeometry()},r6.prototype.setComputationPrecision=function(t){this._s=t,this.Wi.setPrecisionModel(this._s)},r6.prototype.interfaces_=function(){return[]},r6.prototype.getClass=function(){return r6};var i6=function(){};i6.prototype.interfaces_=function(){return[]},i6.prototype.getClass=function(){return i6},i6.map=function(){if(arguments[0]instanceof O1&&Q0(arguments[1],i6.MapOp)){for(var t=arguments[0],e=arguments[1],n=new q1,r=0;r<t.getNumGeometries();r++){var i=e.map(t.getGeometryN(r));null!==i&&n.add(i)}return t.getFactory().buildGeometry(n)}if(Q0(arguments[0],j1)&&Q0(arguments[1],i6.MapOp)){for(var o=arguments[0],s=arguments[1],a=new q1,l=o.iterator();l.hasNext();){var h=l.next(),u=s.map(h);null!==u&&a.add(u)}return a}},i6.MapOp=function(){};var o6=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n),this.Ie=new i4,this.tn=null,this.Hs=null,this.jr=null,this.gr=new C3,this.Js=new q1,this.Ze=new q1,this.Xe=new q1,this.jr=new T5(new T3),this.tn=e.getFactory()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertUniqueEdge=function(t){var e=this.gr.findEqualEdge(t);if(null!==e){var n=e.getLabel(),r=t.getLabel();e.isPointwiseEqual(t)||(r=new f5(t.getLabel())).flip();var i=e.getDepth();i.isNull()&&i.add(n),i.add(r),n.merge(r)}else this.gr.add(t)},e.prototype.getGraph=function(){return this.jr},e.prototype.cancelDuplicateResultEdges=function(){for(var t=this.jr.getEdgeEnds().iterator();t.hasNext();){var e=t.next(),n=e.getSym();e.isInResult()&&n.isInResult()&&(e.setInResult(!1),n.setInResult(!1))}},e.prototype.isCoveredByLA=function(t){return!!this.isCovered(t,this.Ze)||!!this.isCovered(t,this.Js)},e.prototype.computeGeometry=function(t,n,r,i){var o=new q1;return o.addAll(t),o.addAll(n),o.addAll(r),o.isEmpty()?e.createEmptyResult(i,this.Ks[0].getGeometry(),this.Ks[1].getGeometry(),this.tn):this.tn.buildGeometry(o)},e.prototype.mergeSymLabels=function(){for(var t=this.jr.getNodes().iterator();t.hasNext();)t.next().getEdges().mergeSymLabels()},e.prototype.isCovered=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();if(this.Ie.locate(t,r)!==Y0.EXTERIOR)return!0}return!1},e.prototype.replaceCollapsedEdges=function(){for(var t=new q1,e=this.gr.iterator();e.hasNext();){var n=e.next();n.isCollapsed()&&(e.remove(),t.add(n.getCollapsedEdge()))}this.gr.addAll(t)},e.prototype.updateNodeLabelling=function(){for(var t=this.jr.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getEdges().getLabel();e.getLabel().merge(n)}},e.prototype.getResultGeometry=function(t){return this.computeOverlay(t),this.Hs},e.prototype.insertUniqueEdges=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this.insertUniqueEdge(n)}},e.prototype.computeOverlay=function(t){this.copyPoints(0),this.copyPoints(1),this.Ks[0].computeSelfNodes(this.Wi,!1),this.Ks[1].computeSelfNodes(this.Wi,!1),this.Ks[0].computeEdgeIntersections(this.Ks[1],this.Wi,!0);var e=new q1;this.Ks[0].computeSplitEdges(e),this.Ks[1].computeSplitEdges(e),this.insertUniqueEdges(e),this.computeLabelsFromDepths(),this.replaceCollapsedEdges(),w4.checkValid(this.gr.getEdges()),this.jr.addEdges(this.gr.getEdges()),this.computeLabelling(),this.labelIncompleteNodes(),this.findResultAreaEdges(t),this.cancelDuplicateResultEdges();var n=new M5(this.tn);n.add(this.jr),this.Js=n.getPolygons();var r=new M4(this,this.tn,this.Ie);this.Ze=r.build(t);var i=new C4(this,this.tn,this.Ie);this.Xe=i.build(t),this.Hs=this.computeGeometry(this.Xe,this.Ze,this.Js,t)},e.prototype.labelIncompleteNode=function(t,e){var n=this.Ie.locate(t.getCoordinate(),this.Ks[e].getGeometry());t.getLabel().setLocation(e,n)},e.prototype.copyPoints=function(t){for(var e=this.Ks[t].getNodeIterator();e.hasNext();){var n=e.next();this.jr.addNode(n.getCoordinate()).setLabel(t,n.getLabel().getLocation(t))}},e.prototype.findResultAreaEdges=function(t){for(var n=this.jr.getEdgeEnds().iterator();n.hasNext();){var r=n.next(),i=r.getLabel();i.isArea()&&!r.isInteriorAreaEdge()&&e.isResultOfOp(i.getLocation(0,r5.RIGHT),i.getLocation(1,r5.RIGHT),t)&&r.setInResult(!0)}},e.prototype.computeLabelsFromDepths=function(){for(var t=this.gr.iterator();t.hasNext();){var e=t.next(),n=e.getLabel(),r=e.getDepth();if(!r.isNull()){r.normalize();for(var i=0;i<2;i++)n.isNull(i)||!n.isArea()||r.isNull(i)||(0===r.getDelta(i)?n.toLine(i):(b1.isTrue(!r.isNull(i,r5.LEFT),"depth of LEFT side has not been initialized"),n.setLocation(i,r5.LEFT,r.getLocation(i,r5.LEFT)),b1.isTrue(!r.isNull(i,r5.RIGHT),"depth of RIGHT side has not been initialized"),n.setLocation(i,r5.RIGHT,r.getLocation(i,r5.RIGHT))))}}},e.prototype.computeLabelling=function(){for(var t=this.jr.getNodes().iterator();t.hasNext();)t.next().getEdges().computeLabelling(this.Ks);this.mergeSymLabels(),this.updateNodeLabelling()},e.prototype.labelIncompleteNodes=function(){for(var t=this.jr.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getLabel();e.isIsolated()&&(n.isNull(0)?this.labelIncompleteNode(e,0):this.labelIncompleteNode(e,1)),e.getEdges().updateLabelling(n)}},e.prototype.isCoveredByA=function(t){return!!this.isCovered(t,this.Js)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(r6);o6.overlayOp=function(t,e,n){return new o6(t,e).getResultGeometry(n)},o6.intersection=function(t,e){if(t.isEmpty()||e.isEmpty())return o6.createEmptyResult(o6.INTERSECTION,t,e,t.getFactory());if(t.isGeometryCollection()){var n=e;return T4.map(t,{interfaces_:function(){return[i6.MapOp]},map:function(t){return t.intersection(n)}})}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),z4.overlayOp(t,e,o6.INTERSECTION)},o6.symDifference=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return o6.createEmptyResult(o6.SYMDIFFERENCE,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),z4.overlayOp(t,e,o6.SYMDIFFERENCE)},o6.resultDimension=function(t,e,n){var r=e.getDimension(),i=n.getDimension(),o=-1;switch(t){case o6.INTERSECTION:o=Math.min(r,i);break;case o6.UNION:o=Math.max(r,i);break;case o6.DIFFERENCE:o=r;break;case o6.SYMDIFFERENCE:o=Math.max(r,i)}return o},o6.createEmptyResult=function(t,e,n,r){var i=null;switch(o6.resultDimension(t,e,n)){case-1:i=r.createGeometryCollection(new Array(0).fill(null));break;case 0:i=r.createPoint();break;case 1:i=r.createLineString();break;case 2:i=r.createPolygon()}return i},o6.difference=function(t,e){return t.isEmpty()?o6.createEmptyResult(o6.DIFFERENCE,t,e,t.getFactory()):e.isEmpty()?t.copy():(t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),z4.overlayOp(t,e,o6.DIFFERENCE))},o6.isResultOfOp=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=t.getLocation(0),r=t.getLocation(1);return o6.isResultOfOp(n,r,e)}if(3===arguments.length){var i=arguments[0],o=arguments[1];switch(i===Y0.BOUNDARY&&(i=Y0.INTERIOR),o===Y0.BOUNDARY&&(o=Y0.INTERIOR),arguments[2]){case o6.INTERSECTION:return i===Y0.INTERIOR&&o===Y0.INTERIOR;case o6.UNION:return i===Y0.INTERIOR||o===Y0.INTERIOR;case o6.DIFFERENCE:return i===Y0.INTERIOR&&o!==Y0.INTERIOR;case o6.SYMDIFFERENCE:return i===Y0.INTERIOR&&o!==Y0.INTERIOR||i!==Y0.INTERIOR&&o===Y0.INTERIOR}return!1}},o6.INTERSECTION=1,o6.UNION=2,o6.DIFFERENCE=3,o6.SYMDIFFERENCE=4;var s6=function(){this.Zs=null,this.Xs=null,this.$s=null,this.Ie=new i4,this.ir=new Z5;var t=arguments[0],e=arguments[1];this.Zs=t,this.Xs=e,this.$s=this.extractLinework(t)};s6.prototype.isWithinToleranceOfBoundary=function(t){for(var e=this,n=0;n<this.$s.getNumGeometries();n++)for(var r=e.$s.getGeometryN(n).getCoordinateSequence(),i=0;i<r.size()-1;i++)if(r.getCoordinate(i,e.ir.p0),r.getCoordinate(i+1,e.ir.p1),e.ir.distance(t)<=e.Xs)return!0;return!1},s6.prototype.getLocation=function(t){return this.isWithinToleranceOfBoundary(t)?Y0.BOUNDARY:this.Ie.locate(t,this.Zs)},s6.prototype.extractLinework=function(t){var e=new a6;t.apply(e);var n=e.getLinework(),r=e5.toLineStringArray(n);return t.getFactory().createMultiLineString(r)},s6.prototype.interfaces_=function(){return[]},s6.prototype.getClass=function(){return s6};var a6=function(){this.$s=null,this.$s=new q1};a6.prototype.getLinework=function(){return this.$s},a6.prototype.filter=function(t){if(t instanceof F2){var e=t;this.$s.add(e.getExteriorRing());for(var n=0;n<e.getNumInteriorRing();n++)this.$s.add(e.getInteriorRingN(n))}},a6.prototype.interfaces_=function(){return[y2]},a6.prototype.getClass=function(){return a6};var l6=function(){this.Zs=null,this.Au=!0,this.tu=!0;var t=arguments[0];this.Zs=t};l6.prototype.extractPoints=function(t,e,n){for(var r=t.getCoordinates(),i=0;i<r.length-1;i++)this.computeOffsetPoints(r[i],r[i+1],e,n)},l6.prototype.setSidesToGenerate=function(t,e){this.Au=t,this.tu=e},l6.prototype.getPoints=function(t){for(var e=new q1,n=r4.getLines(this.Zs).iterator();n.hasNext();){var r=n.next();this.extractPoints(r,t,e)}return e},l6.prototype.computeOffsetPoints=function(t,e,n,r){var i=e.x-t.x,o=e.y-t.y,s=Math.sqrt(i*i+o*o),a=n*i/s,l=n*o/s,h=(e.x+t.x)/2,u=(e.y+t.y)/2;if(this.Au){var c=new W0(h-l,u+a);r.add(c)}if(this.tu){var f=new W0(h+l,u-a);r.add(f)}},l6.prototype.interfaces_=function(){return[]},l6.prototype.getClass=function(){return l6};var h6=function t(){this.An=null,this.nu=null,this.iu=new Array(3).fill(null),this.ru=null,this.Xs=t.TOLERANCE,this.eu=new q1;var e=arguments[0],n=arguments[1],r=arguments[2];this.Xs=t.computeBoundaryDistanceTolerance(e,n),this.An=[e,n,r],this.nu=[new s6(this.An[0],this.Xs),new s6(this.An[1],this.Xs),new s6(this.An[2],this.Xs)]},u6={TOLERANCE:{configurable:!0}};h6.prototype.reportResult=function(t,e,n){c1.out.println("Overlay result invalid - A:"+Y0.toLocationSymbol(e[0])+" B:"+Y0.toLocationSymbol(e[1])+" expected:"+(n?"i":"e")+" actual:"+Y0.toLocationSymbol(e[2]))},h6.prototype.isValid=function(t){return this.addTestPts(this.An[0]),this.addTestPts(this.An[1]),this.checkValid(t)},h6.prototype.checkValid=function(){var t=this;if(1===arguments.length){for(var e=arguments[0],n=0;n<this.eu.size();n++){var r=t.eu.get(n);if(!t.checkValid(e,r))return t.ru=r,!1}return!0}if(2===arguments.length){var i=arguments[0],o=arguments[1];return this.iu[0]=this.nu[0].getLocation(o),this.iu[1]=this.nu[1].getLocation(o),this.iu[2]=this.nu[2].getLocation(o),!!h6.hasLocation(this.iu,Y0.BOUNDARY)||this.isValidResult(i,this.iu)}},h6.prototype.addTestPts=function(t){var e=new l6(t);this.eu.addAll(e.getPoints(5*this.Xs))},h6.prototype.isValidResult=function(t,e){var n=o6.isResultOfOp(e[0],e[1],t),r=!(n^e[2]===Y0.INTERIOR);return r||this.reportResult(t,e,n),r},h6.prototype.getInvalidLocation=function(){return this.ru},h6.prototype.interfaces_=function(){return[]},h6.prototype.getClass=function(){return h6},h6.hasLocation=function(t,e){for(var n=0;n<3;n++)if(t[n]===e)return!0;return!1},h6.computeBoundaryDistanceTolerance=function(t,e){return Math.min(P4.computeSizeBasedSnapTolerance(t),P4.computeSizeBasedSnapTolerance(e))},h6.isValid=function(t,e,n,r){return new h6(t,e,r).isValid(n)},u6.TOLERANCE.get=function(){return 1e-6},Object.defineProperties(h6,u6);var c6=function t(e){this.su=null,this.uu=!1,this.ou=null,this.su=t.extractFactory(e),this.ou=e};c6.prototype.extractElements=function(t,e){if(null===t)return null;for(var n=0;n<t.getNumGeometries();n++){var r=t.getGeometryN(n);this.uu&&r.isEmpty()||e.add(r)}},c6.prototype.combine=function(){for(var t=new q1,e=this.ou.iterator();e.hasNext();){var n=e.next();this.extractElements(n,t)}return 0===t.size()?null!==this.su?this.su.createGeometryCollection(null):null:this.su.buildGeometry(t)},c6.prototype.interfaces_=function(){return[]},c6.prototype.getClass=function(){return c6},c6.combine=function(){return 1===arguments.length?new c6(arguments[0]).combine():2===arguments.length?new c6(c6.createList(arguments[0],arguments[1])).combine():3===arguments.length?new c6(c6.createList(arguments[0],arguments[1],arguments[2])).combine():void 0},c6.extractFactory=function(t){return t.isEmpty()?null:t.iterator().next().getFactory()},c6.createList=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new q1;return n.add(t),n.add(e),n}if(3===arguments.length){var r=arguments[0],i=arguments[1],o=arguments[2],s=new q1;return s.add(r),s.add(i),s.add(o),s}};var f6=function(){this.hu=null,this.su=null;var t=arguments[0];this.hu=t,null===this.hu&&(this.hu=new q1)},d6={STRTREE_NODE_CAPACITY:{configurable:!0}};f6.prototype.reduceToGeometries=function(t){for(var e=new q1,n=t.iterator();n.hasNext();){var r=n.next(),i=null;Q0(r,G1)?i=this.unionTree(r):r instanceof O1&&(i=r),e.add(i)}return e},f6.prototype.extractByEnvelope=function(t,e,n){for(var r=new q1,i=0;i<e.getNumGeometries();i++){var o=e.getGeometryN(i);o.getEnvelopeInternal().intersects(t)?r.add(o):n.add(o)}return this.su.buildGeometry(r)},f6.prototype.unionOptimized=function(t,e){var n=t.getEnvelopeInternal(),r=e.getEnvelopeInternal();if(!n.intersects(r))return c6.combine(t,e);if(t.getNumGeometries()<=1&&e.getNumGeometries()<=1)return this.unionActual(t,e);var i=n.intersection(r);return this.unionUsingEnvelopeIntersection(t,e,i)},f6.prototype.union=function(){if(null===this.hu)throw new Error("union() method cannot be called twice");if(this.hu.isEmpty())return null;this.su=this.hu.iterator().next().getFactory();for(var t=new B5(f6.STRTREE_NODE_CAPACITY),e=this.hu.iterator();e.hasNext();){var n=e.next();t.insert(n.getEnvelopeInternal(),n)}this.hu=null;var r=t.itemsTree();return this.unionTree(r)},f6.prototype.binaryUnion=function(){if(1===arguments.length){var t=arguments[0];return this.binaryUnion(t,0,t.size())}if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2];if(r-n<=1){var i=f6.getGeometry(e,n);return this.unionSafe(i,null)}if(r-n==2)return this.unionSafe(f6.getGeometry(e,n),f6.getGeometry(e,n+1));var o=Math.trunc((r+n)/2),s=this.binaryUnion(e,n,o),a=this.binaryUnion(e,o,r);return this.unionSafe(s,a)}},f6.prototype.repeatedUnion=function(t){for(var e=null,n=t.iterator();n.hasNext();){var r=n.next();e=null===e?r.copy():e.union(r)}return e},f6.prototype.unionSafe=function(t,e){return null===t&&null===e?null:null===t?e.copy():null===e?t.copy():this.unionOptimized(t,e)},f6.prototype.unionActual=function(t,e){return f6.restrictToPolygons(t.union(e))},f6.prototype.unionTree=function(t){var e=this.reduceToGeometries(t);return this.binaryUnion(e)},f6.prototype.unionUsingEnvelopeIntersection=function(t,e,n){var r=new q1,i=this.extractByEnvelope(n,t,r),o=this.extractByEnvelope(n,e,r),s=this.unionActual(i,o);return r.add(s),c6.combine(r)},f6.prototype.bufferUnion=function(){if(1===arguments.length){var t=arguments[0];return t.get(0).getFactory().buildGeometry(t).buffer(0)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e.getFactory().createGeometryCollection([e,n]).buffer(0)}},f6.prototype.interfaces_=function(){return[]},f6.prototype.getClass=function(){return f6},f6.restrictToPolygons=function(t){if(Q0(t,N2))return t;var e=n4.getPolygons(t);return 1===e.size()?e.get(0):t.getFactory().createMultiPolygon(e5.toPolygonArray(e))},f6.getGeometry=function(t,e){return e>=t.size()?null:t.get(e)},f6.union=function(t){return new f6(t).union()},d6.STRTREE_NODE_CAPACITY.get=function(){return 4},Object.defineProperties(f6,d6);var p6=function(){};function g6(){return new m6}function m6(){this.reset()}p6.prototype.interfaces_=function(){return[]},p6.prototype.getClass=function(){return p6},p6.union=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return o6.createEmptyResult(o6.UNION,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),z4.overlayOp(t,e,o6.UNION)},m6.prototype={constructor:m6,reset:function(){this.s=this.t=0},add:function(t){y6(A6,t,this.t),y6(this,A6.s,this.s),this.s?this.t+=A6.t:this.s=A6.t},valueOf:function(){return this.s}};var A6=new m6;function y6(t,e,n){var r=t.s=e+n,i=r-e,o=r-i;t.t=e-o+(n-i)}var v6,x6,_6=Math.PI,b6=2*_6;function w6(t,e){return[t>_6?t-b6:t<-_6?t+b6:t,e]}function T6(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function M6(){}function C6(t,e){return[t,e]}g6(),g6(),g6(),w6.invert=w6,1===(v6=T6).length&&(x6=v6,v6=function(t,e){return T6(x6(t),e)}),g6(),g6(),g6(),g6(),g6(),M6.prototype={constructor:M6,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}},C6.invert=C6;(class extends F{constructor(t){super(t),this.on("enable",this.Du,this),this.on("disable",this.Iu,this),this.bu=[]}addTo(t){return t&&(super.addTo(t),this.Mu=t,this.zu()),this}zu(){const t=L+"drawtool";this.Mu.getLayer(t).hide()}Du(){this.on("drawstart",this.du,this).on("drawvertex",this.xu,this).on("mousemove",this.mu,this).on("drawend",this.yu,this)}Iu(){this.off("drawstart",this.du,this).off("drawvertex",this.xu,this).off("mousemove",this.mu,this).off("drawend",this.yu,this)}pu(t){const{coordinate:e,containerPoint:r}=t,i=this.Mu.getLayers((t=>t.queryTerrainAtPoint))[0];if(!i)return e.z=e.z||0,e;const o=i.identify(e,{includeInternals:!1})[0];let s=null;if(o&&o.coordinate?s=new n(o.coordinate):(e.z=e.z||0,s=e),i.getTerrainLayer()){const t=i.queryTerrainAtPoint(r);return t&&t.z>s.z?t:s}return s}du(t){const e=this.pu(t);e&&(this.Lu=!0,this.bu.push(e),this.Tu(e))}xu(t){const e=this.pu(t);e&&(this.Lu=!0,this.bu[this.bu.length-1]=e,this.Ou())}mu(t){const e=this.pu(t);e&&(this.Lu?this.bu.push(e):this.bu[this.bu.length-1]=e,this.Ou(),this.Lu=!1)}yu(t){const e=this.pu(t);e&&(this.bu.push(e),this.Fu())}Fu(){this.Ou(),this.bu=[],this.et=null,this.xn=null}remove(){this.Uu&&this.Uu.remove(),this.Eu&&this.Eu.remove()}clear(){this.Uu&&this.Uu.clear(),this.Eu&&this.Eu.clear()}}).mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,once:!0,symbol:{lineColor:"#e8542b",lineWidth:2,polygonFill:"#eee",polygonOpacity:.5},vertexSymbol:{markerType:"ellipse",markerFill:"#e8542b",markerLineColor:"#fff",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDy:0},labelSymbol:{boxStyle:{padding:[15,6],verticalAlignment:"top",horizontalAlignment:"left",minWidth:150,minHeight:30,symbol:{markerType:"square",markerFill:"rgb(60, 60, 60)",markerFillOpacity:.8,markerLineColor:"#fff",markerLineWidth:2,textDx:-110}},textSymbol:{textFill:"#fff",textSize:16,textVerticalAlignment:"top"}}}),"undefined"!=typeof window&&(window.maptalksgl=window.maptalksgl||{},window.maptalksgl.transcoders=window.maptalksgl.transcoders||BE);export{QP as G,Ah as M,pW as b};
